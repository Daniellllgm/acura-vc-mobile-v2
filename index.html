<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title data-i18n="appTitle">Vencer Cuidando</title>

  <link rel="icon" type="image/png" sizes="32x32" href="imagens/favicon-32x32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="imagens/apple-touch-icon.png">
  <link rel="icon" href="favicon.ico" type="image/x-icon">

  

  <script>// Desabilitar TODAS as mensagens do console
     
     const Oculta = "Nao";

    if (Oculta==="Sim") {
        console.log = function() {};
        console.warn = function() {};
        console.error = function() {};
        console.info = function() {};
        console.debug = function() {};
        console.trace = function() {};
        console.dir = function() {};
        console.dirxml = function() {};
        console.group = function() {};
        console.groupEnd = function() {};
        console.time = function() {};
        console.timeEnd = function() {};
        console.assert = function() {};
        console.profile = function() {};
        console.profileEnd = function() {};
        console.count = function() {};
        console.table = function() {};
        console.clear = function() {};
    }</script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class', // <--- ESSENCIAL: Ativa o controle manual do tema (light/dark)
      theme: {
        extend: {
          // 1. Fonte padr√£o do seu CSS (Inter)
          fontFamily: {
            sans: ['Inter', 'system-ui', '-apple-system', 'Segoe UI', 'Roboto', 'sans-serif'],
          },
          // 2. Cores personalizadas extra√≠das das suas classes .user-message e .doctor-message
          colors: {
            'msg-user': {
              bg: '#d1e7dd',   // Fundo verde claro
              text: '#155724'  // Texto verde escuro
            },
            'msg-doctor': {
              bg: '#f8d7da',   // Fundo vermelho claro
              text: '#721c24'  // Texto vermelho escuro
            }
          },
          // 3. Sombra personalizada extra√≠da da sua classe .rounded-card
          boxShadow: {
            'card': '0 6px 20px rgba(0, 0, 0, 0.08)',
          },
          // 4. Anima√ß√£o personalizada extra√≠da da sua classe .pulse e @keyframes pulseGlow
          animation: {
            'pulse-glow': 'pulseGlow 1s ease-in-out infinite',
          },
          keyframes: {
            pulseGlow: {
              '0%':   { boxShadow: '0 0 0 0 rgba(255, 213, 79, 0.9)' },
              '50%':  { boxShadow: '0 0 18px 8px rgba(255, 213, 79, 0.15)' },
              '100%': { boxShadow: '0 0 0 0 rgba(255, 213, 79, 0)' },
            }
          }
        }
      }
    }
 </script>
 <style type="text/tailwindcss">
    @layer components {
        /* REGRA M√ÅGICA:
           Seleciona qualquer div que tenha 'bg-white' e 'rounded-lg' (padr√£o de modais)
           E for√ßa a cor escura quando a classe .dark estiver ativa no HTML.
        */
        .dark .fixed .bg-white {
            @apply bg-slate-800 text-gray-100 border border-slate-700;
        }

        /* Corrige tamb√©m os textos de t√≠tulos e par√°grafos dentro desses modais */
        .dark .fixed .bg-white h2, 
        .dark .fixed .bg-white h3 {
            @apply text-white;
        }
        
        .dark .fixed .bg-white p,
        .dark .fixed .bg-white label {
            @apply text-gray-300;
        }

        /* Corrige inputs dentro dos modais para n√£o ficarem brancos estourados */
        .dark .fixed input,
        .dark .fixed select,
        .dark .fixed textarea {
            @apply bg-slate-700 border-slate-600 text-white placeholder-gray-400;
        }
    }
</style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script> 
  <script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/index.min.js"></script> 
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <script src="https://sdk.mercadopago.com/js/v2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script> function recarregarAPagina(){    
    window.location.reload();}</script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .screen { display:none; }
    .active-screen { display:flex; flex-direction:column; width:100%; }
    .rounded-card { border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); background:#fff; padding:16px; }
    .message-bubble { max-width:80%; word-wrap:break-word; }
    .user-message { background:#d1e7dd; color:#155724; border-radius:12px 12px 0 12px; }
    .doctor-message { background:#f8d7da; color:#721c24; border-radius:12px 12px 12px 0; }
    .hidden { display:none; }
    .pulse {
        animation: pulseGlow 1s ease-in-out infinite;
    }
    @keyframes pulseGlow {
        0%   { box-shadow: 0 0 0 0 rgba(255, 213, 79, 0.9); }
        50%  { box-shadow: 0 0 18px 8px rgba(255, 213, 79, 0.15); }
        100% { box-shadow: 0 0 0 0 rgba(255, 213, 79, 0); }
    }
    
      #form-container {
    width: 300px;
    border: 1px solid #ccc;
    padding: 15px;
    border-radius: 8px;
    background: #f9f9f9;
  }

  .popup {
    position: fixed;
    top: 50%;
    left: 50%;
    width: 400px;  
    max-width: 90vw;
    max-height: 90vh;
    overflow-y: auto;
    padding: 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,.5);
    transform: translate(-50%, -50%);
    display: none;
    z-index: 9999;
  }

  #cameraOCRModal {
    z-index: 10000; /* Novo z-index mais alto que 9999 */
  }

  .popup.active {
    display: block;
  }

   /* Overlay escuro atr√°s do popup */
  .popup-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: none;
    z-index: 9998;
  }
  
  .popup-overlay.active {
    display: block;
  }

  label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
  }

  input[type="number"], select {
    width: 100%;
    padding: 6px;
    margin-bottom: 10px;
    box-sizing: border-box;
  }
  
  input [type="text"]{
     width: 100%;
     padding: 6px;
     margin-bottom: 10px;
     box-sizing: border-box; 
  }

  #time-fields {
    display: flex;
    justify-content: space-between;
  }

  #time-fields input {
    width: 30%;
  }

  button {
    padding: 10px;
    background-color: #2c7be5;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    margin-top: 10px;
    width: 100%;
  }

  button:disabled {
    background-color: #ccc;
    cursor: default;
  }

  #multi-progress-panel {
    margin-top: 30px;
  }

  .infusion-item {
    margin-bottom: 20px;
    border: 1px solid #bbb;
    padding: 10px;
    border-radius: 8px;
    background: #fdfdfd;
    position: relative;
  }


  .infusion-title {
    font-weight: bold;
    margin-bottom: 6px;
  }

  .progress-container {
    width: 100%;
    height: 24px;
    background-color: #eee;
    border-radius: 12px;
    overflow: hidden;
    display: flex;
    align-items: center;
  }

  .progress-bar {
    height: 100%;
    width: 0%;
    background-color: #2c7be5;
    transition: width 1s linear;
    flex-grow: 1;
    border-radius: 12px 0 0 12px;
  }

  .timer-text {
    margin-top: 6px;
    font-family: monospace;
  }

  .alarm-message {
    margin-top: 6px;
    font-weight: bold;
    color: #d9534f;
  }

  .infusion-controls {
    margin-top: 8px;
  }

  .infusion-controls button {
    margin-right: 6px;
    padding: 6px 10px;
    font-weight: normal;
    width: auto;
  }

  .btn-problem {
    margin-left: 10px;
    padding: 6px 10px;
    font-weight: bold;
    font-size: 0.9em;
    color: white;
    cursor: pointer;
    border: none;
    border-radius: 6px;
    white-space: nowrap;
  }

  .btn-problem.solving {
    background-color: #ff8c00;
  }

  .btn-problem.evaluation {
    background-color: #1e90ff;
  }

  .problem-section, .evaluation-section {
    margin-top: 10px;
    border-top: 1px solid #ccc;
    padding-top: 10px;
  }

  .problem-step {
    margin-bottom: 6px;
  }

  .thank-you-message {
    margin-top: 10px;
    font-weight: bold;
    color: green;
    font-size: 1em;
  }
   /* Agenda */
   #agendaDia { margin-top: 30px; padding: 15px; background-color: #fff; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); }
   .lembrete-dose { 
    padding: 10px; 
    border-bottom: 1px solid #eee; 
    display: flex; 
    justify-content: space-between; 
    align-items: flex-start; /* ‚Üê ADICIONE ESTA LINHA */
    gap: 1rem; /* ‚Üê ADICIONE ESPA√áAMENTO ENTRE COLUNAS */
    }
   .lembrete-dose:last-child { border-bottom: none; }
        
   /* Alarme Visual */
   .lembrete-alerta { background-color: #fff3cd; border: 2px solid #ffc107; animation: piscar 1s infinite; }
   @keyframes piscar { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

   /* Estilos Espec√≠ficos para o Modal Ignorar */
.modal-ignorar-content {
    max-width: 450px;
    text-align: center;
    padding-bottom: 30px;
}

.modal-ignorar-content h2 {
    color: #dc3545; /* Vermelho/Aviso */
}

.opcoes-ignorar {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin: 20px 0;
}

.btn-ignorar-acao, .btn-suspender-acao {
    width: 100%;    
    padding: 12px 15px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s;
    line-height: 1.2;
}

.btn-ignorar-acao {
    background-color: #ffc107; /* Amarelo/Aviso */
    color: #333;
}

.btn-ignorar-acao:hover {
    background-color: #e0a800;
}

.btn-suspender-acao {
    background-color: #dc3545; /* Vermelho/Perigo */
    color: white;
}

.btn-suspender-acao:hover {
    background-color: #c82333;
}

.btn-ignorar-acao small, .btn-suspender-acao small {
    display: block;
    font-weight: normal;
    margin-top: 3px;
    opacity: 0.9;
}

#motivoObservacao {
    width: 100%;
    min-height: 80px;
    padding: 8px;
    box-sizing: border-box;
    border: 1px solid #ccc;
    border-radius: 4px;
    resize: vertical;
}

/* Estilos para mensagens de notifica√ß√£o */
.notification-message {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-10px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.celebration-message {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px 40px;
    border-radius: 20px;
    font-size: 24px;
    font-weight: bold;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    z-index: 20000;
    animation: celebrationPop 0.5s ease-out;
}

@keyframes celebrationPop {
    0% {
        transform: translate(-50%, -50%) scale(0.5);
        opacity: 0;
    }
    50% {
        transform: translate(-50%, -50%) scale(1.1);
    }
    100% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
    }
}

/* Indicador de tarefa pendente nos bot√µes */
.task-pending {
    position: relative;
}

.task-pending::after {
    content: '';
    position: absolute;
    top: -5px;
    right: -5px;
    width: 15px;
    height: 15px;
    background: #ef4444;
    border-radius: 50%;
    border: 3px solid white;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
        opacity: 1;
    }
    50% {
        transform: scale(1.2);
        opacity: 0.8;
    }
}

/* Mensagens de notifica√ß√£o - posicionamento √† esquerda */
.notification-message-left {
    right: 100%;
    left: auto;
    margin-right: 12px;
    margin-left: 0;
}

/* Garantir que mensagens n√£o saiam da tela em telas pequenas */
@media (max-width: 768px) {
    .absolute.right-full {
        max-width: 150px;
        font-size: 0.75rem;
        padding: 6px 8px;
    }
}

/* Anima√ß√£o de entrada pela esquerda */
@keyframes slideInFromLeft {
    from {
        opacity: 0;
        transform: translateX(10px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.notification-message-left {
    animation: slideInFromLeft 0.3s ease-out;
}

/* Mensagens de notifica√ß√£o - posicionamento acima */
.notification-message-top {
    bottom: 100%;
    top: auto;
    margin-bottom: 12px;
    margin-top: 0;
}

/* Anima√ß√£o de entrada de cima para baixo */
@keyframes slideInFromTop {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.absolute.bottom-full {
    animation: slideInFromTop 0.3s ease-out;
}

/* Garantir que mensagens superiores n√£o saiam da tela */
@media (max-width: 768px) {
    .absolute.bottom-full {
        max-width: 140px;
        font-size: 0.75rem;
        padding: 6px 8px;
    }
}

/* Ajuste do espa√ßamento inferior para acomodar mensagens */
.flex.justify-center.items-center.mt-auto {
    padding-top: 60px; /* Espa√ßo para mensagens acima */
}

/* Estilos para o Chat de Cuidadores */
.caregiver-message-self {
    background: #d1e7dd; /* Verde claro */
    color: #0f5132;
    margin-left: auto;
    text-align: right;
}

.caregiver-message-other {
    background: #cfe2ff; /* Azul claro */
    color: #084298;
    margin-right: auto;
    text-align: left;
}

.message-sender {
    font-size: 0.75rem;
    font-weight: bold;
    margin-bottom: 4px;
    opacity: 0.8;
}

/* Melhorias visuais gerais */
.message-bubble {
    max-width: 75%;
    word-wrap: break-word;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.pulse-red {
    background-color: #dc3545 !important; /* Cor de alerta vermelha */
    animation: pulseRedGlow 1.5s ease-in-out infinite;
}
@keyframes pulseRedGlow {
    0%   { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.9); }
    50%  { box-shadow: 0 0 18px 8px rgba(220, 53, 69, 0.4); }
    100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
}

/* Classe para o Bot√£o/Card do Paciente com Alerta */
.patient-alert {
    border: 2px solid #dc3545; /* Borda vermelha */
    box-shadow: 0 0 10px rgba(220, 53, 69, 0.7); /* Sombra vermelha */
    animation: pulseBorder 1.5s ease-in-out infinite;
}

@keyframes pulseBorder {
    0%   { box-shadow: 0 0 5px 0 rgba(220, 53, 69, 0.7); }
    50%  { box-shadow: 0 0 15px 5px rgba(220, 53, 69, 0.5); }
    100% { box-shadow: 0 0 5px 0 rgba(220, 53, 69, 0.7); }
}

/* ========== RESPONSIVIDADE PARA SMARTPHONES ========== */

/* Mobile First: Remover padding excessivo em telas pequenas */
@media (max-width: 640px) {
    body {
        padding: 0.5rem !important; /* Reduz padding de 1rem (p-4) para 0.5rem */
    }
    
    #gameContainer {
        max-width: 100% !important; /* Remove limite de largura */
        width: 100% !important;
        padding: 0.75rem !important; /* Reduz padding interno de 1.5rem para 0.75rem */
        margin: 0 !important;
    }
    
    /* Ajustar telas internas para aproveitar melhor o espa√ßo */
    .screen,
    .active-screen {
        padding: 1rem !important;
    }
    
    .rounded-card {
        padding: 0.75rem !important;
        border-radius: 8px !important;
    }
}

/* Tablets e dispositivos m√©dios */
@media (min-width: 641px) and (max-width: 1024px) {
    body {
        padding: 1rem !important;
    }
    
    #gameContainer {
        max-width: 95% !important;
        padding: 1.25rem !important;
    }
}

/* Desktop: mant√©m o design original */
@media (min-width: 1025px) {
    #gameContainer {
        max-width: 42rem; /* 672px - mant√©m max-w-2xl do Tailwind */
    }
}

/* ========== ESTILOS PARA BOT√ïES DA AGENDA (ALINHADOS) ========== */

/* Container principal das a√ß√µes (data + bot√µes) */
.agenda-actions-container {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    min-width: 180px; /* Largura m√≠nima para manter consist√™ncia */
}

/* Data e hora (refer√™ncia para largura dos bot√µes) */
.agenda-datetime {
    width: 100%;
    text-align: center;
    padding: 0.25rem 0.5rem;
    margin-bottom: 0.5rem;
    background-color: #f0f9ff; /* Azul muito claro */
    border-radius: 6px;
    white-space: nowrap;
}

/* Wrapper dos bot√µes (garante que fiquem lado a lado) */
.agenda-buttons-wrapper {
    display: flex;
    gap: 0.5rem;
    width: 100%;
}

/* Estilos base dos bot√µes */
.agenda-btn {
    flex: 1; /* Divide espa√ßo igualmente */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 0.5rem 0.25rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.75rem;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    min-height: 50px;
}

/* √çcone do bot√£o (maior e separado) */
.agenda-btn-icon {
    font-size: 1.25rem;
    line-height: 1;
    margin-bottom: 0.25rem;
}

/* Texto do bot√£o */
.agenda-btn-text {
    font-size: 0.7rem;
    line-height: 1;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Bot√£o Ignorar (Laranja) */
.agenda-btn-ignore {
    background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
    color: white;
}

.agenda-btn-ignore:hover {
    background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(249, 115, 22, 0.3);
}

.agenda-btn-ignore:active {
    transform: translateY(0);
}

/* Bot√£o Iniciar (Verde) */
.agenda-btn-start {
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    color: white;
}

.agenda-btn-start:hover {
    background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(34, 197, 94, 0.3);
}

.agenda-btn-start:active {
    transform: translateY(0);
}

/* Anima√ß√£o de pulsa√ß√£o para alertas */
.lembrete-alerta .agenda-btn-start {
    animation: pulseBtnStart 1.5s ease-in-out infinite;
}

@keyframes pulseBtnStart {
    0%, 100% {
        box-shadow: 0 4px 8px rgba(34, 197, 94, 0.3);
    }
    50% {
        box-shadow: 0 4px 16px rgba(34, 197, 94, 0.6);
        transform: scale(1.05);
    }
}

/* ========== RESPONSIVIDADE DOS BOT√ïES ========== */

/* Tablets e dispositivos m√©dios */
@media (max-width: 1024px) {
    .agenda-actions-container {
        min-width: 160px;
    }
    
    .agenda-btn {
        min-height: 45px;
        padding: 0.4rem 0.2rem;
    }
    
    .agenda-btn-icon {
        font-size: 1.1rem;
    }
    
    .agenda-btn-text {
        font-size: 0.65rem;
    }
}

/* Smartphones */
@media (max-width: 640px) {
    /* For√ßa layout em coluna em telas muito pequenas */
    .lembrete-dose {
        flex-direction: column !important;
        align-items: stretch !important;
    }
    
    .agenda-actions-container {
        width: 100%;
        min-width: 100%;
        margin-top: 0.75rem;
    }
    
    .agenda-datetime {
        text-align: center;
        font-size: 0.8rem;
    }
    
    .agenda-buttons-wrapper {
        width: 100%;
        gap: 0.5rem;
    }
    
    .agenda-btn {
        min-height: 55px;
        padding: 0.6rem 0.5rem;
    }
    
    .agenda-btn-icon {
        font-size: 1.5rem;
        margin-bottom: 0.3rem;
    }
    
    .agenda-btn-text {
        font-size: 0.75rem;
    }
}

/* Ajuste fino para telas muito pequenas (< 360px) */
@media (max-width: 360px) {
    .agenda-btn-text {
        font-size: 0.65rem;
        letter-spacing: 0.3px;
    }
    
    .agenda-btn-icon {
        font-size: 1.3rem;
    }
}

/* Container principal das notifica√ß√µes (sobre o avatar) */
#centralNotificationsContainer {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 160px;
    height: 160px;
    pointer-events: none; /* Permite cliques passarem atrav√©s */
    z-index: 100; /* Acima do avatar (z-20), abaixo dos modais (z-9999) */
}

:root {
    /* Cores da Timeline (adicionar ao :root existente) */
    --timeline-primary: #2563eb;
    --timeline-primary-hover: #1d4ed8;
    --timeline-success: #10b981;
    --timeline-success-dark: #059669;
    --timeline-danger: #ef4444;
    --timeline-warning: #f59e0b;
    --timeline-bg: #ffffff;
    --timeline-line: #e2e8f0;
    --timeline-text: #1e293b;
    --timeline-text-secondary: #64748b;
    --timeline-border: #cbd5e1;
    
    /* Sombras */
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    
    /* Raios de borda */
    --radius-sm: 6px;
    --radius-md: 8px;
    --radius-lg: 12px;
    --radius-full: 9999px;
}

/* ========================================
   TIMELINE DE AGENDAMENTOS
======================================== */
.timeline-section {
    margin: 0px 0;
}

.timeline-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 20px;
}

.timeline-container {
    flex: 1;
    background-color: var(--timeline-bg);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    /* ‚úÖ NOVO: Padding vertical reduzido */
    padding: 20px 40px; 
    position: relative;
    overflow-x: auto; /* CR√çTICO: J√° deve estar como 'auto' */
    overflow-y: visible;
    /* Manter um min-height para garantir a visibilidade */
    min-height: 80px; 
}

.timeline {
    height: 4px;
    background: linear-gradient(90deg, var(--timeline-line) 0%, var(--timeline-primary) 100%);
    position: relative;
    border-radius: var(--radius-full);
    /* min-width: 1000px; <-- REMOVIDO PARA GARANTIR RESPONSIVIDADE */
    width: 100%; /* Garante que ocupe 100% da largura do container */
    min-width: 250px; /* Define a largura m√≠nima para smartphones para distribuir os 90 dias */
}

.timeline-item-wrapper {
    position: absolute;
    top: 0;
    transform: translateX(-50%);
    text-align: center;
    cursor: pointer;
    z-index: 10;
}

.timeline-point {
    width: 20px;
    height: 20px;
    background-color: var(--timeline-success);
    border-radius: var(--radius-full);
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 4px solid var(--timeline-bg);
    box-shadow: var(--shadow-md);
    position: relative;
    top: 50%;
    transform: translateY(-50%);
    margin: 0 auto;
}

.timeline-point:hover {
    transform: translateY(-50%) scale(1.4);
    box-shadow: 0 0 0 8px rgba(37, 99, 235, 0.1);
}

.timeline-point.multiple {
    background-color: var(--timeline-primary);
    width: 24px;
    height: 24px;
}

.timeline-point.success {
    background-color: var(--timeline-success-dark);
}

.timeline-point.cancelled {
    background-color: var(--timeline-danger);
}

.appointment-count {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--timeline-text-secondary);
    margin-top: 8px;
    display: block;
    white-space: nowrap;
    background-color: var(--cor-fundo, #f8f9fa);
    padding: 2px 8px;
    border-radius: var(--radius-sm);
    box-shadow: var(--shadow-sm);
}

/* Bot√£o de Novo Agendamento (Circular) */
.btn-new-appointment {
    background-color: var(--timeline-primary);
    color: white;
    min-width: 50px;
    height: 50px;
    border-radius: var(--radius-full);
    border: none;
    padding: 0;
    cursor: pointer;
    font-size: 1.5rem;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    box-shadow: var(--shadow-sm);
    flex-shrink: 0;
}

.btn-new-appointment:hover {
    background-color: var(--timeline-primary-hover);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.btn-new-appointment:active {
    transform: translateY(0);
}

/* Estilo para o Novo Bot√£o Retangular Azul da Timeline */
.btn-timeline-new-rect {
    /* Altura total do container (timeline-header) */
    height: auto; 
    /* Garante que ocupe todo o espa√ßo vertical dispon√≠vel */
    align-self: stretch; 
    
    background-color: var(--timeline-primary); /* Azul Padr√£o */
    color: white;
    min-width: 60px;
    width: 60px; /* Largura fixa para ret√¢ngulo vertical */
    border-radius: var(--radius-lg); /* Borda arredondada */
    border: none;
    padding: 8px 5px;
    cursor: pointer;
    font-size: 1.5rem;
    font-weight: bold;
    display: flex;
    flex-direction: column; /* Conte√∫do em coluna (√≠cone + texto) */
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    box-shadow: var(--shadow-sm);
    flex-shrink: 0;
    text-align: center;
}

.btn-timeline-new-rect .btn-timeline-new-text {
    font-size: 0.7rem;
    font-weight: 600;
    line-height: 1.1;
    margin-top: 5px;
    /* Faz o texto girar 90 graus para ficar na vertical, se necess√°rio, 
       mas manterei horizontal para facilitar a leitura.
       Para girar: transform: rotate(90deg); */
}

.btn-timeline-new-rect:hover {
    background-color: var(--timeline-primary-hover);
    transform: scale(1.02); /* Pequena escala para efeito hover */
    box-shadow: var(--shadow-md);
}

.btn-timeline-new-rect:active {
    transform: scale(1);
}

/* Modal de Detalhes (aproveitando estrutura existente) */
.timeline-modal-header {
    padding: 24px 30px;
    border-bottom: 1px solid var(--timeline-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, var(--timeline-primary) 0%, var(--timeline-primary-hover) 100%);
    border-radius: var(--radius-lg) var(--radius-lg) 0 0;
}

.timeline-modal-header h3 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 700;
    color: white;
}

.timeline-appointment-card {
    border: 2px solid var(--timeline-border);
    padding: 20px;
    margin-bottom: 16px;
    border-radius: var(--radius-md);
    background-color: var(--cor-fundo, #f8f9fa);
    box-shadow: var(--shadow-sm);
    transition: all 0.2s ease;
}

.timeline-appointment-card:hover {
    box-shadow: var(--shadow-md);
    border-color: var(--timeline-primary);
}

/* ===================================================
   ESTILOS DOS CARDS DE AGENDAMENTO (Copiados/Adaptados de agenda_consultas.html)
   =================================================== */

.timeline-appointment-card {
    background-color: #ffffff; /* Fundo branco */
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 15px;
    border: 1px solid #cbd5e1; /* Cor da borda */
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); /* Sombra padr√£o */
}

.timeline-appointment-card h4 {
    margin-top: 0;
    margin-bottom: 12px;
    font-size: 1.1rem;
    font-weight: 700;
}

.timeline-appointment-card p {
    margin: 6px 0;
    color: #1e293b; /* Cor do texto */
    font-size: 0.95rem;
}

/* Estilo para o Badge de Status */
.status-badge {
    padding: 4px 10px;
    border-radius: 9999px; /* Borda totalmente arredondada (pill shape) */
    font-size: 0.8rem;
    font-weight: 600;
    display: inline-block;
    color: white !important; /* For√ßa a cor branca do texto */
    text-transform: uppercase;
}

/* Container dos bot√µes de A√ß√£o */
.card-actions {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--cor-borda);
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
}

/* Estilo base para todos os bot√µes de a√ß√£o do card */
.btn-app-action {
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    border: none;
    font-size: 0.85rem;
    transition: background-color 0.2s;
    color: white; /* Cor do texto dos bot√µes */
}

/* Cores espec√≠ficas dos bot√µes */
.btn-app-action.success { 
    background-color: #10b981; /* Verde (Cor Sucesso) */
}
.btn-app-action.failure { 
    background-color: #ef4444; /* Vermelho (Cor Perigo) */
}
.btn-app-action.cancel { 
    background-color: #64748b; /* Cinza (Cor Secund√°ria) */
}

.btn-app-action:hover {
    opacity: 0.9;
}


/* Responsividade */
/* Ajuste de responsividade para telas menores */
@media (max-width: 680px) {
    /* Quando o .timeline-header passa para column, o bot√£o volta a 100% de largura */
    .timeline-header {
        flex-direction: column;
    }
    .btn-timeline-new-rect {
        width: 100%;
        height: 40px;
        flex-direction: row; /* Volta a ser uma linha no mobile */
        padding: 10px;
    }
    .btn-timeline-new-rect .btn-timeline-new-text {
        font-size: 1rem;
        margin-left: 8px;
    }
}

/* Estilos para a imagem da logomarca */
.logo {
    max-width: 120px; /* Largura m√°xima da logomarca em telas maiores */
    height: auto; /* Mant√©m a propor√ß√£o da imagem */
    display: block; /* Remove o espa√ßo extra abaixo da imagem */
}

/* --- ESTILOS ESPEC√çFICOS PARA A TELA DO JOGO (AUMENTO DE 40% - 168px) --- */
#mainGameScreen .logo {
    max-width: 168px; /* 120px * 1.4 = 168px */
}

#loginScreen .logo {
    max-width: 168px; /* 120px * 1.4 = 168px */
}

/* Media Queries para responsividade */
@media (max-width: 768px) {
  
    .logo {
        max-width: 90px; /* Reduz a largura da logomarca em tablets */
    }

    #mainGameScreen .logo {
        max-width: 126px; /* 90px * 1.4 = 126px */
    }
    #loginScreen .logo {
    max-width: 126px; /* 120px * 1.4 = 168px */
    }
}

@media (max-width: 480px) {
  
    .logo {
        max-width: 70px; /* Reduz a largura da logomarca em celulares */
    }

    #mainGameScreen .logo {
        max-width: 98px; /* 70px * 1.4 = 98px */
    }

    #loginScreen .logo {
    max-width: 98px; /* 120px * 1.4 = 168px */
    }
}

/* üîë NOVO CSS PARA ABAS */
/* Oculta todos os m√≥dulos de conte√∫do do paciente por padr√£o */
.patient-content-module { 
    display: none; 
}
/* Exibe o m√≥dulo de conte√∫do ativo (Substitui o 'display: none') */
.patient-content-module.active-content { 
    display: block; 
    /* Use 'block' para fluxo de conte√∫do vertical normal */
}

/* ========== CONTAINER DE CONTE√öDO (ESCOPO ISOLADO) ========== */
#patientDashboardScreen .dashboard-content-container {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 20px;
    background: #f9fafb;
    -webkit-overflow-scrolling: touch;
    /* Altura m√°xima calculada dinamicamente */
    max-height: calc(100vh - 200px); /* Ajusta conforme cabe√ßalho + abas */
}

/* ========== M√ìDULOS DE CONTE√öDO (ESCOPO ISOLADO) ========== */
#patientDashboardScreen .patient-content-module {
    /* display: none J√Å est√° no CSS original - n√£o sobrescrever */
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.3s ease, transform 0.3s ease;
}

#patientDashboardScreen .patient-content-module.active-content {
    /* display: block J√Å est√° no CSS original - n√£o sobrescrever */
    opacity: 1;
    transform: translateY(0);
}

/* Anima√ß√£o de entrada (apenas no dashboard) */
@keyframes dashboardFadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

#patientDashboardScreen .patient-content-module.active-content {
    animation: dashboardFadeInUp 0.4s ease;
}

/* ========== T√çTULOS E TEXTOS (ESCOPO ISOLADO) ========== */
#patientDashboardScreen .patient-content-module h2 {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 2px solid #e2e8f0;
}

#patientDashboardScreen .patient-content-module h3 {
    font-size: 1.125rem;
    font-weight: 600;
    color: #334155;
    margin-bottom: 12px;
}

#patientDashboardScreen .patient-content-module h4 {
    font-size: 1rem;
    font-weight: 600;
    color: #475569;
    margin-bottom: 8px;
}

/* ========== GRIDS (ESCOPO ISOLADO) ========== */
#patientDashboardScreen .patient-content-module .grid {
    display: grid;
    gap: 24px;
}

/* ========== CARDS (ESCOPO ISOLADO) ========== */
#patientDashboardScreen .patient-content-module > .bg-white,
#patientDashboardScreen .patient-content-module .bg-white {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    transition: box-shadow 0.2s ease, transform 0.2s ease;
}

#patientDashboardScreen .patient-content-module .bg-white:hover {
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

/* ========================================
   TRANSI√á√ÉO SUAVE DE ABAS (ISOLADO)
======================================== */

#patientDashboardScreen .tab-button {
    position: relative;
}

#patientDashboardScreen .tab-button::after {
    content: '';
    position: absolute;
    bottom: -3px;
    left: 50%;
    transform: translateX(-50%) scaleX(0);
    width: 100%;
    height: 3px;
    background: #312e81;
    transition: transform 0.3s ease;
}

#patientDashboardScreen .tab-button.bg-indigo-600::after {
    transform: translateX(-50%) scaleX(1);
}
    
/* ========================================
   SISTEMA DE BEM-ESTAR DO CUIDADOR
======================================== */

/* Container do Avatar com C√≠rculo de Progresso */
.caregiver-avatar-container {
    position: relative;
    width: 44px;
    height: 44px;
    flex-shrink: 0;
}

/* SVG do C√≠rculo de Progresso (posicionado atr√°s do avatar) */
.caregiver-wellness-circle {
    position: absolute;
    top: 0;
    left: 0;
    width: 44px;
    height: 44px;
    z-index: 1;
    pointer-events: none;
}

/* Avatar do Cuidador (clic√°vel) */
.caregiver-avatar-image {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    z-index: 2;
    border: 2px solid white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.caregiver-avatar-image:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.caregiver-avatar-image:active {
    transform: scale(0.98);
}

/* ========== MENU DROP-DOWN ========== */
.caregiver-dropdown-menu {
    position: absolute;
    top: 50px;
    left: 0;
    width: 280px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    z-index: 1000;
    overflow: hidden;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.caregiver-dropdown-menu.hidden {
    display: none;
}

/* Cabe√ßalho do Menu */
.caregiver-menu-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    color: white;
}

.caregiver-menu-header button {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 20px;
    line-height: 1;
}

/* Estat√≠sticas de Progresso */
.caregiver-menu-stats {
    padding: 12px 16px;
    background: #f9fafb;
    border-bottom: 1px solid #e5e7eb;
}

.caregiver-progress-bar-container {
    width: 100%;
    height: 8px;
    background: #e5e7eb;
    border-radius: 4px;
    overflow: hidden;
    margin-top: 6px;
}

.caregiver-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #22c55e 0%, #16a34a 100%);
    width: 0%;
    transition: width 0.5s ease;
    border-radius: 4px;
}

/* A√ß√µes do Menu */
.caregiver-menu-actions {
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.caregiver-menu-btn {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: left;
    width: 100%;
}

.caregiver-menu-btn svg {
    flex-shrink: 0;
}

.caregiver-menu-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.caregiver-menu-btn:active {
    transform: translateY(0);
}

/* Bot√£o de Refei√ß√£o (Laranja) */
.caregiver-menu-btn-meal {
    background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
    color: white;
}

.caregiver-menu-btn-meal:hover {
    background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
}

/* Bot√£o de Sono (Azul escuro) */
.caregiver-menu-btn-sleep {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
}

.caregiver-menu-btn-sleep:hover {
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
}

/* Rodap√© do Menu */
.caregiver-menu-footer {
    padding: 12px 16px;
    background: #f9fafb;
    border-top: 1px solid #e5e7eb;
}

/* ========== RESPONSIVIDADE ========== */
@media (max-width: 640px) {
    .caregiver-dropdown-menu {
        width: 260px;
        left: 0; /* Centraliza em telas pequenas */
    }
    
    .caregiver-menu-btn {
        padding: 10px;
    }
    
    .caregiver-menu-btn span {
        font-size: 0.8125rem;
    }
}

/* ========== INDICADOR DE MENU ABERTO ========== */
.caregiver-avatar-container.menu-open .caregiver-avatar-image {
    box-shadow: 0 0 0 3px #22c55e;
}

/* ========== ANIMA√á√ÉO DE CONCLUS√ÉO ========== */
@keyframes wellnessComplete {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.1);
    }
}

.caregiver-avatar-container.wellness-complete .caregiver-wellness-circle {
    animation: wellnessComplete 0.6s ease;
}

/* ========================================
   MODAL DE CONFIGURA√á√ïES - ABAS ISOLADAS
======================================== */

/* Container das abas de configura√ß√µes */
#settings-tabs-navigation {
    display: flex;
    border-bottom: 2px solid #e5e7eb;
}

/* Bot√µes das abas de configura√ß√µes */
.settings-tab-button {
    flex: 1;
    padding: 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    border: none;
    border-bottom: 2px solid transparent;
    background: transparent;
    cursor: pointer;
    transition: all 0.2s ease;
    color: #4f46e5; /* Indigo-600 */
}

.settings-tab-button:hover {
    border-bottom-color: #3b82f6; /* Blue-500 */
}

.settings-tab-button.active-settings-tab {
    border-bottom-color: #2563eb; /* Blue-600 */
    color: #1e40af; /* Blue-800 */
    font-weight: 600;
}

/* Conte√∫do das abas de configura√ß√µes */
.settings-tab-content {
    display: none;
}

.settings-tab-content.active-settings-tab {
    display: block;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* ====== Estilos para cards de exame e painel lateral ====== */
.exams-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: 16px;
  align-items: start;
}

.exam-card {
  background: #fff;
  border-radius: 12px;
  padding: 12px;
  box-shadow: 0 6px 20px rgba(2,6,23,0.06);
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.exam-header {
  display:flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
}

.exam-title { font-weight: 700; color: #1f2937; font-size: 1rem; }

.exam-meta {
  display:flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 4px;
  min-width: 140px;
}

@media (max-width: 760px) {
  .exam-meta { align-items: flex-start; }
}

.canvas-wrap { width:100%; height:220px; }
.legend-small { font-size:0.85rem; color:#6b7280; }

/* destaque para valor fora da faixa */
.out-of-range {
  box-shadow: 0 0 24px rgba(239,68,68,0.22);
  border: 1px solid rgba(239,68,68,0.18);
  animation: pulse 1.2s ease-in-out infinite;
}

/* ====== Corre√ß√£o para evitar cards pulando ====== */
.exam-card {
    background: #fff;
    border-radius: 12px;
    padding: 12px;
    box-shadow: 0 6px 20px rgba(2,6,23,0.06);
    display: flex;
    flex-direction: column;
    gap: 8px;
    
    /* üîí Fixar comportamento visual */
    width: 100%;
    max-width: 100%;
    min-height: 320px;  /* Mant√©m altura est√°vel */
    transition: none !important;   /* Remove qualquer anima√ß√£o involunt√°ria */
}

/* ====== Destaque sem aumentar o tamanho do card ====== */
.out-of-range {
    border: 2px solid rgba(239, 68, 68, 0.9); /* Vermelho forte */
    box-shadow: 0 0 16px rgba(239, 68, 68, 0.4);
    animation: borderPulse 1.4s ease-in-out infinite;
}

/* üîÑ Anima√ß√£o suave apenas para a borda (n√£o altera o tamanho do card) */
@keyframes borderPulse {
    0%   { border-color: rgba(239, 68, 68, 0.6); }
    50%  { border-color: rgba(239, 68, 68, 1); }
    100% { border-color: rgba(239, 68, 68, 0.6); }
}

/* ====== Evitar que canvas ou parte interna estique o card ====== */
.canvas-wrap {
    width: 100%;
    height: 220px;
    flex-shrink: 0;
}

/* Grid permanece responsivo mas sem quebrar est√©tica */
.exams-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 16px;
    align-items: start;
    width: 100%;
    max-width: 100%;
}

/* =============================
   Corre√ß√£o DEFINITIVA iPhone12
   ============================= */

/* GRID ‚Äî impede que qualquer card exceda a tela */
.exams-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100%, 1fr));
    width: 100%;
    max-width: 100%;
    overflow-x: hidden;
    box-sizing: border-box;
}

/* CARD ‚Äî garante que nunca ultrapasse a largura da tela */
.exam-card {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    overflow: hidden;             /* impede estouro interno */
    background: #fff;
    border-radius: 12px;
    padding: 12px;
    box-shadow: 0 6px 20px rgba(2,6,23,0.06);
    display: flex;
    flex-direction: column;
    gap: 8px;
    min-height: 320px;
}

/* Canvas ‚Äì evita que o gr√°fico force largura extra */
.canvas-wrap {
    width: 100% !important;
    max-width: 100% !important;
    height: 220px;
    overflow: hidden;
    box-sizing: border-box;
}

.canvas-wrap canvas {
    max-width: 100% !important;
    width: 100% !important;
    height: 100% !important;
    display: block;               /* remove espa√ßo extra */
}

/* Header ‚Äì impede que nome + √∫ltimos valores criem overflow */
.exam-header {
    width: 100%;
    max-width: 100%;
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;              /* permite quebrar linha */
}

/* Painel de valores √† direita */
.exam-meta {
    max-width: 100%;
    word-wrap: break-word;
}

/* Borda pulsante sem expandir largura */
.out-of-range {
    border: 2px solid rgba(239, 68, 68, 0.9);
    box-shadow: 0 0 16px rgba(239, 68, 68, 0.4);
    animation: borderPulse 1.4s ease-in-out infinite;
    box-sizing: border-box;
}

@keyframes borderPulse {
    0%   { border-color: rgba(239, 68, 68, 0.6); }
    50%  { border-color: rgba(239, 68, 68, 1); }
    100% { border-color: rgba(239, 68, 68, 0.6); }
}

/* Adicione isso dentro da tag <style> no head */

#splash-screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background-color: #ffffff; /* Cor de fundo da tela */
  z-index: 9999; /* Garante que fique acima de tudo */
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  transition: opacity 0.8s ease-out, visibility 0.8s;
}

#splash-screen.hidden {
  opacity: 0;
  visibility: hidden;
  pointer-events: none; /* Permite clicar nos elementos abaixo ap√≥s sumir */
}

/* Anima√ß√£o opcional para a logo "respirar" */
.logo-pulse {
  animation: pulse-animation 2s infinite;
}

@keyframes pulse-animation {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.05); opacity: 0.8; }
  100% { transform: scale(1); opacity: 1; }
}

#hub-disease-form {
    z-index: 20000 !important; /* Maior que qualquer outro modal */
}

/* Garante que o elemento destacado fique acima do fundo preto */
.tutorial-highlight {
    position: relative !important;
    z-index: 13001 !important; /* Maior que o overlay (13000) */
    box-shadow: 0 0 0 4px #ffffff, 0 0 20px rgba(0,0,0,0.5) !important;
    background-color: white; /* Garante fundo opaco */
    transition: all 0.3s ease;
}

/* Container para posicionamento relativo */
.autocomplete-wrapper {
    position: relative;
}

/* Lista de sugest√µes */
.suggestions-list {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ccc;
    border-radius: 0 0 4px 4px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    display: none; /* Oculto por padr√£o */
}

.suggestions-list li {
    padding: 10px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}

.suggestions-list li:hover {
    background-color: #f0f9ff; /* Azul claro ao passar o mouse */
}

/* Estilo para a lista de autocompletar */
.autocomplete-container {
    position: relative;
    width: 100%;
}

.suggestions-list {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-radius: 0 0 8px 8px;
    max-height: 250px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    display: none; /* Escondido por padr√£o */
}

.suggestions-list {
    display: none; /* Come√ßa oculta */
    position: absolute; /* Flutua sobre o conte√∫do */
    background-color: white;
    border: 1px solid #ccc;
    border-radius: 0.5rem;
    width: 100%; /* Mesma largura do input pai (se o pai tiver position: relative) */
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000; /* Garante que fique na frente de tudo */
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    margin-top: 2px;
    list-style: none;
    padding: 0;
}

/* Certifique-se de que a div pai do input tenha position: relative */
.form-group .flex {
    position: relative;
}

.suggestion-item {
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
    transition: background-color 0.2s;
}

.suggestion-item:hover {
    background-color: #f3f4f6;
}

.suggestion-name {
    font-weight: bold;
    color: #1f2937;
    display: block;
}

.suggestion-details {
    font-size: 0.75rem;
    color: #6b7280;
    display: block;
    margin-top: 2px;
}

@keyframes gold-shine {
    0% { transform: translateX(-100%) rotate(45deg); }
    100% { transform: translateX(200%) rotate(45deg); }
}

.animate-victory-glow {
    animation: victory-pulse 2s infinite alternate;
    box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
}

@keyframes victory-pulse {
    from { transform: scale(1); filter: brightness(1); }
    to { transform: scale(1.03); filter: brightness(1.3); }
}

#btn-overall-survivor::after {
    content: '';
    position: absolute;
    top: -50%; left: -50%;
    width: 200%; height: 200%;
    background: linear-gradient(to right, transparent, rgba(255,255,255,0.3), transparent);
    transform: rotate(45deg);
    animation: gold-shine 4s infinite;
}

    /* --- CORRE√á√ÉO DE DARK MODE PARA CLASSES PERSONALIZADAS --- */
    
    /* 1. Tela Principal (mainGameScreen) e Cart√µes */
    .dark .rounded-card, 
    .dark .screen {
        background-color: #1e293b !important; /* Cinza Escuro (Slate 800) */
        color: #f1f5f9 !important;             /* Texto Claro */
        border-color: #334155 !important;      /* Bordas Sutis */
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5) !important;
    }

    /* 2. Modais e Popups (Formul√°rios de Medica√ß√£o/Agendamento) */
    .dark .popup,
    .dark .modal-content,
    .dark #agendaDia {
        background-color: #1e293b !important;
        color: #f1f5f9 !important;
        border: 1px solid #334155 !important;
    }

    /* 3. Inputs e Selects dentro dos modais (para n√£o ficar fundo branco com texto branco) */
    .dark .popup input, 
    .dark .popup select, 
    .dark .popup textarea,
    .dark .rounded-card input,
    .dark .rounded-card select {
        background-color: #334155 !important; /* Slate 700 */
        color: #fff !important;
        border-color: #475569 !important;
    }

    /* 4. Corre√ß√£o para Bot√µes que podem ficar invis√≠veis */
    .dark button.bg-white {
        background-color: #334155 !important;
        color: #fff !important;
        border-color: #475569 !important;
    }

    .dark .infusion-item {
        background-color: #1e293b !important; /* Fundo Cinza Escuro (Slate 800) */
        border-color: #334155 !important;      /* Borda mais escura (Slate 700) */
        color: #f1f5f9 !important;             /* Texto Claro */
    }

    /* Se houver inputs dentro do item de infus√£o */
    .dark .infusion-item input,
    .dark .infusion-item select {
        background-color: #334155 !important;
        border-color: #475569 !important;
        color: #fff !important;
    }

    /* Fundo escuro do modal */
    .custom-modal-overlay {
        display: none; /* Controlado via JS */
        position: fixed;
        inset: 0;
        z-index: 9999;
        background-color: rgba(17, 24, 39, 0.75); /* Escuro semi-transparente */
        backdrop-filter: blur(4px); /* Efeito de desfoque no fundo */
        align-items: center;
        justify-content: center;
        padding: 1rem;
    }

    /* Caixa Branca do Modal */
    .custom-modal-box {
        background: white;
        width: 100%;
        max-width: 900px;
        max-height: 90vh;
        border-radius: 0.75rem; /* 12px */
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        display: flex;
        flex-direction: column;
        overflow: hidden; /* Importante para bordas arredondadas */
        font-family: ui-sans-serif, system-ui, -apple-system, sans-serif;
    }

    /* Cabe√ßalho */
    .custom-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #e5e7eb;
        background-color: #f9fafb;
    }

    .custom-modal-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1f2937;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Corpo (Tabela) com Scroll */
    .custom-modal-body {
        padding: 0;
        overflow-y: auto;
        overflow-x: auto;
        flex: 1; /* Ocupa o espa√ßo restante */
    }

    /* Estilo da Tabela */
    .report-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 600px; /* Garante que n√£o esmague em celular */
    }
    
    .report-table th {
        background-color: #f3f4f6;
        color: #374151;
        font-weight: 600;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding: 0.75rem 1.5rem;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
        position: sticky;
        top: 0;
    }

    .report-table td {
        padding: 1rem 1.5rem;
        font-size: 0.875rem;
        color: #4b5563;
        border-bottom: 1px solid #e5e7eb;
    }

    .report-table tr:hover {
        background-color: #f9fafb; /* Destaque ao passar o mouse na linha */
    }

    /* Rodap√© (Bot√µes) */
    .custom-modal-footer {
        padding: 1rem 1.5rem;
        background-color: #f9fafb;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: flex-end; /* ALINHAMENTO √Ä DIREITA */
        gap: 0.75rem; /* Espa√ßo entre bot√µes */
    }

    /* Bot√µes Padr√£o */
    .btn-modal {
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
    }

    .btn-danger {
        background-color: #fee2e2;
        color: #991b1b;
    }
    .btn-danger:hover {
        background-color: #fecaca;
    }

    .btn-primary {
        background-color: #2563eb;
        color: white;
    }
    .btn-primary:hover {
        background-color: #1d4ed8;
    }
    
    .btn-close-icon {
        background: transparent;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        font-size: 1.5rem;
        padding: 0;
        line-height: 1;
    }
    .btn-close-icon:hover {
        color: #4b5563;
    }

    @keyframes pulse-fast {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.4; }
        }
        .animate-pulse-fast {
        animation: pulse-fast 1s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

    /* Corre√ß√£o Segura para Modo Escuro nos Modais */
    .dark .custom-modal-box, 
    .dark #shareOptionModal .bg-white {
        background-color: #1e293b !important; /* Slate 800 */
        color: #e2e8f0;
    }

    /* Corrige textos Indigo dentro do modo escuro */
    .dark .text-indigo-600, 
    .dark .text-indigo-900 {
        color: #818cf8 !important; /* Indigo 400 (Mais claro para ler no escuro) */
    }

    /* Corrige textos Cinza Escuro */
    .dark .text-gray-500, 
    .dark .text-gray-600, 
    .dark .text-gray-700 {
        color: #94a3b8 !important; /* Slate 400 */
    }

    /* Corrige Inputs */
    .dark input[type="text"], 
    .dark input[type="number"], 
    .dark input[type="date"], 
    .dark select {
        background-color: #0f172a !important; /* Slate 900 */
        border-color: #334155 !important;
        color: white !important;
    }

    /* Corrige Fundo Verde (Profissionais Ativos) */
    .dark div[style*="background: #f0fdf4"] {
        background-color: rgba(6, 78, 59, 0.4) !important; /* Verde transparente */
        border-color: #065f46 !important;
    }

    /* Corrige Fundo Cinza (Profissionais Inativos) */
    .dark div[style*="background: #f9fafb"] {
        background-color: rgba(31, 41, 55, 0.5) !important;
        border-color: #374151 !important;
}
    
</style>

  <artifact identifier="dashboard-chart-libraries" type="text/html" title="Bibliotecas de Gr√°ficos"> 
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  </artifact>

</head>
<body class="bg-slate-50 text-gray-800 dark:bg-slate-900 dark:text-gray-100 transition-colors duration-300 min-h-screen flex items-center justify-center p-4">

    <audio id="silentKeeper" loop playsinline style="display:none;">
        <source src="https://raw.githubusercontent.com/anars/blank-audio/master/250-milliseconds-of-silence.mp3" type="audio/mpeg">
    </audio>

    <audio id="alarmPlayer" style="display:none;"></audio>
   
   
  <div id="splash-screen">
    <img src="imagens/Acura_logo_claro_menor.png" alt="Logo Vencer Cuidando" class="w-32 h-auto logo-pulse mb-4">
    
    <h1 class="text-xl font-bold text-gray-700" data-i18n="appTitle">Vencer Cuidando</h1>
    <p class="text-sm text-gray-500 mt-2" data-i18n="loading" >Carregando...</p>
  </div>  

  <div id="gameContainer" class="w-full max-w-2xl sm:max-w-2xl md:max-w-3xl p-6 sm:p-6 md:p-8">

    <div id="loginScreen" class="active-screen rounded-card mx-auto text-center">

    <div class="logo-container mx-auto mb-4" style="max-width: 120px;">
        <img src="imagens/Acura_logo_claro_menor.png" alt="Logomarca Acura" class="logo">
    </div>

      <h1 class="text-2xl font-bold mb-2" data-i18n="appTitle">Vencer Cuidando</h1>
      <p class="text-gray-600 mb-4" data-i18n="loginPrompt">Entre com Google ou use e-mail e senha.</p>

      <div class="flex justify-center w-full">
            <div id="g_button" class="mb-4"></div>
        </div>

      <div class="flex items-center gap-2 mb-4">
        <div class="flex-grow border-t border-gray-300"></div>
        <div class="text-gray-400" data-i18n="orSeparator">ou</div>
        <div class="flex-grow border-t border-gray-300"></div>
      </div>

      <div class="mb-3 text-left">
        <label class="text-sm font-medium" data-i18n="emailLabel">E-mail</label>
        <input id="loginEmail" type="email" class="w-full p-2 border rounded-lg" placeholder="seu@email.com" />
      </div>
      <div class="mb-4 text-left">
        <label class="text-sm font-medium" data-i18n="passwordLabel">Senha</label>
        <input id="loginPassword" type="password" class="w-full p-2 border rounded-lg" placeholder="Senha" />
      </div>

      <div class="flex gap-2 mb-4">
        <button onclick="loginWithEmail()" class="flex-1 bg-blue-600 text-white p-2 rounded-lg" data-i18n="loginButton">Entrar</button>
        <button onclick="registerWithEmail()" class="flex-1 bg-green-600 text-white p-2 rounded-lg" data-i18n="registerButton">Criar conta</button>
      </div>

      <div class="text-right mt-2">
        <button type="button" onclick="document.getElementById('modal-forgot-password').classList.remove('hidden')" class="text-xs text-indigo-600 hover:text-indigo-800 font-semibold" data-i18n="forgotPassword">
            Esqueceu a senha?
        </button>
      </div>
      
      <div>
        <!-- ==================================================================== -->
        <!-- <button type="button" onClick="recarregarAPagina()" data-i18n="refreshScreen">Atualizar tela</button> -->
        <!-- ==================================================================== -->            
       </div>

      <div id="loginStatus" class="text-sm text-gray-500 h-5"></div>
    </div>

    <div id="caregiverScreen" class="screen rounded-card mx-auto text-left">
      <h2 class="text-xl font-semibold mb-2" data-i18n="caregiverProfileTitle" >Perfil do Cuidador</h2>
      <p class="text-gray-600 mb-4" data-i18n="caregiverProfileDesc">Coloque um apelido que ser√° exibido aos outros cuidadores.</p>

      <div class="mb-3">
        <label class="text-sm font-medium" data-i18n="caregiverNicknameLabel" >Apelido</label>
        <div class="mb-4">
        <label class="text-sm font-medium" data-i18n="caregiverRoleLabel" >Voc√™ √©:</label>
        <select id="caregiverRelation" class="w-full p-3 mb-6 border border-gray-300 rounded-xl bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="" data-i18n="caregiverRolePlaceholder" >O que voc√™ √© do paciente</option>
            <optgroup label="Fam√≠lia e cuidadores" data-i18n="roleGroupFamily">
                <option value="father" data-i18n="roleFather">Pai</option>
                <option value="mother" data-i18n="roleMother">M√£e</option>
                <option value="grandfather" data-i18n="roleGrandfather">Av√¥</option>
                <option value="grandmother" data-i18n="roleGrandmother">Av√≥</option>
                <option value="uncle" data-i18n="roleUncle">Tio</option>
                <option value="aunt" data-i18n="roleAunt">Tia</option>
                <option value="brother" data-i18n="roleBrother">Irm√£o</option>
                <option value="sister" data-i18n="roleSister">Irm√£</option>
                <option value="husband" data-i18n="roleHusband">Marido</option>
                <option value="wife" data-i18n="roleWife">Esposa</option>
                <option value="partner" data-i18n="rolePartner">Parceiro(a)</option>
                <option value="friend" data-i18n="roleFriend">Amigo(a)</option>
            </optgroup>
            <optgroup label="Direitos" data-i18n="roleGroupRights"> 
                 <option value="lawyer" data-i18n="roleLawyer">Advogado(a)</option>
                 <option value="Social_worker" data-i18n="roleSocialWorker">Asistente social</option>
            </optgroup>
            <optgroup label="Profissionais de medicina" data-i18n="roleGroupMedical">
                <option value="nurse" data-i18n="roleNurse">Enfermeiro(a)</option>
                <option value="doctor" data-i18n="roleDoctor">M√©dico(a)</option>
                <option value="other" data-i18n="roleOther">Outro(a)</option>
            </optgroup>
        </select>
      </div>
        <input id="caregiverNickname" type="text" class="w-full p-2 border rounded-lg" placeholder="Ex: Jo√£o (pai)" />
      </div>  

      <div class="flex gap-2">
        <button onclick="saveCaregiverProfile()" class="bg-blue-600 text-white p-2 rounded-lg flex-1" data-i18n="saveCaregiverButton">Salvar e continuar</button>
        <button onclick="goToScreen('loginScreen')" class="bg-gray-300 p-2 rounded-lg" data-i18n="backButton">Voltar</button>
      </div>
    </div>

   <div id="patientSelectionScreen" class="screen rounded-card mx-auto text-left">      
    <div class="flex justify-between items-center w-full mb-4">
        <h2 class="text-xl font-semibold" data-i18n="patientsTitle">Pacientes</h2> 

        <div id="status-audio" style="color: red;" >üîá Sound OFF</div>
        
        <div class="logo-container">
            <img src="imagens/Acura_logo_claro_menor.png" 
                 alt="Logomarca Acura" 
                 data-i18n-alt="appTitle"
                 class="logo max-w-[100px] h-auto">
        </div>
    </div>

    <p class="text-gray-600 mb-3" data-i18n="selectPatientDesc">Selecione um paciente existente ou crie um novo.</p>

    <div id="patientList" class="mb-4">
        </div>

    <div class="mb-4 border-t pt-4">
        
        <div class="flex items-center gap-2 mb-2">
            <h3 class="font-medium" data-i18n="createPatientTitle">Criar paciente</h3>
            
            <button onclick="document.getElementById('welcomeOnboardingModal').classList.remove('hidden')"
                    class="text-gray-400 hover:text-indigo-600 transition-colors p-1 rounded-full hover:bg-indigo-50"
                    title="Ver informa√ß√µes sobre XP e funcionamento">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="16" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
            </button>
        </div>
        
        <div class="mb-2">
            <label class="text-sm" data-i18n="patientNicknameLabel">Apelido do paciente</label>
            <input id="newPatientNickname" type="text" class="w-full p-2 border rounded-lg" 
                   placeholder="Ex: Maria" data-i18n-placeholder="phNickPatient"/>
        </div>
        
        <div class="flex gap-2 mb-2">
            <label class="w-1/3 text-sm" data-i18n="patientDobLabel">Data de nascimento</label>
            <input id="patientDob" type="date" class="w-2/3 p-2 border rounded-lg" />
        </div>
        
        <div class="mb-2">
            <label class="text-sm" data-i18n="patientIllnessLabel">Doen√ßa / condi√ß√£o</label>
            <input id="patientIllness" type="text" class="w-full p-2 border rounded-lg" 
                   placeholder="Ex: Leucemia" data-i18n-placeholder="phDisease" />
        </div>
        
        <div class="flex gap-2 mb-3">
            <input id="patientWeight" type="number" step="0.1" class="w-1/2 p-2 border rounded-lg" 
                   placeholder="Peso (kg)" data-i18n-placeholder="phWeight" />
                   
            <input id="patientHeight" type="number" step="0.1" class="w-1/2 p-2 border rounded-lg" 
                   placeholder="Altura (m)" data-i18n-placeholder="phHeight" />
        </div>
        
        <div class="flex gap-2 mb-4">
            <select id="patientGender" class="w-1/2 p-2 border rounded-lg">
                <option value="" data-i18n="patientGenderLabel">G√™nero</option>
                <option value="female" data-i18n="genderFemale">Feminino</option>
                <option value="male" data-i18n="genderMale">Masculino</option>              
            </select>
            
            <input id="patientAllergies" type="text" class="w-1/2 p-2 border rounded-lg" 
                   placeholder="Alergias (se houver)" data-i18n-placeholder="phAllergies" />
        </div>
        
        <div class="flex gap-2">
            <button onclick="createPatientProfile()" class="bg-green-600 text-white p-2 rounded-lg flex-1" data-i18n="savePatientButton">Cadastrar paciente</button>
            <button onclick="logOut()" class="bg-red-500 text-white p-2 rounded-lg flex-1" data-i18n="logoutButton">Deslogar</button>
        </div>
    </div>

    <div class="mt-4 border-t pt-4">
        <h3 class="font-medium mb-2" data-i18n="enterCodeTitle">Entrar com c√≥digo do paciente</h3>
        <div class="flex gap-2">
            <input id="patientCode" type="text" class="flex-1 p-2 border rounded-lg" 
                   placeholder="C√≥digo / ID do paciente" data-i18n-placeholder="phCode" />
            <button onclick="selectPatientByCode()" class="bg-blue-600 text-white p-2 rounded-lg" data-i18n="loginButton">Entrar</button>
        </div>
    </div>
</div> 

  <!-- ==================================================================== -->
  <!-- 4. NOVA TELA DE DASHBOARD POR PACIENTE -->
  <!-- ==================================================================== -->
  <div id="patientDashboardScreen" class="screen rounded-card mx-auto text-left" >
      
      <!-- Cabe√ßalho do Dashboard (Dados do Paciente, Bot√£o Voltar, Logo) -->
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center w-full mb-4 p-2 bg-white border-b pb-4">
            <div class="flex items-center mb-3 md:mb-0 w-full"> <div class="logo-container bg-transparent mr-4"> <img src="imagens/Acura_logo_claro_menor.png" 
                        alt="Logomarca Acura" 
                        data-i18n-alt="appTitle"
                        class="logo h-12 w-auto">
                        
                        <button onclick="returnToPatientSelection()" class="text-emerald-600 hover:text-emerald-700 font-semibold flex items-center whitespace-nowrap">
                                <span class="mr-1">&larr;</span> 
                                <span data-i18n="backButton">Voltar</span>
                        </button> 
                        
                </div>                

                <div class="DataPAtient-container bg-transparent flex-1">
                    <div class="flex items-center gap-2">
                        
                        <h1 id="dashboardPatientName" class="text-xl md:text-2xl font-bold text-gray-800 leading-tight m-0">
                            Carregando...
                        </h1>

                        <button onclick="openShareModal()" class="flex items-center justify-center text-indigo-600 hover:text-indigo-800 p-1 rounded-full hover:bg-indigo-50 transition-colors" title="Compartilhar Acesso">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="18" cy="5" r="3"></circle>
                                <circle cx="6" cy="12" r="3"></circle>
                                <circle cx="18" cy="19" r="3"></circle>
                                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                            </svg>
                        </button>
                    </div>
                    
                    <p id="dashboardPatientInfo" class="text-sm text-gray-500 mt-1">
                        <span id="dashboardPatientAge">--</span> | 
                        <span id="dashboardPatientGender">--</span> | 
                        <span id="dashboardPatientIllness">--</span>
                    </p>
                    
                    <p id="dashboardCaregiverInfo" class="text-xs text-gray-400 mt-1">
                        <span data-i18n="labelCaregiver">Cuidador:</span> 
                        <span id="dashboardCaregiverName">-</span>
                    </p>
                </div>
                

            </div>                          
        </div>
         <div class="mt-2 md:mt-0 md:ml-auto md:flex md:items-center gap-4">                
                
                <div class="w-full md:w-auto">
                    <label class="text-xs text-gray-500 block md:hidden" data-i18n="filterTimeframeLabel">Filtrar por:</label>
                    
                    <select id="filterTimeframe" class="p-2 border rounded-lg text-sm w-full md:w-auto">
                        <option value="6h" data-i18n="timeframe6h">√öltimas 6 Horas</option>
                        <option value="12h" data-i18n="timeframe12h">√öltimas 12 Horas</option>
                        <option value="dia" data-i18n="timeframeDay" selected>Dia</option>
                        <option value="semana" data-i18n="timeframeWeek">Semana</option>
                    </select>
                </div>
                
            </div>

      <!-- Abas de Navega√ß√£o (Especialidades) -->
     <div class="flex border-b border-gray-200 overflow-x-auto whitespace-nowrap mb-4" id="dashboardTabs">
            <button 
                class="dashboard-tab-button px-4 py-2 text-sm font-medium rounded-t-lg bg-indigo-600 text-white transition duration-150 ease-in-out whitespace-nowrap" 
                id="dashboard-tab-btn-nutrologia" 
                data-dashboard-tab="nutrologia-content"
                onclick="changeDashboardTab('nutrologia-content')"  data-i18n="dashboardTabNutrition">
                Nutrologia
            </button>
            <button 
                class="dashboard-tab-button px-4 py-2 text-sm font-medium rounded-t-lg text-indigo-600 hover:bg-indigo-100 transition duration-150 ease-in-out whitespace-nowrap" 
                id="dashboard-tab-btn-farmacia" 
                data-dashboard-tab="farmacia-content"
                onclick="changeDashboardTab('farmacia-content')" data-i18n="dashboardTabPharmacy" >
                Farm√°cia
            </button>
            <button 
                class="dashboard-tab-button px-4 py-2 text-sm font-medium rounded-t-lg text-indigo-600 hover:bg-indigo-100 transition duration-150 ease-in-out whitespace-nowrap" 
                id="dashboard-tab-btn-exames" 
                data-dashboard-tab="exames-content"
                onclick="changeDashboardTab('exames-content')" data-i18n="dashboardTabExams" >
                Exames/Labs
            </button>
            <button 
                class="dashboard-tab-button px-4 py-2 text-sm font-medium rounded-t-lg text-indigo-600 hover:bg-indigo-100 transition duration-150 ease-in-out whitespace-nowrap" 
                id="dashboard-tab-btn-procedimentos" 
                data-dashboard-tab="procedimentos-content"
                onclick="changeDashboardTab('procedimentos-content')" data-i18n="dashboardTabProcedures" >
                Procedimentos
            </button>
            <button onclick="changeDashboardTab('financeiro-content')" 
                class="dashboard-tab-button w-full sm:w-auto px-4 py-3 text-sm font-medium rounded-lg transition-all duration-200 text-indigo-600 hover:bg-indigo-50 flex items-center justify-center gap-2 whitespace-nowrap"
                id="dashboard-tab-btn-financeiro"
                data-dashboard-tab="financeiro-content" data-i18n="dashboardTabFinance" >
                Financeiro
            </button>
            <button 
                class="dashboard-tab-button px-4 py-2 text-sm font-medium rounded-t-lg text-indigo-600 hover:bg-indigo-100 transition duration-150 ease-in-out whitespace-nowrap" 
                id="dashboard-tab-btn-conquistas" 
                data-dashboard-tab="conquistas-content"
                onclick="changeDashboardTab('conquistas-content')" data-i18n="dashboardTabAchievements" >
                Conquistas Di√°rias
            </button>
        </div>

      <!-- Conte√∫do das Abas -->
      <div class="dashboard-content-container p-2 md:p-4 bg-gray-50 rounded-lg shadow-inner flex-grow">
          
          <!-- Aba 1: Nutrologia -->
        <div id="nutrologia-content" class="patient-content-module active-content">
              
              <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2" data-i18n="nutritionTitle" >Nutri√ß√£o e Hidrata√ß√£o</h2>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="nutrition-charts-container">
             </div>

             <div class="p-4 bg-white rounded-card mt-6">               
                <div style="height: 350px;">
                    <canvas id="mealBalanceChart"></canvas>
                    <p id="mealBalanceChart-loading" class="text-center text-gray-500 mt-4 hidden" >Carregando dados...</p>
                </div>
            </div>
              
              <div class="mt-8">
                  <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2" data-i18n="physicalEvolutionTitle" >Porte F√≠sico e Evolu√ß√£o</h2>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                      
                      <div class="bg-white p-4 rounded-xl shadow-md col-span-1">
                          <h3 class="font-semibold mb-2" data-i18n="weightImcTitle" >Evolu√ß√£o do Peso e IMC</h3>
                          <div class="h-40 flex items-center justify-center rounded-lg">
                              <canvas id="weightImcChart"></canvas>
                          </div>
                          <p class="mt-2 text-sm">
                                <span data-i18n="lastWeight">√öltimo Peso</span>: <span id="latestWeight">-- kg</span> | 
                                <span data-i18n="lastImc">√öltimo IMC</span>: <span id="latestImc">--</span>
                            </p>
                      </div>

                      <div class="bg-white p-4 rounded-xl shadow-md col-span-1">
                          <h3 class="font-semibold mb-2" data-i18n="abdominalCircTitle" >Circunfer√™ncia Abdominal</h3>
                          <div class="h-40 flex items-center justify-center rounded-lg">
                              <canvas id="abdominalChart"></canvas>
                          </div>
                          <p class="mt-2 text-sm">
                                <span data-i18n="lastCirc">√öltima Circ.</span>: <span id="latestCirc">-- cm</span> | 
                                <span data-i18n="alertState">Alerta</span>: <span id="circAlert">--</span>
                            </p>
                      </div>
                  </div>
              </div>

            <div class="p-4 bg-white rounded-card mt-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center" data-i18n="fluidBalanceTitle" >
                    üíß Balan√ßo H√≠drico do Per√≠odo
                </h3>

                <div class="flex flex-wrap justify-around items-center mb-6 text-center border-b pb-4">
                    <div class="p-2 w-1/3 min-w-[100px]">
                        <p class="text-sm text-gray-500" data-i18n="fluidIntake">Ingest√£o Total (mL)</p>
                        <p id="bh-ingestao-total" class="text-3xl font-extrabold text-blue-600">--</p>
                    </div>
                    <div class="p-2 w-1/3 min-w-[100px]">
                        <p class="text-sm text-gray-500" data-i18n="fluidOutput">Elimina√ß√£o Total (mL)</p>
                        <p id="bh-eliminacao-total" class="text-3xl font-extrabold text-red-600">--</p>
                    </div>
                    <div class="p-2 w-1/3 min-w-[100px]">
                        <p class="text-sm text-gray-500" data-i18n="fluidFinal" >Balan√ßo Final (mL)</p>
                        <p id="bh-balanco-final" class="text-3xl font-extrabold text-gray-800">--</p>
                    </div>
                </div>
                
                <div id="bh-fever-loss-info" class="text-sm text-gray-600 mb-4 p-2 bg-gray-50 rounded">
                    <span class="font-medium text-gray-700" data-i18n="fluidInsensibleLoss" >Perda Insens√≠vel Estimada:</span> 
                    <span id="bh-insensible-loss" class="font-semibold">--</span> mL. 
                    <span data-i18n="textBasedOn">(Baseado em </span>
                    <span id="bh-period-days">--</span> 
                    <span data-i18n="textDaysWith"> dias, sendo </span>
                    <span id="bh-fever-days">0</span> 
                    <span data-i18n="textFeverDays"> dias com febre).</span>
                </div>

                <h4 class="text-lg font-semibold text-gray-700 mb-2" data-i18n="fluidDetailsTitle" >Entradas e Sa√≠das Detalhadas</h4>
                <div class="overflow-x-auto border rounded-lg shadow-sm">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider" data-i18n="tableHeaderDate" >Data</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider" data-i18n="tableHeaderType" >Tipo</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-600 uppercase tracking-wider" data-i18n="tableHeaderVolume" >Volume (mL)</th>
                            </tr>
                        </thead>
                        <tbody id="bh-details-table" class="bg-white divide-y divide-gray-100 text-sm">
                            <tr id="bh-loading-row"><td colspan="3" class="text-center text-gray-500 py-4">Carregando dados...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

           <div class="mt-6 p-4 bg-blue-50 rounded-lg"> 
                <p class="text-sm text-gray-700"> 
                    <strong data-i18n="tip1Label">üí° Dica 1:</strong> 
                    <span data-i18n="tip1Body">Os dados exibidos s√£o baseados nos registros manuais. Continue registrando as ingest√µes de l√≠quidos e refei√ß√µes usando os bot√µes da tela principal.</span>
                </p> 

                <p class="text-sm text-gray-700"> 
                    <strong data-i18n="tip2Label">üí° Dica 2:</strong> 
                    <span data-i18n="tip2Body">Alimentos que se liquefazem (exemplo: sorvete, gelatina) anote como l√≠quido (em ml).</span>
                </p> 

                <p class="text-sm text-gray-700"> 
                    <strong data-i18n="tip3Label">üí° Dica 3:</strong> 
                    <span data-i18n="tip3Body">Elimina√ß√µes Intestinais (Fezes) l√≠quidas s√£o estimadas e anotadas em mL. Quando pesada a fralda, considerar 1g = 1ml. No campo de anota√ß√£o, descreva diarreia ou fezes l√≠quidas.</span>
                </p> 

                <p class="text-sm text-gray-700"> 
                    <strong data-i18n="tip4Label">üí° Dica 4:</strong> 
                    <span data-i18n="tip4Body">Para maiores informa√ß√µes, consulte um(a) enfermeiro(a).</span>
                </p> 
            </div>

          </div>
          
          <!-- Aba 2: Farm√°cia -->
          <div id="farmacia-content" class="patient-content-module ">
            <div id="farmacia-dynamic"></div>
          </div>
          
          <!-- Aba 3: Exames/Labs -->
          <div id="exames-content" class="patient-content-module ">
              <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2" data-i18n="labResultsTitle" >Resultados de Exames Laboratoriais</h2>
              <p class="text-gray-500" data-i18n="labResultsDesc" >Aqui ser√£o exibidos os √∫ltimos resultados cr√≠ticos e a evolu√ß√£o hist√≥rica (ex: Glicemia, Hemograma, Creatinina).</p>
              <div class="mt-4 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded-lg">
                  <p class="font-semibold text-yellow-800">Alerta: Glicemia (220 mg/dL) - √öltimo resultado fora da meta. Necessita revis√£o.</p>
              </div>

              <div id="exams-alerts" class="mb-4"></div>              
          </div>
          
          <!-- Aba 4: Procedimentos -->
          <div id="procedimentos-content" class="patient-content-module ">
              <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2" data-i18n="proceduresTitle" >Timeline de Procedimentos e Consultas</h2>
              <ul class="space-y-3">
                  <li class="p-3 bg-white rounded-lg shadow-sm border-l-4 border-blue-500">
                      <p class="font-semibold">Atualiza√ß√£o necess√°ria</p>
                      <p class="text-sm text-gray-600">Verifique a conex√£o com a internet.</p>
                  </li>
              </ul>
          </div>

          <!-- Aba 5: Financeiro -->
          <div id="financeiro-content" class="patient-content-module hidden p-4 space-y-6">
    
                <div class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm border border-gray-100">
                    <h3 class="text-lg font-semibold text-gray-800">üìÖ</h3>
                    <input type="month" id="financeFilterMonth" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2" onchange="loadFinanceReport()">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-gradient-to-r from-blue-600 to-blue-500 rounded-xl p-5 text-white shadow-lg">
                        <p class="text-blue-100 text-sm font-medium uppercase tracking-wider" data-i18n="financeTotalMonth" >Total Gasto no M√™s</p>
                        <h2 id="finReportTotal" class="text-3xl font-bold mt-1">R$ 0,00</h2>
                        <p class="text-xs text-blue-200 mt-2">Baseado nos lan√ßamentos realizados</p>
                    </div>

                    <div class="bg-white rounded-xl p-4 shadow-md border border-gray-100 flex items-center justify-center relative" style="height: 180px;">
                        <canvas id="financeChart"></canvas>
                        <div id="financeChartEmpty" class="hidden absolute text-gray-400 text-xs">Sem dados</div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden">
                    <div class="p-4 border-b border-gray-100 bg-gray-50">
                        <h4 class="font-semibold text-gray-700" data-i18n="financeHistory">Hist√≥rico de Lan√ßamentos</h4>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-4 py-3" >Data</th>
                                    <th scope="col" class="px-4 py-3" data-i18n="tbleHeaderDesc" >Descri√ß√£o</th>
                                    <th scope="col" class="px-4 py-3 text-right" data-i18n="tableHeaderValue" >Valor</th>
                                </tr>
                            </thead>
                            <tbody id="financeTableBody">
                                </tbody>
                        </table>
                    </div>
                    <div class="p-3 bg-gray-50 border-t border-gray-200 text-right">
                        <span class="text-xs text-gray-500">Exportar dados: Tire um print desta tela para seu controle.</span>
                    </div>
                </div>

                <div class="mt-6 bg-white p-4 rounded-lg shadow border border-gray-200">
                    <div class="flex items-center justify-between mb-4 border-b pb-2">
                        <h3 class="font-bold text-gray-700 flex items-center">
                            <span class="text-xl mr-2">üìä</span> 
                            Contribui√ß√£o por Cuidador
                        </h3>
                    </div>
                    
                    <div class="relative h-64 w-full flex justify-center">
                        <canvas id="chartCaregiverExpenses"></canvas>
                    </div>
                    
                    <p id="msgSemDadosCuidador" class="hidden text-center text-gray-400 mt-10 text-sm">
                        N√£o h√° dados suficientes para gerar o gr√°fico.
                    </p>
                </div>

                <div class="mt-6 bg-white p-4 rounded-lg shadow border border-gray-200">
                    <div class="flex items-center justify-between mb-4 border-b pb-2">
                        <h3 class="font-bold text-gray-700 flex items-center" data-i18n="financeShiftLog">
                            ‚è±Ô∏è Registro de Escala (Horas)
                        </h3>
                    </div>

                    <div id="escala-resumo-container" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        </div>

                    <div class="overflow-x-auto max-h-64 overflow-y-auto rounded border">
                        <table class="w-full text-xs text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0 z-10">
                                <tr>
                                    <th class="px-3 py-2">Data</th>
                                    <th class="px-3 py-2" data-i18n="tableHeaderCaregiver">Cuidador</th>
                                    <th class="px-3 py-2" data-i18n="tableHeaderIn">Entrada</th>
                                    <th class="px-3 py-2" data-i18n="tableHeaderOut">Sa√≠da</th>
                                    <th class="px-3 py-2 text-right" data-i18n="tableHeaderDuration">Dura√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody id="escala-tbody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

          <!-- Aba 6: Conquistas -->
          <div id="conquistas-content" class="patient-content-module hidden space-y-6 animate-fade-in">
            
            <div class="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-xl p-6 text-white shadow-lg relative overflow-hidden">
                <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-white opacity-10 rounded-full blur-xl"></div>
                
                <div class="flex justify-between items-end mb-2 relative z-10">
                    <div>
                        <h2 class="text-3xl font-bold flex items-center gap-2" id="user-level-title">
                            N√≠vel 1 <span class="text-sm font-normal opacity-80">(Aprendiz)</span>
                        </h2>
                        <p class="text-blue-100 text-sm mt-1">Continue registrando atividades para evoluir!</p>
                    </div>
                    <div class="text-4xl filter drop-shadow-md">üèÜ</div>
                </div>
                
                <div class="relative w-full bg-black/20 h-6 rounded-full overflow-hidden mt-4 backdrop-blur-sm border border-white/10">
                    <div id="xp-progress-bar" class="absolute top-0 left-0 h-full bg-gradient-to-r from-yellow-400 to-yellow-300 transition-all duration-1000 shadow-[0_0_10px_rgba(250,204,21,0.5)]" style="width: 0%"></div>
                    <div class="absolute inset-0 flex items-center justify-center text-xs font-bold text-white drop-shadow-md" id="xp-text-overlay">
                        0 / 500 XP
                    </div>
                </div>
                <div class="flex justify-between text-xs mt-2 text-blue-200 font-medium">
                    <span id="current-xp-label" data-i18n="xpCurrent">0 XP Atual</span>
                    <span id="next-level-xp-label" data-i18n="xpNextLevel" >Pr√≥ximo N√≠vel: 500 XP</span>
                </div>
            </div>

            <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-5">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2 border-b pb-2" data-i18n="achievementsTitle">
                    <span class="bg-blue-100 text-blue-600 p-1.5 rounded-lg text-xl" >üéñÔ∏è</span> 
                    Suas Conquistas
                </h3>
                <div id="badges-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <p class="text-gray-400 col-span-full text-center py-4">Carregando medalhas...</p>
                </div>
            </div>

            <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-5">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2 border-b pb-2" data-i18n="teamRankingTitle">
                    <span class="bg-purple-100 text-purple-600 p-1.5 rounded-lg text-xl">üöÄ</span> 
                    Ranking da Equipe
                </h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b">
                            <tr>
                                <th class="px-4 py-3 text-center w-16">Pos</th>
                                <th class="px-4 py-3">Cuidador</th>
                                <th class="px-4 py-3 text-center">N√≠vel</th>
                                <th class="px-4 py-3 text-right">XP Total</th>
                            </tr>
                        </thead>
                        <tbody id="ranking-table-body" class="divide-y divide-gray-100">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

      </div>

       <!-- Modal de Observa√ß√µes -->
       <div id="bh-observation-modal" 
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 999999; align-items: center; justify-content: center; backdrop-filter: blur(2px);">
            
            <div style="background-color: white; padding: 20px; border-radius: 12px; max-width: 400px; width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.2); position: relative;">
                
                <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px;">
                    <h3 style="margin: 0; font-size: 1.1rem; font-weight: bold; color: #1f2937;" data-i18n="observationTitle">
                        üìù Observa√ß√£o
                    </h3>
                    <button onclick="closeBhObservationModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280; padding: 0;">&times;</button>
                </div>
                
                <div style="background-color: #f9fafb; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 20px; max-height: 60vh; overflow-y: auto;">
                    <p id="bh-modal-text" style="margin: 0; white-space: pre-wrap; color: #374151; font-style: italic;">--</p>
                </div>
                
                <div style="text-align: right;">
                    <button onclick="closeBhObservationModal()" style="padding: 8px 16px; background-color: #e5e7eb; color: #374151; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;" data-i18n="closeButton">
                        Fechar
                    </button>
                </div>
            </div>
        </div>
  </div>
                
    <div id="mainGameScreen" class="screen rounded-card mx-auto text-left bg-white text-gray-900 dark:bg-slate-800 dark:text-gray-100 transition-colors duration-300 shadow-md">
            <!-- Cabe√ßalho do Cuidador com Menu Drop-down -->
            <div class="flex justify-between items-center w-full mb-4 p-2 bg-gray-100 rounded-xl">
                <div class="flex items-center space-x-2">
                    <!-- Avatar do Cuidador com C√≠rculo de Progresso e Menu -->
                    <div class="relative caregiver-avatar-container">
                        <!-- SVG do C√≠rculo de Progresso (Bem-estar do Cuidador) -->
                        <svg class="caregiver-wellness-circle" viewBox="0 0 44 44" width="44" height="44">
                            <circle cx="22" cy="22" r="20" stroke="#e0e0e0" stroke-width="3" fill="none"/>
                            <circle id="caregiverWellnessCircle" 
                                    cx="22" cy="22" r="20" 
                                    stroke="#22c55e" 
                                    stroke-width="3" 
                                    fill="none" 
                                    stroke-dasharray="125.66" 
                                    stroke-dashoffset="125.66" 
                                    stroke-linecap="round" 
                                    transform="rotate(-90 22 22)"
                                    style="transition: stroke-dashoffset 0.5s ease-in-out, stroke 0.5s ease-in-out;"/>
                        </svg>
                        
                        <!-- Avatar do Cuidador (Clic√°vel) -->
                        <img id="caregiverAvatar" 
                            src="https://placehold.co/40x40/cbd5e1/475569?text=C" 
                            alt="Caregiver Avatar" 
                            class="caregiver-avatar-image cursor-pointer" 
                            onclick="toggleCaregiverMenu()">
                        
                        <!-- Menu Drop-down do Cuidador -->
                        <div id="caregiverDropdownMenu" class="caregiver-dropdown-menu hidden">
                            <div class="caregiver-menu-header">
                                <span class="text-sm font-bold" data-i18n="myWellness">Meu Bem-Estar</span>
                                <button onclick="closeCaregiverMenu()" class="text-gray-400 hover:text-gray-600">‚úï</button>
                            </div>
                            
                            <div class="caregiver-menu-stats">
                                <div class="flex items-center justify-between text-xs">
                                    <span data-i18n="dailyProgress">Progresso Di√°rio:</span>
                                    <span id="caregiverProgressText" class="font-bold text-green-600">0/5</span>
                                </div>
                                <div class="caregiver-progress-bar-container">
                                    <div id="caregiverProgressBar" class="caregiver-progress-bar"></div>
                                </div>
                            </div>
                            
                            <div class="caregiver-menu-actions">
                                <button onclick="recordCaregiverMeal()" class="caregiver-menu-btn caregiver-menu-btn-meal">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 002-2V2M7 2v20M21 15V2v0a5 5 0 00-5 5v6c0 1.1.9 2 2 2h3zm0 0v7"/>
                                    </svg>
                                    <div class="flex flex-col items-start">
                                        <span class="text-sm font-semibold" data-i18n="actionRecordMeal">Registrar Refei√ß√£o</span>
                                        <span class="text-xs opacity-75" id="mealsCountText" data-i18n="textProgressToday">0/4 hoje</span>
                                    </div>                                      
                                </button>
                                
                                <button onclick="recordCaregiverSleep()" class="caregiver-menu-btn caregiver-menu-btn-sleep">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>
                                    </svg>
                                    <div class="flex flex-col items-start">
                                        <span class="text-sm font-semibold" data-i18n="actionRecordSleep">Registrar Sono</span>
                                        <span class="text-xs opacity-75" id="sleepStatusText" data-i18n="textPending">Pendente</span>
                                    </div>
                                </button>

                                <button onclick="openBreathingExercise()" class="flex items-center gap-3 w-full px-4 py-3 text-sm text-gray-700 hover:bg-teal-50 hover:text-teal-700 transition-colors">
                                    <span class="text-xl">üå¨Ô∏è</span>
                                    <div class="text-left">
                                        <span class="font-semibold block" data-i18n="actionCalmDown">Acalmar-se</span>
                                        <span class="text-[10px] text-gray-500" data-i18n="subTextCalmDown">Al√≠vio de ansiedade (4-7-8)</span>
                                    </div>
                                </button>

                                <button onclick="openFinanceModal()" class="flex items-center gap-3 w-full px-4 py-3 text-sm text-gray-700 hover:bg-teal-50 hover:text-teal-700 transition-colors">
                                    <span class="text-xl">üí∞</span>
                                    <div class="text-left">
                                        <span class="font-semibold block" data-i18n="actionFinanceControl">Controle Financeiro</span>
                                        <span class="text-[10px] text-gray-500" data-i18n="subTextFinance">Registro de gastos e benef√≠cios</span>
                                    </div>
                                </button>

                                <button onclick="restartTutorialAction()" class="flex items-center gap-3 w-full px-4 py-3 text-sm text-gray-700 hover:bg-indigo-50 hover:text-indigo-700 transition-colors group">
                                    <span class="text-xl bg-indigo-100 p-1.5 rounded-lg group-hover:bg-indigo-200 transition">üéì</span>
                                    <div class="text-left">
                                        <span class="font-semibold block" data-i18n="actionTutorial">Como usar o App</span>
                                        <span class="text-[10px] text-gray-500" data-i18n="subTextTutorial">Rever o tutorial interativo</span>
                                    </div>
                                </button>
                            </div>
                            
                            <div class="caregiver-menu-footer">
                                <p class="text-xs text-gray-500 text-center" data-i18n="wellnessTip">
                                    Complete 4 refei√ß√µes e 1 per√≠odo de sono para manter seu bem-estar em 100%
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Informa√ß√µes do Cuidador (mantidas) -->
                    <div class="flex justify-between items-start w-full">
                        <div class="flex flex-col text-left pr-4">
                            <span class="text-sm font-semibold text-gray-800 flex items-baseline">
                                <span id="caregiverInfo" class="ml-1"></span>
                            </span>
                            <span class="text-xs text-gray-500 capitalize flex items-baseline">
                                <span id="caregiverRelationDisplay" class="ml-1"></span>
                            </span>
                            <span id="userIdDisplay" class="text-[0.6rem] text-gray-400 truncate mt-0.5"></span> 
                        </div>

                      <div class="flex flex-col items-center justify-center w-fit">
                            <button id="OpenShareId" onclick="openShareModal()" class="text-indigo-600 hover:text-indigo-800 p-1 rounded-full hover:bg-indigo-50 transition-colors" title="Compartilhar Acesso">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="18" cy="5" r="3"></circle>
                                    <circle cx="6" cy="12" r="3"></circle>
                                    <circle cx="18" cy="19" r="3"></circle>
                                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                                    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                                </svg>
                            </button>
                            <button id="ProfessionalPresenceId" onclick="ProfessionalPresence.openModal()" class="p-2 rounded-full hover:bg-gray-200 text-indigo-600 transition-colors" title="Definir Equipe Presente">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                </svg>
                            </button>
                        </div>

                        <div class="flex flex-col text-left pl-4">
                            <span class="text-sm font-semibold text-gray-800 flex items-baseline justify-left">
                                <span id="pacientName" class="mr-1"></span>
                            </span>                            
                            <span class="text-xs text-gray-500 capitalize flex items-baseline justify-left">
                                <span id="pacientIdDisplay" class="ml-1"></span>                                
                            </span>                          
                        </div>
                    </div>
                </div>

                <div class="logo-container **bg-transparent**">
                    <div class="relative inline-block text-left z-[9000]" id="acura-menu-container">
    
                <button onclick="toggleAcuraMenu(event)" class="focus:outline-none transition-transform active:scale-95">
                    <img src="imagens/Acura_logo_claro_menor.png" alt="Acura Logo" class="h-10 w-auto cursor-pointer object-contain"> 
                </button>

                <div id="acura-dropdown" class="hidden absolute right-0 mt-2 w-64 max-w-[90vw] origin-top-right bg-white border border-gray-200 divide-y divide-gray-100 rounded-lg shadow-xl ring-1 ring-black ring-opacity-5 focus:outline-none animate-fade-in z-[9001]">
                        
                   <div class="px-4 py-3 bg-gray-50 rounded-t-lg">
                        <p class="text-sm font-bold text-gray-900">
                            Acura <span id="app-version-display"></span> by <a href="https://oncotrek.org" target="_blank">Oncotrek.org</a> 
                        </p>
                    </div>

                    <div class="py-1">
                        <a href="https://oncotrek.org/termos-e-condicoes" target="_blank" class="group flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-blue-600">
                            <svg class="mr-3 h-4 w-4 text-gray-400 group-hover:text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            <span data-i18n="termsConditions">Termos & Condi√ß√µes</span>
                        </a>

                        <a href="https://oncotrek.org/politica-de-privacidade" target="_blank" class="group flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-blue-600">
                            <svg class="mr-3 h-4 w-4 text-gray-400 group-hover:text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                            <span data-i18n="privacyPolicy">Pol√≠tica de Privacidade</span>
                        </a>
                    </div>

                    <div class="py-1">
                        <a href="#" onclick="toggleContactModal(true); return false;" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2">
                            <svg class="mr-3 h-4 w-4 text-gray-400 group-hover:text-teal-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                            <span data-i18n="contactUs">Fale Conosco</span>
                        </a>
                    </div>

                    <div>
                        <button onclick="openCancelPlanModal()" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2">
                        <span>üí≥</span> <span data-i18n="manageSubscription">Gerenciar Assinatura</span>
                        </button>
                    </div>

                    <div>
                        <a href="#" onclick="openAbandonPatientModal()" class="block px-4 py-2 text-sm text-orange-600 hover:bg-orange-50 hover:text-orange-700 transition-colors">
                            <div class="flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6zM21 12h-6"></path></svg>
                                <span data-i18n="abandonPatient">Abandonar Paciente</span>
                            </div>
                        </a>
                    </div>        

                    <div class="py-1 bg-red-50 rounded-b-lg">
                        <button onclick="openDeleteAccountModal()" class="w-full group flex items-center px-4 py-2 text-sm text-red-700 hover:bg-red-100">
                            <svg class="mr-3 h-4 w-4 text-red-500 group-hover:text-red-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            <span data-i18n="deleteAccount">Deletar Minha Conta</span>
                        </button>
                    </div>
                </div>
</div>

        <div id="modal-delete-account" class="popup-overlay z-[12000] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm fixed inset-0">
            <div class="bg-white w-full max-w-lg p-6 rounded-2xl shadow-2xl m-4 relative animate-scale-up border-l-8 border-red-600">
                
                <div class="flex items-center gap-3 mb-4 text-red-600">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    <h2 class="text-xl font-bold" data-i18n="deleteAccountConfirmTitle">Excluir Conta Permanentemente</h2>
                </div>

                <div class="text-gray-700 text-sm space-y-3 mb-6 bg-red-50 p-4 rounded-lg border border-red-100">
                    <p>
                        <strong data-i18n="attentionLabel">Aten√ß√£o:</strong> 
                        <span data-i18n="deleteWarning1">Ao deletar a conta, todos os seus dados e registros de pacientes ser√£o perdidos permanentemente.</span>
                    </p>
                    <p class="font-bold" data-i18n="deleteWarning2">Esta a√ß√£o n√£o poder√° ser desfeita.</p>
                    <p data-i18n="deleteWarning3">A Acura n√£o mais poder√° acompanhar o seu progresso e do(a) paciente com qualquer um dos servi√ßos de suporte.</p>
                </div>

                <div class="flex gap-3 justify-end">
                    <button onclick="document.getElementById('modal-delete-account').classList.add('hidden')" class="px-5 py-2 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium transition" data-i18n="cancelButton">
                        Cancelar
                    </button>
                    
                    <button onclick="confirmDeleteAccountAction()" class="px-5 py-2 text-white bg-red-600 hover:bg-red-700 rounded-lg font-bold shadow-lg transition flex items-center gap-2">
                        <span>üóëÔ∏è</span>
                        <span data-i18n="deleteAccountConfirmBtn">Confirmar Exclus√£o</span>
                    </button>
                </div>
            </div>
        </div>
                </div>
            </div>  
            
            <div class="flex justify-between items-center w-full mb-4 p-2 bg-gray-100 rounded-xl">
              <span id="caregiverLocation" class="text-xs text-gray-500 truncate mt-0.5" hidden>Localizando...</span> 
              <span id="hospitalNameDisplay" class="text-center font-bold text-gray-700 text-sm" onclick="openLocationModal()"></span>
              <span id="currentTime" class="text-sm text-gray-500"></span>
                <div class="flex items-center space-x-2">                    
                    <button id="notificationBtn" class="bg-yellow-400 p-2 rounded-full text-white shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-bell"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                    </button>
                    <button id="openSettingsBtn" onclick="openSettingsModal()" class="bg-gray-400 p-2 rounded-full text-white shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-settings"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83l-2.83 2.83a2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0l-2.83-2.83a2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83l2.83-2.83a2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0l2.83 2.83a2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82z"></path></svg>
                    </button>
                </div>
            </div>
            
            <div class="mt-8 w-full">
                <div class="bg-gray-200 rounded-full h-4">
                    <div id="progressFill" class="bg-green-500 h-4 rounded-full transition-all duration-500 ease-in-out" style="width: 0%;"></div>
                </div>
                <div class="flex justify-between text-sm text-gray-600 mt-2">
                    <span id="taskProgress">0%</span>
                    <span id="survivalProbability" data-i18n="survivalProb">Probabilidade: 100%</span>
                </div>
            </div>  
            
            <!-- ========== TIMELINE DE AGENDAMENTOS ========== -->
            <div class="timeline-section mt-2">
                <div class="timeline-header">
                    <div class="timeline-container bg-gray-50 text-gray-800 dark:bg-slate-900 dark:text-gray-200 transition-colors duration-300 rounded-lg p-4 shadow-inner">
                        <div id="timeline-loading" class="loading" style="display: none;">Carregando agenda...</div>
                        <div id="timeline" class="timeline"></div>
                    </div>
                    <button id="btn-new-appointment-timeline" class="btn-timeline-new-rect" title="Novo Agendamento" onclick="openTimelineNewModal(); event.stopPropagation(); return false;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="feather feather-plus">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        <span class="btn-timeline-new-text"></span>
                    </button>
                </div>
            </div>

            <!-- Modal de Detalhes da Timeline -->
            <div id="timeline-detail-modal" class="popup" role="dialog" aria-modal="true">
                <div class="popup-content" style="max-width: 700px;">
                    <div class="timeline-modal-header">
                        <h3 id="timeline-modal-title">Agendamentos</h3>
                        <span class="close-btn" onclick="closeTimelineDetailModal()"><h3>&times;</h3></span>
                    </div>
                    <div style="padding: 30px;" id="timeline-card-container">
                        <!-- Cards ser√£o inseridos aqui via JS -->
                    </div>
                </div>
            </div>

            <!-- Modal de Novo Agendamento (Timeline) -->
          <div id="timeline-new-appointment-modal" class="popup" role="dialog" aria-modal="true">
            <div class="popup-content" style="max-width: 600px;">
                <div>
                    <h3><i data-i18n="titleCreateAppt">Criar Novo Agendamento</i></h3>
                </div>
                <div>
                    <form id="timeline-new-appointment-form">
                        <div class="form-group">
                            <label for="timeline-tipo" data-i18n="labelApptType">Tipo de Agendamento:</label>
                            <select id="timeline-tipo" name="tipo" class="w-full p-2 border rounded-lg" required>
                                <option value="Consulta" data-i18n="optTypeConsultation">Consulta</option>
                                <option value="Exame" data-i18n="optTypeExam">Exame</option>
                                <option value="Procedimento" data-i18n="optTypeProcedure">Procedimento</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="timeline-data" data-i18n="labelDateTime">Data/hora</label>
                            <input type="date" id="timeline-data" name="data_consulta" class=" p-2 border rounded-lg" required>
                            <input type="time" id="timeline-hora" name="hora_consulta" class=" p-2 border rounded-lg" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="timeline-descricao" data-i18n="tableHeaderDesc">Descri√ß√£o:</label>
                            <input type="text" id="timeline-descricao" name="descricao" class="w-full p-2 border rounded-lg" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="timeline-local" data-i18n="labelLocation">Local:</label>
                            <input type="text" id="timeline-local" name="local" class="w-full p-2 border rounded-lg" 
                                placeholder="Ex: Consult√≥rio 1 - T√©rreo" data-i18n-placeholder="phLocationGeneric" required>
                        </div>
                        
                        <div class="mb-4 autocomplete-wrapper">
                            <label for="timeline-profissional" data-i18n="labelHealthPro">Profissional de Sa√∫de:</label>
                            <input type="text" id="timeline-profissional" name="profissional_contato" class="w-full p-2 border rounded-lg" required>
                            <ul id="suggestions-profissional" class="suggestions-list"></ul>
                        </div>

                        <div id="profissional-saude-field" class="mb-4">
                            <label for="campo-profissional-saude" class="block text-sm font-medium text-gray-700"></label>
                            <div class="mt-1 flex rounded-md shadow-sm">
                                <input type="text" id="campo-profissional-saude" hidden name="profissional_saude" 
                                    class="flex-1 min-w-0 block w-full px-3 py-2 rounded-none rounded-l-md border-gray-300 focus:ring-blue-500 focus:border-blue-500 sm:text-sm" 
                                    placeholder="Nome do M√©dico/Enfermeiro" data-i18n-placeholder="phDoctorName">
                                
                                <button type="button" id="btn-abrir-cadastro-prof" class="inline-flex items-center px-4 py-2 border border-l-0 border-gray-300 bg-blue-600 text-sm font-medium rounded-r-md text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                        data-i18n="btnAddPro">
                                        + Cadastrar Profissional de Sa√∫de
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-4 autocomplete-wrapper">
                            <label for="timeline-telefone" data-i18n="labelPhone">Telefone:</label>
                            <input type="tel" id="timeline-telefone" name="telefone_clinica" class=" p-2 border rounded-lg" 
                                placeholder="(00) 0000-0000" data-i18n-placeholder="phPhone">
                            <ul id="suggestions-telefone" class="suggestions-list"></ul>
                        </div>
                        
                        <div class="form-group">
                            <label for="timeline-instrucoes" data-i18n="labelInstructions">Instru√ß√µes de Preparo:</label>
                            <textarea id="timeline-instrucoes" name="instrucoes_preparo" class="w-full p-2 border rounded-lg" rows="3"></textarea>
                        </div>
                        
                        <div class="mb-4">
                            <label for="jejum" class="block text-sm font-medium text-gray-700 mb-1" data-i18n="labelFasting">Jejum (em horas):</label>
                            <select id="jejum" name="jejum" 
                                    class="w-full p-2 border border-gray-300 rounded-md bg-white focus:ring-red-500 focus:border-red-500" required>
                                <option value="0" data-i18n="optFasting0">0 (N√£o necess√°rio)</option> 
                                
                                <option value="" disabled selected data-i18n="selectFastingPlaceholder">Selecione o tempo de jejum</option>
                                <option value="4" data-i18n="optFasting4">4 horas</option>
                                <option value="6" data-i18n="optFasting6">6 horas</option>
                                <option value="8" data-i18n="optFasting8">8 horas</option>
                                <option value="12" data-i18n="optFasting12">12 horas</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label for="statusPagador" data-i18n="labelPaidBy">Pago por:</label>
                            <select id="statusPagador" name="status_pagador" 
                                    class="w-full p-2 border border-gray-300 rounded-md bg-white focus:ring-red-500 focus:border-red-500" required>
                                <option value="" disabled selected data-i18n="optPaySelect">Selecione o tipo de pagamento</option>
                                <option value="P√∫blico" data-i18n="payerPublic">P√∫blico</option>
                                <option value="Plano" data-i18n="payerInsurance">Plano</option>
                                <option value="Particular" data-i18n="payerPrivate">Particular</option>
                            </select>
                        </div>

                        <button type="button" id="appointment_create" onclick="createAppointment()" class="p-3 bg-indigo-500 text-white rounded-full shadow-lg hover:scale-110 transition-transform flex items-center justify-center space-x-2"
                                data-i18n="btnCreateAppt">
                            Criar Agendamento
                        </button>

                        <button type="button" id="close-btn" onclick="closeTimelineNewModal()" class="p-3  text-white rounded-full shadow-lg hover:scale-110 transition-transform flex items-center justify-center space-x-2" style="margin-top:10px; background:#aaa;"
                                data-i18n="closeButton">
                            Fechar
                        </button> 
                    </form>
                </div>
            </div>
        </div>      

            <div class="mt-0 w-full h-auto">
            
            <div id="agendaDia">
             <h3><i data-i18n="todayAgenda">Agenda de Hoje</i></h3>
            </div>
            
                       
            
            <div id="form-popup-drugs" class="popup" role="dialog" aria-modal="true" aria-labelledby="formTitle">
                <div id="modalPrescricao" class="modal">
                    <div class="modal-content">
                    <h3 id="formTitle"><i data-i18n="newMedTitle">Cadastrar Nova Medica√ß√£o</i></h3>
                    <form id="formPrescricao">

                        <div class="mb-4 autocomplete-container">
                        <label for="nome_medicamento" data-i18n="medNameLabel">Nome do Medicamento:</label>
                        <div class="flex gap-2 items-center">
                            <input type="text" id="nome_medicamento" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Digite para buscar..." autocomplete="off" oninput="buscarMedicamento(this.value)">
                            <div id="lista-sugestoes" class="suggestions-list"></div>
                            <button type="button" id="btnCameraReceita" class="p-2 bg-indigo-500 text-white rounded-lg shadow-md hover:bg-indigo-600 transition-colors" title="Ler receita via C√¢mera">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-camera">
                                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                                <circle cx="12" cy="13" r="4"></circle>
                            </svg>
                            </button>
                        </div>
                        </div>

                        <div class="form-group" style="display: flex; gap: 10px;">
                        <label for="via_administracao" data-i18n="medRouteLabel">Via de Administra√ß√£o:</label>
                        <select id="via_administracao" name="via_administracao" onchange="alternarCamposFormulario()" class="w-1/2 p-2 border rounded-lg" required>
                            <option value="Oral" selected data-i18n="routeOral">Oral (Pela boca)</option>
                            <option value="Nasofagica" data-i18n="routeNaso">Nasof√°gica</option>
                            <option value="Intravenosa" data-i18n="routeIV">Intravenosa (IV)</option>
                        </select>
                        </div>

                        <div class="form-group" style="display: flex; gap: 10px;">
                        <div style="flex: 2;">
                            <label for="dosagem" data-i18n="medDosageLabel">Dosagem:</label>
                            <input type="number" id="dosagem" name="dosagem" step="0.01" class="w-1/2 p-2 border rounded-lg" required>
                        </div>
                        <div style="flex: 1;">
                            <label for="unidade_dosagem" data-i18n="medUnitLabel">Unidade:</label>
                            <input type="text" id="unidade_dosagem" name="unidade_dosagem" placeholder="mg, ml, gotas" list="sugestoesMedsUnd" class="w-1/2 p-2 border rounded-lg" size="10" required>
                            <datalist id="sugestoesMedsUnd"></datalist>
                        </div>
                        </div>

                        <div class="form-group" style="display: flex; gap: 10px;">
                        <label for="volume_diluicao_liquido" data-i18n="medDilutionLabel">L√≠quido de Dilui√ß√£o:</label>
                        <select id="volume_diluicao_liquido" onchange="alternarCamposFormulario()" name="volume_diluicao_liquido" class="w-1/2 p-2 border rounded-lg" required>
                            <option value="Nenhum" selected >Nenhum</option>
                            <option value="Soro Fisiol√≥gico">Soro Fisiol√≥gico</option>
                            <option value="√Ågua">√Ågua</option>
                        </select>
                        </div>

                        <div id="camposDiluicao" class="campo-dependente" style="display: none;">
                        <div class="form-group" style="display: flex; gap: 10px;">
                            <div style="flex: 2;">
                            <label for="volume_diluicao_quant" data-i18n="medDilutionVolLabel">Volume da Dilui√ß√£o:</label>
                            <input type="number" id="volume_diluicao_quant" name="volume_diluicao_quant" class="w-1/2 p-2 border rounded-lg" step="0.01">
                            </div>
                            <div style="flex: 1;">
                            <label for="unidade_diluicao">Unidade:</label>
                            <input type="text" id="unidade_diluicao" name="unidade_diluicao" class="w-1/2 p-2 border rounded-lg" value="ml" readonly>
                            </div>
                        </div>
                        </div>

                        <div id="campoVazao" class="campo-dependente" style="display: none;">
                        <div class="form-group">
                            <label for="vazao_bomba" data-i18n="medFlowLabel">Vaz√£o Programada da Bomba (ml/h):</label>
                            <input type="number" id="vazao_bomba" name="vazao_bomba" class="w-1/2 p-2 border rounded-lg" step="0.01">
                        </div>
                        </div>

                        <div class="form-group" style="display: flex; gap: 10px;">
                        <label for="intervalo_horas" data-i18n="medIntervalLabel">Tomar de:</label>
                        <input type="number" min="1" id="intervalo_horas" name="intervalo_horas" class="w-1/2 p-2 border rounded-lg" required>
                        <label for="unidade_diluicao" data-i18n="hoursUnit">horas</label>

                        </div>

                        <div class="form-group">
                        <label for="data_hora_inicio" data-i18n="medStartLabel">Data e Hora da Primeira Dose:</label>
                        <input type="datetime-local" id="data_hora_inicio" name="data_hora_inicio" class="w-1/2 p-2 border rounded-lg" required>
                        </div>

                        <div class="form-group">
                        <label for="medico_prescritor" data-i18n="medDoctorLabel">Nome da(o) M√©dica(o) Prescritor(a):</label>
                        <div class="flex gap-2 w-1/2">
                            <input type="text" 
                                id="medico_prescritor" 
                                name="medico_prescritor" 
                                list="list-profissionais-drugs" 
                                class="flex-1 p-2 border rounded-lg" 
                                placeholder="Selecione ou digite..."
                                required>
                            
                            <ul id="suggestions-profissional-drugs" class="suggestions-list"></ul>

                            <button type="button" 
                                    onclick="openNewProfessionalModal('medico_prescritor')" 
                                    class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 rounded-md transition-colors" 
                                    title="Cadastrar Novo Profissional">
                            +
                            </button>
                        </div>
                        </div>
                        
                        <div class="form-group">
                        <label for="data_hora_suspensao" data-i18n="medSuspensionLabel">Data Prevista para Suspens√£o (Opcional):</label>
                        <input type="date" id="data_hora_suspensao" name="data_hora_suspensao" class="w-1/2 p-2 border rounded-lg">
                        </div>

                        <div class="form-group">
                        <label for="status_receita" data-i18n="medPayerLabel">Pago por:</label>
                        <select id="status_pagador" class="w-1/2 p-2 border rounded-lg" name="status_pagador" required>
                            <option value="P√∫blico" selected data-i18n="payerPublic">P√∫blico</option>
                            <option value="Plano" data-i18n="payerInsurance">Plano</option>
                            <option value="Particular" data-i18n="payerPrivate">Particular</option>
                        </select>
                        </div>

                        <div class="form-group">
                        <label for="status_receita" data-i18n="medStatusLabel">Status da Receita:</label>
                        <select id="status_receita" class="w-1/2 p-2 border rounded-lg" name="status_receita" required>
                            <option value="Ativa" selected data-i18n="statusActive">Ativa</option>
                            <option value="Suspensa" data-i18n="statusSuspended">Suspensa</option>
                        </select>
                        </div>

                        <button type="button" onclick="saveDrugs()" class="p-3 bg-indigo-500 text-white rounded-full shadow-lg hover:scale-110 transition-transform flex items-center justify-center space-x-2" data-i18n="savePrescriptionBtn">Salvar Prescri√ß√£o</button>
                        <button type="button" id="close-form-btn-Drug" class="p-3  text-white rounded-full shadow-lg hover:scale-110 transition-transform flex items-center justify-center space-x-2" style="margin-top:10px; background:#aaa;" data-i18n="closeButton">Fechar</button>
                    </form>
                    </div>
                </div>
                </div>
                    
            </div>
           
   
            <div class="mt-8 w-full">
            <div>         
                <button id="btnCadastrarDrug" class="p-3 bg-indigo-500 text-white rounded-full shadow-lg hover:scale-110 transition-transform flex items-center justify-center space-x-2" data-i18n="btnMedications"><b>+</b> Medica√ß√µes</button>
            
                <button id="open-form-btn" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50" data-i18n="btnIntravenous">Intravenosa</button>
            </div>  

            <div id="form-popup" class="popup" role="dialog" aria-modal="true" aria-labelledby="formTitle">
    
                <h3 id="formTitle"><i data-i18n="tipInfusionCalc">Dica: Use 2 dados para c√°lculo do 3¬∫</i></h3><br>
                
                <form id="infusion-form">
                    <label for="volume" data-i18n="calcVolume">Volume total (mL):</label>
                    <input type="number" id="volume" name="volume" min="0" step="any" class="w-1/2 p-2 border rounded-lg" 
                        placeholder="Ex: 500" data-i18n-placeholder="phVol" />

                    <label for="flow" data-i18n="calcFlow">Vaz√£o (mL/h):</label>
                    <input type="number" id="flow" name="flow" min="0" step="any" class="w-1/2 p-2 border rounded-lg" 
                        placeholder="Ex: 100" data-i18n-placeholder="phFlow" />

                    <fieldset>
                        <legend><b data-i18n="calcTime">Tempo de aplica√ß√£o:</b></legend>
                        <div id="time-fields">
                            <input type="number" id="hours" name="hours" min="0" class="w-1/2 p-2 border rounded-lg" 
                                placeholder="Horas" data-i18n-placeholder="phTimeH" />
                                
                            <input type="number" id="minutes" name="minutes" min="0" max="59" class="w-1/2 p-2 border rounded-lg" 
                                placeholder="Minutos" data-i18n-placeholder="phTimeM" />
                                
                            <input type="number" id="seconds" name="seconds" min="0" max="59" class="w-1/2 p-2 border rounded-lg" 
                                placeholder="Segundos" data-i18n-placeholder="phTimeS" />
                        </div>
                    </fieldset>

                    <button type="button" id="calculate-btn" class="p-3 text-green rounded-full shadow-lg hover:scale-110 transition-transform flex items-center justify-center space-x-2" 
                            data-i18n="btnCalculate">
                        Calcular
                    </button>
                    
                    <button type="button" id="reset-calc-btn" class="p-3 text-white rounded-full shadow-lg hover:scale-110 transition-transform flex items-center justify-center space-x-2" style="display:none; background:#f44336;"
                            data-i18n="btnRestart">
                        Reiniciar
                    </button> 
                    
                    <button type="button" id="start-btn" class="p-3 text-green rounded-full shadow-lg hover:scale-110 transition-transform flex items-center justify-center space-x-2" style="display:none;" 
                            data-i18n="btnStartInfusion">
                        Iniciar a infus√£o
                    </button>
                    
                    <button type="button" id="close-form-btn" class="p-3 text-white rounded-full shadow-lg hover:scale-110 transition-transform flex items-center justify-center space-x-2" style="margin-top:10px; background:#aaa;" 
                            data-i18n="closeButton">
                        Fechar
                    </button>
                </form>
            </div>
         
           <div id="multi-progress-panel" aria-live="polite" aria-atomic="true" aria-relevant="additions"></div>

            
            </div> 
                       
            <div>
            <br><br>            
            </div>  

            <div class="flex-grow flex items-center justify-center relative">
                <div class="absolute left-0 top-1/2 -translate-y-1/2 flex flex-col space-y-4 pr-16 md:pr-24" style="z-index: 30;">
                   <div class="flex items-center relative"> 
                   <button id='foodButton' onclick="performAction('food')" class="p-3 bg-orange-500 text-white rounded-full shadow-lg hover:scale-110 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            
                            <line x1="8" y1="22" x2="8" y2="2" />
                            <line x1="7" y1="2" x2="9" y2="2" />
                            <line x1="7" y1="5" x2="9" y2="5" />
                            
                            <line x1="16" y1="22" x2="16" y2="10" />
                            <path d="M16 10 L 19 8 L 16 2 Z" />
                        </svg>
                    </button>
                    <span id="notification-message-food" 
                      class="absolute z-10 left-full ml-3 px-3 py-1 bg-red-100 border-2 border-red-500 text-sm font-bold text-red-600 rounded-lg shadow-xl whitespace-nowrap hidden">
                    </span>
                    </div>

                    <div class="flex items-center relative"> 
                   <button onclick="performAction('meds')" class="p-3 bg-purple-500 text-white rounded-full shadow-lg hover:scale-110 transition-transform">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M7 21L17 21L18 5L6 5Z" stroke="currentColor"/>
                          <line x1="5" y1="5" x2="19" y2="5" stroke="currentColor"/>
                          <line x1="7" y1="13" x2="17" y2="13" stroke="currentColor" stroke-width="2"/>
                      </svg>
                  </button>
                  <span id="notification-message-meds" 
                      class="absolute z-10 left-full ml-3 px-3 py-1 bg-red-100 border-2 border-red-500 text-sm font-bold text-red-600 rounded-lg shadow-xl whitespace-nowrap hidden">
                    </span>
                  </div>

                    <div class="flex items-center relative"> 
                    <button onclick="performAction('infusion')" class="p-3 bg-yellow-500 text-white rounded-full shadow-lg hover:scale-110 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            
                            <path d="M 5 18 L 12 18 L 5 12 L 12 12" />
                            
                            <path d="M 12 13 L 17 13 L 12 9 L 17 9" />
                            
                            <path d="M 16 9 L 20 9 L 16 6 L 20 6" />
                        </svg>
                    </button>
                    <span id="notification-message-infusion" 
                      class="absolute z-10 left-full ml-3 px-3 py-1 bg-red-100 border-2 border-red-500 text-sm font-bold text-red-600 rounded-lg shadow-xl whitespace-nowrap hidden">
                    </span>
                    </div>

                    <div class="flex items-center relative">
                    <button onclick="performAction('physio')" class="p-3 bg-cyan-500 text-white rounded-full shadow-lg hover:scale-110 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="5" r="2"/>
                            <line x1="12" y1="7" x2="12" y2="15"/>
                            <path d="M12 10 L 15 12"/>
                            <path d="M12 10 L 9 12"/>
                            <path d="M12 15 L 14 21"/>
                            <path d="M12 15 L 10 18"/>
                        </svg>
                    </button>
                    <span id="notification-message-physio" 
                      class="absolute z-10 left-full ml-3 px-3 py-1 bg-red-100 border-2 border-red-500 text-sm font-bold text-red-600 rounded-lg shadow-xl whitespace-nowrap hidden">
                    </span>
                    </div>
                </div>

                <div class="relative flex-grow flex items-center justify-center">
    
    <div class="absolute left-0 top-1/2 -translate-y-1/2 flex flex-col space-y-4 pr-16 md:pr-24">
        </div>

   <div id="probContainer" class="relative w-40 h-40 flex items-center justify-center mt-8">
  <!-- Seta indicadora - posicionada acima e centralizada -->
  <div class="absolute -top-14 w-full flex justify-center z-40 pointer-events-none">
   <button 
    id="catheter-indicator-btn" 
    onclick="openCatheterModal()" 
    class="pointer-events-auto focus:outline-none transition-transform hover:scale-110 active:scale-95 flex items-center justify-center" 
    title="Gerenciar Acesso/Cateter">
    <svg 
        id="catheter-icon" 
        xmlns="http://www.w3.org/2000/svg" 
        viewBox="0 0 24 24" 
        fill="currentColor" 
        class="w-10 h-10 text-gray-300 drop-shadow-sm transition-colors duration-300">
        <path 
        fill-rule="evenodd" 
        d="M12 2.25a.75.75 0 01.75.75v16.19l2.47-2.47a.75.75 0 111.06 1.06l-3.75 3.75a.75.75 0 01-1.06 0l-3.75-3.75a.75.75 0 111.06-1.06l2.47 2.47V3a.75.75 0 01.75-.75z" 
        clip-rule="evenodd" />
    </svg>
    </button>
  </div>
  
<div class="relative w-40 h-40 flex items-center justify-center mx-auto mb-4">
  <svg 
    id="survivalCircleSvg" 
    class="absolute inset-0 transform -rotate-90 w-full h-full" 
    viewBox="0 0 160 160" 
    style="z-index: 10;">
    
    <circle 
      cx="80" 
      cy="80" 
      r="75" 
      stroke="#e5e7eb" 
      stroke-width="8" 
      fill="none"/>
      
    <circle 
      id="survivalProgressCircle" 
      cx="80" 
      cy="80" 
      r="75" 
      stroke="#198754" 
      stroke-width="8" 
      fill="none" 
      stroke-dasharray="471.24" 
      stroke-dashoffset="0" 
      stroke-linecap="round" 
      style="transition: stroke-dashoffset 1s ease-out, stroke 0.5s ease-in-out;"/>
  </svg>
  
  <img 
    id="patientAvatar" 
    src="https://placehold.co/160x160/cbd5e1/475569?text=P" 
    onclick="handleAvatarClick(event)" 
    alt="Paciente Avatar" 
    class="rounded-full object-cover relative cursor-pointer hover:opacity-90 transition-opacity shadow-inner" 
    style="width: 130px; height: 130px; z-index: 20; border: 4px solid white;">

  <div class="absolute -bottom-2 bg-white px-2 py-0.5 rounded-full shadow-md border border-gray-100 z-30 flex items-center gap-1">
      <span id="survivalPercentageText" class="text-xs font-bold text-green-600">100%</span>
  </div>
</div>

  <!-- Mensagem de status -->
  <div 
    id="statusMessage" 
    class="absolute bottom-full mb-2 p-2 bg-white rounded-lg shadow-md text-sm text-gray-700 whitespace-nowrap hidden" 
    style="z-index: 30;">
  </div>
</div>

    <div id="centralNotificationsContainer" class="absolute inset-0 flex items-center justify-center pointer-events-none" style="z-index: 100;">
    <div class="absolute right-0 top-1/2 -translate-y-1/2 flex flex-col space-y-4 pl-16 md:pl-24">
        </div>
</div>

                <div class="absolute right-0 top-1/2 -translate-y-1/2 flex flex-col space-y-4 pl-16 md:pl-24">                  
                  <div class="flex items-center relative">
                    <span id="notification-message-pain" 
                      class="absolute z-10 right-full mr-3 px-3 py-1 bg-red-100 border-2 border-red-500 text-sm font-bold text-red-600 rounded-lg shadow-xl whitespace-nowrap hidden">
                    </span>
                    <button onclick="performAction('pain')" class="p-3 bg-red-500 text-white rounded-full shadow-lg hover:scale-110 transition-transform">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-frown">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M16 16s-1.5-2-4-2-4 2-4 2"></path>
                        <line x1="9" y1="10" x2="9.01" y2="10"></line>
                        <line x1="15" y1="10" x2="15.01" y2="10"></line>
                      </svg>
                    </button>
                  </div>

                    <div class="flex items-center relative">
                      <span id="notification-message-heartbeat" 
                        class="absolute z-10 right-full mr-3 px-3 py-1 bg-red-100 border-2 border-red-500 text-sm font-bold text-red-600 rounded-lg shadow-xl whitespace-nowrap hidden">
                      </span>
                      <button onclick="performAction('heartbeat')" class="p-3 bg-blue-500 text-white rounded-full shadow-lg hover:scale-110 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-activity">
                          <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                        </svg>
                      </button>
                    </div>

                   <div class="flex items-center relative">
                        <span id="notification-message-blood" 
                            class="absolute z-10 right-full mr-3 px-3 py-1 bg-red-100 border-2 border-red-500 text-sm font-bold text-red-600 rounded-lg shadow-xl whitespace-nowrap hidden">
                        </span>
                        <button onclick="performAction('blood')" class="p-3 bg-red-600 text-white rounded-full shadow-lg hover:scale-110 transition-transform">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M8 5a4 4 0 0 1 8 0" transform="scale(1, -1) translate(0, -10)" /> 
                                
                                <line x1="12" y1="9" x2="12" y2="15" />
                                <circle cx="12" cy="18" r="3" />
                            </svg>
                        </button>
                    </div>

                 <div class="flex items-center relative">
                  <span id="notification-message-phone" 
                    class="absolute z-10 right-full mr-3 px-3 py-1 bg-red-100 border-2 border-red-500 text-sm font-bold text-red-600 rounded-lg shadow-xl whitespace-nowrap hidden">
                  </span>
                  <button onclick="performAction('phone')" class="p-3 bg-gray-500 text-white rounded-full shadow-lg hover:scale-110 transition-transform">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                      <circle cx="12" cy="7" r="4"/>
                      <line x1="11" y1="5" x2="13" y2="5"/>
                      <line x1="12" y1="4" x2="12" y2="6"/>
                    </svg>
                  </button>
                </div>

                </div>
            </div>
</div>
            

            <div class="flex justify-center items-center mt-auto w-full space-x-4">
    <!-- Conselho (mantido sem notifica√ß√£o) -->
    <button onclick="getDailyAdvice()" class="p-3 bg-indigo-500 text-white rounded-full shadow-lg hover:scale-110 transition-transform flex items-center justify-center space-x-2">
        <span class="text-sm">
            <span data-i18n="btnAdvice">Conselho</span> 
            ‚ú®
        </span>
    </button>
    
    <!-- Excretion -->
    <div class="relative flex flex-col items-center">
        <span id="notification-message-excretion" 
          class="absolute z-10 bottom-full mb-3 px-3 py-1 bg-red-100 border-2 border-red-500 text-sm font-bold text-red-600 rounded-lg shadow-xl whitespace-nowrap hidden">
        </span>
        <button onclick="performAction('excretion')" class="p-3 bg-teal-500 text-white rounded-full shadow-lg hover:scale-110 transition-transform">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                <path d="M 6 22 
                        C 6 19, 7 19, 8 19 
                        C 8 16, 10 16, 10 13
                        C 10 10, 11 10, 12 4
                        C 13 10, 14 10, 14 13
                        C 14 16, 16 16, 16 19
                        C 17 19, 18 19, 18 22 Z" />
                <line x1="7" y1="18.5" x2="17" y2="18.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <line x1="9" y1="15" x2="15" y2="15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <line x1="10" y1="11.5" x2="14" y2="11.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
        </button>
    </div>
    
    <!-- Shower -->
    <div class="relative flex flex-col items-center">
        <span id="notification-message-shower" 
          class="absolute z-10 bottom-full mb-3 px-3 py-1 bg-red-100 border-2 border-red-500 text-sm font-bold text-red-600 rounded-lg shadow-xl whitespace-nowrap hidden">
        </span>
        <button onclick="performAction('shower')" class="p-3 bg-cyan-400 text-white rounded-full shadow-lg hover:scale-110 transition-transform">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M 6 18 V 6" />
                <path d="M 6 10 C 6 6, 10 6, 14 6 H 18" />
                <line x1="6" y1="6" x2="8" y2="4" />
                <path d="M18 6v5 c 0 1.5 -1.5 1.5 -1.5 1.5 s -1.5 0 -1.5 -1.5" fill="none" />
                <circle cx="16.5" cy="14" r="1.5" fill="currentColor" stroke="none"/>
            </svg>
        </button>
    </div>
    
    <!-- AI Chat -->
    <div class="relative flex flex-col items-center">
        <span id="notification-message-ai" 
          class="absolute z-10 bottom-full mb-3 px-3 py-1 bg-red-100 border-2 border-red-500 text-sm font-bold text-red-600 rounded-lg shadow-xl whitespace-nowrap hidden">
        </span>
        <button onclick="openChatModal('ai')" class="p-3 bg-green-500 text-white rounded-full shadow-lg hover:scale-110 transition-transform flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="5" y="6" width="14" height="12" rx="2"/>
                <circle cx="9" cy="10" r="1"/>
                <circle cx="15" cy="10" r="1"/>
                <path d="M9 14 c 1.5 2 4.5 2 6 0"/>
                <line x1="12" y1="6" x2="12" y2="3"/>
                <circle cx="12" cy="3" r="1.5" fill="currentColor" stroke="none"/>
            </svg>
        </button>
    </div>
    
    <!-- Caregiver Chat -->
    <div class="relative flex flex-col items-center">
        <span id="notification-message-caregiver" 
          class="hidden absolute -top-1 -right-1 h-3.5 w-3.5 bg-red-600 rounded-full border-2 border-white z-20 shadow-sm">
        </span>       
        <button onclick="openChatModal('caregiver')" class="p-3 bg-blue-500 text-white rounded-full shadow-lg hover:scale-110 transition-transform flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-users">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>            
        </button>
    </div>
</div>

  <div id="modal-care-hub" class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeCareHub(event)">
    <div class="bg-white w-full md:w-[600px] h-[90vh] md:h-auto md:max-h-[90vh] rounded-xl shadow-2xl overflow-y-auto fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 p-0 flex flex-col" onclick="event.stopPropagation()">
        
        <div class="bg-gradient-to-r from-teal-600 to-emerald-600 p-6 rounded-t-xl flex items-center gap-4 text-white relative">              
            <img id="hub-avatar" hidden src="" class="w-16 h-16 rounded-full border-4 border-white shadow-md bg-gray-200 object-cover">
            <div>
                <h2 id="hub-patient-name" class="text-xl font-bold" data-i18n="loading">Carregando...</h2>
                <p id="hub-patient-status" class="text-sm opacity-90" data-i18n="hubHeaderStatus">Hub de Atendimento,<br> Decis√£o e Evolu√ß√£o</p>
            </div>                          
        </div>

        <div class="p-6 space-y-8 flex-grow">

             <section>
                <div class="flex justify-between items-center mb-3">     
                    <h3 class="text-gray-700 font-bold mb-3 flex items-center gap-2">                   
                        <span class="bg-red-100 text-red-600 p-1 rounded">üìñ</span> 
                        <span data-i18n="hubDiary">Di√°rio</span>
                    </h3>
                    <button onclick="hubToggleHistoryView()" id="hub-btn-toggle-history" class="text-sm text-teal-600 font-medium hover:underline" data-i18n="btnReadStories">Ler Hist√≥rias</button>
                </div>

                <div class="relative group">
                <button onclick="openLegacyModal()" class="bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 hover:from-indigo-600 hover:to-pink-600 text-white px-3 py-2 rounded-lg shadow-md text-sm font-medium transition-all transform hover:scale-105 flex items-center gap-2 ring-1 ring-purple-300">
                    <div class="flex items-center text-white">
                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                        <span class="mx-1 text-[10px] opacity-80">‚ûù</span>
                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <span class="hidden sm:inline" data-i18n="hubLegacyAI">Legado IA</span>
                </button>

                <div class="absolute bottom-full mb-2 left-1/2 transform -translate-x-1/2 w-48 bg-gray-900 text-white text-xs rounded py-1 px-2 hidden group-hover:block text-center z-50 pointer-events-none">
                    <span data-i18n="tooltipStories">Transforme o di√°rio em um livro ou filme no futuro!</span>
                    <div class="absolute top-full left-1/2 -ml-1 border-4 border-transparent border-t-gray-900"></div>
                </div>

                <div id="hub-history-write-mode">
                    <textarea id="hub-history-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 text-sm" rows="3" 
                              placeholder="Registre inseguran√ßas, sustos, conquistas ou relatos de hoje..." data-i18n-placeholder="hubWriteStory"></textarea>
                    <div class="flex justify-between items-center mt-2">
                        <label class="flex items-center gap-2 text-xs text-gray-600 cursor-pointer">
                            <input type="checkbox" id="hub-history-public" checked class="rounded text-teal-600">
                            <span data-i18n="checkVisibleTeam">Vis√≠vel para a equipe</span>
                        </label>
                        <button onclick="hubSaveHistory()" class="bg-teal-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-teal-700 transition" data-i18n="hubPublish">Publicar</button>
                    </div>
                </div>

                <div id="hub-history-read-mode" class="hidden space-y-3 max-h-40 overflow-y-auto bg-gray-50 p-2 rounded-lg border border-gray-200">
                    <p class="text-center text-gray-400 text-xs italic" data-i18n="statusLoadingStories">Carregando hist√≥rias...</p>
                </div>
            </section>
            
   

            <hr class="border-gray-100">

              <section>
        <h3 class="text-gray-700 font-bold mb-3 flex items-center gap-2">
            <span class="bg-red-100 text-red-600 p-1 rounded">üè•</span> 
            <span data-i18n="hubEmergency">Pronto Atendimento | UTI</span>
        </h3>

    <div id="monitorSVAlarm" class="mb-4 p-4 bg-slate-900 rounded-xl border-2 border-slate-700 shadow-inner">
        <div class="grid grid-cols-2 gap-4">

            <div class="flex flex-col">
                <div class="flex justify-between items-center text-[10px] text-red-400 font-bold uppercase mb-1">
                    <span>‚ù§Ô∏è BPM</span>
                    <div class="flex gap-1 text-[9px] text-slate-500">
                        min:<input type="number" id="limit-hr-min" value="60" class="w-8 bg-transparent border-b border-slate-700 text-center">
                        max:<input type="number" id="limit-hr-max" value="100" class="w-8 bg-transparent border-b border-slate-700 text-center">
                    </div>
                </div>
                <div class="flex flex-row items-center justify-between h-10">
                    <div id="val-hr" class="text-3xl font-mono text-red-500 leading-none">--</div>
                    <div id="slot-batt-hr" class="flex items-center justify-end min-w-[70px]"></div>
                </div>
            </div>

            <div class="flex flex-col">
                <div class="flex justify-between items-center text-[10px] text-orange-400 font-bold uppercase mb-1">
                    <span>üå°Ô∏è TEMP</span>
                    <div class="flex gap-1 text-[9px] text-slate-500">
                        min:<input type="number" id="limit-temp-min" value="35.0" step="0.1" class="w-10 bg-transparent border-b border-slate-700 text-center">
                        max:<input type="number" id="limit-temp-max" value="37.8" step="0.1" class="w-10 bg-transparent border-b border-slate-700 text-center">
                    </div>
                </div>
                <div class="flex flex-row items-center justify-between h-10">
                    <div id="val-temp" class="text-3xl font-mono text-orange-500 leading-none">
                        --<span id="unitMonitorTemp" class="text-sm">¬∞C</span>
                    </div>
                    
                    <div id="slot-batt-temp" class="flex items-center justify-end min-w-[70px]"></div>
                </div>
            </div>

            <div class="flex flex-col">
                <div class="flex justify-between items-center text-[10px] text-blue-400 font-bold uppercase mb-1">
                    <span>ü©∏ SpO2</span>
                    <div class="flex gap-1 text-[9px] text-slate-500">
                        min:<input type="number" id="limit-spo2-min" value="92" class="w-8 bg-transparent border-b border-slate-700 text-center">
                    </div>
                </div>
                <div class="flex flex-row items-center justify-between h-10">
                    <div id="val-spo2" class="text-3xl font-mono text-blue-500 leading-none">--<span class="text-sm">%</span></div>
                    <div id="slot-batt-spo2" class="flex items-center justify-end min-w-[70px]"></div>
                </div>
            </div>

            <div class="flex flex-col">
                <div class="flex justify-between items-center text-[10px] text-green-400 font-bold uppercase mb-1">
                    <span>üí™ P.A.</span>
                </div>
                <div class="flex flex-row items-center justify-between h-10">
                    <div id="val-bp" class="text-2xl font-mono text-green-500 leading-none">--/--</div>
                    <div id="slot-batt-bp" class="flex items-center justify-end min-w-[70px]"></div>
                </div>
            </div>

        </div>
    </div>
        
        <div class="grid grid-cols-2 gap-3 mb-4">

            <button id="btnOpenBleModal" onclick="abrirGuiaSincronizacao()"  class="flex flex-col items-center justify-center p-3 bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded-lg transition-all text-xs font-semibold text-blue-800 shadow-sm">
                <span class="text-2xl mb-1">üì°</span> 
                <span class="text-center">
                    <span data-i18n="btnSyncWearables">Sincronizar Wearables</span>
                </span>
            </button>

            <button onclick="hubLogEmergency('Transfus√£o de Hem√°cias')" class="flex flex-col items-center justify-center p-3 bg-red-50 hover:bg-red-100 border border-red-200 rounded-lg transition-all text-xs font-semibold text-red-800 shadow-sm">
                <span class="text-2xl mb-1">ü©∏</span> 
                <span class="text-center" data-i18n="btnTransfusionRBC">Transfus√£o de Hem√°cias</span>
            </button>

            <button onclick="hubLogEmergency('Transfus√£o de Plaquetas')" class="flex flex-col items-center justify-center p-3 bg-yellow-50 hover:bg-yellow-100 border border-yellow-200 rounded-lg transition-all text-xs font-semibold text-yellow-800 shadow-sm">
                <span class="text-2xl mb-1">üü°</span> 
                <span class="text-center" data-i18n="btnTransfusionPlatelets">Transfus√£o de Plaquetas</span>
            </button>

            <button onclick="hubLogEmergency('Transfus√£o de Granul√≥citos')" class="flex flex-col items-center justify-center p-3 bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded-lg transition-all text-xs font-semibold text-slate-700 shadow-sm">
                <span class="text-2xl mb-1">üõ°Ô∏è</span> 
                <span class="text-center" data-i18n="btnTransfusionGranulo">Transfus√£o de Granul√≥citos</span>
            </button>

            <button onclick="hubLogEmergency('Antit√©rmico')" class="flex flex-col items-center justify-center p-3 bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded-lg transition-all text-xs font-semibold text-blue-700 shadow-sm">
                <span class="text-2xl mb-1">üíä</span> 
                <span class="text-center" data-i18n="btnMedAntipyretic">Medica√ß√£o Antit√©rmico</span>
            </button>

            <button onclick="hubLogEmergency('Oxig√™nio')" class="flex flex-col items-center justify-center p-3 bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded-lg transition-all text-xs font-semibold text-blue-700 shadow-sm">
                <span class="text-2xl mb-1">üçÉ</span> 
                <span class="text-center" data-i18n="btnGasOxygen">G√°s Oxig√™nio</span>
            </button>
        </div>

        <div class="bg-gray-50 border border-gray-200 rounded-lg p-2 flex items-center justify-between shadow-inner">
            <button onclick="hubNavigateEmergencyLog(1)" class="p-2 text-gray-400 hover:text-indigo-600 hover:bg-gray-200 rounded-full transition">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
            </button>

            <div id="hub-emergency-log-display" class="flex-grow text-center">
                <p class="text-xs text-gray-500 italic" data-i18n="statusLoadingHistory">Carregando hist√≥rico...</p>
            </div>

            <button onclick="hubNavigateEmergencyLog(-1)" class="p-2 text-gray-400 hover:text-indigo-600 hover:bg-gray-200 rounded-full transition">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
            </button>
        </div>
              </section>

            <hr class="border-gray-100">

            <section class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                <h3 class="text-indigo-800 font-bold mb-3 flex items-center gap-2">
                    <span>‚öñÔ∏è</span> <span data-i18n="hubDecisions">Enquete para Decis√£o</span>
                    <span class="text-xs font-normal bg-white px-2 py-0.5 rounded-full border border-indigo-200 text-indigo-600" id="hub-decision-status" data-i18n="msgNoActiveDecisions">Nenhuma ativa</span>
                </h3>

                <div id="hub-decision-display-area" class="mb-4">
                    <div class="text-center text-gray-500 text-sm py-4" data-i18n="msgNoDecisions">Sem decis√µes pendentes.</div>
                </div>
                
                <div class="flex gap-2 justify-between items-center mt-2">
                    <div class="flex gap-1">
                        <button onclick="hubNavigateDecision(-1)" class="p-2 bg-white rounded-full shadow hover:bg-gray-100 text-gray-600">‚¨ÖÔ∏è</button>
                        <button onclick="hubNavigateDecision(1)" class="p-2 bg-white rounded-full shadow hover:bg-gray-100 text-gray-600">‚û°Ô∏è</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="hubOpenNewDecisionForm()" class="text-xs bg-indigo-600 text-white px-3 py-2 rounded-lg shadow hover:bg-indigo-700" data-i18n="hubNewDecision">Nova Decis√£o</button>
                        <button onclick="hubOpenAddMember()" class="text-xs bg-white text-indigo-600 border border-indigo-200 px-3 py-2 rounded-lg hover:bg-indigo-50" data-i18n="hubAddMember">+ Membro</button>
                    </div>
                </div>

                <div id="hub-new-decision-form" class="hidden mt-4 bg-white p-3 rounded-lg shadow-inner border border-gray-200">
                    <label class="block text-xs font-bold text-gray-500 mb-1" data-i18n="labelDecisionTitle">T√≠tulo da Decis√£o:</label>
                    <input type="text" id="hub-new-dec-title" placeholder="Ex: Troca de Hospital" data-i18n-placeholder="phDecisionTitle" class="w-full mb-2 p-2 text-sm border rounded">
                    
                    <label class="block text-xs font-bold text-gray-500 mb-1" data-i18n="labelDeadline">Data Limite (Prazo):</label>
                    <input type="datetime-local" id="hub-new-dec-deadline" class="w-full mb-2 p-2 text-sm border rounded text-gray-600">

                    <label class="block text-xs font-bold text-gray-500 mb-1" data-i18n="labelDetails">Detalhes:</label>
                    <textarea id="hub-new-dec-desc" placeholder="Detalhes, termo de consentimento, etc." data-i18n-placeholder="phDecisionDetails" class="w-full mb-2 p-2 text-sm border rounded" rows="2"></textarea>
                    
                    <label class="block text-xs font-bold text-gray-500 mb-1" data-i18n="labelVoteOptions">Op√ß√µes de Voto:</label>
                    <input type="text" class="w-full mb-2 p-2 text-sm border rounded hub-new-dec-opt" placeholder="Op√ß√£o 1 (Descreva, cite vantagens/desvantagens)" data-i18n-placeholder="phOption1">
                    <input type="text" class="w-full mb-2 p-2 text-sm border rounded hub-new-dec-opt" placeholder="Op√ß√£o 2 (Descreva, cite vantagens/desvantagens)" data-i18n-placeholder="phOption2">
                    
                    <div class="flex justify-end gap-2 mt-2">
                        <button onclick="document.getElementById('hub-new-decision-form').classList.add('hidden')" class="text-xs text-gray-500 hover:text-gray-700" data-i18n="cancelButton">Cancelar</button>
                        <button onclick="hubSubmitNewDecision()" class="text-xs bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded font-bold shadow" data-i18n="saveButton">Criar Decis√£o</button>
                    </div>
                </div>
                
                <div id="hub-add-member-form" class="hidden mt-2 p-2 bg-white rounded border">
                    <input type="email" id="hub-invite-email" placeholder="E-mail do cuidador" data-i18n-placeholder="phCaregiverEmail" class="w-full p-2 border rounded text-sm mb-2">
                    <button onclick="hubInviteMember()" class="w-full bg-blue-500 text-white text-xs py-1 rounded" data-i18n="btnSendInvite">Enviar Convite</button>
                </div>
            </section>

            <hr class="border-gray-100">

            <section class="grid grid-cols-2 gap-4 pt-2">  

                <div id="survivor-widget-container" class="col-span-2 mb-6 px-2">
                    <button id="btn-overall-survivor" class="w-full relative overflow-hidden rounded-2xl p-6 transition-all duration-500 shadow-lg border-2 border-yellow-400 group" style="height: 140px;">
                        <div class="absolute inset-0 bg-gradient-to-br from-yellow-300 via-yellow-500 to-amber-600 opacity-90"></div>
                        
                        <div id="survivor-shine" class="absolute inset-0 bg-white opacity-0 pointer-events-none"></div>

                        <div class="relative z-10 flex flex-col items-center justify-center h-full text-white text-center">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-3xl">üèÜ</span>
                                <h3 class="font-black text-lg uppercase tracking-widest shadow-sm" data-i18n="widgetSurvivorTitle">Trof√©u Overall [Vit√≥ria]</h3>
                            </div>
                            
                            <div class="w-full bg-black/20 rounded-full h-4 mt-2 border border-white/30 overflow-hidden">
                                <div id="survivor-progress-bar" class="bg-gradient-to-r from-green-400 to-white h-full transition-all duration-1000 shadow-[0_0_15px_rgba(255,255,255,0.8)]" style="width: 0%"></div>
                            </div>
                            
                            <p id="survivor-countdown" class="mt-2 font-mono text-sm font-bold drop-shadow-md" data-i18n="widgetSurvivorCalc">
                                Calculando tempo para a vit√≥ria...
                            </p>
                        </div>
                    </button>
                </div>

                <div>                        
                    <button onclick="forceCloseCareHub()" class="w-full py-3 bg-green-500 hover:bg-gray rounded-lg text-gray-200 font-semibold text-sm border border-gray-600 transition flex items-center justify-center gap-2">
                       <span>üèÜ</span> <span data-i18n="btnBackToCare">Voltar a cuidar</span>
                    </button>
                </div>
                <div>
                    <button onclick="hubInitiateEndJourney()" class="w-full py-3 bg-gray-800 hover:bg-black rounded-lg text-gray-200 font-semibold text-sm border border-gray-600 transition flex items-center justify-center gap-2">
                        <span>üïäÔ∏è</span> <span data-i18n="hubEndJourney">Fim da Jornada</span>
                    </button>
                </div>                
                
            </section>
        </div>
    </div>
</div>

            <div>
            <br>
            </div> 
            
            <div class="flex justify-between mt-4">
                <button onclick="returnToPatientSelection()" class="bg-violet-500 text-white p-2 rounded-lg" data-i18n="btnExitScene"><b></b>Sair de cena</button>
                <button onclick="logOut()" class="bg-red-500 text-white p-2 rounded-lg" data-i18n="logoutButton">Deslogar</button>
            </div>

        </div>

    <div id="bleModal" class="fixed inset-0 bg-black/60 hidden z-[9999] flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white dark:bg-slate-800 rounded-2xl max-w-sm w-full overflow-hidden shadow-2xl border border-gray-200 dark:border-slate-700">
        <div class="bg-blue-600 p-4 text-white flex justify-between items-center">
            <h3 class="font-bold flex items-center gap-2">
                <span>üì°</span> 
                <span data-i18n="bleTitle">Conectar Sensores</span>
            </h3>
            <button onclick="document.getElementById('bleModal').classList.add('hidden')" class="text-2xl leading-none">&times;</button>
        </div>
        
        <div class="p-6">
            <button id="btnScanBle" onclick="buscarDispositivosBLE()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-bold transition-all shadow-lg active:scale-95 flex flex-col items-center gap-1">
                <span class="text-xl">üîç</span>
                <span data-i18n="btnScanBle">Escanear Dispositivo</span>
            </button>
            
            <div id="bleStatus" class="text-center mt-4 text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="statusWaitingConnection">
                Aguardando conex√£o...
            </div>

            <div id="connectedDevicesList" class="mt-4 space-y-2">
                </div>

            <div class="mt-6 grid grid-cols-2 gap-2 border-t pt-4 border-gray-100 dark:border-slate-700">
                <div id="ind-hr" class="flex items-center gap-2 text-[10px] p-2 rounded bg-gray-50 dark:bg-slate-900 text-gray-400 transition-colors">
                    <span>‚ù§Ô∏è</span> <span data-i18n="labelHR">HR</span>
                </div>
                <div id="ind-temp" class="flex items-center gap-2 text-[10px] p-2 rounded bg-gray-50 dark:bg-slate-900 text-gray-400 transition-colors">
                    <span>üå°Ô∏è</span> <span data-i18n="labelTemp">TEMP</span>
                </div>
                <div id="ind-ox" class="flex items-center gap-2 text-[10px] p-2 rounded bg-gray-50 dark:bg-slate-900 text-gray-400 transition-colors">
                    <span>ü©∏</span> <span data-i18n="labelSpO2">SpO2</span>
                </div>
                <div id="ind-bp" class="flex items-center gap-2 text-[10px] p-2 rounded bg-gray-50 dark:bg-slate-900 text-gray-400 transition-colors">
                    <span>üí™</span> <span data-i18n="labelBP">PA</span>
                </div>
            </div>
        </div>
    </div>
</div>   

    <div id="modalIgnorar" class="popup" role="dialog" aria-modal="true" aria-labelledby="formTitle">  
    <div class="mt-8 w-full">
      <div class="modal-content">
        <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-sm md:max-w-md">
          
            <h2 id="ignorarTitulo">
                <i data-i18n="ignoreActionTitle">Confirma√ß√£o de A√ß√£o</i>
            </h2>
    
            <p>
                <span data-i18n="textIgnoreMsgPart1">Voc√™ est√° ignorando a dose de</span> 
                <strong id="medNomeIgnorar"></strong>, 
                <span data-i18n="textIgnoreMsgPart2">prevista para</span> 
                <span id="medHoraIgnorar"></span>.
            </p>
    
            <div class="opcoes-ignorar">
                <button id="btnIgnorarDose" type="button" class="btn-ignorar-acao">
                  <span class="block font-bold" data-i18n="ignoreOnceBtn">Ignorar S√ì AGORA</span>
                  <small data-i18n="subTextIgnoreOnce">N√£o afeta as doses futuras.</small>
                </button>
        
                <button id="btnSuspenderReceita" type="button" class="btn-suspender-acao">
                  <span class="block font-bold" data-i18n="suspendRxBtn">Suspender Uso</span>
                  <small data-i18n="subTextSuspendRx">Cancela esta e todas as doses futuras.</small>
                </button>
            </div>
    
            <textarea id="motivoObservacao" 
                      placeholder="Opcional: Descreva o motivo..." 
                      data-i18n-placeholder="phIgnoreReason"></textarea>

            <span class="p-3 text-white rounded-full shadow-lg hover:scale-110 transition-transform flex items-center justify-center space-x-2 cursor-pointer" 
                  style="margin-top:10px; background:#aaa;"  
                  onclick="fecharModalIgnorar()">
                  &times; <span data-i18n="closeButton">Fechar</span>
            </span>
          
        </div>
      </div>
    </div>
</div>
     
   <div id="confirmModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-[900000]">
    <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-sm md:max-w-md">
        <h3 id="confirmModalTitle" class="text-xl font-bold text-gray-800 mb-4" data-i18n="confirmationTitle">
            Confirma√ß√£o
        </h3>
        
        <p id="confirmModalMessage" class="text-gray-600 mb-6"></p>
        
        <div class="flex justify-end space-x-4">
            <button id="confirmCancelBtn" 
                    class="bg-gray-400 text-white font-semibold py-3 px-6 rounded-xl hover:bg-gray-500 transition-colors" 
                    data-i18n="cancelButton">
                Cancelar
            </button>
            
            <button id="confirmProceedBtn" 
                    class="bg-red-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-red-700 transition-colors" 
                    data-i18n="btnConfirm">
                Confirmar
            </button>
        </div>
    </div>
</div>

<div id="messageModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-[900000]">
    <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-sm md:max-w-md">
        <h3 id="modalTitle" class="text-xl font-bold text-gray-800 mb-4"></h3>
        <p id="modalMessage" class="text-gray-600 mb-6"></p>
        
        <button onclick="closeModal()" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-xl hover:bg-blue-700 transition-colors" data-i18n="closeButton">
            Fechar
        </button>
    </div>
</div>

    <!-- Modal de Configura√ß√µes do Local/Paciente -->
 <div id="locationModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-[10000]">
    <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-sm md:max-w-md transition-all duration-300">
        
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800" data-i18n="locationLabel">Atualizar Onde Paciente Est√°</h3>
            <label class="inline-flex items-center cursor-pointer">
                <span class="mr-3 text-sm font-medium text-gray-900" id="toggleLabelText" data-i18n="locationResidence">Resid√™ncia</span>
                <input type="checkbox" id="locationToggle" class="sr-only peer" onchange="toggleLocationMode()">
                <div class="relative w-14 h-7 bg-green-500 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:start-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-blue-600"></div>
            </label>
        </div>
        
        <div class="mb-3">
            <label for="hospitalNameInput" class="block text-sm font-medium text-gray-700" id="lblLocalName" data-i18n="locHospitalName">Nome do Local:</label>
            <input id="hospitalNameInput" type="text" placeholder="Casa de Paciente" data-i18n-placeholder="phLocHome" 
                   class="w-full p-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500">
        </div>

        <div id="hospitalFields" class="hidden transition-all duration-500 ease-in-out">
            <div class="grid grid-cols-2 gap-4 mb-3">
                <div>
                    <label for="hospitalSector" class="block text-sm font-medium text-gray-700" data-i18n="locSector">Setor:</label>
                    <input id="hospitalSector" type="text" placeholder="Ex: UTI 2" data-i18n-placeholder="phLocSector" 
                           class="w-full p-2 border border-gray-300 rounded-xl">
                </div>
                <div>
                    <label for="hospitalFloor" class="block text-sm font-medium text-gray-700" data-i18n="locFloor">Andar:</label>
                    <input id="hospitalFloor" type="text" placeholder="Ex: 5¬∫" data-i18n-placeholder="phLocFloor" 
                           class="w-full p-2 border border-gray-300 rounded-xl">
                </div>
            </div>

            <div class="mb-3">
                <label for="hospitalBed" class="block text-sm font-medium text-gray-700" data-i18n="locBed">Leito / Quarto:</label>
                <input id="hospitalBed" type="text" placeholder="Ex: 21B" data-i18n-placeholder="phLocBed" 
                       class="w-full p-2 border border-gray-300 rounded-xl">
            </div>

            <div class="mb-4">
                <label for="admissionDate" class="block text-sm font-medium text-gray-700" data-i18n="locAdmissionDate">Data de Interna√ß√£o:</label>
                <input id="admissionDate" type="date" class="w-full p-2 border border-gray-300 rounded-xl" onchange="calculateLocationDays()">
            </div>
        </div>
        
        <div class="mt-4">
            <label for="loc_freq_limpeza" class="block text-sm font-medium text-gray-700" data-i18n="locCleaningFreq">
                Frequ√™ncia de Limpeza Terminal (em dias)
            </label>
            <div class="mt-1 relative rounded-md shadow-sm">
                <input type="number" name="loc_freq_limpeza" id="loc_freq_limpeza" 
                    class="focus:ring-blue-500 focus:border-blue-500 block w-full pl-3 sm:text-sm border-gray-300 rounded-md" 
                    placeholder="Ex: 7" min="1">
                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                    <span class="text-gray-500 sm:text-sm" data-i18n="unitDays">dias</span>
                </div>
            </div>
            <p class="mt-1 text-xs text-gray-500" data-i18n="tipCleaningChecklist">Define o alerta para o checklist de TMO.</p>
        </div>

        <div id="cleaningActionContainer" class="mt-4"></div>

        <div class="mb-6 text-center bg-blue-50 p-3 rounded-lg">
            <p class="text-gray-700 text-sm" data-i18n="labelTimeOnLoc">Tempo no Local:</p>
            
            <span id="daysInHospital" class="text-2xl font-bold text-blue-700">0</span> 
            <span class="text-sm text-blue-700" data-i18n="unitDays">dias</span>
            
            <p id="gpsStatus" class="text-xs text-gray-400 mt-2">
                üìç <span data-i18n="statusGPS">GPS aguardando...</span>
            </p>
        </div>

        <div class="flex space-x-4">
            <button onclick="closeLocationModal()" class="flex-grow bg-gray-400 text-white font-semibold py-3 rounded-xl hover:bg-gray-500 transition-colors" data-i18n="cancelButton">Cancelar</button>
            <button id="btnSaveLocation" onclick="saveLocationSettings()" class="flex-grow bg-blue-600 text-white font-semibold py-3 rounded-xl hover:bg-blue-700 transition-colors flex justify-center items-center">
                <span data-i18n="btnSaveLocation">Salvar Localiza√ß√£o</span>
            </button>
        </div>
    </div>
</div>

   <div id="aiChatModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-xl shadow-lg w-full max-w-sm md:max-w-md flex flex-col h-[80vh]">
        
        <div class="bg-green-600 text-white p-4 rounded-t-xl flex justify-between items-center">
            <h3 class="text-xl font-bold" data-i18n="aiChatTitle">Dr. Intelig√™ncia Artificial</h3>
            
            <button onclick="closeChatModal('ai')" class="text-white hover:text-gray-200 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        
        <div id="aiChatHistory" class="flex-grow p-4 overflow-y-auto flex flex-col space-y-4">
            </div>
        
        <div class="p-4 bg-gray-100 rounded-b-xl flex items-center">
            <input id="aiChatInput" type="text" 
                   placeholder="Digite sua mensagem..." 
                   data-i18n-placeholder="aiChatInputPlaceholder"
                   class="flex-grow p-3 rounded-l-xl focus:outline-none focus:ring-2 focus:ring-blue-500 border-r-0">
            
            <button onclick="sendMessage('ai')" class="bg-green-600 text-white p-3 rounded-r-xl hover:bg-green-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </button>
        </div>
    </div>
</div>

  <div id="caregiverChatModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-xl shadow-lg w-full max-w-sm md:max-w-md flex flex-col h-[80vh]">
        
        <div class="bg-blue-600 text-white p-4 rounded-t-xl flex justify-between items-center">
            <h3 class="text-xl font-bold" data-i18n="caregiverChatTitle">Chat de Cuidadores</h3>
            <button onclick="closeChatModal('caregiver')" class="text-white hover:text-gray-200 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        
        <div class="p-3 border-b border-gray-200 bg-gray-50">
            <label for="chatFilter" class="block text-xs font-medium text-gray-700 mb-1" data-i18n="labelViewConv">Visualizar Conversas:</label>
            <select id="chatFilter" onchange="pollCaregiverChat(true)" class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                <option value="patient" data-i18n="optChatPatientOnly">Somente Paciente Selecionado</option>
                <option value="nearby" data-i18n="optChatNearby">Cuidadores Pr√≥ximos (Raio de 1 km)</option>
            </select>
        </div>
        
        <div class="p-4 flex flex-wrap gap-2 justify-center border-b border-gray-200">
            <p class="text-sm font-semibold text-gray-700">
                <span data-i18n="labelPatient">Paciente</span>: 
                <span id="caregiverChatPatientName"></span>
            </p>
        </div>
        
        <div id="caregiverChatHistory" class="flex-grow p-4 overflow-y-auto flex flex-col space-y-4">
            </div>
        
        <div class="p-4 bg-gray-100 rounded-b-xl flex items-center">
            <input id="caregiverChatInput" type="text" 
                   placeholder="Digite sua mensagem..." 
                   data-i18n-placeholder="phMessageGeneric"
                   class="flex-grow p-3 rounded-l-xl focus:outline-none focus:ring-2 focus:ring-blue-500 border-r-0">
            
            <button onclick="sendMessage('caregiver')" class="bg-blue-600 text-white p-3 rounded-r-xl hover:bg-blue-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </button>
        </div>
    </div>
</div>

  </div>


<div id="physicalMeasurementsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 shadow-2xl w-full max-w-md">
        <h2 class="text-xl font-bold mb-4 text-gray-800" data-i18n="titlePhysicalMeasurements">Registro de Medidas F√≠sicas</h2>
        
        <form id="physicalMeasurementsForm" onsubmit="return false;">

            <div class="mb-4">
                <label for="pMWeight" class="block text-sm font-medium text-gray-700 mb-1">
                    <span data-i18n="labelWeight">Peso</span> 
                    (<span id="unitLabelWeight">kg</span>):
                </label>
                <div class="flex items-center space-x-3 mb-2">
                    <input type="range" id="rangeWeight" min="1" max="150" step="0.1" value="0"
                           class="flex-grow h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    
                    <input type="number" step="0.1" id="pMWeight" name="weight" placeholder="0.0" 
                           class="w-1/4 p-2 border border-gray-300 rounded-md text-center" readonly>
                    
                    <select id="selUnitWeight" onchange="setMeasurementUnits(this.value)" 
                            class="p-2 border border-gray-300 rounded-md bg-white w-1/4 cursor-pointer hover:bg-gray-50">
                        <option value="metric">kg</option>
                        <option value="imperial">lbs</option>
                    </select>
                </div>
            </div>

            <div class="mb-4">
                <label for="pMHeight" class="block text-sm font-medium text-gray-700 mb-1">
                    <span data-i18n="labelHeight">Altura</span> 
                    (<span id="unitLabelHeight">m</span>):
                </label>
                <div class="flex items-center space-x-3 mb-2">
                    <input type="range" id="rangeHeight" min="0.5" max="2.5" step="0.01" value="0.5"
                           class="flex-grow h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    
                    <input type="number" step="0.01" id="pMHeight" name="height" placeholder="0.00" 
                           class="w-1/4 p-2 border border-gray-300 rounded-md text-center" readonly>
                    
                    <select id="selUnitHeight" onchange="setMeasurementUnits(this.value)" 
                            class="p-2 border border-gray-300 rounded-md bg-white w-1/4 cursor-pointer hover:bg-gray-50">
                        <option value="metric">m</option>
                        <option value="imperial">ft</option>
                    </select>
                </div>
            </div>

            <div class="mb-4">
                <label for="pMAbdominalCircumference" class="block text-sm font-medium text-gray-700 mb-1">
                    <span data-i18n="labelAbdCircumference">Circunfer√™ncia Abdominal</span> 
                    (<span id="unitLabelCirc">cm</span>):
                </label>
                <div class="flex items-center space-x-3 mb-2">
                    <input type="range" id="rangeCircumference" min="10" max="150" step="0.1" value="10"
                           class="flex-grow h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    
                    <input type="number" step="0.1" id="pMAbdominalCircumference" name="abdominalCircumference" placeholder="0.0" 
                           class="w-1/4 p-2 border border-gray-300 rounded-md text-center" readonly>
                    
                    <select id="selUnitCirc" onchange="setMeasurementUnits(this.value)" 
                            class="p-2 border border-gray-300 rounded-md bg-white w-1/4 cursor-pointer hover:bg-gray-50">
                        <option value="metric">cm</option>
                        <option value="imperial">in</option>
                    </select>
                </div>
            </div>

            <div class="mb-6">
                <label for="pMNotes" class="block text-sm font-medium text-gray-700 mb-1" data-i18n="labelNotes">Observa√ß√µes:</label>
                <textarea id="pMNotes" name="notes" rows="3" 
                          class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" 
                          data-i18n-placeholder="phMeasurementNotes"></textarea>
            </div>

            <div class="flex justify-between items-center mt-4">
                <button type="button" onclick="closePhysicalMeasurementsModal()" 
                        class="px-4 py-2 text-gray-600 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors" data-i18n="cancelButton">
                    Cancelar
                </button>
                <button type="submit" onclick="savePhysicalMeasurements()"
                        class="px-4 py-2 text-white bg-blue-600 rounded-md shadow-md hover:bg-blue-700 transition-colors" data-i18n="saveButton">
                    Salvar
                </button>
            </div>
        </form>
    </div>
</div>

  <div id="diaryModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 shadow-2xl w-full max-w-md"><h2 id="diaryModalTitle" class="text-xl font-bold mb-4 text-gray-800" data-i18n="diaryTitle">Registrar A√ß√£o</h2>
        
        <form id="diaryForm" onsubmit="return false;">
            <input type="hidden" id="diaryActionType" name="action_type"> 

            <div id="labExamFields" class="space-y-4 hidden">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="labelExamType">Tipo de Exame:</label>
                    <select id="labExamType" class="w-full p-2 border border-gray-300 rounded-md bg-white">
                        <option value="" data-i18n="optSelect">Selecione...</option>
                        <option value="Hemograma" data-i18n="examHemogram">Hemograma</option>                        
                        <option value="Bioqu√≠mica_Hep√°tica" data-i18n="examHepatic">Bioqu√≠mica Hep√°tica</option>
                        <option value="Bioqu√≠mica_Renal" data-i18n="examRenal">Bioqu√≠mica Renal</option>
                        <option value="Eletr√≥litos" data-i18n="examElectrolytes">Eletr√≥litos</option>
                        <option value="Perfil_Lip√≠dico" data-i18n="examLipid">Perfil Lip√≠dico</option>
                        <option value="Glicemia_Metabolismo" data-i18n="examGlycemia">Glicemia/Metabolismo</option>
                        <option value="Coagula√ß√£o" data-i18n="examCoagulation">Coagula√ß√£o</option>
                        <option value="Marcadores_Tumorais" data-i18n="examTumorMarkers">Marcadores Tumorais</option>
                        <option value="Prote√≠nas_Imunoglobulinas" data-i18n="examProteins">Prote√≠nas/Imunoglobulinas</option>
                        <option value="Horm√¥nios" data-i18n="examHormones">Horm√¥nios</option>
                        <option value="Urina tipo I (EAS)" data-i18n="examUrine1">Urina tipo I (EAS)</option>
                        <option value="Urina 24 horas" data-i18n="examUrine24h">Urina 24 horas</option>
                        <option value="Fezes" data-i18n="examStool">Fezes</option>
                        <option value="Virol√≥gicos" data-i18n="examVirology">Virol√≥gicos</option>
                        <option value="Cultura" data-i18n="examCulture">Cultura</option>
                        <option value="L√≠quor (L√≠quido Cefalorraquidiano)" data-i18n="examCSF">L√≠quor (LCR)</option>
                        <option value="L√≠quido Asc√≠tico" data-i18n="examAscitic">L√≠quido Asc√≠tico</option>
                        <option value="L√≠quido Pleural" data-i18n="examPleural">L√≠quido Pleural</option>
                        <option value="Imunol√≥gicos" data-i18n="examImmunology">Imunol√≥gicos</option>
                        <option value="Gasometria" data-i18n="examGasometry">Gasometria</option> 
                        <option value="Gen√©tica NGS (Next Generation Sequencing)*" data-i18n="examGeneticsNGS">Gen√©tica NGS*</option>
                        <option value="Citogen√©tica e Moleculares*" data-i18n="examCytogenetics">Citogen√©tica e Moleculares*</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="labelExamParameter">Par√¢metro do Exame:</label>
                    <input
                        id="labExamParameter"
                        type="text"
                        placeholder="Ex: Plaquetas, Hem√°cias, Linf√≥citos"
                        data-i18n-placeholder="phExamParameter"
                        class="w-full p-2 border border-gray-300 rounded-md"
                        list="labParameterSuggestions"
                    />
                    <datalist id="labParameterSuggestions"></datalist>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="labelUnit">Unidade de Medida:</label>
                    <select id="labExamUnit" class="w-full p-2 border border-gray-300 rounded-md bg-white"></select>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="labelRefMin">Refer√™ncia (m√≠nimo):</label>
                        <input id="labLimitLow" type="number" step="0.001" class="w-full p-2 border border-gray-300 rounded-md" />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="labelRefMax">Refer√™ncia (m√°ximo):</label>
                        <input id="labLimitHigh" type="number" step="0.001" class="w-full p-2 border border-gray-300 rounded-md" />
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="labelExamResult">Resultado do Exame:</label>
                    <input id="labExamValue" type="number" step="0.001" class="w-full p-2 border border-gray-300 rounded-md" />
                    
                    <select id="labExamResultSelect" class="w-full p-2 border border-gray-300 rounded-md bg-white" style="display:none;">
                        <option value="0" data-i18n="optNotDetected">N√£o detectado/Negativo</option>
                        <option value="1" data-i18n="optDetected">Detectado/Positivo</option>
                    </select>
                </div>

            </div>

            <div id="inputGroup1" class="mb-4">
                <label id="label1" for="value1" class="block text-sm font-medium text-gray-700 mb-1" data-i18n="labelValue1">Valor 1:</label>
                <div class="flex items-center space-x-3 mb-2">
                    <input type="range" id="range1" name="range_1" min="0" max="1000" step="1" value="0"
                        class="flex-grow h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        
                    <input type="number" id="value1" name="value_1" min="0" max="1000" step="0.1"
                        class="w-1/4 p-2 border border-gray-300 rounded-md text-center">
                        
                    <select id="unit1" name="unit_1" class="p-2 border border-gray-300 rounded-md bg-white">
                    </select>
                </div>
            </div>

            <div id="inputGroup2" class="mb-4 hidden">
                <label id="label2" for="value2" class="block text-sm font-medium text-gray-700 mb-1" data-i18n="labelValue2">Valor 2:</label>
                <div class="flex items-center space-x-3 mb-2">
                    <input type="range" id="range2" name="range_2" min="0" max="1000" step="1" value="0"
                        class="flex-grow h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        
                    <input type="number" id="value2" name="value_2" min="0" max="1000" step="0.1"
                        class="w-1/4 p-2 border border-gray-300 rounded-md text-center">
                        
                    <select id="unit2" name="unit_2" class="p-2 border border-gray-300 rounded-md bg-white">
                    </select>
                </div>
            </div>

            <div id="inputGroup3" class="mb-4">
                <label id="label3" for="value3" class="block text-sm font-medium text-gray-700 mb-1" data-i18n="labelSpO2">Oximetria (SpO2):</label>
                 <div class="flex items-center space-x-3 mb-2">
                    <input type="range" id="range3" name="range_3" min="0" max="1000" step="1" value="0"
                        class="flex-grow h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <input type="number" step="1" id="value3" name="value_3" placeholder="Ex: 98" data-i18n-placeholder="phSpO2"
                           class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500">
                    <select id="unit3" name="unit_3" class="p-2 border border-gray-300 rounded-md bg-white">
                        <option value="%">%</option>
                    </select>
                </div>
            </div>

            <div id="inputGroup4" class="mb-4">
                <label id="label4" for="value4_sys" class="block text-sm font-medium text-gray-700 mb-1" data-i18n="labelBP">Press√£o Arterial (PA):</label>
                <div class="flex space-x-2">
                    <input type="text" id="value4_sys" name="value_4_sys" placeholder="Sist√≥lica" data-i18n-placeholder="phSystolic"
                           class="w-1/4 p-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500">
                    
                    <span class="p-2">/</span>
                    
                    <input type="text" id="value4_dia" name="value_4_dia" placeholder="Diast√≥lica" data-i18n-placeholder="phDiastolic"
                           class="w-1/4 p-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500">
                    
                    <select id="unit4" name="unit_4" class="w-1/4 p-2 border border-gray-300 rounded-md bg-white">
                        <option value="mmHg">mmHg</option>
                    </select>
                </div>
            </div>

            <div id="inputGroup5" class="mb-4">
                <label id="label5" for="value5" class="block text-sm font-medium text-gray-700 mb-1" data-i18n="labelTemp">Temperatura:</label>
                 <div class="flex items-center space-x-3 mb-2">
                    <input type="range" id="range5" name="range_5" min="34" max="43" step="0.1" value="0"
                        class="flex-grow h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <input type="number" step="0.1" id="value5" name="value_5" placeholder="Ex: 36.5" data-i18n-placeholder="phTemp"
                           class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500">
                    <select id="unit5" name="unit_5" class="p-2 border border-gray-300 rounded-md bg-white">
                        <option value="¬∫C">¬∫C</option>
                        <option value="¬∫F">¬∫F</option>
                    </select>
                </div>
            </div>

            <div class="mb-6">
                <label for="notes" class="block text-sm font-medium text-gray-700 mb-1" data-i18n="labelNotes">Anota√ß√µes:</label>
                <textarea id="notes" name="notes" rows="3" 
                          class="w-full p-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500" 
                          placeholder="Relate observa√ß√µes aqui..." data-i18n-placeholder="phNotes"></textarea>
            </div>

            <div class="flex justify-between items-center mt-4">
                  <button type="button" id="diaryOCRButton" 
                          class="px-4 py-2 text-white bg-purple-600 rounded-md shadow-md hover:bg-purple-700 transition-colors hidden"
                          onclick="openCameraOCRModalFromDiary()">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-camera mr-1 inline-block"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                      <span id="diaryOCRButtonText" data-i18n="btnOCR">Ler via C√¢mera</span>
                  </button>
                  
                  <div class="flex space-x-3 ml-auto">
                      <button type="button" onclick="closeDiaryModal()" 
                              class="px-4 py-2 text-gray-600 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors" data-i18n="cancelButton">
                          Cancelar
                      </button>
                      <button type="submit" onclick="saveDiaryEntry()"
                              class="px-4 py-2 text-white bg-red-600 rounded-md shadow-md hover:bg-red-700 transition-colors" data-i18n="saveButton">
                          Salvar
                      </button>
                  </div>
              </div>
        </form>
    </div>
</div>

<div id="cameraOCRModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-lg w-full max-w-lg flex flex-col h-[90vh]">
        
        <div class="bg-blue-600 text-white p-4 rounded-t-xl flex justify-between items-center">
            <h3 class="text-xl font-bold" id="ocrModalTitle" data-i18n="ocrTitle">Leitura de Documento via C√¢mera</h3>
            <button onclick="closeCameraOCRModal()" class="text-white hover:text-gray-200 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        
        <div class="flex-grow p-4 overflow-y-auto flex flex-col items-center justify-center">
            
            <video id="cameraPreview" class="w-full h-auto max-h-80 bg-black rounded-lg mb-4" autoplay playsinline></video>
            <canvas id="photoCanvas" class="hidden"></canvas>
            
            <img id="capturedImage" class="hidden w-full h-auto max-h-80 bg-gray-200 rounded-lg mb-4" alt="Foto Capturada" />

            <div id="ocrStatus" class="text-center text-sm text-gray-600 mb-4 h-6"></div>

            <div id="ocrResultContainer" class="w-full p-3 border rounded-lg bg-gray-50 mb-4 hidden">
                <h4 class="font-bold mb-2" data-i18n="ocrDataFound">Dados Encontrados:</h4>
                <div id="ocrResultData" class="text-sm"></div>
            </div>

        </div>
        
        <div class="p-4 bg-gray-100 rounded-b-xl flex justify-between space-x-3">
            <button id="snapButton" onclick="capturePhoto()" 
                    class="flex-1 bg-green-600 text-white font-semibold py-3 rounded-xl hover:bg-green-700 transition-colors" data-i18n="btnSnap">
                Tirar Foto
            </button>
            <button id="retryButton" onclick="startCamera()" 
                    class="flex-1 bg-yellow-600 text-white font-semibold py-3 rounded-xl hover:bg-yellow-700 transition-colors hidden" data-i18n="btnRetry">
                Tentar Novamente
            </button>
            <button id="useDataButton" onclick="useOCRData()" 
                    class="flex-1 bg-blue-600 text-white font-semibold py-3 rounded-xl hover:bg-blue-700 transition-colors hidden" data-i18n="btnUseData">
                Usar Dados
            </button>
        </div>
    </div>
</div>

<!-- Modal de Configura√ß√µes (Inicialmente Oculto) -->
<div id="settings-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden z-[10000]" >
    <div id="settings-content" class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md mx-4 transform scale-95 transition-transform duration-300">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center" data-i18n="settingsTitle">Configura√ß√µes</h2>
        
        <div class="flex border-b border-gray-200 mb-6" id="settings-tabs-navigation">
            <button class="settings-tab-button flex-1 py-2 text-sm font-medium border-b-2 border-transparent hover:border-blue-500 transition-colors" 
                    data-settings-tab="system" data-i18n="tabSystem">
                Sistema
            </button>
            <button class="settings-tab-button flex-1 py-2 text-sm font-medium border-b-2 border-blue-600 transition-colors" 
                    data-settings-tab="caregiver" data-i18n="tabCaregiver">
                Cuidador
            </button>
            <button class="settings-tab-button flex-1 py-2 text-sm font-medium border-b-2 border-transparent hover:border-blue-500 transition-colors" 
                    data-settings-tab="patient" data-i18n="tabPatient">
                Paciente
            </button>
        </div>

        <div id="settings-tabs-content">
            
            <div id="settings-tab-system" class="settings-tab-content space-y-6 hidden">
                <div>
                    <label for="font-size-slider" class="block font-semibold mb-2 text-gray-700" data-i18n="fontSizeLabel">Tamanho das Letras</label>
                    <input type="range" id="font-size-slider" min="14" max="24" value="16" step="1"
                           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" onchange="setFontSize(this.value)">
                </div>
                <div>
                    <label for="language-select" class="block font-semibold mb-2 text-gray-700" data-i18n="languageLabel">Idioma do App</label>
                    <select id="language-select" class="w-full max-w-xs p-2 rounded-lg bg-gray-100 border border-gray-300 mx-auto block" onchange="setAppLanguage(this.value)">
                        <option value="pt" data-i18n="langPt">Portugu√™s</option>
                        <option value="en" data-i18n="langEn">Ingl√™s</option>
                        <option value="es" data-i18n="langEs">Espanhol</option>
                    </select>
                </div>
                <div>
                    <label for="alarm-select" class="block font-semibold mb-2 text-gray-700" data-i18n="alarmLabel">Toque de Alarme</label>
                    <div class="flex items-center space-x-2">
                        <select id="alarm-select" class="flex-grow p-2 rounded-lg bg-gray-100 border border-gray-300" onchange="setAlarmSound(this.value)">                            
                            <option value="beep" data-i18n="Beep">Beep</option>  
                            <option value="synth" data-i18n="alarmSynth">Sino</option>
                            <option value="beep_short" data-i18n="alarmBeepShort">Beep Curto</option>
                            <option value="digital_long" data-i18n="alarmDigitalLong">Alarme Digital</option>
                            <option value="medium_bell" data-i18n="alarmMediumBell">Campainha M√©dia</option>       
                            <option value="none" data-i18n="alarmNote">Nenhum</option>                                                       
                        </select>
                        <button onclick="playAlarm()" class="bg-indigo-500 hover:bg-indigo-600 text-white p-2 rounded-full shadow-md transition-colors duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.91 11.672a.375.375 0 0 1 0 .656l-5.604 3.113a.375.375 0 0 1-.557-.328V8.887c0-.286.307-.466.557-.328l5.604 3.113Z" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div>
                    <label for="units-select" class="block font-semibold mb-2 text-gray-700" data-i18n="unitsLabel">Unidades de Medida</label>
                    <select id="units-select" class="w-full p-2 rounded-lg bg-gray-100 border border-gray-300" onchange="setMeasurementUnits(this.value)">
                        <option value="metric" data-i18n="unitsMetric">Sistema Internacional (m, ¬∞C)</option>
                        <option value="imperial" data-i18n="unitsImperial">Sistema Imperial (ft, ¬∞F)</option>
                    </select>
                </div>
                <div class="flex items-center justify-between">
                    <label for="data-collection-toggle" class="font-semibold text-gray-700" data-i18n="dataCollectionLabel">Coleta de dados (Temp/Umid.)</label>
                    <input type="checkbox" id="data-collection-toggle" class="form-checkbox h-5 w-5 text-indigo-600 rounded" onchange="toggleDataCollection(this.checked)">
                </div>
                <div>
                    <label for="theme-select" class="block font-semibold mb-2 text-gray-700" data-i18n="themeLabel">Modo de Exibi√ß√£o</label>
                    <select id="theme-select" class="w-full p-2 rounded-lg bg-gray-100 border border-gray-300" onchange="setAppTheme(this.value)">
                        <option value="auto" data-i18n="themeAuto">Autom√°tico</option>
                        <option value="light" data-i18n="themeLight">Claro</option>
                        <option value="dark" data-i18n="themeDark">Escuro</option>
                    </select>
                </div>
                <button onclick="saveCaregiverSettings()"
                  class="w-full bg-blue-600 text-white font-medium py-3 rounded-lg hover:bg-blue-700 transition duration-300" data-i18n="btnSaveSystem">
                  Salvar Configura√ß√µes do Sistema
            </button>
            </div>

            <div id="settings-tab-caregiver" class="settings-tab-content space-y-6">
                <div class="text-center">
                    <img id="settingsCaregiverAvatar" src="https://placehold.co/80x80/cbd5e1/475569?text=C" alt="Caregiver Avatar" class="w-20 h-20 rounded-full shadow-md mx-auto mb-3">
                    <button onclick="changeAvatar('caregiver')" class="text-sm text-blue-600 hover:text-blue-800" data-i18n="changeAvatarBtn">Mudar Avatar</button>
                </div>
                <div>
                    <label for="settingsCaregiverNickname" class="block font-semibold mb-2 text-gray-700" data-i18n="labelNickname">Apelido</label>
                    <input id="settingsCaregiverNickname" type="text" class="w-full p-2 rounded-lg bg-gray-100 border border-gray-300" 
                           placeholder="Seu apelido" data-i18n-placeholder="phNickname">
                </div>
                <div>
                    <label for="settingsCaregiverRelation" class="block font-semibold mb-2 text-gray-700" data-i18n="labelRelation">Rela√ß√£o com o Paciente</label>
                    <select id="settingsCaregiverRelation" class="w-full p-2 rounded-lg bg-gray-100 border border-gray-300">
                        </select>
                </div>
                <button onclick="saveCaregiverSettings()" class="w-full bg-blue-600 text-white font-medium py-3 rounded-lg hover:bg-blue-700 transition duration-300" data-i18n="btnSaveCaregiver">
                    Salvar Perfil do Cuidador
                </button>
            </div>

            <div id="settings-tab-patient" class="settings-tab-content space-y-6 hidden">
                <div class="text-center">
                    <img id="settingsPatientAvatar" src="https://placehold.co/80x80/cbd5e1/475569?text=P" alt="Patient Avatar" class="w-20 h-20 rounded-full shadow-md mx-auto mb-3">
                    <button onclick="changeAvatar('patient')" class="text-sm text-blue-600 hover:text-blue-800" data-i18n="changeAvatarBtn">Mudar Avatar</button>
                </div>
                <div>
                    <label for="settingsPatientNickname" class="block font-semibold mb-2 text-gray-700" data-i18n="patientNicknameLabel">Apelido do Paciente</label>
                    <input id="settingsPatientNickname" type="text" class="w-full p-2 rounded-lg bg-gray-100 border border-gray-300" 
                           placeholder="Apelido do paciente" readonly data-i18n-placeholder="phPatientNickname">
                    <small class="text-gray-500" data-i18n="msgNicknameLocal">Apelido √© apenas para exibi√ß√£o local.</small>
                </div>
                <div>
                    <label for="settingsPatientIllness" class="block font-semibold mb-2 text-gray-700" data-i18n="patientIllnessLabel">Doen√ßa / Condi√ß√£o</label>
                    <input id="settingsPatientIllness" type="text" class="w-full p-2 rounded-lg bg-gray-100 border border-gray-300" 
                           placeholder="Ex: Leucemia" onchange="savePatientSettings()" data-i18n-placeholder="phIllness">
                </div>
                <div>                                             
                    <div class="relative">
                        <button onclick="openDiseaseSelectorFromSettings()" class="w-full py-3 bg-gray-100 hover:bg-gray-200 rounded-lg text-gray-700 font-semibold text-sm border border-gray-300 transition">
                            <span>üß¨</span> <span data-i18n="improveDiagnosisBtn">Aprimorar Diagn√≥stico</span>
                        </button>                   
                    </div>
                </div>
                <div>
                    <label for="settingsPatientAllergies" class="block font-semibold mb-2 text-gray-700" data-i18n="patientAllergiesLabel">Alergias</label>
                    <input id="settingsPatientAllergies" type="text" class="w-full p-2 rounded-lg bg-gray-100 border border-gray-300" 
                           placeholder="Lista de alergias" onchange="savePatientSettings()" data-i18n-placeholder="phAllergies">
                </div>
                <button onclick="savePatientSettings()" class="w-full bg-blue-600 text-white font-medium py-3 rounded-lg hover:bg-blue-700 transition duration-300" data-i18n="btnSavePatient">
                    Salvar Perfil do Paciente
                </button>
            </div>
            
        </div>
        
        <button onclick="closeSettingsModal()"
                class="mt-8 w-full bg-gray-200 text-gray-800 font-medium py-3 rounded-lg hover:bg-gray-300 transition duration-300" data-i18n="closeButton">
            Fechar
        </button>
    </div>
</div>

<div id="hub-disease-form" class="hidden fixed inset-0 z-[20000] flex items-center justify-center bg-gray-900 bg-opacity-90 backdrop-blur-sm transition-opacity duration-300">
    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md relative mx-4 animate-bounce-in">
        
        <div class="flex justify-between items-center mb-4 border-b pb-2">
            <h4 class="text-lg font-bold text-gray-800 flex items-center gap-2" data-i18n="titleImproveDiag">
                üß¨ Aprimorar Diagn√≥stico
            </h4>
            <button onclick="hubToggleDiseaseForm()" class="text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-100 transition">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>

        <label class="block text-xs font-bold text-gray-600 mb-1 uppercase tracking-wide" data-i18n="labelQuickSearch">Busca R√°pida:</label>
        <div class="relative mb-4">
            <input type="text" id="hub-disease-search" onkeyup="hubFilterDiseaseList()" 
                   placeholder="Digite para filtrar (ex: C√¢ncer)..." data-i18n-placeholder="phDiseaseFilter"
                   class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
            <span class="absolute left-3 top-3.5 text-gray-400">üîç</span>
        </div>

        <label class="block text-xs font-bold text-gray-600 mb-1 uppercase tracking-wide" data-i18n="labelDiseaseType">Tipo da Doen√ßa:</label>
        <select id="hub-illness-type" class="w-full p-3 border border-gray-300 rounded-lg mb-4 bg-gray-50 focus:bg-white transition text-gray-700">
            <option value="" data-i18n="optSelect">Selecione...</option>
            
            <optgroup label="Principais" data-i18n-label="grpMain">
                <option value="Leucemia Linfoide Aguda (LLA)" data-i18n="disLLA">Leucemia Linfoide Aguda (LLA)</option>
                <option value="Leucemia Miel√≥ide Aguda (LMA)" data-i18n="disLMA">Leucemia Miel√≥ide Aguda (LMA)</option>
                <option value="Leucemia Miel√≥ide Cr√¥nica (LMC)" data-i18n="disLMC">Leucemia Miel√≥ide Cr√¥nica (LMC)</option>
                <option value="Linfoma de Hodgkin" data-i18n="disHodgkin">Linfoma de Hodgkin</option>
                <option value="Linfoma N√£o-Hodgkin" data-i18n="disNonHodgkin">Linfoma N√£o-Hodgkin</option>
                <option value="Mieloma M√∫ltiplo" data-i18n="disMyeloma">Mieloma M√∫ltiplo</option>
                <option value="C√¢ncer de Mama" data-i18n="disBreast">C√¢ncer de Mama</option>
                <option value="C√¢ncer de Pr√≥stata" data-i18n="disProstate">C√¢ncer de Pr√≥stata</option>
                <option value="C√¢ncer de Pulm√£o" data-i18n="disLung">C√¢ncer de Pulm√£o</option>
            </optgroup>
            
            <optgroup label="Lista Completa (A-Z)" data-i18n-label="grpFullList">
                <option value="Anal" data-i18n="disAnal">Anal</option>
                <option value="Bexiga" data-i18n="disBladder">Bexiga</option>
                <option value="Boca" data-i18n="disMouth">Boca</option>
                <option value="Cabe√ßa e Pesco√ßo" data-i18n="disHeadNeck">Cabe√ßa e Pesco√ßo</option>
                <option value="Colo do √ötero" data-i18n="disCervical">Colo do √ötero</option>
                <option value="Colorretal (Intestino)" data-i18n="disColorectal">Colorretal (Intestino)</option>
                <option value="Corpo do √ötero" data-i18n="disUterine">Corpo do √ötero</option>
                <option value="Es√¥fago" data-i18n="disEsophagus">Es√¥fago</option>
                <option value="Est√¥mago" data-i18n="disStomach">Est√¥mago</option>
                <option value="F√≠gado" data-i18n="disLiver">F√≠gado</option>
                <option value="GIST" data-i18n="disGIST">GIST</option>
                <option value="Laringe" data-i18n="disLarynx">Laringe</option>
                <option value="NET" data-i18n="disNET">NET (Neuroend√≥crinos)</option>
                <option value="Ov√°rio" data-i18n="disOvarian">Ov√°rio</option>
                <option value="P√¢ncreas" data-i18n="disPancreas">P√¢ncreas</option>
                <option value="Pele Melanoma" data-i18n="disSkinMelanoma">Pele - Melanoma</option>
                <option value="Pele N√£o Melanoma" data-i18n="disSkinNonMelanoma">Pele - N√£o Melanoma</option>
                <option value="P√™nis" data-i18n="disPenis">P√™nis</option>
                <option value="Rim" data-i18n="disKidney">Rim</option>
                <option value="Sarcomas" data-i18n="disSarcoma">Sarcomas</option>
                <option value="Sistema Nervoso Central" data-i18n="disCNS">Sistema Nervoso Central</option>
                <option value="Test√≠culo" data-i18n="disTesticular">Test√≠culo</option>
                <option value="Tireoide" data-i18n="disThyroid">Tireoide</option>
                <option value="Vagina" data-i18n="disVagina">Vagina</option>
                <option value="Ves√≠cula Biliar" data-i18n="disGallbladder">Ves√≠cula Biliar</option>
                <option value="Vulva" data-i18n="disVulva">Vulva</option>
                <option value="Outro" data-i18n="disOther">Outro</option>
            </optgroup>
        </select>

        <label class="block text-xs font-bold text-gray-600 mb-1 uppercase tracking-wide" data-i18n="labelSubtype">Subtipo / Muta√ß√£o (Opcional):</label>
        <input type="text" id="hub-illness-subtype" 
               placeholder="Ex: Ph+, HER2, KRAS..." data-i18n-placeholder="phSubtype"
               class="w-full p-3 border border-gray-300 rounded-lg mb-6 focus:ring-2 focus:ring-blue-500 outline-none">

        <button onclick="hubUpdateDiseaseInfo()" 
                class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold py-3 rounded-lg shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all transform" 
                data-i18n="btnSaveDiag">
            Salvar Diagn√≥stico
        </button>
    </div>
</div>

<div id="avatarUploadModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-[99999]">
    <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-sm md:max-w-md">
        <h3 class="text-xl font-bold text-gray-800 mb-4" data-i18n="titleChangeAvatar">Mudar Avatar</h3>
        
        <input type="file" id="avatarFileInput" accept="image/*" class="mb-4 w-full" />
        
        <p class="text-sm text-gray-500 mb-4" data-i18n="descSelectImage">Selecione uma imagem do seu dispositivo.</p>
        
        <div class="flex justify-between space-x-4">
            <button onclick="closeAvatarUploadModal()" class="flex-grow bg-gray-400 text-white font-semibold py-3 rounded-xl hover:bg-gray-500 transition-colors" data-i18n="cancelButton">Cancelar</button>
            <button onclick="uploadAvatar()" id="uploadAvatarBtn" class="flex-grow bg-blue-600 text-white font-semibold py-3 rounded-xl hover:bg-blue-700 transition-colors" data-i18n="btnUpload">Carregar</button>
        </div>
    </div>
</div>

<!-- Modal de tutorial e treinamento -->
<div id="tutorial-overlay" class="fixed inset-0 z-[13000] hidden transition-all duration-500">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-[2px]" onclick="return false;"></div>

    <div id="tutorial-card" class="absolute bottom-10 left-4 right-4 md:bottom-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 bg-white p-6 rounded-2xl shadow-2xl border-l-8 border-indigo-500 animate-slide-up transition-all duration-300 w-auto md:w-[400px]">
        <div class="flex justify-between items-start mb-3">
            <h3 id="tut-title" class="text-lg font-bold text-indigo-900">Bem-vindo</h3>
            <span id="tut-step-count" class="text-xs font-bold text-gray-400 bg-gray-100 px-2 py-1 rounded-full">1/5</span>
        </div>
        
        <p id="tut-desc" class="text-gray-600 text-sm mb-6 leading-relaxed">
            Texto explicativo vai aqui...
        </p>

        <div class="flex justify-between items-center mt-4">
            <button onclick="skipTutorial()" class="text-gray-400 text-xs hover:text-gray-600 underline" data-i18n="btnSkipTut">Pular Tutorial</button>
            <div class="flex gap-2">
                <button id="tut-btn-prev" onclick="prevTutorialStep()" class="hidden px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100 text-sm font-medium" data-i18n="btnBack">Voltar</button>
                <button id="tut-btn-next" onclick="nextTutorialStep()" class="px-6 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold shadow-lg transition-transform active:scale-95" data-i18n="btnNext">Pr√≥ximo</button>
            </div>
        </div>
        
        <div class="absolute -bottom-2 left-1/2 transform -translate-x-1/2 w-4 h-4 bg-white rotate-45 md:hidden"></div>
    </div>
</div>

<!-- Modal: Premium Hope (Assinatura) -->
<div id="modal-premium-hope" class="popup-overlay z-[10000]" onclick="closePremiumModal(event)">
    <div class="bg-white w-full md:w-[800px] h-[95vh] md:h-auto md:max-h-[90vh] rounded-2xl shadow-2xl overflow-y-auto fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 flex flex-col md:flex-row overflow-hidden animate-fade-in" onclick="event.stopPropagation()">
        
        <div class="hidden md:flex md:w-1/3 bg-gradient-to-br from-indigo-600 to-purple-700 p-8 text-white flex-col justify-between relative">
            <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
            
            <div class="z-10">
                <h2 class="text-2xl font-bold mb-2" data-i18n="premTitle">Jornada de Supera√ß√£o</h2>
                <p class="text-indigo-100 text-sm" data-i18n="premSubtitle">Voc√™ n√£o precisa carregar o mundo sozinho. N√≥s ajudamos a organizar o cuidado para que voc√™ foque no amor.</p>
            </div>

            <div class="z-10 space-y-6">
                <div class="flex items-center gap-3">
                    <div class="bg-white/20 p-2 rounded-full"><span class="text-xl">üõ°Ô∏è</span></div>
                    <div>
                        <p class="font-bold text-sm" data-i18n="premFeat1Title">Decis√µes Seguras</p>
                        <p class="text-xs text-indigo-200" data-i18n="premFeat1Desc">Apoio jur√≠dico e m√©dico da comunidade.</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="bg-white/20 p-2 rounded-full"><span class="text-xl">üìä</span></div>
                    <div>
                        <p class="font-bold text-sm" data-i18n="premFeat2Title">Hist√≥rico Vital</p>
                        <p class="text-xs text-indigo-200" data-i18n="premFeat2Desc">Gr√°ficos de evolu√ß√£o para m√©dicos.</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="bg-white/20 p-2 rounded-full"><span class="text-xl">‚ù§Ô∏è</span></div>
                    <div>
                        <p class="font-bold text-sm" data-i18n="premFeat3Title">C√≠rculo de Apoio</p>
                        <p class="text-xs text-indigo-200" data-i18n="premFeat3Desc">Convide familiares ilimitados.</p>
                    </div>
                </div>
            </div>

            <div class="z-10 bg-indigo-800/50 p-3 rounded-lg border border-indigo-400/30">
                <p class="text-xs italic" data-i18n="premTestimonial">"Este app me deu for√ßas quando eu achei que n√£o tinha mais."</p>
                <p class="text-[10px] text-right mt-1 opacity-80" data-i18n="premTestimonialAuthor">- Maria, cuidadora h√° 2 anos</p>
            </div>
        </div>

        <div class="w-full md:w-2/3 bg-gray-50 p-6 md:p-8 flex flex-col relative">            

            <div class="text-center mb-6">
                <span id="teste_gratis" class="bg-green-100 text-green-700 text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wide" data-i18n="premBadgeTrial">Teste Gr√°tis Dispon√≠vel</span>                
                <h3 class="text-2xl font-bold text-gray-800 mt-2" data-i18n="premTrialTitle">Experimente 14 Dias Sem Custo</h3>
                <p class="text-sm text-gray-500" data-i18n="premTrialDesc">Cancele a qualquer momento. O sino da esperan√ßa s√≥ toca se voc√™ quiser.</p>
            </div>

            <div class="text-center mb-6"><button onclick="document.getElementById('modal-premium-hope').classList.remove('active')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">‚úï</button></div>

        <div class="flex gap-4 mb-6" id="plan-selector">
            <label class="flex-1 cursor-pointer relative group">
                <input type="radio" name="plan" value="monthly" class="peer sr-only" onchange="updatePlanUI('monthly')">
                <div class="p-4 rounded-xl border-2 border-gray-200 bg-white hover:border-indigo-300 peer-checked:border-indigo-600 peer-checked:bg-indigo-50 transition-all h-full flex flex-col items-center justify-center text-center">
                    <span class="text-sm font-semibold text-gray-600" data-i18n="planMonthlyTitle">Mensal Flex√≠vel</span>
                    
                    <span class="text-2xl font-bold text-purple-400 mt-1">R$ 29,90</span>
                    
                    <div id="display-usd-monthly" class="hidden text-xs font-medium text-indigo-500 bg-indigo-100 px-2 py-0.5 rounded-md mt-1 mb-1">
                        Wait...
                    </div>

                    <span class="text-xs text-gray-400 mt-1" data-i18n="planMonthlySub">Cobrado mensalmente</span>
                </div>
            </label>

            <label class="flex-1 cursor-pointer relative group">
                <input type="radio" name="plan" value="annual" class="peer sr-only" checked onchange="updatePlanUI('annual')">
                
                <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-orange-500 to-pink-500 text-white text-[10px] font-bold px-3 py-1 rounded-full shadow-sm z-10" data-i18n="planAnnualSave">
                    ECONOMIZE 40%
                </div>
                
                <div class="p-4 rounded-xl border-2 border-orange-200 bg-white hover:border-orange-300 peer-checked:border-orange-500 peer-checked:bg-orange-50 transition-all h-full flex flex-col items-center justify-center text-center shadow-lg transform scale-105">
                    <span class="text-sm font-semibold text-gray-600" data-i18n="planAnnualTitle">Anual - Melhor Valor</span>
                    
                    <span class="text-2xl font-bold text-orange-600 mt-1">R$ 17,90</span>
                    
                    <div id="display-usd-annual" class="hidden text-xs font-medium text-orange-600 bg-orange-100 px-2 py-0.5 rounded-md mt-1 mb-1">
                        Wait...
                    </div>

                    <span class="text-xs text-gray-400 mt-1" data-i18n="planAnnualSub">/m√™s (Cobrado R$ 214/ano)</span>
                    
                    <div class="mt-2 text-[10px] text-green-600 font-bold flex items-center gap-1">
                        <span>üèÜ</span> <span data-i18n="planAnnualBonus">+2 Meses de B√¥nus</span>
                    </div>
                </div>
            </label>
        </div>

            <div class="space-y-4">
                <p class="text-xs font-bold text-gray-500 uppercase" data-i18n="payMethodSafe">M√©todo Seguro (Cobran√ßa ap√≥s 14 dias)</p>
                
                <div class="flex gap-2 mb-3">
                    <button onclick="selectPayment('card')" id="btn-pay-card" class="flex-1 py-2 text-xs font-bold rounded border border-indigo-600 bg-indigo-50 text-indigo-700" data-i18n="payBtnCard">Cart√£o de Cr√©dito</button>
                    <button onclick="selectPayment('pix')" id="btn-pay-pix" class="flex-1 py-2 text-xs font-bold rounded border border-gray-200 bg-white text-gray-600 hover:bg-gray-50" data-i18n="payBtnPix">Pix</button>
                    <button onclick="selectPayment('paypal')" id="btn-pay-paypal" class="flex-1 py-2 text-xs font-bold rounded border border-gray-200 bg-white text-gray-600 hover:bg-gray-50">PayPal</button>
                </div>

                <div id="payment-form-card" class="hidden flex-col items-center justify-center p-4 bg-white rounded-lg border border-green-200 animate-fade-in text-center space-y-4">

                    <div id="card-payment-step" class="w-full max-w-md">

                        <form id="form-cartao" class="space-y-4 text-left">

                            <div>
                                <label for="cardNumber" class="block text-sm font-medium text-gray-700" data-i18n="lblCardNumber">N√∫mero do cart√£o</label>
                                <input id="cardNumber" class="input w-full" placeholder="0000 0000 0000 0000" />
                            </div>

                            <div class="flex gap-3">
                                <div class="flex-1">
                                    <label for="expirationDate" class="block text-sm font-medium text-gray-700" data-i18n="lblExpiry">Validade</label>
                                    <input id="expirationDate" class="input w-full" placeholder="MM/AA" />
                                </div>

                                <div class="flex-1">
                                    <label for="securityCode" class="block text-sm font-medium text-gray-700" data-i18n="lblCVV">CVV</label>
                                    <input id="securityCode" class="input w-full" placeholder="123" />
                                </div>
                            </div>

                            <div>
                                <label for="cardholderName" class="block text-sm font-medium text-gray-700" data-i18n="lblCardName">Nome no cart√£o</label>
                                <input id="cardholderName" class="input w-full" placeholder="Como impresso no cart√£o" data-i18n-placeholder="phCardName"/>
                            </div>

                            <div>
                                <label for="cardholderEmail" class="block text-sm font-medium text-gray-700" data-i18n="lblCardEmail">E-mail do titular</label>
                                <input id="cardholderEmail" class="input w-full" placeholder="email@exemplo.com" />
                            </div>

                            <div class="hidden">
                                <label for="issuer" class="block text-sm font-medium text-gray-700">Banco emissor</label>
                                <select id="issuer" class="input w-full"></select>
                            </div>
                            <div class="hidden">
                                <label for="installments" class="block text-sm font-medium text-gray-700">Parcelamento</label>
                                <select id="installments" class="input w-full"></select>
                            </div>
                            <div class="hidden">
                                <label for="identificationType" class="block text-sm font-medium text-gray-700">Tipo de documento</label>
                                <select id="identificationType" class="input w-full"></select>
                            </div>

                            <div>
                                <label for="identificationNumber" class="block text-sm font-medium text-gray-700" data-i18n="lblDocNumber">CPF do titular</label>
                                <input id="identificationNumber" class="input w-full" placeholder="000.000.000-00" />
                            </div>

                            <button id="card-payment-start" type="button" 
                                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-medium" data-i18n="btnPayCard">
                                Pagar com cart√£o
                            </button>
                        </form>
                        <div id="card-feedback" class="text-center text-sm mt-4 text-gray-700"></div>
                    </div>
                </div>

                <div id="payment-form-pix" class="hidden flex-col items-center justify-center p-4 bg-white rounded-lg border border-green-200 animate-fade-in text-center space-y-4">
    
                    <div id="pix-instruction-step">
                        <p class="text-sm text-gray-600 mb-2" data-i18n="pixInst1">Ao confirmar, geraremos um c√≥digo exclusivo.</p>
                        <p class="text-xs text-green-700 font-bold bg-green-50 p-2 rounded" data-i18n="pixBonus">üéÅ +5 dias de b√¥nus inclu√≠dos!</p>
                    </div>

                    <button id="pix-payment-start" onclick="processSubscription()" type="button" 
                            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-medium" data-i18n="btnGenCode">
                        Gerar C√≥digo
                    </button>

                    <div id="pix-loading-step" class="hidden">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600 mx-auto"></div>
                        <p class="text-xs text-gray-500 mt-2" data-i18n="pixGenerating">Gerando QR Code seguro...</p>
                    </div>

                    <div id="pix-result-step" class="hidden w-full">
                        <p class="text-xs font-bold text-gray-500 uppercase mb-2" data-i18n="pixScan">Escaneie ou Copie</p>
                        
                        <img id="pix-qr-image" src="" class="w-40 h-40 mx-auto border p-2 rounded shadow-sm mb-3 object-contain">
                        
                        <div class="flex gap-2">
                            <input type="text" id="pix-copy-code" readonly class="w-full text-[10px] p-2 bg-gray-100 border rounded text-gray-500 font-mono overflow-hidden whitespace-nowrap" value="">
                            <button onclick="copyPixCode()" class="bg-green-600 hover:bg-green-700 text-white p-2 rounded shadow transition" title="Copiar C√≥digo">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                            </button>
                        </div>
                        
                        <p class="text-[10px] text-gray-400 mt-2" data-i18n="pixApproved">O pagamento √© aprovado instantaneamente.</p>
                    </div>
                </div>                
            </div>

            <div class="mt-auto pt-6">
                <button id="trial_button" onclick="processSubscription()" class="w-full py-4 rounded-xl bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold text-lg shadow-lg transform transition active:scale-95 flex items-center justify-center gap-2">
                    <span data-i18n="btnStartTrial">Come√ßar 14 Dias Gr√°tis</span>
                    <span class="text-xs bg-white/20 px-2 py-0.5 rounded" data-i18n="lblSecure">üõí Seguro</span>
                </button>
                <p class="text-[10px] text-gray-400 text-center mt-3" data-i18n="premDisclaimer">
                    Ao continuar, voc√™ concorda com os Termos. Renova√ß√£o autom√°tica. Cancele online a qualquer momento para evitar cobran√ßas.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Modal Winback (O Sino) -->
<div id="modal-winback" class="popup-overlay z-[10001]" style="display:none;">
    <div class="bg-white w-[90%] max-w-md p-6 rounded-2xl shadow-2xl fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center">
        <div class="mx-auto w-20 h-20 bg-orange-100 rounded-full flex items-center justify-center mb-4 animate-bounce">
            <span class="text-4xl">üîî</span>
        </div>
        
        <h3 class="text-xl font-bold text-gray-800" data-i18n="winbackTitle">N√£o silencie o sino agora...</h3>
        
        <p class="text-sm text-gray-600 mt-2 mb-6">
            <span data-i18n="winbackDesc">O tratamento √© uma maratona, n√£o uma corrida de 100 metros. Seus registros de hoje podem salvar o dia de amanh√£.</span>
            <br><br>
            <strong data-i18n="winbackOffer">Que tal mais 7 dias gr√°tis para pensar?</strong>
        </p>
        
        <div class="flex flex-col gap-2">
            <button onclick="acceptWinback()" class="w-full py-3 bg-indigo-600 text-white rounded-lg font-bold shadow hover:bg-indigo-700" data-i18n="btnAcceptWinback">Aceitar +7 Dias Gr√°tis</button>
            
            <button onclick="confirmCancel()" class="w-full py-2 bg-transparent text-gray-400 text-xs hover:text-red-500" data-i18n="btnConfirmCancel">Eu entendo, quero cancelar</button>
        </div>
    </div>
</div>

<!-- Modal Relaxamento e ansiedade -->
<div id="modal-breathing" class="popup-overlay z-[11000] transition-opacity duration-500 opacity-0 pointer-events-none flex items-center justify-center bg-teal-900/95 backdrop-blur-sm">
    <div class="text-center text-white w-full max-w-md p-6 relative">
        
        <h2 class="text-2xl font-bold mb-2" data-i18n="breathTitle">Pausa para Respirar</h2>
        
        <p class="text-teal-100 text-sm mb-8 opacity-90" data-i18n="breathDesc">
            Escute seu corpo. Sinta seus batimentos.<br>
            Siga o ritmo visual para acalmar sua mente.
        </p>

        <div class="relative h-64 w-64 mx-auto flex items-center justify-center mb-10">
            <div id="breath-aura-1" class="absolute inset-0 bg-teal-400/20 rounded-full scale-50 transition-transform duration-[4000ms] ease-in-out"></div>
            <div id="breath-aura-2" class="absolute inset-0 bg-teal-300/10 rounded-full scale-75 transition-transform duration-[4000ms] ease-in-out delay-75"></div>
            
            <div id="breath-circle" class="relative w-32 h-32 bg-white rounded-full flex items-center justify-center shadow-[0_0_40px_rgba(255,255,255,0.3)] transition-all duration-[4000ms] ease-in-out">
                <span id="breath-timer" class="text-teal-900 text-3xl font-bold font-mono">4</span>
            </div>
        </div>

        <h3 id="breath-instruction" class="text-3xl font-light tracking-widest mb-2 transition-all duration-500" data-i18n="breathInstrPrep">PREPARE-SE</h3>
        <p id="breath-subtext" class="text-sm text-teal-200 h-6" data-i18n="breathSubPrep">Esvazie os pulm√µes...</p>

        <button onclick="stopBreathingExercise()" class="mt-12 px-8 py-3 bg-transparent border border-white/30 rounded-full hover:bg-white/10 transition text-sm tracking-wide" data-i18n="btnFinishBreath">
            Finalizar e Voltar
        </button>
    </div>
</div>

<!-- Modal de esqueceu a senha -->
<div id="modal-forgot-password" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-[11000]">
    <div class="bg-white p-6 rounded-xl shadow-2xl w-96 animate-scale-up">
        <h3 class="text-lg font-bold text-gray-800 mb-2" data-i18n="forgotTitle">Recuperar Acesso</h3>
        
        <p class="text-sm text-gray-500 mb-4" data-i18n="forgotDesc">Informe seu e-mail para receber as instru√ß√µes.</p>
        
        <input type="email" id="forgot-email" placeholder="seu@email.com" data-i18n-placeholder="phYourEmail"
               class="w-full p-3 border rounded-lg mb-4 text-sm">
        
        <button onclick="requestPasswordReset()" 
                class="w-full bg-indigo-600 text-white py-2 rounded-lg font-bold hover:bg-indigo-700 mb-2" data-i18n="btnSendLink">
            Enviar Link
        </button>
        
        <button onclick="document.getElementById('modal-forgot-password').classList.add('hidden')" 
                class="w-full text-gray-500 text-sm hover:underline" data-i18n="cancelButton">
            Cancelar
        </button>
    </div>
</div>

<!-- Modal de reset de senha -->
<div id="modal-reset-confirm" class="fixed inset-0 bg-gray-900 bg-opacity-80 hidden flex items-center justify-center z-[11000]">
    <div class="bg-white p-6 rounded-xl shadow-2xl w-96 border-t-4 border-green-500">
        <h3 class="text-lg font-bold text-gray-800 mb-2" data-i18n="resetPassTitle">Nova Senha</h3>
        
        <p class="text-sm text-gray-500 mb-4" data-i18n="resetPassDesc">Crie uma nova senha segura.</p>
        
        <input type="password" id="reset-new-pass" 
               placeholder="Nova senha (m√≠n. 6 d√≠gitos)" data-i18n-placeholder="phNewPass"
               class="w-full p-3 border rounded-lg mb-4">
               
        <input type="hidden" id="reset-token-input">
        
        <button onclick="confirmNewPassword()" 
                class="w-full bg-green-600 text-white py-2 rounded-lg font-bold hover:bg-green-700" data-i18n="btnChangePass">
            Alterar Senha
        </button>
    </div>
</div>

<!-- Modal de controle de Finan√ßas -->
<div id="financeModal" tabindex="-1" aria-hidden="true" style="z-index: 9999;" class="hidden fixed inset-0 z-[9999] flex items-center justify-center w-full h-full bg-gray-900 bg-opacity-50 backdrop-blur-sm overflow-y-auto">
    <div class="relative w-full max-w-2xl max-h-full p-4">
        <div class="relative bg-white rounded-lg shadow-xl">
            <div class="flex items-center justify-between p-4 border-b rounded-t bg-blue-600 text-white">
                <h3 class="text-xl font-semibold" data-i18n="finTitle">
                    Controle Financeiro & Apoio
                </h3>
                <button type="button" onclick="closeFinanceModal()" class="text-white bg-transparent hover:bg-blue-700 rounded-lg text-sm w-8 h-8 inline-flex justify-center items-center">
                    <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                    </svg>
                    <span class="sr-only" data-i18n="closeButton">Fechar modal</span>
                </button>
            </div>

            <div class="border-b border-gray-200">
                <ul class="flex flex-wrap -mb-px text-sm font-medium text-center text-gray-500">
                    <li class="mr-2">
                        <button onclick="switchFinanceTab('tab-despesa')" id="btn-tab-despesa" class="inline-block p-4 border-b-2 border-blue-600 text-blue-600 rounded-t-lg active" data-i18n="tabExpense">
                            ‚ûï Nova Despesa
                        </button>
                    </li>
                    <li class="mr-2">
                        <button onclick="switchFinanceTab('tab-dicas')" id="btn-tab-dicas" class="inline-block p-4 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 rounded-t-lg" data-i18n="tabRights">
                            üí° Dicas e Direitos
                        </button>
                    </li>
                </ul>
            </div>

            <div class="p-6 space-y-6 max-h-[70vh] overflow-y-auto">
                
                <div id="tab-despesa" class="block">
                    <form id="formFinanceExpense" onsubmit="submitExpense(event)">
                        <div class="grid gap-4 mb-4 grid-cols-2">
                            <input type="hidden" id="fin_origin_type" value="">
                            <input type="hidden" id="fin_origin_id" value="">

                            <div class="col-span-2 space-y-2">
                                <div id="pending-alert-area" class="hidden p-3 bg-orange-50 border border-orange-200 rounded-lg">
                                    <p class="text-xs font-bold text-orange-800 mb-2 flex items-center">
                                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"></path></svg>
                                        <span data-i18n="finPendingAlert">Pend√™ncias encontradas (Clique para preencher):</span>
                                    </p>
                                    <div id="pending-chips-container" class="flex flex-wrap gap-2"></div>
                                </div>

                                <label for="fin_descricao" class="block mb-1 text-sm font-medium text-gray-900" data-i18n="finLabelDesc">Descri√ß√£o</label>
                                <input type="text" id="fin_descricao" 
                                    class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" 
                                    placeholder="Ex: Medicamento X..." data-i18n-placeholder="finPhDesc" required>
                            </div>
                            
                            <div class="col-span-1">
                                <label for="fin_categoria" class="block mb-2 text-sm font-medium text-gray-900" data-i18n="finLabelCategory">Categoria</label>
                                <select id="fin_categoria" onchange="checkMedicationCategory(this)" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                                    <option value="" data-i18n="optLoading">Carregando...</option>
                                </select>
                            </div>

                            <div id="medication-details" class="col-span-2 hidden bg-blue-50 p-3 rounded-lg border border-blue-200 grid grid-cols-2 gap-3 transition-all">
                                <div class="col-span-2 text-xs font-bold text-blue-800 uppercase tracking-wide mb-1" data-i18n="finPackDetails">
                                    üì¶ Detalhes da Embalagem
                                </div>

                                <div class="col-span-1">
                                    <label for="fin_med_tipo" class="block mb-1 text-xs font-medium text-gray-700" data-i18n="finLabelType">Tipo</label>
                                    <select id="fin_med_tipo" class="bg-white border border-gray-300 text-gray-900 text-xs rounded-lg block w-full p-2">
                                        <option value="" data-i18n="optSelect">Selecione...</option>
                                        <option value="frasco" data-i18n="optBottle">Frasco (L√≠quido)</option>
                                        <option value="pote" data-i18n="optPot">Pote (Creme/P√≥)</option>
                                        <option value="caixa" data-i18n="optBox">Caixa (Comprimidos)</option>
                                        <option value="ampola" data-i18n="optAmpoule">Ampola/Injet√°vel</option>
                                    </select>
                                </div>

                                <div class="col-span-1">
                                    <label for="fin_med_qtd_comprada" class="block mb-1 text-xs font-medium text-gray-700" data-i18n="finLabelQty">Qtd. Itens</label>
                                    <input type="number" id="fin_med_qtd_comprada" value="1" min="1" placeholder="Ex: 2" data-i18n-placeholder="finPhQty"
                                        class="bg-white border border-gray-300 text-gray-900 text-xs rounded-lg block w-full p-2">
                                </div>

                                <div class="col-span-2 flex gap-2">
                                    <div class="w-2/3">
                                        <label for="fin_med_conteudo" class="block mb-1 text-xs font-medium text-gray-700" data-i18n="finLabelContent">Conte√∫do por item</label>
                                        <input type="number" step="0.01" id="fin_med_conteudo" placeholder="Ex: 350" data-i18n-placeholder="finPhContent"
                                            class="bg-white border border-gray-300 text-gray-900 text-xs rounded-lg block w-full p-2">
                                    </div>
                                    <div class="w-1/3">
                                        <label for="fin_med_unidade" class="block mb-1 text-xs font-medium text-gray-700" data-i18n="finLabelUnit">Unidade</label>
                                        <select id="fin_med_unidade" class="bg-white border border-gray-300 text-gray-900 text-xs rounded-lg block w-full p-2">
                                            <option value="ml">ml</option>
                                            <option value="g">g</option>
                                            <option value="un">unid</option> <option value="mg">mg</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="col-span-1">
                                <label for="fin_valor" class="block mb-2 text-sm font-medium text-gray-900" data-i18n="finLabelValue">Valor (R$)</label>
                                <input type="number" step="0.01" id="fin_valor" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="0,00" required>
                            </div>
                            <div class="col-span-1">
                                <label for="fin_data" class="block mb-2 text-sm font-medium text-gray-900" data-i18n="finLabelDate">Data</label>
                                <input type="date" id="fin_data" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                            </div>
                            <div class="col-span-2 flex items-center">
                                <input id="fin_recorrente" type="checkbox" value="1" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                                <label for="fin_recorrente" class="ml-2 text-sm font-medium text-gray-900" data-i18n="finLabelRecurring">Esta √© uma despesa mensal recorrente</label>
                            </div>
                        </div>
                        <button type="submit" class="text-white inline-flex items-center bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                            <svg class="mr-1 -ml-1 w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
                            <span data-i18n="btnSaveExpense">Salvar Despesa</span>
                        </button>
                    </form>
                    <div id="finance-feedback" class="mt-4 hidden p-4 mb-4 text-sm rounded-lg" role="alert"></div>
                </div>

                <div id="tab-dicas" class="hidden h-full flex flex-col">
                    <div class="mb-4 bg-blue-50 p-4 rounded-lg border border-blue-100">
                        <div class="flex justify-between items-end mb-2">
                            <div>
                                <h4 class="font-bold text-blue-900 text-lg" data-i18n="tipsTitle">Jornada de Direitos</h4>
                                <p class="text-xs text-blue-700" data-i18n="tipsSubtitle">Marque o que voc√™ j√° conquistou ou encaminhou.</p>
                            </div>
                            <span id="checklist-percent" class="text-2xl font-bold text-blue-600">0%</span>
                        </div>
                        <div class="w-full bg-blue-200 rounded-full h-2.5">
                            <div id="checklist-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <p id="checklist-count" class="text-xs text-right text-blue-500 mt-1" data-i18n="tipsCountInitial">0 de 0 itens conclu√≠dos</p>
                    </div>

                    <div id="checklist-container" class="space-y-6 overflow-y-auto pr-2" style="max-h-[60vh];">
                        <p class="text-center text-gray-500 py-4" data-i18n="tipsLoading">Carregando checklist...</p>
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-100">
                        <p class="text-xs text-gray-500 text-center" data-i18n="tipsFooter">
                            D√∫vidas complexas? Converse com o Dr. IA ou use o chat de cuidadores.
                        </p>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<div id="abandonPatientModal" tabindex="-1" aria-hidden="true" style="z-index: 9999;" class="hidden fixed inset-0 z-[9999] flex items-center justify-center w-full h-full bg-gray-900 bg-opacity-50 backdrop-blur-sm">
    <div class="relative w-full max-w-md p-4">
        <div class="relative bg-white rounded-lg shadow-xl border-t-4 border-orange-500">
            <button type="button" onclick="closeAbandonPatientModal()" class="absolute top-3 right-2.5 text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ml-auto inline-flex justify-center items-center">
                <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                </svg>
            </button>
            
            <div class="p-6 text-center">
                <svg class="mx-auto mb-4 text-orange-500 w-12 h-12" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 11V6m0 8h.01M19 10a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
                </svg>
                
                <h3 class="mb-2 text-lg font-bold text-gray-800">
                    <span data-i18n="abandonTitlePrefix">Abandonar cuidados de</span> 
                    <span id="modal-abandon-name" class="text-orange-600">...</span>?
                </h3>
                
                <div class="text-sm text-gray-500 mb-6 text-left bg-orange-50 p-4 rounded-md border border-orange-100">
                    <p class="mb-2"><strong data-i18n="abandonWarnTitle">Ao confirmar:</strong></p>
                    <ul class="list-disc pl-5 space-y-1">
                        <li data-i18n="abandonWarn1">Voc√™ perder√° o acesso a este perfil.</li>
                        <li data-i18n="abandonWarn2">Os dados financeiros e de sa√∫de <strong>N√ÉO ser√£o apagados</strong>.</li>
                        <li data-i18n="abandonWarn3">Outros cuidadores vinculados continuar√£o com acesso.</li>
                        <li data-i18n="abandonWarn4">Voc√™ poder√° retornar pesquisando pelo C√≥digo do(a) Paciente na tela inicial.</li>
                    </ul>
                </div>

                <div class="flex justify-center gap-3">
                    <button onclick="closeAbandonPatientModal()" type="button" 
                            class="text-gray-900 bg-white hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 border border-gray-200 font-medium rounded-lg text-sm px-5 py-2.5 focus:outline-none" data-i18n="cancelButton">
                        Cancelar
                    </button>
                    <button onclick="confirmAbandonPatient()" type="button" 
                            class="text-white bg-orange-500 hover:bg-orange-600 focus:ring-4 focus:outline-none focus:ring-orange-300 font-medium rounded-lg text-sm px-5 py-2.5" data-i18n="btnConfirmAbandon">
                        Sim, abandonar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modal-cadastro-prof" class="fixed inset-0 z-[11000] hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="fecharModalCadastroProf()"></div>

    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
      <form id="form-cadastro-prof" class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title" data-i18n="profTitle">
          Cadastro de Profissional de Sa√∫de
        </h3>
        <div class="mt-4 space-y-4">
            
            <div>
                <label for="prof_nome" class="block text-sm font-medium text-gray-700" data-i18n="profLabelName">Nome Completo</label>
                <input type="text" id="prof_nome" name="nome" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>

            <div class="flex space-x-4">
                <div class="w-1/2">
                    <label for="prof_formacao" class="block text-sm font-medium text-gray-700" data-i18n="profLabelEducation">Forma√ß√£o</label>
                    <select id="prof_formacao" name="formacao" required onchange="atualizarConselho()" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="" data-i18n="optSelect">Selecione</option>
                        <option value="Medico" data-i18n="optDoctor">M√©dico</option>
                        <option value="Enfermeiro" data-i18n="optNurse">Enfermeiro</option>
                        <option value="Tecnico" data-i18n="optTechNurse">T√©cnico de Enfermagem</option>
                        <option value="Auxiliar" data-i18n="optAuxNurse">Auxiliar de Enfermagem</option>
                    </select>
                </div>
                 <div class="w-1/2">
                    <label for="prof_pronome" class="block text-sm font-medium text-gray-700" data-i18n="profLabelPronoun">Pronome de Tratamento</label>
                    <select id="prof_pronome" name="pronome_tratamento" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="" data-i18n="optSelectPrefix">Selecione (Dr/a, Enf/a...)</option>
                        <option value="Dr.">Dr.</option>
                        <option value="Dra.">Dra.</option>
                        <option value="Enf.">Enf.</option>
                        <option value="Enfa.">Enfa.</option>
                        <option value="Enfo.">Enfo.</option>
                        <option value="Tec.">T√©c.</option>
                        <option value="Aux.">Aux.</option>
                        <option value="Farm.">Farm.</option>                        
                    </select>
                </div>
            </div>

            <div class="flex space-x-4">
                <div class="w-1/3">
                    <label for="prof_tipo_conselho" class="block text-sm font-medium text-gray-700" data-i18n="profLabelCouncil">Conselho</label>
                    <select id="prof_tipo_conselho" name="tipo_conselho" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="" data-i18n="optCouncil">Conselho</option>
                        <option value="CFM">CFM</option>
                        <option value="COFEN">COFEN/COREN</option>
                        <option value="CFF">CFF</option>
                        <option value="CFO">CFO</option>
                    </select>
                </div>
                <div class="w-2/3">
                    <label for="prof_numero_conselho" class="block text-sm font-medium text-gray-700" data-i18n="profLabelCouncilNum">N¬∫ do Conselho</label>
                    <input type="text" id="prof_numero_conselho" name="numero_conselho" required 
                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" 
                           placeholder="Ex: 12345/SP" data-i18n-placeholder="phCouncilNum">
                </div>
            </div>

            <div class="flex space-x-4">
                <div class="w-1/2">
                    <label for="prof_email" class="block text-sm font-medium text-gray-700" data-i18n="profLabelEmail">E-mail</label>
                    <input type="email" id="prof_email" name="email" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="exemplo@dominio.com">
                </div>
                <div class="w-1/2">
                    <label for="prof_telefone" class="block text-sm font-medium text-gray-700" data-i18n="profLabelPhone">Telefone c/ DDD</label>
                    <input type="tel" id="prof_telefone" name="telefone" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="(XX) XXXXX-XXXX">
                </div>
            </div>

            <div class="relative flex items-start">
                <div class="flex items-center h-5">
                    <input id="prof_is_cuidador" name="is_cuidador" type="checkbox" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded">
                </div>
                <div class="ml-3 text-sm">
                    <label for="prof_is_cuidador" class="font-medium text-gray-700" data-i18n="profLabelIsCaregiver">Este profissional ser√° Cuidador do Paciente?</label>
                    <p class="text-gray-500" data-i18n="profDescIsCaregiver">Se marcado, o profissional cadastrado ter√° acesso √† tela de sele√ß√£o de pacientes, alertas e equipe de apoio a decis√£o.</p>
                </div>
            </div>

        </div>
        
        <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
            <button type="submit" id="btn-salvar-prof" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:ml-3 sm:w-auto sm:text-sm" data-i18n="btnSaveProf">
              Salvar Profissional
            </button>
            <button type="button" onclick="fecharModalCadastroProf()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm" data-i18n="cancelButton">
              Cancelar
            </button>
        </div>
      </form>
    </div>
  </div>
</div>

<div id="modal-legacy-info" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-[100000]">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 overflow-hidden relative animate-fade-in-up">
        
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-6 text-center">
            <div class="mx-auto bg-white/20 w-16 h-16 rounded-full flex items-center justify-center mb-3 backdrop-blur-sm">
                <span class="text-3xl">üé¨</span>
            </div>
            <h3 class="text-white text-xl font-bold" data-i18n="legTitle">Da Rotina ao Legado</h3>
            <p class="text-indigo-100 text-sm mt-1" data-i18n="legSubtitle">Sua dedica√ß√£o conta uma hist√≥ria.</p>
        </div>

        <div class="p-6">
            <p class="text-gray-600 text-sm leading-relaxed mb-4 text-justify" data-i18n="legBody">
                Sabemos que o dia a dia √© desafiador. Mas cada registro que voc√™ faz aqui ‚Äî cada medicamento, cada observa√ß√£o, cada voto ‚Äî est√° construindo a <strong>Jornada Vital</strong> do paciente.
            </p>
            
            <div class="bg-indigo-50 border-l-4 border-indigo-500 p-4 mb-4 rounded-r">
                <h4 class="font-bold text-indigo-800 text-sm mb-1" data-i18n="legAiTitle">‚ú® Futuro com IA</h4>
                <p class="text-xs text-indigo-700" data-i18n="legAiBody">
                    No final do tratamento, nossa Intelig√™ncia Artificial poder√° compilar todos esses dados para gerar um <strong>Livro Digital</strong> ou um <strong>V√≠deo de Mem√≥rias</strong>, celebrando a for√ßa e a supera√ß√£o de voc√™s.
                </p>
            </div>

            <p class="text-xs text-gray-500 text-center italic mb-6" data-i18n="legQuote">
                "Continue registrando. Voc√™ est√° escrevendo uma hist√≥ria de amor e cuidado."
            </p>

            <button onclick="document.getElementById('modal-legacy-info').classList.add('hidden'); document.getElementById('modal-legacy-info').classList.remove('flex');" 
                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow transition-colors" data-i18n="btnContinueLeg">
                Entendi, vou continuar registrando!
            </button>
        </div>
    </div>
</div>

<div id="modal-cancel-plan" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden" style="z-index: 10001;">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100">
                <svg class="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            
            <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2" data-i18n="cancelPlanTitle">Cancelar Plano Premium?</h3>
            
            <div class="mt-2 px-2 py-3">
                <p class="text-sm text-gray-500" data-i18n="cancelPlanDesc">
                    Ao cancelar, voc√™ perder√° acesso aos recursos exclusivos ao fim do ciclo atual.
                </p>
            </div>
            
            <div class="items-center px-4 py-3">
                <button onclick="confirmCancelPlan()" 
                        class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500" data-i18n="btnConfirmCancelPlan">
                    Sim, cancelar assinatura
                </button>
                
                <button onclick="closeCancelPlanModal()" 
                        class="mt-3 px-4 py-2 bg-white text-gray-700 text-base font-medium rounded-md w-full shadow-sm border border-gray-300 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-300" data-i18n="btnKeepPlan">
                    Manter meu Premium
                </button>
            </div>
        </div>
    </div>
</div>

<div id="modal-pix-payment" class="fixed inset-0 bg-gray-900 bg-opacity-75 overflow-y-auto h-full w-full hidden" style="z-index: 10000;">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                <span class="text-2xl">üí†</span>
            </div>
            <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2" data-i18n="pixTitle">Pagamento via PIX</h3>
            
            <div class="mt-2 px-2 py-3">
                <p class="text-sm text-gray-500 mb-4" data-i18n="pixDesc">
                    Escaneie o QR Code ou use a op√ß√£o "Copia e Cola" no seu banco.
                </p>

                <div class="flex justify-center mb-4 border p-2 rounded bg-gray-50">
                    <canvas id="pix-qr-canvas" class="mx-auto border p-2 rounded bg-white"></canvas>
                </div>

                <label class="text-xs font-bold text-gray-700 text-left block mb-1" data-i18n="pixLabelCopy">Pix Copia e Cola:</label>
                <div class="flex gap-2">
                    <input type="text" id="pix-copia-cola" readonly 
                           class="w-full text-xs border border-gray-300 rounded p-2 bg-gray-100 focus:outline-none text-gray-600">
                    
                    <button onclick="copyPixCode()" class="bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600" 
                            title="Copiar" data-i18n-title="btnCopyTooltip">
                        üìã
                    </button>
                </div>
            </div>

            <div class="items-center px-4 py-3 mt-4">
                <button onclick="finishPixPayment()" 
                        class="px-4 py-2 bg-green-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-700 focus:outline-none" data-i18n="btnPixPaid">
                    J√° realizei o pagamento
                </button>
                
                <button onclick="document.getElementById('modal-pix-payment').classList.add('hidden')" 
                        class="mt-3 px-4 py-2 bg-white text-gray-700 text-base font-medium rounded-md w-full shadow-sm border border-gray-300 hover:bg-gray-50" data-i18n="closeButton">
                    Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de controle de cateteres -->

<div id="modal-cateter" class="hidden fixed inset-0 z-[9999] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl m-4 max-h-[90vh] overflow-hidden flex flex-col">
        
        <div class="bg-indigo-600 p-4 flex justify-between items-center">
            <h2 class="text-xl font-bold text-white flex items-center gap-2" data-i18n="catTitle">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                Gest√£o de Acessos Venosos (Cateter)
            </h2>
            <button onclick="closeCatheterModal()" class="text-white hover:text-gray-200 text-2xl">&times;</button>
        </div>

        <div class="flex border-b border-gray-200">
            <button onclick="switchCatheterTab('active')" id="tab-cat-active" class="flex-1 py-3 px-4 text-center font-medium text-indigo-600 border-b-2 border-indigo-600 bg-indigo-50" data-i18n="tabCatActive">
                Cateteres Ativos
            </button>
            <button onclick="switchCatheterTab('add')" id="tab-cat-add" class="flex-1 py-3 px-4 text-center font-medium text-gray-500 hover:text-indigo-600" data-i18n="tabCatAdd">
                Adicionar Novo
            </button>
        </div>

        <div id="content-cat-active" class="p-6 overflow-y-auto flex-1 bg-gray-50">
            <div id="catheter-list-container" class="space-y-4">
                <p class="text-center text-gray-500 py-4" data-i18n="loading">Carregando...</p>
            </div>
        </div>

        <div id="content-cat-add" class="p-6 overflow-y-auto flex-1 hidden bg-white">
            <form id="form-add-catheter" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                
                <div class="md:col-span-2 bg-blue-50 p-4 rounded-lg">
                    <h3 class="font-bold text-blue-800 mb-3" data-i18n="catSecDevice">Dados do Dispositivo</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700" data-i18n="catLabelType">Tipo de Cateter</label>
                            <select id="cat_tipo" class="w-full p-2 border rounded" required>
                                <option value="PICC">PICC</option>
                                <option value="Port-a-Cath">Port-a-Cath</option>
                                <option value="CVC Jugular" data-i18n="optCVCJug">CVC Jugular</option>
                                <option value="CVC Subcl√°via" data-i18n="optCVCSub">CVC Subcl√°via</option>
                                <option value="CVC Femoral" data-i18n="optCVCFem">CVC Femoral</option>
                                <option value="Hickman">Hickman</option>
                                <option value="Permcath">Permcath</option>
                                <option value="Intracath">Intracath</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700" data-i18n="catLabelManuf">Fabricante</label>
                            <input type="text" id="cat_fabricante" class="w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700" data-i18n="catLabelSite">Local de Acesso</label>
                            <select id="cat_local" class="w-full p-2 border rounded">
                                <option value="Bra√ßo Direito" data-i18n="optArmR">Bra√ßo Direito</option>
                                <option value="Bra√ßo Esquerdo" data-i18n="optArmL">Bra√ßo Esquerdo</option>
                                <option value="Jugular Direita" data-i18n="optJugR">Jugular Direita</option>
                                <option value="Jugular Esquerda" data-i18n="optJugL">Jugular Esquerda</option>
                                <option value="Subcl√°via Direita" data-i18n="optSubR">Subcl√°via Direita</option>
                                <option value="Subcl√°via Esquerda" data-i18n="optSubL">Subcl√°via Esquerda</option>
                                <option value="Femoral Direita" data-i18n="optFemR">Femoral Direita</option>
                                <option value="Femoral Esquerda" data-i18n="optFemL">Femoral Esquerda</option>
                                <option value="Regi√£o tor√°xica" data-i18n="optThorax">Regi√£o tor√°xica</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <div>
                                <label class="block text-xs font-medium text-gray-700" data-i18n="catLabelLumens">L√∫mens</label>
                                <select id="cat_lumens" class="w-full p-2 border rounded">
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700" data-i18n="catLabelGauge">Calibre (Fr)</label>
                                <input type="text" id="cat_calibre" class="w-full p-2 border rounded" placeholder="ex: 5Fr">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700" data-i18n="catLabelLen">Comp. (cm)</label>
                                <input type="text" id="cat_comp" class="w-full p-2 border rounded" placeholder="ex: 60">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="md:col-span-2 bg-purple-50 p-4 rounded-lg">
                    <h3 class="font-bold text-purple-800 mb-3" data-i18n="catSecInsert">Dados da Inser√ß√£o</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700" data-i18n="catLabelDate">Data Inser√ß√£o</label>
                            <input type="date" id="cat_data" class="w-full p-2 border rounded" required>
                        </div>
                         <div>
                            <label class="block text-sm font-medium text-gray-700" data-i18n="catLabelMethod">M√©todo</label>
                            <select id="cat_metodo" class="w-full p-2 border rounded">
                                <option value="Seldinger">Seldinger</option>
                                <option value="Ultrassom" data-i18n="optUltrasound">Ultrassom</option>
                                <option value="Dissec√ß√£o" data-i18n="optDissection">Dissec√ß√£o</option>
                                <option value="Fluroscopia" data-i18n="optFluoro">Fluroscopia</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700" data-i18n="catLabelXray">Confirma√ß√£o RX</label>
                            <select id="cat_rx" class="w-full p-2 border rounded">
                                <option value="Sim" data-i18n="optRxYes">Sim - Adequado</option>
                                <option value="Sim - Reposicionar" data-i18n="optRxReposition">Sim - Reposicionar</option>
                                <option value="N√£o" data-i18n="optRxNo">N√£o Realizado</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700" data-i18n="catLabelIssues">Intercorr√™ncias</label>
                            <input type="text" id="cat_inter" class="w-full p-2 border rounded" placeholder="Opcional" data-i18n-placeholder="phOptional">
                        </div>
                    </div>
                </div>

                <div class="md:col-span-2 bg-green-50 p-4 rounded-lg">
                    <h3 class="font-bold text-green-800 mb-3" data-i18n="catSecMaint">Protocolo de Manuten√ß√£o</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700" data-i18n="catLabelFlush">Freq. Flush (dias)</label>
                            <input type="number" id="cat_freq_flush" class="w-full p-2 border rounded" value="7">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700" data-i18n="catLabelDressing">Freq. Curativo (dias)</label>
                            <input type="number" id="cat_freq_curativo" class="w-full p-2 border rounded" value="7">
                        </div>
                    </div>
                </div>

                <div class="md:col-span-2 pt-4">
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded hover:bg-indigo-700 font-bold shadow" data-i18n="btnSaveCat">
                        Salvar Cateter
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="modal-checklist-cateter" class="hidden fixed inset-0 bg-black bg-opacity-70 z-[9999] flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg">
        
        <div class="bg-green-600 p-4 rounded-t-lg flex justify-between items-center">
            <h3 class="text-white font-bold text-lg" data-i18n="chkTitle">Checklist de Manuten√ß√£o</h3>
            <button onclick="closeChecklistModal()" class="text-white font-bold">&times;</button>
        </div>

        <div class="p-6 space-y-3">
            <input type="hidden" id="checklist_cat_id">
            
            <label class="flex items-center space-x-3 p-2 border rounded hover:bg-gray-50">
                <input type="checkbox" class="w-5 h-5 text-green-600" id="chk_maos">
                <span data-i18n="chkHands">Higieniza√ß√£o das m√£os</span>
            </label>

            <label class="flex items-center space-x-3 p-2 border rounded hover:bg-gray-50">
                <input type="checkbox" class="w-5 h-5 text-green-600" id="chk_epi">
                <span data-i18n="chkPPE">Uso de EPI (Luvas Est√©reis/M√°scara)</span>
            </label>

            <label class="flex items-center space-x-3 p-2 border rounded hover:bg-gray-50">
                <input type="checkbox" class="w-5 h-5 text-green-600" id="chk_sitio">
                <span data-i18n="chkSite">Inspe√ß√£o do S√≠tio (Sem sinais flog√≠sticos)</span>
            </label>

            <label class="flex items-center space-x-3 p-2 border rounded hover:bg-gray-50">
                <input type="checkbox" class="w-5 h-5 text-green-600" id="chk_flush">
                <span data-i18n="chkFlush">Flush realizado com t√©cnica ass√©ptica</span>
            </label>

             <label class="flex items-center space-x-3 p-2 border rounded hover:bg-gray-50">
                <input type="checkbox" class="w-5 h-5 text-green-600" id="chk_clave">
                <span data-i18n="chkConnector">Clave trocado e etiquetado em cada l√∫men</span>
            </label>

            <label class="flex items-center space-x-3 p-2 border rounded hover:bg-gray-50">
                <input type="checkbox" class="w-5 h-5 text-green-600" id="chk_lumen">
                <span data-i18n="chkReflux">Todos os l√∫mens refluindo com sucesso.</span>
            </label>

            <label class="flex items-center space-x-3 p-2 border rounded hover:bg-gray-50">
                <input type="checkbox" class="w-5 h-5 text-green-600" id="chk_curativo">
                <span data-i18n="chkDressing">Troca de Curativo realizada</span>
            </label>

            <textarea id="checklist_obs" class="w-full border p-2 rounded mt-4" 
                      placeholder="Observa√ß√µes adicionais..." data-i18n-placeholder="phAdditionalObs"></textarea>
            
            <button onclick="submitMaintenance()" 
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded mt-2" data-i18n="btnConfirmMaint">
                Confirmar Realiza√ß√£o
            </button>
        </div>
    </div>
</div>

<div id="updateBanner" class="hidden fixed bottom-4 right-4 bg-blue-600 text-white p-4 rounded-lg shadow-lg z-50 flex flex-col gap-2 max-w-sm animate-bounce-in">
    <div class="font-bold text-lg" data-i18n="updateTitle">Nova vers√£o dispon√≠vel! üöÄ</div>
    
    <p id="updateMsg" class="text-sm text-blue-100" data-i18n="updateMsgDefault">Novas funcionalidades adicionadas.</p>
    
    <div class="flex gap-2 mt-2">
        <button onclick="window.location.reload(true)" 
                class="bg-white text-blue-600 px-4 py-1 rounded font-bold hover:bg-gray-100 transition" data-i18n="btnUpdateNow">
            Atualizar Agora
        </button>
        
        <button onclick="document.getElementById('updateBanner').classList.add('hidden')" 
                class="text-blue-200 hover:text-white px-2" data-i18n="btnUpdateLater">
            Depois
        </button>
    </div>
</div>

<div id="tmoChecklistModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden overflow-y-auto h-full w-full z-[10100]">
    <div class="relative top-5 mx-auto p-0 border w-full max-w-4xl shadow-lg rounded-md bg-white mb-10">
        
        <div class="flex flex-col bg-blue-600 text-white p-4 rounded-t-md sticky top-0 z-10 shadow-md">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold flex items-center gap-2" data-i18n="tmoTitle">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                    Checklist de Limpeza - Quarto TMO
                </h3>
                <button onclick="closeTmoModal()" class="text-white hover:text-gray-200 text-2xl font-bold">&times;</button>
            </div>
            <div class="mt-2 text-sm bg-blue-700 p-2 rounded border border-blue-500">
                <p data-i18n="tmoWarningPPE"><strong>‚ö†Ô∏è EPI Obrigat√≥rio:</strong> Avental, luvas, m√°scara, touca e prop√©s.</p>
                <p data-i18n="tmoWarningImmuno"><strong>‚ö†Ô∏è Aten√ß√£o:</strong> Paciente imunossuprimido. Respeite o tempo de a√ß√£o dos desinfetantes (10 min).</p>
            </div>
        </div>

        <div id="tmoChecklistContent" class="p-6 space-y-6 bg-gray-50"></div>

        <div class="p-4 border-t bg-gray-100 rounded-b-md flex justify-between items-center sticky bottom-0 z-10">
            <div class="text-sm text-gray-600">
                <span data-i18n="lblProgress">Progresso:</span> 
                <span id="checklistProgress" class="font-bold">0%</span>
            </div>
            <div class="flex gap-3">
                <button onclick="closeTmoModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition" data-i18n="cancelButton">Cancelar</button>
                <button onclick="saveChecklistTMO()" class="px-6 py-2 bg-green-600 text-white font-bold rounded hover:bg-green-700 transition shadow-lg flex items-center gap-2" data-i18n="btnFinishRegister">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    Finalizar e Registrar
                </button>
            </div>
        </div>
    </div>
</div>

<div id="contactModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-[10000]">
    <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-100">
        
        <div class="bg-blue-600 px-6 py-4 flex justify-between items-center">
            <h3 class="text-white text-lg font-bold flex items-center gap-2">
                <svg class="mr-3 h-4 w-4 text-gray-400 group-hover:text-teal-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                <span data-i18n="contactTitle">Fale Conosco</span>
            </h3>
            <button onclick="toggleContactModal(false)" class="text-blue-100 hover:text-white transition">
                <span class="material-symbols-outlined">X</span>
            </button>
        </div>

        <div class="p-6 space-y-4">
            <p class="text-gray-600 text-sm" data-i18n="contactDesc">Tem alguma d√∫vida, sugest√£o ou encontrou um problema? Envie uma mensagem para nossa equipe.</p>
            
            <form id="contactForm" onsubmit="enviarFaleConosco(event)">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="labelSubject">Assunto</label>
                    <div class="relative">
                        <select id="contactSubject" required
                            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none appearance-none bg-white">
                            <option value="" disabled selected data-i18n="optSelectSubject">Selecione um assunto...</option>
                            <option value="D√∫vida" data-i18n="optDoubt">D√∫vida</option>
                            <option value="Elogio" data-i18n="optPraise">Elogio</option>
                            <option value="Sugest√£o" data-i18n="optSuggestion">Sugest√£o de Melhoria</option>
                            <option value="Problema T√©cnico" data-i18n="optBug">Problema T√©cnico / Bug</option>
                            <option value="Outros" data-i18n="optOthers">Outros Assuntos</option>
                        </select>
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="material-symbols-outlined text-gray-400" hidden>label</span>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-i18n="labelMessage">Mensagem</label>
                    <textarea id="contactMessage" rows="5" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none resize-none"
                        data-i18n-placeholder="phMessage"
                        placeholder="Digite sua mensagem aqui com o m√°ximo de detalhes poss√≠vel..."></textarea>
                </div>

                <div class="flex justify-end gap-3 pt-2">
                    <button type="button" onclick="toggleContactModal(false)" 
                        class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium transition"
                        data-i18n="btnCancel">
                        Cancelar
                    </button>
                    <button type="submit" id="btnSendContact"
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium shadow-md transition flex items-center gap-2">
                        <span data-i18n="btnSendMessage">Enviar Mensagem</span>
                        <span class="material-symbols-outlined text-sm" hidden>send</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="shareOptionModal" class="fixed inset-0 z-[11000] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 transition-opacity duration-300">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-fade-in transform transition-all scale-100">
        
        <div class="bg-indigo-600 p-4 text-white flex justify-between items-center">
            <h3 class="font-bold flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                <span data-i18n="shareAccessTitle">Compartilhar Acesso</span>
            </h3>
            <button onclick="closeShareModal()" class="text-white hover:bg-white/20 rounded-full p-1 transition">‚úï</button>
        </div>

        <div class="p-6 space-y-4">
            
            <div class="bg-gradient-to-r from-amber-50 to-orange-50 dark:from-slate-700 dark:to-slate-700 border border-amber-100 dark:border-slate-600 rounded-xl p-3 flex items-start gap-3 shadow-sm">
                <div class="bg-amber-100 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400 p-2 rounded-full shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /> <path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                    </svg>
                </div>
                <div class="flex-grow">
                    <div class="flex justify-between items-center mb-1">
                        <h4 class="font-bold text-amber-800 dark:text-amber-300 text-xs uppercase tracking-wide" data-i18n="promoGamificationTitle">Desbloqueie Conquistas!</h4>
                        <span class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm animate-pulse ml-2 whitespace-nowrap">
                            +30 XP
                        </span>
                    </div>
                    <p class="text-xs text-amber-700 dark:text-slate-300 leading-snug" data-i18n="promoGamificationDesc">
                        Ao convidar novos cuidadores, voc√™ fortalece a rede de apoio e ganha a medalha <b>Embaixador</b> no seu perfil.
                    </p>
                </div>
            </div>

            <p class="text-sm text-gray-600 dark:text-slate-400 text-center mb-2" data-i18n="shareAccessDesc">
                Como voc√™ deseja convidar o novo cuidador?
            </p>

            <button onclick="shareLink('full')" class="w-full flex items-center p-3 rounded-xl border-2 border-indigo-100 bg-indigo-50 hover:bg-indigo-100 dark:bg-indigo-900/20 dark:border-indigo-800 dark:hover:bg-indigo-900/40 hover:border-indigo-300 transition-all group text-left">
                <div class="bg-indigo-600 text-white p-2 rounded-lg mr-3 shadow-sm group-hover:scale-110 transition-transform">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                </div>
                <div>
                    <h4 class="font-bold text-indigo-900 dark:text-indigo-200 text-sm" data-i18n="btnShareWithData">Enviar com Dados do Paciente</h4>
                    <p class="text-xs text-indigo-600 dark:text-indigo-400" data-i18n="subShareWithData">Inclui o c√≥digo para acesso imediato.</p>
                </div>
            </button>

            <button onclick="shareLink('app')" class="w-full flex items-center p-3 rounded-xl border border-gray-100 bg-white hover:bg-gray-50 dark:bg-slate-700 dark:border-slate-600 dark:hover:bg-slate-600 transition-all group text-left">
                <div class="bg-gray-400 text-white p-2 rounded-lg mr-3 shadow-sm group-hover:scale-110 transition-transform">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                </div>
                <div>
                    <h4 class="font-bold text-gray-700 dark:text-gray-200 text-sm" data-i18n="btnShareAppLink">Apenas Link do App</h4>
                    <p class="text-xs text-gray-500 dark:text-gray-400" data-i18n="subShareAppLink">Para instalar sem vincular paciente agora.</p>
                </div>
            </button>
        </div>

        <div class="bg-gray-50 dark:bg-slate-900 p-3 text-center border-t border-gray-100 dark:border-slate-700">
            <button onclick="closeShareModal()" class="text-xs font-bold text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200" data-i18n="btnCancel">Cancelar</button>
        </div>
    </div>
</div>

<div id="modal-relatorio-resposta" class="custom-modal-overlay">
    <div class="custom-modal-box">
        
        <div class="custom-modal-header">
            <h2 class="custom-modal-title">
                <span>üìã</span>
                <span data-i18n="reportResponseTitle">Relat√≥rio de Resposta e Atendimentos</span>
            </h2>
            <button onclick="ReportSystem.closeModal()" class="btn-close-icon" title="Fechar">&times;</button>
        </div>

        <div class="custom-modal-body">
            <table class="report-table">
                <thead>
                    <tr>
                        <th data-i18n="thDateTime">Data/Hora</th>
                        <th data-i18n="thReason">Motivo (Agilidade)</th>
                        <th data-i18n="thProfessional">Profissional</th>
                        <th data-i18n="thCaregiver">Cuidador</th>
                        <th data-i18n="thLocationCheck">Local OK?</th>
                        <th data-i18n="thNotes">Observa√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="lista-relatorio-corpo">
                    </tbody>
            </table>
        </div>

        <div class="custom-modal-footer">
            <button onclick="ReportSystem.clearLogs()" class="btn-modal btn-danger" data-i18n="btnClearHistory">
                Limpar Hist√≥rico
            </button>
            <button onclick="ReportSystem.closeModal()" class="btn-modal btn-primary" data-i18n="btnClose">
                Fechar
            </button>
        </div>
    </div>
</div>

<div id="profissional_presente_agora" class="custom-modal-overlay">
    <div class="custom-modal-box" style="max-width: 600px; max-height: 90vh; display: flex; flex-direction: column;">
        
        <div class="custom-modal-header">
            <h2 class="custom-modal-title">
                <span>üë®‚Äç‚öïÔ∏è</span>
                <span data-i18n="ppTitle">Equipe Presente no Turno</span>
            </h2>
            <button onclick="ProfessionalPresence.closeModal()" class="btn-close-icon">&times;</button>
        </div>

        <div class="custom-modal-body" style="padding: 20px; overflow-y: auto;">
            
            <div style="margin-bottom: 20px; background: #f0fdf4; padding: 15px; border-radius: 8px; border: 1px solid #bbf7d0;">
                <h3 style="font-size: 14px; color: #166534; margin: 0 0 10px 0; font-weight: bold;">
                    <span class="mr-1">‚úÖ</span> 
                    <span data-i18n="ppActivePros">Profissionais no Local (Ativos):</span>
                </h3>
                <div id="lista-profissionais-ativos" style="display: flex; flex-wrap: wrap; gap: 10px; min-height: 40px;">
                    <span class="empty-msg" style="color: #666; font-style: italic; font-size: 13px;" data-i18n="ppNoActiveSelection">Nenhum profissional ativo no momento.</span>
                </div>
            </div>

            <div style="margin-bottom: 25px; background: #f9fafb; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb;">
                <h3 style="font-size: 14px; color: #4b5563; margin: 0 0 10px 0; font-weight: bold;">
                    <span class="mr-1">üí§</span> 
                    <span data-i18n="ppInactivePros">Profissionais em Descanso (Desativos):</span>
                </h3>
                <div id="lista-profissionais-desativos" style="display: flex; flex-wrap: wrap; gap: 10px; min-height: 40px;">
                    <span class="empty-msg" style="color: #9ca3af; font-style: italic; font-size: 13px;" data-i18n="ppNoInactiveSelection">Nenhum profissional em descanso.</span>
                </div>
            </div>

            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

            <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">
                    üîé <span data-i18n="ppAddLabel">Adicionar Profissional ao Turno:</span>
                </label>
                
                <div style="position: relative;">
                    <input type="text" id="input-busca-prof" 
                           placeholder="Digite o nome para buscar..." 
                           style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;"
                           onkeyup="ProfessionalPresence.search(this.value)"
                           autocomplete="off">
                    
                    <div id="resultados-busca-prof" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e5e7eb; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; z-index: 10; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                    </div>
                </div>
            </div>

            <div style="margin-top: 15px; text-align: center; font-size: 12px; color: #6b7280;">
                <span data-i18n="ppNotFound">Ainda n√£o cadastrado no sistema?</span>                     
                <a href="#" onclick="openNewProfessionalModal()" style="color: #2563eb; font-weight: 600; margin-left: 5px;">
                    <span data-i18n="ppRegisterNew">Cadastrar novo</span>
                </a>
            </div>
        </div>

        <div class="custom-modal-footer">
            <button onclick="ProfessionalPresence.closeModal()" class="btn-modal btn-primary" data-i18n="btnFinish">Concluir</button>
        </div>
    </div>
</div>

<div id="welcomeOnboardingModal" class="fixed inset-0 z-[12000] hidden flex items-center justify-center bg-indigo-900/80 backdrop-blur-sm p-4">
    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-in-up relative">
        
        <div class="absolute top-0 left-0 w-full h-32 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-b-[50%] scale-x-150 -translate-y-10 z-0"></div>

        <div class="relative z-10 p-6 text-center">
            
            <div class="mx-auto w-20 h-20 bg-white rounded-full flex items-center justify-center shadow-lg mb-4 mt-4 border-4 border-indigo-50">
                <span class="text-4xl">üëã</span>
            </div>

            <h2 class="text-2xl font-bold text-gray-800 mb-2" data-i18n="welcomeTitle">Bem-vindo ao Acura!</h2>
            
            <p class="text-gray-600 text-sm mb-6 leading-relaxed" data-i18n="welcomeSubtitle">
                Sua jornada de cuidado come√ßa aqui. Percebemos que voc√™ ainda n√£o tem pacientes cadastrados.
            </p>

            <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-4 mb-6 text-left">
                <h3 class="text-indigo-900 font-bold text-sm mb-2 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    <span data-i18n="welcomeHowItWorks">Como funciona o XP?</span>
                </h3>
                <ul class="space-y-2 text-xs text-indigo-800">
                    <li class="flex items-start gap-2">
                        <span class="text-indigo-500 mt-0.5">1.</span>
                        <span data-i18n="welcomeStep1">Cadastre seu primeiro paciente agora.</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-indigo-500 mt-0.5">2.</span>
                        <span data-i18n="welcomeStep2">O App te guiar√° nas tarefas di√°rias.</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-indigo-500 mt-0.5">3.</span>
                        <span data-i18n="welcomeStep3">Cada cuidado registrado gera <strong>Pontos de Experi√™ncia (XP)</strong> e medalhas!</span>
                    </li>
                </ul>
            </div>

            <button onclick="closeWelcomeAndCreate()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg shadow-indigo-200 transform transition hover:scale-[1.02] flex items-center justify-center gap-2">
                <span data-i18n="btnCreateFirstPatient">Criar Primeiro Paciente</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
            </button>
            
        </div>
    </div>
</div>

   <script>


/* app.js
   Reescrita completa do JS do front-end para funcionar em produo com api.php
*/
const API_URL = 'https://acura.vc/api.php';

const Screens = {
  LOGIN: 'loginScreen',
  CAREGIVER: 'caregiverScreen',
  PATIENT_SELECTION: 'patientSelectionScreen',
  MAIN_GAME: 'mainGameScreen',
  DASHBOARD: 'patientDashboardScreen'
};

const ALARM_SOUNDS = {
    'none': null,
    'synth': 'https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg', 
    'beep_short': 'https://actions.google.com/sounds/v1/alarms/beep_short.ogg',
    'digital_long': 'https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg',
    'medium_bell': 'https://actions.google.com/sounds/v1/alarms/medium_bell_ringing_near.ogg',
    'phone_ring': 'https://actions.google.com/sounds/v1/alarms/phone_alerts_and_rings.ogg',
    'beep': 'beep.mp3'
};

// Fun√ß√£o auxiliar para criar o objeto de √°udio com seguran√ßa
function getSavedAlarmAudio() {
    const savedKey = localStorage.getItem('alarmSound') || 'beep';
    const soundUrl = ALARM_SOUNDS[savedKey];

    // Se a URL existir (n√£o for null/none), retorna o Audio. Sen√£o, retorna null.
    return soundUrl ? new Audio(soundUrl) : null;
}
const EMERGENCY_BEEP = 'data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU'; // (Exemplo encurtado)

const LANG_STRINGS = {
    'pt': {

        //boas vindas
        'welcomeTitle': 'Bem-vindo ao Acura!',
        'welcomeSubtitle': 'Sua jornada de cuidado come√ßa aqui. Percebemos que voc√™ ainda n√£o tem pacientes cadastrados.',
        'welcomeHowItWorks': 'Como funciona o XP?',
        'welcomeStep1': 'Cadastre seu primeiro paciente agora.',
        'welcomeStep2': 'O App te guiar√° nas tarefas di√°rias.',
        'welcomeStep3': 'Cada cuidado registrado gera Pontos de Experi√™ncia (XP) e medalhas!',
        'btnCreateFirstPatient': 'Criar Primeiro Paciente',

        //alterna hospital/casa
        'locModeHospital': 'Hospital / Institui√ß√£o',
        'lblHospitalName': 'Nome do Hospital:',
        'locModeHome': 'Resid√™ncia / HomeCare',
        'lblIdentification': 'Identifica√ß√£o:',
        'valHomePatient': 'Casa de Paciente',

        //profissionais no turno
        'titleDeleteProf': 'Excluir Profissional',
        'msgConfirmDeleteProf': 'Tem certeza que deseja remover este profissional da lista definitivamente?',
        'btnDelete': 'Excluir',
        'ppTitle': 'Equipe Presente no Turno',
        'ppActivePros': 'Profissionais no Local (Ativos):',
        "ppInactivePros": "Profissionais em Descanso (Desativos):",
        'ppNoSelection': 'Nenhum profissional selecionado.',
        'ppAddLabel': 'Adicionar Profissional ao Turno:',
        'ppSearchPlaceholder': 'Digite o nome do profissional...',
        'ppNotFound': 'N√£o encontrou?',
        'ppRegisterNew': 'Cadastrar novo profissional',
        'btnFinish': 'Concluir',

        //atendimento
        'rsReasonGeneral': 'Geral',
        'rsNotInformed': 'N√£o Informado',
        'rsYes': 'Sim',
        'rsNo': 'N√£o',
        'rsNoRecordsFound': 'Nenhum registro encontrado.',
        'rsLabelResp': 'Resp',
        'rsClearHistoryTitle': 'Limpar Hist√≥rico',
        'rsConfirmClear': 'Tem certeza que deseja apagar todo o hist√≥rico de atendimentos?',
        'rsBtnClearConfirm': 'Sim, Apagar',
        'titleLogAttendance': 'Registro de Atendimento',
        'lblWhoAttended': 'Quem est√° realizando o atendimento?',
        'phWhoAttended': 'Nome do Profissional ou Cuidador',
        'lblObservations': 'Observa√ß√µes:',
        'phObservations': 'Ex: Paciente atendido, medica√ß√£o adiantada...',
        'btnSaveLog': 'Salvar Registro',
        'reasonManualCall': 'Chamada Manual (Campainha)',
        'defaultCaregiverName': 'Cuidador Atual',
        'msgAttendanceSaved': 'Atendimento registrado com sucesso!',
        // 'btnCancel' j√° deve existir
        'rsReasonGeneral': 'Geral',
        'rsNotInformed': 'N√£o Informado',
        'rsYes': 'Sim',
        'rsNo': 'N√£o',
        'rsNoRecordsFound': 'Nenhum registro encontrado.',
        'rsLabelResp': 'Resp',
        'rsConfirmClear': 'Tem certeza que deseja apagar todo o hist√≥rico de atendimentos?',
        'reportResponseTitle': 'Relat√≥rio de Resposta e Atendimentos',
        'thDateTime': 'Data/Hora',
        'thReason': 'Motivo (Agilidade)',
        'thProfessional': 'Profissional',
        'thCaregiver': 'Cuidador',
        'thLocationCheck': 'Local OK?',
        'thNotes': 'Observa√ß√µes',
        'btnClearHistory': 'Limpar Hist√≥rico',
        'btnClose': 'Fechar',

        //modal de compartilhamento
        'promoGamificationTitle': 'Desbloqueie Conquistas!',
        'promoGamificationDesc': 'Convide cuidadores, fortale√ßa a rede de apoio e ganhe a medalha Embaixador Acura.',
        'msgShareDefault': 'Ol√°! Estou usando o app Acura: Vencer Cuidando, da OncoTrek.org, para auxiliar no nosso tratamento.',
        'msgErrNoPatientCode': 'N√£o foi poss√≠vel localizar o c√≥digo do paciente. Compartilhando apenas o link do App.',
        'msgShareWithCode': 'Ol√°! Acesse o *acura.vc* para acompanhar o paciente. O c√≥digo de acesso √©: *{code}*',
        'titleCodeDetected': 'C√≥digo Detectado!',
        'msgCodeInserted': "C√≥digo {code} inserido. Clique em 'Entrar' para acessar.",
        'btnOk': 'Ok',
        'modalAttentionTitle': 'Aten√ß√£o',
        'shareAccessTitle': 'Compartilhar Acesso',
        'shareAccessDesc': 'Como voc√™ deseja convidar o novo cuidador?',
        'btnShareWithData': 'Enviar com Dados do Paciente',
        'subShareWithData': 'Inclui o c√≥digo para acesso imediato.',
        'btnShareAppLink': 'Apenas Link do App',
        'subShareAppLink': 'Para instalar sem vincular paciente agora.',
        'btnCancel': 'Cancelar',

        //voz
        'msgWeNeedYou' : 'Precisamos de voc√™',
        'msgSpeakComeAcura': 'Venha! Voc√™ tem Acura.',

        //
        'lblTrend': 'Tend√™ncia:',
        'statusAdequate': '‚úÖ Adequado',
        'statusConsumeMore': '‚ö†Ô∏è Consumir Mais',
        'titleLiquidConsumption': 'Consumo de L√≠quidos (mL)',
        'lblTotal': 'Total:',
        'lblGoal': 'Meta:',
        'lblDaily': '/Dia',
        'titleRegisteredMeals': 'Refei√ß√µes Registradas',
        'lblMealsInPeriod': 'refei√ß√µes no per√≠odo',
        'statusStable': 'Est√°vel',
        'goalMealsPerDay': 'Meta: 4-5 refei√ß√µes/dia',

        //
        'titleLogEmergency': 'Registrar Emerg√™ncia',
        'msgConfirmEmergency': 'Deseja registrar "{type}" agora?',
        'btnRegister': 'Registrar',
        'msgEmergencySaved': '‚úÖ Registro de emerg√™ncia salvo com sucesso!',
        'titleLocationAccess': 'Acesso √† Localiza√ß√£o',
        'msgLocationRequiredEmergency': 'Por favor, permita a localiza√ß√£o para registrar a emerg√™ncia.',
        // 'modalSuccessTitle', 'modalErrorTitle', 'msgGenericError' e 'msgConnectionError' j√° devem existir

        // final jornada
        'titleEndOfJourney': 'Fim da Jornada',
        'msgConfirmGrief': 'ATEN√á√ÉO: Esta a√ß√£o encerrar√° o ciclo de cuidados para este paciente. Deseja realmente confirmar o luto?',
        'btnConfirmGrief': 'Sim, Confirmar Luto',
        'msgValidatingLocation': 'Validando localiza√ß√£o...',
        'detailsJourneyEnded': 'Jornada encerrada.',
        'titleJourneyEnded': 'Jornada Encerrada',
        'msgCondolences': 'Meus sentimentos. O aplicativo ser√° reiniciado para atualizar os dados.',
        'msgLocationRequired': 'Necess√°rio localiza√ß√£o para validar o encerramento.',
        // 'modalErrorTitle', 'msgGenericError' e 'msgConnectionError' j√° existem

        // Trofeu
        'msgDatePending': 'Data de in√≠cio pendente',
        'survivorCountdown': '{a}a {d}d {h}h para Celebra√ß√£o Suprema',
        'survivorInfoTitle': 'O Caminho Her√≥ico',
        'survivorInfoP1': 'O <b>Trof√©u Overall</b> celebra a jornada de 5 anos ap√≥s o diagn√≥stico inicial.',
        'survivorInfoP2': 'Na medicina, este marco representa <b>A cura</b> consolidada e a supera√ß√£o do risco de recidiva.',
        'survivorInfoP3': 'Continue fazendo a sua hist√≥ria e n√£o deixe faltar ningu√©m na festa: convide profissionais e cuidadores para <b>A cura</b>!',
        'survivorInfoFooter': 'Faltam <b>{a} anos e {d} dias</b> de vigil√¢ncia e amor.',
        'btnKeepCaring': 'Continuar Cuidando',
        'survivorVictoryBtnLabel': 'VIT√ìRIA ALCAN√áADA! CLIQUE AQUI!',
        'survivorVictoryTitle': 'üéä SUPER VIVENTE ABSOLUTO üéä',
        'survivorVictorySubtitle': '5 ANOS DE VIT√ìRIA!',
        'survivorVictoryQuote': 'O c√¢ncer tornou-se apenas uma p√°gina virada na sua hist√≥ria de bravura.',
        'survivorVictoryListTitle': 'A partir de agora, um novo cap√≠tulo come√ßa:',
        'survivorActionInspireTitle': 'Inspirar:',
        'survivorActionInspireDesc': 'Transforme sua jornada em um livro ou filme para guiar quem ainda est√° no caminho.',
        'survivorActionGratitudeTitle': 'Gratid√£o:',
        'survivorActionGratitudeDesc': 'Honre os her√≥is da medicina e enfermagem que lutaram ao seu lado.',
        'survivorActionMentorshipTitle': 'Mentoria:',
        'survivorActionMentorshipDesc': 'Use o app Acura para dar suporte e esperan√ßa a novos pacientes.',
        'survivorVictoryFinalMsg': 'E, principalmente... Viva. Intensamente.',
        'btnCelebrateLife': '‚ú® CELEBRAR A VIDA ‚ú®',

        //catheter
        'msgNoCatheter': 'Nenhum cateter ativo encontrado.',
        'btnRegisterNew': 'Cadastrar Novo',
        'labelCatheter': 'Cateter',
        'lblInsertedIn': 'Inserido em:',
        'lblManufacturer': 'Fabricante:',
        'lblGauge': 'Calibre:',
        'statusActive': 'Ativo',
        'lblNextFlush': 'Pr√≥ximo Flush',
        'lblNextDressing': 'Pr√≥ximo Curativo',
        'tagToday': '(HOJE)',
        'btnMaintenance': 'Manuten√ß√£o',
        'btnRemoved': 'Retirado',
        // 'msgLoading' e 'msgConnectionError' j√° existem

        //timeline
        'timeToday': ' (hoje)',
        'timeTomorrow': ' (amanh√£)',
        'timeInDays': ' (daqui a {days} dias)',
        'titleAppointmentsFor': 'Agendamentos para',
        'lblDescription': 'Descri√ß√£o:',
        'lblPlace': 'Local:',
        'lblProfessional': 'Profissional:',
        'lblPhone': 'Telefone:',
        'lblFasting': 'Jejum:',
        'lblHours': 'horas',
        'lblNotNeeded': 'N√£o necess√°rio',
        'lblInstructions': 'Instru√ß√µes:',
        'lblStatus': 'Status:',
        'btnNotDone': '‚ö†Ô∏è N√£o Realizado',
        'btnCancel': '‚ùå Cancelar',
        'btnReschedule': 'üìÖ Reagendar',
        'btnDone': '‚úÖ Realizado',
        'lblNewDate': 'Nova Data e Hora (Reagendamento):',
        'btnRequestReschedule': 'Solicitar Reagendamento',
        'titleFinishReturn': 'Finalizar e Agendar Retorno',
        'lblReturnDate': 'Data/Hora do Retorno (Deixe vazio para finalizar sem retorno):',
        'lblPayerSource': 'Selecione a fonte do pagamento do retorno:',
        'optPublic': 'P√∫blico',
        'optInsurance': 'Plano',
        'optPrivate': 'Particular',
        'btnConfirmCompletion': 'Confirmar Conclus√£o',
        'btnCancelText': 'Cancelar',
 
        //notifica√ß√£o
        'alertTitle': 'Alerta do Cuidador',
        'alertBody': 'Verifique o paciente!',
        'msgAlertTriggered': 'üö® Alerta!',

        //cancela
        'titleFreeMode': 'Modo Free ativado..',
        'msgPlanCanceled': 'Plano cancelado com sucesso.',
        'msgCancelFailed': 'Falha ao cancelar.',
        'msgConnectionErrorCancel': 'Erro de conex√£o ao tentar cancelar.',
        // J√° existentes (apenas refer√™ncia)
        'btnProcessing': 'Processando...',
        'modalErrorTitle': 'Falha',
        'msgUserNotAuth': 'Erro: Usu√°rio n√£o identificado. Fa√ßa login novamente.',
        'msgErrorPrefix': 'Erro: ',

        //fluxo de pagamento
        'msgErrCardFormNotLoaded': 'Erro: O formul√°rio de pagamento n√£o foi carregado corretamente. Recarregue a p√°gina.',
        'modalAttentionTitle': 'Aten√ß√£o',
        'msgFillCardData': 'Por favor, preencha os dados para continuar.',
        'btnValidatingCard': 'Validando Cart√£o...',
        'titleWelcome': 'Boas-vindas!',
        'msgPremiumWelcome': 'üéâ Bem-vindo(a)! Sua jornada premium come√ßou.',
        'msgGenericError': 'Ocorreu um erro ao processar a assinatura.',
        // 'modalErrorTitle' e 'msgConnectionError' j√° devem existir.

        //confirma senha
        'msgPassMinLength': 'A senha deve ter pelo menos 6 caracteres.',
        'msgPassResetSuccess': 'Sucesso! Use sua nova senha para entrar.',
        'modalResultTitle': 'Resultado',
        // C√≥digos de erro poss√≠veis do backend (Sugest√£o)
        'TOKEN_INVALID': 'O token de recupera√ß√£o √© inv√°lido ou expirou.',
        'TOKEN_EXPIRED': 'Este link expirou. Solicite um novo.',
        // J√° existentes (apenas refer√™ncia)
        'btnSaving': 'Salvando...',
        'modalSuccessTitle': 'Sucesso',
        'modalErrorTitle': 'Falha',
        'msgConnectionError': 'Erro de conex√£o.',

        //nova senha
        'msgEnterEmail': 'Por favor, digite seu e-mail.',
        'btnSendLink': 'Enviar Link',
        // C√≥digos de Retorno do Backend (Sugest√£o)
        'EMAIL_SENT': 'Um link de recupera√ß√£o foi enviado para seu e-mail.',
        'USER_NOT_FOUND': 'N√£o encontramos uma conta com este e-mail.',
        'EMAIL_INVALID': 'O formato do e-mail √© inv√°lido.',
        // Chaves j√° existentes (apenas para refer√™ncia)
        'btnSending': 'Enviando...',
        'modalSuccessTitle': 'Sucesso',
        'modalErrorTitle': 'Erro',
        'msgConnectionError': 'Erro de conex√£o.',

        //excluir
        'btnProcessing': 'Processando...',
        'titleDone': 'Pronto',
        'msgAccountDeleted': 'Conta exclu√≠da. Lamentamos ver voc√™ partir.',
        'msgDeleteErrorPrefix': 'Erro ao excluir conta: ',
        // 'modalErrorTitle', 'msgTryAgain' e 'msgConnectionError' j√° devem existir.

        //contato
        'btnSending': 'Enviando...',
        'modalThankYouTitle': 'Obrigado',
        'msgMessageSent': 'Mensagem enviada com sucesso!',
        'msgSendErrorPrefix': 'Erro ao enviar: ',
        'msgTryAgain': 'Tente novamente.',
        // 'modalErrorTitle' e 'msgConnectionError' j√° devem existir.
        'contactTitle': 'Fale Conosco',
        'contactDesc': 'Tem alguma d√∫vida, sugest√£o ou encontrou um problema? Envie uma mensagem para nossa equipe.',
        'labelSubject': 'Assunto',
        'labelMessage': 'Mensagem',
        'optSelectSubject': 'Selecione um assunto...',
        'optDoubt': 'D√∫vida',
        'optPraise': 'Elogio',
        'optSuggestion': 'Sugest√£o de Melhoria',
        'optBug': 'Problema T√©cnico / Bug',
        'optOthers': 'Outros Assuntos',
        'phMessage': 'Digite sua mensagem aqui com o m√°ximo de detalhes poss√≠vel...',
        'btnCancel': 'Cancelar',
        'btnSendMessage': 'Enviar Mensagem',

        //financeiro
        'msgConnectionError': 'Erro de conex√£o.',

        //abandonar
        'msgNoPatientToAbandon': 'Nenhum paciente selecionado para abandonar.',
        'defaultPatientName': 'Paciente',
        'msgErrPatientIdMissing': 'Erro: ID do paciente n√£o encontrado no estado.',
        'msgErrSessionMissing': 'Erro: Sess√£o do cuidador n√£o encontrada. Tente fazer login novamente.',
        'titleDone': 'Est√° feito',
        'msgAbandonSuccess': 'Voc√™ deixou de cuidar deste paciente.',
        'msgErrorPrefix': 'Erro: ',
        // 'modalErrorTitle' e 'msgConnectionError' j√° devem existir

        //interacoes
        'medIntervalSN': 'S/N',
        'medIntervalPrefix': 'De',
        'medIntervalSuffix': 'em',
        'medIntervalHours': 'h',
        'msgNoActiveMeds': 'Nenhum medicamento ativo registrado.',
        'msgNoInactiveMeds': 'Nenhum inativo recente.',
        'msgNoAlerts': 'Sem alertas internos.',
        'statusAttention': 'Aten√ß√£o Necess√°ria',
        'statusExcellent': 'Excelente!',
        'statusRegular': 'Regular',
        'titlePharmacy': 'üíä Gest√£o Farmac√™utica',
        'titleActive': 'Ativos',
        'tagInUse': 'Em uso',
        'titleAlerts': 'Alertas Farmac√™uticos',
        'btnCheckInteractions': 'Verificar Intera√ß√µes (IA)',
        'tooltipNeedMeds': 'Necess√°rio 2+ medicamentos',
        'titleHistory': 'Hist√≥rico Recente',
        'msgHistoryDisclaimer': '"O valor total consumido dividido pela capacidade do frasco indica o consumo real."',
        'titleAdherence': 'Ades√£o ao Tratamento',
        'lblEfficiency': 'Efici√™ncia Adminstrada',
        'lblDoses': 'doses',
        'msgBasedOn30Days': 'Baseado nos √∫ltimos 30 dias.',
        'titleConsolidated': 'üìä Consumo Consolidado',
        'colItem': 'Item',
        'colDoses': 'Doses',
        'colTotal': 'Total',
        'msgLoading': 'Carregando...',
        'titleFrequencyChart': 'üìà Gr√°fico de Frequ√™ncia',
        'btnAnalyzing': 'Analisando...',
        'lblAnalysisResult': 'Resultado da An√°lise',
        'lblSource': 'Fonte',
        'msgSelectPatientVerification': 'Selecione um paciente para realizar a verifica√ß√£o.',
        'msgConnectionErrorVerification': 'Falha na conex√£o.',
        'msgNoInteractions': 'nenhuma intera√ß√£o', // Texto chave para l√≥gica de sucesso

        //geo tmo
        'msgMissingLocationName': 'Por favor, informe o nome do Local.',
        'msgSessionError': 'Erro de Sess√£o: N√£o foi poss√≠vel identificar usu√°rio/paciente.',
        'btnSave': 'Salvar',
        'btnSaving': 'Salvando...',
        'msgLocationUpdated': '‚úÖ Localiza√ß√£o atualizada!',
        'msgServerRefused': '‚ö†Ô∏è O servidor recusou: ',
        // 'modalWarningTitle', 'modalErrorTitle', 'modalSuccessTitle' e 'msgConnectionError' j√° devem existir.
        'gpsSearching': 'üìç Buscando dados...',
        'gpsConfirming': 'üìç Confirmando GPS...',
        'gpsUpdated': 'üìç Localiza√ß√£o GPS Atualizada',
        'gpsOffline': 'üìç Usando √∫ltima localiza√ß√£o conhecida (GPS Off)',
        'labelHomePatient': 'Casa de Paciente',
        'tmoStatusNone': 'Nenhuma limpeza registrada anteriormente.',
        'tmoBtnDoChecklist': 'Realizar Checklist de Limpeza TMO',
        'tmoStatusDays': '√öltima limpeza: {days} dias atr√°s (Meta: {freq} dias).',
        'tmoBtnExpired': '‚ö†Ô∏è ATEN√á√ÉO: Limpeza TMO Vencida',
        'tmoBtnOk': 'Limpeza em dia. Realizar nova?',
        'tagActionRequired': 'A√ß√£o Necess√°ria',

        //graficos
        'msgNoHydricData': 'Nenhum dado encontrado para o per√≠odo.',
        'typeOralLiquids': 'L√≠quidos Orais',
        'typeIVEtheral': 'IV/Enteral (Medica√ß√£o)',
        'typeExcretion': 'Excre√ß√£o (Diurese/V√¥mito/Dreno)',
        'typeInsensible': 'Perda Insens√≠vel (Est.)',
        'labelSummary': 'Resumo',
        'tooltipViewNote': 'Toque para ver a observa√ß√£o',
        'labelViewNote': 'Ver nota',
        'msgNoHydricRecords': 'Nenhum registro de entrada ou sa√≠da encontrado no per√≠odo.',
        'msgNoMealData': 'Nenhum dado de refei√ß√£o ou excre√ß√£o s√≥lida encontrado no per√≠odo.',
        'labelIntakeG': 'Ingest√£o (g)',
        'labelOutputG': 'Sa√≠da (Fezes, g)',
        'labelDay': 'Dia',
        'labelMassG': 'Massa (g)',
        'msgNoData': 'Nenhum dado',
        'statusEvaluation': 'Em Avalia√ß√£o',
        'statusHighRisk': '‚ö†Ô∏è Risco Acentuado!',
        'statusAdequate': '‚úÖ Adequado',
        'labelWeight': 'Peso (kg)',
        'labelBMI': 'IMC',
        'labelAbdominalCirc': 'Circ. Abdominal (cm)',
        'labelHighRiskLimit': 'Limite Risco Alto',
        'labelCirc': 'Circ. (cm)',

        'msgNoPatientSelected': 'Nenhum paciente selecionado',
        'msgUserNotAuth': 'Usu√°rio n√£o autenticado.',
        'msgNicknameRequired': 'Apelido do cuidador √© obrigat√≥rio.',
        'msgSavingSettings': 'Salvando configura√ß√µes...',
        'msgSettingsSaved': '‚úÖ Configura√ß√µes salvas e aplicadas!',
        'msgSettingsSaveFail': 'Falha ao salvar configura√ß√µes.',
        'msgNoFileSelected': 'Nenhum arquivo selecionado.',
        'msgSavingAvatar': 'Salvando novo avatar...',
        'msgAvatarUpdated': '‚úÖ Avatar atualizado com sucesso!',
        'msgAvatarUploadFail': 'Falha ao carregar avatar.',

        //agenda
        'msgSyncData': 'Sincronizando dados cl√≠nicos...',
        'tmoRequiredTitle': 'Limpeza Terminal Necess√°ria',
        'tmoLastCleaning': '√öltima limpeza h√° <b>{days} dias</b>. (Meta: cada {freq} dias).',
        'tmoChecklistBtn': 'Checklist',
        'catIssueFlush': 'Flush/Saliniza√ß√£o (Venceu hoje ou antes)',
        'catIssueDressing': 'Troca de Curativo (Venceu hoje ou antes)',
        'catMaintTitle': 'Manuten√ß√£o: ',
        'msgAppointmentsToday': '<b>Aten√ß√£o:</b> H√° <span class="font-bold">{count}</span> agendamento(s) hoje!',
        'msgAllClear': '‚ú® Tudo tranquilo! Nenhuma pend√™ncia no momento.',

        //medicacoes
        'msgMedTakenSuccess': 'Medica√ß√£o {med} tomada com sucesso. üíä',
        'lblInfusion': 'Infus√£o',
        'lblAgendaId': 'ID Agenda',
        'msgTimeCalcAuto': 'Tempo calculado automaticamente',
        'msgDoseNeglected': '‚ùå Medica√ß√£o ignorada ou suspensa. -10% de chance.',
        'msgAllMedsTaken': 'As medica√ß√µes est√£o em dia!',
        // 'todayAgenda' j√° deve existir ('Agenda de Hoje')
        'optNone': 'Nenhum',
        'payerPublic': 'P√∫blico',
        'statusActive': 'Ativa',
        'msgDoseSuspendedObs': 'Dose suspensa e registrada com observa√ß√£o.',
        'msgDoseRegisteredObs': 'Dose registrada com observa√ß√£o.',
        'msgDoseActionError': 'ERRO: Falha ao registrar a a√ß√£o de {status}.',
        // As chaves abaixo provavelmente j√° existem, mas garanta que estejam l√°:
        'modalSuccessTitle': 'Sucesso',
        'modalErrorTitle': 'Erro',
        'msgConnectionError': 'Erro de conex√£o com o servidor.',

        //Bomba
        'defaultMedName': 'Medicamento',
        'msgInvalidTime': 'Tempo de aplica√ß√£o inv√°lido.',
        'msgSaveInfusionError': 'Aviso: Erro de conex√£o ao salvar in√≠cio da infus√£o (o timer funcionar√° localmente).',
        'msgSaveObsError': 'Falha ao salvar a avalia√ß√£o da infus√£o no hist√≥rico.',
        'msgSaveObsNetworkError': 'Erro de conex√£o ao salvar avalia√ß√£o.',
        'optSelectEvaluation': 'Selecione uma avalia√ß√£o...',
        'msgEvalRegistered': 'Avalia√ß√£o registrada: ',
        'msgThankYou': ' ü§© Obrigado!',
        // Op√ß√µes de Avalia√ß√£o
        'evalOptionDelay': '‚è≥üíâ problema: bomba est√° infundindo [atrasada mais de 5 minutos]',
        'evalOptionEarly': '‚è∞ü™´ problema: bomba terminou antes do esperado [medica√ß√£o foi toda aplicada]',
        'evalOptionEarlyLeftover': '‚è∞üîã problema: bomba terminou antes do esperado [e ainda tem medica√ß√£o]',
        'evalOptionPerfect': '‚è±Ô∏èü™´ Perfeito! [tempo e medica√ß√£o conforme o programado]',
        'optSelectProblem': 'Selecione um problema...',
        // Labels dos Problemas
        'probLabelOcclusion': 'Mensagem na tela de oclus√£o no equipo',
        'probLabelAir': 'Mensagem na tela de ar no equipo',
        'probLabelBattery': 'Mensagem na tela de bateria fraca',
        'probLabelKVO': 'KVO ou fim de infus√£o',
        // Passos (Steps)
        'stepSilence': '1- Aperte o bot√£o silenciar na bomba de infus√£o para ter dois minutos de sil√™ncio',
        'stepCheckKink': '2- Verifique se o equipo ou o cateter n√£o est√° dobrado ou clampado',
        'stepCheckFit': '2- Verifique se o equipo est√° bem colocado na bomba de infus√£o',
        'stepCallNurse': '3- Chame a enfermagem',
        'stepCheckPower': '2- Retire e coloque na tomada novamente o cabo de energia da bomba de infus√£o',
        'stepCallNurseIfFail': '3- Se n√£o resolver, chame a enfermagem',
        'stepTurnOffClose': '2- Desligue a bomba de infus√£o e feche o clamp no cateter/equipo',
        'labelMedication': 'Medica√ß√£o',
        'labelVolumeAbbr': 'Vol',
        'labelFlowAbbr': 'Vaz√£o',
        'btnSolveProblem': 'Solucionar um problema?',
        'btnCloseProblem': 'Fechar problema',
        'btnEvaluation': 'Avalia√ß√£o de conclus√£o',
        'btnCloseEvaluation': 'Fechar avalia√ß√£o',
        'btnUnderstood': 'Entendido',
        'msgInfusionWarning': 'Aviso: Prepare-se para silenciar a bomba antes dela tocar para preservar o sono/descanso do paciente.',
        'statusFinished': 'Finalizado',
        'msgInfusionFinished': 'Infus√£o finalizada.',
        'msgInfusionStarted': 'Infus√£o de {med} come√ßou. Pode dar in√≠cio na bomba de infus√£o agora.üìü',
        'msgCalcFillTwo': 'Por favor, preencha pelo menos dois dos tr√™s campos para calcular o terceiro.',
        'msgCalcInvalidTime': 'Valores inv√°lidos para c√°lculo do tempo.',
        'msgCalcVolOrFlow': 'Informe pelo menos volume ou vaz√£o para calcular o outro campo.',
        // 'modalWarningTitle' e 'modalErrorTitle' j√° devem existir de passos anteriores
        'modalErrorTitle': 'Erro',
        'modalSuccessTitle': 'Sucesso',
        'modalWarningTitle': 'Aviso',
        'msgSelectPatient': 'Selecione um paciente.',
        'msgFillMedFields': 'Preencha os campos obrigat√≥rios: Nome do Medicamento, Dosagem e Unidade.',
        'msgMedSavedId': 'Medicamento cadastrado com sucesso! ID: {id}',
        'msgAgendaCreated': 'üìÖ Agenda criada:',
        'msgTasksAdded': '‚úÖ {count} tarefa(s) adicionada(s)',
        'msgTasksExisting': '‚ÑπÔ∏è {count} tarefa(s) j√° existente(s)',
        'msgWarnings': '‚ö†Ô∏è Avisos:',
        'msgAgendaErrorBackend': 'mas houve um problema ao criar a agenda: {error}',
        'msgAgendaErrorNetwork': 'mas n√£o foi poss√≠vel criar a agenda automaticamente.',
        'msgMedSaveFail': 'Falha ao cadastrar medicamento.',
        'msgConnectionError': 'Erro de conex√£o. Tente novamente.',

        //geo
        'locWarningFar': '‚ö†Ô∏è Longe do Local',
        'locDistanceLabel': 'Dist√¢ncia:',
        'shiftEndReasonFar': 'Saiu do per√≠metro',

        //escala
        'shiftLocationTitle': 'Aten√ß√£o √† Localiza√ß√£o',
        'shiftLocationMsg': 'Ol√°! Est√° ao lado do(a) Paciente? Se sim, lembre-se de informar a localiza√ß√£o atual. Ela ficar√° em preto depois de salva.',
        'shiftSuccessTitle': 'Hora do Show',
        'shiftSuccessMsg': '‚úÖ Em suas m√£os est√° Acura: Cuide sempre com carinho, seja no hospital ou em casa! Importante: deixe a tela do app ativa para receber notifica√ß√µes.',
        'modalWarningTitle': 'Aviso',
        'msgShiftStartError': 'N√£o foi poss√≠vel iniciar o turno.',
        'msgConnectionErrorShift': 'Erro de conex√£o ao iniciar o turno.',

        //celebra√ß√£o di√°ria
        'modalCongratsTitle': 'üèÜ Parab√©ns!',
        'msgAllTasksCompleted': 'Voc√™ completou todas as {total} tarefas do dia!\n\nProbabilidade de recupera√ß√£o: {prob}%\n\nContinue esse excelente trabalho! üí™',
        'celMsg1': 'üéâ Parab√©ns! Tarefa conclu√≠da!',
        'celMsg2': '‚≠ê Excelente trabalho!',
        'celMsg3': 'üëè Muito bem! Continue assim!',
        'celMsg4': '‚ú® √ìtimo! Voc√™ est√° cuidando bem!',
        'celMsg5': 'üåü Perfeito! Mais uma tarefa!',
        'celMsg6': 'üí™ Isso a√≠! Voc√™ conseguiu!',

        'defaultPatientName': 'seu paciente',
        'aiWelcomeMsg': 'Ol√°! Sou o Dr. IA, seu assistente m√©dico virtual. üë®‚Äç‚öïÔ∏è\n\nEstou aqui para ajudar com orienta√ß√µes sobre os cuidados de {patientName}.\n\nComo posso te ajudar hoje?',
        'msgNoPatients': 'Nenhum paciente encontrado.',
        'metaCureProb': 'Probabilidade de Cura',
        'metaChronicIndex': '√çndice de Controle-Croniciza√ß√£o',
        'metaBridgeTherapy': 'Performance da Terapia Ponte',
        'metaPalliative': 'Indicador de Conforto Paliativo',

        //TMO
        'tmoTitle': 'Checklist de Limpeza - Quarto TMO',
        'tmoWarningPPE': '‚ö†Ô∏è EPI Obrigat√≥rio: Avental, luvas, m√°scara, touca e prop√©s.',
        'tmoWarningImmuno': '‚ö†Ô∏è Aten√ß√£o: Paciente imunossuprimido. Respeite o tempo de a√ß√£o dos desinfetantes (10 min).',
        'lblProgress': 'Progresso:',
        'btnFinishRegister': 'Finalizar e Registrar',
        // Categorias TMO
        'tmoCatPrep': 'PREPARA√á√ÉO',
        'tmoCatSurface': 'SUPERF√çCIES (Teto e Paredes)',
        'tmoCatLightVent': 'ILUMINA√á√ÉO E VENTILA√á√ÉO',
        'tmoCatFurniture': 'MOBILI√ÅRIO E EQUIPAMENTOS',
        'tmoCatBath': 'BANHEIRO (√Årea Cr√≠tica)',
        'tmoCatFloor': 'PISO (√öltima Etapa)',
        'tmoCatFinal': 'FINALIZA√á√ÉO E VERIFICA√á√ÉO',

        // Itens TMO
        'tmoItemHands': 'Higienizaram as m√£os conforme protocolo',
        'tmoItemPPE': 'Paramentaram-se com EPI completo',
        'tmoItemSupplies': 'Houve disponibilidade de produtos adequados',
        'tmoItemMaterials': 'Prepararam materiais (panos, MOP, √°lcool 70%, desinfetante)',
        'tmoItemTrash': 'Retiraram todo lixo do quarto anterior',
        'tmoItemLinens': 'Removeram roupas de cama e cortinas',
        'tmoItemPaint': 'Paredes e m√≥veis pintados e sem danos',
        'tmoItemCeiling': 'Limparam teto com pano √∫mido e desinfetante',
        'tmoItemWalls': 'Limparam paredes de cima para baixo',
        'tmoItemCobwebs': 'Verificaram aus√™ncia de teias de aranha/poeira',
        'tmoItemLights': 'Limparam lumin√°rias (externa/interna)',
        'tmoItemACGrills': 'Limparam grelhas do ar condicionado',
        'tmoItemHEPACheck': 'Verificaram sistema de press√£o positiva/HEPA',
        'tmoItemSwitches': 'Limparam interruptores com √°lcool 70%',
        'tmoItemWindows': 'Janelas vedadas, com cortinas e bloqueadas',
        'tmoItemServiceLight': 'Ilumina√ß√£o de servi√ßo indireta limpa e funcional',
        'tmoItemBed': 'Leito: colch√£o, grades, manivelas, rod√≠zios',
        'tmoItemBedTable': 'Mesa de cabeceira (todas as superf√≠cies)',
        'tmoItemMealTable': 'Mesa auxiliar e refei√ß√£o',
        'tmoItemChair': 'Cadeira/poltrona e Suporte de soro',
        'tmoItemPumps': 'Bombas de infus√£o e Monitores',
        'tmoItemCables': 'Term√¥metros, cabos (Oximetria/ECG), bra√ßadeira PNI',
        'tmoItemRemote': 'Limparam controle remoto da TV',
        'tmoItemToilet': 'Vaso sanit√°rio (completo com tampa e assento)',
        'tmoItemSink': 'Pia, torneira, cuba e bancada',
        'tmoItemShower': 'Box, paredes do chuveiro e piso',
        'tmoItemBathTrash': 'Lixeira (limpar e trocar saco)',
        'tmoItemDrains': 'Ralos (limpar e desinfetar)',
        'tmoItemSupports': 'Apoios/suportes',
        'tmoItemFilters': 'Trocaram filtros de √°gua (fungos)',
        'tmoItemBathWindows': 'Janelas vedadas e bloqueadas permanentemente',
        'tmoItemSweep': 'Varreram/aspiraram com filtro HEPA',
        'tmoItemMop': 'Passaram MOP √∫mido (T√©cnica 2 baldes)',
        'tmoItemMotion': 'Fizeram movimentos em "S" ou "8"',
        'tmoItemCorners': 'Quinas e rodap√©s arredondados e sem danos',
        'tmoItemOdors': 'Verificaram odores e pontos pretos (sem mofo)',
        'tmoItemRefill': 'Trocaram sacos de lixo e reabastecer insumos',
        'tmoItemCleanLinens': 'Instalaram roupas de cama limpas',
        'tmoItemFinalHEPA': 'Re-verificaram Filtro HEPA e Press√£o',
        'tmoItemDust': 'Aus√™ncia total de poeira vis√≠vel',
        'tmoItemSign': 'Colocaram placa "Quarto Higienizado"',
        'tmoItemDispenser': 'Abasteceram dispensadores (√°lcool/sab√£o)',
        'tmoItemTemp': 'Climatizaram o quarto (21-23¬∫C)',
        'tmoItemFridge': 'Frigobar ajustado (2-5¬∫C)',

        // Itens do Checklist (Sugest√£o para uso no JS)
        'chkSurface': 'Superf√≠cies Altas (Lumin√°rias, Soro)',
        'chkBed': 'Leito e Colch√£o (Fric√ß√£o unidirecional)',
        'chkEqp': 'Equipamentos (Bombas, Monitores)',
        'chkBath': 'Banheiro (Pia, Vaso, Box)',
        'chkFloor': 'Piso (T√©cnica de 2 baldes)',

        //atualiza√ß√£o
        'updateTitle': 'Nova vers√£o dispon√≠vel! üöÄ',
        'updateMsgDefault': 'Novas funcionalidades adicionadas.',
        'btnUpdateNow': 'Atualizar Agora',
        'btnUpdateLater': 'Depois',

        //cateter
        'catTitle': 'Gest√£o de Acessos Venosos (Cateter)',
        'tabCatActive': 'Cateteres Ativos',
        'tabCatAdd': 'Adicionar Novo',
        'loading': 'Carregando...',
        'catSecDevice': 'Dados do Dispositivo',
        'catLabelType': 'Tipo de Cateter',
        'optCVCJug': 'CVC Jugular',
        'optCVCSub': 'CVC Subcl√°via',
        'optCVCFem': 'CVC Femoral',
        'catLabelManuf': 'Fabricante',
        'catLabelSite': 'Local de Acesso',
        'optArmR': 'Bra√ßo Direito',
        'optArmL': 'Bra√ßo Esquerdo',
        'optJugR': 'Jugular Direita',
        'optJugL': 'Jugular Esquerda',
        'optSubR': 'Subcl√°via Direita',
        'optSubL': 'Subcl√°via Esquerda',
        'optFemR': 'Femoral Direita',
        'optFemL': 'Femoral Esquerda',
        'optThorax': 'Regi√£o tor√°xica',
        'catLabelLumens': 'L√∫mens',
        'catLabelGauge': 'Calibre (Fr)',
        'catLabelLen': 'Comp. (cm)',
        'catSecInsert': 'Dados da Inser√ß√£o',
        'catLabelDate': 'Data Inser√ß√£o',
        'catLabelMethod': 'M√©todo',
        'optUltrasound': 'Ultrassom',
        'optDissection': 'Dissec√ß√£o',
        'optFluoro': 'Fluroscopia',
        'catLabelXray': 'Confirma√ß√£o RX',
        'optRxYes': 'Sim - Adequado',
        'optRxReposition': 'Sim - Reposicionar',
        'optRxNo': 'N√£o Realizado',
        'catLabelIssues': 'Intercorr√™ncias',
        'phOptional': 'Opcional',
        'catSecMaint': 'Protocolo de Manuten√ß√£o',
        'catLabelFlush': 'Freq. Flush (dias)',
        'catLabelDressing': 'Freq. Curativo (dias)',
        'btnSaveCat': 'Salvar Cateter',
        'chkTitle': 'Checklist de Manuten√ß√£o',
        'chkHands': 'Higieniza√ß√£o das m√£os',
        'chkPPE': 'Uso de EPI (Luvas Est√©reis/M√°scara)',
        'chkSite': 'Inspe√ß√£o do S√≠tio (Sem sinais flog√≠sticos)',
        'chkFlush': 'Flush realizado com t√©cnica ass√©ptica',
        'chkConnector': 'Clave/Conector trocado e etiquetado',
        'chkReflux': 'Todos os l√∫mens refluindo com sucesso',
        'chkDressing': 'Troca de Curativo realizada',
        'phAdditionalObs': 'Observa√ß√µes adicionais...',
        'btnConfirmMaint': 'Confirmar Realiza√ß√£o',

        //pix
        'pixTitle': 'Pagamento via PIX',
        'pixDesc': 'Escaneie o QR Code ou use a op√ß√£o "Copia e Cola" no seu banco.',
        'pixLabelCopy': 'Pix Copia e Cola:',
        'btnCopyTooltip': 'Copiar',
        'btnPixPaid': 'J√° realizei o pagamento',
        // 'closeButton' j√° existe
        // Mensagem de sucesso ao copiar (usar no JS):
        'msgPixCopied': 'C√≥digo Pix copiado!',
        'pixCopyTitle': 'Pronto',
        'msgPixCopied': 'C√≥digo Pix copiado!',

        //cancelar plano
        'cancelPlanTitle': 'Cancelar Plano Premium?',
        'cancelPlanDesc': 'Ao cancelar, voc√™ perder√° acesso aos recursos exclusivos ao fim do ciclo atual.',
        'btnConfirmCancelPlan': 'Sim, cancelar assinatura',
        'btnKeepPlan': 'Manter meu Premium',

        //legacy
        'legTitle': 'Da Rotina ao Legado',
        'legSubtitle': 'Sua dedica√ß√£o conta uma hist√≥ria.',
        'legBody': 'Sabemos que o dia a dia √© desafiador. Mas cada registro que voc√™ faz aqui ‚Äî cada medicamento, cada observa√ß√£o ‚Äî est√° construindo a <b>Jornada Vital</b> do paciente.',
        'legAiTitle': '‚ú® Futuro com IA',
        'legAiBody': 'No final do tratamento, nossa Intelig√™ncia Artificial poder√° compilar todos esses dados para gerar um <b>Livro Digital</b> ou um <b>V√≠deo de Mem√≥rias</b>, celebrando a for√ßa e a supera√ß√£o de voc√™s.',
        'legQuote': '"Continue registrando. Voc√™ est√° escrevendo uma hist√≥ria de amor e cuidado."',
        'btnContinueLeg': 'Entendi, vou continuar registrando!',

        //cadastro de profissionais
        'profTitle': 'Cadastro de Profissional de Sa√∫de',
        'profLabelName': 'Nome Completo',
        'profLabelEducation': 'Forma√ß√£o',
        'optSelect': 'Selecione',
        'optDoctor': 'M√©dico',
        'optNurse': 'Enfermeiro',
        'optTechNurse': 'T√©cnico de Enfermagem',
        'optAuxNurse': 'Auxiliar de Enfermagem',
        'profLabelPronoun': 'Pronome de Tratamento',
        'optSelectPrefix': 'Selecione (Dr/a, Enf/a...)',
        'profLabelCouncil': 'Conselho',
        'profLabelCouncilNum': 'N¬∫ do Conselho',
        'phCouncilNum': 'Ex: 12345/SP',
        'optCouncil': 'Conselho',
        'profLabelEmail': 'E-mail',
        'profLabelPhone': 'Telefone c/ DDD',
        'profLabelIsCaregiver': 'Este profissional ser√° Cuidador do Paciente?',
        'profDescIsCaregiver': 'Se marcado, o profissional cadastrado ter√° acesso √† tela de sele√ß√£o de pacientes, alertas e equipe de apoio a decis√£o.',
        'btnSaveProf': 'Salvar Profissional',

        //abandonar paciente
        'abandonTitlePrefix': 'Abandonar cuidados de',
        'abandonWarnTitle': 'Ao confirmar:',
        'abandonWarn1': 'Voc√™ perder√° o acesso a este perfil.',
        'abandonWarn2': 'Os dados financeiros e de sa√∫de <b>N√ÉO ser√£o apagados</b>.',
        'abandonWarn3': 'Outros cuidadores vinculados continuar√£o com acesso.',
        'abandonWarn4': 'Voc√™ poder√° retornar pesquisando pelo C√≥digo do Paciente.',
        'btnConfirmAbandon': 'Sim, abandonar',
        // 'cancelButton' j√° existe

        // Financeiro & Direitos
        'finTitle': 'Controle Financeiro & Apoio',
        'tabExpense': '‚ûï Nova Despesa',
        'tabRights': 'üí° Dicas e Direitos',
        'finPendingAlert': 'Pend√™ncias encontradas (Clique para preencher):',
        'finLabelDesc': 'Descri√ß√£o',
        'finPhDesc': 'Ex: Medicamento X...',
        'finLabelCategory': 'Categoria',
        'optLoading': 'Carregando...',
        'finPackDetails': 'üì¶ Detalhes da Embalagem',
        'finLabelType': 'Tipo',
        'optBottle': 'Frasco (L√≠quido)',
        'optPot': 'Pote (Creme/P√≥)',
        'optBox': 'Caixa (Comprimidos)',
        'optAmpoule': 'Ampola/Injet√°vel',
        'finLabelQty': 'Qtd. Itens',
        'finPhQty': 'Ex: 2',
        'finLabelContent': 'Conte√∫do por item',
        'finPhContent': 'Ex: 350',
        'finLabelUnit': 'Unidade',
        'finLabelValue': 'Valor (R$)',
        'finLabelDate': 'Data',
        'finLabelRecurring': 'Esta √© uma despesa mensal recorrente',
        'btnSaveExpense': 'Salvar Despesa',
        'tipsTitle': 'Jornada de Direitos',
        'tipsSubtitle': 'Marque o que voc√™ j√° conquistou ou encaminhou.',
        'tipsCountInitial': '0 de 0 itens conclu√≠dos',
        'tipsLoading': 'Carregando checklist...',
        'tipsFooter': 'D√∫vidas complexas? Converse com o Dr. IA ou use o chat de cuidadores.',

        //recuperar senha
        'forgotTitle': 'Recuperar Acesso',
        'forgotDesc': 'Informe seu e-mail para receber as instru√ß√µes.',
        'phYourEmail': 'seu@email.com',
        'btnSendLink': 'Enviar Link',
        'modalErrorTitle': 'Falha',
        'modalResultTitle': 'Resultado',
        'msgEnterEmail': 'Digite o e-mail.',
        'btnSending': 'Enviando...',
        'msgConnectionError': 'Erro de conex√£o.',
        'RESET_LINK_SENT': 'Se o e-mail estiver cadastrado, voc√™ receber√° as instru√ß√µes em instantes.',
        'INVALID_EMAIL_FORMAT': 'O formato do e-mail √© inv√°lido.',
        'SERVER_ERROR': 'Ocorreu um erro interno. Tente novamente mais tarde.',
        'resetPassTitle': 'Nova Senha',
        'resetPassDesc': 'Crie uma nova senha segura.',
        'phNewPass': 'Nova senha (m√≠n. 6 d√≠gitos)',
        'btnChangePass': 'Alterar Senha',
        // Prov√°veis valida√ß√µes JS:
        'msgPassShort': 'A senha deve ter pelo menos 6 caracteres.',
        'msgPassChanged': 'Senha alterada com sucesso! Fa√ßa login.',

        //Relax
        // Est√°ticos
        'breathTitle': 'Pausa para Respirar',
        'breathDesc': 'Escute seu corpo. Sinta seus batimentos.<br>Siga o ritmo visual para acalmar sua mente.',
        'btnFinishBreath': 'Finalizar e Voltar',

        // Din√¢micos (Anima√ß√£o)
        'breathInstrPrep': 'PREPARE-SE',
        'breathSubPrep': 'Esvazie os pulm√µes...',
        'breathInstrIn': 'INSPIRE',
        'breathSubIn': 'Encha os pulm√µes de ar...',
        'breathInstrHold': 'SEGURE',
        'breathSubHold': 'Mantenha o ar...',
        'breathInstrOut': 'EXPIRE',
        'breathSubOut': 'Solte devagar...',
        'msgBreathCelebration': 'Voc√™ tirou um tempo para si. Parab√©ns!',

        //winback
        'winbackTitle': 'N√£o silencie o sino agora...',
        'winbackDesc': 'O tratamento √© uma maratona, n√£o uma corrida de 100 metros. Seus registros de hoje podem salvar o dia de amanh√£.',
        'winbackOffer': 'Que tal mais 7 dias gr√°tis para pensar?',
        'btnAcceptWinback': 'Aceitar +7 Dias Gr√°tis',
        'btnConfirmCancel': 'Eu entendo, quero cancelar',

        // Premium Modal
        'premTitle': 'Jornada de Supera√ß√£o',
        'premSubtitle': 'Voc√™ n√£o precisa carregar o mundo sozinho. N√≥s ajudamos a organizar o cuidado para que voc√™ foque no amor.',
        'premFeat1Title': 'Decis√µes Seguras',
        'premFeat1Desc': 'Apoio jur√≠dico e m√©dico da comunidade.',
        'premFeat2Title': 'Hist√≥rico Vital',
        'premFeat2Desc': 'Gr√°ficos de evolu√ß√£o para m√©dicos.',
        'premFeat3Title': 'C√≠rculo de Apoio',
        'premFeat3Desc': 'Convide familiares ilimitados.',
        'premTestimonial': '"Este app me deu for√ßas quando eu achei que n√£o tinha mais."',
        'premTestimonialAuthor': '- Maria, cuidadora h√° 2 anos',
        'premBadgeTrial': 'Teste Gr√°tis Dispon√≠vel',
        'premTrialTitle': 'Experimente 14 Dias Sem Custo',
        'premTrialDesc': 'Cancele a qualquer momento. O sino da esperan√ßa s√≥ toca se voc√™ quiser.',
        'planMonthlyTitle': 'Mensal Flex√≠vel',
        'planMonthlySub': 'Cobrado mensalmente',
        'planAnnualTitle': 'Anual - Melhor Valor',
        'planAnnualSub': '/m√™s (Cobrado anualmente)',
        'planAnnualSave': 'ECONOMIZE 40%',
        'planAnnualBonus': '+2 Meses de B√¥nus',
        'payMethodSafe': 'M√©todo Seguro (Cobran√ßa ap√≥s 14 dias)',
        'payBtnCard': 'Cart√£o de Cr√©dito',
        'payBtnPix': 'Pix',
        'lblCardNumber': 'N√∫mero do cart√£o',
        'lblExpiry': 'Validade',
        'lblCVV': 'CVV',
        'lblCardName': 'Nome no cart√£o',
        'phCardName': 'Como impresso no cart√£o',
        'lblCardEmail': 'E-mail do titular',
        'lblDocNumber': 'CPF do titular',
        'btnPayCard': 'Pagar com cart√£o',
        'pixInst1': 'Ao confirmar, geraremos um c√≥digo exclusivo.',
        'pixBonus': 'üéÅ +5 dias de b√¥nus inclu√≠dos!',
        'btnGenCode': 'Gerar C√≥digo',
        'pixGenerating': 'Gerando QR Code seguro...',
        'pixScan': 'Escaneie ou Copie',
        'pixApproved': 'O pagamento √© aprovado instantaneamente.',
        'btnStartTrial': 'Come√ßar 14 Dias Gr√°tis',
        'lblSecure': 'üõí Seguro',
        'premDisclaimer': 'Ao continuar, voc√™ concorda com os Termos. Renova√ß√£o autom√°tica. Cancele online a qualquer momento.',

        // --- GERAL / NAVEGA√á√ÉO / BOT√ïES ---
        'btnSkipTut': 'Pular Tutorial',
        'btnNext': 'Pr√≥ximo',
        'btnBack': 'Voltar',
        'btnFinish': 'Concluir', // Para o √∫ltimo passo (injetar via JS)
        'appTitle': 'Vencer Cuidando',
        'closeButton': 'Fechar',
        'backButton': 'Voltar',
        'saveButton': 'Salvar',
        'cancelButton': 'Cancelar',
        'loading': 'Carregando...',
        'okButton': 'OK',
        'confirmationTitle': 'Confirma√ß√£o',
        'updateNeeded': 'Atualiza√ß√£o necess√°ria',
        'checkInternet': 'Verifique a conex√£o com a internet.',
        'observationTitle': 'üìù Observa√ß√£o',
        'deleteAccountConfirmTitle': 'Excluir Conta Permanentemente',
        'attentionLabel': 'Aten√ß√£o:',
        'deleteWarning1': 'Ao deletar a conta, todos os seus dados e registros de pacientes ser√£o perdidos permanentemente.',
        'deleteWarning2': 'Esta a√ß√£o n√£o poder√° ser desfeita.',
        'deleteWarning3': 'A Acura n√£o mais poder√° acompanhar o seu progresso e do(a) paciente com qualquer um dos servi√ßos de suporte.',
        'deleteAccountConfirmBtn': 'Confirmar Exclus√£o',
        'btnConfirm': 'Confirmar',
        'aiChatTitle': 'Dr. Intelig√™ncia Artificial',
        'aiChatInputPlaceholder': 'Digite sua mensagem...',
        'caregiverChatTitle': 'Chat de Cuidadores',
        'labelViewConv': 'Visualizar Conversas:',
        'optChatPatientOnly': 'Somente Paciente Selecionado',
        'optChatNearby': 'Cuidadores Pr√≥ximos (Raio de 1 km)',
        'labelPatient': 'Paciente',
        'phMessageGeneric': 'Digite sua mensagem...',
        'ocrTitle': 'Leitura de Documento via C√¢mera',
        'ocrDataFound': 'Dados Encontrados:',
        'btnSnap': 'Tirar Foto',
        'btnRetry': 'Tentar Novamente',
        'btnUseData': 'Usar Dados',
        // Status din√¢micos (Use no JS)
        'ocrStatusProcessing': 'Processando imagem, aguarde...',
        'ocrStatusSuccess': 'Leitura conclu√≠da!',
        'ocrStatusError': 'N√£o foi poss√≠vel ler os dados. Tente novamente.',
        'ocrStatusNoText': 'Nenhum texto detectado.',

        //Peso e unidades:
        'titlePhysicalMeasurements': 'Registro de Medidas F√≠sicas',
        'labelWeight': 'Peso',
        'labelHeight': 'Altura',
        'labelAbdCircumference': 'Circunfer√™ncia Abdominal',
        'labelNotes': 'Observa√ß√µes:',
        'phMeasurementNotes': 'Anota√ß√µes relevantes sobre as medidas...',
        // Unidades para exibi√ß√£o din√¢mica (se necess√°rio via JS)
        'unitKg': 'kg',
        'unitLbs': 'lbs',
        'unitM': 'm',
        'unitFt': 'ft', // p√©s
        'unitCm': 'cm',
        'unitIn': 'in', // polegadas
        'msgUnitsChanged': 'Unidades de medida alteradas para:',
        'system_metric': 'M√©trico (kg/m)',
        'system_imperial': 'Imperial (lbs/ft)',
        'titleChangeAvatar': 'Mudar Avatar',
        'descSelectImage': 'Selecione uma imagem do seu dispositivo.',
        'btnUpload': 'Carregar',
                

        // --- TELA DE LOGIN ---
        'loginPrompt': 'Entre com Google ou use e-mail e senha.',
        'orSeparator': 'ou',
        'emailLabel': 'E-mail',
        'phEmail': 'seu@email.com', // Placeholder
        'passwordLabel': 'Senha',
        'phPassword': 'Senha', // Placeholder
        'loginButton': 'Entrar',
        'registerButton': 'Criar conta',
        'forgotPassword': 'Esqueceu a senha?',
        'refreshScreen': 'Atualizar tela',

        // --- PERFIL DO CUIDADOR ---
        'caregiverProfileTitle': 'Perfil do Cuidador',
        'caregiverProfileDesc': 'Coloque um apelido que ser√° exibido aos outros cuidadores.',
        'caregiverNicknameLabel': 'Apelido',
        'phNickCaregiver': 'Ex: Jo√£o (pai)', // Placeholder
        'caregiverRoleLabel': 'Voc√™ √©:',
        'phRole': 'O que voc√™ √© do paciente', // Placeholder Select
        'saveCaregiverButton': 'Salvar e continuar',

        // --- SELE√á√ÉO DE PACIENTE ---
        'patientsTitle': 'Pacientes',
        'selectPatientDesc': 'Selecione um paciente existente ou crie um novo.',
        'createPatientTitle': 'Criar paciente',
        'patientNicknameLabel': 'Apelido do paciente',
        'phNickPatient': 'Ex: Maria', // Placeholder
        'patientDobLabel': 'Data de nascimento',
        'patientIllnessLabel': 'Doen√ßa / Condi√ß√£o',
        'phDisease': 'Ex: Leucemia', // Placeholder
        'phWeight': 'Peso (kg)', // Placeholder
        'phHeight': 'Altura (m)', // Placeholder
        'patientGenderLabel': 'G√™nero',
        'genderFemale': 'Feminino', 'genderMale': 'Masculino',
        'patientAllergiesLabel': 'Alergias',
        'phAllergies': 'Alergias (se houver)', // Placeholder
        'savePatientButton': 'Cadastrar paciente',
        'logoutButton': 'Deslogar',
        'enterCodeTitle': 'Entrar com c√≥digo do paciente',
        'phCode': 'C√≥digo / ID do paciente', // Placeholder        
        'careBtn': 'Cuidar',
        'dashboardBtn': 'Painel', // ou Dashboard
        'noDiagnosis': 'Sem diagn√≥stico',

        // --- DASHBOARD (ABAS) ---
        'dashboardTabNutrition': 'Nutrologia',
        'dashboardTabPharmacy': 'Farm√°cia',
        'dashboardTabExams': 'Exames/Labs',
        'dashboardTabProcedures': 'Procedimentos',
        'dashboardTabFinance': 'Financeiro',
        'dashboardTabAchievements': 'Conquistas Di√°rias',
        'filterTimeframeLabel': 'Filtrar por:',
        'timeframe6h': '√öltimas 6 Horas', 'timeframe12h': '√öltimas 12 Horas', 'timeframeDay': 'Dia', 'timeframeWeek': 'Semana',
        'labelCaregiver': 'Cuidador:', 

        // --- M√ìDULO NUTRI√á√ÉO ---
        'nutritionTitle': 'Nutri√ß√£o e Hidrata√ß√£o',
        'nutritionalBalanceTitle': 'üçé Balan√ßo Nutricional (Entrada/Sa√≠da S√≥lida)',
        'physicalEvolutionTitle': 'Porte F√≠sico e Evolu√ß√£o',
        'weightImcTitle': 'Evolu√ß√£o do Peso e IMC',
        'lastWeight': '√öltimo Peso', 'lastImc': '√öltimo IMC',
        'abdominalCircTitle': 'Circunfer√™ncia Abdominal',
        'lastCirc': '√öltima Circ.', 'alertState': 'Alerta',
        'fluidBalanceTitle': 'Balan√ßo H√≠drico do Per√≠odo',
        'fluidIntake': 'Ingest√£o Total (mL)', 'fluidOutput': 'Elimina√ß√£o Total (mL)', 'fluidFinal': 'Balan√ßo Final (mL)',
        'fluidInsensibleLoss': 'Perda Insens√≠vel Estimada',
        'fluidDetailsTitle': 'Entradas e Sa√≠das Detalhadas',
        'tableHeaderDate': 'Data', 'tableHeaderType': 'Tipo', 'tableHeaderVolume': 'Volume (mL)',
        
        // Frases fragmentadas para Balan√ßo H√≠drico
        'textBasedOn': '(Baseado em ',
        'textDaysWith': ' dias, sendo ',
        'textFeverDays': ' dias com febre).',

        // Dicas de Nutri√ß√£o (Fragmentadas)
        'tip1Label': 'üí° Dica 1:',
        'tip1Body': 'Os dados exibidos s√£o baseados nos registros manuais. Continue registrando as ingest√µes de l√≠quidos e refei√ß√µes usando os bot√µes da tela principal.',
        'tip2Label': 'üí° Dica 2:',
        'tip2Body': 'Alimentos que se liquefazem (exemplo: sorvete, gelatina) anote como l√≠quido (em ml).',
        'tip3Label': 'üí° Dica 3:',
        'tip3Body': 'Elimina√ß√µes Intestinais (Fezes) l√≠quidas s√£o estimadas e anotadas em mL. Quando pesada a fralda, considerar 1g = 1ml. No campo de anota√ß√£o, descreva diarreia ou fezes l√≠quidas.',
        'tip4Label': 'üí° Dica 4:',
        'tip4Body': 'Para maiores informa√ß√µes, consulte um(a) enfermeiro(a).',

        // --- M√ìDULO EXAMES / PROCEDIMENTOS ---
        'labResultsTitle': 'Resultados de Exames Laboratoriais',
        'labResultsDesc': 'Aqui ser√£o exibidos os √∫ltimos resultados cr√≠ticos e a evolu√ß√£o hist√≥rica.',
        'proceduresTitle': 'Timeline de Procedimentos e Consultas',
        'phSearchFilter': 'Digite para buscar...',
        // T√≠tulos
        'diaryTitle_food': 'Registro de Alimenta√ß√£o',
        'diaryTitle_drinks': 'Registro de Bebidas',
        'diaryTitle_pain': 'Registro de Dor/Satisfa√ß√£o',
        'diaryTitle_sleep': 'Sono',
        'diaryTitle_physio': 'Sess√£o de Fisioterapia',
        'diaryTitle_excretion': 'Registro de Excre√ß√£o',
        'diaryTitle_vitals': 'Sinais Vitais (Manual)',
        'diaryTitle_lab': 'Exame Laboratorial',
        // Termos m√©dicos
        'titleImproveDiag': 'üß¨ Aprimorar Diagn√≥stico',
        'labelQuickSearch': 'Busca R√°pida:',
        'phDiseaseFilter': 'Digite para filtrar (ex: C√¢ncer)...',
        'labelDiseaseType': 'Tipo da Doen√ßa:',
        'grpMain': 'Principais',
        'grpFullList': 'Lista Completa (A-Z)',
        'labelSubtype': 'Subtipo / Muta√ß√£o (Opcional):',
        'phSubtype': 'Ex: Ph+, HER2, KRAS...',
        'btnSaveDiag': 'Salvar Diagn√≥stico',

        // Doen√ßas
        'disLLA': 'Leucemia Linfoide Aguda (LLA)',
        'disLMA': 'Leucemia Miel√≥ide Aguda (LMA)',
        'disLMC': 'Leucemia Miel√≥ide Cr√¥nica (LMC)',
        'disHodgkin': 'Linfoma de Hodgkin',
        'disNonHodgkin': 'Linfoma N√£o-Hodgkin',
        'disMyeloma': 'Mieloma M√∫ltiplo',
        'disBreast': 'C√¢ncer de Mama',
        'disProstate': 'C√¢ncer de Pr√≥stata',
        'disLung': 'C√¢ncer de Pulm√£o',
        'disAnal': 'Anal',
        'disBladder': 'Bexiga',
        'disMouth': 'Boca',
        'disHeadNeck': 'Cabe√ßa e Pesco√ßo',
        'disCervical': 'Colo do √ötero',
        'disColorectal': 'Colorretal (Intestino)',
        'disUterine': 'Corpo do √ötero',
        'disEsophagus': 'Es√¥fago',
        'disStomach': 'Est√¥mago',
        'disLiver': 'F√≠gado',
        'disGIST': 'GIST (Tumor Estromal Gastrointestinal)',
        'disLarynx': 'Laringe',
        'disNET': 'NET (Neuroend√≥crinos)',
        'disOvarian': 'Ov√°rio',
        'disPancreas': 'P√¢ncreas',
        'disSkinMelanoma': 'Pele - Melanoma',
        'disSkinNonMelanoma': 'Pele - N√£o Melanoma',
        'disPenis': 'P√™nis',
        'disKidney': 'Rim',
        'disSarcoma': 'Sarcomas',
        'disCNS': 'Sistema Nervoso Central',
        'disTesticular': 'Test√≠culo',
        'disThyroid': 'Tireoide',
        'disVagina': 'Vagina',
        'disGallbladder': 'Ves√≠cula Biliar',
        'disVulva': 'Vulva',
        'disOther': 'Outro',

        // R√≥tulos (Labels)
        'labelFoodQty': 'Quantidade de Comida',
        'labelVolDose': 'Volume/Dose',
        'labelPainLevel': 'N√≠vel de Dor | Mal Estar (1-10)',
        'labelSatisfaction': 'Satisfa√ß√£o c/ Servi√ßos (1-10)',
        'labelDuration': 'Dura√ß√£o',
        'labelSessionDuration': 'Dura√ß√£o da Sess√£o',
        'labelLiquidExcretion': 'Urina|V√¥mito|Diarreia (L√≠quido)',
        'labelSolidExcretion': 'Fezes (S√≥lido)',
        'labelHeartRate': 'Frequ√™ncia Card√≠aca (FC)',
        'labelRespRate': 'Frequ√™ncia Respirat√≥ria (FR)',
        'labelExamType': 'Tipo de Exame',
        'labelResultMain': 'Resultado Principal',
        'ocrTitle_monitor': 'Leitura de Sinais Vitais (Monitor UTI)',
        'ocrTitle_blood': 'Leitura de Exame Laboratorial',

        // Unidades
        'unitG': 'g (gramas)',
        'unitMl': 'ml (mililitros)',
        'unitScale': 'Escala',
        'unitHours': 'h (horas)',
        'unitMin': 'min (minutos)',
        'unitBpm': 'bpm',
        'unitRpm': 'rpm',
        'unitExam': 'Exame',
        'unitGdl': 'g/dL',
        'unitMgdl': 'mg/dL',
        'unitUil': 'UI/L',
        
        // --- M√ìDULO FINANCEIRO ---
        'financeTotalMonth': 'Total Gasto no M√™s',
        'financeHistory': 'Hist√≥rico de Lan√ßamentos',
        'financeCaregiverContrib': 'Contribui√ß√£o por Cuidador',
        'financeShiftLog': 'Registro de Escala (Horas)',
        'msgNoChartData': 'N√£o h√° dados suficientes para gerar o gr√°fico.',
        'tableHeaderDesc': 'Descri√ß√£o', 'tableHeaderValue': 'Valor',
        'tableHeaderCaregiver': 'Cuidador', 'tableHeaderIn': 'Entrada', 'tableHeaderOut': 'Sa√≠da', 'tableHeaderDuration': 'Dura√ß√£o',

        // --- MENU DO CUIDADOR (AVATAR) ---
        'myWellness': 'Meu Bem-Estar',
        'dailyProgress': 'Progresso Di√°rio',
        'wellnessTip': 'Complete 4 refei√ß√µes e 1 per√≠odo de sono para manter seu bem-estar em 100%',
        'actionRecordMeal': 'Registrar Refei√ß√£o',
        'actionRecordSleep': 'Registrar Sono',
        'actionCalmDown': 'Acalmar-se',
        'subTextCalmDown': 'Al√≠vio de ansiedade (4-7-8)',
        'actionFinanceControl': 'Controle Financeiro',
        'subTextFinance': 'Registro de gastos e benef√≠cios',
        'actionTutorial': 'Como usar o App',
        'subTextTutorial': 'Rever o tutorial interativo',
        'textPending': 'Pendente',
        'textProgressToday': '0/4 hoje', // Exemplo gen√©rico, se for din√¢mico deve ser tratado via JS

        // --- MENU ACURA (LOGOMARCA) ---
        'termsConditions': 'Termos & Condi√ß√µes',
        'privacyPolicy': 'Pol√≠tica de Privacidade',
        'contactUs': 'Fale Conosco',
        'manageSubscription': 'Gerenciar Assinatura',
        'abandonPatient': 'Abandonar Paciente',
        'deleteAccount': 'Deletar Minha Conta',
        'deleteAccountConfirmTitle': 'Excluir Conta Permanentemente',
        'deleteAccountConfirmBtn': 'Confirmar Exclus√£o',

        // --- TELA PRINCIPAL (GAME/A√á√ïES) ---
        'locationLabel': 'Onde Paciente Est√°',
        'locationResidence': 'Resid√™ncia',
        'locationHospital': 'Hospital',
        'taskProgress': 'Progresso',
        'survivalProb': 'Probabilidad', // Typo original corrigido para Probabilidade se for PT, mantido se for intencional
        'survivalProbLabel': 'Probabilidade',
        'newAppointmentBtn': 'Novo Agendamento',
        'todayAgenda': 'Agenda de Hoje',
        'btnMedications': 'Medica√ß√µes',
        'btnIntravenous': 'Intravenosa',
        'btnAdvice': 'Conselho',
        'titleManageCatheter': 'Gerenciar Acesso/Cateter',
        'btnExitScene': 'Sair de cena',

        // --- TIMELINE / AGENDAMENTO ---
        'btnAddPro': '+ Cadastrar Profissional de Sa√∫de',
        'phLocationGeneric': 'Ex: Consult√≥rio 1 - T√©rreo',
        'phDoctorName': 'Nome do M√©dico/Enfermeiro',
        'phPhone': '(00) 0000-0000',
        'labelFasting': 'Jejum (em horas):',
        'optFasting0': '0 (N√£o necess√°rio)',
        'optFasting4': '4 horas',
        'optFasting6': '6 horas',
        'optFasting8': '8 horas',
        'optFasting12': '12 horas',
        'labelPaidBy': 'Pago por:',
        'optPaySelect': 'Selecione o tipo de pagamento',
        'btnCreateAppt': 'Criar Agendamento',
        'titleCreateAppt': 'Criar Novo Agendamento',
        'labelApptType': 'Tipo de Agendamento:',
        'optTypeConsultation': 'Consulta',
        'optTypeExam': 'Exame',
        'optTypeProcedure': 'Procedimento',
        'labelDateTime': 'Data/Hora',
        'labelLocation': 'Local:',
        'labelHealthPro': 'Profissional de Sa√∫de:',
        'labelPhone': 'Telefone:',
        'labelInstructions': 'Instru√ß√µes de Preparo:',
        'selectFastingPlaceholder': 'Selecione o tempo de jejum',

        // --- MODAL MEDICAMENTOS ---
        'newMedTitle': 'Cadastrar Nova Medica√ß√£o',
        'phSearchMed': 'Digite para buscar...',
        'titleCamRx': 'Ler receita via C√¢mera',
        'medNameLabel': 'Nome do Medicamento',
        'medRouteLabel': 'Via de Administra√ß√£o',
        'routeOral': 'Oral (Pela boca)', 'routeNaso': 'Nasof√°gica', 'routeIV': 'Intravenosa (IV)',
        'medDosageLabel': 'Dosagem', 'medUnitLabel': 'Unidade',
        'phDosageUnit': 'mg, ml, gotas',
        'medDilutionLabel': 'L√≠quido de Dilui√ß√£o',
        'medDilutionVolLabel': 'Volume da Dilui√ß√£o',
        'medFlowLabel': 'Vaz√£o Programada da Bomba (ml/h)',
        'medIntervalLabel': 'Tomar de', 'hoursUnit': 'horas',
        'medStartLabel': 'Data e Hora da Primeira Dose',
        'medDoctorLabel': 'Nome do(a) M√©dico(a) Prescritor(a)',
        'medSuspensionLabel': 'Data Prevista para Suspens√£o',
        'medPayerLabel': 'Pago por',
        'payerPublic': 'P√∫blico', 'payerInsurance': 'Plano', 'payerPrivate': 'Particular',
        'medStatusLabel': 'Status da Receita',
        'statusActive': 'Ativa', 'statusSuspended': 'Suspensa',
        'savePrescriptionBtn': 'Salvar Prescri√ß√£o',
        'labelVia': 'Via',
        'labelDilution': 'Dilui√ß√£o',
        'labelFlow': 'Vaz√£o',
        'btnIgnore': 'Ignorar',
        'btnStart': 'Iniciar',

        // --- MODAL CALCULADORA INFUS√ÉO ---
        'calcVolume': 'Volume total (mL)',
        'phVol': 'Ex: 500',
        'calcFlow': 'Vaz√£o (mL/h)',
        'phFlow': 'Ex: 100',
        'calcTime': 'Tempo de aplica√ß√£o',
        'phTimeH': 'Horas', 'phTimeM': 'Minutos', 'phTimeS': 'Segundos',
        'tipInfusionCalc': 'Dica: Use 2 dados para c√°lculo do 3¬∫',
        'btnCalculate': 'Calcular',
        'btnStartInfusion': 'Iniciar a infus√£o',
        'btnRestart': 'Reiniciar',
        'tipInfusionCalc': 'Dica: Use 2 dados para c√°lculo do 3¬∫',
        'phVol': 'Ex: 500',
        'phFlow': 'Ex: 100',
        'phTimeH': 'Horas',
        'phTimeM': 'Minutos',
        'phTimeS': 'Segundos',
        'btnRestart': 'Reiniciar',

        // --- MODAL IGNORAR DOSE ---
        'ignoreActionTitle': 'Confirma√ß√£o de A√ß√£o',
        'textIgnoreMsg': 'Voc√™ est√° ignorando a dose prevista.',
        'ignoreOnceBtn': 'Ignorar S√ì AGORA',
        'subTextIgnoreOnce': 'N√£o afeta as doses futuras.',
        'suspendRxBtn': 'Suspender Uso',
        'subTextSuspendRx': 'Cancela esta e todas as doses futuras.',
        'phIgnoreReason': 'Opcional: Descreva o motivo...',
        'textIgnoreMsgPart1': 'Voc√™ est√° ignorando a dose de ',
        'textIgnoreMsgPart2': 'prevista para ',
        'ignoreOnceBtn': 'Ignorar S√ì AGORA',
        'subTextIgnoreOnce': 'N√£o afeta as doses futuras.',
        'suspendRxBtn': 'Suspender Uso',
        'subTextSuspendRx': 'Cancela esta e todas as doses futuras.',
        'phIgnoreReason': 'Opcional: Descreva o motivo...',
        

        // --- MODAL LOCALIZA√á√ÉO ---
        'locHospitalName': 'Nome do Local',
        'phLocHome': 'Casa de Paciente',
        'phLocSector': 'Ex: UTI 2',
        'phLocFloor': 'Ex: 5¬∫',
        'phLocBed': 'Ex: 21B',
        'locSector': 'Setor', 'locFloor': 'Andar', 'locBed': 'Leito / Quarto',
        'locAdmissionDate': 'Data de Interna√ß√£o',
        'labelTimeOnLoc': 'Tempo no Local:',
        'unitDays': 'dias',
        'locCleaningFreq': 'Frequ√™ncia de Limpeza Terminal (dias)',
        'statusGPS': 'GPS aguardando...',
        'btnSaveLocation': 'Salvar Localiza√ß√£o',
        'tipCleaningChecklist': 'Define o alerta para o checklist de TMO.',

        // --- HUB DE CUIDADO / CHAT ---
        'hubDiary': 'Di√°rio',
        'hubLegacyAI': 'Legado IA',
        'labelDrAI': 'Dr. Intelig√™ncia Artificial',
        'labelChatCare': 'Chat de Cuidadores',
        'labelViewChat': 'Visualizar Conversas:',
        'optChatPatient': 'Somente Paciente Selecionado',
        'optChatNear': 'Cuidadores Pr√≥ximos (Raio de 1 km)',
        'phChatMsg': 'Digite sua mensagem...',
        'hubWriteStory': 'Registre inseguran√ßas, sustos, conquistas...',
        'btnReadStories': 'Ler Hist√≥rias',
        'tooltipStories': 'Transforme o di√°rio em um livro ou filme no futuro!',
        'statusLoadingStories': 'Carregando hist√≥rias...',
        'checkVisibleTeam': 'Vis√≠vel para a equipe',
        'hubPublish': 'Publicar',
        'hubEmergency': 'Pronto Atendimento | UTI',
        'hubDecisions': 'Enquete para Decis√£o',
        'hubNewDecision': 'Nova Decis√£o',
        'msgNoDecisions': 'Sem decis√µes pendentes.',
        'btnSendInvite': 'Enviar Convite',
        'hubAddMember': '+ Membro',
        'hubEndJourney': 'Fim da Jornada',
        'widgetSurvivorTitle': 'Trof√©u Overall [Vit√≥ria]',
        'widgetSurvivorCalc': 'Calculando tempo para a vit√≥ria...',
        'btnBackToCare': 'Voltar a cuidar',
        'hubHeaderStatus': 'Hub de Atendimento,  Decis√£o e Evolu√ß√£o',
        'btnSyncWearables': 'Sincronizar Wearables',
        'btnTransfusionRBC': 'Transfus√£o de Hem√°cias',
        'btnTransfusionPlatelets': 'Transfus√£o de Plaquetas',
        'btnTransfusionGranulo': 'Transfus√£o de Granul√≥citos',
        'btnMedAntipyretic': 'Medica√ß√£o Antit√©rmico',
        'btnGasOxygen': 'G√°s Oxig√™nio',
        'statusLoadingHistory': 'Carregando hist√≥rico...',
        'msgNoActiveDecisions': 'Nenhuma ativa',
        'labelDecisionTitle': 'T√≠tulo da Decis√£o:',
        'phDecisionTitle': 'Ex: Troca de Hospital',
        'labelDeadline': 'Data Limite (Prazo):',
        'labelDetails': 'Detalhes:',
        'phDecisionDetails': 'Detalhes, termo de consentimento, etc.',
        'labelVoteOptions': 'Op√ß√µes de Voto:',
        'phOption1': 'Op√ß√£o 1 (Descreva, cite vantagens/desvantagens)',
        'phOption2': 'Op√ß√£o 2 (Descreva, cite vantagens/desvantagens)',
        'phCaregiverEmail': 'E-mail do cuidador',
        
        //---BLE
        'bleTitle': 'Conectar Sensores',
        'btnScanBle': 'Escanear Dispositivo',
        'statusWaitingConnection': 'Aguardando conex√£o...',
        'labelHR': 'HR', // Ou 'Frequ√™ncia' se preferir
        'labelTemp': 'TEMP',
        'labelSpO2': 'SpO2',
        'labelBP': 'PA', // Press√£o Arterial
        'bleErrorTitle': 'ERRO CR√çTICO: API Bluetooth n√£o detectada.',
        'bleErrorHttps': '‚ö†Ô∏è O site n√£o est√° em contexto seguro (HTTPS).',
        'bleErrorCausesTitle': '‚ö†Ô∏è Poss√≠veis causas:',
        'bleErrorCause1': '1. WebView desatualizado.',
        'bleErrorCause2': '2. Aplica√ß√£o em modo debug sem Chrome System WebView atualizado.',
        'bleErrorCause3': '3. Bluetooth desativado no dispositivo.',

        // --- CONFIGURA√á√ïES E OUTROS ---
        'settingsTitle': 'Configura√ß√µes',
        'tabSystem': 'Sistema',
        'tabCaregiver': 'Cuidador',
        'tabPatient': 'Paciente',
        'fontSizeLabel': 'Tamanho das Letras',
        'languageLabel': 'Idioma do App',
        'alarmLabel': 'Toque de Alarme',
        'alarmNone': 'Nenhum',
        'alarmSynth': 'Sino',
        'alarmBeepShort': 'Beep Curto',
        'alarmDigitalLong': 'Alarme Digital',
        'alarmMediumBell': 'Campainha M√©dia',
        'alarmPhoneRing': 'Toque de Telefone',
        'unitsLabel': 'Unidades de Medida',
        'unitsMetric': 'Sistema Internacional (m, ¬∞C)',
        'unitsImperial': 'Sistema Imperial (ft, ¬∞F)',
        'dataCollectionLabel': 'Coleta de dados (Temp/Umid.)',
        'themeLabel': 'Modo de Exibi√ß√£o',
        'themeAuto': 'Autom√°tico',
        'themeLight': 'Claro',
        'themeDark': 'Escuro',
        'changeAvatarBtn': 'Mudar Avatar',
        'improveDiagnosisBtn': 'Aprimorar Diagn√≥stico',
        'phCard': '0000 0000 0000 0000',
        'titleCopyCode': 'Copiar C√≥digo',
        'settingsTitle': 'Configura√ß√µes',
        'tabSystem': 'Sistema',
        'tabCaregiver': 'Cuidador',
        'tabPatient': 'Paciente',
        'fontSizeLabel': 'Tamanho das Letras',
        'languageLabel': 'Idioma do App',
        'langPt': 'Portugu√™s',
        'langEn': 'Ingl√™s',
        'langEs': 'Espanhol',
        'alarmLabel': 'Toque de Alarme',
        'alarmNote': 'Nenhum',
        'alarmSynth': 'Sino',
        'alarmBeepShort': 'Beep Curto',
        'alarmDigitalLong': 'Alarme Digital',
        'alarmMediumBell': 'Campainha M√©dia',
        'unitsLabel': 'Unidades de Medida',
        'unitsMetric': 'Sistema Internacional (m, ¬∞C)',
        'unitsImperial': 'Sistema Imperial (ft, ¬∞F)',
        'dataCollectionLabel': 'Coleta de dados (Temp/Umid.)',
        'themeLabel': 'Modo de Exibi√ß√£o',
        'themeAuto': 'Autom√°tico',
        'themeLight': 'Claro',
        'themeDark': 'Escuro',
        'btnSaveSystem': 'Salvar Configura√ß√µes do Sistema',
        'changeAvatarBtn': 'Mudar Avatar',
        'labelNickname': 'Apelido',
        'phNickname': 'Seu apelido',
        'labelRelation': 'Rela√ß√£o com o Paciente',
        'btnSaveCaregiver': 'Salvar Perfil do Cuidador',
        'patientNicknameLabel': 'Apelido do Paciente',
        'phPatientNickname': 'Apelido do paciente',
        'msgNicknameLocal': 'Apelido √© apenas para exibi√ß√£o local.',
        'patientIllnessLabel': 'Doen√ßa / Condi√ß√£o',
        'phIllness': 'Ex: Leucemia',
        'improveDiagnosisBtn': 'Aprimorar Diagn√≥stico',
        'patientAllergiesLabel': 'Alergias',
        'phAllergies': 'Lista de alergias',
        'btnSavePatient': 'Salvar Perfil do Paciente',

        //--Exames
        'diaryTitle': 'Registrar A√ß√£o',
        'labelExamType': 'Tipo de Exame:',
        'optSelect': 'Selecione...',
        'examHemogram': 'Hemograma',
        'examHepatic': 'Bioqu√≠mica Hep√°tica',
        'examRenal': 'Bioqu√≠mica Renal',
        'examElectrolytes': 'Eletr√≥litos',
        'examLipid': 'Perfil Lip√≠dico',
        'examGlycemia': 'Glicemia/Metabolismo',
        'examCoagulation': 'Coagula√ß√£o',
        'examTumorMarkers': 'Marcadores Tumorais',
        'examProteins': 'Prote√≠nas/Imunoglobulinas',
        'examHormones': 'Horm√¥nios',
        'examUrine1': 'Urina tipo I (EAS)',
        'examUrine24h': 'Urina 24 horas',
        'examStool': 'Fezes',
        'examVirology': 'Virol√≥gicos',
        'examCulture': 'Cultura',
        'examCSF': 'L√≠quor (LCR)',
        'examAscitic': 'L√≠quido Asc√≠tico',
        'examPleural': 'L√≠quido Pleural',
        'examImmunology': 'Imunol√≥gicos',
        'examGasometry': 'Gasometria',
        'examGeneticsNGS': 'Gen√©tica NGS*',
        'examCytogenetics': 'Citogen√©tica e Moleculares*',
        'labelExamParameter': 'Par√¢metro do Exame:',
        'phExamParameter': 'Ex: Plaquetas, Hem√°cias, Linf√≥citos',
        'labelUnit': 'Unidade de Medida:',
        'labelRefMin': 'Refer√™ncia (m√≠nimo):',
        'labelRefMax': 'Refer√™ncia (m√°ximo):',
        'labelExamResult': 'Resultado do Exame:',
        'optNotDetected': 'N√£o detectado/Negativo',
        'optDetected': 'Detectado/Positivo',
        'labelValue1': 'Valor 1:',
        'labelValue2': 'Valor 2:',
        'labelSpO2': 'Oximetria (SpO2):',
        'phSpO2': 'Ex: 98',
        'labelBP': 'Press√£o Arterial (PA):',
        'phSystolic': 'Sist√≥lica',
        'phDiastolic': 'Diast√≥lica',
        'labelTemp': 'Temperatura:',
        'phTemp': 'Ex: 36.5',
        'labelNotes': 'Anota√ß√µes:',
        'phNotes': 'Relate observa√ß√µes aqui...',
        'btnOCR': 'Ler via C√¢mera',

        // -- Tutorial
        // Tutorial
        'tutIntroTitle': 'Ol√°! üíô',
        'tutIntroDesc': 'Bem-vindo(a) ao seu espa√ßo de apoio. Preparamos um guia r√°pido para te ajudar a usar o Acura App da melhor forma.',
        'tutMenuTitle': 'Menu Acura',
        'tutMenuDesc': 'Toque na logomarca para acessar termos legais e suporte.',
        'tutSettingsTitle': 'Configura√ß√µes',
        'tutSettingsDesc': 'Para usar do seu jeito, use as configura√ß√µes dispon√≠veis aqui: troque o seu avatar e do paciente, por exemplo.',
        'tutCaregiverTitle': 'Seu Bem-Estar',
        'tutCaregiverDesc': 'Aqui voc√™ cuida de si mesmo. Registre seu sono, refei√ß√µes e fa√ßa pausas para respirar. Voc√™ √© importante!',
        'tutCallCaregiversTitle': 'Chamar cuidadores',
        'tutCallCaregiversDesc': 'Toque aqui para ativar ou desativar o alarme que chama cuidadores que est√£o de guarda na tela de Pacientes.',
        'tutLocationTitle': 'Localize o(a) paciente',
        'tutLocationDesc': 'Na presen√ßa do(a) paciente, toque aqui para completar dados e ajudar outros cuidadores a localiz√°-lo(a).',
        'tutProgressTitle': 'Seu progresso di√°rio',
        'tutProgressDesc': 'Note o desempenho a cada cuidado dado por essa barra gr√°fica. Complet√°-la ao final do dia √© confirma√ß√£o de cuidar bem.',
        'tutTimelineTitle': 'Linha do tempo',
        'tutTimelineDesc': 'Aqui v√£o aparecer os eventos como exames, procedimentos e consultas agendadas.',
        'tutAddEventTitle': 'Adicione um evento',
        'tutAddEventDesc': 'Um bot√£o importante! Use-o para te lembrar de consultas, exames, procedimentos atrav√©s da linha do tempo.',
        'tutAgendaTitle': 'Compromissos da Agenda',
        'tutAgendaDesc': 'Quando chega a hora, √© aqui que aparecem as medica√ß√µes e compromissos a realizar ao longo do dia.',
        'tutMedsTitle': 'Adicione medica√ß√µes',
        'tutMedsDesc': 'Outro bot√£o importante! Use-o para programar a rotina de administra√ß√£o (dica: oriente-se com a enfermagem se precisar).',
        'tutPatientTitle': 'Paciente',
        'tutPatientDesc': 'Toque aqui para registrar a hist√≥ria, os cuidados de pronto atendimento e obter ajuda para tomar decis√µes importantes.',
        'tutShieldTitle': 'Escudo de prote√ß√£o',
        'tutShieldDesc': 'O c√≠rculo completo √© um indicador de que os cuidados prestados est√£o sendo significativos ao longo da jornada.',
        'tutQuickLogTitle': 'Registro R√°pido',
        'tutQuickLogDesc': 'Os bot√µes circulares servem para registrar facilmente alimentos, bebidas e outros dados. Experimente!',
        'tutCatheterTitle': 'Cateteres ativos',
        'tutCatheterDesc': 'Ao tocar na seta, voc√™ poder√° cadastrar e gerenciar cateteres para mant√™-los funcionais e seguros.',
        'tutDrAITitle': 'Doutor IA',
        'tutDrAIDesc': 'Quando precisar, converse com Doutor Intelig√™ncia Artificial sobre sintomas, d√∫vidas ou dicas.',
        'tutChatHumanTitle': 'Converse com cuidadores',
        'tutChatHumanDesc': 'N√£o existem paredes para quem deseja compartilhar carinho. Incentive outros cuidadores a usarem o Acura.',
        'tutDashboardTitle': 'Controle via Dashboard',
        'tutDashboardDesc': 'Na tela de pacientes, veja relat√≥rios como balan√ßo h√≠drico, exames e doses acumuladas!',
        'msgTutorialComplete': 'Voc√™ est√° pronto! Conte conosco.',
        'tutcurrentTimeTitle': 'Agilidade no atendimento',
        'tutcurrentTimeDesc': 'Al√©m do tempo atual, conhe√ßa a agilidade da equipe de enfermagem a cada final de infus√£o',
        'tutProfessionalPresenceTitle': 'Reconhe√ßa a Enfermagem de Hoje',
        'tutProfessionalPresenceDesc': 'Declare aqui cada enfermeiro que est√° presente hoje, mesmo que ele n√£o use o Acura ainda. Assim ele receber√° reconhecimento futuro pelo bom trabalho.',
        'tutOpenShareTitle': 'Compartilhe Acura Agora',
        'tutOpenShareDesc': 'Convide outros cuidadores e pacientes para Acura! Mas aten√ß√£o: s√≥ envie convite com dados de paciente para amigos e familiares.',

    },
    'en': {

        //boas vindas
        'welcomeTitle': 'Welcome to Acura!',
        'welcomeSubtitle': 'Your care journey starts here. We noticed you don\'t have any patients registered yet.',
        'welcomeHowItWorks': 'How XP Works?',
        'welcomeStep1': 'Register your first patient now.',
        'welcomeStep2': 'The App will guide you through daily tasks.',
        'welcomeStep3': 'Every logged care activity earns you Experience Points (XP) and badges!',
        'btnCreateFirstPatient': 'Create First Patient',

        // alterna hospital casa
        'locModeHospital': 'Hospital / Institution',
        'lblHospitalName': 'Hospital Name:',
        'locModeHome': 'Residence / HomeCare',
        'lblIdentification': 'Identification:',
        'valHomePatient': "Patient's Home",

        //profssionais no turno
        'titleDeleteProf': 'Delete Professional',
        'msgConfirmDeleteProf': 'Are you sure you want to permanently remove this professional from the list?',
        'btnDelete': 'Delete',
        'ppTitle': 'Team Present on Shift',
        'ppActivePros': 'Professionals on Site (Active):',
        "ppInactivePros": "Inactive Professionals (Resting):",
        'ppNoSelection': 'No professional selected.',
        'ppAddLabel': 'Add Professional to Shift:',
        'ppSearchPlaceholder': 'Type the professional name...',
        'ppNotFound': 'Not found?',
        'ppRegisterNew': 'Register new professional',
        'btnFinish': 'Finish',

        //atendimento
        'rsReasonGeneral': 'General',
        'rsNotInformed': 'Not Informed',
        'rsYes': 'Yes',
        'rsNo': 'No',
        'rsNoRecordsFound': 'No records found.',
        'rsLabelResp': 'Resp', // ou 'Time'
        'rsClearHistoryTitle': 'Clear History',
        'rsConfirmClear': 'Are you sure you want to clear the entire service history?',
        'rsBtnClearConfirm': 'Yes, Clear',
        'titleLogAttendance': 'Attendance Log',
        'lblWhoAttended': 'Who provided the assistance?',
        'phWhoAttended': 'Professional or Caregiver Name',
        'lblObservations': 'Observations:',
        'phObservations': 'Ex: Patient attended, medication given early...',
        'btnSaveLog': 'Save Log',
        'reasonManualCall': 'Manual Call (Buzzer)',
        'defaultCaregiverName': 'Current Caregiver',
        'msgAttendanceSaved': 'Attendance logged successfully!',
        'rsReasonGeneral': 'General',
        'rsNotInformed': 'Not Informed',
        'rsYes': 'Yes',
        'rsNo': 'No',
        'rsNoRecordsFound': 'No records found.',
        'rsLabelResp': 'Resp', // ou 'Time'
        'rsConfirmClear': 'Are you sure you want to clear the entire service history?',
        'reportResponseTitle': 'Response & Service Report',
        'thDateTime': 'Date/Time',
        'thReason': 'Reason (Agility)',
        'thProfessional': 'Professional',
        'thCaregiver': 'Caregiver',
        'thLocationCheck': 'Location OK?',
        'thNotes': 'Notes',
        'btnClearHistory': 'Clear History',
        'btnClose': 'Close',

        //modal de compartilhamento
        'promoGamificationTitle': 'Unlock Achievements!',
        'promoGamificationDesc': 'Invite caregivers, strengthen the support network, and earn the Acura Ambassador badge.',
        'msgShareDefault': 'Hello! I am using the Acura app by OncoTrek.org to help with our treatment.',
        'msgErrNoPatientCode': 'Could not locate the patient code. Sharing only the App link.',
        'msgShareWithCode': 'Hello! Access *acura.vc* to follow the patient. The access code is: *{code}*',
        'titleCodeDetected': 'Code Detected!',
        'msgCodeInserted': "Code {code} inserted. Click 'Enter' to access.",
        'btnOk': 'Ok',
        'modalAttentionTitle': 'Attention',
        'shareAccessTitle': 'Share Access',
        'shareAccessDesc': 'How would you like to invite the new caregiver?',
        'btnShareWithData': 'Send with Patient Data',
        'subShareWithData': 'Includes code for immediate access.',
        'btnShareAppLink': 'App Link Only',
        'subShareAppLink': 'To install without linking patient now.',
        'btnCancel': 'Cancel',

        //voz
        'msgWeNeedYou' : 'We call You',
        // "Come here! You have Acura." soa mais natural para um comando de voz em ingl√™s
        'msgSpeakComeAcura': 'Come here! You have Acura.',

        //
        'lblTrend': 'Trend:',
        'statusAdequate': '‚úÖ Adequate',
        'statusConsumeMore': '‚ö†Ô∏è Consume More',
        'titleLiquidConsumption': 'Liquid Consumption (mL)',
        'lblTotal': 'Total:',
        'lblGoal': 'Goal:',
        'lblDaily': '/Day',
        'titleRegisteredMeals': 'Registered Meals',
        'lblMealsInPeriod': 'meals in period',
        'statusStable': 'Stable',
        'goalMealsPerDay': 'Goal: 4-5 meals/day',

        //
        'titleLogEmergency': 'Log Emergency',
        'msgConfirmEmergency': 'Do you want to log "{type}" now?',
        'btnRegister': 'Register',
        'msgEmergencySaved': '‚úÖ Emergency log saved successfully!',
        'titleLocationAccess': 'Location Access',
        'msgLocationRequiredEmergency': 'Please allow location access to log the emergency.',

        // fim do trofeu
        'titleEndOfJourney': 'End of Journey',
        'msgConfirmGrief': 'WARNING: This action will end the care cycle for this patient. Do you really wish to confirm bereavement?',
        'btnConfirmGrief': 'Yes, Confirm Bereavement',
        'msgValidatingLocation': 'Validating location...',
        'detailsJourneyEnded': 'Journey ended.',
        'titleJourneyEnded': 'Journey Ended',
        'msgCondolences': 'My deepest condolences. The app will restart to update data.',
        'msgLocationRequired': 'Location is required to validate the closure.',

        // Trofeu
        'msgDatePending': 'Start date pending',
        'survivorCountdown': '{a}y {d}d {h}h until Supreme Celebration',
        'survivorInfoTitle': 'The Heroic Path',
        'survivorInfoP1': 'The <b>Overall Trophy</b> celebrates the 5-year journey after the initial diagnosis.',
        'survivorInfoP2': 'In medicine, this milestone represents consolidated <b>Cure</b> and overcoming the risk of recurrence.',
        'survivorInfoP3': 'Keep making history and leave no one behind: invite professionals and caregivers to <b>The Cure</b>!',
        'survivorInfoFooter': '<b>{a} years and {d} days</b> of vigilance and love remain.',
        'btnKeepCaring': 'Keep Caring',
        'survivorVictoryBtnLabel': 'VICTORY ACHIEVED! CLICK HERE!',
        'survivorVictoryTitle': 'üéä ABSOLUTE SUPER SURVIVOR üéä',
        'survivorVictorySubtitle': '5 YEARS OF VICTORY!',
        'survivorVictoryQuote': 'Cancer has become just a turned page in your story of bravery.',
        'survivorVictoryListTitle': 'From now on, a new chapter begins:',
        'survivorActionInspireTitle': 'Inspire:',
        'survivorActionInspireDesc': 'Turn your journey into a book or movie to guide those still on the path.',
        'survivorActionGratitudeTitle': 'Gratitude:',
        'survivorActionGratitudeDesc': 'Honor the medical and nursing heroes who fought by your side.',
        'survivorActionMentorshipTitle': 'Mentorship:',
        'survivorActionMentorshipDesc': 'Use the Acura app to provide support and hope to new patients.',
        'survivorVictoryFinalMsg': 'And, above all... Live. Intensely.',
        'btnCelebrateLife': '‚ú® CELEBRATE LIFE ‚ú®',

        // catheter
        'msgNoCatheter': 'No active catheters found.',
        'btnRegisterNew': 'Register New',
        'labelCatheter': 'Catheter',
        'lblInsertedIn': 'Inserted on:',
        'lblManufacturer': 'Manufacturer:',
        'lblGauge': 'Gauge:',
        'statusActive': 'Active',
        'lblNextFlush': 'Next Flush',
        'lblNextDressing': 'Next Dressing',
        'tagToday': '(TODAY)',
        'btnMaintenance': 'Maintenance',
        'btnRemoved': 'Removed',

        //timeline
        'timeToday': ' (today)',
        'timeTomorrow': ' (tomorrow)',
        'timeInDays': ' (in {days} days)',
        'titleAppointmentsFor': 'Appointments for',
        'lblDescription': 'Description:',
        'lblPlace': 'Location:',
        'lblProfessional': 'Professional:',
        'lblPhone': 'Phone:',
        'lblFasting': 'Fasting:',
        'lblHours': 'hours',
        'lblNotNeeded': 'Not needed',
        'lblInstructions': 'Instructions:',
        'lblStatus': 'Status:',
        'btnNotDone': '‚ö†Ô∏è Not Done',
        'btnCancel': '‚ùå Cancel',
        'btnReschedule': 'üìÖ Reschedule',
        'btnDone': '‚úÖ Done',
        'lblNewDate': 'New Date and Time (Reschedule):',
        'btnRequestReschedule': 'Request Reschedule',
        'titleFinishReturn': 'Finish and Schedule Return',
        'lblReturnDate': 'Return Date/Time (Leave empty to finish without return):',
        'lblPayerSource': 'Select return payment source:',
        'optPublic': 'Public',
        'optInsurance': 'Insurance',
        'optPrivate': 'Private',
        'btnConfirmCompletion': 'Confirm Completion',
        'btnCancelText': 'Cancel',

        //notifica√ß√£o
        'alertTitle': 'Caregiver Alert',
        'alertBody': 'Check the patient!',
        'msgAlertTriggered': 'üö® Alert Triggered!',

        //cancela
        'titleFreeMode': 'Free Mode Activated..',
        'msgPlanCanceled': 'Plan successfully canceled.',
        'msgCancelFailed': 'Failed to cancel.',
        'msgConnectionErrorCancel': 'Connection error while trying to cancel.',
        // Existing
        'btnProcessing': 'Processing...',
        'modalErrorTitle': 'Failed',
        'msgUserNotAuth': 'Error: User not identified. Please log in again.',
        'msgErrorPrefix': 'Error: ',

        //fluxo de pagemento
        'msgErrCardFormNotLoaded': 'Error: The payment form did not load correctly. Please reload the page.',
        'modalAttentionTitle': 'Attention',
        'msgFillCardData': 'Please fill in the data to continue.',
        'btnValidatingCard': 'Validating Card...',
        'titleWelcome': 'Welcome!',
        'msgPremiumWelcome': 'üéâ Welcome! Your premium journey has begun.',
        'msgGenericError': 'An error occurred while processing the subscription.',

        //confirma senha
        'msgPassMinLength': 'Password must be at least 6 characters long.',
        'msgPassResetSuccess': 'Success! Use your new password to log in.',
        'modalResultTitle': 'Result',
        // Backend Codes
        'TOKEN_INVALID': 'The recovery token is invalid or expired.',
        'TOKEN_EXPIRED': 'This link has expired. Please request a new one.',
        // Existing
        'btnSaving': 'Saving...',
        'modalSuccessTitle': 'Success',
        'modalErrorTitle': 'Error',
        'msgConnectionError': 'Connection error.',

        //Nova senha
        'msgEnterEmail': 'Please enter your email address.',
        'btnSendLink': 'Send Link',
        // Backend Codes
        'EMAIL_SENT': 'A recovery link has been sent to your email.',
        'USER_NOT_FOUND': 'We could not find an account with this email.',
        'EMAIL_INVALID': 'Invalid email format.',
        // Existing
        'btnSending': 'Sending...',
        'modalSuccessTitle': 'Success',
        'modalErrorTitle': 'Error',
        'msgConnectionError': 'Connection error.',

        //exluir
        'btnProcessing': 'Processing...',
        'titleDone': 'Done',
        'msgAccountDeleted': 'Account deleted. We are sorry to see you go.',
        'msgDeleteErrorPrefix': 'Error deleting account: ',

        //contato
        'btnSending': 'Sending...',
        'modalThankYouTitle': 'Thank You',
        'msgMessageSent': 'Message sent successfully!',
        'msgSendErrorPrefix': 'Error sending: ',
        'msgTryAgain': 'Try again.',
        'contactTitle': 'Contact Us',
        'contactDesc': 'Have a question, suggestion, or found a bug? Send a message to our team.',
        'labelSubject': 'Subject',
        'labelMessage': 'Message',
        'optSelectSubject': 'Select a subject...',
        'optDoubt': 'Question',
        'optPraise': 'Praise',
        'optSuggestion': 'Suggestion',
        'optBug': 'Technical Issue / Bug',
        'optOthers': 'Other Subjects',
        'phMessage': 'Type your message here with as much detail as possible...',
        'btnCancel': 'Cancel',
        'btnSendMessage': 'Send Message',

        //financeiro
        'msgConnectionError': 'Connection error.',

        //abandonar
        'msgNoPatientToAbandon': 'No patient selected to abandon.',
        'defaultPatientName': 'Patient',
        'msgErrPatientIdMissing': 'Error: Patient ID not found in state.',
        'msgErrSessionMissing': 'Error: Caregiver session not found. Please log in again.',
        'titleDone': 'It is done',
        'msgAbandonSuccess': 'You have stopped caring for this patient.',
        'msgErrorPrefix': 'Error: ',

        // intera√ß√µes
        'medIntervalSN': 'PRN',
        'medIntervalPrefix': 'Every',
        'medIntervalSuffix': 'hours', // Ajuste a l√≥gica se necess√°rio (ex: Every 8 hours)
        'medIntervalHours': '',
        'msgNoActiveMeds': 'No active medications registered.',
        'msgNoInactiveMeds': 'No recent inactive meds.',
        'msgNoAlerts': 'No internal alerts.',
        'statusAttention': 'Attention Required',
        'statusExcellent': 'Excellent!',
        'statusRegular': 'Regular',
        'titlePharmacy': 'üíä Pharmacy Management',
        'titleActive': 'Active',
        'tagInUse': 'In use',
        'titleAlerts': 'Pharmaceutical Alerts',
        'btnCheckInteractions': 'Check Interactions (AI)',
        'tooltipNeedMeds': 'Need 2+ medications',
        'titleHistory': 'Recent History',
        'msgHistoryDisclaimer': '"Total consumed divided by bottle capacity indicates actual usage."',
        'titleAdherence': 'Treatment Adherence',
        'lblEfficiency': 'Administered Efficiency',
        'lblDoses': 'doses',
        'msgBasedOn30Days': 'Based on last 30 days.',
        'titleConsolidated': 'üìä Consolidated Consumption',
        'colItem': 'Item',
        'colDoses': 'Doses',
        'colTotal': 'Total',
        'msgLoading': 'Loading...',
        'titleFrequencyChart': 'üìà Frequency Chart',
        'btnAnalyzing': 'Analyzing...',
        'lblAnalysisResult': 'Analysis Result',
        'lblSource': 'Source',
        'msgSelectPatientVerification': 'Select a patient to perform the check.',
        'msgConnectionErrorVerification': 'Connection failed.',
        'msgNoInteractions': 'no interactions', // Ajuste conforme retorno da sua API em EN

        //geo tmo
        'msgMissingLocationName': 'Please enter the Location name.',
        'msgSessionError': 'Session Error: Could not identify user/patient.',
        'btnSave': 'Save',
        'btnSaving': 'Saving...',
        'msgLocationUpdated': '‚úÖ Location updated!',
        'msgServerRefused': '‚ö†Ô∏è Server refused: ',
        'gpsSearching': 'üìç Fetching data...',
        'gpsConfirming': 'üìç Confirming GPS...',
        'gpsUpdated': 'üìç GPS Location Updated',
        'gpsOffline': 'üìç Using last known location (GPS Off)',
        'labelHomePatient': 'Patient Home',
        'tmoStatusNone': 'No cleaning recorded previously.',
        'tmoBtnDoChecklist': 'Perform Terminal Cleaning Checklist',
        'tmoStatusDays': 'Last cleaning: {days} days ago (Target: {freq} days).',
        'tmoBtnExpired': '‚ö†Ô∏è ATTENTION: Cleaning Overdue',
        'tmoBtnOk': 'Cleaning up to date. Perform new?',
        'tagActionRequired': 'Action Required',

        //graficos
        'msgNoHydricData': 'No data found for the period.',
        'typeOralLiquids': 'Oral Fluids',
        'typeIVEtheral': 'IV/Enteral (Medication)',
        'typeExcretion': 'Output (Urine/Vomit/Drain)',
        'typeInsensible': 'Insensible Loss (Est.)',
        'labelSummary': 'Summary',
        'tooltipViewNote': 'Tap to view note',
        'labelViewNote': 'View note',
        'msgNoHydricRecords': 'No intake or output records found for the period.',
        'msgNoMealData': 'No meal or solid excretion data found in the period.',
        'labelIntakeG': 'Intake (g)',
        'labelOutputG': 'Output (Stool, g)',
        'labelDay': 'Day',
        'labelMassG': 'Mass (g)',
        'msgNoData': 'No data',
        'statusEvaluation': 'Under Evaluation',
        'statusHighRisk': '‚ö†Ô∏è High Risk!',
        'statusAdequate': '‚úÖ Adequate',
        'labelWeight': 'Weight (kg)',
        'labelBMI': 'BMI',
        'labelAbdominalCirc': 'Abdominal Circ. (cm)',
        'labelHighRiskLimit': 'High Risk Limit',
        'labelCirc': 'Circ. (cm)',

        'msgNoPatientSelected': 'No patient selected',
        'msgUserNotAuth': 'User not authenticated.',
        'msgNicknameRequired': 'Caregiver nickname is required.',
        'msgSavingSettings': 'Saving settings...',
        'msgSettingsSaved': '‚úÖ Settings saved and applied!',
        'msgSettingsSaveFail': 'Failed to save settings.',
        'msgNoFileSelected': 'No file selected.',
        'msgSavingAvatar': 'Saving new avatar...',
        'msgAvatarUpdated': '‚úÖ Avatar updated successfully!',
        'msgAvatarUploadFail': 'Failed to upload avatar.',

        // agenda
        'msgSyncData': 'Synchronizing clinical data...',
        'tmoRequiredTitle': 'Terminal Cleaning Required',
        'tmoLastCleaning': 'Last cleaning <b>{days} days ago</b>. (Goal: every {freq} days).',
        'tmoChecklistBtn': 'Checklist',
        'catIssueFlush': 'Flush/Saline (Due today or overdue)',
        'catIssueDressing': 'Dressing Change (Due today or overdue)',
        'catMaintTitle': 'Maintenance: ',
        'msgAppointmentsToday': '<b>Attention:</b> There are <span class="font-bold">{count}</span> appointment(s) today!',
        'msgAllClear': '‚ú® All clear! No pending tasks at the moment.',

        //medicacoes
        'msgMedTakenSuccess': 'Medication {med} taken successfully. üíä',
        'lblInfusion': 'Infusion',
        'lblAgendaId': 'Schedule ID',
        'msgTimeCalcAuto': 'Time calculated automatically',
        'msgDoseNeglected': '‚ùå Medication ignored or suspended. -10% chance.',
        'msgAllMedsTaken': 'All medications are up to date!',
        'optNone': 'None',
        'payerPublic': 'Public',
        'statusActive': 'Active',
        'msgDoseSuspendedObs': 'Dose suspended and registered with observation.',
        'msgDoseRegisteredObs': 'Dose registered with observation.',
        'msgDoseActionError': 'ERROR: Failed to register action for {status}.',
        'modalSuccessTitle': 'Success',
        'modalErrorTitle': 'Error',
        'msgConnectionError': 'Connection error with the server.',

        //bomba
        'defaultMedName': 'Medication',
        'msgInvalidTime': 'Invalid application time.',
        'msgSaveInfusionError': 'Warning: Connection error saving infusion start (timer will run locally).',
        'msgSaveObsError': 'Failed to save infusion assessment to history.',
        'msgSaveObsNetworkError': 'Connection error while saving assessment.',
        'optSelectEvaluation': 'Select an evaluation...',
        'msgEvalRegistered': 'Evaluation registered: ',
        'msgThankYou': ' ü§© Thank you!',
        // Evaluation Options
        'evalOptionDelay': '‚è≥üíâ issue: pump is infusing [delayed more than 5 minutes]',
        'evalOptionEarly': '‚è∞ü™´ issue: pump finished early [medication fully administered]',
        'evalOptionEarlyLeftover': '‚è∞üîã issue: pump finished early [medication still remaining]',
        'evalOptionPerfect': '‚è±Ô∏èü™´ Perfect! [time and medication as programmed]',
        'optSelectProblem': 'Select a problem...',
        // Problem Labels
        'probLabelOcclusion': 'Screen message: Occlusion in line',
        'probLabelAir': 'Screen message: Air in line',
        'probLabelBattery': 'Screen message: Low battery',
        'probLabelKVO': 'KVO or Infusion Complete',
        // Steps
        'stepSilence': '1- Press silence button on the infusion pump for 2 minutes of silence',
        'stepCheckKink': '2- Check if tubing or catheter is kinked or clamped',
        'stepCheckFit': '2- Verify if the tubing is properly seated in the pump',
        'stepCallNurse': '3- Call the nurse',
        'stepCheckPower': '2- Unplug and replug the pump power cord',
        'stepCallNurseIfFail': '3- If not resolved, call the nurse',
        'stepTurnOffClose': '2- Turn off the pump and close the clamp on the catheter/line',
        'labelMedication': 'Medication',
        'labelVolumeAbbr': 'Vol',
        'labelFlowAbbr': 'Flow',
        'btnSolveProblem': 'Solve a problem?',
        'btnCloseProblem': 'Close problem',
        'btnEvaluation': 'Completion Assessment',
        'btnCloseEvaluation': 'Close assessment',
        'btnUnderstood': 'Understood',
        'msgInfusionWarning': 'Warning: Prepare to silence the pump before it alarms to preserve patient sleep/rest.',
        'statusFinished': 'Finished',
        'msgInfusionFinished': 'Infusion finished.',
        'msgInfusionStarted': 'Infusion of {med} started. You can start the infusion pump now.üìü',
        'msgCalcFillTwo': 'Please fill in at least two of the three fields to calculate the third.',
        'msgCalcInvalidTime': 'Invalid values for time calculation.',
        'msgCalcVolOrFlow': 'Enter at least volume or flow rate to calculate the other field.',
        'modalErrorTitle': 'Error',
        'modalSuccessTitle': 'Success',
        'modalWarningTitle': 'Warning',
        'msgSelectPatient': 'Please select a patient.',
        'msgFillMedFields': 'Please fill required fields: Medication Name, Dosage, and Unit.',
        'msgMedSavedId': 'Medication registered successfully! ID: {id}',
        'msgAgendaCreated': 'üìÖ Schedule created:',
        'msgTasksAdded': '‚úÖ {count} task(s) added',
        'msgTasksExisting': '‚ÑπÔ∏è {count} task(s) already exist',
        'msgWarnings': '‚ö†Ô∏è Warnings:',
        'msgAgendaErrorBackend': 'but there was a problem creating the schedule: {error}',
        'msgAgendaErrorNetwork': 'but the schedule could not be created automatically.',
        'msgMedSaveFail': 'Failed to register medication.',
        'msgConnectionError': 'Connection error. Please try again.',

        //geo
        'locWarningFar': '‚ö†Ô∏è Far from Location',
        'locDistanceLabel': 'Distance:',
        'shiftEndReasonFar': 'Left perimeter',

        //escala
        'shiftLocationTitle': 'Location Alert',
        'shiftLocationMsg': 'Hello! Are you beside the patient? If so, please remember to set the current location. It will turn black once saved.',
        'shiftSuccessTitle': 'Showtime',
        'shiftSuccessMsg': '‚úÖ Acura is in your hands: Care with love, whether at the hospital or home! Important: keep the app screen active to receive notifications.',
        'modalWarningTitle': 'Warning',
        'msgShiftStartError': 'Could not start shift.',
        'msgConnectionErrorShift': 'Connection error while starting shift.',

        //celebra√ß√£o di√°ria
        'modalCongratsTitle': 'üèÜ Congratulations!',
        'msgAllTasksCompleted': 'You completed all {total} tasks today!\n\nRecovery probability: {prob}%\n\nKeep up the excellent work! üí™',
        'celMsg1': 'üéâ Congratulations! Task completed!',
        'celMsg2': '‚≠ê Excellent work!',
        'celMsg3': 'üëè Well done! Keep it up!',
        'celMsg4': '‚ú® Great! You are caring well!',
        'celMsg5': 'üåü Perfect! Another task done!',
        'celMsg6': 'üí™ You got this! Great job!',

        'defaultPatientName': 'your patient',
        'aiWelcomeMsg': 'Hello! I am Dr. AI, your virtual medical assistant. üë®‚Äç‚öïÔ∏è\n\nI am here to help with guidance regarding the care of {patientName}.\n\nHow can I help you today?',
        'msgNoPatients': 'No patients found.',
        'metaCureProb': 'Cure Probability',
        'metaChronicIndex': 'Control-Chronicity Index',
        'metaBridgeTherapy': 'Bridge Therapy Performance',
        'metaPalliative': 'Palliative Comfort Indicator',

        //TMO
        'tmoTitle': 'Cleaning Checklist - BMT Room',
        'tmoWarningPPE': '‚ö†Ô∏è Mandatory PPE: Gown, gloves, mask, cap, and shoe covers.',
        'tmoWarningImmuno': '‚ö†Ô∏è Attention: Immunosuppressed patient. Respect disinfectant contact time (10 min).',
        'lblProgress': 'Progress:',
        'btnFinishRegister': 'Finish and Register',
        // Categories
        'tmoCatPrep': 'PREPARATION',
        'tmoCatSurface': 'SURFACES (Ceiling & Walls)',
        'tmoCatLightVent': 'LIGHTING & VENTILATION',
        'tmoCatFurniture': 'FURNITURE & EQUIPMENT',
        'tmoCatBath': 'BATHROOM (Critical Area)',
        'tmoCatFloor': 'FLOOR (Last Step)',
        'tmoCatFinal': 'FINALIZATION & VERIFICATION',

        // Items
        'tmoItemHands': 'Hand hygiene performed per protocol',
        'tmoItemPPE': 'Full PPE donned',
        'tmoItemSupplies': 'Availability of appropriate cleaning products',
        'tmoItemMaterials': 'Materials prepared (cloths, MOP, 70% alcohol, disinfectant)',
        'tmoItemTrash': 'Removed all trash from previous patient',
        'tmoItemLinens': 'Removed bed linens and curtains',
        'tmoItemPaint': 'Walls/furniture painted and undamaged',
        'tmoItemCeiling': 'Ceiling cleaned with damp cloth and disinfectant',
        'tmoItemWalls': 'Walls cleaned from top to bottom',
        'tmoItemCobwebs': 'Checked for cobwebs/dust',
        'tmoItemLights': 'Light fixtures cleaned (external/internal)',
        'tmoItemACGrills': 'AC vents/grills cleaned',
        'tmoItemHEPACheck': 'Positive pressure/HEPA system checked',
        'tmoItemSwitches': 'Switches cleaned with 70% alcohol',
        'tmoItemWindows': 'Windows sealed, curtained, and permanently blocked',
        'tmoItemServiceLight': 'Indirect service lighting clean and functional',
        'tmoItemBed': 'Bed: mattress, rails, cranks, casters',
        'tmoItemBedTable': 'Bedside table (all surfaces)',
        'tmoItemMealTable': 'Auxiliary and meal table',
        'tmoItemChair': 'Chair/armchair and IV pole',
        'tmoItemPumps': 'Infusion pumps and Monitors',
        'tmoItemCables': 'Thermometers, cables (SpO2/ECG), NIBP cuff',
        'tmoItemRemote': 'TV remote control cleaned',
        'tmoItemToilet': 'Toilet (complete with lid and seat)',
        'tmoItemSink': 'Sink, faucet, basin, and counter',
        'tmoItemShower': 'Shower stall, walls, and floor',
        'tmoItemBathTrash': 'Trash can (cleaned and liner replaced)',
        'tmoItemDrains': 'Drains (cleaned and disinfected)',
        'tmoItemSupports': 'Grab bars/supports',
        'tmoItemFilters': 'Water filters changed (fungi protection)',
        'tmoItemBathWindows': 'Windows sealed and permanently blocked',
        'tmoItemSweep': 'Swept/vacuumed with HEPA filter',
        'tmoItemMop': 'Wet MOP used (Two-bucket technique)',
        'tmoItemMotion': 'Movements in "S" or "8" pattern',
        'tmoItemCorners': 'Corners/baseboards rounded and undamaged',
        'tmoItemOdors': 'Checked for odors and black spots (no mold)',
        'tmoItemRefill': 'Trash bags replaced and supplies restocked',
        'tmoItemCleanLinens': 'Clean bed linens installed',
        'tmoItemFinalHEPA': 'Re-checked HEPA Filter and Pressure',
        'tmoItemDust': 'Total absence of visible dust',
        'tmoItemSign': 'Placed "Sanitized Room" sign',
        'tmoItemDispenser': 'Dispensers refilled (alcohol/soap)',
        'tmoItemTemp': 'Room climate set (21-23¬∫C)',
        'tmoItemFridge': 'Fridge adjusted (2-5¬∫C)',

        // Checklist Items
        'chkSurface': 'High Surfaces (Lights, IV Poles)',
        'chkBed': 'Bed and Mattress (Unidirectional friction)',
        'chkEqp': 'Equipment (Pumps, Monitors)',
        'chkBath': 'Bathroom (Sink, Toilet, Shower)',
        'chkFloor': 'Floor (Two-bucket technique)',

        //atualiza√ß√£o
        'updateTitle': 'New version available! üöÄ',
        'updateMsgDefault': 'New features added.',
        'btnUpdateNow': 'Update Now',
        'btnUpdateLater': 'Later',

        //cateter
        'catTitle': 'Venous Access Management (Catheter)',
        'tabCatActive': 'Active Catheters',
        'tabCatAdd': 'Add New',
        'loading': 'Loading...',
        'catSecDevice': 'Device Data',
        'catLabelType': 'Catheter Type',
        'optCVCJug': 'CVC Jugular',
        'optCVCSub': 'CVC Subclavian',
        'optCVCFem': 'CVC Femoral',
        'catLabelManuf': 'Manufacturer',
        'catLabelSite': 'Access Site',
        'optArmR': 'Right Arm',
        'optArmL': 'Left Arm',
        'optJugR': 'Right Jugular',
        'optJugL': 'Left Jugular',
        'optSubR': 'Right Subclavian',
        'optSubL': 'Left Subclavian',
        'optFemR': 'Right Femoral',
        'optFemL': 'Left Femoral',
        'optThorax': 'Thoracic Region',
        'catLabelLumens': 'Lumens',
        'catLabelGauge': 'Size (Fr)',
        'catLabelLen': 'Length (cm)',
        'catSecInsert': 'Insertion Data',
        'catLabelDate': 'Insertion Date',
        'catLabelMethod': 'Method',
        'optUltrasound': 'Ultrasound',
        'optDissection': 'Dissection/Cutdown',
        'optFluoro': 'Fluoroscopy',
        'catLabelXray': 'X-Ray Confirmation',
        'optRxYes': 'Yes - Adequate',
        'optRxReposition': 'Yes - Reposition',
        'optRxNo': 'Not Done',
        'catLabelIssues': 'Complications',
        'phOptional': 'Optional',
        'catSecMaint': 'Maintenance Protocol',
        'catLabelFlush': 'Flush Freq. (days)',
        'catLabelDressing': 'Dressing Freq. (days)',
        'btnSaveCat': 'Save Catheter',
        'chkTitle': 'Maintenance Checklist',
        'chkHands': 'Hand hygiene',
        'chkPPE': 'PPE Use (Sterile Gloves/Mask)',
        'chkSite': 'Site Inspection (No signs of inflammation)',
        'chkFlush': 'Flush performed with aseptic technique',
        'chkConnector': 'Connector changed and labeled on each lumen',
        'chkReflux': 'All lumens showing blood return (patent)',
        'chkDressing': 'Dressing change performed',
        'phAdditionalObs': 'Additional observations...',
        'btnConfirmMaint': 'Confirm Completion',

        // pix
        'pixTitle': 'Payment via PIX',
        'pixDesc': 'Scan the QR Code or use the "Copy and Paste" option in your bank app.',
        'pixLabelCopy': 'PIX Copy and Paste:',
        'btnCopyTooltip': 'Copy',
        'btnPixPaid': 'I have made the payment',
        // 'closeButton' exists
        'msgPixCopied': 'PIX code copied!',
        'pixCopyTitle': 'Done',
        'msgPixCopied': 'PIX code copied!',

        // cancelar plano
        'cancelPlanTitle': 'Cancel Premium Plan?',
        'cancelPlanDesc': 'By canceling, you will lose access to exclusive features at the end of the current cycle.',
        'btnConfirmCancelPlan': 'Yes, cancel subscription',
        'btnKeepPlan': 'Keep my Premium',

        // Legado
        'legTitle': 'From Routine to Legacy',
        'legSubtitle': 'Your dedication tells a story.',
        'legBody': 'We know daily life is challenging. But every record you make here ‚Äî every medication, every note ‚Äî is building the patient\'s <b>Vital Journey</b>.',
        'legAiTitle': '‚ú® Future with AI',
        'legAiBody': 'At the end of treatment, our Artificial Intelligence can compile all this data to generate a <b>Digital Book</b> or a <b>Memory Video</b>, celebrating your strength and overcoming.',
        'legQuote': '"Keep recording. You are writing a story of love and care."',
        'btnContinueLeg': 'Understood, I\'ll keep recording!',

        //cadastro de profissionais
        'profTitle': 'Healthcare Professional Registration',
        'profLabelName': 'Full Name',
        'profLabelEducation': 'Education / Role',
        'optSelect': 'Select',
        'optDoctor': 'Doctor (MD)',
        'optNurse': 'Nurse',
        'optTechNurse': 'Nursing Technician',
        'optAuxNurse': 'Nursing Assistant',
        'profLabelPronoun': 'Title',
        'optSelectPrefix': 'Select (Dr, Nurse...)',
        'profLabelCouncil': 'Council/Board',
        'profLabelCouncilNum': 'License Number',
        'phCouncilNum': 'Ex: 12345/NY',
        'optCouncil': 'Council',
        'profLabelEmail': 'Email',
        'profLabelPhone': 'Phone Number',
        'profLabelIsCaregiver': 'Is this professional a Patient Caregiver?',
        'profDescIsCaregiver': 'If checked, the professional will have access to patient selection, alerts, and decision support.',
        'btnSaveProf': 'Save Professional',

        //Abandonar paciente
        'abandonTitlePrefix': 'Stop caring for',
        'abandonWarnTitle': 'By confirming:',
        'abandonWarn1': 'You will lose access to this profile.',
        'abandonWarn2': 'Financial and health data will NOT be deleted.',
        'abandonWarn3': 'Other linked caregivers will retain access.',
        'abandonWarn4': 'You can rejoin by searching for the Patient Code.',
        'btnConfirmAbandon': 'Yes, leave',
        // 'cancelButton' exists

        // Finance & Rights
        'finTitle': 'Financial Control & Support',
        'tabExpense': '‚ûï New Expense',
        'tabRights': 'üí° Tips & Rights',
        'finPendingAlert': 'Pending items found (Click to fill):',
        'finLabelDesc': 'Description',
        'finPhDesc': 'Ex: Medication X...',
        'finLabelCategory': 'Category',
        'optLoading': 'Loading...',
        'finPackDetails': 'üì¶ Package Details',
        'finLabelType': 'Type',
        'optBottle': 'Bottle (Liquid)',
        'optPot': 'Pot (Cream/Powder)',
        'optBox': 'Box (Pills)',
        'optAmpoule': 'Ampoule/Injectable',
        'finLabelQty': 'Qty. Items',
        'finPhQty': 'Ex: 2',
        'finLabelContent': 'Content per item',
        'finPhContent': 'Ex: 350',
        'finLabelUnit': 'Unit',
        'finLabelValue': 'Value ($)',
        'finLabelDate': 'Date',
        'finLabelRecurring': 'This is a recurring monthly expense',
        'btnSaveExpense': 'Save Expense',
        'tipsTitle': 'Rights Journey',
        'tipsSubtitle': 'Mark what you have achieved or initiated.',
        'tipsCountInitial': '0 of 0 items completed',
        'tipsLoading': 'Loading checklist...',
        'tipsFooter': 'Complex questions? Chat with Dr. AI or use the caregiver chat.',

        // Recuperar senha
        'forgotTitle': 'Recover Access',
        'forgotDesc': 'Enter your email to receive instructions.',
        'phYourEmail': 'you@email.com',
        'btnSendLink': 'Send Link',
        'modalErrorTitle': 'Error',
        'modalResultTitle': 'Result',
        'msgEnterEmail': 'Please enter your email.',
        'btnSending': 'Sending...',
        'msgConnectionError': 'Connection error.',
        'RESET_LINK_SENT': 'If the email is registered, you will receive instructions shortly.',
        'INVALID_EMAIL_FORMAT': 'Invalid email format.',
        'SERVER_ERROR': 'An internal server error occurred. Please try again later.',
        'resetPassTitle': 'New Password',
        'resetPassDesc': 'Create a secure new password.',
        'phNewPass': 'New password (min. 6 digits)',
        'btnChangePass': 'Change Password',
        // Validations:
        'msgPassShort': 'Password must be at least 6 characters.',
        'msgPassChanged': 'Password changed successfully! Please login.',

        // Relax
        // Static
        'breathTitle': 'Breathing Pause',
        'breathDesc': 'Listen to your body. Feel your heartbeat.<br>Follow the visual rhythm to calm your mind.',
        'btnFinishBreath': 'Finish and Return',

        // Dynamic (Animation)
        'breathInstrPrep': 'GET READY',
        'breathSubPrep': 'Empty your lungs...',
        'breathInstrIn': 'INHALE',
        'breathSubIn': 'Fill your lungs with air...',
        'breathInstrHold': 'HOLD',
        'breathSubHold': 'Keep the air inside...',
        'breathInstrOut': 'EXHALE',
        'breathSubOut': 'Release slowly...',
        'msgBreathCelebration': 'You took time for yourself. Congratulations!',

        // winback
        'winbackTitle': 'Don\'t silence the bell just yet...',
        'winbackDesc': 'Treatment is a marathon, not a sprint. Your records today could save tomorrow.',
        'winbackOffer': 'How about 7 more free days to think about it?',
        'btnAcceptWinback': 'Accept +7 Free Days',
        'btnConfirmCancel': 'I understand, I want to cancel',

        // Premium Modal
        'premTitle': 'Journey of Overcoming',
        'premSubtitle': 'You don\'t have to carry the world alone. We help organize care so you can focus on love.',
        'premFeat1Title': 'Safe Decisions',
        'premFeat1Desc': 'Legal and medical community support.',
        'premFeat2Title': 'Vital History',
        'premFeat2Desc': 'Evolution charts for doctors.',
        'premFeat3Title': 'Support Circle',
        'premFeat3Desc': 'Invite unlimited family members.',
        'premTestimonial': '"This app gave me strength when I thought I had none left."',
        'premTestimonialAuthor': '- Maria, caregiver for 2 years',
        'premBadgeTrial': 'Free Trial Available',
        'premTrialTitle': 'Try 14 Days Free',
        'premTrialDesc': 'Cancel anytime. The bell of hope only rings if you want it to.',
        'planMonthlyTitle': 'Flexible Monthly',
        'planMonthlySub': 'Billed monthly',
        'planAnnualTitle': 'Annual - Best Value',
        'planAnnualSub': '/mo (Billed annually)',
        'planAnnualSave': 'SAVE 40%',
        'planAnnualBonus': '+2 Bonus Months',
        'payMethodSafe': 'Secure Method (Charged after 14 days)',
        'payBtnCard': 'Credit Card',
        'payBtnPix': 'Pix (Brazil)', // Pix s√≥ existe no BR, manter nome
        'lblCardNumber': 'Card Number',
        'lblExpiry': 'Expiry',
        'lblCVV': 'CVV',
        'lblCardName': 'Name on Card',
        'phCardName': 'As printed on card',
        'lblCardEmail': 'Cardholder Email',
        'lblDocNumber': 'Document Number (ID)',
        'btnPayCard': 'Pay with Card',
        'pixInst1': 'Upon confirmation, we generate a unique code.',
        'pixBonus': 'üéÅ +5 bonus days included!',
        'btnGenCode': 'Generate Code',
        'pixGenerating': 'Generating secure QR Code...',
        'pixScan': 'Scan or Copy',
        'pixApproved': 'Payment is approved instantly.',
        'btnStartTrial': 'Start 14-Day Free Trial',
        'lblSecure': 'üõí Secure',
        'premDisclaimer': 'By continuing, you agree to Terms. Auto-renewal. Cancel online anytime to avoid charges.',
        // --- GENERAL / NAVIGATION ---
        'btnSkipTut': 'Skip Tutorial',
        'btnNext': 'Next',
        'btnBack': 'Back',
        'btnFinish': 'Finish',
        'appTitle': 'Caregiver System',
        'closeButton': 'Close',
        'backButton': 'Back',
        'saveButton': 'Save',
        'cancelButton': 'Cancel',
        'loading': 'Loading...',
        'okButton': 'OK',
        'confirmationTitle': 'Confirmation',
        'updateNeeded': 'Update needed',
        'checkInternet': 'Check your internet connection.',
        'observationTitle': 'üìù Observation',
        'deleteAccountConfirmTitle': 'Permanently Delete Account',
        'attentionLabel': 'Warning:',
        'deleteWarning1': 'By deleting the account, all your data and patient records will be permanently lost.',
        'deleteWarning2': 'This action cannot be undone.',
        'deleteWarning3': 'Acura will no longer be able to support your progress or the patient\'s care.',
        'deleteAccountConfirmBtn': 'Confirm Deletion',
        'btnConfirm': 'Confirm',
        'aiChatTitle': 'Dr. Artificial Intelligence',
        'aiChatInputPlaceholder': 'Type your message...',
        'caregiverChatTitle': 'Caregiver Chat',
        'labelViewConv': 'View Conversations:',
        'optChatPatientOnly': 'Selected Patient Only',
        'optChatNearby': 'Nearby Caregivers (1 km radius)',
        'labelPatient': 'Patient',
        'phMessageGeneric': 'Type your message...',
        'ocrTitle': 'Document Scan via Camera',
        'ocrDataFound': 'Data Found:',
        'btnSnap': 'Take Photo',
        'btnRetry': 'Retry',
        'btnUseData': 'Use Data',
        'ocrStatusProcessing': 'Processing image, please wait...',
        'ocrStatusSuccess': 'Scan complete!',
        'ocrStatusError': 'Could not read data. Please try again.',
        'ocrStatusNoText': 'No text detected.',

        // -- UNiTS
        'titlePhysicalMeasurements': 'Physical Measurements Record',
        'labelWeight': 'Weight',
        'labelHeight': 'Height',
        'labelAbdCircumference': 'Abdominal Circumference',
        'labelNotes': 'Notes:',
        'phMeasurementNotes': 'Relevant notes about measurements...',
        'unitKg': 'kg',
        'unitLbs': 'lbs',
        'unitM': 'm',
        'unitFt': 'ft',
        'unitCm': 'cm',
        'unitIn': 'in',
        'msgUnitsChanged': 'Measurement units changed to:',
        'system_metric': 'Metric (kg/m)',
        'system_imperial': 'Imperial (lbs/ft)',
        'titleChangeAvatar': 'Change Avatar',
        'descSelectImage': 'Select an image from your device.',
        'btnUpload': 'Upload',

        // --- LOGIN ---
        'loginPrompt': 'Sign in with Google or use email and password.',
        'orSeparator': 'or',
        'emailLabel': 'Email',
        'phEmail': 'your@email.com',
        'passwordLabel': 'Password',
        'phPassword': 'Password',
        'loginButton': 'Sign In',
        'registerButton': 'Create Account',
        'forgotPassword': 'Forgot password?',
        'refreshScreen': 'Refresh Screen',

        // --- CAREGIVER PROFILE ---
        'caregiverProfileTitle': 'Caregiver Profile',
        'caregiverProfileDesc': 'Set a nickname to be displayed to other caregivers.',
        'caregiverNicknameLabel': 'Nickname',
        'phNickCaregiver': 'Ex: John (dad)',
        'caregiverRoleLabel': 'You are:',
        'phRole': 'What is your relationship to the patient',
        'saveCaregiverButton': 'Save and Continue',

        // --- PATIENT SELECTION ---
        'patientsTitle': 'Patients',
        'selectPatientDesc': 'Select an existing patient or create a new one.',
        'createPatientTitle': 'Create Patient',
        'patientNicknameLabel': 'Patient Nickname',
        'phNickPatient': 'Ex: Mary',
        'patientDobLabel': 'Date of Birth',
        'patientIllnessLabel': 'Illness / Condition',
        'phDisease': 'Ex: Leukemia',
        'phWeight': 'Weight (kg)',
        'phHeight': 'Height (m)',
        'patientGenderLabel': 'Gender',
        'genderFemale': 'Female', 'genderMale': 'Male',
        'patientAllergiesLabel': 'Allergies',
        'phAllergies': 'Allergies (if any)',
        'savePatientButton': 'Register Patient',
        'logoutButton': 'Logout',
        'enterCodeTitle': 'Enter Patient Code',
        'phCode': 'Patient Code / ID',
        'careBtn': 'Care',
        'dashboardBtn': 'Dashboard',
        'noDiagnosis': 'No diagnosis',

        // --- DASHBOARD ---
        'dashboardTabNutrition': 'Nutrition',
        'dashboardTabPharmacy': 'Pharmacy',
        'dashboardTabExams': 'Exams/Labs',
        'dashboardTabProcedures': 'Procedures',
        'dashboardTabFinance': 'Finance',
        'dashboardTabAchievements': 'Daily Achievements',
        'filterTimeframeLabel': 'Filter by:',
        'timeframe6h': 'Last 6 Hours', 'timeframe12h': 'Last 12 Hours', 'timeframeDay': 'Day', 'timeframeWeek': 'Week',
        'labelCaregiver': 'Caregiver:',

        // --- NUTRITION MODULE ---
        'nutritionTitle': 'Nutrition & Hydration',
        'nutritionalBalanceTitle': 'üçé Nutritional Balance (Solid Input/Output)',
        'physicalEvolutionTitle': 'Physical Evolution',
        'weightImcTitle': 'Weight & BMI Evolution',
        'lastWeight': 'Last Weight', 'lastImc': 'Last BMI',
        'abdominalCircTitle': 'Abdominal Circumference',
        'lastCirc': 'Last Circ.', 'alertState': 'Alert',
        'fluidBalanceTitle': 'Fluid Balance',
        'fluidIntake': 'Total Intake (mL)', 'fluidOutput': 'Total Output (mL)', 'fluidFinal': 'Final Balance (mL)',
        'fluidInsensibleLoss': 'Est. Insensible Loss',
        'fluidDetailsTitle': 'Detailed Input/Output',
        'tableHeaderDate': 'Date', 'tableHeaderType': 'Type', 'tableHeaderVolume': 'Volume (mL)',

        // Fragmented Fluid Balance Strings
        'textBasedOn': '(Based on ',
        'textDaysWith': ' days, with ',
        'textFeverDays': ' fever days).',

        // Nutrition Tips
        'tip1Label': 'üí° Tip 1:',
        'tip1Body': 'The displayed data is based on manual records. Continue recording fluid intake and meals using the buttons on the main screen.',
        'tip2Label': 'üí° Tip 2:',
        'tip2Body': 'Foods that liquefy (e.g., ice cream, gelatin) should be recorded as liquid (in mL).',
        'tip3Label': 'üí° Tip 3:',
        'tip3Body': 'Liquid Bowel Movements (Stool) are estimated and recorded in mL. When weighing the diaper, consider 1g = 1ml. In the notes field, describe diarrhea or liquid stool.',
        'tip4Label': 'üí° Tip 4:',
        'tip4Body': 'For more information, consult a nurse.',

        // --- EXAMS / PROCEDURES ---
        'labResultsTitle': 'Laboratory Results',
        'labResultsDesc': 'Latest critical results and historical evolution will be shown here.',
        'proceduresTitle': 'Procedures & Consultations Timeline',
        'phSearchFilter': 'Type to search...',
        // Titles
        'diaryTitle_food': 'Food Log',
        'diaryTitle_drinks': 'Drink/Hydration Log',
        'diaryTitle_pain': 'Pain/Satisfaction Log',
        'diaryTitle_sleep': 'Sleep',
        'diaryTitle_physio': 'Physiotherapy Session',
        'diaryTitle_excretion': 'Excretion Log',
        'diaryTitle_vitals': 'Vital Signs (Manual)',
        'diaryTitle_lab': 'Lab Exam',
        'titleImproveDiag': 'üß¨ Improve Diagnosis',
        'labelQuickSearch': 'Quick Search:',
        'phDiseaseFilter': 'Type to filter (e.g. Cancer)...',
        'labelDiseaseType': 'Disease Type:',
        'grpMain': 'Main',
        'grpFullList': 'Complete List (A-Z)',
        'labelSubtype': 'Subtype / Mutation (Optional):',
        'phSubtype': 'Ex: Ph+, HER2, KRAS...',
        'btnSaveDiag': 'Save Diagnosis',

        // Diseases
        'disLLA': 'Acute Lymphocytic Leukemia (ALL)',
        'disLMA': 'Acute Myeloid Leukemia (AML)',
        'disLMC': 'Chronic Myeloid Leukemia (CML)',
        'disHodgkin': 'Hodgkin Lymphoma',
        'disNonHodgkin': 'Non-Hodgkin Lymphoma',
        'disMyeloma': 'Multiple Myeloma',
        'disBreast': 'Breast Cancer',
        'disProstate': 'Prostate Cancer',
        'disLung': 'Lung Cancer',
        'disAnal': 'Anal Cancer',
        'disBladder': 'Bladder Cancer',
        'disMouth': 'Oral Cancer',
        'disHeadNeck': 'Head and Neck Cancer',
        'disCervical': 'Cervical Cancer',
        'disColorectal': 'Colorectal Cancer',
        'disUterine': 'Uterine Cancer',
        'disEsophagus': 'Esophageal Cancer',
        'disStomach': 'Stomach Cancer',
        'disLiver': 'Liver Cancer',
        'disGIST': 'GIST (Gastrointestinal Stromal Tumor)',
        'disLarynx': 'Laryngeal Cancer',
        'disNET': 'NET (Neuroendocrine Tumors)',
        'disOvarian': 'Ovarian Cancer',
        'disPancreas': 'Pancreatic Cancer',
        'disSkinMelanoma': 'Skin - Melanoma',
        'disSkinNonMelanoma': 'Skin - Non-Melanoma',
        'disPenis': 'Penile Cancer',
        'disKidney': 'Kidney Cancer',
        'disSarcoma': 'Sarcomas',
        'disCNS': 'Central Nervous System',
        'disTesticular': 'Testicular Cancer',
        'disThyroid': 'Thyroid Cancer',
        'disVagina': 'Vaginal Cancer',
        'disGallbladder': 'Gallbladder Cancer',
        'disVulva': 'Vulvar Cancer',
        'disOther': 'Other',

        // Labels
        'labelFoodQty': 'Food Quantity',
        'labelVolDose': 'Volume/Dose',
        'labelPainLevel': 'Pain Level | Discomfort (1-10)',
        'labelSatisfaction': 'Service Satisfaction (1-10)',
        'labelDuration': 'Duration',
        'labelSessionDuration': 'Session Duration',
        'labelLiquidExcretion': 'Urine|Vomit|Diarrhea (Liquid)',
        'labelSolidExcretion': 'Stool (Solid)',
        'labelHeartRate': 'Heart Rate (HR)',
        'labelRespRate': 'Respiratory Rate (RR)',
        'labelExamType': 'Exam Type',
        'labelResultMain': 'Main Result',
        'ocrTitle_monitor': 'Vital Signs Scan (ICU Monitor)',
        'ocrTitle_blood': 'Lab Test Scan',

        // Units
        'unitG': 'g (grams)',
        'unitMl': 'mL (milliliters)',
        'unitScale': 'Scale',
        'unitHours': 'h (hours)',
        'unitMin': 'min (minutes)',
        'unitBpm': 'bpm',
        'unitRpm': 'rpm',
        'unitExam': 'Exam',
        'unitGdl': 'g/dL',
        'unitMgdl': 'mg/dL',
        'unitUil': 'UI/L',

        // --- FINANCE ---
        'financeTotalMonth': 'Total Spent this Month',
        'financeHistory': 'Expense History',
        'financeCaregiverContrib': 'Contribution by Caregiver',
        'financeShiftLog': 'Shift Log (Hours)',
        'msgNoChartData': 'Not enough data to generate chart.',
        'tableHeaderDesc': 'Description', 'tableHeaderValue': 'Value',
        'tableHeaderCaregiver': 'Caregiver', 'tableHeaderIn': 'In', 'tableHeaderOut': 'Out', 'tableHeaderDuration': 'Duration',

        // --- CAREGIVER MENU ---
        'myWellness': 'My Wellness',
        'dailyProgress': 'Daily Progress',
        'wellnessTip': 'Complete 4 meals and 1 sleep period to keep your wellness at 100%',
        'actionRecordMeal': 'Record Meal',
        'actionRecordSleep': 'Record Sleep',
        'actionCalmDown': 'Calm Down',
        'subTextCalmDown': 'Anxiety relief (4-7-8)',
        'actionFinanceControl': 'Finance Control',
        'subTextFinance': 'Expense and benefit log',
        'actionTutorial': 'How to use App',
        'subTextTutorial': 'Review interactive tutorial',
        'textPending': 'Pending',
        'textProgressToday': '0/4 today',

        // --- ACURA MENU ---
        'termsConditions': 'Terms & Conditions',
        'privacyPolicy': 'Privacy Policy',
        'contactUs': 'Contact Us',
        'manageSubscription': 'Manage Subscription',
        'abandonPatient': 'Abandon Patient',
        'deleteAccount': 'Delete My Account',
        'deleteAccountConfirmTitle': 'Permanently Delete Account',
        'deleteAccountConfirmBtn': 'Confirm Deletion',

        // --- MAIN GAME SCREEN ---
        'locationLabel': 'Patient Location',
        'locationResidence': 'Residence',
        'locationHospital': 'Hospital',
        'taskProgress': 'Progress',
        'survivalProb': 'Probability',
        'survivalProbLabel': 'Probability',
        'newAppointmentBtn': 'New Appointment',
        'todayAgenda': 'Today\'s Agenda',
        'btnMedications': 'Medications',
        'btnIntravenous': 'Intravenous',
        'btnAdvice': 'Advice',
        'titleManageCatheter': 'Manage Access/Catheter',
        'btnExitScene': 'Leave scene',

        // --- TIMELINE ---
        'btnAddPro': '+ Register Health Pro',
        'phLocationGeneric': 'Ex: Office 1 - Ground Floor',
        'phDoctorName': 'Doctor/Nurse Name',
        'phPhone': '(00) 0000-0000',
        'labelFasting': 'Fasting (hours):',
        'optFasting0': '0 (Not required)',
        'optFasting4': '4 hours',
        'optFasting6': '6 hours',
        'optFasting8': '8 hours',
        'optFasting12': '12 hours',
        'labelPaidBy': 'Paid by:',
        'optPaySelect': 'Select payment type',
        'btnCreateAppt': 'Create Appointment',
        'titleCreateAppt': 'Create New Appointment',
        'labelApptType': 'Appointment Type:',
        'optTypeConsultation': 'Consultation',
        'optTypeExam': 'Exam',
        'optTypeProcedure': 'Procedure',
        'labelDateTime': 'Date/Time',
        'labelLocation': 'Location:',
        'labelHealthPro': 'Health Professional:',
        'labelPhone': 'Phone:',
        'labelInstructions': 'Preparation Instructions:',
        'selectFastingPlaceholder': 'Select fasting time',

        // --- MEDICATIONS MODAL ---
        'newMedTitle': 'Register New Medication',
        'phSearchMed': 'Type to search...',
        'titleCamRx': 'Read prescription via Camera',
        'medNameLabel': 'Medication Name',
        'medRouteLabel': 'Administration Route',
        'routeOral': 'Oral (Mouth)', 'routeNaso': 'Nasogastric', 'routeIV': 'Intravenous (IV)',
        'medDosageLabel': 'Dosage', 'medUnitLabel': 'Unit',
        'phDosageUnit': 'mg, ml, drops',
        'medDilutionLabel': 'Dilution Liquid',
        'medDilutionVolLabel': 'Dilution Volume',
        'medFlowLabel': 'Programmed Flow Rate (ml/h)',
        'medIntervalLabel': 'Take every', 'hoursUnit': 'hours',
        'medStartLabel': 'First Dose Date/Time',
        'medDoctorLabel': 'Prescribing Doctor',
        'medSuspensionLabel': 'Expected Suspension Date',
        'medPayerLabel': 'Paid by',
        'payerPublic': 'Public', 'payerInsurance': 'Insurance', 'payerPrivate': 'Private',
        'medStatusLabel': 'Prescription Status',
        'statusActive': 'Active', 'statusSuspended': 'Suspended',
        'savePrescriptionBtn': 'Save Prescription',
        'labelVia': 'Route',
        'labelDilution': 'Dilution',
        'labelFlow': 'Flow Rate',
        'btnIgnore': 'Skip',
        'btnStart': 'Start',


        // --- INFUSION CALCULATOR ---
        'calcVolume': 'Total Volume (mL)',
        'phVol': 'Ex: 500',
        'calcFlow': 'Flow Rate (mL/h)',
        'phFlow': 'Ex: 100',
        'calcTime': 'Application Time',
        'phTimeH': 'Hours', 'phTimeM': 'Minutes', 'phTimeS': 'Seconds',
        'tipInfusionCalc': 'Tip: Use 2 fields to calculate the 3rd',
        'btnCalculate': 'Calculate',
        'btnStartInfusion': 'Start Infusion',
        'btnRestart': 'Reset',
        'tipInfusionCalc': 'Tip: Use 2 fields to calculate the 3rd',
        'phVol': 'Ex: 500',
        'phFlow': 'Ex: 100',
        'phTimeH': 'Hours',
        'phTimeM': 'Minutes',
        'phTimeS': 'Seconds',
        'btnRestart': 'Reset',

        // --- IGNORE DOSE MODAL ---
        'ignoreActionTitle': 'Action Confirmation',
        'textIgnoreMsg': 'You are skipping the scheduled dose.',
        'ignoreOnceBtn': 'Skip JUST NOW',
        'subTextIgnoreOnce': 'Does not affect future doses.',
        'suspendRxBtn': 'Suspend Use',
        'subTextSuspendRx': 'Cancels this and all future doses.',
        'phIgnoreReason': 'Optional: Describe the reason...',
        'textIgnoreMsgPart1': 'You are skipping the dose of ',
        'textIgnoreMsgPart2': 'scheduled for ',
        'ignoreOnceBtn': 'Skip JUST THIS ONE',
        'subTextIgnoreOnce': 'Does not affect future doses.',
        'suspendRxBtn': 'Suspend Medication',
        'subTextSuspendRx': 'Cancels this and all future doses.',
        'phIgnoreReason': 'Optional: Describe the reason...',

        // --- LOCATION MODAL ---
        'locHospitalName': 'Location Name',
        'phLocHome': 'Patient Home',
        'phLocSector': 'Ex: ICU 2',
        'phLocFloor': 'Ex: 5th',
        'phLocBed': 'Ex: 21B',
        'locSector': 'Sector', 'locFloor': 'Floor', 'locBed': 'Bed / Room',
        'locAdmissionDate': 'Admission Date',
        'labelTimeOnLoc': 'Time at Location:',
        'unitDays': 'days',
        'locCleaningFreq': 'Terminal Cleaning Frequency (days)',
        'statusGPS': 'GPS waiting...',
        'btnSaveLocation': 'Save Location',
        'tipCleaningChecklist': 'Sets the alert for the BMT checklist.',

        // --- CARE HUB / CHAT ---
        'hubDiary': 'Diary',
        'hubLegacyAI': 'Legacy AI',
        'labelDrAI': 'Dr. Artificial Intelligence',
        'labelChatCare': 'Caregiver Chat',
        'labelViewChat': 'View Chats:',
        'optChatPatient': 'Selected Patient Only',
        'optChatNear': 'Nearby Caregivers (1 km Radius)',
        'phChatMsg': 'Type your message...',
        'hubWriteStory': 'Record insecurities, scares, achievements...',
        'btnReadStories': 'Read Stories',
        'tooltipStories': 'Turn the diary into a book or movie in the future!',
        'statusLoadingStories': 'Loading stories...',
        'checkVisibleTeam': 'Visible to team',
        'hubPublish': 'Publish',
        'hubEmergency': 'ER | ICU',
        'hubDecisions': 'Decision Poll',
        'hubNewDecision': 'New Decision',
        'msgNoDecisions': 'No pending decisions.',
        'btnSendInvite': 'Send Invite',
        'hubAddMember': '+ Member',
        'hubEndJourney': 'End of Journey',
        'widgetSurvivorTitle': 'Overall Trophy [Victory]',
        'widgetSurvivorCalc': 'Calculating time to victory...',
        'btnBackToCare': 'Back to care',
        'hubHeaderStatus': 'Care Hub, Decision & Evolution',
        'btnSyncWearables': 'Sync Wearables',
        'btnTransfusionRBC': 'RBC Transfusion',
        'btnTransfusionPlatelets': 'Platelet Transfusion',
        'btnTransfusionGranulo': 'Granulocyte Transfusion',
        'btnMedAntipyretic': 'Antipyretic Medication',
        'btnGasOxygen': 'Oxygen Gas',
        'statusLoadingHistory': 'Loading history...',
        'msgNoActiveDecisions': 'None active',
        'labelDecisionTitle': 'Decision Title:',
        'phDecisionTitle': 'Ex: Hospital Change',
        'labelDeadline': 'Deadline:',
        'labelDetails': 'Details:',
        'phDecisionDetails': 'Details, consent form, etc.',
        'labelVoteOptions': 'Vote Options:',
        'phOption1': 'Option 1 (Describe pros/cons)',
        'phOption2': 'Option 2 (Describe pros/cons)',
        'phCaregiverEmail': 'Caregiver Email',

        // --- BLE
        'bleTitle': 'Connect Sensors',
        'btnScanBle': 'Scan Device',
        'statusWaitingConnection': 'Waiting for connection...',
        'labelHR': 'HR',
        'labelTemp': 'TEMP',
        'labelSpO2': 'SpO2',
        'labelBP': 'BP', // Blood Pressure
        'bleErrorTitle': 'CRITICAL ERROR: Bluetooth API not detected.',
        'bleErrorHttps': '‚ö†Ô∏è Site is not in a secure context (HTTPS).',
        'bleErrorCausesTitle': '‚ö†Ô∏è Possible causes:',
        'bleErrorCause1': '1. Outdated WebView.',
        'bleErrorCause2': '2. App in debug mode without updated Chrome System WebView.',
        'bleErrorCause3': '3. Bluetooth disabled on device.',

        // --- SETTINGS ---
        'settingsTitle': 'Settings',
        'tabSystem': 'System',
        'tabCaregiver': 'Caregiver',
        'tabPatient': 'Patient',
        'fontSizeLabel': 'Font Size',
        'languageLabel': 'App Language',
        'alarmLabel': 'Alarm Tone',
        'alarmNone': 'None',
        'alarmSynth': 'Bell (Default)',
        'alarmBeepShort': 'Short Beep',
        'alarmDigitalLong': 'Digital Alarm',
        'alarmMediumBell': 'Medium Bell',
        'alarmPhoneRing': 'Phone Ring',
        'unitsLabel': 'Measurement Units',
        'unitsMetric': 'Metric System (m, ¬∞C)',
        'unitsImperial': 'Imperial System (ft, ¬∞F)',
        'dataCollectionLabel': 'Data Collection (Temp/Humid.)',
        'themeLabel': 'Display Mode',
        'themeAuto': 'Automatic',
        'themeLight': 'Light',
        'themeDark': 'Dark',
        'changeAvatarBtn': 'Change Avatar',
        'improveDiagnosisBtn': 'Improve Diagnosis',
        'phCard': '0000 0000 0000 0000',
        'titleCopyCode': 'Copy Code',
        'settingsTitle': 'Settings',
        'tabSystem': 'System',
        'tabCaregiver': 'Caregiver',
        'tabPatient': 'Patient',
        'fontSizeLabel': 'Font Size',
        'languageLabel': 'App Language',
        'langPt': 'Portuguese',
        'langEn': 'English',
        'langEs': 'Spanish',
        'alarmLabel': 'Alarm Sound',
        'alarmNote': 'None',
        'alarmSynth': 'Bell',
        'alarmBeepShort': 'Short Beep',
        'alarmDigitalLong': 'Digital Alarm',
        'alarmMediumBell': 'Medium Bell',
        'unitsLabel': 'Measurement Units',
        'unitsMetric': 'International System (m, ¬∞C)',
        'unitsImperial': 'Imperial System (ft, ¬∞F)',
        'dataCollectionLabel': 'Data Collection (Temp/Humid.)',
        'themeLabel': 'Display Mode',
        'themeAuto': 'Automatic',
        'themeLight': 'Light',
        'themeDark': 'Dark',
        'btnSaveSystem': 'Save System Settings',
        'changeAvatarBtn': 'Change Avatar',
        'labelNickname': 'Nickname',
        'phNickname': 'Your nickname',
        'labelRelation': 'Relationship to Patient',
        'btnSaveCaregiver': 'Save Caregiver Profile',
        'patientNicknameLabel': 'Patient Nickname',
        'phPatientNickname': 'Patient nickname',
        'msgNicknameLocal': 'Nickname is for local display only.',
        'patientIllnessLabel': 'Disease / Condition',
        'phIllness': 'Ex: Leukemia',
        'improveDiagnosisBtn': 'Improve Diagnosis',
        'patientAllergiesLabel': 'Allergies',
        'phAllergies': 'List of allergies',
        'btnSavePatient': 'Save Patient Profile',

        //---EXAM
        'diaryTitle': 'Record Action',
        'labelExamType': 'Exam Type:',
        'optSelect': 'Select...',
        'examHemogram': 'Complete Blood Count (CBC)',
        'examHepatic': 'Hepatic Biochemistry',
        'examRenal': 'Renal Biochemistry',
        'examElectrolytes': 'Electrolytes',
        'examLipid': 'Lipid Profile',
        'examGlycemia': 'Glycemia/Metabolism',
        'examCoagulation': 'Coagulation',
        'examTumorMarkers': 'Tumor Markers',
        'examProteins': 'Proteins/Immunoglobulins',
        'examHormones': 'Hormones',
        'examUrine1': 'Urinalysis (UA)',
        'examUrine24h': '24-hour Urine',
        'examStool': 'Stool Test',
        'examVirology': 'Virology',
        'examCulture': 'Culture',
        'examCSF': 'Cerebrospinal Fluid (CSF)',
        'examAscitic': 'Ascitic Fluid',
        'examPleural': 'Pleural Fluid',
        'examImmunology': 'Immunology',
        'examGasometry': 'Blood Gas Analysis',
        'examGeneticsNGS': 'Genetics NGS*',
        'examCytogenetics': 'Cytogenetics & Molecular*',
        'labelExamParameter': 'Exam Parameter:',
        'phExamParameter': 'Ex: Platelets, RBC, Lymphocytes',
        'labelUnit': 'Measurement Unit:',
        'labelRefMin': 'Reference (min):',
        'labelRefMax': 'Reference (max):',
        'labelExamResult': 'Exam Result:',
        'optNotDetected': 'Not detected/Negative',
        'optDetected': 'Detected/Positive',
        'labelValue1': 'Value 1:',
        'labelValue2': 'Value 2:',
        'labelSpO2': 'Pulse Oximetry (SpO2):',
        'phSpO2': 'Ex: 98',
        'labelBP': 'Blood Pressure (BP):',
        'phSystolic': 'Systolic',
        'phDiastolic': 'Diastolic',
        'labelTemp': 'Temperature:',
        'phTemp': 'Ex: 36.5',
        'labelNotes': 'Notes:',
        'phNotes': 'Report observations here...',
        'btnOCR': 'Scan with Camera',
        // Tutorial
        'tutIntroTitle': 'Hello! üíô',
        'tutIntroDesc': 'Welcome to your support space. We prepared a quick guide to help you use the Acura App effectively.',
        'tutMenuTitle': 'Acura Menu',
        'tutMenuDesc': 'Tap the logo to access legal terms and support.',
        'tutSettingsTitle': 'Settings',
        'tutSettingsDesc': 'Customize your experience here: change your avatar and the patient\'s avatar, for example.',
        'tutCaregiverTitle': 'Your Well-being',
        'tutCaregiverDesc': 'Here you take care of yourself. Log your sleep, meals, and take breaks to breathe. You matter!',
        'tutCallCaregiversTitle': 'Call Caregivers',
        'tutCallCaregiversDesc': 'Tap here to toggle the alarm that alerts on-duty caregivers on the Patient screen.',
        'tutLocationTitle': 'Locate Patient',
        'tutLocationDesc': 'When with the patient, tap here to update location data and help other caregivers find them.',
        'tutProgressTitle': 'Daily Progress',
        'tutProgressDesc': 'Track performance with this bar. Completing it by the end of the day confirms good care.',
        'tutTimelineTitle': 'Timeline',
        'tutTimelineDesc': 'Here you will see upcoming events like exams, procedures, and appointments.',
        'tutAddEventTitle': 'Add Event',
        'tutAddEventDesc': 'An important button! Use it to set reminders for appointments and procedures on the timeline.',
        'tutAgendaTitle': 'Agenda Commitments',
        'tutAgendaDesc': 'When the time comes, medications and tasks due throughout the day appear here.',
        'tutMedsTitle': 'Add Medications',
        'tutMedsDesc': 'Another important button! Use it to schedule administration routines (tip: consult nursing if needed).',
        'tutPatientTitle': 'Patient',
        'tutPatientDesc': 'Tap here to log history, emergency care, and get help making important decisions.',
        'tutShieldTitle': 'Protection Shield',
        'tutShieldDesc': 'A complete circle indicates that the care provided is significant throughout the journey.',
        'tutQuickLogTitle': 'Quick Log',
        'tutQuickLogDesc': 'The circular buttons are for easily logging food, drinks, and other data. Try it out!',
        'tutCatheterTitle': 'Active Catheters',
        'tutCatheterDesc': 'Tap the arrow to register and manage catheters to keep them functional and safe.',
        'tutDrAITitle': 'Doctor AI',
        'tutDrAIDesc': 'When needed, chat with Doctor AI about symptoms, questions, or tips.',
        'tutChatHumanTitle': 'Chat with Caregivers',
        'tutChatHumanDesc': 'Share care and information. Encourage other caregivers to use Acura and expand your horizons.',
        'tutDashboardTitle': 'Dashboard Control',
        'tutDashboardDesc': 'On the patient screen, view reports like fluid balance, exams, and cumulative doses!',
        'msgTutorialComplete': 'You are ready! Count on us.',
        'tutcurrentTimeTitle': 'Service Agility',
        'tutcurrentTimeDesc': 'Beyond the current time, track the nursing team\'s agility at the end of every infusion.',
        'tutProfessionalPresenceTitle': 'Recognize Today\'s Nursing Team',
        'tutProfessionalPresenceDesc': 'Register every nurse present today here, even if they don\'t use Acura yet. This ensures they receive future recognition for their good work.',
        'tutOpenShareTitle': 'Share Acura Now',
        'tutOpenShareDesc': 'Invite other caregivers and patients to Acura! But attention: only send invites containing patient data to friends and family.',
    },
    'es': {

        //boas vindas
        'welcomeTitle': '¬°Bienvenido a Acura!',
        'welcomeSubtitle': 'Tu jornada de cuidado comienza aqu√≠. Notamos que a√∫n no tienes pacientes registrados.',
        'welcomeHowItWorks': '¬øC√≥mo funciona la XP?',
        'welcomeStep1': 'Registra tu primer paciente ahora.',
        'welcomeStep2': 'La App te guiar√° en las tareas diarias.',
        'welcomeStep3': '¬°Cada cuidado registrado genera Puntos de Experiencia (XP) y medallas!',
        'btnCreateFirstPatient': 'Crear Primer Paciente',

        //
        'locModeHospital': 'Hospital / Instituci√≥n',
        'lblHospitalName': 'Nombre del Hospital:',
        'locModeHome': 'Residencia / HomeCare',
        'lblIdentification': 'Identificaci√≥n:',
        'valHomePatient': 'Casa del Paciente',

        //profissionais no turno
        'titleDeleteProf': 'Eliminar Profesional',
        'msgConfirmDeleteProf': '¬øEst√° seguro de que desea eliminar definitivamente a este profesional de la lista?',
        'btnDelete': 'Eliminar',
        'ppTitle': 'Equipo Presente en el Turno',
        'ppActivePros': 'Profesionales en el Lugar (Activos):',
        'ppInactivePros': "Profesionales en Descanso (Inactivos):",
        'ppNoSelection': 'Ning√∫n profesional seleccionado.',
        'ppAddLabel': 'Agregar Profesional al Turno:',
        'ppSearchPlaceholder': 'Escriba el nombre del profesional...',
        'ppNotFound': '¬øNo lo encontr√≥?',
        'ppRegisterNew': 'Registrar nuevo profesional',
        'btnFinish': 'Concluir',

        //atendimento
        'rsReasonGeneral': 'General',
        'rsNotInformed': 'No Informado',
        'rsYes': 'S√≠',
        'rsNo': 'No',
        'rsNoRecordsFound': 'No se encontraron registros.',
        'rsLabelResp': 'Resp',
        'rsClearHistoryTitle': 'Borrar Historial',
        'rsConfirmClear': '¬øEst√° seguro de que desea borrar todo el historial de atenci√≥n?',
        'rsBtnClearConfirm': 'S√≠, Borrar',
        'titleLogAttendance': 'Registro de Atenci√≥n',
        'lblWhoAttended': '¬øQui√©n realiz√≥ la atenci√≥n?',
        'phWhoAttended': 'Nombre del Profesional o Cuidador',
        'lblObservations': 'Observaciones:',
        'phObservations': 'Ej: Paciente atendido, medicaci√≥n adelantada...',
        'btnSaveLog': 'Guardar Registro',
        'reasonManualCall': 'Llamada Manual (Timbre)',
        'defaultCaregiverName': 'Cuidador Actual',
        'msgAttendanceSaved': '¬°Atenci√≥n registrada con √©xito!',
        'rsReasonGeneral': 'General',
        'rsNotInformed': 'No Informado',
        'rsYes': 'S√≠',
        'rsNo': 'No',
        'rsNoRecordsFound': 'No se encontraron registros.',
        'rsLabelResp': 'Resp',
        'rsConfirmClear': '¬øEst√° seguro de que desea borrar todo el historial de atenci√≥n?',
        'reportResponseTitle': 'Informe de Respuesta y Atenci√≥n',
        'thDateTime': 'Fecha/Hora',
        'thReason': 'Motivo (Agilidad)',
        'thProfessional': 'Profesional',
        'thCaregiver': 'Cuidador',
        'thLocationCheck': '¬øUbicaci√≥n OK?',
        'thNotes': 'Observaciones',
        'btnClearHistory': 'Borrar Historial',
        'btnClose': 'Cerrar',

        //modal de compartilhamento
        'promoGamificationTitle': '¬°Desbloquea Logros!',
        'promoGamificationDesc': 'Invita a cuidadores, fortalece la red de apoyo y gana la medalla Embajador Acura.',
        'msgShareDefault': '¬°Hola! Estoy usando la app Acura de OncoTrek.org para ayudar con nuestro tratamiento.',
        'msgErrNoPatientCode': 'No se pudo localizar el c√≥digo del paciente. Compartiendo solo el enlace de la App.',
        'msgShareWithCode': '¬°Hola! Accede a *acura.vc* para acompa√±ar al paciente. El c√≥digo de acceso es: *{code}*',
        'titleCodeDetected': '¬°C√≥digo Detectado!',
        'msgCodeInserted': "C√≥digo {code} insertado. Haga clic en 'Entrar' para acceder.",
        'btnOk': 'Ok',
        'modalAttentionTitle': 'Atenci√≥n',
        'shareAccessTitle': 'Compartir Acceso',
        'shareAccessDesc': '¬øC√≥mo desea invitar al nuevo cuidador?',
        'btnShareWithData': 'Enviar con Datos del Paciente',
        'subShareWithData': 'Incluye c√≥digo para acceso inmediato.',
        'btnShareAppLink': 'Solo Enlace de la App',
        'subShareAppLink': 'Para instalar sin vincular paciente ahora.',
        'btnCancel': 'Cancelar',

        //voz
        'msgWeNeedYou' : 'Te necesitamos',
        'msgSpeakComeAcura': '¬°Venga! Usted tiene Acura.',

        //
        'lblTrend': 'Tendencia:',
        'statusAdequate': '‚úÖ Adecuado',
        'statusConsumeMore': '‚ö†Ô∏è Consumir M√°s',
        'titleLiquidConsumption': 'Consumo de L√≠quidos (mL)',
        'lblTotal': 'Total:',
        'lblGoal': 'Meta:',
        'lblDaily': '/D√≠a',
        'titleRegisteredMeals': 'Comidas Registradas',
        'lblMealsInPeriod': 'comidas en el per√≠odo',
        'statusStable': 'Estable',
        'goalMealsPerDay': 'Meta: 4-5 comidas/d√≠a',

        //
        'titleLogEmergency': 'Registrar Emergencia',
        'msgConfirmEmergency': '¬øDesea registrar "{type}" ahora?',
        'btnRegister': 'Registrar',
        'msgEmergencySaved': '‚úÖ ¬°Registro de emergencia guardado con √©xito!',
        'titleLocationAccess': 'Acceso a Ubicaci√≥n',
        'msgLocationRequiredEmergency': 'Por favor, permita la ubicaci√≥n para registrar la emergencia.',

        // fim de jornada
        'titleEndOfJourney': 'Fin de la Jornada',
        'msgConfirmGrief': 'ATENCI√ìN: Esta acci√≥n finalizar√° el ciclo de cuidados para este paciente. ¬øRealmente desea confirmar el duelo?',
        'btnConfirmGrief': 'S√≠, Confirmar Duelo',
        'msgValidatingLocation': 'Validando ubicaci√≥n...',
        'detailsJourneyEnded': 'Jornada terminada.',
        'titleJourneyEnded': 'Jornada Terminada',
        'msgCondolences': 'Mis condolencias. La aplicaci√≥n se reiniciar√° para actualizar los datos.',
        'msgLocationRequired': 'Se requiere ubicaci√≥n para validar el cierre.',

        // Trofeu
        'msgDatePending': 'Fecha de inicio pendiente',
        'survivorCountdown': '{a}a {d}d {h}h para Celebraci√≥n Suprema',
        'survivorInfoTitle': 'El Camino Heroico',
        'survivorInfoP1': 'El <b>Trofeo Overall</b> celebra la jornada de 5 a√±os despu√©s del diagn√≥stico inicial.',
        'survivorInfoP2': 'En medicina, este hito representa <b>La Cura</b> consolidada y la superaci√≥n del riesgo de recidiva.',
        'survivorInfoP3': 'Sigue haciendo historia y no dejes a nadie fuera: ¬°invita a profesionales y cuidadores a <b>La Cura</b>!',
        'survivorInfoFooter': 'Faltan <b>{a} a√±os y {d} d√≠as</b> de vigilancia y amor.',
        'btnKeepCaring': 'Seguir Cuidando',
        'survivorVictoryBtnLabel': '¬°VICTORIA ALCANZADA! ¬°CLIC AQU√ç!',
        'survivorVictoryTitle': 'üéä S√öPER SOBREVIVIENTE ABSOLUTO üéä',
        'survivorVictorySubtitle': '¬°5 A√ëOS DE VICTORIA!',
        'survivorVictoryQuote': 'El c√°ncer se ha convertido solo en una p√°gina pasada en tu historia de valent√≠a.',
        'survivorVictoryListTitle': 'A partir de ahora, comienza un nuevo cap√≠tulo:',
        'survivorActionInspireTitle': 'Inspirar:',
        'survivorActionInspireDesc': 'Transforma tu jornada en un libro o pel√≠cula para guiar a quienes siguen en el camino.',
        'survivorActionGratitudeTitle': 'Gratitud:',
        'survivorActionGratitudeDesc': 'Honra a los h√©roes de la medicina y enfermer√≠a que lucharon a tu lado.',
        'survivorActionMentorshipTitle': 'Mentor√≠a:',
        'survivorActionMentorshipDesc': 'Usa la app Acura para dar apoyo y esperanza a nuevos pacientes.',
        'survivorVictoryFinalMsg': 'Y, sobre todo... Vive. Intensamente.',
        'btnCelebrateLife': '‚ú® CELEBRAR LA VIDA ‚ú®',

        //catheter
        'msgNoCatheter': 'No se encontraron cat√©teres activos.',
        'btnRegisterNew': 'Registrar Nuevo',
        'labelCatheter': 'Cat√©ter',
        'lblInsertedIn': 'Insertado en:',
        'lblManufacturer': 'Fabricante:',
        'lblGauge': 'Calibre:',
        'statusActive': 'Activo',
        'lblNextFlush': 'Pr√≥ximo Lavado',
        'lblNextDressing': 'Pr√≥ximo Curativo',
        'tagToday': '(HOY)',
        'btnMaintenance': 'Mantenimiento',
        'btnRemoved': 'Retirado',

        //timeline
        'timeToday': ' (hoy)',
        'timeTomorrow': ' (ma√±ana)',
        'timeInDays': ' (en {days} d√≠as)',
        'titleAppointmentsFor': 'Citas para',
        'lblDescription': 'Descripci√≥n:',
        'lblPlace': 'Ubicaci√≥n:',
        'lblProfessional': 'Profesional:',
        'lblPhone': 'Tel√©fono:',
        'lblFasting': 'Ayuno:',
        'lblHours': 'horas',
        'lblNotNeeded': 'No necesario',
        'lblInstructions': 'Instrucciones:',
        'lblStatus': 'Estado:',
        'btnNotDone': '‚ö†Ô∏è No Realizado',
        'btnCancel': '‚ùå Cancelar',
        'btnReschedule': 'üìÖ Reprogramar',
        'btnDone': '‚úÖ Realizado',
        'lblNewDate': 'Nueva Fecha y Hora (Reprogramaci√≥n):',
        'btnRequestReschedule': 'Solicitar Reprogramaci√≥n',
        'titleFinishReturn': 'Finalizar y Agendar Retorno',
        'lblReturnDate': 'Fecha/Hora del Retorno (Deje vac√≠o para finalizar sin retorno):',
        'lblPayerSource': 'Seleccione la fuente de pago del retorno:',
        'optPublic': 'P√∫blico',
        'optInsurance': 'Seguro',
        'optPrivate': 'Particular',
        'btnConfirmCompletion': 'Confirmar Finalizaci√≥n',
        'btnCancelText': 'Cancelar',

        //notifica√ß√£o
        'alertTitle': 'Alerta del Cuidador',
        'alertBody': '¬°Verifique al paciente!',
        'msgAlertTriggered': 'üö® ¬°Alerta!',

        //cancela
        'titleFreeMode': 'Modo Gratuito activado..',
        'msgPlanCanceled': 'Plan cancelado con √©xito.',
        'msgCancelFailed': 'Fallo al cancelar.',
        'msgConnectionErrorCancel': 'Error de conexi√≥n al intentar cancelar.',
        // Existing
        'btnProcessing': 'Procesando...',
        'modalErrorTitle': 'Fallo',
        'msgUserNotAuth': 'Error: Usuario no identificado. Inicie sesi√≥n nuevamente.',
        'msgErrorPrefix': 'Error: ',

        //fluxo de pagamento
        'msgErrCardFormNotLoaded': 'Error: El formulario de pago no carg√≥ correctamente. Recargue la p√°gina.',
        'modalAttentionTitle': 'Atenci√≥n',
        'msgFillCardData': 'Por favor, complete los datos para continuar.',
        'btnValidatingCard': 'Validando Tarjeta...',
        'titleWelcome': '¬°Bienvenido!',
        'msgPremiumWelcome': 'üéâ ¬°Bienvenido! Su jornada premium ha comenzado.',
        'msgGenericError': 'Ocurri√≥ un error al procesar la suscripci√≥n.',

        //confirma senha
        'msgPassMinLength': 'La contrase√±a debe tener al menos 6 caracteres.',
        'msgPassResetSuccess': '¬°√âxito! Use su nueva contrase√±a para entrar.',
        'modalResultTitle': 'Resultado',
        // Backend Codes
        'TOKEN_INVALID': 'El token de recuperaci√≥n es inv√°lido o ha expirado.',
        'TOKEN_EXPIRED': 'Este enlace ha expirado. Solicite uno nuevo.',
        // Existing
        'btnSaving': 'Guardando...',
        'modalSuccessTitle': '√âxito',
        'modalErrorTitle': 'Fallo',
        'msgConnectionError': 'Error de conexi√≥n.',

        //nova senha
        'msgEnterEmail': 'Por favor, introduzca su correo electr√≥nico.',
        'btnSendLink': 'Enviar Enlace',
        // Backend Codes
        'EMAIL_SENT': 'Se ha enviado un enlace de recuperaci√≥n a su correo.',
        'USER_NOT_FOUND': 'No encontramos una cuenta con este correo.',
        'EMAIL_INVALID': 'Formato de correo inv√°lido.',
        // Existing
        'btnSending': 'Enviando...',
        'modalSuccessTitle': '√âxito',
        'modalErrorTitle': 'Error',
        'msgConnectionError': 'Error de conexi√≥n.',

        //excluir
        'btnProcessing': 'Procesando...',
        'titleDone': 'Listo',
        'msgAccountDeleted': 'Cuenta eliminada. Lamentamos verte partir.',
        'msgDeleteErrorPrefix': 'Error al eliminar cuenta: ',

        //contato
        'btnSending': 'Enviando...',
        'modalThankYouTitle': 'Gracias',
        'msgMessageSent': '¬°Mensaje enviado con √©xito!',
        'msgSendErrorPrefix': 'Error al enviar: ',
        'msgTryAgain': 'Int√©ntelo de nuevo.',
        'contactTitle': 'Cont√°ctenos',
        'contactDesc': '¬øTiene alguna duda, sugerencia o encontr√≥ un problema? Env√≠e un mensaje a nuestro equipo.',
        'labelSubject': 'Asunto',
        'labelMessage': 'Mensaje',
        'optSelectSubject': 'Seleccione un asunto...',
        'optDoubt': 'Duda',
        'optPraise': 'Elogio',
        'optSuggestion': 'Sugerencia',
        'optBug': 'Problema T√©cnico / Bug',
        'optOthers': 'Otros Asuntos',
        'phMessage': 'Escriba su mensaje aqu√≠ con el mayor detalle posible...',
        'btnCancel': 'Cancelar',
        'btnSendMessage': 'Enviar Mensaje',

        //financeiro
        'msgConnectionError': 'Error de conexi√≥n.',

        //abandonar
        'msgNoPatientToAbandon': 'Ning√∫n paciente seleccionado para abandonar.',
        'defaultPatientName': 'Paciente',
        'msgErrPatientIdMissing': 'Error: ID del paciente no encontrado en el estado.',
        'msgErrSessionMissing': 'Error: Sesi√≥n del cuidador no encontrada. Inicie sesi√≥n nuevamente.',
        'titleDone': 'Est√° hecho',
        'msgAbandonSuccess': 'Has dejado de cuidar a este paciente.',
        'msgErrorPrefix': 'Error: ',

        //intera√ß√µes
        'medIntervalSN': 'S/N',
        'medIntervalPrefix': 'Cada',
        'medIntervalSuffix': 'horas',
        'medIntervalHours': '',
        'msgNoActiveMeds': 'Ning√∫n medicamento activo registrado.',
        'msgNoInactiveMeds': 'Ning√∫n inactivo reciente.',
        'msgNoAlerts': 'Sin alertas internas.',
        'statusAttention': 'Atenci√≥n Necesaria',
        'statusExcellent': '¬°Excelente!',
        'statusRegular': 'Regular',
        'titlePharmacy': 'üíä Gesti√≥n Farmac√©utica',
        'titleActive': 'Activos',
        'tagInUse': 'En uso',
        'titleAlerts': 'Alertas Farmac√©uticas',
        'btnCheckInteractions': 'Verificar Interacciones (IA)',
        'tooltipNeedMeds': 'Necesario 2+ medicamentos',
        'titleHistory': 'Historial Reciente',
        'msgHistoryDisclaimer': '"El valor total consumido dividido por la capacidad del frasco indica el consumo real."',
        'titleAdherence': 'Adherencia al Tratamiento',
        'lblEfficiency': 'Eficiencia Administrada',
        'lblDoses': 'dosis',
        'msgBasedOn30Days': 'Basado en los √∫ltimos 30 d√≠as.',
        'titleConsolidated': 'üìä Consumo Consolidado',
        'colItem': '√çtem',
        'colDoses': 'Dosis',
        'colTotal': 'Total',
        'msgLoading': 'Cargando...',
        'titleFrequencyChart': 'üìà Gr√°fico de Frecuencia',
        'btnAnalyzing': 'Analizando...',
        'lblAnalysisResult': 'Resultado del An√°lisis',
        'lblSource': 'Fuente',
        'msgSelectPatientVerification': 'Seleccione un paciente para realizar la verificaci√≥n.',
        'msgConnectionErrorVerification': 'Fallo en la conexi√≥n.',
        'msgNoInteractions': 'ninguna interacci√≥n', // Ajuste conforme retorno da sua API em ES

        // geo tmo
        'msgMissingLocationName': 'Por favor, ingrese el nombre del Lugar.',
        'msgSessionError': 'Error de Sesi√≥n: No se pudo identificar usuario/paciente.',
        'btnSave': 'Guardar',
        'btnSaving': 'Guardando...',
        'msgLocationUpdated': '‚úÖ ¬°Ubicaci√≥n actualizada!',
        'msgServerRefused': '‚ö†Ô∏è El servidor rechaz√≥: ',
        'gpsSearching': 'üìç Buscando datos...',
        'gpsConfirming': 'üìç Confirmando GPS...',
        'gpsUpdated': 'üìç Ubicaci√≥n GPS Actualizada',
        'gpsOffline': 'üìç Usando √∫ltima ubicaci√≥n conocida (GPS Off)',
        'labelHomePatient': 'Casa del Paciente',
        'tmoStatusNone': 'Ninguna limpieza registrada anteriormente.',
        'tmoBtnDoChecklist': 'Realizar Lista de Limpieza Terminal',
        'tmoStatusDays': '√öltima limpieza: hace {days} d√≠as (Meta: {freq} d√≠as).',
        'tmoBtnExpired': '‚ö†Ô∏è ATENCI√ìN: Limpieza Vencida',
        'tmoBtnOk': 'Limpieza al d√≠a. ¬øRealizar nueva?',
        'tagActionRequired': 'Acci√≥n Necesaria',

        // graficos
        'msgNoHydricData': 'No se encontraron datos para el per√≠odo.',
        'typeOralLiquids': 'L√≠quidos Orales',
        'typeIVEtheral': 'IV/Enteral (Medicaci√≥n)',
        'typeExcretion': 'Excreci√≥n (Orina/V√≥mito/Drenaje)',
        'typeInsensible': 'P√©rdida Insensible (Est.)',
        'labelSummary': 'Resumen',
        'tooltipViewNote': 'Toque para ver la nota',
        'labelViewNote': 'Ver nota',
        'msgNoHydricRecords': 'No se encontraron registros de entrada o salida para el per√≠odo.',
        'msgNoMealData': 'No se encontraron datos de comidas o excreci√≥n s√≥lida en el per√≠odo.',
        'labelIntakeG': 'Ingesta (g)',
        'labelOutputG': 'Salida (Heces, g)',
        'labelDay': 'D√≠a',
        'labelMassG': 'Masa (g)',
        'msgNoData': 'Sin datos',
        'statusEvaluation': 'En Evaluaci√≥n',
        'statusHighRisk': '‚ö†Ô∏è ¬°Riesgo Alto!',
        'statusAdequate': '‚úÖ Adecuado',
        'labelWeight': 'Peso (kg)',
        'labelBMI': 'IMC',
        'labelAbdominalCirc': 'Circ. Abdominal (cm)',
        'labelHighRiskLimit': 'L√≠mite Riesgo Alto',
        'labelCirc': 'Circ. (cm)',

        'msgNoPatientSelected': 'Ning√∫n paciente seleccionado',
        'msgUserNotAuth': 'Usuario no autenticado.',
        'msgNicknameRequired': 'El apodo del cuidador es obligatorio.',
        'msgSavingSettings': 'Guardando configuraciones...',
        'msgSettingsSaved': '‚úÖ ¬°Configuraciones guardadas y aplicadas!',
        'msgSettingsSaveFail': 'Fallo al guardar configuraciones.',
        'msgNoFileSelected': 'Ning√∫n archivo seleccionado.',
        'msgSavingAvatar': 'Guardando nuevo avatar...',
        'msgAvatarUpdated': '‚úÖ ¬°Avatar actualizado con √©xito!',
        'msgAvatarUploadFail': 'Fallo al cargar el avatar.',

        // agenda
        'msgSyncData': 'Sincronizando datos cl√≠nicos...',
        'tmoRequiredTitle': 'Limpieza Terminal Necesaria',
        'tmoLastCleaning': '√öltima limpieza hace <b>{days} d√≠as</b>. (Meta: cada {freq} d√≠as).',
        'tmoChecklistBtn': 'Lista',
        'catIssueFlush': 'Lavado/Salinizaci√≥n (Vence hoy o vencido)',
        'catIssueDressing': 'Cambio de Ap√≥sito (Vence hoy o vencido)',
        'catMaintTitle': 'Mantenimiento: ',
        'msgAppointmentsToday': '<b>Atenci√≥n:</b> ¬°Hay <span class="font-bold">{count}</span> cita(s) hoy!',
        'msgAllClear': '‚ú® ¬°Todo tranquilo! Sin pendientes por el momento.',

        //medicacoes
        'msgMedTakenSuccess': 'Medicaci√≥n {med} tomada con √©xito. üíä',
        'lblInfusion': 'Infusi√≥n',
        'lblAgendaId': 'ID Agenda',
        'msgTimeCalcAuto': 'Tiempo calculado autom√°ticamente',
        'msgDoseNeglected': '‚ùå Medicaci√≥n ignorada o suspendida. -10% de probabilidad.',
        'msgAllMedsTaken': '¬°Las medicaciones est√°n al d√≠a!',
        'optNone': 'Ninguno',
        'payerPublic': 'P√∫blico',
        'statusActive': 'Activa',
        'msgDoseSuspendedObs': 'Dosis suspendida y registrada con observaci√≥n.',
        'msgDoseRegisteredObs': 'Dosis registrada con observaci√≥n.',
        'msgDoseActionError': 'ERROR: Fallo al registrar la acci√≥n de {status}.',
        'modalSuccessTitle': '√âxito',
        'modalErrorTitle': 'Error',
        'msgConnectionError': 'Error de conexi√≥n con el servidor.',

        //bomba
        'defaultMedName': 'Medicamento',
        'msgInvalidTime': 'Tiempo de aplicaci√≥n inv√°lido.',
        'msgSaveInfusionError': 'Aviso: Error de conexi√≥n al guardar inicio de infusi√≥n (el temporizador funcionar√° localmente).',
        'msgSaveObsError': 'Fallo al guardar la evaluaci√≥n de la infusi√≥n en el historial.',
        'msgSaveObsNetworkError': 'Error de conexi√≥n al guardar la evaluaci√≥n.',
        'optSelectEvaluation': 'Seleccione una evaluaci√≥n...',
        'msgEvalRegistered': 'Evaluaci√≥n registrada: ',
        'msgThankYou': ' ü§© ¬°Gracias!',
        // Opciones de Evaluaci√≥n
        'evalOptionDelay': '‚è≥üíâ problema: bomba infundiendo [retrasada m√°s de 5 minutos]',
        'evalOptionEarly': '‚è∞ü™´ problema: bomba termin√≥ antes [medicaci√≥n aplicada totalmente]',
        'evalOptionEarlyLeftover': '‚è∞üîã problema: bomba termin√≥ antes [a√∫n queda medicaci√≥n]',
        'evalOptionPerfect': '‚è±Ô∏èü™´ ¬°Perfecto! [tiempo y medicaci√≥n seg√∫n lo programado]',
        'optSelectProblem': 'Seleccione un problema...',
        // Etiquetas de Problemas
        'probLabelOcclusion': 'Mensaje en pantalla: Oclusi√≥n en el equipo',
        'probLabelAir': 'Mensaje en pantalla: Aire en el equipo',
        'probLabelBattery': 'Mensaje en pantalla: Bater√≠a baja',
        'probLabelKVO': 'KVO o Fin de infusi√≥n',
        // Pasos
        'stepSilence': '1- Presione el bot√≥n silenciar en la bomba para tener dos minutos de silencio',
        'stepCheckKink': '2- Verifique si el equipo o cat√©ter no est√° doblado o pinzado',
        'stepCheckFit': '2- Verifique si el equipo est√° bien colocado en la bomba',
        'stepCallNurse': '3- Llame a enfermer√≠a',
        'stepCheckPower': '2- Desenchufe y vuelva a enchufar el cable de energ√≠a de la bomba',
        'stepCallNurseIfFail': '3- Si no se resuelve, llame a enfermer√≠a',
        'stepTurnOffClose': '2- Apague la bomba y cierre la pinza del cat√©ter/equipo',
        'labelMedication': 'Medicaci√≥n',
        'labelVolumeAbbr': 'Vol',
        'labelFlowAbbr': 'Flujo',
        'btnSolveProblem': '¬øSolucionar un problema?',
        'btnCloseProblem': 'Cerrar problema',
        'btnEvaluation': 'Evaluaci√≥n de conclusi√≥n',
        'btnCloseEvaluation': 'Cerrar evaluaci√≥n',
        'btnUnderstood': 'Entendido',
        'msgInfusionWarning': 'Aviso: Prep√°rese para silenciar la bomba antes de que suene para preservar el sue√±o/descanso del paciente.',
        'statusFinished': 'Finalizado',
        'msgInfusionFinished': 'Infusi√≥n finalizada.',
        'msgInfusionStarted': 'Infusi√≥n de {med} iniciada. Puede iniciar la bomba de infusi√≥n ahora.üìü',
        'msgCalcFillTwo': 'Por favor, complete al menos dos de los tres campos para calcular el tercero.',
        'msgCalcInvalidTime': 'Valores inv√°lidos para el c√°lculo del tiempo.',
        'msgCalcVolOrFlow': 'Ingrese al menos el volumen o el flujo para calcular el otro campo.',
        'modalErrorTitle': 'Error',
        'modalSuccessTitle': '√âxito',
        'modalWarningTitle': 'Aviso',
        'msgSelectPatient': 'Seleccione un paciente.',
        'msgFillMedFields': 'Complete los campos obligatorios: Nombre, Dosis y Unidad.',
        'msgMedSavedId': '¬°Medicamento registrado con √©xito! ID: {id}',
        'msgAgendaCreated': 'üìÖ Agenda creada:',
        'msgTasksAdded': '‚úÖ {count} tarea(s) a√±adida(s)',
        'msgTasksExisting': '‚ÑπÔ∏è {count} tarea(s) ya existente(s)',
        'msgWarnings': '‚ö†Ô∏è Avisos:',
        'msgAgendaErrorBackend': 'pero hubo un problema al crear la agenda: {error}',
        'msgAgendaErrorNetwork': 'pero no fue posible crear la agenda autom√°ticamente.',
        'msgMedSaveFail': 'Fallo al registrar medicamento.',
        'msgConnectionError': 'Error de conexi√≥n. Intente nuevamente.',

        //geo
        'locWarningFar': '‚ö†Ô∏è Lejos del Lugar',
        'locDistanceLabel': 'Distancia:',
        'shiftEndReasonFar': 'Sali√≥ del per√≠metro',

        //escala
        'shiftLocationTitle': 'Atenci√≥n a la Ubicaci√≥n',
        'shiftLocationMsg': '¬°Hola! ¬øEst√°s al lado del paciente? Si es as√≠, recuerda informar la ubicaci√≥n actual. Se pondr√° negra una vez guardada.',
        'shiftSuccessTitle': 'Hora del Show',
        'shiftSuccessMsg': '‚úÖ Acura est√° en tus manos: ¬°Cuida con cari√±o, en el hospital o en casa! Importante: mant√©n la pantalla activa para recibir notificaciones.',
        'modalWarningTitle': 'Aviso',
        'msgShiftStartError': 'No se pudo iniciar el turno.',
        'msgConnectionErrorShift': 'Error de conexi√≥n al iniciar el turno.',

        //celebra√ß√£o diaria
        'modalCongratsTitle': 'üèÜ ¬°Felicidades!',
        'msgAllTasksCompleted': '¬°Completaste todas las {total} tareas del d√≠a!\n\nProbabilidad de recuperaci√≥n: {prob}%\n\n¬°Sigue con este excelente trabajo! üí™',
        'celMsg1': 'üéâ ¬°Felicidades! ¬°Tarea completada!',
        'celMsg2': '‚≠ê ¬°Excelente trabajo!',
        'celMsg3': 'üëè ¬°Muy bien! ¬°Sigue as√≠!',
        'celMsg4': '‚ú® ¬°Genial! ¬°Est√°s cuidando bien!',
        'celMsg5': 'üåü ¬°Perfecto! ¬°Otra tarea lista!',
        'celMsg6': 'üí™ ¬°Eso es! ¬°Lo lograste!',

        'defaultPatientName': 'su paciente',
        'aiWelcomeMsg': '¬°Hola! Soy el Dr. IA, su asistente m√©dico virtual. üë®‚Äç‚öïÔ∏è\n\nEstoy aqu√≠ para ayudar con orientaciones sobre el cuidado de {patientName}.\n\n¬øC√≥mo puedo ayudarle hoy?',
        'msgNoPatients': 'No se encontraron pacientes.',
        'metaCureProb': 'Probabilidad de Cura',
        'metaChronicIndex': '√çndice de Control-Cronicidad',
        'metaBridgeTherapy': 'Rendimiento de Terapia Puente',
        'metaPalliative': 'Indicador de Confort Paliativo',

        //TMO
        'tmoTitle': 'Lista de Limpieza - Habitaci√≥n TMO',
        'tmoWarningPPE': '‚ö†Ô∏è EPP Obligatorio: Bata, guantes, mascarilla, gorro y cubrecalzado.',
        'tmoWarningImmuno': '‚ö†Ô∏è Atenci√≥n: Paciente inmunosuprimido. Respete el tiempo de acci√≥n (10 min).',
        'lblProgress': 'Progreso:',
        'btnFinishRegister': 'Finalizar y Registrar',
        // Categor√≠as
        'tmoCatPrep': 'PREPARACI√ìN',
        'tmoCatSurface': 'SUPERFICIES (Techo y Paredes)',
        'tmoCatLightVent': 'ILUMINACI√ìN Y VENTILACI√ìN',
        'tmoCatFurniture': 'MOBILIARIO Y EQUIPOS',
        'tmoCatBath': 'BA√ëO (√Årea Cr√≠tica)',
        'tmoCatFloor': 'SUELO (√öltima Etapa)',
        'tmoCatFinal': 'FINALIZACI√ìN Y VERIFICACI√ìN',

        // √çtems
        'tmoItemHands': 'Higiene de manos realizada seg√∫n protocolo',
        'tmoItemPPE': 'EPP completo colocado',
        'tmoItemSupplies': 'Disponibilidad de productos adecuados',
        'tmoItemMaterials': 'Materiales preparados (pa√±os, MOP, alcohol 70%, desinfectante)',
        'tmoItemTrash': 'Retiraron toda la basura del paciente anterior',
        'tmoItemLinens': 'Retiraron ropa de cama y cortinas',
        'tmoItemPaint': 'Paredes y muebles pintados y sin da√±os',
        'tmoItemCeiling': 'Techo limpiado con pa√±o h√∫medo y desinfectante',
        'tmoItemWalls': 'Paredes limpiadas de arriba a abajo',
        'tmoItemCobwebs': 'Verificaron ausencia de telara√±as/polvo',
        'tmoItemLights': 'L√°mparas limpiadas (externa/interna)',
        'tmoItemACGrills': 'Rejillas de aire acondicionado limpiadas',
        'tmoItemHEPACheck': 'Sistema de presi√≥n positiva/HEPA verificado',
        'tmoItemSwitches': 'Interruptores limpiados con alcohol 70%',
        'tmoItemWindows': 'Ventanas selladas, con cortinas y bloqueadas',
        'tmoItemServiceLight': 'Iluminaci√≥n de servicio indirecta limpia y funcional',
        'tmoItemBed': 'Cama: colch√≥n, barandillas, manivelas, ruedas',
        'tmoItemBedTable': 'Mesa de noche (todas las superficies)',
        'tmoItemMealTable': 'Mesa auxiliar y de comida',
        'tmoItemChair': 'Silla/sill√≥n y Soporte de suero',
        'tmoItemPumps': 'Bombas de infusi√≥n y Monitores',
        'tmoItemCables': 'Term√≥metros, cables (SpO2/ECG), manguito PNI',
        'tmoItemRemote': 'Control remoto de TV limpiado',
        'tmoItemToilet': 'Inodoro (completo con tapa y asiento)',
        'tmoItemSink': 'Lavabo, grifo, cuba y encimera',
        'tmoItemShower': 'Ducha, paredes y suelo',
        'tmoItemBathTrash': 'Papelera (limpiar y cambiar bolsa)',
        'tmoItemDrains': 'Desag√ºes (limpiar y desinfectar)',
        'tmoItemSupports': 'Barras de apoyo/soportes',
        'tmoItemFilters': 'Filtros de agua cambiados (protecci√≥n hongos)',
        'tmoItemBathWindows': 'Ventanas selladas y bloqueadas permanentemente',
        'tmoItemSweep': 'Barrido/aspirado con filtro HEPA',
        'tmoItemMop': 'MOP h√∫medo usado (T√©cnica 2 cubos)',
        'tmoItemMotion': 'Movimientos en "S" u "8"',
        'tmoItemCorners': 'Esquinas y rodapi√©s redondeados y sin da√±os',
        'tmoItemOdors': 'Verificaron olores y puntos negros (sin moho)',
        'tmoItemRefill': 'Cambiaron bolsas de basura y repusieron insumos',
        'tmoItemCleanLinens': 'Instalaron ropa de cama limpia',
        'tmoItemFinalHEPA': 'Re-verificaron Filtro HEPA y Presi√≥n',
        'tmoItemDust': 'Ausencia total de polvo visible',
        'tmoItemSign': 'Colocaron cartel "Habitaci√≥n Higienizada"',
        'tmoItemDispenser': 'Dispensadores reabastecidos',
        'tmoItemTemp': 'Climatizaron la habitaci√≥n (21-23¬∫C)',
        'tmoItemFridge': 'Frigobar ajustado (2-5¬∫C)',

        // Checklist Items
        'chkSurface': 'Superficies Altas (L√°mparas, Porta sueros)',
        'chkBed': 'Cama y Colch√≥n (Fricci√≥n unidireccional)',
        'chkEqp': 'Equipos (Bombas, Monitores)',
        'chkBath': 'Ba√±o (Lavabo, Inodoro, Ducha)',
        'chkFloor': 'Suelo (T√©cnica de dos cubos)',

        //atualiza√ß√£o
        'updateTitle': '¬°Nueva versi√≥n disponible! üöÄ',
        'updateMsgDefault': 'Nuevas funcionalidades a√±adidas.',
        'btnUpdateNow': 'Actualizar Ahora',
        'btnUpdateLater': 'Despu√©s',

        //cateter
        'catTitle': 'Gesti√≥n de Accesos Venosos (Cat√©ter)',
        'tabCatActive': 'Cat√©teres Activos',
        'tabCatAdd': 'A√±adir Nuevo',
        'loading': 'Cargando...',
        'catSecDevice': 'Datos del Dispositivo',
        'catLabelType': 'Tipo de Cat√©ter',
        'optCVCJug': 'CVC Yugular',
        'optCVCSub': 'CVC Subclavia',
        'optCVCFem': 'CVC Femoral',
        'catLabelManuf': 'Fabricante',
        'catLabelSite': 'Sitio de Acceso',
        'optArmR': 'Brazo Derecho',
        'optArmL': 'Brazo Izquierdo',
        'optJugR': 'Yugular Derecha',
        'optJugL': 'Yugular Izquierda',
        'optSubR': 'Subclavia Derecha',
        'optSubL': 'Subclavia Izquierda',
        'optFemR': 'Femoral Derecha',
        'optFemL': 'Femoral Izquierda',
        'optThorax': 'Regi√≥n Tor√°cica',
        'catLabelLumens': 'L√∫menes',
        'catLabelGauge': 'Calibre (Fr)',
        'catLabelLen': 'Long. (cm)',
        'catSecInsert': 'Datos de Inserci√≥n',
        'catLabelDate': 'Fecha Inserci√≥n',
        'catLabelMethod': 'M√©todo',
        'optUltrasound': 'Ultrasonido',
        'optDissection': 'Disecci√≥n',
        'optFluoro': 'Fluoroscopia',
        'catLabelXray': 'Confirmaci√≥n RX',
        'optRxYes': 'S√≠ - Adecuado',
        'optRxReposition': 'S√≠ - Reposicionar',
        'optRxNo': 'No Realizado',
        'catLabelIssues': 'Intercurrencias',
        'phOptional': 'Opcional',
        'catSecMaint': 'Protocolo de Mantenimiento',
        'catLabelFlush': 'Frec. Lavado (d√≠as)',
        'catLabelDressing': 'Frec. Ap√≥sito (d√≠as)',
        'btnSaveCat': 'Guardar Cat√©ter',
        'chkTitle': 'Lista de Verificaci√≥n de Mantenimiento',
        'chkHands': 'Higiene de manos',
        'chkPPE': 'Uso de EPP (Guantes est√©riles/Mascarilla)',
        'chkSite': 'Inspecci√≥n del Sitio (Sin signos inflamatorios)',
        'chkFlush': 'Lavado (Flush) realizado con t√©cnica as√©ptica',
        'chkConnector': 'Conector cambiado y etiquetado en cada luz',
        'chkReflux': 'Todos los l√∫menes con retorno sangu√≠neo',
        'chkDressing': 'Cambio de ap√≥sito realizado',
        'phAdditionalObs': 'Observaciones adicionales...',
        'btnConfirmMaint': 'Confirmar Realizaci√≥n',

        // pix
        'pixTitle': 'Pago v√≠a PIX',
        'pixDesc': 'Escanea el C√≥digo QR o usa la opci√≥n "Copia y Pega" en tu banco.',
        'pixLabelCopy': 'PIX Copia y Pega:',
        'btnCopyTooltip': 'Copiar',
        'btnPixPaid': 'Ya realic√© el pago',
        // 'closeButton' exists
        'msgPixCopied': '¬°C√≥digo PIX copiado!',
        'pixCopyTitle': 'Listo',
        'msgPixCopied': '¬°C√≥digo PIX copiado!',

        // cancelar plano
        'cancelPlanTitle': '¬øCancelar Plan Premium?',
        'cancelPlanDesc': 'Al cancelar, perder√°s acceso a funciones exclusivas al final del ciclo actual.',
        'btnConfirmCancelPlan': 'S√≠, cancelar suscripci√≥n',
        'btnKeepPlan': 'Mantener mi Premium',

        //Legado
        'legTitle': 'De la Rutina al Legado',
        'legSubtitle': 'Tu dedicaci√≥n cuenta una historia.',
        'legBody': 'Sabemos que el d√≠a a d√≠a es un desaf√≠o. Pero cada registro que haces aqu√≠ ‚Äî cada medicamento, cada observaci√≥n ‚Äî est√° construyendo la <b>Jornada Vital</b> del paciente.',
        'legAiTitle': '‚ú® Futuro con IA',
        'legAiBody': 'Al final del tratamiento, nuestra Inteligencia Artificial podr√° recopilar todos estos datos para generar un <b>Libro Digital</b> o un <b>Video de Memorias</b>, celebrando su fuerza y superaci√≥n.',
        'legQuote': '"Sigue registrando. Est√°s escribiendo una historia de amor y cuidado."',
        'btnContinueLeg': '¬°Entendido, seguir√© registrando!',

        // Cadastro de profissionais
        'profTitle': 'Registro de Profesional de Salud',
        'profLabelName': 'Nombre Completo',
        'profLabelEducation': 'Formaci√≥n',
        'optSelect': 'Seleccione',
        'optDoctor': 'M√©dico',
        'optNurse': 'Enfermero/a',
        'optTechNurse': 'T√©cnico en Enfermer√≠a',
        'optAuxNurse': 'Auxiliar de Enfermer√≠a',
        'profLabelPronoun': 'T√≠tulo / Pronombre',
        'optSelectPrefix': 'Seleccione (Dr/a, Enf...)',
        'profLabelCouncil': 'Consejo / Colegio',
        'profLabelCouncilNum': 'N¬∫ de Matr√≠cula',
        'phCouncilNum': 'Ej: 12345/BA',
        'optCouncil': 'Consejo',
        'profLabelEmail': 'E-mail',
        'profLabelPhone': 'Tel√©fono',
        'profLabelIsCaregiver': '¬øEste profesional ser√° Cuidador del Paciente?',
        'profDescIsCaregiver': 'Si se marca, el profesional tendr√° acceso a la selecci√≥n de pacientes, alertas y apoyo a la decisi√≥n.',
        'btnSaveProf': 'Guardar Profesional',

        // Abandonar paciente
        'abandonTitlePrefix': '¬øDejar de cuidar a',
        'abandonWarnTitle': 'Al confirmar:',
        'abandonWarn1': 'Perder√°s el acceso a este perfil.',
        'abandonWarn2': 'Los datos de salud y financieros NO se borrar√°n.',
        'abandonWarn3': 'Otros cuidadores vinculados seguir√°n teniendo acceso.',
        'abandonWarn4': 'Podr√°s volver buscando por el C√≥digo del Paciente.',
        'btnConfirmAbandon': 'S√≠, dejar',
        // 'cancelButton' exists

        // Finanzas & Derechos
        'finTitle': 'Control Financiero y Apoyo',
        'tabExpense': '‚ûï Nuevo Gasto',
        'tabRights': 'üí° Consejos y Derechos',
        'finPendingAlert': 'Pendientes encontrados (Clic para llenar):',
        'finLabelDesc': 'Descripci√≥n',
        'finPhDesc': 'Ej: Medicamento X...',
        'finLabelCategory': 'Categor√≠a',
        'optLoading': 'Cargando...',
        'finPackDetails': 'üì¶ Detalles del Envase',
        'finLabelType': 'Tipo',
        'optBottle': 'Frasco (L√≠quido)',
        'optPot': 'Pote (Crema/Polvo)',
        'optBox': 'Caja (Comprimidos)',
        'optAmpoule': 'Ampolla/Inyectable',
        'finLabelQty': 'Cant. √çtems',
        'finPhQty': 'Ej: 2',
        'finLabelContent': 'Contenido por √≠tem',
        'finPhContent': 'Ej: 350',
        'finLabelUnit': 'Unidad',
        'finLabelValue': 'Valor ($)',
        'finLabelDate': 'Fecha',
        'finLabelRecurring': 'Este es un gasto mensual recurrente',
        'btnSaveExpense': 'Guardar Gasto',
        'tipsTitle': 'Jornada de Derechos',
        'tipsSubtitle': 'Marque lo que ya conquist√≥ o inici√≥.',
        'tipsCountInitial': '0 de 0 √≠tems completados',
        'tipsLoading': 'Cargando lista...',
        'tipsFooter': '¬øDudas complejas? Hable con el Dr. IA o use el chat de cuidadores.',

        // Recuperar senha
        'forgotTitle': 'Recuperar Acceso',
        'forgotDesc': 'Ingrese su correo para recibir instrucciones.',
        'phYourEmail': 'tu@email.com',
        'btnSendLink': 'Enviar Enlace',
        'modalErrorTitle': 'Error',
        'modalResultTitle': 'Resultado',
        'msgEnterEmail': 'Ingrese su correo.',
        'btnSending': 'Enviando...',
        'msgConnectionError': 'Error de conexi√≥n.',
        'RESET_LINK_SENT': 'Si el correo est√° registrado, recibir√° las instrucciones en breve.',
        'INVALID_EMAIL_FORMAT': 'Formato de correo inv√°lido.',
        'SERVER_ERROR': 'Ocurri√≥ un error interno. Intente nuevamente m√°s tarde.',
        'resetPassTitle': 'Nueva Contrase√±a',
        'resetPassDesc': 'Crea una nueva contrase√±a segura.',
        'phNewPass': 'Nueva contrase√±a (m√≠n. 6 d√≠gitos)',
        'btnChangePass': 'Cambiar Contrase√±a',
        // Validations:
        'msgPassShort': 'La contrase√±a debe tener al menos 6 caracteres.',
        'msgPassChanged': '¬°Contrase√±a cambiada con √©xito! Inicie sesi√≥n.',

        // Relax
        // Static
        'breathTitle': 'Pausa para Respirar',
        'breathDesc': 'Escucha tu cuerpo. Siente tus latidos.<br>Sigue el ritmo visual para calmar tu mente.',
        'btnFinishBreath': 'Finalizar y Volver',

        // Dynamic (Animation)
        'breathInstrPrep': 'PREP√ÅRATE',
        'breathSubPrep': 'Vac√≠a tus pulmones...',
        'breathInstrIn': 'INHALA',
        'breathSubIn': 'Llena tus pulmones de aire...',
        'breathInstrHold': 'RET√âN',
        'breathSubHold': 'Mant√©n el aire dentro...',
        'breathInstrOut': 'EXHALA',
        'breathSubOut': 'Suelta despacio...',
        'msgBreathCelebration': 'Te tomaste un tiempo para ti. ¬°Felicidades!',

        //winback
        'winbackTitle': 'No silencies la campana ahora...',
        'winbackDesc': 'El tratamiento es un marat√≥n, no una carrera corta. Tus registros de hoy pueden salvar el ma√±ana.',
        'winbackOffer': '¬øQu√© tal 7 d√≠as gratis m√°s para pensarlo?',
        'btnAcceptWinback': 'Aceptar +7 D√≠as Gratis',
        'btnConfirmCancel': 'Entiendo, quiero cancelar',

        // Premium Modal
        'premTitle': 'Jornada de Superaci√≥n',
        'premSubtitle': 'No necesitas cargar el mundo solo. Ayudamos a organizar el cuidado para que te enfoques en el amor.',
        'premFeat1Title': 'Decisiones Seguras',
        'premFeat1Desc': 'Apoyo legal y m√©dico de la comunidad.',
        'premFeat2Title': 'Historial Vital',
        'premFeat2Desc': 'Gr√°ficos de evoluci√≥n para m√©dicos.',
        'premFeat3Title': 'C√≠rculo de Apoyo',
        'premFeat3Desc': 'Invita familiares ilimitados.',
        'premTestimonial': '"Esta app me dio fuerzas cuando pens√© que ya no ten√≠a."',
        'premTestimonialAuthor': '- Maria, cuidadora por 2 a√±os',
        'premBadgeTrial': 'Prueba Gratis Disponible',
        'premTrialTitle': 'Prueba 14 D√≠as Sin Costo',
        'premTrialDesc': 'Cancela cuando quieras. La campana de esperanza solo suena si t√∫ quieres.',
        'planMonthlyTitle': 'Mensual Flexible',
        'planMonthlySub': 'Cobrado mensualmente',
        'planAnnualTitle': 'Anual - Mejor Valor',
        'planAnnualSub': '/mes (Cobrado anualmente)',
        'planAnnualSave': 'AHORRA 40%',
        'planAnnualBonus': '+2 Meses de Bono',
        'payMethodSafe': 'M√©todo Seguro (Cobro tras 14 d√≠as)',
        'payBtnCard': 'Tarjeta de Cr√©dito',
        'payBtnPix': 'Pix (Brasil)',
        'lblCardNumber': 'N√∫mero de tarjeta',
        'lblExpiry': 'Vencimiento',
        'lblCVV': 'CVV',
        'lblCardName': 'Nombre en la tarjeta',
        'phCardName': 'Como impreso en la tarjeta',
        'lblCardEmail': 'Email del titular',
        'lblDocNumber': 'DNI / Documento',
        'btnPayCard': 'Pagar con tarjeta',
        'pixInst1': 'Al confirmar, generaremos un c√≥digo √∫nico.',
        'pixBonus': 'üéÅ ¬°+5 d√≠as de bono incluidos!',
        'btnGenCode': 'Generar C√≥digo',
        'pixGenerating': 'Generando QR Code seguro...',
        'pixScan': 'Escanee o Copie',
        'pixApproved': 'El pago se aprueba al instante.',
        'btnStartTrial': 'Iniciar 14 D√≠as Gratis',
        'lblSecure': 'üõí Seguro',
        'premDisclaimer': 'Al continuar, aceptas los T√©rminos. Renovaci√≥n autom√°tica. Cancela en l√≠nea cuando quieras.',
        // --- GENERAL / NAVEGACI√ìN ---
        'btnSkipTut': 'Omitir Tutorial',
        'btnNext': 'Siguiente',
        'btnBack': 'Atr√°s',
        'btnFinish': 'Finalizar',
        'appTitle': 'Sistema de Cuidadores',
        'closeButton': 'Cerrar',
        'backButton': 'Volver',
        'saveButton': 'Guardar',
        'cancelButton': 'Cancelar',
        'loading': 'Cargando...',
        'okButton': 'OK',
        'confirmationTitle': 'Confirmaci√≥n',
        'updateNeeded': 'Actualizaci√≥n necesaria',
        'checkInternet': 'Verifique su conexi√≥n a internet.',
        'observationTitle': 'üìù Observaci√≥n',
        'deleteAccountConfirmTitle': 'Eliminar Cuenta Permanentemente',
        'attentionLabel': 'Atenci√≥n:',
        'deleteWarning1': 'Al eliminar la cuenta, todos sus datos y registros de pacientes se perder√°n permanentemente.',
        'deleteWarning2': 'Esta acci√≥n no se puede deshacer.',
        'deleteWarning3': 'Acura ya no podr√° acompa√±ar su progreso ni el del paciente con ninguno de los servicios de soporte.',
        'deleteAccountConfirmBtn': 'Confirmar Eliminaci√≥n',
        'btnConfirm': 'Confirmar',
        'aiChatTitle': 'Dr. Inteligencia Artificial',
        'aiChatInputPlaceholder': 'Escriba su mensaje...',
        'caregiverChatTitle': 'Chat de Cuidadores',
        'labelViewConv': 'Ver Conversaciones:',
        'optChatPatientOnly': 'Solo Paciente Seleccionado',
        'optChatNearby': 'Cuidadores Cercanos (Radio 1 km)',
        'labelPatient': 'Paciente',
        'phMessageGeneric': 'Escriba su mensaje...',
        'ocrTitle': 'Lectura de Documento v√≠a C√°mara',
        'ocrDataFound': 'Datos Encontrados:',
        'btnSnap': 'Tomar Foto',
        'btnRetry': 'Intentar de Nuevo',
        'btnUseData': 'Usar Datos',
        'ocrStatusProcessing': 'Procesando imagen, espere...',
        'ocrStatusSuccess': '¬°Lectura completada!',
        'ocrStatusError': 'No se pudieron leer los datos. Intente de nuevo.',
        'ocrStatusNoText': 'Ning√∫n texto detectado.',
        'titleChangeAvatar': 'Cambiar Avatar',
        'descSelectImage': 'Seleccione una imagen de su dispositivo.',
        'btnUpload': 'Cargar',

        // --- UNIT
        'titlePhysicalMeasurements': 'Registro de Medidas F√≠sicas',
        'labelWeight': 'Peso',
        'labelHeight': 'Altura',
        'labelAbdCircumference': 'Circunferencia Abdominal',
        'labelNotes': 'Observaciones:',
        'phMeasurementNotes': 'Notas relevantes sobre las medidas...',
        'unitKg': 'kg',
        'unitLbs': 'lbs',
        'unitM': 'm',
        'unitFt': 'ft',
        'unitCm': 'cm',
        'unitIn': 'in',
        'msgUnitsChanged': 'Unidades de medida cambiadas a:',
        'system_metric': 'M√©trico (kg/m)',
        'system_imperial': 'Imperial (lbs/ft)',

        // --- LOGIN ---
        'loginPrompt': 'Ingresa con Google o usa email y contrase√±a.',
        'orSeparator': 'o',
        'emailLabel': 'Correo electr√≥nico',
        'phEmail': 'tu@email.com',
        'passwordLabel': 'Contrase√±a',
        'phPassword': 'Contrase√±a',
        'loginButton': 'Ingresar',
        'registerButton': 'Crear cuenta',
        'forgotPassword': '¬øOlvidaste tu contrase√±a?',
        'refreshScreen': 'Actualizar pantalla',

        // --- PERFIL CUIDADOR ---
        'caregiverProfileTitle': 'Perfil del Cuidador',
        'caregiverProfileDesc': 'Elige un apodo visible para otros cuidadores.',
        'caregiverNicknameLabel': 'Apodo',
        'phNickCaregiver': 'Ej: Juan (pap√°)',
        'caregiverRoleLabel': 'Eres:',
        'phRole': 'Cu√°l es tu relaci√≥n con el paciente',
        'saveCaregiverButton': 'Guardar y Continuar',

        // --- SELECCI√ìN PACIENTE ---
        'patientsTitle': 'Pacientes',
        'selectPatientDesc': 'Selecciona un paciente existente o crea uno nuevo.',
        'createPatientTitle': 'Crear Paciente',
        'patientNicknameLabel': 'Apodo del Paciente',
        'phNickPatient': 'Ej: Mar√≠a',
        'patientDobLabel': 'Fecha de Nacimiento',
        'patientIllnessLabel': 'Enfermedad / Condici√≥n',
        'phDisease': 'Ej: Leucemia',
        'phWeight': 'Peso (kg)',
        'phHeight': 'Altura (m)',
        'patientGenderLabel': 'G√©nero',
        'genderFemale': 'Femenino', 'genderMale': 'Masculino',
        'patientAllergiesLabel': 'Alergias',
        'phAllergies': 'Alergias (si las hay)',
        'savePatientButton': 'Registrar Paciente',
        'logoutButton': 'Cerrar Sesi√≥n',
        'enterCodeTitle': 'Ingresar con c√≥digo',
        'phCode': 'C√≥digo / ID del paciente',
        'careBtn': 'Cuidar',
        'dashboardBtn': 'Tablero', // ou Dashboard
        'noDiagnosis': 'Sin diagn√≥stico',

        // --- DASHBOARD ---
        'dashboardTabNutrition': 'Nutrolog√≠a',
        'dashboardTabPharmacy': 'Farmacia',
        'dashboardTabExams': 'Ex√°menes',
        'dashboardTabProcedures': 'Procedimientos',
        'dashboardTabFinance': 'Finanzas',
        'dashboardTabAchievements': 'Logros Diarios',
        'filterTimeframeLabel': 'Filtrar por:',
        'timeframe6h': '√öltimas 6 Horas', 'timeframe12h': '√öltimas 12 Horas', 'timeframeDay': 'D√≠a', 'timeframeWeek': 'Semana',
        'labelCaregiver': 'Cuidador:',

        // --- M√ìDULO NUTRICI√ìN ---
        'nutritionTitle': 'Nutrici√≥n e Hidrataci√≥n',
        'nutritionalBalanceTitle': 'üçé Balance Nutricional (S√≥lidos)',
        'physicalEvolutionTitle': 'Evoluci√≥n F√≠sica',
        'weightImcTitle': 'Evoluci√≥n de Peso e IMC',
        'lastWeight': '√öltimo Peso', 'lastImc': '√öltimo IMC',
        'abdominalCircTitle': 'Circunferencia Abdominal',
        'lastCirc': '√öltima Circ.', 'alertState': 'Alerta',
        'fluidBalanceTitle': 'Balance H√≠drico',
        'fluidIntake': 'Ingesta Total (mL)', 'fluidOutput': 'Eliminaci√≥n Total (mL)', 'fluidFinal': 'Balance Final (mL)',
        'fluidInsensibleLoss': 'P√©rdida Insensible Est.',
        'fluidDetailsTitle': 'Entradas y Salidas Detalladas',
        'tableHeaderDate': 'Fecha', 'tableHeaderType': 'Tipo', 'tableHeaderVolume': 'Volumen (mL)',

        // Strings Fragmentados
        'textBasedOn': '(Basado en ',
        'textDaysWith': ' d√≠as, siendo ',
        'textFeverDays': ' d√≠as con fiebre).',

        // Consejos Nutrici√≥n
        'tip1Label': 'üí° Consejo 1:',
        'tip1Body': 'Los datos mostrados se basan en registros manuales. Contin√∫e registrando la ingesta de l√≠quidos y las comidas usando los botones de la pantalla principal.',
        'tip2Label': 'üí° Consejo 2:',
        'tip2Body': 'Los alimentos que se lic√∫an (ej: helado, gelatina) reg√≠strelos como l√≠quido (en mL).',
        'tip3Label': 'üí° Consejo 3:',
        'tip3Body': 'Las Eliminaciones Intestinales (Heces) l√≠quidas se estiman y anotan en mL. Al pesar el pa√±al, considere 1g = 1ml. En el campo de notas, describa diarrea o heces l√≠quidas.',
        'tip4Label': 'üí° Consejo 4:',
        'tip4Body': 'Para m√°s informaci√≥n, consulte a un enfermero(a).',

        // --- EX√ÅMENES / PROCEDIMIENTOS ---
        'labResultsTitle': 'Resultados de Laboratorio',
        'labResultsDesc': 'Aqu√≠ se mostrar√°n los √∫ltimos resultados cr√≠ticos y la evoluci√≥n hist√≥rica.',
        'proceduresTitle': 'L√≠nea de Tiempo de Procedimientos',
        'phSearchFilter': 'Escribe para buscar...',
        // Titles
        'diaryTitle_food': 'Food Log',
        'diaryTitle_drinks': 'Drink/Hydration Log',
        'diaryTitle_pain': 'Pain/Satisfaction Log',
        'diaryTitle_sleep': 'Sleep',
        'diaryTitle_physio': 'Physiotherapy Session',
        'diaryTitle_excretion': 'Excretion Log',
        'diaryTitle_vitals': 'Vital Signs (Manual)',
        'diaryTitle_lab': 'Lab Exam',
        'titleImproveDiag': 'üß¨ Mejorar Diagn√≥stico',
        'labelQuickSearch': 'B√∫squeda R√°pida:',
        'phDiseaseFilter': 'Escriba para filtrar (ej: C√°ncer)...',
        'labelDiseaseType': 'Tipo de Enfermedad:',
        'grpMain': 'Principales',
        'grpFullList': 'Lista Completa (A-Z)',
        'labelSubtype': 'Subtipo / Mutaci√≥n (Opcional):',
        'phSubtype': 'Ej: Ph+, HER2, KRAS...',
        'btnSaveDiag': 'Guardar Diagn√≥stico',

        // Diseases
        'disLLA': 'Leucemia Linfobl√°stica Aguda (LLA)',
        'disLMA': 'Leucemia Mieloide Aguda (LMA)',
        'disLMC': 'Leucemia Mieloide Cr√≥nica (LMC)',
        'disHodgkin': 'Linfoma de Hodgkin',
        'disNonHodgkin': 'Linfoma No Hodgkin',
        'disMyeloma': 'Mieloma M√∫ltiple',
        'disBreast': 'C√°ncer de Mama',
        'disProstate': 'C√°ncer de Pr√≥stata',
        'disLung': 'C√°ncer de Pulm√≥n',
        'disAnal': 'C√°ncer Anal',
        'disBladder': 'C√°ncer de Vejiga',
        'disMouth': 'C√°ncer de Boca',
        'disHeadNeck': 'Cabeza y Cuello',
        'disCervical': 'C√°ncer de Cuello Uterino',
        'disColorectal': 'Colorrectal (Intestino)',
        'disUterine': 'C√°ncer de √ötero',
        'disEsophagus': 'C√°ncer de Es√≥fago',
        'disStomach': 'C√°ncer de Est√≥mago',
        'disLiver': 'C√°ncer de H√≠gado',
        'disGIST': 'GIST (Tumor del Estroma Gastrointestinal)',
        'disLarynx': 'C√°ncer de Laringe',
        'disNET': 'NET (Tumores Neuroendocrinos)',
        'disOvarian': 'C√°ncer de Ovario',
        'disPancreas': 'C√°ncer de P√°ncreas',
        'disSkinMelanoma': 'Piel - Melanoma',
        'disSkinNonMelanoma': 'Piel - No Melanoma',
        'disPenis': 'C√°ncer de Pene',
        'disKidney': 'C√°ncer de Ri√±√≥n',
        'disSarcoma': 'Sarcomas',
        'disCNS': 'Sistema Nervioso Central',
        'disTesticular': 'C√°ncer Testicular',
        'disThyroid': 'C√°ncer de Tiroides',
        'disVagina': 'C√°ncer de Vagina',
        'disGallbladder': 'Ves√≠cula Biliar',
        'disVulva': 'C√°ncer de Vulva',
        'disOther': 'Otro',

        // Labels
        'labelFoodQty': 'Food Quantity',
        'labelVolDose': 'Volume/Dose',
        'labelPainLevel': 'Pain Level | Discomfort (1-10)',
        'labelSatisfaction': 'Service Satisfaction (1-10)',
        'labelDuration': 'Duration',
        'labelSessionDuration': 'Session Duration',
        'labelLiquidExcretion': 'Urine|Vomit|Diarrhea (Liquid)',
        'labelSolidExcretion': 'Stool (Solid)',
        'labelHeartRate': 'Heart Rate (HR)',
        'labelRespRate': 'Respiratory Rate (RR)',
        'labelExamType': 'Exam Type',
        'labelResultMain': 'Main Result',
        'ocrTitle_monitor': 'Lectura de Signos Vitales (Monitor UCI)',
        'ocrTitle_blood': 'Lectura de Examen de Laboratorio',

        // Units
        'unitG': 'g (grams)',
        'unitMl': 'mL (milliliters)',
        'unitScale': 'Scale',
        'unitHours': 'h (hours)',
        'unitMin': 'min (minutes)',
        'unitBpm': 'bpm',
        'unitRpm': 'rpm',
        'unitExam': 'Exam',
        'unitGdl': 'g/dL',
        'unitMgdl': 'mg/dL',
        'unitUil': 'UI/L',

        // --- FINANZAS ---
        'financeTotalMonth': 'Total Gastado este Mes',
        'financeHistory': 'Historial de Gastos',
        'financeCaregiverContrib': 'Contribuci√≥n por Cuidador',
        'financeShiftLog': 'Registro de Turnos (Horas)',
        'msgNoChartData': 'No hay datos suficientes para el gr√°fico.',
        'tableHeaderDesc': 'Descripci√≥n', 'tableHeaderValue': 'Valor',
        'tableHeaderCaregiver': 'Cuidador', 'tableHeaderIn': 'Entrada', 'tableHeaderOut': 'Salida', 'tableHeaderDuration': 'Duraci√≥n',

        // --- MEN√ö CUIDADOR ---
        'myWellness': 'Mi Bienestar',
        'dailyProgress': 'Progreso Diario',
        'wellnessTip': 'Completa 4 comidas y 1 periodo de sue√±o para mantener tu bienestar al 100%',
        'actionRecordMeal': 'Registrar Comida',
        'actionRecordSleep': 'Registrar Sue√±o',
        'actionCalmDown': 'Calmarse',
        'subTextCalmDown': 'Alivio de ansiedad (4-7-8)',
        'actionFinanceControl': 'Control Financiero',
        'subTextFinance': 'Registro de gastos y beneficios',
        'actionTutorial': 'C√≥mo usar la App',
        'subTextTutorial': 'Repetir tutorial interactivo',
        'textPending': 'Pendiente',
        'textProgressToday': '0/4 hoy',

        // --- MEN√ö ACURA ---
        'termsConditions': 'T√©rminos y Condiciones',
        'privacyPolicy': 'Pol√≠tica de Privacidad',
        'contactUs': 'Cont√°ctanos',
        'manageSubscription': 'Gestionar Suscripci√≥n',
        'abandonPatient': 'Abandonar Paciente',
        'deleteAccount': 'Eliminar Mi Cuenta',
        'deleteAccountConfirmTitle': 'Eliminar Cuenta Permanentemente',
        'deleteAccountConfirmBtn': 'Confirmar Eliminaci√≥n',

        // --- PANTALLA PRINCIPAL ---
        'locationLabel': 'Ubicaci√≥n del Paciente',
        'locationResidence': 'Residencia',
        'locationHospital': 'Hospital',
        'taskProgress': 'Progreso',
        'survivalProb': 'Probabilidad',
        'survivalProbLabel': 'Probabilidad',
        'newAppointmentBtn': 'Nueva Cita',
        'todayAgenda': 'Agenda de Hoy',
        'btnMedications': 'Medicamentos',
        'btnIntravenous': 'Intravenosa',
        'btnAdvice': 'Consejo',
        'titleManageCatheter': 'Gestionar Acceso/Cat√©ter',
        'btnExitScene': 'Salir de escena',

        // --- TIMELINE ---
        'btnAddPro': '+ Registrar Prof. Salud',
        'phLocationGeneric': 'Ej: Consultorio 1 - Planta Baja',
        'phDoctorName': 'Nombre M√©dico/Enfermero',
        'phPhone': '(00) 0000-0000',
        'labelFasting': 'Ayuno (horas):',
        'optFasting0': '0 (No necesario)',
        'optFasting4': '4 horas',
        'optFasting6': '6 horas',
        'optFasting8': '8 horas',
        'optFasting12': '12 horas',
        'labelPaidBy': 'Pagado por:',
        'optPaySelect': 'Seleccione tipo de pago',
        'btnCreateAppt': 'Crear Cita',
        'titleCreateAppt': 'Crear Nueva Cita',
        'labelApptType': 'Tipo de Cita:',
        'optTypeConsultation': 'Consulta',
        'optTypeExam': 'Examen',
        'optTypeProcedure': 'Procedimiento',
        'labelDateTime': 'Fecha/Hora',
        'labelLocation': 'Ubicaci√≥n:',
        'labelHealthPro': 'Profesional de Salud:',
        'labelPhone': 'Tel√©fono:',
        'labelInstructions': 'Instrucciones de Preparaci√≥n:',
        'selectFastingPlaceholder': 'Seleccione tiempo de ayuno',

        // --- MODAL MEDICAMENTOS ---
        'newMedTitle': 'Registrar Nueva Medicaci√≥n',
        'phSearchMed': 'Escribe para buscar...',
        'titleCamRx': 'Leer receta v√≠a C√°mara',
        'medNameLabel': 'Nombre del Medicamento',
        'medRouteLabel': 'V√≠a de Administraci√≥n',
        'routeOral': 'Oral (Boca)', 'routeNaso': 'Nasog√°strica', 'routeIV': 'Intravenosa (IV)',
        'medDosageLabel': 'Dosis', 'medUnitLabel': 'Unidad',
        'phDosageUnit': 'mg, ml, gotas',
        'medDilutionLabel': 'L√≠quido de Diluci√≥n',
        'medDilutionVolLabel': 'Volumen de Diluci√≥n',
        'medFlowLabel': 'Flujo Programado (ml/h)',
        'medIntervalLabel': 'Tomar cada', 'hoursUnit': 'horas',
        'medStartLabel': 'Fecha/Hora Primera Dosis',
        'medDoctorLabel': 'M√©dico Prescriptor',
        'medSuspensionLabel': 'Fecha Prevista Suspensi√≥n',
        'medPayerLabel': 'Pagado por',
        'payerPublic': 'P√∫blico', 'payerInsurance': 'Seguro', 'payerPrivate': 'Privado',
        'medStatusLabel': 'Estado de Receta',
        'statusActive': 'Activa', 'statusSuspended': 'Suspendida',
        'savePrescriptionBtn': 'Guardar Receta',
        'labelVia': 'V√≠a',
        'labelDilution': 'Diluci√≥n',
        'labelFlow': 'Flujo',
        'btnIgnore': 'Saltar',
        'btnStart': 'Iniciar',

        // --- CALCULADORA INFUSI√ìN ---
        'calcVolume': 'Volumen Total (mL)',
        'phVol': 'Ej: 500',
        'calcFlow': 'Flujo (mL/h)',
        'phFlow': 'Ej: 100',
        'calcTime': 'Tiempo de Aplicaci√≥n',
        'phTimeH': 'Horas', 'phTimeM': 'Minutos', 'phTimeS': 'Segundos',
        'tipInfusionCalc': 'Consejo: Use 2 datos para calcular el 3¬∫',
        'btnCalculate': 'Calcular',
        'btnStartInfusion': 'Iniciar Infusi√≥n',
        'btnRestart': 'Reiniciar',
        'tipInfusionCalc': 'Consejo: Use 2 datos para calcular el 3¬∫',
        'phVol': 'Ej: 500',
        'phFlow': 'Ej: 100',
        'phTimeH': 'Horas',
        'phTimeM': 'Minutos',
        'phTimeS': 'Segundos',
        'btnRestart': 'Reiniciar',

        // --- MODAL IGNORAR DOSIS ---
        'ignoreActionTitle': 'Confirmaci√≥n de Acci√≥n',
        'textIgnoreMsg': 'Est√°s saltando la dosis programada.',
        'ignoreOnceBtn': 'Saltar SOLO AHORA',
        'subTextIgnoreOnce': 'No afecta dosis futuras.',
        'suspendRxBtn': 'Suspender Uso',
        'subTextSuspendRx': 'Cancela esta y todas las futuras.',
        'phIgnoreReason': 'Opcional: Describa el motivo...',
        'textIgnoreMsgPart1': 'Est√°s saltando la dosis de ',
        'textIgnoreMsgPart2': 'programada para las ',
        'ignoreOnceBtn': 'Saltar SOLO AHORA',
        'subTextIgnoreOnce': 'No afecta dosis futuras.',
        'suspendRxBtn': 'Suspender Uso',
        'subTextSuspendRx': 'Cancela esta y todas las dosis futuras.',
        'phIgnoreReason': 'Opcional: Describa el motivo...',

        // --- MODAL UBICACI√ìN ---
        'locHospitalName': 'Nombre del Lugar',
        'phLocHome': 'Casa de Paciente',
        'phLocSector': 'Ej: UCI 2',
        'phLocFloor': 'Ej: 5¬∫',
        'phLocBed': 'Ej: 21B',
        'locSector': 'Sector', 'locFloor': 'Piso', 'locBed': 'Cama / Habitaci√≥n',
        'locAdmissionDate': 'Fecha de Ingreso',
        'labelTimeOnLoc': 'Tiempo en Lugar:',
        'unitDays': 'd√≠as',
        'locCleaningFreq': 'Frecuencia Limpieza Terminal (d√≠as)',
        'statusGPS': 'GPS esperando...',
        'btnSaveLocation': 'Guardar Ubicaci√≥n',
        'tipCleaningChecklist': 'Define la alerta para la lista de verificaci√≥n de TMO.',

        // --- HUB DE CUIDADO / CHAT ---
        'hubDiary': 'Diario',
        'hubLegacyAI': 'Legado IA',
        'labelDrAI': 'Dr. Inteligencia Artificial',
        'labelChatCare': 'Chat de Cuidadores',
        'labelViewChat': 'Ver Chats:',
        'optChatPatient': 'Solo Paciente Seleccionado',
        'optChatNear': 'Cuidadores Cercanos (Radio 1 km)',
        'phChatMsg': 'Escribe tu mensaje...',
        'hubWriteStory': 'Registra inseguridades, sustos, logros...',
        'btnReadStories': 'Leer Historias',
        'tooltipStories': '¬°Transforma el diario en un libro o pel√≠cula en el futuro!',
        'statusLoadingStories': 'Cargando historias...',
        'checkVisibleTeam': 'Visible para el equipo',
        'hubPublish': 'Publicar',
        'hubEmergency': 'Urgencias | UCI',
        'hubDecisions': 'Encuesta de Decisi√≥n',
        'hubNewDecision': 'Nueva Decisi√≥n',
        'msgNoDecisions': 'Sin decisiones pendientes.',
        'btnSendInvite': 'Enviar Invitaci√≥n',
        'hubAddMember': '+ Miembro',
        'hubEndJourney': 'Fin de la Jornada',
        'widgetSurvivorTitle': 'Trofeo Overall [Victoria]',
        'widgetSurvivorCalc': 'Calculando tiempo para la victoria...',
        'btnBackToCare': 'Volver a cuidar',
        'hubHeaderStatus': 'Hub de Atenci√≥n, Decisi√≥n y Evoluci√≥n',
        'btnSyncWearables': 'Sincronizar Wearables',
        'btnTransfusionRBC': 'Transfusi√≥n de Gl√≥bulos Rojos',
        'btnTransfusionPlatelets': 'Transfusi√≥n de Plaquetas',
        'btnTransfusionGranulo': 'Transfusi√≥n de Granulocitos',
        'btnMedAntipyretic': 'Medicaci√≥n Antit√©rmica',
        'btnGasOxygen': 'Gas Ox√≠geno',
        'statusLoadingHistory': 'Cargando historial...',
        'msgNoActiveDecisions': 'Ninguna activa',
        'labelDecisionTitle': 'T√≠tulo de la Decisi√≥n:',
        'phDecisionTitle': 'Ej: Cambio de Hospital',
        'labelDeadline': 'Fecha L√≠mite:',
        'labelDetails': 'Detalles:',
        'phDecisionDetails': 'Detalles, consentimiento, etc.',
        'labelVoteOptions': 'Opciones de Voto:',
        'phOption1': 'Opci√≥n 1 (Describa pros/contras)',
        'phOption2': 'Opci√≥n 2 (Describa pros/contras)',
        'phCaregiverEmail': 'Correo del cuidador',

        // --- BLE
        'bleTitle': 'Conectar Sensores',
        'btnScanBle': 'Escanear Dispositivo',
        'statusWaitingConnection': 'Esperando conexi√≥n...',
        'labelHR': 'FC', // Frecuencia Card√≠aca
        'labelTemp': 'TEMP',
        'labelSpO2': 'SpO2',
        'labelBP': 'PA', // Presi√≥n Arterial
        'bleErrorTitle': 'ERROR CR√çTICO: API Bluetooth no detectada.',
        'bleErrorHttps': '‚ö†Ô∏è El sitio no est√° en contexto seguro (HTTPS).',
        'bleErrorCausesTitle': '‚ö†Ô∏è Posibles causas:',
        'bleErrorCause1': '1. WebView desactualizado.',
        'bleErrorCause2': '2. Aplicaci√≥n en modo debug sin Chrome System WebView actualizado.',
        'bleErrorCause3': '3. Bluetooth desactivado en el dispositivo.',

        // --- CONFIGURACIONES ---
        'settingsTitle': 'Configuraciones',
        'tabSystem': 'Sistema',
        'tabCaregiver': 'Cuidador',
        'tabPatient': 'Paciente',
        'fontSizeLabel': 'Tama√±o de Letra',
        'languageLabel': 'Idioma de la App',
        'alarmLabel': 'Tono de Alarma',
        'alarmNone': 'Ninguno',
        'alarmSynth': 'Campana',
        'alarmBeepShort': 'Bip Corto',
        'alarmDigitalLong': 'Alarma Digital',
        'alarmMediumBell': 'Campana Mediana',
        'alarmPhoneRing': 'Tono de Tel√©fono',
        'unitsLabel': 'Unidades de Medida',
        'unitsMetric': 'Sistema M√©trico (m, ¬∞C)',
        'unitsImperial': 'Sistema Imperial (ft, ¬∞F)',
        'dataCollectionLabel': 'Recolecci√≥n de Datos (Temp/Hum.)',
        'themeLabel': 'Modo de Visualizaci√≥n',
        'themeAuto': 'Autom√°tico',
        'themeLight': 'Claro',
        'themeDark': 'Oscuro',
        'changeAvatarBtn': 'Cambiar Avatar',
        'improveDiagnosisBtn': 'Mejorar Diagn√≥stico',
        'phCard': '0000 0000 0000 0000',
        'titleCopyCode': 'Copiar C√≥digo',
        'settingsTitle': 'Configuraciones',
        'tabSystem': 'Sistema',
        'tabCaregiver': 'Cuidador',
        'tabPatient': 'Paciente',
        'fontSizeLabel': 'Tama√±o de Letra',
        'languageLabel': 'Idioma de la App',
        'langPt': 'Portugu√©s',
        'langEn': 'Ingl√©s',
        'langEs': 'Espa√±ol',
        'alarmLabel': 'Sonido de Alarma',
        'alarmNote': 'Ninguno',
        'alarmSynth': 'Campana',
        'alarmBeepShort': 'Beep Corto',
        'alarmDigitalLong': 'Alarma Digital',
        'alarmMediumBell': 'Campana Media',
        'unitsLabel': 'Unidades de Medida',
        'unitsMetric': 'Sistema Internacional (m, ¬∞C)',
        'unitsImperial': 'Sistema Imperial (ft, ¬∞F)',
        'dataCollectionLabel': 'Recolecci√≥n de datos (Temp/Hum.)',
        'themeLabel': 'Modo de Visualizaci√≥n',
        'themeAuto': 'Autom√°tico',
        'themeLight': 'Claro',
        'themeDark': 'Oscuro',
        'btnSaveSystem': 'Guardar Configuraci√≥n del Sistema',
        'changeAvatarBtn': 'Cambiar Avatar',
        'labelNickname': 'Apodo',
        'phNickname': 'Tu apodo',
        'labelRelation': 'Relaci√≥n con el Paciente',
        'btnSaveCaregiver': 'Guardar Perfil del Cuidador',
        'patientNicknameLabel': 'Apodo del Paciente',
        'phPatientNickname': 'Apodo del paciente',
        'msgNicknameLocal': 'El apodo es solo para visualizaci√≥n local.',
        'patientIllnessLabel': 'Enfermedad / Condici√≥n',
        'phIllness': 'Ej: Leucemia',
        'improveDiagnosisBtn': 'Mejorar Diagn√≥stico',
        'patientAllergiesLabel': 'Alergias',
        'phAllergies': 'Lista de alergias',
        'btnSavePatient': 'Guardar Perfil del Paciente',

        // --- EXAM
        'diaryTitle': 'Registrar Acci√≥n',
        'labelExamType': 'Tipo de Examen:',
        'optSelect': 'Seleccione...',
        'examHemogram': 'Hemograma',
        'examHepatic': 'Bioqu√≠mica Hep√°tica',
        'examRenal': 'Bioqu√≠mica Renal',
        'examElectrolytes': 'Electrolitos',
        'examLipid': 'Perfil Lip√≠dico',
        'examGlycemia': 'Glucemia/Metabolismo',
        'examCoagulation': 'Coagulaci√≥n',
        'examTumorMarkers': 'Marcadores Tumorales',
        'examProteins': 'Prote√≠nas/Inmunoglobulinas',
        'examHormones': 'Hormonas',
        'examUrine1': 'Orina tipo I (EAS)',
        'examUrine24h': 'Orina 24 horas',
        'examStool': 'Heces',
        'examVirology': 'Virol√≥gicos',
        'examCulture': 'Cultivo',
        'examCSF': 'L√≠quido Cefalorraqu√≠deo (LCR)',
        'examAscitic': 'L√≠quido Asc√≠tico',
        'examPleural': 'L√≠quido Pleural',
        'examImmunology': 'Inmunol√≥gicos',
        'examGasometry': 'Gasometr√≠a',
        'examGeneticsNGS': 'Gen√©tica NGS*',
        'examCytogenetics': 'Citogen√©tica y Moleculares*',
        'labelExamParameter': 'Par√°metro del Examen:',
        'phExamParameter': 'Ej: Plaquetas, Gl√≥bulos rojos',
        'labelUnit': 'Unidad de Medida:',
        'labelRefMin': 'Referencia (m√≠n):',
        'labelRefMax': 'Referencia (m√°x):',
        'labelExamResult': 'Resultado del Examen:',
        'optNotDetected': 'No detectado/Negativo',
        'optDetected': 'Detectado/Positivo',
        'labelValue1': 'Valor 1:',
        'labelValue2': 'Valor 2:',
        'labelSpO2': 'Oximetr√≠a (SpO2):',
        'phSpO2': 'Ej: 98',
        'labelBP': 'Presi√≥n Arterial (PA):',
        'phSystolic': 'Sist√≥lica',
        'phDiastolic': 'Diast√≥lica',
        'labelTemp': 'Temperatura:',
        'phTemp': 'Ej: 36.5',
        'labelNotes': 'Notas:',
        'phNotes': 'Reporte observaciones aqu√≠...',
        'btnOCR': 'Escanear con C√°mara',
        // Tutorial
        'tutIntroTitle': '¬°Hola! üíô',
        'tutIntroDesc': 'Bienvenido a tu espacio de apoyo. Preparamos una gu√≠a r√°pida para ayudarte a usar Acura App.',
        'tutMenuTitle': 'Men√∫ Acura',
        'tutMenuDesc': 'Toca el logo para acceder a t√©rminos legales y soporte.',
        'tutSettingsTitle': 'Configuraciones',
        'tutSettingsDesc': 'Personaliza tu experiencia aqu√≠: cambia tu avatar y el del paciente, por ejemplo.',
        'tutCaregiverTitle': 'Tu Bienestar',
        'tutCaregiverDesc': 'Aqu√≠ te cuidas a ti mismo. Registra tu sue√±o, comidas y toma descansos. ¬°Eres importante!',
        'tutCallCaregiversTitle': 'Llamar Cuidadores',
        'tutCallCaregiversDesc': 'Toca aqu√≠ para activar la alarma que alerta a los cuidadores de guardia.',
        'tutLocationTitle': 'Localizar Paciente',
        'tutLocationDesc': 'Al estar con el paciente, toca aqu√≠ para actualizar datos y ayudar a otros a localizarlo.',
        'tutProgressTitle': 'Progreso Diario',
        'tutProgressDesc': 'Sigue el desempe√±o con esta barra. Completarla al final del d√≠a confirma un buen cuidado.',
        'tutTimelineTitle': 'L√≠nea de Tiempo',
        'tutTimelineDesc': 'Aqu√≠ aparecer√°n eventos futuros como ex√°menes, procedimientos y citas.',
        'tutAddEventTitle': 'Agregar Evento',
        'tutAddEventDesc': '¬°Bot√≥n importante! √ösalo para recordar citas y procedimientos en la l√≠nea de tiempo.',
        'tutAgendaTitle': 'Compromisos de Agenda',
        'tutAgendaDesc': 'Cuando llega la hora, aqu√≠ aparecen los medicamentos y tareas del d√≠a.',
        'tutMedsTitle': 'Agregar Medicamentos',
        'tutMedsDesc': '¬°Otro bot√≥n importante! √ösalo para programar rutinas de administraci√≥n (consejo: consulta enfermer√≠a).',
        'tutPatientTitle': 'Paciente',
        'tutPatientDesc': 'Toca aqu√≠ para registrar historia, atenci√≥n de urgencia y obtener ayuda para decisiones.',
        'tutShieldTitle': 'Escudo de Protecci√≥n',
        'tutShieldDesc': 'El c√≠rculo completo indica que los cuidados prestados son significativos en la jornada.',
        'tutQuickLogTitle': 'Registro R√°pido',
        'tutQuickLogDesc': 'Los botones circulares sirven para registrar f√°cilmente alimentos y bebidas. ¬°Pru√©balo!',
        'tutCatheterTitle': 'Cat√©teres Activos',
        'tutCatheterDesc': 'Toca la flecha para registrar y gestionar cat√©teres para mantenerlos seguros.',
        'tutDrAITitle': 'Doctor IA',
        'tutDrAIDesc': 'Cuando necesites, chatea con Doctor IA sobre s√≠ntomas, dudas o consejos.',
        'tutChatHumanTitle': 'Chat con Cuidadores',
        'tutChatHumanDesc': 'Comparte cari√±o e informaci√≥n. Incentiva a otros cuidadores a usar Acura.',
        'tutDashboardTitle': 'Control v√≠a Dashboard',
        'tutDashboardDesc': '¬°En la pantalla de pacientes, ve informes como balance h√≠drico, ex√°menes y dosis!',
        'msgTutorialComplete': '¬°Est√°s listo! Cuenta con nosotros.',
        'tutcurrentTimeTitle': 'Agilidad en la Atenci√≥n',
        'tutcurrentTimeDesc': 'Adem√°s de la hora actual, conozca la agilidad del equipo de enfermer√≠a al finalizar cada infusi√≥n.',
        'tutProfessionalPresenceTitle': 'Reconozca a la Enfermer√≠a de Hoy',
        'tutProfessionalPresenceDesc': 'Registre aqu√≠ a cada enfermero presente hoy, aunque a√∫n no use Acura. As√≠ recibir√° reconocimiento futuro por su buen trabajo.',
        'tutOpenShareTitle': 'Comparta Acura Ahora',
        'tutOpenShareDesc': '¬°Invite a otros cuidadores y pacientes a Acura! Pero atenci√≥n: solo env√≠e invitaciones con datos del paciente a amigos y familiares.',

    }
};

const state = {
   
  currentScreen: Screens.LOGIN,
  userId: localStorage.getItem('userId') || null,
  nickname: localStorage.getItem('nickname') || null,
  relation: localStorage.getItem('relation') || null,
  isPremium: (localStorage.getItem('isPremium') === 'true'),  

  isPremiumFlag: (localStorage.getItem('isPremium') === 'true'), 
  appLanguage: localStorage.getItem('appLanguage') || 'pt',

  patientAlarmSound: getSavedAlarmAudio(),
  alarmSound: localStorage.getItem('alarmSound') || 'synth',  

  measurementUnit: localStorage.getItem('measurementUnit') || 'metric',
  dataCollectionActive: localStorage.getItem('dataCollectionActive') !== 'false', // Assume true por padr√£o
  appFontSize: parseInt(localStorage.getItem('appFontSize')) || 16,

  patientId: null,
  avatarUrl: null, // *** NOVO: Armazenar URL do avatar ***
  caregiver: {
    avatarUrl: localStorage.getItem('avatarCaregiverUrl') || null,
  },

  patient: {},
  patientsList: [],
  gameStats: { tasksCompleted: 0, totalTasks: 0, survivalProbability: 100 },
  pendingNotifications: [],
  completedTasksToday: [], // NOVO: Rastrear tarefas completadas
  activeNotification: null,
  timer: null,
  caregiverChatHistory: [],
  chatPollInterval: null,
  agendaPollInterval: null,
  activeNotifications: {}, 
  gameStartTimestamp: 0,
  notificationCheckInterval: null, // NOVO: Intervalo para verificar notifica√ß√µes
  lastCheckedDate: null, // NOVO: √öltima data verificada
  isNotificationActive: false,

  patientSelectionPollInterval: null, // Intervalo para o polling da tela de sele√ß√£o
  isPatientAlarmSounding: false,      // Flag para o status do √°udio

  // Alarme de notifica√ß√£o do paciente (tela de sele√ß√£o)
  patientAlarmSound: new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg'),
  //patientAlarmSound: new Audio(ALARM_SOUNDS[localStorage.getItem('alarmSound') || 'synth']),
  // NOVO: Alarme de medica√ß√£o/infus√£o
  medicationAlarmSound: new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg'), 
  //medicationAlarmSound: new Audio(ALARM_SOUNDS[localStorage.getItem('alarmSound') || 'synth']), 
  // NOVO: Prefer√™ncia do usu√°rio, lida do localStorage
  userAlarmPreference: localStorage.getItem('appAlarmSound') || 'beep',
  //userAlarmPreference: new Audio(ALARM_SOUNDS[localStorage.getItem('alarmSound') || 'synth']), 
  

  isCaregiverChatModalOpen: false, // 

  aiChatHistory: [{
                role: "assistant",
                parts: [{ text: "Ol√°! Eu sou o Dr. Intelig√™ncia Artificial. Como posso te ajudar hoje com os cuidados do seu paciente?" }]
            }],
            caregiverChatHistory: [],
            apiCalls: {
                generateIllnessInfo: false,
                generateAdvice: false,
                generateAvatar: false,
                generateTasks: false,
                chat: false,
            },
            hospitalSettings: {
                sector: '',
                floor: '',
                bed: '',
                admissionDate: null,
            }

            
};

state.patientAlarmSound.loop = true; // Configura o √°udio para tocar em loop

// --- UI refs ---
const ui = {
  
  //telas  
  loginScreen: document.getElementById('loginScreen'),
  caregiverScreen: document.getElementById('caregiverScreen'),
  patientSelectionScreen: document.getElementById('patientSelectionScreen'),
  mainGameScreen: document.getElementById('mainGameScreen'),  
    
  loginStatus: document.getElementById('loginStatus'),  
  
  patientList: document.getElementById('patientList'),
  illnessInfoDiv: document.getElementById('illnessInfo'),
  
  patientAvatar: document.getElementById('patientAvatar'),
  caregiverAvatar: document.getElementById('caregiverAvatar'),
  caregiverInfo: document.getElementById('caregiverInfo'),
  caregiverRelationDisplay: document.getElementById('caregiverRelationDisplay'),
  userIdDisplay: document.getElementById('userIdDisplay'),
  
  //modal
  modal: document.getElementById('messageModal'),
  modalTitle: document.getElementById('modalTitle'),
  modalMessage: document.getElementById('modalMessage'),
  settingsModal: document.getElementById('settingsModal'),
  
  //ai
  aiChatModal: document.getElementById('aiChatModal'),
  aiChatHistory: document.getElementById('aiChatHistory'),
  aiChatInput: document.getElementById('aiChatInput'),
  
  caregiverChatModal: document.getElementById('caregiverChatModal'),
  caregiverChatHistory: document.getElementById('caregiverChatHistory'),
  caregiverChatInput: document.getElementById('caregiverChatInput'),
  caregiverChatPatientName: document.getElementById('caregiverChatPatientName'),
  caregiverLocation: document.getElementById('caregiverLocation'),
  hospitalNameDisplay: document.getElementById('hospitalNameDisplay'),
  
  notificationBtn: document.getElementById('notificationBtn'),
  progressFill: document.getElementById('progressFill'),
  taskProgress: document.getElementById('taskProgress'),
  survivalProbability: document.getElementById('survivalProbability'),
  statusMessage: document.getElementById('statusMessage'),
  currentTime: document.getElementById('currentTime')
};

const MEASUREMENT_CONFIG = {
    metric: {
        weight: { 
            unit: 'kg', min: 1, max: 200, step: 0.1, 
            labelId: 'unitLabelWeight', inputId: 'pMWeight', rangeId: 'rangeWeight', selectId: 'selUnitWeight' 
        },
        height: { 
            unit: 'm', min: 0.3, max: 2.5, step: 0.01, 
            labelId: 'unitLabelHeight', inputId: 'pMHeight', rangeId: 'rangeHeight', selectId: 'selUnitHeight' 
        },
        circumference: { 
            unit: 'cm', min: 10, max: 200, step: 0.1, 
            labelId: 'unitLabelCirc', inputId: 'pMAbdominalCircumference', rangeId: 'rangeCircumference', selectId: 'selUnitCirc' 
        },
        // --- NOVO: Temperatura (Formul√°rio) ---
        temperature: { 
            unit: '¬∞C', min: 35, max: 42, step: 0.1, 
            labelId: 'unitLabelTemp', inputId: 'pMTemp', rangeId: 'rangeTemp', selectId: 'selUnitTemp' 
        },
        // --- NOVO: Temperatura (Monitor Care Hub - Apenas Label) ---
        monitorTemp: { 
            unit: '¬∞C', labelId: 'unitMonitorTemp' 
            // Sem inputId/rangeId pois o monitor √© apenas visualiza√ß√£o ou tem inputs separados
        }
    },
    imperial: {
        weight: { 
            unit: 'lbs', min: 2, max: 440, step: 0.1, 
            labelId: 'unitLabelWeight', inputId: 'pMWeight', rangeId: 'rangeWeight', selectId: 'selUnitWeight' 
        },
        height: { 
            unit: 'ft', min: 1, max: 8.2, step: 0.01, 
            labelId: 'unitLabelHeight', inputId: 'pMHeight', rangeId: 'rangeHeight', selectId: 'selUnitHeight' 
        },
        circumference: { 
            unit: 'in', min: 4, max: 80, step: 0.1, 
            labelId: 'unitLabelCirc', inputId: 'pMAbdominalCircumference', rangeId: 'rangeCircumference', selectId: 'selUnitCirc' 
        },
        // --- NOVO: Temperatura (Formul√°rio) ---
        temperature: { 
            unit: '¬∞F', min: 95, max: 108, step: 0.1, 
            labelId: 'unitLabelTemp', inputId: 'pMTemp', rangeId: 'rangeTemp', selectId: 'selUnitTemp' 
        },
        // --- NOVO: Temperatura (Monitor Care Hub - Apenas Label) ---
        monitorTemp: { 
            unit: '¬∞F', labelId: 'unitMonitorTemp' 
        }
    }
};


/* ==========================================================
   L√ìGICA DE PUSH NOTIFICATIONS (WEB PUSH / SERVICE WORKER)
   ========================================================== */
const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;   

// Conjunto para armazenar IDs de notifica√ß√µes j√° exibidas para n√£o repetir
const notifiedIds = new Set();

// 1. Registrar o Service Worker e Pedir Permiss√£o
async function initNotifications() {
    if ('serviceWorker' in navigator && 'Notification' in window) {
        try {
            // Registra o SW
            const registration = await navigator.serviceWorker.register('sw.js');
            console.log('Service Worker registrado:', registration);

            // Pede permiss√£o para notifica√ß√µes
            const permission = await Notification.requestPermission();
            if (permission === 'granted') {
                console.log('Permiss√£o de notifica√ß√£o concedida.');
                // Inicia o monitoramento
                startNotificationPolling();
            } else {
                console.warn('Permiss√£o de notifica√ß√£o negada.');
            }
        } catch (error) {
            console.error('Erro ao configurar notifica√ß√µes:', error);
        }
    } else {
        console.log('Este navegador n√£o suporta notifica√ß√µes web.');
    }
}

// 2. Fun√ß√£o de Polling (Consulta a API a cada minuto)
function startNotificationPolling() {
    // Verifica imediatamente
    checkDueNotifications();
    
    // Configura intervalo de 60 segundos (ajuste conforme necessidade)
    setInterval(checkDueNotifications, 60000); 
}

// 3. Consultar o Backend
async function checkDueNotifications() {
    // S√≥ verifica se o usu√°rio estiver logado
    if (!state.userId) return;

    try {
        const response = await apiGet('check-due-notifications', { caregiverId: state.userId });
        
        if (response.success && response.data) {
            const items = response.data;
            
            items.forEach(item => {
                // Cria um ID √∫nico para evitar repeti√ß√£o: tipo + id
                const uniqueId = `${item.tipo}-${item.id}`;
                
                // Se ainda n√£o notificamos este item nesta sess√£o
                if (!notifiedIds.has(uniqueId)) {
                    showWebNotification(item);
                    notifiedIds.add(uniqueId);
                }
            });
        }
    } catch (e) {
        console.error('Erro ao buscar notifica√ß√µes pendentes:', e);
    }
}

// 4. Exibir a Notifica√ß√£o
function showWebNotification(item) {
    if (Notification.permission === 'granted') {
        navigator.serviceWorker.ready.then(function(registration) {
            registration.showNotification(`Aten√ß√£o: ${item.paciente}`, {
                body: item.mensagem,
                icon: 'imagens/favicon-32x32.png', // Verifique se o caminho existe
                vibrate: [200, 100, 200],
                tag: `${item.tipo}-${item.id}`, // Tag evita empilhamento de notifica√ß√µes iguais
                requireInteraction: true // Notifica√ß√£o fica at√© usu√°rio interagir (opcional)
            });
            
            // Toca o som de alerta do sistema (opcional, j√° que voc√™ tem sons no app)
            if(state.alarmSound && ALARM_SOUNDS[state.alarmSound]){
                 const audio = new Audio(ALARM_SOUNDS[state.alarmSound]);
                 audio.play().catch(e => console.log("Audio play prevented in background"));
            }
        });
    }
}

// Event listeners para envio com Enter
if (ui.aiChatInput) {
    ui.aiChatInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault(); // Evita quebra de linha
            sendMessage('ai');
        }
    });
}

if (ui.caregiverChatInput) {
    ui.caregiverChatInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault(); // Evita quebra de linha
            sendMessage('caregiver');
        }
    });
}

// --- Utilities ---

/**
 * Aplica as strings de texto para o idioma selecionado em todos os elementos data-i18n.
 * @param {string} langCode O c√≥digo do idioma ('pt', 'en', 'es', etc.)
 */
function applyLanguage(langCode) {
    // 1. Verifica se as tradu√ß√µes existem
    const translations = LANG_STRINGS[langCode];
    if (!translations) {
        console.error(`Idioma ${langCode} n√£o suportado.`);
        return;
    }

    // 2. Traduz o T√≠tulo da Aba do Navegador
    if (translations['appTitle']) {
        document.title = translations['appTitle'];
    }

    // 3. Traduz Texto Interno (textContent)
    // Isso cobre p, span, h1, h2, button, label e tamb√©m as OPTIONs dos selects
    document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (translations[key]) {
            element.textContent = translations[key];
        }
    });

    // 4. Traduz Placeholders (Campos de digita√ß√£o)
    // CORRE√á√ÉO: Usando 'translations' em vez de 'LANG_STRINGS[currentLang]'
    document.querySelectorAll('[data-i18n-placeholder]').forEach(elem => {
        const key = elem.getAttribute('data-i18n-placeholder');
        if (translations[key]) {
            elem.placeholder = translations[key];
        }
    });

    // 5. Traduz Textos Alternativos de Imagens (Alt)
    // CORRE√á√ÉO: Usando 'translations' em vez de 'LANG_STRINGS[currentLang]'
    document.querySelectorAll('[data-i18n-alt]').forEach(elem => {
        const key = elem.getAttribute('data-i18n-alt');
        if (translations[key]) {
            elem.alt = translations[key];
        }
    });

    // 6. Atualiza o estado global e a vari√°vel de controle
    if (typeof state !== 'undefined') {
        state.currentLanguage = langCode;
    }
    // Atualiza a vari√°vel global que voc√™ usa em outras partes do c√≥digo
    currentLang = langCode; 

    console.log(`Idioma alterado para: ${langCode}`);
}

// --- NOVO: Fun√ß√£o CustomConfirm ---

let confirmResolver = null; // Armazena a fun√ß√£o resolve/reject da Promise

// Mudan√ßa 1: Default de confirmButtonText agora √© null (para respeitar o HTML traduzido)
function customConfirm(title, message, confirmButtonText = null, confirmButtonColor = 'bg-red-600') {
    return new Promise((resolve) => {
        // Vari√°vel de controle (certifique-se que ela foi declarada globalmente ou no escopo superior)
        let confirmResolver = resolve;
        
        const modal = document.getElementById('confirmModal');
        const titleEl = document.getElementById('confirmModalTitle');
        const messageEl = document.getElementById('confirmModalMessage');
        const proceedBtn = document.getElementById('confirmProceedBtn');
        const cancelBtn = document.getElementById('confirmCancelBtn');

        // 1. Configurar Conte√∫do
        
        // Se passar um t√≠tulo, usa ele. Se passar null, mant√©m o "Confirma√ß√£o" padr√£o do HTML/Tradu√ß√£o
        if (title) {
            titleEl.textContent = title;
        } else {
             // Opcional: Reseta para o padr√£o traduzido caso a fun√ß√£o seja reutilizada
             // titleEl.textContent = LANG_STRINGS[currentLang]['confirmationTitle']; 
        }

        // A mensagem √© sempre din√¢mica, ent√£o sempre atualizamos
        messageEl.innerHTML = message; // Usei innerHTML para permitir quebra de linha <br> se necess√°rio
        
        // 2. Configurar Bot√£o de Confirma√ß√£o
        
        // Mudan√ßa cr√≠tica: S√≥ altera o texto se um valor espec√≠fico for passado.
        // Caso contr√°rio, mant√©m o "Confirmar" / "Confirm" / "Confirmar" do data-i18n
        if (confirmButtonText) {
            proceedBtn.textContent = confirmButtonText;
        } else {
            // Se for null, garantimos que o texto volta ao padr√£o traduzido (caso tenha sido alterado antes)
            const defaultKey = proceedBtn.getAttribute('data-i18n'); // Pega 'btnConfirm'
            if (defaultKey && typeof LANG_STRINGS !== 'undefined') {
                 proceedBtn.textContent = LANG_STRINGS[currentLang][defaultKey];
            }
        }

        // L√≥gica de cores (Mantida, mas limpando classes anteriores com seguran√ßa)
        // Remove classes de cor comuns para evitar conflito (ex: bg-blue-600 bg-red-600)
        proceedBtn.classList.remove('bg-red-600', 'bg-blue-600', 'bg-green-600', 'hover:bg-red-700', 'hover:bg-blue-700', 'hover:bg-green-700');
        
        // Adiciona a nova cor base
        // Nota: O ideal √© passar a cor completa ou ter um mapa, mas assumindo que voc√™ passa 'bg-red-600'
        proceedBtn.classList.add(confirmButtonColor.split(' ')[0]); 
        
        // Adiciona o hover correspondente (pequena l√≥gica extra para UX)
        if (confirmButtonColor.includes('red')) proceedBtn.classList.add('hover:bg-red-700');
        else if (confirmButtonColor.includes('blue')) proceedBtn.classList.add('hover:bg-blue-700');
        else if (confirmButtonColor.includes('green')) proceedBtn.classList.add('hover:bg-green-700');
        else proceedBtn.classList.add('hover:opacity-90'); // Fallback


        // 3. Mostrar o modal
        modal.classList.remove('hidden');

        // 4. Limpeza e Listeners
        const cleanup = () => {
            modal.classList.add('hidden');
            proceedBtn.removeEventListener('click', handleProceed);
            cancelBtn.removeEventListener('click', handleCancel);
        };

        const handleProceed = () => {
            cleanup();
            resolve(true);
        };

        const handleCancel = () => {
            cleanup();
            resolve(false);
        };

        // Adicionar Listeners (usando {once: true} √© uma forma mais limpa de garantir que n√£o dupliquem)
        proceedBtn.addEventListener('click', handleProceed, { once: true });
        cancelBtn.addEventListener('click', handleCancel, { once: true });
    });
}

function showModal(title, message) {
  ui.modalTitle.textContent = title;
  ui.modalMessage.textContent = message;
  ui.modal.classList.remove('hidden');
}
function closeModal() { ui.modal.classList.add('hidden'); }
function escapeHtml(s = '') {
  return s.replace?.(/[&<>"'`]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;", '`':'&#96;'})[c]) || s;
}


/**
 * Define e recarrega as fontes de √°udio baseado na prefer√™ncia.
 * Chamado ao iniciar e ao alterar a configura√ß√£o no modal.
 * @param {string} soundKey 'synth', 'plucky', 'none'
 */
/**
 * Define o toque de alarme e persiste a escolha.
 */
/**
 * Define e recarrega as fontes de √°udio baseado na prefer√™ncia.
 * Chamado ao iniciar e ao alterar a configura√ß√£o no modal.
 * @param {string} soundKey 'synth', 'plucky', 'none'
 */
function setAlarmSound(soundKey) {
    // 1. Atualiza o estado e o localStorage
    state.userAlarmPreference = soundKey;
    //localStorage.setItem('appAlarmSound', soundKey);
    
    const soundUrl = ALARM_SOUNDS[soundKey];

    // 2. Atualiza as fontes dos objetos Audio principais
    if (soundUrl) {
        state.patientAlarmSound.src = soundUrl;
        state.medicationAlarmSound.src = soundUrl;
        
        // Garante que o loop esteja ativo para alarmes prim√°rios
        state.patientAlarmSound.loop = true; 
        state.medicationAlarmSound.loop = true;
    } else {
        // Se 'none', limpa a fonte e desliga o loop
        state.patientAlarmSound.src = '';
        state.medicationAlarmSound.src = '';
        state.patientAlarmSound.loop = false;
        state.medicationAlarmSound.loop = false;
    }
    
    console.log('O som do alarme √©', soundKey );
    showStatusMessage(`Toque de alarme alterado para: ${soundKey}.`);
}

/**
 * Toca o som de alarme selecionado (usado apenas no bot√£o de teste do modal).
 */
function playAlarm() {
    const soundKey = document.getElementById('alarm-select').value;
    const soundUrl = ALARM_SOUNDS[soundKey];

    if (soundUrl) {
        console.log('tom selecionado em',soundUrl);
        // Cria um novo objeto Audio APENAS para o teste
        const soundTest = new Audio(soundUrl);
        soundTest.play().catch(e => console.error("Falha ao tocar som de teste:", e));
    }
}

/**
 * Toca o som de alarme para notifica√ß√µes/alertas gerais.
 * @param {object} audioObject O objeto Audio (e.g., state.patientAlarmSound)
 */
function playCentralAlarm(audioObject) {
    /*
    if (state.userAlarmPreference === 'none') return;
    
    // Tenta parar e reiniciar para garantir que comece do zero
    audioObject.pause();
    audioObject.currentTime = 0;

    // Tenta tocar, tratando o erro (muitas vezes bloqueado pelo navegador)
    audioObject.play().catch(e => {
        console.warn("√Åudio de alarme bloqueado (sem intera√ß√£o ou por erro):", e);
    });*/

    // Se o state.medicationAlarmSound vier vazio ou undefined, o AlarmSystem
    // vai ser inteligente e buscar o valor do <select id="alarm-select">
    console.log('playCentralAlarm ', audioObject);
    AlarmSystem.playAlarm(audioObject);

}

function updateSurvivalCircle(probability) {
    const circle = document.getElementById('survivalProgressCircle');
    const textElement = document.getElementById('survivalPercentageText'); // Elemento de texto no centro
    const labelElement = document.getElementById('survivalLabel'); // Label "Estado"
    
    if (!circle) return;

    // Garante que respeita os limites visuais (0 a 100)
    const normalizedProbability = Math.min(100, Math.max(0, probability));
    
    // Circunfer√™ncia para raio = 75 (2 * PI * 75)
    const circumference = 471.24; 
    const offset = circumference - (normalizedProbability / 100) * circumference;
    
    // 1. Atualiza o anel (com transi√ß√£o CSS)
    circle.style.strokeDashoffset = offset;
    
    // 2. Define a cor e anima√ß√£o cr√≠tica
    let color;
    
    // Remove anima√ß√£o de pulso anterior para recalcular
    circle.classList.remove('animate-pulse-fast'); 
    if (textElement) textElement.classList.remove('text-red-600', 'animate-pulse');

    if (normalizedProbability <= 1) {
        // ESTADO CR√çTICO (1%)
        color = '#dc3545'; // Vermelho intenso
        // Adiciona pulsa√ß√£o de alerta
        circle.classList.add('animate-pulse-fast'); 
        if (textElement) {
            textElement.innerText = "CR√çTICO";
            textElement.classList.add('text-red-600', 'animate-pulse');
            textElement.style.fontSize = "1rem"; // Diminui fonte para caber a palavra
        }
    } else if (normalizedProbability < 50) {
        color = '#dc3545'; // Vermelho
        if (textElement) {
            textElement.innerText = `${Math.round(normalizedProbability)}%`;
            textElement.style.color = color;
            textElement.style.fontSize = "1.5rem";
        }
    } else if (normalizedProbability <= 90) {
        color = '#ffc107'; // Amarelo
        if (textElement) {
            textElement.innerText = `${Math.round(normalizedProbability)}%`;
            textElement.style.color = '#b45309'; // Um laranja escuro para leitura no texto
            textElement.style.fontSize = "1.5rem";
        }
    } else {
        color = '#198754'; // Verde
        if (textElement) {
            textElement.innerText = `${Math.round(normalizedProbability)}%`;
            textElement.style.color = color;
            textElement.style.fontSize = "1.5rem";
        }
    }
    
    // Aplica a cor ao anel
    circle.style.stroke = color;
}

/**
 * Atualiza o status de notifica√ß√£o no banco de dados.
 * @param {number} status 1 (ativo) ou 0 (inativo).
 */
async function setNotificationStatus(status) {
    if (!state.patientId) return;

    const resp = await apiPost('update-notification-status', {
        patientId: state.patientId,
        status: status
    });

    if (resp.success) {
        state.isNotificationActive = (status === 1);
        updateNotificationButtonUI();
        // *** CORRE√á√ÉO: Atualizar o objeto do paciente local (se estiver ativo) ***
        // Isso garante que o estado local reflita o que foi para o DB.
        if (state.patient) {
            state.patient.Notification = status;            
        }
        return true;
    }
    return false;
}

/**
 * Consulta o status da notifica√ß√£o no banco e atualiza a UI.
 */
async function checkNotificationStatus() {
    if (!state.patientId) return;

    // Faz a consulta ao servidor
    const resp = await apiGet('get-notification-status', { patientId: state.patientId });

    if (resp.success) {
        // O MySQL retorna a coluna como string ou int. Convertemos para garantir.
        // Se Notification for 1, isActive √© true. Se for 0, isActive √© false.
        const isActive = (parseInt(resp.status) === 1);

        // S√≥ atualiza o DOM se houver mudan√ßa de estado para evitar processamento desnecess√°rio
        if (state.isNotificationActive !== isActive) {
            state.isNotificationActive = isActive;
            updateNotificationButtonUI();
        }
    }
}

/**
 * Aplica ou remove a classe de piscar no bot√£o do sino.
 */
async function updateNotificationButtonUI() {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o (Fallback para PT se n√£o existir)
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : (typeof LANG_STRINGS !== 'undefined' ? LANG_STRINGS['pt'] : {});

    // 2. Localiza o bot√£o na interface
    const btn = (typeof ui !== 'undefined' && ui.notificationBtn) ? ui.notificationBtn : document.getElementById('notification-btn');
    if (!btn) return;

    if (state.isNotificationActive) {
        // ============================================================
        // üö® ESTADO: ALARME DISPARADO (ATIVANDO)
        // ============================================================
        
        // 1. Feedback Visual
        btn.classList.add('pulse-red');
        btn.classList.remove('bg-yellow-400');
        
        // 2. Inicia cron√¥metro da agilidade (para medir tempo de resposta)
        if (typeof ReportSystem !== 'undefined') ReportSystem.startTimer(); 
        
        // 3. Toca o alerta sonoro
        if (typeof AlarmSystem !== 'undefined') AlarmSystem.playAlert();

    } else {
        // ============================================================
        // ‚úÖ ESTADO: ALARME SENDO DESLIGADO (ATENDIMENTO REALIZADO)
        // ============================================================
        
        // 1. Para o alarme visual e sonoro IMEDIATAMENTE (Melhor UX)
        btn.classList.remove('pulse-red');
        btn.classList.add('bg-yellow-400');
        
        if (typeof AlarmSystem !== 'undefined') AlarmSystem.stopAll();

        // 2. PREPARA√á√ÉO DOS DADOS PARA O RELAT√ìRIO
        
        // Tenta descobrir automaticamente quem atendeu (Integra√ß√£o com ProfessionalPresence)
        let suggestedResponder = "";
        
        // Se a classe ProfessionalPresence existir, pega o nome da lista de presen√ßa
        if (typeof ProfessionalPresence !== 'undefined') {
            suggestedResponder = ProfessionalPresence.getCurrentResponder();
        } 
        // Se n√£o, tenta pegar o apelido do usu√°rio logado ou usa fallback
        else {
            suggestedResponder = state.nickname || localStorage.getItem('nickname') || t['defaultCaregiverName'] || 'Cuidador';
        }

        // Vari√°veis de Texto (Tradu√ß√£o)
        const titleLog = t['titleLogAttendance'] || 'Registro de Atendimento';
        const lblWho = t['lblWhoAttended'] || 'Quem atendeu?';
        const phWho = t['phWhoAttended'] || 'Profissional/Cuidador';
        const lblObs = t['lblObservations'] || 'Observa√ß√µes:';
        const phObs = t['phObservations'] || 'Ex: Paciente atendido no quarto';
        const btnSave = t['btnSaveLog'] || 'Salvar Registro';
        const reasonManual = t['reasonManualCall'] || 'Chamada Manual (Campainha)';
        const defaultCaregiver = t['defaultCaregiverName'] || 'Cuidador Atual';

        // 3. EXIBI√á√ÉO DO MODAL DE REGISTRO (SweetAlert2)
        if (typeof Swal !== 'undefined') {
            const { value: formValues } = await Swal.fire({
                title: titleLog,
                // HTML injetado com o valor pr√©-preenchido (value="${suggestedResponder}")
                html: `
                    <div style="text-align: left;">
                        <label class="block text-sm font-bold mb-1" style="color:#374151;">${lblWho}</label>
                        <input id="swal-attendant" class="swal2-input" style="margin: 0 0 15px 0; width: 100%;" 
                               placeholder="${phWho}" value="${suggestedResponder}">
                        
                        <label class="block text-sm font-bold mb-1" style="color:#374151;">${lblObs}</label>
                        <textarea id="swal-notes" class="swal2-textarea" style="margin: 0; width: 100%;" 
                                  placeholder="${phObs}"></textarea>
                    </div>
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: btnSave,
                cancelButtonText: t['btnCancel'] || 'Cancelar',
                confirmButtonColor: '#2563eb', // Azul padr√£o do sistema
                preConfirm: () => {
                    return {
                        attendant: document.getElementById('swal-attendant').value,
                        notes: document.getElementById('swal-notes').value
                    }
                }
            });

            // 4. SALVAR NO RELAT√ìRIO SE CONFIRMADO
            if (formValues && formValues.attendant) {
                if (typeof ReportSystem !== 'undefined') {
                    ReportSystem.logEvent({
                        reason: reasonManual,
                        professional: formValues.attendant, // Usa o nome (editado ou sugerido)
                        caregiver: localStorage.getItem('caregiverName') || defaultCaregiver, 
                        notes: formValues.notes,
                        isLocationCorrect: ReportSystem.checkLocation()
                    });
                    
                    // Feedback discreto (Toast)
                    const Toast = Swal.mixin({
                        toast: true, position: 'top-end', showConfirmButton: false, timer: 3000
                    });
                    Toast.fire({ icon: 'success', title: t['msgAttendanceSaved'] || 'Atendimento registrado!' });
                }
            }
        } else {
            // Fallback (Prompt nativo) caso SweetAlert falhe
            const quemAtendeu = prompt(`${titleLog}\n${lblWho}`, suggestedResponder);
            if (quemAtendeu) {
                if (typeof ReportSystem !== 'undefined') {
                    ReportSystem.logEvent({
                        reason: reasonManual,
                        professional: quemAtendeu,
                        caregiver: localStorage.getItem('caregiverName') || defaultCaregiver,
                        notes: prompt(lblObs, phObs),
                        isLocationCorrect: ReportSystem.checkLocation()
                    });
                }
            }
        }
    }
}

// index.html - NOVO: Fun√ß√£o para voltar √† sele√ß√£o de pacientes
function returnToPatientSelection() {

    // Verifica se existe um turno aberto (currentShiftId) e o encerra
    if (typeof currentShiftId !== 'undefined' && currentShiftId) {
        console.log(`üõë Usu√°rio clicou em Sair. Encerrando turno ID: ${currentShiftId}...`);
        
        // Chama a fun√ß√£o que criamos anteriormente
        if (typeof apiEndShift === 'function') {
            apiEndShift('Bot√£o Sair de Cena');
        }
        
        // Opcional: Se voc√™ estiver usando watchPosition (monitoramento cont√≠nuo)
        // e tiver salvo o ID em uma vari√°vel global 'watchId', pare o GPS aqui:
        // if (typeof watchId !== 'undefined' && watchId) {
        //     navigator.geolocation.clearWatch(watchId);
        //     watchId = null;
        // }
    }

    // 1. Limpa o estado do paciente atual
    state.patientId = null;
    state.patient = null;
    
    // 2. Parar TODO o polling da tela principal (agenda, chat, etc.)
    // O polling da agenda e o chat foram iniciados em startGame()
    if (state.agendaPollInterval) {
        clearInterval(state.agendaPollInterval);
        state.agendaPollInterval = null;
    }
    if (state.chatPollInterval) {
        clearInterval(state.chatPollInterval);
        state.chatPollInterval = null;
    }
    // Parar o polling de notifica√ß√£o do bot√£o de sino (se existir)
    if (state.notificationStatusPoll) {
        clearInterval(state.notificationStatusPoll);
        state.notificationStatusPoll = null;
    }
    
    // 3. For√ßar o carregamento da lista de pacientes e o in√≠cio imediato do polling de notifica√ß√£o
    // fetchPatientsAndProceed faz a chamada √† API para obter o status 'Notification' atualizado,
    // chama renderPatientList(), e inicia o pollPatientNotifications.
    fetchPatientsAndProceed(); 
}

    // üîë VARI√ÅVEL GLOBAL: Armazena o ID do paciente atualmente selecionado
    let currentPatientId = null;
    let currentPatientGender = null; 
    
// ** Fim das Fun√ß√µes Auxiliares **

    // NOVO: Fun√ß√£o para exibir a tela de Dashboard
 /**
 * üîë FUN√á√ÉO PRINCIPAL: Abre o dashboard do paciente, carregando seus dados via API.
 * * @param {string} patientId O ID √∫nico do paciente a ser carregado.
 */
async function openPatientDashboard(patientId) {
    if (!patientId) {
        showStatusMessage('Erro: ID do paciente n√£o fornecido.', 'error');
        return;
    }

    if (!checkPremiumFeature()) return;

    currentPatientId = patientId; // Armazena o ID globalmente
    
    // 1. Exibir mensagem de loading e mudar para a tela do dashboard
    showStatusMessage('Carregando dados do paciente...', 'info');
    goToScreen(Screens.DASHBOARD);
    
    // 2. Definir placeholders enquanto carrega
    document.getElementById('dashboardPatientName').textContent = 'Carregando...';
    document.getElementById('dashboardPatientAge').textContent = '';
    document.getElementById('dashboardPatientGender').textContent = '';
    document.getElementById('dashboardPatientIllness').textContent = '';
    document.getElementById('dashboardCaregiverName').textContent = '-';

    try {
        // 3. Buscar dados do paciente via API
        const response = await apiGet('get-patient-data', { paciente_id: patientId });

        if (response.success && response.data) {
            const patient = response.data;
            
            // 4. Atualizar elementos HTML com os dados reais
            document.getElementById('dashboardPatientName').textContent = patient.nome || 'Paciente Desconhecido';
            document.getElementById('dashboardPatientAge').textContent = `${patient.idade || '--'} anos`;
            document.getElementById('dashboardPatientGender').textContent = patient.sexo_formatado || 'N√£o informado';
            document.getElementById('dashboardPatientIllness').textContent = patient.condicao_medica_principal || 'Sem diagn√≥stico';
            document.getElementById('dashboardCaregiverName').textContent = patient.nome_cuidador_principal || 'N√£o atribu√≠do';
            
            // 5. Atualizar avatar se dispon√≠vel (opcional)
            const avatarElement = document.getElementById('dashboardPatientAvatar');
            if (avatarElement && patient.foto_url) {
                avatarElement.src = patient.foto_url;
            }
            
            // 6. Armazenar dados no estado global para uso posterior
            state.currentDashboardPatient = patient;
            
            console.log('‚úÖ Dashboard carregado:', patient);
            showStatusMessage(`Dashboard de ${patient.nome} carregado com sucesso.`, 'success');

            resetSettingsModalState();

            // 7. (Opcional) Inicializar a primeira aba
            changeDashboardTab('nutrologia-content');

        } else {
            // 8. Tratamento de erro da API
            showStatusMessage(response.message || 'Falha ao carregar dados do paciente.', 'error');
            document.getElementById('dashboardPatientName').textContent = 'Erro ao carregar';
        }

    } catch (error) {
        // 9. Tratamento de erro de conex√£o
        console.error('Erro no Fetch ao carregar dashboard:', error);
        showStatusMessage('Erro de conex√£o ou servidor ao buscar dados do paciente.', 'error');
        document.getElementById('dashboardPatientName').textContent = 'Erro de conex√£o';
    }
}
    // ====================================================================
    // Fun√ß√µes do Dashboard
    // ====================================================================
    
    /**
 * üîë Troca o conte√∫do (aba) exibido no dashboard do paciente.
 * @param {string} tabName O ID do elemento de conte√∫do a ser exibido (ex: 'patient-agenda-content').
 */
/**
 * üîí Troca o conte√∫do (aba) exibido no dashboard do paciente.
 * Vers√£o isolada e segura com valida√ß√µes.
 * @param {string} tabName O ID do elemento de conte√∫do a ser exibido.
 */
function changeDashboardTab(tabName) {
    // ‚úÖ VALIDA√á√ÉO 1: Verificar se est√° na tela correta
    if (state.currentScreen !== Screens.DASHBOARD) {
        console.warn('changeDashboardTab: N√£o est√° na tela do Dashboard');
        return;
    }
    
    // ‚úÖ VALIDA√á√ÉO 2: Verificar se o elemento existe
    const targetContent = document.getElementById(tabName);
    if (!targetContent) {
        console.error(`changeDashboardTab: Aba "${tabName}" n√£o encontrada`);
        return;
    }
    
    // ‚úÖ ESCOPO ISOLADO: Busca apenas dentro do dashboard
    const dashboardScreen = document.getElementById('patientDashboardScreen');
    if (!dashboardScreen) {
        console.error('changeDashboardTab: Dashboard screen n√£o encontrado');
        return;
    }
    
    // 1. Oculta todos os conte√∫dos de aba (APENAS dentro do dashboard)
    dashboardScreen.querySelectorAll('.patient-content-module').forEach(content => {
        content.classList.remove('active-content');
    });

    // 2. Desativa todos os bot√µes de aba (APENAS dentro do dashboard)
    dashboardScreen.querySelectorAll('.dashboard-tab-button').forEach(button => {
        button.classList.remove('bg-indigo-600', 'text-white');
        button.classList.add('text-indigo-600');
    });

    // 3. Ativa o conte√∫do da aba desejada
    targetContent.classList.add('active-content');
    
    // ‚úÖ NOVO: GATILHO DE DADOS ESPEC√çFICOS
    // Verifica se a aba aberta √© a financeira para carregar os relat√≥rios
    // Aceita tanto o padr√£o 'financeiro-content' quanto o antigo 'tabFinanceiro'
    if (tabName === 'financeiro-content') {
        if (typeof loadFinanceReport === 'function') {
            requestAnimationFrame(() => {
                loadFinanceReport();
            });
        }
    }

    // 4. Scroll suave at√© o topo
    const contentContainer = dashboardScreen.querySelector('.dashboard-content-container');
    if (contentContainer) {
        requestAnimationFrame(() => {
            contentContainer.scrollTo({ top: 0, behavior: 'smooth' });
        });
    }
    
    // 5. Ativa o bot√£o da aba
    // Nota: O replace remove '-content' para achar o bot√£o correto (ex: dashboard-tab-btn-financeiro)
    const btnSuffix = tabName.replace('-content', '').replace('tab', '').toLowerCase(); 
    // Tenta achar pelo padr√£o estrito ou flex√≠vel
    let targetButton = dashboardScreen.querySelector(`#dashboard-tab-btn-${tabName.replace('-content', '')}`);
    
    // Fallback para caso o ID do bot√£o n√£o siga estritamente o padr√£o
    if (!targetButton) {
         targetButton = dashboardScreen.querySelector(`[onclick*="${tabName}"]`);
    }

    if (targetButton) {
        targetButton.classList.remove('text-indigo-600');
        targetButton.classList.add('bg-indigo-600', 'text-white');
        
        // 6. Scroll horizontal autom√°tico (mobile)
        const tabsContainer = document.getElementById('dashboardTabs');
        if (tabsContainer && window.innerWidth <= 768) {
            requestAnimationFrame(() => {
                const buttonRect = targetButton.getBoundingClientRect();
                const containerRect = tabsContainer.getBoundingClientRect();
                const scrollLeft = targetButton.offsetLeft - (containerRect.width / 2) + (buttonRect.width / 2);
                
                tabsContainer.scrollTo({
                    left: Math.max(0, scrollLeft),
                    behavior: 'smooth'
                });
            });
        }
    }
    
    console.log(`üìä Dashboard: Aba "${tabName}" ativada`);
}

/**
 * Garante que todas as abas e bot√µes do modal de configura√ß√µes sejam desativados.
 * Isso resolve o conflito de estado ao retornar ao Dashboard.
 */
function resetSettingsModalState() {
    // 1. Oculta todos os conte√∫dos de aba do modal (assumindo a classe .tab-content para os modais)
    document.querySelectorAll('#settings-modal .tab-content').forEach(content => {
        content.classList.remove('active-content');
    });

    // 2. Desativa todos os bot√µes de aba do modal (assumindo a classe .tab-button para os botais)
    document.querySelectorAll('#settings-modal .tab-button').forEach(button => {
        // Remove estado Ativo
        button.classList.remove('bg-indigo-600', 'text-white');
        // Adiciona estado Inativo (cores default)
        button.classList.add('text-indigo-600', 'hover:bg-indigo-100');
    });
    
    // 3. (Opcional) For√ßa a ativa√ß√£o da primeira aba padr√£o do modal
    const firstTabContent = document.getElementById('settings-geral-content'); // Ajuste o ID conforme seu modal
    const firstTabButton = document.getElementById('settings-btn-geral');     // Ajuste o ID conforme seu modal

    if (firstTabContent) {
        firstTabContent.classList.add('active-content');
    }
    if (firstTabButton) {
        firstTabButton.classList.remove('text-indigo-600', 'hover:bg-indigo-100');
        firstTabButton.classList.add('bg-indigo-600', 'text-white');
    }
}
 

function openDiseaseSelectorFromSettings() {
    // 1. Exibir o Modal (removendo a classe hidden)
    const form = document.getElementById('hub-disease-form');
    if (!form) {
        console.error("Modal hub-disease-form n√£o encontrado!");
        return;
    }
    form.classList.remove('hidden');

    // 2. Localizar os campos
    const typeSelect = document.getElementById('hub-illness-type');
    const subtypeInput = document.getElementById('hub-illness-subtype');
    const searchInput = document.getElementById('hub-disease-search');

    // 3. Obter dados salvos do paciente
    // Tenta pegar do state global. Se n√£o tiver, tenta do localStorage como fallback.
    let currentIllness = "";
    let currentSubtype = "";

    if (state && state.patient) {
        currentIllness = state.patient.illness || "";
        currentSubtype = state.patient.illness_subtype || ""; // Verifique se seu banco usa esse nome exato
    }

    console.log("Carregando diagn√≥stico:", currentIllness, currentSubtype);

    // 4. Preencher os campos
    if (subtypeInput) subtypeInput.value = currentSubtype;

    if (typeSelect && currentIllness) {
        // Truque para garantir que o select mostre a op√ß√£o correta mesmo com filtro
        // Primeiro, limpamos a busca para mostrar todas as op√ß√µes
        if (searchInput) {
            searchInput.value = ""; 
            hubFilterDiseaseList(); // Fun√ß√£o que mostra todas as options
        }
        
        // Define o valor
        typeSelect.value = currentIllness;

        // Se o valor n√£o foi selecionado (pq a op√ß√£o n√£o existe ou nome difere),
        // tentamos preencher a busca para ajudar o usu√°rio
        if (!typeSelect.value) {
            if (searchInput) {
                searchInput.value = currentIllness;
                hubFilterDiseaseList(); // Filtra para tentar achar
            }
        }
    } else {
        // Se n√£o tem doen√ßa, reseta
        if (typeSelect) typeSelect.value = "";
        if (searchInput) {
            searchInput.value = "";
            hubFilterDiseaseList();
        }
    }
}

/**
 * Checa o status de notifica√ß√£o de TODOS os pacientes e atualiza a UI/Alarme.
 */

 async function pollPatientNotifications() {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    if (!state.userId) return;

    const resp = await apiGet('get-patients-by-caregiver', { caregiverId: state.userId });

    let shouldSoundAlarm = false;

    if (resp.success && resp.data) {
        // 1. Atualiza dados e renderiza lista
        state.patients = resp.data;
        state.patientsList = resp.data; 
        
        // Dica: Verifique se renderPatientList existe antes de chamar para evitar erros
        if(typeof renderPatientList === 'function') renderPatientList();

        // 2. Checa se h√° algum paciente com notifica√ß√£o ativa
        shouldSoundAlarm = resp.data.some(p => p.Notification === 1 || p.Notification === '1');
    }

    // 3. Controle do Alarme Sonoro, Vibra√ß√£o e Notifica√ß√£o Nativa
    if (shouldSoundAlarm && !state.isPatientAlarmSounding) {
        state.isPatientAlarmSounding = true;

        // TRADU√á√ÉO: Textos do Alerta
        const title = t['alertTitle'] || 'Alerta do Cuidador';
        const body = t['alertBody'] || 'Verifique o paciente!';
        const msgVisual = t['msgAlertTriggered'] || 'üö® Alerta!';

        // --- INTEGRA√á√ÉO COM ANDROID NATIVO ---
        if (window.Android && window.Android.showNotification) {
            // Agora o Android receber√° o texto no idioma correto
            window.Android.showNotification(title, body);
            
            // Backup sonoro Web
            if (state.patientAlarmSound) {
                console.log('alarme tocando √© ', state.patientAlarmSound);
                // Supondo que playCentralAlarm toca o som em loop
                if(typeof playCentralAlarm === 'function') playCentralAlarm(state.patientAlarmSound);
            }
        } else {
            // Cen√°rio Web (PC/iPhone)
            if (state.patientAlarmSound) {
                if(typeof playCentralAlarm === 'function') playCentralAlarm(state.patientAlarmSound);
            }
            // Modal visual
            if (typeof showModal === 'function') {
                showModal(title, body);
            }
        }
        // -------------------------------------

        // Vibra√ß√£o Web API
        if (navigator.vibrate) {
            navigator.vibrate([1000, 500, 1000]); 
        }
        
        showStatusMessage(msgVisual);

    } else if (!shouldSoundAlarm && state.isPatientAlarmSounding) {
        
        // 4. Para o alarme se a notifica√ß√£o foi resolvida
        state.isPatientAlarmSounding = false;

        if (state.patientAlarmSound) {
            state.patientAlarmSound.pause();
            state.patientAlarmSound.currentTime = 0;
            AlarmSystem.stopAlarm();
            beepSound.loop = false; 
            beepSound.pause();       
            beepSound.currentTime = 0; 
        }
        if (navigator.vibrate) {
            navigator.vibrate(0); 
        }
    }
}

/**
 * Para o alarme e o polling quando o paciente √© selecionado.
 */
function stopPatientAlarmAndPolling() {
    if (state.patientSelectionPollInterval) {
        clearInterval(state.patientSelectionPollInterval);
        state.patientSelectionPollInterval = null;
    }
    if (state.isPatientAlarmSounding) {
        state.isPatientAlarmSounding = false;
        if (state.patientAlarmSound) {
            state.patientAlarmSound.pause();
            state.patientAlarmSound.currentTime = 0;
            state.patientAlarmSound.loop = false;
        }
        if (navigator.vibrate) {
            navigator.vibrate(0);
        }
    }
}
/**
 * Manipula o clique manual no bot√£o do sino.
 */
async function handleClickNotification() {
    if (!state.isNotificationActive) {
        // Se inativo, ativa manualmente (define como 1)
        if (await setNotificationStatus(1)) {
            showStatusMessage("üîî Chama Cuidador.");
        }
    } else {
        // Se ativo, desativa (define como 0)
        if (await setNotificationStatus(0)) {
            showStatusMessage("‚úÖ Parou chamada.");
        }
    }
}

function goToScreen(screenName) {
  Object.values(Screens).forEach(s => {
    const el = document.getElementById(s);
    if (!el) return;
    el.classList.remove('active-screen');
    el.classList.add('screen');
  });
  const active = document.getElementById(screenName);
  if (active) {
    active.classList.remove('screen');
    active.classList.add('active-screen');
    state.currentScreen = screenName;
  }
}

// --- HTTP helpers ---
async function apiPost(action, payload = {}) {
  try {
    const res = await fetch(`${API_URL}?action=${encodeURIComponent(action)}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    return await res.json();
  } catch (e) {
    console.error('apiPost error', e);
    return { success: false, message: 'Erro [1] de comunica√ß√£o com o servidor.' };
  }
}
async function apiGet(action, params = {}) {
  const url = new URL(API_URL, location.origin);
  url.searchParams.set('action', action);
  Object.keys(params).forEach(k => params[k] !== undefined && url.searchParams.set(k, params[k]));
  try {
    const res = await fetch(url.toString());
    return await res.json();
  } catch (e) {
    console.error('apiGet error', e);
    return { success: false, message: 'Erro [2] de comunica√ß√£o com o servidor.' };
  }
}

// --- Auth (email/password) ---
async function registerWithEmail() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  if (!email || !password) { showModal('Erro', 'Email e senha obrigat√≥rios'); return; }
  ui.loginStatus.textContent = 'Criando conta...';
  const resp = await apiPost('register', { email, password });
  ui.loginStatus.textContent = '';
  if (resp.success) {
    state.userId = resp.data.userId;
    localStorage.setItem('userId', state.userId);
    localStorage.setItem('isLoggedIn', '1');
    showModal('Sucesso', 'Conta criada. Preencha seu perfil.');
    goToScreen(Screens.CAREGIVER);
    // keep userId in state for profile save
  } else {
    showModal('Erro', resp.message || 'Falha no registro');
  }
}

async function loginWithEmail() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  if (!email || !password) { showModal('Erro', 'Email e senha obrigat√≥rios'); return; }
  ui.loginStatus.textContent = 'Autenticando...';
  const resp = await apiPost('login', { email, password });
  ui.loginStatus.textContent = '';
  if (resp.success) {
    state.userId = resp.data.userId;
    state.nickname = resp.data.nickname || '';
    state.relation = resp.data.relation || '';
    // *** NOVO: Salvar avatarUrl no state ***
    state.avatarUrl = resp.data.avatarUrl || null;

    // *** NOVO: Sincronizar com state.caregiver ***
    state.caregiver.avatarUrl = resp.data.avatarUrl || null;
    
    // *** NOVO: Salvar configura√ß√µes do sistema no state ***
    state.appLanguage = resp.data.appLanguage || 'pt';
    state.alarmSound = resp.data.alarmSound || 'beep';
    state.measurementUnit = resp.data.measurementUnit || 'metric';
    state.dataCollectionActive = resp.data.dataCollectionActive || 'true';
    state.appFontSize = resp.data.appFontSize || 16;
    const isPremiumFlag = !!resp.data.isPremium; // normaliza pra boolean
    state.isPremium = isPremiumFlag;
    localStorage.setItem('isPremium', isPremiumFlag ? 'true' : 'false');
    localStorage.setItem('userId', state.userId);
    localStorage.setItem('nickname', state.nickname || '');
    localStorage.setItem('relation', state.relation || '');
    localStorage.setItem('avatarCaregiverUrl', state.caregiver.avatarUrl || '');
    
    localStorage.setItem('appLanguage', state.appLanguage || 'pt-br');
    localStorage.setItem('alarmSound', state.alarmSound || 'padrao');
    localStorage.setItem('measurementUnit', state.measurementUnit || 'metric');
    localStorage.setItem('dataCollectionActive', state.dataCollectionActive || 'true');
    localStorage.setItem('appFontSize', state.appFontSize || '16');    
    
    updateCaregiverUI();
    await fetchPatientsAndProceed();
  } else {
    showModal('Erro', resp.message || 'Falha no login');
  }
}

// Vari√°vel global para armazenar a agenda
let AGENDA_SIMULADA = [];

async function logOut() {

  // Verifica se existe um turno aberto (currentShiftId) e o encerra
    if (typeof currentShiftId !== 'undefined' && currentShiftId) {
        console.log(`üõë Usu√°rio clicou em Sair. Encerrando turno ID: ${currentShiftId}...`);
        
        // Chama a fun√ß√£o que criamos anteriormente
        if (typeof apiEndShift === 'function') {
            apiEndShift('Bot√£o logout');
        }
        
        // Opcional: Se voc√™ estiver usando watchPosition (monitoramento cont√≠nuo)
        // e tiver salvo o ID em uma vari√°vel global 'watchId', pare o GPS aqui:
        // if (typeof watchId !== 'undefined' && watchId) {
        //     navigator.geolocation.clearWatch(watchId);
        //     watchId = null;
        // }
    }  
  
  // Limpa timers e estado local
  if (state.chatPollInterval) { 
    clearInterval(state.chatPollInterval); 
    state.chatPollInterval = null; 
  }
  
  if (state.agendaPollInterval) { 
    clearInterval(state.agendaPollInterval); 
    state.agendaPollInterval = null; 
  }
  
  if (state.notificationCheckInterval) { // NOVO
    clearInterval(state.notificationCheckInterval); 
    state.notificationCheckInterval = null; 
  }
  
  if (state.notificationTimeoutHandle) { 
    clearTimeout(state.notificationTimeoutHandle); 
    state.notificationTimeoutHandle = null; 
  }
  
  if (state.clockIntervalHandle) { 
    clearInterval(state.clockIntervalHandle); 
    state.clockIntervalHandle = null; 
  }
  
  // Limpar agenda
  AGENDA_SIMULADA = [];
  
  state.userId = null; 
  state.token = null; 
  state.nickname = null;  
  state.relation = null;
  state.patientId = null;
  state.pendingNotifications = []; // NOVO
  state.completedTasksToday = []; // NOVO
  
  localStorage.removeItem('userId'); 
  localStorage.removeItem('token'); 
  localStorage.removeItem('nickname');   
  
  goToScreen(Screens.LOGIN);
}

// --- Google sign-in callback (GSI) ---
// The index.html should load Google Identity SDK and call renderGoogleButton().
// handleGoogleCredentialResponse will be called by the SDK.
window.handleGoogleCredentialResponse = async (response) => {
  if (!response || !response.credential) {
    showModal('Erro', 'Falha no login com Google.');
    return;
  }
  
  ui.loginStatus.textContent = 'Validando token Google...';
  
  // CORRE√á√ÉO AQUI: Mudado de { id_token: ... } para { credential: ... }
  // para combinar com o que o api.php espera ($input['credential'])
  const resp = await apiPost('google-login', { credential: response.credential });
  
  ui.loginStatus.textContent = '';
  
  if (resp.success) {
    // Ajuste: O api.php retorna 'user' (n√£o 'data'), mas vou manter 
    // seu c√≥digo original de leitura. Se der erro de undefined, 
    // mude resp.data.userId para resp.user.id
    
    // Assumindo que seu PHP retorna a estrutura que vimos antes:
    const userData = resp.user || resp.data; // Tenta pegar de user ou data para garantir

    state.userId = userData.id || userData.userId;
    state.nickname = userData.nome || userData.nickname || '';
    state.relation = userData.relation || '';

    state.isPremium = userData.isPremium ;
    state.appLanguage = userData.appLanguage || 'pt';
    state.alarmSound = userData.alarmSound || 'beep';
    state.measurementUnit = userData.measurementUnit || 'metric';
    state.dataCollectionActive = userData.dataCollectionActive || 'true';
    state.appFontSize = userData.appFontSize || 16;

    
    localStorage.setItem('userId', state.userId);
    localStorage.setItem('nickname', state.nickname);
    localStorage.setItem('relation', state.relation || '');

    state.avatarUrl = userData.avatarUrl || null;

    // *** NOVO: Sincronizar com state.caregiver ***
    state.caregiver.avatarUrl = userData.avatarUrl || null;

    localStorage.setItem('avatarCaregiverUrl', state.caregiver.avatarUrl || '');

    // Se o PHP n√£o retornar isPremium, assume false
    localStorage.setItem('isPremium', state.isPremium ? 'true' : 'false');    
    localStorage.setItem('appLanguage', state.appLanguage || 'pt-br');
    localStorage.setItem('alarmSound', state.alarmSound || 'padrao');
    localStorage.setItem('measurementUnit', state.measurementUnit || 'metric');
    localStorage.setItem('dataCollectionActive', state.dataCollectionActive || 'true');
    localStorage.setItem('appFontSize', state.appFontSize || '16');    

    // Aplica as mudan√ßas
    setAlarmSound(state.alarmSound );
    setAppLanguage(state.appLanguage);
    setFontSize(state.appFontSize); // Aplica a fonte imediatamente

    updateCaregiverUI();
    await fetchPatientsAndProceed();
  } else {
    showModal('Erro', resp.message || 'Falha no login Google');
  }
};

function renderGoogleButtonIfReady() {
  if (window.google && google.accounts && google.accounts.id) {
    google.accounts.id.initialize({ client_id: '946499185027-oa899ofai134c3uvo5pslbhjo0vrf9cj.apps.googleusercontent.com', callback: handleGoogleCredentialResponse, ux_mode: 'popup' });
    google.accounts.id.renderButton(document.getElementById('g_button'), { theme: 'outline', size: 'large', width: '100%' });
  } else {
    // noop  index.html already has fallback
  }
}

// --- Caregiver profile ---
async function saveCaregiverProfile() {
  const nickname = document.getElementById('caregiverNickname').value.trim();
  const relation = document.getElementById('caregiverRelation').value || '';
  if (!nickname) { showModal('Erro', 'Insira um apelido.'); return; }
  if (!state.userId) { showModal('Erro', 'Usu√°rio n√£o autenticado.'); return; }
  const resp = await apiPost('save-caregiver-profile', { userId: state.userId, nickname, relation, patientID: state.patientId });
  if (resp.success) {
    state.nickname = nickname;
    state.relation = relation;
    localStorage.setItem('nickname', nickname);
    localStorage.setItem('relation', relation);
    updateCaregiverUI();
    await fetchPatientsAndProceed();
  } else {
    showModal('Erro', resp.message || 'Falha ao salvar perfil.');
  }
}


/**
 * Atualiza a interface do usu√°rio com os dados do cuidador (apelido, rela√ß√£o, avatar).
 * L√™ os dados do objeto global 'state'.
 */
/**
 * Atualiza a interface do usu√°rio com os dados do cuidador (apelido, rela√ß√£o, avatar).
 * L√™ os dados do objeto global 'state'.
 */
function updateCaregiverUI() {

    // Carrega as prefer√™ncias do usu√°rio
    setAlarmSound(state.alarmSound );
    setAppLanguage(state.appLanguage);
    setFontSize(state.appFontSize); // Aplica a fonte imediatamente
    updateMeasurementUI(state.measurementUnit, state.measurementUnit); // atualiza o sistema de medidas salvo

    console.log("-> Atualizando interface do cuidador. Avatar URL:", state.caregiver.avatarUrl);

    // *** CORRE√á√ÉO: IDs CORRETOS DO HTML ***
    const nicknameDisplay = document.getElementById('caregiverInfo');
    const relationDisplay = document.getElementById('caregiverRelationDisplay');
    const avatarElement = document.getElementById('caregiverAvatar');
     
    console.log('Pegou do elemento por id caregiverAvatar', avatarElement);

    const settingsAvatarElement = document.getElementById('settingsCaregiverAvatar');
    
    // 1. Atualizar Nickname e Rela√ß√£o
    if (nicknameDisplay) nicknameDisplay.innerText = state.nickname || '';
    if (relationDisplay) relationDisplay.innerText = state.relation || 'Cuidador(a)';

    // 2. L√≥gica CR√çTICA para carregar o Avatar
    const defaultAvatar = 'https://placehold.co/80x80/cbd5e1/475569?text=C'; 
    const avatarSrc = state.caregiver.avatarUrl ? state.caregiver.avatarUrl : defaultAvatar;

    // Aplica a URL √† imagem da tela principal
    if (avatarElement) {
        avatarElement.src = avatarSrc;
    } else {
        console.warn("Elemento 'caregiverAvatar' n√£o encontrado no DOM.");
    }
    
    // Aplica a URL √† imagem do modal de configura√ß√µes
    if (settingsAvatarElement) {
        settingsAvatarElement.src = avatarSrc;
    } else {
        console.warn("Elemento 'settingsCaregiverAvatar' n√£o encontrado no DOM.");
    }
}

function updatePatientUI() {
    // 1. Atualiza o apelido/nome do paciente
    const patientNameElement = document.getElementById('pacientName');
    if (patientNameElement) {
        // Tenta pegar o nickname, sen√£o o nome, sen√£o "Paciente"
        const nomeParaMostrar = state.patient.nickname || state.patient.name || state.patient.nome || 'Paciente';
        patientNameElement.textContent = nomeParaMostrar;
    }
    
    // Opcional: Atualiza o avatar
    const patientAvatarElement = document.getElementById('patientAvatar');
    if (patientAvatarElement && state.patient.avatarUrl) {
        patientAvatarElement.src = state.patient.avatarUrl;
    }

    // 2. CORRE√á√ÉO DA EXIBI√á√ÉO DO C√ìDIGO
    const patientIdElement = document.getElementById('pacientIdDisplay');
    if (patientIdElement) {
        // A L√≥gica da Corre√ß√£o:
        // 1¬∫ Tenta state.patientCode
        // 2¬∫ Tenta dentro do objeto paciente (access_code ou codigo_acesso)
        // 3¬∫ Tenta recuperar do localStorage (caso tenha dado F5)
        // 4¬∫ Se nada der certo, mostra N/A
        const codeToShow = state.patientCode 
                        || state.patient.access_code 
                        || state.patient.codigo_acesso 
                        || localStorage.getItem('patientCode') 
                        || 'N/A';

        patientIdElement.textContent = `Code: ${codeToShow}`;
    }
}

// --- Patients ---
async function fetchPatientsAndProceed() {
  if (!state.userId) { goToScreen(Screens.LOGIN); return; }
  ui.loginStatus.textContent = 'Verificando pacientes...';
  const resp = await apiGet('get-patients-by-caregiver', { caregiverId: state.userId });
  ui.loginStatus.textContent = '';
  
  if (resp.success) {
    state.patientsList = resp.data || [];
    renderPatientList(); // Renderiza o primeiro lote de dados (tela n√£o fica em branco)    
    goToScreen(Screens.PATIENT_SELECTION);
    
    // ** CORRE√á√ÉO: INICIAR O POLLING DA TELA DE SELE√á√ÉO (AGORA E A CADA 5S) **
    stopPatientAlarmAndPolling(); // 1. Garante que o alarme anterior pare
    
    // 2. Inicia o polling peri√≥dico (a cada 5 segundos)
    state.patientSelectionPollInterval = setInterval(pollPatientNotifications, 5000); 
    
    // 3. For√ßa a execu√ß√£o do primeiro poll imediatamente para sincronizar o alarme
    //    e atualizar a UI com o status de notifica√ß√£o mais recente.
    pollPatientNotifications();
    // ** FIM DA CORRE√á√ÉO **
    
  } else {
    showModal('Erro', resp.message || 'N√£o foi poss√≠vel buscar pacientes.');
  }
}

// Fun√ß√£o auxiliar para mostrar o alerta (Adicione esta fun√ß√£o fora do renderPatientList se ainda n√£o tiver)
function showVotingAlert(patientName, patientId) {
    // N√ÉO coloque event.stopPropagation() aqui.
    // O clique j√° foi tratado e parado l√° no renderPatientList.

    console.log(`Abrindo alerta de vota√ß√£o para: ${patientName} (ID: ${patientId})`);

    // Use seu sistema de modal existente ou um alert simples
    if (typeof showModal === 'function') {
        showModal(
            'üó≥Ô∏è Vota√ß√£o em Aberto!', 
            `Paciente ${patientName} possui decis√µes pendentes com prazo em aberto.Por favor, acesse Cuidar e verifique o Hub de Decis√µes.`
        );
    } else {
        showModal('üó≥Ô∏è Vota√ß√£o em Aberto!' , 'O paciente ${patientName} possui decis√µes pendentes.\nAcesse o Dashboard para votar.');
    }
}

// Fun√ß√£o Principal Editada
function renderPatientList() {
    // 1. INTEGRA√á√ÉO DO ONBOARDING
    // Verifica se precisa mostrar o modal de boas-vindas sempre que tentar renderizar a lista
    // Passamos o state.patientsList para a fun√ß√£o decidir se abre o modal ou n√£o
    if (typeof checkOnboardingStatus === 'function') {
        checkOnboardingStatus(state.patientsList);
    }

    const container = document.getElementById('patientList');
    
    // 2. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    if (!container) return;

    container.innerHTML = '';

    // Verifica se a lista est√° vazia para mostrar a mensagem de fundo (Empty State)
    if (!state.patientsList || state.patientsList.length === 0) {
        // TRADU√á√ÉO: Mensagem de lista vazia
        const msg = t['msgNoPatients'] || "Nenhum paciente encontrado.";
        
        container.innerHTML = `
            <div class="text-center py-6 bg-gray-50 rounded-lg border border-gray-200">
                <p class="text-gray-500">${msg}</p>
            </div>`;
        return;
    }

    const list = document.createElement('div');
    list.className = 'space-y-3'; 

    const safeText = (text) => {
        if (typeof escapeHtml === 'function') return escapeHtml(text);
        if (!text) return '';
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    };

    state.patientsList.forEach(p => {
        const isAlert = (p.Notification == 1);
        const hasVote = (p.has_active_vote == 1);
        
        // TRADU√á√ÉO: Textos padr√£o
        const noDiagnosisText = t['noDiagnosis'] || 'Sem diagn√≥stico';
        const careBtnText = t['careBtn'] || 'Cuidar';
        const dashboardBtnText = t['dashboardBtn'] || 'Dashboard';
        
        const votingBadge = hasVote ? `
            <div onclick="showVotingAlert('${safeText(p.nickname)}', ${p.id}); event.stopPropagation();" 
                 class="absolute -top-2 -right-2 w-8 h-8 bg-purple-600 text-white rounded-full flex items-center justify-center shadow-lg cursor-pointer animate-bounce z-10 border-2 border-white" 
                 title="Vota√ß√£o Pendente">
                <span class="text-sm">üó≥Ô∏è</span>
            </div>
        ` : '';

        const card = document.createElement('div');
        
        card.className = `relative overflow-visible p-3 border rounded-xl flex items-center justify-between bg-white ${isAlert ? 'patient-alert' : 'border-gray-200'}`;

        card.innerHTML = `
            ${votingBadge}

            <div>
                <div class="font-semibold text-gray-800">${safeText(p.nickname)}</div>
                <div class="text-xs text-gray-500">${safeText(p.illness || noDiagnosisText)}</div>
            </div>
            
            <div class="flex items-center space-x-2">
                <button class="px-3 py-2 bg-blue-600 text-white rounded-lg" data-id="${p.id}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-bell ${isAlert ? 'pulse-red' : ''}"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                    <span data-i18n="careBtn">${careBtnText}</span>
                </button>

                <button onclick="openPatientDashboard('${p.id}')" 
                        class="px-3 py-2 bg-green-600 text-white rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 01-18 0 9 9 0 0118 0z" />
                        </svg>
                    <span data-i18n="dashboardBtn">${dashboardBtnText}</span>
                </button>
            </div>
        `;

        const btnCuidar = card.querySelector('button[data-id]');
        if (btnCuidar) {
            btnCuidar.addEventListener('click', (e) => {
                e.stopPropagation();
                selectExistingPatient(p.id);
            });
        }

        list.appendChild(card);
    });

    container.appendChild(list);
    
    // Opcional: Chama setAppLanguage novamente para garantir que outros elementos din√¢micos sejam traduzidos
    if (typeof setAppLanguage === 'function') {
        setAppLanguage(state.appLanguage);
    }
}

/**
 * Busca e atualiza a rela√ß√£o do cuidador com o paciente atual.
 * @param {string|number} patientId - ID do paciente selecionado
 */
async function updateCaregiverRelationContext(patientId) {
    
    console.log('chama a fun√ß√£o para rela√ß√£o para paciente:', patientId);
    console.log('cuidador:', state.userId);

    // Verifica√ß√£o de seguran√ßa
    if (!state.userId || !patientId) return;

    try {
        const response = await apiGet('get-caregiver-relation', {
            caregiverId: state.userId,
            patientId: patientId
        });

        if (response.success) {
            // 1. Atualiza o State Global
            const novaRelacao = response.relation || ''; // Garante string vazia se for null
            state.relation = novaRelacao;
            
            // 2. Atualiza o LocalStorage (para persist√™ncia se der F5)
            localStorage.setItem('relation', novaRelacao);
            
            console.log(`‚úÖ Contexto atualizado: Voc√™ √© "${novaRelacao}" deste paciente.`);
            
            // 3. (Opcional) Atualiza a UI se houver algum lugar mostrando isso
            document.getElementById('caregiverRelationDisplay').innerText = novaRelacao;
            
        } else {
            console.warn("Aviso: N√£o foi poss√≠vel obter a rela√ß√£o com o paciente.");
        }

    } catch (error) {
        console.error("Erro ao buscar rela√ß√£o:", error);
    }
}

async function selectExistingPatient(patientId) {
  if (!state.userId) { showModal('Erro', 'Usu√°rio n√£o autenticado'); return; }

  // ** NOVO: Parar alarme e polling **
  stopPatientAlarmAndPolling();

  const resp = await apiPost('select-patient-by-id', { patientId, caregiverId: state.userId, caregiverNickname: state.nickname });
  if (resp.success) {
    state.patientId = patientId;
    state.patient = resp.data;     
    state.currentPatient = resp.data;   
    
    // --- CORRE√á√ÉO 1: Pegar a propriedade espec√≠fica do c√≥digo ---
    // Verifica se veio 'access_code' (ingl√™s) ou 'codigo_acesso' (portugu√™s) dependendo do seu banco
    state.patientCode = resp.data.access_code || resp.data.codigo_acesso; 
    localStorage.setItem('patientCode', state.patientCode);

  
    // Presumindo que resp.data.survivalProbability cont√©m o valor salvo (padr√£o 100)
    state.gameStats.survivalProbability = parseFloat(resp.data.survivalProbability) || 100;
    state.gameStats.taskProgress = parseInt(resp.data.taskProgress) || 0; // ‚Üê CORRIGIDO
    state.gameStats.tasksCompleted = parseInt(resp.data.tasksCompleted) || 0; // ‚Üê CORRIGIDO
    currentPatientGender = resp.data.gender;

    if (resp.data.meta_display) {
            state.currentPatient.meta_display = resp.data.meta_display;
    }

    console.log("Paciente carregado:", state.currentPatient);


    updateDashboardMeta(state.currentPatient);

            
    console.log("G√™nero do paciente carregado:", currentPatientGender);

    startGame();
  } else {
    showModal('Erro', resp.message || 'N√£o foi poss√≠vel selecionar paciente.');
  }
}

async function createPatientProfile() {
  const nickname = document.getElementById('newPatientNickname').value.trim();
  const illness = document.getElementById('patientIllness').value.trim();
  if (!nickname || !illness) { showModal('Erro', 'Preencha apelido e doen√ßa do paciente.'); return; }
  const data = {
    caregiverId: state.userId,
    caregiverNickname: state.nickname || 'Cuidador',
    nickname,
    illness,
    weight: document.getElementById('patientWeight').value || null,
    height: document.getElementById('patientHeight').value || null,
    gender: document.getElementById('patientGender').value || null,
    allergies: document.getElementById('patientAllergies').value || null,
    patientDob: document.getElementById('patientDob').value || null
  };
  const resp = await apiPost('create-patient-profile', data);
  if (resp.success) {
    state.patientId = resp.data.patientId;
    state.patient = Object.assign({ id: state.patientId }, data);
    showModal('Paciente Criado', `Paciente criado com sucesso. ID: ${state.patientId}`);
    startGame();
  } else {
    showModal('Erro', resp.message || 'Falha ao criar paciente.');
  }
}

async function selectPatientByCode() {
  const codeInput = document.getElementById('patientCode');
  const code = codeInput.value.trim();

  if (!code) { 
    showModal('Erro', 'Por favor, insira o c√≥digo de acesso.'); 
    return; 
  }

  // ** NOVO: Parar alarme e polling (Mantido conforme solicitado) **
  // Verifique se esta fun√ß√£o existe no seu escopo global, caso contr√°rio, comente-a para testar
  if (typeof stopPatientAlarmAndPolling === 'function') {
      stopPatientAlarmAndPolling();
  }

  // Envia 'code' ao inv√©s de 'patientId', pois agora √© uma busca por c√≥digo alfanum√©rico
  const resp = await apiPost('select-patient-by-code', { 
      code: code, // <--- MUDAN√áA IMPORTANTE: A chave deve ser 'code'
      caregiverId: state.userId, 
      caregiverNickname: state.nickname 
  });

  if (resp.success) {
    const patientData = resp.data;

    // ATUALIZA√á√ÉO DO ESTADO GLOBAL
    // √â crucial salvar o ID num√©rico real no state.patientId, pois outras chamadas
    // (como salvar progresso, tarefas) provavelmente usam o ID num√©rico do banco.
    state.patientId = patientData.id; 
    state.patientCode = patientData.access_code || code; // Guarda o c√≥digo visual
    state.patient = patientData;

    // ATUALIZA√á√ÉO VISUAL (Se os elementos existirem na tela)
    const nameDisplay = document.getElementById('pacientNameDisplay');
    const idDisplay = document.getElementById('pacientIdDisplay');

    if (nameDisplay) nameDisplay.textContent = patientData.name || patientData.nome; // Suporta ingl√™s ou portugu√™s
    if (idDisplay) idDisplay.textContent = `C√≥d: ${state.patientCode}`;

    // SALVAR NA MEM√ìRIA LOCAL (Para recarregar a p√°gina sem perder o paciente)
    localStorage.setItem('patientId', state.patientId);
    localStorage.setItem('patientCode', state.patientCode);

    startGame();
  } else {
    showModal('Erro', resp.message || 'C√≥digo inv√°lido ou paciente n√£o encontrado.');
  }
}

// --- Chat (caregiver) ---
/**
 * Renderiza o hist√≥rico do chat de cuidadores
 */
function renderCaregiverChat() {
    const div = ui.caregiverChatHistory;
    div.innerHTML = '';
    
    // Obter o tipo de filtro atual
    const chatFilterElement = document.getElementById('chatFilter');
    const filterType = chatFilterElement ? chatFilterElement.value : 'patient';
    
    if (!state.caregiverChatHistory || state.caregiverChatHistory.length === 0) {
        const emptyMsg = document.createElement('div');
        emptyMsg.className = 'text-center text-gray-500 mt-4';
        
        if (filterType === 'nearby' && !state.caregiverLocationName) {
             emptyMsg.textContent = 'üìç Aguardando localiza√ß√£o GPS para exibir o chat pr√≥ximo...';
        } else if (filterType === 'nearby') {
             emptyMsg.textContent = 'üåç Nenhuma mensagem de cuidadores pr√≥ximos no momento.';
        } else {
             emptyMsg.textContent = 'Nenhuma mensagem ainda. Seja o primeiro a escrever!';
        }

        div.appendChild(emptyMsg);
        return;
    }
    
    // Reverter ordem (mais antiga primeiro)
    const reversedHistory = [...state.caregiverChatHistory].reverse(); 
    
    reversedHistory.forEach(msg => {
        const isOwnMessage = msg.sender_id == state.userId;
        const roleClass = isOwnMessage ? 'caregiver-message-self' : 'caregiver-message-other';
        
        const wrapper = document.createElement('div');
        wrapper.className = `flex mb-3 ${isOwnMessage ? 'justify-end' : 'justify-start'}`;
        
        const bubble = document.createElement('div');
        bubble.className = `p-3 rounded-xl message-bubble ${roleClass}`;

        // Nome do remetente
        const sender = document.createElement('p');
        sender.className = 'message-sender';
        
        let senderText = msg.sender_nickname || 'Cuidador';

        // ‚úÖ L√ìGICA DE EXIBI√á√ÉO CORRIGIDA
        if (filterType === 'nearby') {
             // Chat geogr√°fico: mostrar nome do cuidador + paciente
            if (msg.patientnickname) {
                senderText += ` (Paciente: ${msg.patientnickname})`; 
            }
            sender.textContent = senderText;
            bubble.appendChild(sender);
            
        } else if (filterType === 'patient' && !isOwnMessage) {
             // Chat do paciente: mostrar apenas nome do cuidador
            sender.textContent = senderText;
            bubble.appendChild(sender);
        }
        
        // Texto da mensagem
        const text = document.createElement('p');
        text.textContent = msg.text;
        bubble.appendChild(text);
        
        // Timestamp
        if (msg.created_at) {
            const time = document.createElement('p');
            time.className = 'text-xs opacity-70 mt-1';
            time.textContent = new Date(msg.created_at).toLocaleTimeString('pt-BR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            bubble.appendChild(time);
        }
        
        wrapper.appendChild(bubble);
        div.appendChild(wrapper);
    });
    
    // Scroll para o final
    div.scrollTop = div.scrollHeight;
}

async function pollCaregiverChat(force = false) {
  if (!state.patientId) return;

  const chatFilterElement = document.getElementById('chatFilter');
  const filterType = chatFilterElement ? chatFilterElement.value : 'patient';
  
  let resp;
  
  try {
      if (filterType === 'patient') {
        // L√≥gica para o chat do paciente (canal: patient_group)
        resp = await apiGet('get-caregiver-chat', {
          patientId: state.patientId,
          chatChannel: 'patient_group' 
        });

      } else if (filterType === 'nearby') {
        // ‚úÖ CORRE√á√ÉO: Verificar se a localiza√ß√£o est√° dispon√≠vel
        if (!state.caregiverLocationName) {
           console.warn('‚ö†Ô∏è Localiza√ß√£o n√£o dispon√≠vel para chat nearby');
           state.caregiverChatHistory = [];
           renderCaregiverChat();
           return; 
        }
        
        // 2. Chamar o endpoint geogr√°fico correto
        resp = await apiGet('get-caregiver-chat-geo', {
          caregiverId: state.userId,
          currentLocation: state.caregiverLocationName // Formato: "GPS: Lat X, Lon Y"
        });

      } else {
        return; // Filtro desconhecido
      }
  } catch (e) {
      console.error('Erro no poll do chat:', e);
      return;
  }
    
  // 3. Processar resposta
  if (resp && resp.success) {
    state.caregiverChatHistory = resp.data || [];
    renderCaregiverChat();
  }
}

/**
 * Retorna o nome do canal de chat baseado no filtro selecionado no modal.
 * @returns {string} 'patient_group' ou 'geo_group'
 */
function getCurrentChatChannel() {
    const chatFilterElement = document.getElementById('chatFilter');
    // Mapeamento: 'patient' -> 'patient_group', 'nearby' -> 'geogroup'
    const filterType = chatFilterElement ? chatFilterElement.value : 'patient';
    return filterType === 'patient' ? 'patient_group' : 'geogroup'; // << MUDAN√áA AQUI: 'geogroup'
}


// index.html - Substituir a fun√ß√£o `sendCaregiverMessage`
/**
 * Envia mensagem para o chat de cuidadores (salva no backend)
 */
/**
 * Envia mensagem para o chat de cuidadores (salva no backend)
 */
async function sendCaregiverMessage() {
    const messageText = ui.caregiverChatInput.value.trim();
    if (messageText === '') return;

    const chatChannel = getCurrentChatChannel(); // 'patient_group' ou 'geo_group'

    // ‚úÖ Valida√ß√£o para chat geogr√°fico
    if (chatChannel === 'geo_group') {
        if (!state.caregiverLocationName) {
            showStatusMessage('‚ö†Ô∏è Aguardando sua localiza√ß√£o GPS...');
            return;
        }
        
        // Extrair lat e lon do formato "GPS: Lat X, Lon Y"
        const match = state.caregiverLocationName.match(/Lat\s*(-?\d+\.\d+),\s*Lon\s*(-?\d+\.\d+)/);
        if (!match) {
            showStatusMessage('‚ùå Erro: Localiza√ß√£o em formato inv√°lido');
            return;
        }
    }

    const payload = {
        patientId: state.patientId,
        senderId: state.userId,
        senderNickname: state.nickname,
        text: messageText,
        chatChannel: chatChannel
    };

    // Adicionar localiza√ß√£o apenas para geo_group
    if (chatChannel === 'geo_group') {
        const match = state.caregiverLocationName.match(/Lat\s*(-?\d+\.\d+),\s*Lon\s*(-?\d+\.\d+)/);
        payload.originLocation = `${match[1]},${match[2]}`; // Formato: "lat,lon"
    }

    ui.caregiverChatInput.value = '';

    try {
        const resp = await apiPost('send-caregiver-message', payload);

        if (resp.success) {
            pollCaregiverChat(true); // Atualizar imediatamente
        } else {
            showStatusMessage('‚ùå Erro ao enviar mensagem.');
            console.error(resp.message);
        }
    } catch (e) {
        showStatusMessage('‚ùå Erro de rede ao enviar mensagem.');
        console.error(e);
    }
}
// --- Game / Actions / Notifications ---    
function updateDateTime() {
  const now = new Date();
  ui.currentTime.textContent = `${now.toLocaleDateString('pt-BR')} ${now.toLocaleTimeString('pt-BR')}`;
}


// fun√ß√µes de escala de cuidadores
// Vari√°vel global para controlar se o turno est√° ativo localmente
let currentShiftId = null; 
const RAIO_ACEITAVEL_METROS = 50; // Limite para check-in

// --- Fun√ß√µes curtas para chamar a API (Helpers) ---
async function apiStartShift(patientId) {
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    const userId = localStorage.getItem('userId');
    
    console.log("Tentando iniciar turno...");

    if (!userId || !patientId) {
        console.error("‚ùå ERRO: IDs inv√°lidos para iniciar escala.");
        return;
    }

    //se n√£o tem a localiza√ß√£o, n√£o deixa come√ßar o turno
    if(state.hasLocationDefined !== true){
        console.log("Falhou o turno: sem local salvo");
         showModal(
                    t['shiftLocationTitle'] || 'Aten√ß√£o √† Localiza√ß√£o', 
                    t['shiftLocationMsg'] || "Ol√°! Est√° ao lado do(a) Paciente? Se sim, lembre-se de informar a localiza√ß√£o atual."
                );
          return;
    }



    try {
        const res = await fetch('api.php?action=shift-start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Timezone': (typeof userTimezone !== 'undefined' ? userTimezone : 'UTC') },
            body: JSON.stringify({ patient_id: patientId, caregiver_id: userId })
        });
        
        const text = await res.text(); 
        const data = JSON.parse(text);

        if (data.success) {
            currentShiftId = data.shift_id;
            console.log("‚úÖ Check-in SUCESSO. Turno ID:", currentShiftId);

            // --- L√ìGICA DE LOCALIZA√á√ÉO ---
            const headerDisplay = document.getElementById('hospitalNameDisplay');
            
            // 1. Verifica√ß√£o Visual: Verifica se tem QUALQUER classe vermelha de alerta
            // (Isso cobre text-red-500, text-red-600, etc.)
            const isRedAlert = headerDisplay && (
                headerDisplay.classList.contains('text-red-500') || 
                headerDisplay.classList.contains('text-red-600')
            );

            // 2. Verifica√ß√£o de Estado: (state.hasLocationDefined !== true cobre false e undefined)
            // Se undefined, assume risco e avisa.
            const isLocationMissing = (typeof state !== 'undefined' && state.hasLocationDefined !== true);

            console.log ('avalia√ß√£o de local para turno:', isLocationMissing );

            if (isRedAlert || isLocationMissing) {
                // CEN√ÅRIO: Local errado ou n√£o definido
                showModal(
                    t['shiftLocationTitle'] || 'Aten√ß√£o √† Localiza√ß√£o', 
                    t['shiftLocationMsg'] || "Ol√°! Est√° ao lado do(a) Paciente? Se sim, lembre-se de informar a localiza√ß√£o atual."
                );
            } else {
                // CEN√ÅRIO: Tudo certo
                showModal(
                    t['shiftSuccessTitle'] || 'Hora do Show', 
                    t['shiftSuccessMsg'] || "‚úÖ Em suas m√£os est√° Acura: Cuide sempre com carinho! Importante: deixe a tela ativa."
                );
            }

            // --- [IMPORTANTE] ATUALIZA√á√ÉO DA TELA ---
            // Sem isso, o bot√£o de "Iniciar Turno" n√£o muda para "Encerrar Turno"
            if (typeof updateShiftButtonsUI === 'function') updateShiftButtonsUI(true);
            if (typeof startShiftMonitoring === 'function') startShiftMonitoring();

        } else {
            console.warn("‚ö†Ô∏è API retornou erro:", data.message);
            showModal(t['modalWarningTitle'] || 'Aviso', data.message || "N√£o foi poss√≠vel iniciar o turno.");
        }
    } catch (e) { 
        console.error("‚ùå Erro fatal ao iniciar turno:", e); 
        showModal(t['modalErrorTitle'] || 'Erro', "Erro de conex√£o ao iniciar o turno.");
    }
}

async function apiEndShift(motivo) {
    if (!currentShiftId) return; // N√£o faz nada se n√£o tiver turno aberto

    try {
        const res = await fetch('api.php?action=shift-end', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json','X-Timezone': userTimezone },
            body: JSON.stringify({ shift_id: currentShiftId, motivo: motivo })
        });
        const data = await res.json();
        if (data.success) {
            console.log("üõë Check-out realizado:", motivo);
            currentShiftId = null;
            // Opcional: Atualizar UI para remover status "Em Plant√£o"
        }
    } catch (e) { console.error("Erro ao encerrar turno:", e); }
}


// Geolocaliza√ß√£o
async function getGeolocationAndName() {
  if (!navigator.geolocation) {
    ui.caregiverLocation.textContent = 'GPS n√£o suportado.';
    ui.hospitalNameDisplay.textContent = 'Localiza√ß√£o Padr√£o';
    return;
  }

  const timeout = new Promise((_, reject) =>
    setTimeout(() => reject(new Error('Timeout de localiza√ß√£o')), 5000)
  );

  try {
    const position = await Promise.race([
      new Promise((resolve, reject) => 
        navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 })
      ), 
      timeout
    ]);
    
    const lat = position.coords.latitude;  //-22.56303091719863; // - Hospital Unimed Limeira (para teste)
    const lon = position.coords.longitude;  //-47.403710935310286; //
    state.caregiverLocation = { lat, lon };

    // Formatamos para 4 casas decimais para maior precis√£o e clareza
    const coordinateDisplay = `GPS: Lat ${lat.toFixed(4)}, Lon ${lon.toFixed(4)}`;

    // Atribui as coordenadas ao elemento caregiverLocation
    ui.caregiverLocation.textContent = coordinateDisplay;
    state.caregiverLocationName = coordinateDisplay; // Atualiza o estado

    // Atualiza√ß√£o do hospitalNameDisplay (mantida da corre√ß√£o anterior)
    ui.hospitalNameDisplay.textContent = 'Identificando..';

   
    //nominatim.openstreetmap
    const geoResponse = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=jsonv2&layer=address&zoom=18`,
          { headers: { 'User-Agent': 'CuidadorSimApp/1.0' } });
    
    if (!geoResponse.ok) throw new Error("Erro ao consultar Nominatim");
    const geoData = await geoResponse.json(); 
    const addr = geoData.name || {}; //era address
    let hospitalNameTemp = "HomeCare";

      
      if (addr === null){
          ui.hospitalNameDisplay.textContent = hospitalNameTemp; 
      }else{
          ui.hospitalNameDisplay.textContent = addr; 
      }
                
          

    // *****************************************************************

  } catch (error) {
    // Trata falhas de rede ou timeout
    console.error("Erro ao obter dados de Nominatim:", error);
    ui.hospitalNameDisplay.textContent = '-HomeCare-';
    //ui.caregiverLocation.textContent = 'Localiza√ß√£o Indispon√≠vel';
  }
}


/* --- L√ìGICA DE GEOFENCING E VALIDA√á√ÉO DE LOCAL --- */

// F√≥rmula de Haversine para calcular dist√¢ncia em Metros
function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
    const R = 6371e3; // Raio da terra em metros
    const dLat = deg2rad(lat2 - lat1);
    const dLon = deg2rad(lon2 - lon1);
    const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    const distance = R * c; // Dist√¢ncia em metros
    return distance;
}

function deg2rad(deg) {
    return deg * (Math.PI / 180);
}

// Fun√ß√£o Principal: Verifica se o GPS atual bate com o salvo
// Fun√ß√£o Principal: Verifica GPS e Gerencia a Escala (Check-in/Out)
/**
 * Verifica se o cuidador est√° no local correto (Geofencing)
 * CORRIGIDA: Agora avisa se n√£o houver local salvo!
 */
/**
 * Verifica se o paciente tem local definido e se o cuidador est√° l√°.
 */
async function checkLocationConsistency() {
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    // 1. Inicializa estado como FALSE por seguran√ßa
    if (typeof state !== 'undefined') state.hasLocationDefined = false;

    if (!state.currentPatientId || !navigator.geolocation) return;

    try {
        // Consulta o banco de dados (patient_location_history)
        const response = await apiGet('get-last-location', { patientId: state.currentPatientId });
        const headerDisplay = document.getElementById('hospitalNameDisplay');
        
        // --- CEN√ÅRIO 1: NENHUM LOCAL SALVO NO BANCO ---
        if (!response.success || !response.data || !response.data.latitude) {
            console.warn("‚ö†Ô∏è CheckLocation: Paciente sem hist√≥rico de localiza√ß√£o.");
            
            // Marca no estado global que n√£o temos local
            state.hasLocationDefined = false;

            if (headerDisplay) {
                headerDisplay.innerText = t['locationNotDefined'] || "Local N√£o Definido üìç";
                headerDisplay.classList.add('text-red-500', 'animate-pulse');
                headerDisplay.onclick = () => { if(typeof saveCaregiverLocation === 'function') saveCaregiverLocation(); };
            }

            // EXIBE O MODAL DE INCENTIVO (Uma vez por sess√£o)
            if (!sessionStorage.getItem('location_warning_shown')) {
                const titleLoc = t['titleLocationNeeded'] || "Defina o Local do Paciente";
                const msgLoc = t['msgLocationNeeded'] || "Para monitorar sua presen√ßa corretamente, precisamos saber onde o paciente est√°.\n\nToque no texto 'Local N√£o Definido' para salvar sua posi√ß√£o atual.";
                
                if (typeof showModal === 'function') showModal(titleLoc, msgLoc);
                else alert(msgLoc);
                
                sessionStorage.setItem('location_warning_shown', 'true');
            }
            return; // Sai, pois n√£o d√° para calcular dist√¢ncia sem local alvo
        }

        // --- CEN√ÅRIO 2: LOCAL ENCONTRADO (C√°lculo de Dist√¢ncia) ---
        state.hasLocationDefined = true; // Marca que temos local
        
        const savedLoc = response.data;
        const savedLat = parseFloat(savedLoc.latitude);
        const savedLng = parseFloat(savedLoc.longitude);

        navigator.geolocation.getCurrentPosition((position) => {
            const currentLat = position.coords.latitude;
            const currentLng = position.coords.longitude;
            const distMeters = getDistanceFromLatLonInMeters(savedLat, savedLng, currentLat, currentLng);
            const RAIO_ACEITAVEL = 200;

            if (headerDisplay) {
                if (distMeters <= RAIO_ACEITAVEL) {
                    headerDisplay.innerText = savedLoc.hospital_name || "Resid√™ncia/Hospital";
                    headerDisplay.classList.remove('text-red-500', 'animate-pulse');
                    headerDisplay.classList.add('text-gray-700');
                    headerDisplay.onclick = null;
                } else {
                    const distKm = (distMeters / 1000).toFixed(1);
                    headerDisplay.innerText = `${t['locationFar'] || 'Fora do Local'} (${distKm}km)`;
                    headerDisplay.classList.add('text-red-500');
                }
            }
        });

    } catch (e) {
        console.error("Erro no checkLocation:", e);
    }
}

function showStatusMessage(message) {
  ui.statusMessage.textContent = message;
  ui.statusMessage.classList.remove('hidden');
  setTimeout(() => ui.statusMessage.classList.add('hidden'), 3000);
}

function updateStatsUI() {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    // C√°lculo do Progresso (Mantido)
    const progress = state.gameStats.totalTasks ? 
        (state.gameStats.tasksCompleted / state.gameStats.totalTasks) * 100 : 0;
    
    if(ui.progressFill) ui.progressFill.style.width = `${progress}%`;
    if(ui.taskProgress) ui.taskProgress.textContent = `${Math.round(progress)}%`;
    state.gameStats.taskProgress = Math.round(progress);  

    // L√≥gica do Dropdown
    const valueDisplayElement = document.getElementById('meta-value-display');
    const selectElement = document.getElementById('meta-display-select');
    
    // DEFINI√á√ÉO DA META ATUAL
    // Usa a tradu√ß√£o padr√£o se n√£o houver meta salva
    const defaultMeta = t['metaCureProb']; 
    
    // Nota: Se o valor salvo no banco estiver em outro idioma (ex: "Probabilidade de Cura" e o app est√° em Ingl√™s),
    // o select pode n√£o encontrar a op√ß√£o correspondente e voltar√° para o padr√£o. 
    // Isso se corrige assim que o usu√°rio selecionar uma nova op√ß√£o no idioma atual.
    const currentMeta = (state.currentPatient && state.currentPatient.meta_display) 
                        ? state.currentPatient.meta_display 
                        : defaultMeta;

    if (!valueDisplayElement) {
        // --- CEN√ÅRIO 1: Renderiza√ß√£o Inicial ---
        // Cria o HTML do dropdown injetando as tradu√ß√µes nas op√ß√µes
        ui.survivalProbability.innerHTML = `
            <div class="flex flex-col w-full">
                <div class="relative w-full border-b border-dashed border-gray-400 mb-1">
                    <select id="meta-display-select" onchange="updateMetaDisplay(this.value)" 
                            class="w-full bg-transparent font-bold text-gray-800 focus:outline-none cursor-pointer appearance-none py-1 pr-6 truncate">
                        <option value="${t['metaCureProb']}">${t['metaCureProb']}</option>
                        <option value="${t['metaChronicIndex']}">${t['metaChronicIndex']}</option>
                        <option value="${t['metaBridgeTherapy']}">${t['metaBridgeTherapy']}</option>
                        <option value="${t['metaPalliative']}">${t['metaPalliative']}</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-1 text-gray-700">
                         <svg class="fill-current h-4 w-4" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>
                <div class="text-right">
                    <span id="meta-value-display" class="text-xl font-bold text-blue-600">
                        ${state.gameStats.survivalProbability}%
                    </span>
                </div>
            </div>
        `;
        
        // For√ßa o valor inicial do select
        const newSelect = document.getElementById('meta-display-select');
        // Verifica se a op√ß√£o existe antes de setar (para evitar bugs de troca de idioma)
        const optionExists = Array.from(newSelect.options).some(o => o.value === currentMeta);
        if (optionExists) {
            newSelect.value = currentMeta;
        } else {
            newSelect.value = defaultMeta;
        }

    } else {
        // --- CEN√ÅRIO 2: Atualiza√ß√£o de Rotina ---
        valueDisplayElement.textContent = `${state.gameStats.survivalProbability}%`;
        
        if (selectElement && selectElement.value !== currentMeta) {
             // Verifica se a op√ß√£o existe antes de setar
             const optionExists = Array.from(selectElement.options).some(o => o.value === currentMeta);
             if (optionExists) {
                 selectElement.value = currentMeta;
             }
        }
    }

    updateSurvivalCircle(state.gameStats.survivalProbability);

    if (state.patientId && state.gameStats.survivalProbability !== undefined) {
        saveSurvivalProbability();
    }
}

/**
 * Envia a probabilidade de cura e progresso de tarefas atualizada para o backend.
 * Deve ser chamado sempre que state.gameStats.survivalProbability mudar.
 */
async function saveSurvivalProbability() {
    if (!state.patientId) {
        console.error('saveSurvivalProbability: Paciente n√£o selecionado.');
        return;
    }

    // 1. Obt√©m o valor bruto do estado
    let rawProbability = state.gameStats.survivalProbability;

    // 2. APLICA A REGRA DE OURO (Trava de Seguran√ßa) antes de salvar
    // Math.max(1, X) -> Se X for menor que 1 (ex: 0, -5), retorna 1.
    // Math.min(100, Y) -> Se Y for maior que 100 (ex: 105), retorna 100.
    const probabilityToSave = Math.max(1, Math.min(100, rawProbability));

    const currentTaskProgress = state.gameStats.taskProgress || 0;
    const currentTaskCompleted = state.gameStats.tasksCompleted || 0;

    console.log(`üì° Salvando Probabilidade de Cura: ${probabilityToSave}% (Original: ${rawProbability}%) para o(a) Paciente ID: ${state.patientId}`);

    const resp = await apiPost('update-survival-probability', {
        patientId: state.patientId,
        probability: probabilityToSave, // ‚úÖ Envia o valor tratado (m√≠nimo 1%)
        task_progress: currentTaskProgress,
        task_completed: currentTaskCompleted
    });

    if (resp.success) {
        console.log('‚úÖ Probabilidade de cura salva com sucesso.');
        
        // Opcional: Atualiza o estado local caso ele estivesse errado (ex: estava 0, agora fica 1)
        if (state.gameStats.survivalProbability !== probabilityToSave) {
             state.gameStats.survivalProbability = probabilityToSave;
             // Se tiver uma fun√ß√£o de renderizar a barra, chame-a aqui para corrigir visualmente tamb√©m
             if (typeof renderSurvivalBar === 'function') renderSurvivalBar(state.patientData); 
        }

    } else {
        console.error('‚ùå Falha ao salvar probabilidade de cura:', resp.message || 'Erro de servidor.');
    }
}


function displayNotificationMessage(task, message) {
    const messageElement = document.getElementById(`notification-message-${task}`);
    if (messageElement) {
        messageElement.textContent = message;
        messageElement.classList.remove('hidden'); // Exibe a mensagem
        state.activeNotifications[task] = true;   // Marca como ativa
    }
}

function hideNotificationMessage(task) {
    const messageElement = document.getElementById(`notification-message-${task}`);
    if (messageElement) {
        messageElement.classList.add('hidden'); // Esconde a mensagem
        delete state.activeNotifications[task];  // Remove do rastreamento
    }
}

function performAction(action) {
    const agora = new Date().getTime();

    const DIARY_ACTIONS = ['food', 'pain', 'meds', 'infusion', 'physio', 'excretion', 'heartbeat', 'blood'];

    if (action === 'phone') { // <<< ADICIONE ESTE BLOCO
        openPhysicalMeasurementsModal();
        return; 
    }

      if (DIARY_ACTIONS.includes(action)) {
          // Para 'heartbeat' e 'blood', o listener DOMContentLoaded j√° chama openDiaryModal
          // com o tipo '_manual', mas deixamos aqui como fallback seguro.
          if (action === 'heartbeat') { //|| action === 'blood'
              openDiaryModal(action + '_manual'); 
          } else {
              openDiaryModal(action);
          }
          return; // Sai da fun√ß√£o, a l√≥gica de sucesso/falha √© movida para saveDiaryEntry
      }
    
    // 1. Encontrar a pr√≥xima notifica√ß√£o de mesmo 'action' que ainda n√£o foi completada
    const nextNotification = state.pendingNotifications.find(
        n => n.task === action && !n.completed
    );

    if (!nextNotification) {
        // Se todas as tarefas para este tipo (action) j√° foram completadas hoje
        showStatusMessage('‚úÖ Tarefa do dia para ' + action + ' j√° completada.');
        return;
    }

    const scheduledTime = nextNotification.scheduledTime.getTime();
    const isTriggered = nextNotification.triggered;

    let successMessage = '';
    let probabilityIncrease = 0;

    // Cen√°rio A: A√ß√£o Antecipada (Antes do hor√°rio agendado)
    if (agora < scheduledTime) {
        successMessage = 'Antecipa√ß√£o: ' + nextNotification.message;
        probabilityIncrease = 1; // B√îNUS menor por antecipa√ß√£o
    } 
    // Cen√°rio B: A√ß√£o Tardia ou no Prazo (No ou ap√≥s o hor√°rio agendado)
    // O clique √© feito para a tarefa mais urgente/pr√≥xima
    else {
        // O aviso ter sido disparado (isTriggered) n√£o √© mais estritamente necess√°rio
        // para considerar sucesso, apenas para calcular o b√¥nus.
        successMessage = nextNotification.message;
        probabilityIncrease = 3; // Aumento maior por fazer no prazo/tardio
    } 
    
    // Aplica√ß√£o das Mudan√ßas (L√≥gica Comum de Sucesso)
    
    // 2. Marcar a notifica√ß√£o como completada
    nextNotification.completed = true;
    state.gameStats.tasksCompleted++;
    
    // 3. Incrementar a probabilidade
    state.gameStats.survivalProbability = Math.min(100, state.gameStats.survivalProbability + probabilityIncrease); 
    
    // 4. Limpar a UI
    hideNotificationMessage(action);
    removeTaskPendingIndicator(action);

    // 5. Feedback Visual
    showCelebrationMessage(successMessage);
    
    // 6. Atualizar UI e checar conclus√£o total
    updateStatsUI();
    checkAllTasksCompleted();
}

/**
 * Mostra mensagem de celebra√ß√£o animada
 */
function showCelebrationMessage(taskMessage) {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    // 2. Monta o array usando as chaves de tradu√ß√£o
    const messages = [
        t['celMsg1'] || 'üéâ Parab√©ns! Tarefa conclu√≠da!',
        t['celMsg2'] || '‚≠ê Excelente trabalho!',
        t['celMsg3'] || 'üëè Muito bem! Continue assim!',
        t['celMsg4'] || '‚ú® √ìtimo! Voc√™ est√° cuidando bem!',
        t['celMsg5'] || 'üåü Perfeito! Mais uma tarefa!',
        t['celMsg6'] || 'üí™ Isso a√≠! Voc√™ conseguiu!'
    ];
  
    // Seleciona uma mensagem aleat√≥ria
    const randomMessage = messages[Math.floor(Math.random() * messages.length)];
  
    const celebration = document.createElement('div');
    celebration.className = 'celebration-message';
    
    // Nota: Assumimos que 'taskMessage' j√° vem traduzido da fun√ß√£o que chamou esta
    celebration.innerHTML = `
        <div>${randomMessage}</div>
        <div style="font-size: 16px; margin-top: 10px; opacity: 0.9;">${taskMessage}</div>
    `;
  
    document.body.appendChild(celebration);
  
    // Remover ap√≥s 2 segundos (Anima√ß√£o mantida)
    setTimeout(() => {
        celebration.style.animation = 'celebrationPop 0.3s ease-in reverse';
        setTimeout(() => celebration.remove(), 300);
    }, 2000);
}

/**
 * Verifica se todas as tarefas do dia foram completadas
 */
function checkAllTasksCompleted() {
    const totalTasks = state.pendingNotifications.length;
    const completedTasks = state.pendingNotifications.filter(n => n.completed).length;
  
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    if (completedTasks === totalTasks && totalTasks > 0) {
        setTimeout(() => {
            // 2. Busca o modelo de texto traduzido
            let msg = t['msgAllTasksCompleted'];

            // Fallback de seguran√ßa
            if (!msg) {
                msg = `Voc√™ completou todas as {total} tarefas do dia!\n\nProbabilidade de recupera√ß√£o: {prob}%\n\nContinue esse excelente trabalho! üí™`;
            }

            // 3. Substitui os placeholders pelos valores reais
            msg = msg.replace('{total}', totalTasks)
                     .replace('{prob}', state.gameStats.survivalProbability);

            // 4. Exibe o modal traduzido
            showModal(
                t['modalCongratsTitle'] || 'üèÜ Parab√©ns!',
                msg
            );
        }, 2500);
    }
}

// NOVO: Fun√ß√£o de suporte para configurar e sincronizar sliders
function setupPhysicalRangeSlider(rangeId, valueId, minVal, maxVal, stepVal) {
    const rangeInput = document.getElementById(rangeId);
    const valueInput = document.getElementById(valueId);

    if (rangeInput && valueInput) {
        // 1. Configurar Range
        rangeInput.min = minVal;
        rangeInput.max = maxVal;
        rangeInput.step = stepVal;
        
        // 2. Sincronizar Range com Valor (Inicial)
        // O valor inicial √© o m√≠nimo (ou 0, dependendo do contexto)
        const initialValue = parseFloat(valueInput.value) || minVal; 
        rangeInput.value = initialValue; 
        valueInput.value = initialValue.toFixed((stepVal.toString().split('.')[1] || '').length);

        // 3. Sincroniza√ß√£o em tempo real (Slider -> Campo de Valor)
        rangeInput.oninput = function() {
            // Calcula as casas decimais a partir do step
            const decimals = (stepVal.toString().split('.')[1] || '').length;
            valueInput.value = parseFloat(this.value).toFixed(decimals);
        };
        
        // Garante que o campo num√©rico de feedback seja readonly
        valueInput.setAttribute('readonly', 'true');
    }
}

function openPhysicalMeasurementsModal() {
    // 1. Exibir o modal
    const modal = document.getElementById('physicalMeasurementsModal');
    modal.classList.remove('hidden');
    // Adiciona flex para garantir centraliza√ß√£o (caso sua classe 'hidden' remova o display flex)
    modal.classList.add('flex'); 

    // 2. Limpar dados anteriores
    document.getElementById('physicalMeasurementsForm').reset();
    showStatusMessage('üìù Registrando');

    // 3. Descobrir qual sistema usar (Estado Global > LocalStorage > Padr√£o M√©trico)
    // Certifique-se de que a vari√°vel 'state' existe, sen√£o usa apenas localStorage
    const savedSystem = (typeof state !== 'undefined' && state.measurementUnit) 
                        ? state.measurementUnit 
                        : (localStorage.getItem('measurementSystem') || 'metric');

    // 4. For√ßar a interface a ficar coerente (Labels iguais aos Selectors)
    // Isso corrige o problema de "Weight (lbs)" aparecer com seletor em "kg"
    if (typeof updateMeasurementUI === 'function') {
        updateMeasurementUI(savedSystem, savedSystem);
    }

    // 5. Pegar os limites corretos da configura√ß√£o (M√©trico ou Imperial)
    const config = MEASUREMENT_CONFIG[savedSystem];

    // 6. Inicializar os sliders com os valores din√¢micos da config
    // Ex: Se for metric, height max √© 2.5. Se for imperial, height max √© 8.2
    setupPhysicalRangeSlider('rangeWeight', 'pMWeight', config.weight.min, config.weight.max, config.weight.step);
    setupPhysicalRangeSlider('rangeHeight', 'pMHeight', config.height.min, config.height.max, config.height.step);
    setupPhysicalRangeSlider('rangeCircumference', 'pMAbdominalCircumference', config.circumference.min, config.circumference.max, config.circumference.step);
}

function closePhysicalMeasurementsModal() {
    document.getElementById('physicalMeasurementsModal').classList.add('hidden');
}

async function savePhysicalMeasurements() {
    // Coletar dados
    const peso = document.getElementById('pMWeight').value;
    const altura = document.getElementById('pMHeight').value;
    const circAbdominal = document.getElementById('pMAbdominalCircumference').value;
    const notes = document.getElementById('pMNotes').value;

    if (!state.patientId || !state.userId) {
        showStatusMessage('‚ùå Erro: Selecione paciente e fa√ßa login.');
        return;
    }
    
    // Verifica√ß√£o simples se pelo menos um campo de medida foi preenchido
    if (!peso && !altura && !circAbdominal) {
        showStatusMessage('‚ö†Ô∏è Preencha pelo menos uma medida.');
        return;
    }

    const payload = {
        patientId: state.patientId,
        caregiverId: state.userId,
        weight: peso,
        height: altura,
        abdominalCircumference: circAbdominal,
        notes: notes
    };

    const resp = await apiPost('save-physical-measurements', payload);

    if (resp.success) {
        showCelebrationMessage('‚úÖ Medidas f√≠sicas salvas!');
        closePhysicalMeasurementsModal();
    } else {
        showStatusMessage('‚ùå Falha ao salvar medidas: ' + (resp.message || 'Erro de servidor.'));
    }
}

const DIARY_CONFIGS = {
    'food': {
        titleKey: 'diaryTitle_food',
        label1Key: 'labelFoodQty', 
        unit1: ['g'], // CHAVE T√âCNICA: O dicion√°rio traduzir√° 'g' para 'g (gramas)'
        min1: 0, max1: 900, step1: 10,
        show2: false,
        showVitalSigns: false
    },
    'meds': {
        titleKey: 'diaryTitle_drinks', 
        label1Key: 'labelVolDose', 
        unit1: ['ml'], // CHAVE T√âCNICA: O dicion√°rio traduzir√° 'ml' para 'ml (mililitros)'
        min1: 0, max1: 1000, step1: 50,
        show2: false,
        showVitalSigns: false
    },
    'pain': {
        titleKey: 'diaryTitle_pain',
        label1Key: 'labelPainLevel', unit1: ['scale'],
        min1: 1, max1: 10, step1: 1,
        show2: true, 
        label2Key: 'labelSatisfaction', unit2: ['scale'],
        min2: 1, max2: 10, step2: 1,        
        showVitalSigns: false
    },
    'infusion': { 
        titleKey: 'diaryTitle_sleep',
        label1Key: 'labelDuration', unit1: ['h'],
        min1: 0.5, max1: 24, step1: 0.5,
        show2: false,
        showVitalSigns: false
    },
    'physio': {
        titleKey: 'diaryTitle_physio',
        label1Key: 'labelSessionDuration', unit1: ['min'],
        min1: 0, max1: 120, step1: 5,
        show2: false,
        showVitalSigns: false
    },
    'excretion': {
        titleKey: 'diaryTitle_excretion',
        label1Key: 'labelLiquidExcretion', unit1: ['ml'],
        min1: 0, max1: 1000, step1: 10,
        show2: true, 
        label2Key: 'labelSolidExcretion', unit2: ['g'],
        min2: 0, max2: 800, step2: 10,
        showVitalSigns: false
    },
    'heartbeat_manual': {
        titleKey: 'diaryTitle_vitals',
        label1Key: 'labelHeartRate', unit1: ['bpm'],
        min1: 30, max1: 250, step1: 1,
        show2: true, 
        label2Key: 'labelRespRate', unit2: ['rpm'],
        min2: 10, max2: 40, step2: 1,
        showCamera: true, 
        cameraType: 'monitor',
        showVitalSigns: true, 
        min3: 70, max3: 100, step3: 1,
        min5: 35.0, max5: 41.0, step5: 0.1
    },
    'blood_manual': {
        titleKey: 'diaryTitle_lab',
        label1Key: 'labelExamType', unit1: ['exam'],
        show2: true, 
        label2Key: 'labelResultMain', unit2: ['g/dL', 'mg/dL', 'ml', 'UI/L'],
        showCamera: true,
        cameraType: 'blood',
        showVitalSigns: false
    }
};

function setupRangeSlider(index, config) {
    // Note: index pode ser 1, 2, 3, ou 5.
    const rangeInput = document.getElementById(`range${index}`);
    const valueInput = document.getElementById(`value${index}`);
    const minVal = config[`min${index}`] || 0;
    const maxVal = config[`max${index}`] || 100;
    const stepVal = config[`step${index}`] || 1;

    if (rangeInput && valueInput) {
        // Configura as propriedades min/max/step/value
        rangeInput.min = minVal;
        rangeInput.max = maxVal;
        rangeInput.step = stepVal;
        
        // Define o valor inicial como o valor m√≠nimo
        rangeInput.value = minVal; 
        valueInput.value = minVal;
        
        // Sincroniza√ß√£o em tempo real (Slider -> Campo de Valor)
        rangeInput.oninput = function() {
            // Arredonda para o n√∫mero de casas decimais do 'step'
            const decimals = (stepVal.toString().split('.')[1] || '').length;
            valueInput.value = parseFloat(this.value).toFixed(decimals);
        };
       
        // Garante que o campo de valor num√©rico n√£o seja usado se n√£o for um campo de slider (ex: Exame/Texto)
        valueInput.classList.toggle('hidden', valueInput.type === 'text');
    }
}


function openDiaryModal(action) {
    const config = DIARY_CONFIGS[action];
    if (!config) return;

    // Acesso ao dicion√°rio atual
    const t = LANG_STRINGS[currentLang]; 

    // Mapeamento dos Elementos
    const labExamFields = document.querySelector("#labExamFields");
    const inputGroup1 = document.getElementById('inputGroup1');
    const inputGroup2 = document.getElementById('inputGroup2');
    
    const vitalGroups = [
        document.getElementById('inputGroup3'), // Oximetria
        document.getElementById('inputGroup4'), // PA
        document.getElementById('inputGroup5')  // Temperatura
    ];

    // 1. T√çTULO (Agora busca a tradu√ß√£o da chave definida na config)
    // Se config.titleKey n√£o existir, tenta usar config.title como fallback ou string vazia
    document.getElementById('diaryModalTitle').textContent = t[config.titleKey] || config.title;
    
    document.getElementById('diaryActionType').value = action;
    document.getElementById('diaryForm').reset();

    // 2. L√≥gica de Exibi√ß√£o
    if (action === 'blood_manual') {
        // === MODO EXAME LABORATORIAL ===
        if (labExamFields) labExamFields.classList.remove("hidden");
        
        if (inputGroup1) inputGroup1.classList.add("hidden");
        if (inputGroup2) inputGroup2.classList.add("hidden");
        vitalGroups.forEach(g => g && g.classList.add("hidden"));

        document.getElementById('value1')?.removeAttribute('required');
        document.getElementById('value2')?.removeAttribute('required'); 
        document.getElementById('diaryDate')?.removeAttribute('required');

    } else {
        // === MODO GEN√âRICO ===
        if (labExamFields) labExamFields.classList.add("hidden");

        // b) Configura Grupo 1
        if (inputGroup1) {
            inputGroup1.classList.remove("hidden");
            
            // TRADU√á√ÉO DO LABEL 1
            const label1Text = t[config.label1Key] || config.label1;
            document.getElementById('label1').textContent = label1Text + ':';
            
            const unit1Select = document.getElementById('unit1');
            if (unit1Select) {
                // TRADU√á√ÉO DAS UNIDADES (Se forem palavras como 'colher', 'comprimido')
                // Se forem universais (mg, ml), a chave retorna ela mesma
                unit1Select.innerHTML = config.unit1.map(unitKey => {
                    const unitName = t[unitKey] || unitKey; 
                    // Assume que o value √© a pr√≥pria chave ou uma vers√£o simplificada
                    return `<option value="${unitKey}">${unitName}</option>`;
                }).join('');
            }
            setupRangeSlider(1, config);
        }

        // c) Configura Grupo 2
        if (inputGroup2) {
            if (config.show2) {
                inputGroup2.classList.remove('hidden');
                
                // TRADU√á√ÉO DO LABEL 2
                const label2Text = t[config.label2Key] || config.label2;
                document.getElementById('label2').textContent = label2Text + ':';
                
                const unit2Select = document.getElementById('unit2');
                if (unit2Select) {
                    unit2Select.innerHTML = config.unit2.map(unitKey => {
                        const unitName = t[unitKey] || unitKey;
                        return `<option value="${unitKey}">${unitName}</option>`;
                    }).join('');
                }
                document.getElementById('value2').setAttribute('required', 'true');
                setupRangeSlider(2, config);
            } else {
                inputGroup2.classList.add('hidden');
                document.getElementById('value2').removeAttribute('required');
            }
        }

        // d) Sinais Vitais
        if (config.showVitalSigns) {
            setupRangeSlider(3, config);
            setupRangeSlider(5, config);
            vitalGroups.forEach(g => g && g.classList.remove("hidden"));
        } else {
            vitalGroups.forEach(g => g && g.classList.add("hidden"));
        }
    }

    // 3. Bot√£o de C√¢mera/OCR (Traduzido)
    const ocrButton = document.getElementById('diaryOCRButton');
    if (config.showCamera) {
        ocrButton.classList.remove('hidden');
        // Define qual chave usar baseado na a√ß√£o
        const ocrKey = action.includes('heartbeat') ? 'btnMonitorOCR' : 'btnExamOCR';
        document.getElementById('diaryOCRButtonText').textContent = t[ocrKey];
    } else {
        ocrButton.classList.add('hidden');
    }

    // 4. Exibe o Modal
    document.getElementById('diaryModal').classList.remove('hidden');
}

const LAB_EXAMS = {
    Hemograma: {
        "Hemoglobina": {
            unidade: "g/dL",
            genderSpecific: true,
            male: { min: 13.5, max: 17.5 },
            female: { min: 12.0, max: 16.0 },
        },
        "Hemat√≥crito": {
            unidade: "%",
            genderSpecific: true,
            male: { min: 41, max: 53 },
            female: { min: 36, max: 46 },
        },
        "Eritr√≥citos": {
            unidade: "milh√µes/mm¬≥",
            genderSpecific: true,
            male: { min: 4.5, max: 5.9 },
            female: { min: 4.0, max: 5.4 },
        },
        "VCM": { unidade: "fL", min: 75.0, max: 85.0 },
        "HCM": { unidade: "pg", min: 28.0, max: 30.0 },
        "CHCM": { unidade: "g/dL", min: 33.0, max: 37.0 },
        "RDW": { unidade: "%", min: 10.0, max: 14.0 },
        "Leuc√≥citos": { unidade: "x10^3/mm3", min: 5.000, max: 10.000 },
        "Neutr√≥filos": { unidade: "x10^3/mm3", min: 4.500, max: 6.200 },
        "Eosin√≥filos": { unidade: "x10^3/mm3", min: 0.030, max: 0.440 },
        "Bas√≥filos": { unidade: "x10^3/mm3", min: 0.000, max: 0.080 },
        "Mon√≥citos": { unidade: "x10^3/mm3", min: 0.240, max: 0.790 },
        "Linf√≥citos": { unidade: "x10^3/mm3", min: 1.090, max: 2.990 },
        "Plaquetas": { unidade: "x10^3/mm3", min: 150.000, max: 450.000 }
    },

    Bioqu√≠mica_Hep√°tica: {
        
        "TGO/AST": { unidade: "U/L", min: 5, max: 40 },
        "TGP/ALT": { unidade: "U/L", min: 7, max: 56 },
        "Bilirrubina total": { unidade: "mg/dL", min: 0.2, max: 1.2 },
        "Bilirrubina direta": { unidade: "mg/dL", min: 0.0, max: 0.3 },
        "Fosfatase alcalina": { unidade: "U/L", min: 40, max: 150 },
        "Gama GT": {
            unidade: "U/L",
            genderSpecific: true,
            male: { min: 8, max: 61 },
            female: { min: 5, max: 36 },
        },
        "Albumina": { unidade: "g/dL", min: 3.5, max: 5.5 },
        "Prote√≠nas totais": { unidade: "g/dL", min: 6.0, max: 8.0 },
    },

     Bioqu√≠mica_Renal: {
        "Ureia": { unidade: "mg/dL", min: 10, max: 50 },
            "Creatinina": {
            unidade: "mg/dL",
            genderSpecific: true,
            male: { min: 0.7, max: 1.3 },
            female: { min: 0.6, max: 1.2 },
        },
        "√Åcido √örico": {
            unidade: "mg/dL",
            genderSpecific: true,
            male: { min: 3.5, max: 7.2 },
            female: { min: 2.5, max: 6.0 },
        },
        "Clearance de creatinina": { unidade: "mL/min", min: 90, max: 120 },
    },

    Eletr√≥litos: {
        "S√≥dio": { unidade: "mEq/L", min: 135, max: 145 },
        "Pot√°ssio": { unidade: "mEq/L", min: 3.5, max: 5.0 },
        "C√°lcio": { unidade: "mg/dL", min: 8.5, max: 10.5 },
        "C√°lcio i√¥nico": { unidade: "mg/dL", min: 4.6, max: 5.3 },
        "Magn√©sio": { unidade: "mg/dL", min: 1.7, max: 2.4 },
        "F√≥sforo": { unidade: "mg/dL", min: 2.5, max: 4.5 },
        "Cloro": { unidade: "mEq/L", min: 98, max: 107 },
    },

    Perfil_Lip√≠dico: {
        "Colesterol total": { unidade: "mg/dL", min: 0, max: 200 },
        "HDL": { unidade: "mg/dL", min: 40, max: 60 },
        "LDL": { unidade: "mg/dL", min: 0, max: 130 },
        "Triglicer√≠deos": { unidade: "mg/dL", min: 0, max: 150 },
    },

    Glicemia_Metabolismo: {
        "Glicose em jejum": { unidade: "mg/dL", min: 70, max: 99 },
        "Hemoglobina glicada (HbA1c)": { unidade: "%", min: 4.0, max: 5.6 },
    },

    Coagula√ß√£o: {
        "TAP (Tempo de Protrombina)": { unidade: "segundos", min: 10, max: 14 },
        "INR": { unidade: "raz√£o", min: 0.8, max: 1.2 },
        "TTPA": { unidade: "segundos", min: 25, max: 35 },
        "Fibrinog√™nio": { unidade: "mg/dL", min: 200, max: 400 },
        "D√≠mero-D": { unidade: "ng/mL", min: 0, max: 500 },
    },

    Marcadores_Tumorais: {
        "CEA (Ant√≠geno Carcinoembrion√°rio)": { unidade: "ng/mL", min: 0, max: 3.0 },
        "CA 15-3": { unidade: "U/mL", min: 0, max: 25 },
        "CA 19-9": { unidade: "U/mL", min: 0, max: 37 },
        "CA 125": { unidade: "U/mL", min: 0, max: 35 },
        "AFP (Alfafetoprote√≠na)": { unidade: "ng/mL", min: 0, max: 10 },
        "PSA total": { unidade: "ng/mL", min: 0, max: 4.0 },
        "PSA livre": { unidade: "ng/mL", min: 0, max: 0.93 },
        "Beta-HCG": { unidade: "mUI/mL", min: 0, max: 5 },
        "Calcitonina": { unidade: "pg/mL", min: 0, max: 10 },
    },

     Prote√≠nas_Imunoglobulinas: {
       "LDH (Lactato Desidrogenase)": { unidade: "U/L", min: 140, max: 280 },
        "Ferritina": {
            unidade: "ng/mL",
            genderSpecific: true,
            male: { min: 12, max: 300 },
            female: { min: 12, max: 150 },
        },
        "PCR (Prote√≠na C Reativa)": { unidade: "mg/L", min: 0, max: 5 },
        "PCR ultrassens√≠vel": { unidade: "mg/L", min: 0, max: 3 },
        "VHS (Velocidade de Hemossedimenta√ß√£o)": { unidade: "mm/h", min: 0, max: 20 },
    },

    Horm√¥nios: {
        "TSH": { unidade: "ŒºUI/mL", min: 0.4, max: 4.0 },
        "T4 livre": { unidade: "ng/dL", min: 0.8, max: 1.8 },
        "Cortisol": { unidade: "Œºg/dL", min: 5, max: 25 },
        "Vitamina D (25-OH)": { unidade: "ng/mL", min: 30, max: 100 },
        "Vitamina B12": { unidade: "pg/mL", min: 200, max: 900 },
        "√Åcido f√≥lico": { unidade: "ng/mL", min: 3.0, max: 17.0 },
    },

    "Urina tipo I (EAS)": {
        "pH": { unidade: "pH", min: 5.0, max: 7.0 },
        "Densidade": { unidade: "g/mL", min: 1.010, max: 1.030 },
        "Prote√≠nas": { unidade: "mg/dL", min: 0, max: 10 },
        "Leuc√≥citos": { unidade: "/campo", min: 0, max: 5 },
        "Hem√°cias": { unidade: "/campo", min: 0, max: 3 },  
        "Glicose*": { unidade: "true or false", min: 0, max: 0 }, 
        "Hemoglobina*": { unidade: "true or false", min: 0, max: 0 },
        "Leuc√≥citos*": { unidade: "true or false", min: 0, max: 0 },
        "Hem√°cias*": { unidade: "true or false", min: 0, max: 0 },
        "C√©lulas epiteliais*": { unidade: "true or false", min: 0, max: 0 },
        "Cilindros*": { unidade: "true or false", min: 0, max: 0 },
        "Cristais*": { unidade: "true or false", min: 0, max: 0 },  
    },

    "Urina 24 horas": {
        "Ureia urin√°ria": { unidade: "g/24h", min: 12, max: 20 },
        "Creatinina Urin√°ria": {
            unidade: "mg/24h",
            genderSpecific: true,
            male: { min: 800, max: 2000 },
            female: { min: 600, max: 1600 },
        },
        "Protein√∫ria": { unidade: "mg/24h", min: 0, max: 150 },
        "C√°lcio urin√°rio": { unidade: "mg/24h", min: 100, max: 300 },
        "√Åcido √∫rico urin√°rio": { unidade: "mg/24h", min: 250, max: 750 },
    },

     Fezes: {
        "Gordura fecal": { unidade: "g/24h", min: 0, max: 7 },
        "pH fecal": { unidade: "pH", min: 6.0, max: 7.5 },       
        "Elastase fecal": { unidade: "Œºg/g", min: 200, max: 500 },
        "Leuc√≥citos fecais*": { unidade: "true or false", min: 0, max: 0 },
        "Pesquisa de sangue oculto*": { unidade: "true or false", min: 0, max: 0 },
        "Trofozo√≠tos*": { unidade: "true or false", min: 0, max: 0 },
        "Cistos de protozo√°rios*": { unidade: "true or false", min: 0, max: 0 },
        "Ovos de helmintos*": { unidade: "true or false", min: 0, max: 0 },
    },

     "Virol√≥gicos": {
        "HIV (Anti-HIV)*": { unidade: "true or false", min: 0, max: 0 },
        "Hepatite B (HBsAg)*": { unidade: "true or false", min: 0, max: 0 },
        "Hepatite B (Anti-HBs)": { unidade: "mUI/mL", min: 10, max: 10000000 },
        "Hepatite C (Anti-HCV)*": { unidade: "true or false", min: 0, max: 0 },
        "CMV IgG": { unidade: "UI/mL", min: 0, max: 0 },
        "CMV IgM*": { unidade: "true or false", min: 0, max: 0 },
        "EBV (Epstein-Barr) IgG*": { unidade: "true or false", min: 0, max: 0 },
        "EBV IgM:*": { unidade: "true or false", min: 0, max: 0 },
        "HPV (detec√ß√£o DNA*": { unidade: "true or false", min: 0, max: 0 },
        "HIV carga viral": { unidade: "c√≥pias/mL", min: 0, max: 40 },
        "Hepatite B (HBV DNA)": { unidade: "UI/mL", min: 0, max: 0 },
        "Hepatite C (HCV RNA)": { unidade: "UI/mL", min: 0, max: 0 },
        "CMV carga viral": { unidade: "c√≥pias/mL", min: 0, max: 0 },
        "EBV carga viral": { unidade: "c√≥pias/mL", min: 0, max: 0 },
    },

     "Cultura": {
        "Urocultura": { unidade: "UFC/mL", min: 0, max: 100000 },
        "Hemocultura*": { unidade: "true or false", min: 0, max: 0 },
        "Coprocultura*": { unidade: "true or false", min: 0, max: 0 },
    },

    "L√≠quor (L√≠quido Cefalorraquidiano)": {
        "Glicose": { unidade: "mg/dL", min: 40, max: 70 },
        "Prote√≠nas": { unidade: "mg/dL", min: 15, max: 45 },
        "C√©lulas": { unidade: "c√©lulas/mm¬≥", min: 0, max: 5 },
        "Cloretos": { unidade: "mEq/L", min: 120, max: 130 },
    },

    "L√≠quido Asc√≠tico": {
        "Leuc√≥citos": { unidade: "c√©lulas/mm¬≥", min: 0, max: 500 },
    },

    "L√≠quido Pleural": {
       "pH": { unidade: "pH", min: 7.30, max: 7.45 },
       "Glicose": { unidade: "mg/dL", min: 60, max: 100 },
    },

    "Imunol√≥gicos": {
        "C3": { unidade: "mg/dL", min: 90, max: 180 },
        "C4": { unidade: "mg/dL", min: 10, max: 40 },
        "IgG": { unidade: "mg/dL", min: 700, max: 1600 },
        "IgA": { unidade: "mg/dL", min: 70, max: 400 },
        "IgM": { unidade: "mg/dL", min: 40, max: 230 },
        "IgE total": { unidade: "UI/mL", min: 0, max: 100 },
    },

    "Gasometria": {
        "pH arterial": { unidade: "pH", min: 7.35, max: 7.45 },
        "PaO2 (Press√£o parcial de oxig√™nio)": { unidade: "mmHg", min: 80, max: 100 },
        "PaCO2 (Press√£o parcial de g√°s carb√¥nico)": { unidade: "mmHg", min: 35, max: 45 },
        "SatO2 (Satura√ß√£o de oxig√™nio)": { unidade: "%", min: 95, max: 100 },
    },

    "Gen√©tica NGS (Next Generation Sequencing)*": {
        "BRCA1*": { unidade: "true or false", min: 0, max: 0 },
        "BRCA2*": { unidade: "true or false", min: 0, max: 0 },
        "EGFR*": { unidade: "true or false", min: 0, max: 0 },
        "KRAS*": { unidade: "true or false", min: 0, max: 0},
        "BRAF*": { unidade: "true or false", min: 0, max: 0 },
        "ALK (rearranjo)*": { unidade: "true or false", min: 0, max: 0 },
        "ROS1 (rearranjo)*": { unidade: "true or false", min: 0, max: 0 },
        "PD-L1 (express√£o)": { unidade: "TPS %", min: 0, max: 0 },
        "MSI (Instabilidade de Microssat√©lites)*": { unidade: "true or false", min: 0, max: 0 },
        "TMB (Tumor Mutational Burden)": { unidade: "muta√ß√µes/Mb", min: 0, max: 10 },
    },

    "Citogen√©tica e Moleculares*": {
        "FISH (Hibridiza√ß√£o in situ)*": {unidade: "true or false", min: 0, max: 0  },
        "HER2 (amplifica√ß√£o)*": { unidade: "true or false", min: 0, max: 0  },
        "BCR-ABL (transloca√ß√£o)*": { unidade: "true or false", min: 0, max: 0  }
    }

};

// Autocompletar da lista de exames
document.getElementById("labExamType").addEventListener("change", () => {
    const type = labExamType.value;
    const datalist = document.getElementById("labParameterSuggestions");

    // üî• 1. Limpar todos os campos do formul√°rio ao trocar o tipo
    labExamParameter.value = "";
    labExamUnit.innerHTML = "";
    labLimitLow.value = "";
    labLimitHigh.value = "";
    labExamValue.value = "";

    //resetar tipo de entrada nos resultados
    const resultInput = document.getElementById("labExamValue"); 
    const resultSelect = document.getElementById("labExamResultSelect");
      // Modo Bin√°rio: Esconde Select, Mostra Input
      resultInput.style.display = 'block';
      resultSelect.style.display = 'none';

    // üî• 2. Limpar o datalist antes de preencher novamente
    datalist.innerHTML = "";

    // üî• 3. Preencher novamente apenas se existir lista para o tipo
    if (LAB_EXAMS[type]) {
        Object.keys(LAB_EXAMS[type]).forEach(param => {
            const opt = document.createElement("option");
            opt.value = param;
            datalist.appendChild(opt);
        });
    }
});



// Listener para preencher automaticamente unidades, limites e Alternar Input/Select
document.getElementById("labExamParameter").addEventListener("change", () => {
    // 1. Captura os elementos do DOM
    const typeField = document.getElementById("labExamType");
    const paramField = document.getElementById("labExamParameter");
    const unitField = document.getElementById("labExamUnit");
    const minField = document.getElementById("labLimitLow");
    const maxField = document.getElementById("labLimitHigh");
    
    // Captura os campos de Resultado (O input texto e o novo select)
    // ATEN√á√ÉO: Verifique se o ID "labExamResult" corresponde ao seu input original
    const resultInput = document.getElementById("labExamValue"); 
    const resultSelect = document.getElementById("labExamResultSelect");

    // 2. Obt√©m os valores selecionados
    const type = typeField.value; 
    const key = paramField.value; 

    // --- NOVA L√ìGICA: Verifica se √© bin√°rio pelo asterisco (*) ---
    // Remove espa√ßos em branco e verifica o √∫ltimo caractere
    const isBinary = key.trim().endsWith('*');

    if (resultInput && resultSelect) {
        if (isBinary) {
            // Modo Bin√°rio: Mostra Select, Esconde Input
            resultInput.style.display = 'none';
            resultSelect.style.display = 'block';
            
            // Sincroniza o valor inicial (j√° define o input como 0 ou 1)
            resultInput.value = resultSelect.value;
            
            // Limpa limites visuais pois bin√°rio geralmente n√£o usa range num√©rico visual
            minField.value = '0';
            maxField.value = '0';
        } else {
            // Modo Normal: Mostra Input, Esconde Select
            resultInput.style.display = 'block';
            resultSelect.style.display = 'none';
            resultInput.value = ''; // Limpa valor anterior
        }
    }

    // 3. Verifica se existe a categoria e o exame na constante (C√≥digo Original Mantido)
    if (LAB_EXAMS[type] && LAB_EXAMS[type][key]) {
        const info = LAB_EXAMS[type][key];

        // --- A. Preenche a Unidade ---
        if (unitField.tagName === 'SELECT') {
            unitField.innerHTML = `<option value="${info.unidade}">${info.unidade}</option>`;
        } else {
            unitField.value = info.unidade;
        }

        // Se for bin√°rio, ignoramos o preenchimento autom√°tico de Min/Max num√©ricos
        if (!isBinary) {
            // --- B. Define Limites Padr√£o ---
            let minVal = info.min;
            let maxVal = info.max;

            // --- C. Aplica L√≥gica de G√™nero ---
            if (info.genderSpecific) {
                const gender = currentPatientGender ? String(currentPatientGender).toLowerCase() : '';
                
                if (['male', 'masculino', 'm', 'homem'].includes(gender)) {
                    minVal = info.male.min;
                    maxVal = info.male.max;
                } 
                else if (['female', 'feminino', 'f', 'mulher'].includes(gender)) {
                    minVal = info.female.min;
                    maxVal = info.female.max;
                } else {
                    console.warn(`G√™nero '${gender}' n√£o reconhecido. Usando refer√™ncia padr√£o.`);
                    minVal = info.female.min;
                    maxVal = info.female.max;
                }
            }

            // --- D. Aplica valores nos inputs ---
            minField.value = (minVal !== undefined && minVal !== null) ? minVal : '';
            maxField.value = (maxVal !== undefined && maxVal !== null) ? maxVal : '';
        }
    } else {
        // Se n√£o encontrar dados
        if (unitField.tagName === 'INPUT') unitField.value = '';
        minField.value = '';
        maxField.value = '';
    }
});

// --- LISTENER EXTRA NECESS√ÅRIO ---
// Adicione este trecho logo ap√≥s o c√≥digo acima para garantir que,
// ao mudar o Select, o valor seja enviado corretamente no Input oculto.
const selectElement = document.getElementById("labExamResultSelect");
if (selectElement) {
    selectElement.addEventListener("change", function() {
        const inputElement = document.getElementById("labExamResult");
        if (inputElement) {
            inputElement.value = this.value; // Copia 0 ou 1 para o input que ser√° salvo
        }
    });
}


/**
 * Abre o modal de c√¢mera a partir do modal de di√°rio.
 */
function openCameraOCRModalFromDiary() {

    if (!checkPremiumFeature()) return;

    const action = document.getElementById('diaryActionType').value;
    // Verifica se DIARY_CONFIGS e a action existem para evitar erro
    if (!DIARY_CONFIGS || !DIARY_CONFIGS[action]) return;
    
    const config = DIARY_CONFIGS[action];
    
    if (config && config.cameraType) {
        // 1. Acesso ao dicion√°rio de tradu√ß√µes atual
        const t = LANG_STRINGS[currentLang];

        // 2. Mapeamento: Tipo de C√¢mera -> Chave de Tradu√ß√£o
        const titleKeys = {
            'monitor': 'ocrTitle_monitor', // Chave para Monitor UTI
            'blood': 'ocrTitle_blood'      // Chave para Exame de Sangue
        };

        // 3. Obt√©m a chave correta ou usa um fallback gen√©rico
        const key = titleKeys[config.cameraType] || 'ocrTitle'; 
        const translatedTitle = t[key] || "OCR";

        // 4. Abre o modal passando o t√≠tulo traduzido
        openCameraOCRModal(config.cameraType, translatedTitle);
        
        // Fecha o modal de di√°rio temporariamente
        closeDiaryModal();
    }
}

// --- NOVO: Fun√ß√£o para Fechar o Popup ---
function closeDiaryModal() {
    document.getElementById('diaryModal').classList.add('hidden');
    document.getElementById('diaryForm').reset();
    // N√ÉO altera estat√≠sticas
}

function updateClock() {
    // Atualiza o rel√≥gio de parede
    updateDateTime();
    
    // Nota: checkNotifications agora roda em seu pr√≥prio intervalo (a cada minuto)
    // Removemos a chamada daqui para evitar checks excessivos
}

async function Atualiza_Agenda(pacienteId) {
  try {
    // Validar paciente_id
    if (!pacienteId) {
      console.error('Atualiza_Agenda: paciente_id √© obrigat√≥rio');
      return [];
    }
    
    console.log('Buscando agenda para paciente ID:', pacienteId);
    
    // *** NOVO: Obter data e hora atual do dispositivo ***
    const now = new Date();
    
    // Formatar data/hora no formato MySQL (YYYY-MM-DD HH:MM:SS) no fuso local
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hour = String(now.getHours()).padStart(2, '0');
    const minute = String(now.getMinutes()).padStart(2, '0');
    const second = String(now.getSeconds()).padStart(2, '0');
    
    const dataHoraDispositivo = `${year}-${month}-${day} ${hour}:${minute}:${second}`;
    
    // Obter offset do fuso hor√°rio em minutos
    const offsetMinutos = -now.getTimezoneOffset(); // Negativo porque getTimezoneOffset retorna o oposto
    const offsetHoras = Math.floor(Math.abs(offsetMinutos) / 60);
    const offsetMinutosRestantes = Math.abs(offsetMinutos) % 60;
    const sinalOffset = offsetMinutos >= 0 ? '+' : '-';
    const fusoHorario = `${sinalOffset}${String(offsetHoras).padStart(2, '0')}:${String(offsetMinutosRestantes).padStart(2, '0')}`;
    
    console.log(`üìÖ Data/Hora do dispositivo: ${dataHoraDispositivo} (Fuso: UTC${fusoHorario})`);
    
    // Fazer requisi√ß√£o para buscar agenda COM data/hora do dispositivo
    const resp = await apiPost('buscar-agenda-medicamentos', {
      paciente_id: pacienteId,
      data_hora_dispositivo: dataHoraDispositivo,
      fuso_horario: fusoHorario
    });
    
    if (resp.success) {
      // Atualizar vari√°vel global com os dados da agenda
      AGENDA_SIMULADA = resp.data.tarefas.map(tarefa => ({
        id: tarefa.id,
        prescricao_id: tarefa.medicamento_id,
        nome_medicamento: tarefa.nome_medicamento,
        via_administracao: tarefa.via_administracao,
        data_hora_prevista: tarefa.data_hora_agendada,
        dosagem: parseFloat(tarefa.dosagem) || 0,
        unidade_dosagem: tarefa.unidade_dosagem || '',
        volume_diluicao_quant: parseFloat(tarefa.volume_diluicao_quant) || 0,
        vazao_bomba: parseFloat(tarefa.vazao_bomba) || 0
      }));
      
      console.log(`‚úÖ Agenda atualizada: ${AGENDA_SIMULADA.length} tarefa(s) pendente(s)`);
      console.log(`‚è∞ Refer√™ncia de hor√°rio usada: ${dataHoraDispositivo}`);
      
      // Reconstruir a interface da agenda
      construirAgenda();
      
      // Disparar evento customizado para notificar outras partes do sistema
      const evento = new CustomEvent('agendaAtualizada', { 
        detail: { 
          tarefas: AGENDA_SIMULADA,
          pacienteId: pacienteId,
          total: AGENDA_SIMULADA.length,
          dataHoraReferencia: dataHoraDispositivo
        } 
      });
      document.dispatchEvent(evento);
      
      return AGENDA_SIMULADA;
      
    } else {
      console.error('Erro ao buscar agenda:', resp.error || resp.message);
      showModal('Erro', 'N√£o foi poss√≠vel carregar a agenda de medicamentos.');
      return [];
    }
    
  } catch (error) {
    console.error('Erro ao atualizar agenda:', error);
    showModal('Erro', 'Erro de conex√£o ao buscar agenda.');
    return [];
  }
}

async function Atualiza_Status_Agenda(registroId, novoStatus, dataHoraRealizada, obs_usuario) {
  try {
    if (!registroId || !novoStatus || !dataHoraRealizada) {
      console.error('Atualiza_Status_Agenda: id, status e data_hora_realizada s√£o obrigat√≥rios');
      return { success: false, error: 'Par√¢metros obrigat√≥rios n√£o fornecidos' };
    }

    console.log(`Atualizando status da agenda ID: ${registroId}`);

    const resp = await apiPost('atualizar-status-agenda', {
      id: registroId,
      status: novoStatus,
      data_hora_realizada: dataHoraRealizada,
      observacoes: obs_usuario,
      caregiver_id: state.userId // <--- IMPORTANTE
    });

    if (resp.success) {
      console.log('Status atualizado com sucesso para registro:', registroId);
    } else {
      console.error('Erro ao atualizar status:', resp.error || resp.message);
    }

    return resp;

  } catch (error) {
    console.error('Erro na chamada Atualiza_Status_Agenda:', error);
    return { success: false, error: 'Erro inesperado na atualiza√ß√£o' };
  }
}

// --- NOVO: Fun√ß√£o para Salvar os Dados no Banco e Atualizar Estat√≠sticas ---
async function saveDiaryEntry() {
    const form = document.getElementById('diaryForm');
    if (!form.checkValidity()) {
        form.reportValidity(); // Exibe valida√ß√µes padr√£o do navegador
        return;
    }

    const action = document.getElementById('diaryActionType').value;
    const value1 = document.getElementById('value1').value; // FC/Tipo Exame
    const unit1 = document.getElementById('unit1').value;
    const value2 = document.getElementById('value2').value; // FR/Resultado Principal
    const unit2 = document.getElementById('unit2').value;
    const notes = document.getElementById('notes').value;
    
    const patientId = state.patientId; 
    const caregiverId = state.userId;
    
    let resp;
    let payload;
    let isVitalSigns = false;
    let recordsToSave = []; // Array para armazenar todos os registros de sinais vitais/exames

    // --- L√ìGICA PARA REGISTRO DE SINAIS VITAIS / EXAMES --- 
    if (action === 'heartbeat_manual' || action === 'blood_manual' ) {
        isVitalSigns = true;
        
        // 1. Coleta de Dados do Formul√°rio
        const value3 = document.getElementById('value3')?.value; // SpO2
        const unit3 = document.getElementById('unit3')?.value;
        const value4Sys = document.getElementById('value4_sys')?.value; // PA Sist√≥lica
        const value4Dia = document.getElementById('value4_dia')?.value; // PA Diast√≥lica
        const unit4 = document.getElementById('unit4')?.value;
        const value5 = document.getElementById('value5')?.value; // Temperatura
        const unit5 = document.getElementById('unit5')?.value;
        
        let savedCount = 0;
        let erroOccurred = false;

        // --- Mapeamento e Estrutura√ß√£o dos Registros ---
        if (action === 'heartbeat_manual') {
            const tipoRegistro = 'Monitor_UTI';
            
            // a) Frequ√™ncia Card√≠aca (FC) - Obrigat√≥rio pelo DIARY_CONFIGS original
            if (value1) recordsToSave.push({ campo_chave: 'Frequ√™ncia Card√≠aca', valor_lido: value1, unidade_medida: unit1, tipo_registro: tipoRegistro });
            
            // b) Frequ√™ncia Respirat√≥ria (FR) - Segundo campo do DIARY_CONFIGS
            if (value2) recordsToSave.push({ campo_chave: 'Frequ√™ncia Respirat√≥ria', valor_lido: value2, unidade_medida: unit2, tipo_registro: tipoRegistro });
            
            // c) Oximetria (SpO2)
            if (value3) recordsToSave.push({ campo_chave: 'Oximetria (SpO2)', valor_lido: value3, unidade_medida: unit3, tipo_registro: tipoRegistro });
            
            // d) Press√£o Arterial (PA) - Combina√ß√£o de dois campos
            if (value4Sys && value4Dia) recordsToSave.push({ campo_chave: 'Press√£o Arterial (PA)', valor_lido: `${value4Sys}/${value4Dia}`, unidade_medida: unit4, tipo_registro: tipoRegistro });
            else if (value4Sys || value4Dia) console.warn("PA incompleta: apenas um campo preenchido.");
            
            // e) Temperatura
            if (value5) recordsToSave.push({ campo_chave: 'Temperatura', valor_lido: value5, unidade_medida: unit5, tipo_registro: tipoRegistro });
        
        } else if (action === 'blood_manual') {
            // üîë CORRE√á√ÉO 2: Coletar valores dos campos dedicados (n√£o dos ocultos)
            const tipoRegistro = 'Exame_Outros';
            const labParam = document.getElementById('labExamParameter')?.value;
            const labValue = document.getElementById('labExamValue')?.value;
            const labUnit = document.getElementById('labExamUnit')?.value; // O campo unitario
            const labMin = document.getElementById('labLimitLow')?.value;
            const labMax = document.getElementById('labLimitHigh')?.value;

            // Verifica se os campos dedicados foram preenchidos
            if (labParam && labValue && labUnit) {
                recordsToSave.push({
                    campo_chave: labParam,      // Par√¢metro do Exame (ex: Plaquetas)
                    valor_lido: labValue,       // Valor do Exame (ex: 150)
                    unidade_medida: labUnit,    // Unidade (ex: x10^3/mm3)
                    tipo_registro: tipoRegistro,
                    limite_inferior: labMin, 
                    limite_superior: labMax
                });
            } else {
                // Se a a√ß√£o for 'blood_manual', mas o usu√°rio n√£o preencheu o exame
                showStatusMessage('‚ö†Ô∏è Preencha o Par√¢metro e o Valor do Exame Laboratorial.');
                closeDiaryModal();
                return; 
            }
        }
        
        if (recordsToSave.length === 0) {
            showStatusMessage('‚ö†Ô∏è Pelo menos um campo de valor precisa ser preenchido.');
            closeDiaryModal();
            return;
        }

        // --- Salvamento M√∫ltiplo no Backend ---
        for (const record of recordsToSave) {
            payload = {
                paciente_id: patientId, // For√ßa o nome correto para o PHP
                caregiverId: caregiverId,
                tipo_registro: record.tipo_registro,
                campo_chave: record.campo_chave,
                valor_lido: record.valor_lido,
                unidade_medida: record.unidade_medida,
                limite_inferior: record.limite_inferior,
                limite_superior: record.limite_superior,
                observacoes: notes // A observa√ß√£o se aplica a todos os registros
            };
            
            resp = await apiPost('save-sinais-vitais-exames', payload);
            
            if (resp.success) {
                savedCount++;
            } else {
                erroOccurred = true;
                console.error(`Falha ao salvar registro de ${record.campo_chave}:`, resp.message);
            }
        }
        
        // Finaliza√ß√£o da A√ß√£o de Sinais Vitais/Exames
        if (savedCount > 0) {
             // L√≥gica de Sucesso: Limpar Notifica√ß√£o
            const nextNotification = state.pendingNotifications.find(
                n => n.task === 'heartbeat' && !n.completed
            );

            // A pontua√ß√£o muda UMA √öNICA VEZ ap√≥s o salvamento de pelo menos 1 registro.
            if (nextNotification) {
                nextNotification.completed = true;
                state.gameStats.tasksCompleted++;
                
                let probabilityIncrease = (nextNotification.triggered) ? 3 : 1;
                state.gameStats.survivalProbability = Math.min(100, state.gameStats.survivalProbability + probabilityIncrease);

                // Limpar UI da notifica√ß√£o
                hideNotificationMessage('heartbeat');
                removeTaskPendingIndicator('heartbeat');
            }
            
            showCelebrationMessage(`‚úÖ ${savedCount} registro(s) de Sinais Vitais/Exames salvo(s)!`);
            updateStatsUI(); 
            closeDiaryModal();
            
        } else if (erroOccurred) {
            showStatusMessage('‚ùå Falha ao salvar todos os registros de sinais vitais/exames. Verifique o console.');
        }

    } else {
    // --- L√≥gica para exames
    if (action === "blood") { //lab-exam
    const payload = {
        action_type: "blood",
        paciente_id: selectedPatientId,
        tipo_registro: labExamType.value,
        campo_chave: labExamParameter.value,
        valor_lido: labExamValue.value,
        unidade_medida: labExamUnit.value,
        limite_inferior: labLimitLow.value,
        limite_superior: labLimitHigh.value,
        observacoes: notes.value
    };

    apiPost("save-sinais-vitais-exames", payload, () => {
        closeDiaryModal();
        loadExamsDashboard();
    });

    return;
}
     
        // --- L√ìGICA EXISTENTE: Outros Di√°rios (food, physio, excretion, pain) ---
        // ... (c√≥digo existente da l√≥gica save-diary-entry) ...        
        payload = {
            patientId: state.patientId, 
            caregiverId: state.userId,
            action_type: action,
            value_1: parseFloat(value1),
            unit_1: unit1,
            value_2: value2 ? parseFloat(value2) : null,
            unit_2: unit2 || null,
            notes: notes
        };
        resp = await apiPost('save-diary-entry', payload);

        if (resp.success) {
            // L√≥gica de Sucesso: Limpar Notifica√ß√£o (j√° existente)
            const nextNotification = state.pendingNotifications.find(
                n => n.task === action && !n.completed
            );

            if (nextNotification) {
                nextNotification.completed = true;
                state.gameStats.tasksCompleted++;

                let probabilityIncrease = (nextNotification.triggered) ? 3 : 1;
                state.gameStats.survivalProbability = Math.min(100, state.gameStats.survivalProbability + probabilityIncrease);

                hideNotificationMessage(action);
                removeTaskPendingIndicator(action);
            }
            showCelebrationMessage(`‚úÖ Registro de ${DIARY_CONFIGS[action].title} salvo com sucesso!`);
            updateStatsUI(); 
            closeDiaryModal();
        } else {
             showStatusMessage(`‚ùå Falha ao salvar: ${resp.message || 'Erro de servidor.'}`);
        }
    }
}

// Fun√ß√£o auxiliar para fechar o modal
function fecharModalIgnorar() {
    document.getElementById('modalIgnorar').style.display = 'none';
    document.getElementById('motivoObservacao').value = ''; // Limpa a observa√ß√£o
    doseEmAcaoId = null;
}

// NOVO: Fun√ß√£o para ABRIR e PREENCHER o modal Ignorar
function abrirModalIgnorar(id) {
    const dose = AGENDA_SIMULADA.find(d => d.id === id);
    if (!dose) return;
    
    doseEmAcaoId = id;

    const horaFormatada = formatarHora(dose.data_hora_prevista);

    document.getElementById('medNomeIgnorar').textContent = dose.nome_medicamento;
    document.getElementById('medHoraIgnorar').textContent = horaFormatada;
    document.getElementById('modalIgnorar').style.display = 'block';
}


/**
 * Gera notifica√ß√µes baseadas em hor√°rios reais do dia
 * Retorna array com todas as tarefas do dia com seus hor√°rios
 */
function generateDailyNotifications() {
  const hoje = new Date();
  const notifications = [];
  
  // Configura√ß√£o de hor√°rios para cada tipo de tarefa
  const schedules = {
    heartbeat: [
      { hour: 9, minute: 45, message: 'üå°Ô∏è' },
      { hour: 18, minute: 45, message: 'üå°Ô∏è' },
      { hour: 21, minute: 17, message: 'üå°Ô∏è' }
    ],
    pain: [
      { hour: 8, minute: 30, message: 'ü•¥' },
      { hour: 12, minute: 30, message: 'ü§ï' },
      { hour: 15, minute: 30, message: 'ü§≠' },
      { hour: 18, minute: 30, message: 'ü´†' },
      { hour: 20, minute: 30, message: 'üòµ‚Äçüí´' }
    ],
    food: [
      { hour: 8, minute: 0, message: 'üçû' },
      { hour: 12, minute: 0, message: 'üçΩÔ∏è' },
      { hour: 15, minute: 0, message: 'üç∞' },
      { hour: 18, minute: 0, message: 'üçΩÔ∏è' },
      { hour: 20, minute: 0, message: 'ü•ó' }
    ],
    shower: [
      { hour: 7, minute: 30, message: 'üí¶ü´≤' },
      { hour: 9, minute: 10, message: 'üí¶ü´≤' },
      { hour: 11, minute: 0, message: 'üöø' },
      { hour: 14, minute: 30, message: 'üí¶ü´≤' },
      { hour: 17, minute: 0, message: 'üöø' },
      { hour: 21, minute: 30, message: 'üí¶ü´≤' }     
    ],
    meds: [
      { hour: 8, minute: 0, message: 'ü•õ' },
      { hour: 10, minute: 0, message: 'ü•õ' },
      { hour: 12, minute: 0, message: 'ü•õ' },
      { hour: 14, minute: 0, message: 'ü•õ' },
      { hour: 16, minute: 0, message: 'ü•õ' },
      { hour: 18, minute: 0, message: 'ü•õ' },
      { hour: 20, minute: 0, message: 'ü•õ' }
    ],
    physio: [
      { hour: 9, minute: 0, message: 'üö¥' },
      { hour: 15, minute: 0, message: '‚õπÔ∏è‚Äç‚ôÇÔ∏è' }
    ],
    excretion: [      
      { hour: 10, minute: 30, message: 'üöΩ' },      
      { hour: 19, minute: 30, message: 'üöΩ' }      
    ]
  };

  // Gerar notifica√ß√µes para cada tipo de tarefa
  Object.keys(schedules).forEach(taskType => {
    schedules[taskType].forEach(schedule => {
      const taskTime = new Date(hoje);
      taskTime.setHours(schedule.hour, schedule.minute, 0, 0);
      
      // Criar ID √∫nico para a tarefa
      const taskId = `${taskType}-${schedule.hour}-${schedule.minute}`;
      
      notifications.push({
        id: taskId,
        task: taskType,
        scheduledTime: taskTime,
        hour: schedule.hour,
        minute: schedule.minute,
        message: schedule.message,
        completed: false,
        triggered: false
      });
    });
  });

  // Ordenar notifica√ß√µes por hor√°rio
  notifications.sort((a, b) => a.scheduledTime - b.scheduledTime);
  
  console.log(`‚úÖ ${notifications.length} tarefas geradas para hoje`);
  return notifications;
}

/**
 * Verifica se alguma notifica√ß√£o deve ser exibida agora
 * Executa a cada minuto
 */
function checkNotifications() {
  const agora = new Date();
  const agoraMinutos = agora.getHours() * 60 + agora.getMinutes();
  
  state.pendingNotifications.forEach(notification => {
    // Se j√° foi completada ou j√° foi disparada, pular
    if (notification.completed || notification.triggered) return;
    
    const notifMinutos = notification.hour * 60 + notification.minute;
    
    // Janela de 5 minutos: mostrar notifica√ß√£o entre 5min antes e no hor√°rio exato
    const diferenca = notifMinutos - agoraMinutos;
    
    if (diferenca <= 5 && diferenca >= 0) {
      
      // 1. Encontrar a notifica√ß√£o anterior (a que foi 'triggered' mas N√ÉO 'completed')
      const previousNeglected = state.pendingNotifications.find(
          n => n.task === notification.task && n.triggered && !n.completed
      );
      
      if (previousNeglected) {
          // Penalizar pela neglig√™ncia da tarefa anterior
          state.gameStats.survivalProbability = Math.max(0, state.gameStats.survivalProbability - 5);
          updateStatsUI();
          console.log(`‚ùå Penalidade por neglig√™ncia: Tarefa ${notification.task} anterior n√£o cumprida. -5%`);
          showStatusMessage(`‚ùå Tarde demais! Tarefa anterior de ${notification.task} n√£o foi feita. -5% de chance.`);
          
          // Marcar a tarefa anterior como falhada (completa, mas n√£o com sucesso)
          previousNeglected.completed = true; 
          
          // Remover o indicador da tarefa negligenciada
          removeTaskPendingIndicator(previousNeglected.task);
      }
      
      // Disparar notifica√ß√£o
      displayNotificationMessage(notification.task, notification.message);
      notification.triggered = true;
      
      // Adicionar indicador visual no bot√£o
      addTaskPendingIndicator(notification.task);
      
      console.log(`üîî Notifica√ß√£o disparada: ${notification.message}`);
    }
  });
  
  // Verificar se mudou o dia (meia-noite passou)
  const dataAtual = agora.toDateString();
  if (state.lastCheckedDate && state.lastCheckedDate !== dataAtual) {
    console.log('üìÖ Novo dia detectado! Regenerando tarefas...');
    resetDailyTasks();
  }
  state.lastCheckedDate = dataAtual;
}

/**
 * Adiciona indicador visual no bot√£o de tarefa pendente
 */
function addTaskPendingIndicator(task) {
  const button = document.querySelector(`button[onclick="performAction('${task}')"]`);
  if (button && !button.classList.contains('task-pending')) {
    button.classList.add('task-pending');
  }
}

/**
 * Remove indicador visual do bot√£o
 */
function removeTaskPendingIndicator(task) {
  const button = document.querySelector(`button[onclick="performAction('${task}')"]`);
  if (button) {
    button.classList.remove('task-pending');
  }
}

/**
 * Reseta as tarefas para um novo dia
 */
function resetDailyTasks() {
  state.pendingNotifications = generateDailyNotifications();
  state.completedTasksToday = [];
  state.gameStats.tasksCompleted = 0;
  state.gameStats.totalTasks = state.pendingNotifications.length;
  updateStatsUI();
  
  // Limpar todas as notifica√ß√µes ativas
  Object.keys(state.activeNotifications).forEach(task => {
    hideNotificationMessage(task);
  });
  
  showModal('Novo Dia', 'üåÖ Um novo dia come√ßou! Novas tarefas foram geradas.');
}

/**
 * Salva a localiza√ß√£o atual do cuidador no backend.
 */
async function saveCaregiverLocation() {
    // geolocationName √© setado em getGeolocationAndName() no formato "GPS: Lat X, Lon Y"
    if (!state.caregiverLocationName || !state.userId) return;

    // Extrai a latitude e longitude (apenas n√∫meros)
    const match = state.caregiverLocationName.match(/Lat\s*(-?\d+\.\d+),\s*Lon\s*(-?\d+\.\d+)/);
    if (!match) return;
    
    const locationString = `${match[1]},${match[2]}`; // "lat,lon"

    const resp = await apiPost('update-caregiver-location', {
        caregiverId: state.userId,
        location: locationString
    });

    if (!resp.success) {
        console.error('Falha ao salvar localiza√ß√£o do cuidador.');
    }


}


// Fun√ß√£o Wrapper que decide qual nome exibir
async function initializeLocationDisplay() {
    const headerDisplay = document.getElementById('hospitalNameDisplay');
    
    // 1. Verifica√ß√£o b√°sica
    if (!navigator.geolocation) {
        if(headerDisplay) headerDisplay.innerText = "GPS n√£o suportado";
        return;
    }

    navigator.geolocation.getCurrentPosition(
        async (position) => {
            const currentLat = position.coords.latitude;
            const currentLng = position.coords.longitude;
            
            // Salva globalmente
            if (typeof currentLocationCoords !== 'undefined') {
                currentLocationCoords = { lat: currentLat, lng: currentLng };
            }

            try {
                // 2. Busca local salvo no banco
                const patientId = (typeof state !== 'undefined' && state.patientId) ? state.patientId : 
                                  (localStorage.getItem('patientId') || 1);
                
                const response = await fetch(`api.php?action=get-last-location&patientId=${patientId}`);
                const json = await response.json();

                let usarNomeSalvo = false;

                if (json.success && json.data) {
                    const savedLat = parseFloat(json.data.latitude);
                    const savedLng = parseFloat(json.data.longitude);
                    const savedName = json.data.hospital_name;

                    // Calcula dist√¢ncia
                    const distancia = getDistanceFromLatLonInMeters(savedLat, savedLng, currentLat, currentLng);

                    // --- REGRA DE OURO (< 50m) ---
                    if (distancia < 50) {
                        usarNomeSalvo = true;
                        
                        // A. Atualiza UI
                        if (headerDisplay) {
                            headerDisplay.innerText = savedName;
                            headerDisplay.classList.remove('text-red-600', 'animate-pulse');
                            headerDisplay.classList.add('text-gray-800');
                        }
                        
                        console.log(`üìç Localiza√ß√£o confirmada (${parseInt(distancia)}m).`);

                        // B. CORRE√á√ÉO: Executa o Check-in aqui!
                        // Se n√£o tem turno local registrado, tenta iniciar
                        if (typeof currentShiftId !== 'undefined' && !currentShiftId) {
                            console.log("üöÄ Iniciando check-in autom√°tico...");
                            // Certifique-se que apiStartShift est√° definida no escopo global
                            if (typeof apiStartShift === 'function') {
                                apiStartShift(patientId);
                            }
                        }

                    } 
                }

                // 3. Se estiver LONGE ou local desconhecido
                if (!usarNomeSalvo) {
                    console.log("Local desconhecido ou distante.");

                    apiStartShift(patientId);
                    
                    // A. Tenta resolver nome gen√©rico
                    if (typeof getGeolocationAndName === 'function') {
                        getGeolocationAndName(position); 
                    } else if(headerDisplay) {
                        headerDisplay.innerText = "Local Desconhecido";
                    }
                    
                    // Alerta visual
                    if((headerDisplay && json.success) || (state.hasLocationDefined !== true)) { 
                         headerDisplay.classList.add('text-red-600'); 
                    }

                    // B. CORRE√á√ÉO: Executa Check-out aqui!
                    // Se estiver longe e tiver turno aberto, encerra
                    if (typeof currentShiftId !== 'undefined' && currentShiftId) {
                        console.log("üèÉ Saiu do per√≠metro. Tentando Check-out...");
                        if (typeof apiEndShift === 'function') {
                            apiEndShift('Saiu do per√≠metro');
                        }
                    }
                }

            } catch (error) {
                console.error("Erro ao validar localiza√ß√£o:", error);
                if (typeof getGeolocationAndName === 'function') getGeolocationAndName(position);
            }
        },
        (error) => {
            console.warn("Erro de GPS:", error);
            if(headerDisplay) headerDisplay.innerText = "GPS Indispon√≠vel";
        },
        { enableHighAccuracy: true, timeout: 10000 }
    );
}

// --- Start the game screen ---
async function startGame() {
  
  // Validar se h√° paciente selecionado
  if (!state.patientId) {
    showModal('Erro', 'Nenhum paciente selecionado.');
    return;
  }
  
  goToScreen(Screens.MAIN_GAME);
  updateDateTime();
  updatePatientUI();
  updateCaregiverUI();   
  initCaregiverWellness();
  await updateCaregiverRelationContext(state.patientId); 
  //getGeolocationAndName();
  checkNotificationStatus();
  initializeLocationDisplay();
  renderTimeline(); // ADICIONAR ESTA LINHA

  checkOngoingInfusions(state.patientId);

  setTimeout(() => {

        saveCaregiverLocation();
        checkLocationConsistency();        
        
    }, 2000);

  state.gameStartTimestamp = Date.now();
  state.lastCheckedDate = new Date().toDateString();
  
  // Configurar rel√≥gio que tamb√©m verifica notifica√ß√µes
  if (!state.clockIntervalHandle) {        
    state.clockIntervalHandle = setInterval(updateClock, 1000);
  }

  // Configurar verifica√ß√£o de notifica√ß√µes a cada minuto
  if (!state.notificationCheckInterval) {
    state.notificationCheckInterval = setInterval(checkNotifications, 60000); // 60 segundos
    
  }

  let medTasksCount = 0;

  // *** NOVO: Vincular o bot√£o de notifica√ß√£o ao manipulador de clique ***
  ui.notificationBtn.onclick = handleClickNotification;

  // Configurar verifica√ß√£o de notifica√ß√µes a cada minuto
  if (!state.notificationCheckInterval) {
    state.notificationCheckInterval = setInterval(checkNotifications, 60000); // 60 segundos
  }
  
  // *** NOVO: Polling do status do bot√£o de sino (a cada 10 segundos) ***
  //if (state.notificationStatusPoll) clearInterval(state.notificationStatusPoll);
  state.notificationStatusPoll = setInterval(checkNotificationStatus, 10000);

  // Carregar agenda de medicamentos
  try {
    await Atualiza_Agenda(state.patientId);
    medTasksCount = AGENDA_SIMULADA.length;
  } catch (error) {
    console.error('Erro ao carregar agenda inicial:', error);
  }

  // *** NOVA L√ìGICA: Gerar notifica√ß√µes baseadas em hor√°rios reais ***
  state.pendingNotifications = generateDailyNotifications();
  state.gameStats.totalTasks = state.pendingNotifications.length + medTasksCount;
  //state.gameStats.tasksCompleted = 0;
  const savedTasksCompleted = state.gameStats.tasksCompleted || 0;
  const savedTaskProgress = state.gameStats.taskProgress || 0;
  
  console.log(`üîÑ Valores carregados do servidor:`, {
    tasksCompleted: savedTasksCompleted,
    taskProgress: savedTaskProgress,
    survivalProbability: state.gameStats.survivalProbability
  });

  
  
  // Fazer verifica√ß√£o inicial imediatamente
  checkNotifications();
  
  updateStatsUI();  
  
  console.log(`üéÆ Jogo iniciado com ${state.gameStats.totalTasks} tarefas (${state.pendingNotifications.length} atividades + ${medTasksCount} medica√ß√µes)`);
  
  // Start chat polling
  //if (state.chatPollInterval) clearInterval(state.chatPollInterval);
  //state.chatPollInterval = setInterval(pollCaregiverChat, 3000);
  
  // Polling peri√≥dico da agenda
  if (state.agendaPollInterval) clearInterval(state.agendaPollInterval);
  state.agendaPollInterval = setInterval(() => {
    if (state.patientId) {
      Atualiza_Agenda(state.patientId); 
      checkOngoingInfusions(state.patientId); //atualiza as infus√µes em andamento    
    }
  }, 120000); // 2 minutos

  //inicia o tutorial
  initTutorial();
  //verifica as mensagens n√£o lidas no chat de cuidadores  
  startChatNotificationService();
}

// --- Event listeners for chat inputs ---
if (ui.aiChatInput) ui.aiChatInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessageAI(); });
if (ui.caregiverChatInput) ui.caregiverChatInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendCaregiverMessage(); });

function openChatModal(type) {

    if (!checkPremiumFeature()) return;

    if (type === 'ai') {
        ui.aiChatModal.classList.remove('hidden');
        ui.aiChatHistory.scrollTop = ui.aiChatHistory.scrollHeight;
    } else if (type === 'caregiver') {
        if (!state.patientId) {
            showModal('Erro', 'Nenhum paciente selecionado para o chat.');
            return;
        }
        state.isCaregiverChatModalOpen = true; 
        ui.caregiverChatPatientName.textContent = state.patient.nickname || 'Paciente';
        ui.caregiverChatModal.classList.remove('hidden');
        
        // *** CORRE√á√ÉO: Carregar mensagens imediatamente ***
        pollCaregiverChat();
        
         // *** NOVO: Iniciar polling cont√≠nuo SOMENTE quando o modal abre ***
        if (!state.chatPollInterval) {
            state.chatPollInterval = setInterval(() => {
                // ‚úÖ Polling condicional: s√≥ executa se o modal estiver aberto
                if (state.isCaregiverChatModalOpen) {
                    pollCaregiverChat();
                }
            }, 3000); // A cada 3 segundos
        }

        ui.caregiverChatHistory.scrollTop = ui.caregiverChatHistory.scrollHeight;
        markChatAsRead();
    }
}

function closeChatModal(type) {
    if (type === 'ai') {
        ui.aiChatModal.classList.add('hidden');
    } else if (type === 'caregiver') {
        ui.caregiverChatModal.classList.add('hidden');
        state.isCaregiverChatModalOpen = false; // Mudar o flag de estado
        
        // *** CORRE√á√ÉO: PARAR O POLLING ***
        if (state.chatPollInterval) {
            clearInterval(state.chatPollInterval);
            state.chatPollInterval = null;
        }
    }
}     

// ========== CONFIGURA√á√ÉO DA API ==========
const GEMINI_CONFIG = {
    // ‚ö†Ô∏è SUBSTITUA PELA SUA CHAVE API REAL DO GOOGLE AI STUDIO
    // Obtenha em: https://aistudio.google.com/app/apikey
    apiKey: "AIzaSyC8KkQ9E9oa9jkeyJHt-7wGFJaLWWJpW90",
    
    // Modelo correto (verificado em janeiro 2025)
    model: "gemini-2.5-flash",//"gemini-2.5-flash-preview-05-20",//"gemini-1.5-flash-latest", // ou "gemini-1.5-pro-latest" gemini-3-pro-preview
    
    // URL base da API
    baseUrl: "https://generativelanguage.googleapis.com/v1beta/models"
};

// ========== FUN√á√ÉO PRINCIPAL DA API GEMINI (CORRIGIDA) ==========
async function callGeminiAPI(prompt, systemPrompt = "") {
    try {
        console.log("ü§ñ Enviando para IA via Backend...");

        // Garante que 'apiPost' existe. Se n√£o existir, usa fetch direto.
        const bodyData = { 
            prompt: prompt, 
            systemPrompt: systemPrompt 
        };

        const response = await fetch('api.php?action=gemini-chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Timezone': userTimezone},
            body: JSON.stringify(bodyData)
        });

        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }

        const jsonResponse = await response.json();

        // Verifica sucesso na resposta do PHP
        if (jsonResponse && jsonResponse.success) {
            return jsonResponse.data; // Retorna S√ì o texto, como era antes
        } else {
            console.error("Erro da API:", jsonResponse);
            throw new Error(jsonResponse.message || "Erro desconhecido na resposta");
        }

    } catch (error) {
        console.error("‚ùå Falha na IA:", error);
        return "Desculpe, houve um erro ao processar sua solicita√ß√£o. Verifique sua conex√£o.";
    }
}

 // ========== CONSELHO DI√ÅRIO (CORRIGIDO) ==========
async function getDailyAdvice() {

    if (!checkPremiumFeature()) return;

    // Prevenir m√∫ltiplas chamadas simult√¢neas
    if (state.apiCalls.generateAdvice) {
        console.log("‚è≥ J√° existe uma chamada em andamento...");
        return;
    }
    
    state.apiCalls.generateAdvice = true;
    
    // Obter refer√™ncia ao bot√£o que foi clicado
    const button = event.target.closest('button');
    const originalHTML = button.innerHTML;
    
    // Mostrar loading
    button.disabled = true;
    button.innerHTML = `
        <svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    `;

    try {
        // Construir prompt baseado no paciente
        const patientName = state.patient.nickname || 'o paciente';
        const illness = state.patient.illness || 'a condi√ß√£o de sa√∫de';
        const LanguageCaregiver = state.appLanguage;
        
        const prompt = `Como conselheiro experiente de cuidadores de pacientes oncol√≥gicos, forne√ßa um conselho di√°rio motivacional e pr√°tico.

Contexto:
- Paciente: ${patientName}
- Condi√ß√£o: ${illness}
- Idioma do cuidador: ${LanguageCaregiver}
- P√∫blico: Cuidador familiar

Requisitos:
1. Seja emp√°tico e encorajador
2. D√™ uma dica pr√°tica de cuidado sobre temas como controle da ansiedade, dieta, sono, hidrata√ß√£o, preven√ß√£o de infec√ß√µes, lazer, comunica√ß√£o familiar e suporte de outras pessoas, apoio por entidades como casas de apoio, campanhas de doa√ß√£o de sangue, farm√°cia de alto custo, homecare e cuidados quando o cuidador est√° fora do hospital. 
3. Mantenha tom positivo mas realista
4. M√°ximo 3 par√°grafos curtos, n√£o mais que 500 palavras.
5. Responda no idioma do cuidador

Formate a resposta de forma clara e direta.`;

        const systemPrompt = "Voc√™ √© um conselheiro especializado em apoio a cuidadores de pacientes com c√¢ncer. Suas respostas s√£o sempre emp√°ticas, pr√°ticas e baseadas em evid√™ncias m√©dicas.";

        // Chamar API
        const response = await callGeminiAPI(prompt, systemPrompt);
        
        // Exibir resposta
        showModal('üí° Conselho do Dia', response);
        
    } catch (error) {
        console.error("‚ùå Erro ao gerar conselho:", error);
        showModal('Erro', 'N√£o foi poss√≠vel gerar o conselho. Tente novamente.');
    } finally {
        // Restaurar bot√£o
        button.disabled = false;
        button.innerHTML = originalHTML;
        state.apiCalls.generateAdvice = false;
    }
}

  async function generatePatientAvatar() {
            if (state.apiCalls.generateAvatar) return;
            state.apiCalls.generateAvatar = true;
            const prompt = `A digital illustration of a patient avatar for a medical game. The patient has a very gentle and friendly face. The art style should be minimalist and cartoonish. No text.`;
            const avatarUrl = await callGeminiAPI(prompt, true);
            ui.patientAvatar.src = avatarUrl;
            state.apiCalls.generateAvatar = false;
        }

  async function generateCaregiverAvatar() {
            const prompt = `A digital illustration of a caregiver avatar for a medical game. The art style should be minimalist and cartoonish. The avatar should have a gentle and reassuring face. No text.`;
            const avatarUrl = await callGeminiAPI(prompt, true);
            ui.caregiverAvatar.src = avatarUrl;
        }

        // sendMessageAI is a simple local echo placeholder (Gemini not configured here)
/**
 * Fun√ß√£o unificada para enviar mensagens (AI e Caregiver)
 */
async function sendMessage(type) {
    if (type === 'ai') {
        await sendMessageAI();
    } else if (type === 'caregiver') {
        await sendCaregiverMessage();
    }
}

// ========== CHAT COM IA (CORRIGIDO) ==========
async function sendMessageAI() {
    const input = ui.aiChatInput;
    const txt = input.value.trim();
    const patientData = state.patient || {};
    console.log("DADOS DO PACIENTE ENVIADOS PARA A IA:", patientData);

    // ‚úÖ OBTER DATA ATUAL DO DISPOSITIVO
        const hoje = new Date();
        const dataFormatada = hoje.toLocaleDateString('pt-BR', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        const horaFormatada = hoje.toLocaleTimeString('pt-BR', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });

        // ‚úÖ CALCULAR IDADE SE HOUVER DATA DE NASCIMENTO
        let idadeTexto = 'Idade n√£o informada';
        if (patientData.birth_date) {
            const nascimento = new Date(patientData.birth_date);
            let idade = hoje.getFullYear() - nascimento.getFullYear();
            const mesAtual = hoje.getMonth();
            const mesNascimento = nascimento.getMonth();
            
            // Ajusta se ainda n√£o fez anivers√°rio este ano
            if (mesAtual < mesNascimento || (mesAtual === mesNascimento && hoje.getDate() < nascimento.getDate())) {
                idade--;
            }
            
            idadeTexto = `${idade} anos (nascido em ${nascimento.toLocaleDateString('pt-BR')})`;
        }
    
    if (!txt) return;
    
    // Limpar input imediatamente
    input.value = '';
    
    // Adicionar mensagem do usu√°rio ao hist√≥rico visual
    const his = ui.aiChatHistory;
    addMessageToChat(his, txt, 'user');
    
    // Scroll para o final
    his.scrollTop = his.scrollHeight;
    
    // Adicionar indicador de "digitando..."
    const typingIndicator = addTypingIndicator(his);
    
    try {
        // Construir hist√≥rico de contexto
        const patientName = state.patient.nickname || 'o paciente';
        const illness = state.patient.illness || 'a condi√ß√£o';
        const NameApp = "Acura";
        const LinguageCaregiver = state.appLanguage;
        
        // System prompt com contexto do paciente
        const systemPrompt = `Voc√™ √© o Dr. IA, um m√©dico virtual especializado em doen√ßas como ${illness}.

Contexto do Paciente:
- Nome: ${patientName}
- Idade: ${idadeTexto}
- Diagn√≥stico: ${illness}
- Alergias do paciente: ${patientData.allergies || 'Nenhuma'}
- Data de nascimento do paciente: ${patientData.birth_date || 'N√£o Informada'}
- Peso do paciente: ${patientData.weight || 'N√£o Informado'}
- Altura do paciente: ${patientData.height || 'N√£o Informada'}
- G√™nero: ${patientData.gender || 'N√£o Informado'}
- Situa√ß√£o: Paciente em tratamento
- Idioma do cuidador: ${LinguageCaregiver}


Suas responsabilidades:
1. Responder perguntas do cuidador de forma clara e emp√°tica
2. Fornecer orienta√ß√µes pr√°ticas de cuidados, como a import√¢ncia de lavar as m√£os, de comer o que est√° preescrito, de tomar os rem√©dios na dose e hora certa. Relembre ao cuidador que ele pode documentar isso atrav√©s dos bot√µes na tela principal do aplicativo ${NameApp}.
3. Se perceber que o cuidador est√° usando pela primeira vez o aplicativo ${NameApp}, oriente-o a us√°-lo de forma sincera e verdadeira, j√° que as informa√ß√µes ser√£o √∫teis para profissionais de sa√∫de. Recomende que o cuidador tenha apoio de outros cuidadores, ou familiares, baixando o aplicativo ${NameApp}.  
4. Voc√™ pode indicar estudos cient√≠ficos j√° publicados e guias m√©dicos se o(a) paciente solicitar, mas sempre deve alertar para o cuidador consultar um m√©dico presencial e especialista no tema antes de decidir agir
5. NUNCA prescrever medicamentos ou dar diagn√≥sticos - sempre diante disso, recomende que o cuidador procure um profissional m√©dico real e pergunte ao cuidador se dele deseja dicas do que ou sobre o que conversar com esse profissional.
6. Sempre priorizar a seguran√ßa do paciente, e para isso oriente o cuidador sobre boas pr√°ticas reconhecidas pelos profissionais de medicina e enfermagem.
7. Oriente que antes do(a) paciente consumir medicamentos, o cuidador deve ter a receita m√©dica. Uma dica de boa pr√°tica √© cadastrar os medicamentos no aplicativo ${NameApp}, no bot√£o +Medicamentos. Isso √© fundamental para ter controle e hist√≥rico das medica√ß√µes.
8. Oriente ao cuidador que fique atento √†s datas de consulta, exames e procedimentos, bem como aos preparativos. Uma dica de boa pr√°tica √© cadastrar os compromissos usando o bot√£o "+" e observar a timeline do aplicativo ${NameApp} com os agendamentos: o cuidador pode tocar ou clicar num circulo da timeline e ver√° os detalhes do que est√° programado para o paciente.
9. Diante da pergunta do cuidador sobre probabilidade de cura de sua doen√ßa, explique que somente a equipe m√©dica pode estimar valores menores que 100%. Ainda, explique que ningu√©m pode ter certeza absoluta sobre este dado. Contudo, no aplicativo ${NameApp}, a aten√ß√£o aos cuidados di√°rios, aos procedimentos, aos exames, a presen√ßa nas consultas m√©dicas, enfim, a aten√ß√£o investida sempre corobora para maximizar a probabilidade. Isso tamb√©m vale para tratamentos onde o objetivo n√£o √© curar, mas sim dar qualidade de vida ao paciente.
10. Se o cuidador for religioso, manifestando sua f√©, mostre empatia e respeito. Se, por outro lado, o(a) paciente demonstra ser mais adepto de ci√™ncias, corresponda igualmente com respeito e empatia. 
11. Se o cuidador se sentir s√≥, ou manifestar que gostaria de conversar com outras pessoas que est√£o passando por situa√ß√£o similar, ou at√© descobrir mais sobre a situa√ß√£o em que se encontra, indique o chat do aplicativo ${NameApp}. Nele h√° uma sala especial que reune os cuidadores pr√≥ximos. Lembre-o de ter cuidado para n√£o compartilhar dados sens√≠veis no chat, para preservar a seguran√ßa do cuidador e do paciente. Tamb√©m explique para ser educado e respeitoso, j√° que as outras pessoas tamb√©m podem estar fragilizadas pelo cen√°rio familiar que enfrentam.
12. Nunca pe√ßa informa√ß√µes sobre plano de sa√∫de, nem dados de identifica√ß√£o do(a) paciente ou do(a) cuidador(a) como documentos de identidade ou financeiros. Explique para o cuidador ter cuidado e somente compartilhar essas informa√ß√µes com o funcion√°rio administrativo do hospital, normalmente no ato da entrada na recep√ß√£o. Explique que m√©dicos, enfermeiros e outros profissionais ir√£o sempre buscar esses dados no cadastro, ent√£o que a boa pr√°tica √© evitar divulg√°-los para os profissionais de medicina e enfermagem novamente.
13. Qualquer reclama√ß√£o sobre a conduta de um profissional de sa√∫de, oriente ao cuidador procurar a ouvidoria ou o setor de controle de qualidade do estabelecimento de sa√∫de. Se, contudo, a comunica√ß√£o por esses caminhos foi infrut√≠fera e ainda assim estiver insatisfeito, oriente a conversar com um advogado especializado em casos no contexto de sa√∫de. Tamb√©m cite que a documenta√ß√£o no aplicativo ${NameApp} pode vir a ser √∫til no processo judicial.
14. Orientar que o cuidador tamb√©m deve se fortalecer f√≠sica e emocionalmente e para isso, d√™ uma dica: comer e durmir bem. Depois de fazer isso, ele pode registrar essas boas a√ß√µes tocando no avatar dele.

Mantenha respostas concisas (m√°ximo 3 par√°grafos) e no idioma do cuidador.`;

        // Chamar API
        const response = await callGeminiAPI(txt, systemPrompt);
        
        // Remover indicador de digita√ß√£o
        typingIndicator.remove();
        
        // Adicionar resposta da IA
        addMessageToChat(his, response, 'assistant');
        
        // Atualizar hist√≥rico interno
        state.aiChatHistory.push(
            { role: "user", parts: [{ text: txt }] },
            { role: "assistant", parts: [{ text: response }] }
        );
        
    } catch (error) {
        console.error("‚ùå Erro no chat AI:", error);
        typingIndicator.remove();
        addMessageToChat(his, "Desculpe, ocorreu um erro. Tente novamente.", 'error');
    }
    
    // Scroll para o final
    his.scrollTop = his.scrollHeight;
}

/**
 * Adiciona indicador de "digitando..."
 */
function addTypingIndicator(container) {
    const wrapper = document.createElement('div');
    wrapper.className = 'flex mb-3 justify-start';
    wrapper.id = 'typing-indicator';
    
    wrapper.innerHTML = `
        <div class="p-3 rounded-xl bg-gray-200">
            <div class="flex space-x-2">
                <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0s"></div>
                <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
            </div>
        </div>
    `;
    
    container.appendChild(wrapper);
    container.scrollTop = container.scrollHeight;
    
    return wrapper;
}

/**
 * Adiciona mensagem ao hist√≥rico visual do chat
 */
function addMessageToChat(container, text, role) {
    const wrapper = document.createElement('div');
    wrapper.className = `flex mb-3 ${role === 'user' ? 'justify-end' : 'justify-start'}`;
    
    const bubble = document.createElement('div');
    bubble.className = `p-3 rounded-xl message-bubble ${
        role === 'user' ? 'user-message bg-blue-100' : 
        role === 'error' ? 'bg-red-100 text-red-800' :
        'doctor-message bg-green-100'
    }`;
    
    // Preservar quebras de linha
    bubble.style.whiteSpace = 'pre-wrap';
    bubble.textContent = text;
    
    wrapper.appendChild(bubble);
    container.appendChild(wrapper);
    
    return wrapper;
}

// ========== RENDERIZAR HIST√ìRICO DO CHAT (MELHORADO) ==========
function renderAIChatHistory() {
    const div = ui.aiChatHistory;
    
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    div.innerHTML = '';
    
    if (state.aiChatHistory.length === 0) {
        // 2. Define o nome ou o termo gen√©rico traduzido
        const patientName = state.patient.nickname || t['defaultPatientName'] || 'seu paciente';

        // 3. Pega a mensagem base e substitui o placeholder {patientName}
        let welcomeMsg = t['aiWelcomeMsg'];
        
        // Fallback de seguran√ßa se a chave n√£o existir
        if (!welcomeMsg) {
            welcomeMsg = `Ol√°! Sou o Dr. IA. Estou aqui para ajudar com os cuidados de ${patientName}.`;
        } else {
            welcomeMsg = welcomeMsg.replace('{patientName}', patientName);
        }
        
        addMessageToChat(div, welcomeMsg, 'assistant');
        return;
    }
    
    // Renderizar hist√≥rico existente
    state.aiChatHistory.forEach(msg => {
        const text = msg.parts[0].text;
        addMessageToChat(div, text, msg.role);
    });
}

/**
 * Retorna o nome do canal de chat baseado no filtro selecionado no modal.
 * @returns {string} 'patient_group' ou 'geo_group'
 */
function getCurrentChatChannel() {
    const chatFilterElement = document.getElementById('chatFilter');
    const filterType = chatFilterElement ? chatFilterElement.value : 'patient';
    
    // Mapeamento:
    // 'patient' (Filtro de Paciente) usa o canal 'patient_group'
    // 'nearby' (Filtro Geogr√°fico) usa o canal 'geo_group'
    return filterType === 'patient' ? 'patient_group' : 'geo_group';
}

/**
 * Envia mensagem para o chat de cuidadores (salva no backend)
 */
async function sendCaregiverMessage() {
    const messageText = ui.caregiverChatInput.value.trim();
    if (messageText === '') return;

    // Determina o canal de chat atual
    const chatChannel = getCurrentChatChannel(); // <<< NOVO: OBTER O CANAL

    // Se estiver no chat geogr√°fico, n√£o enviar se a localiza√ß√£o falhou.
    if (chatChannel === 'geo_group' && (!state.caregiverLocationName || !state.userId)) {
        showStatusMessage('‚ùå N√£o √© poss√≠vel enviar mensagem no chat geogr√°fico sem sua localiza√ß√£o.');
        return;
    }

    const payload = {
        patientId: state.patientId,
        senderId: state.userId,
        senderNickname: state.nickname,
        text: messageText,
        chatChannel: chatChannel // <<< NOVO: ENVIAR O CANAL
    };

    // Se o canal for geogr√°fico, adiciona a localiza√ß√£o no payload
    if (chatChannel === 'geo_group') {
        payload.originLocation = state.caregiverLocationName;
    }

    ui.caregiverChatInput.value = ''; // Limpa antes do envio

    try {
        const resp = await apiPost('send-caregiver-message', payload);

        if (resp.success) {
            // Se o envio foi para o canal atual, force a atualiza√ß√£o para ver a mensagem imediatamente
            pollCaregiverChat(true);
        } else {
            showStatusMessage('‚ùå Erro ao enviar mensagem.');
            console.error(resp.message);
        }
    } catch (e) {
        showStatusMessage('‚ùå Erro de rede ao enviar mensagem.');
        console.error(e);
    }
}


// --- Init on load ---
window.addEventListener('DOMContentLoaded', () => {

  // NOVO: Aplica o som de alarme salvo no localStorage (ou o padr√£o 'beep')
  setAlarmSound(state.userAlarmPreference);

  // If user already logged  try to fetch patients
  if (state.userId) {
    updateCaregiverUI();
    fetchPatientsAndProceed();
  } else {
    goToScreen(Screens.LOGIN);
  }
  // try to render google button if scripts loaded later
  setTimeout(renderGoogleButtonIfReady, 1200);

  // Verificar chave API ao carregar
    if (GEMINI_CONFIG.apiKey === "SUA_CHAVE_API_AQUI") {
        console.warn("‚ö†Ô∏è ATEN√á√ÉO: Configure sua chave API do Gemini!");
    }
    
    // Renderizar hist√≥rico inicial do chat
    if (ui.aiChatHistory) {
        renderAIChatHistory();
    }
});

/* -----------------------
   Fim do arquivo do jogo
------------------------*/

// VARI√ÅVEIS GLOBAIS PARA OCR/C√ÇMERA
let videoStream = null;
let ocrDocumentType = ''; // 'recipe', 'blood', 'monitor'
let ocrDataResult = {}; // Armazena os dados extra√≠dos da API

// Elementos DOM do OCR
const cameraOCRModal = document.getElementById('cameraOCRModal');
const cameraPreview = document.getElementById('cameraPreview');
const photoCanvas = document.getElementById('photoCanvas');
const capturedImage = document.getElementById('capturedImage');
const snapButton = document.getElementById('snapButton');
const retryButton = document.getElementById('retryButton');
const useDataButton = document.getElementById('useDataButton');
const ocrStatus = document.getElementById('ocrStatus');
const ocrResultContainer = document.getElementById('ocrResultContainer');
const ocrResultData = document.getElementById('ocrResultData');
const ocrModalTitle = document.getElementById('ocrModalTitle');

// Listener para o bot√£o de c√¢mera no formul√°rio de medicamentos
document.addEventListener('DOMContentLoaded', () => {
    const btnCameraReceita = document.getElementById('btnCameraReceita');
    if (btnCameraReceita) {
        btnCameraReceita.addEventListener('click', () => {
            openCameraOCRModal('recipe', 'Leitura de Receita M√©dica');
        });
    }
    
    // Listeners para os bot√µes "Blood" e "Heartbeat" (ver passo 4)
    document.querySelector('button[onclick="performAction(\'heartbeat\')"]').addEventListener('click', (e) => {
        e.preventDefault(); // Evita a chamada padr√£o
        openDiaryModal('heartbeat_manual'); // Abre o modal de entrada manual (ajustaremos DIARY_CONFIGS)
    });

    document.querySelector('button[onclick="performAction(\'blood\')"]').addEventListener('click', (e) => {
        e.preventDefault(); // Evita a chamada padr√£o
        openDiaryModal('blood_manual'); // Abre o modal de entrada manual (ajustaremos DIARY_CONFIGS) blood_manual
    });
});

/**
 * Inicia a c√¢mera e abre o modal de OCR.
 * @param {string} type 'recipe', 'blood', 'monitor'
 * @param {string} title T√≠tulo do modal
 */
async function openCameraOCRModal(type, title) {

    if (!checkPremiumFeature()) return;

    ocrDocumentType = type;
    ocrModalTitle.textContent = title;
    cameraOCRModal.classList.remove('hidden');
    
    startCamera();
}

function closeCameraOCRModal() {
    cameraOCRModal.classList.add('hidden');
    stopCamera();
    resetOCRUI();
}


/**
 * Ligar a c√¢mera do dispositivo.
 */
async function startCamera() {
    
    resetOCRUI();
    cameraPreview.classList.remove('hidden');
    capturedImage.classList.add('hidden');
    snapButton.classList.remove('hidden');
    retryButton.classList.add('hidden');
    useDataButton.classList.add('hidden');

    try {
        videoStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment' } // Usa c√¢mera traseira em mobile
        });
        cameraPreview.srcObject = videoStream;
        ocrStatus.textContent = 'C√¢mera pronta. Enquadre o documento.';
    } catch (err) {
        console.error("Erro ao acessar a c√¢mera:", err);
        ocrStatus.textContent = 'Erro ao acessar a c√¢mera. Tente novamente.';
        showModal('Erro de C√¢mera', 'N√£o foi poss√≠vel acessar a c√¢mera. Certifique-se de que o dispositivo tenha c√¢mera e que as permiss√µes foram concedidas.');
    }
}

function stopCamera() {
    if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
    }
}

function resetOCRUI() {
    ocrDataResult = {};
    ocrStatus.textContent = '';
    ocrResultContainer.classList.add('hidden');
    ocrResultData.innerHTML = '';
}

/**
 * Tira a foto e inicia o processo de OCR.
 */
function capturePhoto() {
    if (!videoStream) {
        ocrStatus.textContent = 'C√¢mera n√£o iniciada.';
        return;
    }

    // 1. Desenhar o frame no canvas
    const context = photoCanvas.getContext('2d');
    photoCanvas.width = cameraPreview.videoWidth;
    photoCanvas.height = cameraPreview.videoHeight;
    context.drawImage(cameraPreview, 0, 0, photoCanvas.width, photoCanvas.height);

    // 2. Parar a c√¢mera e exibir a imagem capturada
    stopCamera();
    const imageDataURL = photoCanvas.toDataURL('image/jpeg');
    
    cameraPreview.classList.add('hidden');
    capturedImage.src = imageDataURL;
    capturedImage.classList.remove('hidden');
    
    snapButton.classList.add('hidden');
    retryButton.classList.remove('hidden');

    // 3. Iniciar a chamada de OCR
    performOCRAnalysis(imageDataURL);
}

/**
 * Envia a imagem para a API PHP para an√°lise OCR/Gemini.
 * @param {string} imageDataURL Imagem em Base64.
 */
async function performOCRAnalysis(imageDataURL) {
    ocrStatus.innerHTML = '‚öôÔ∏è Analisando imagem via Intelig√™ncia Artificial...';

    // Remove o prefixo 'data:image/jpeg;base64,'
    const base64Image = imageDataURL.split(',')[1];

    try {
        const resp = await apiPost('ocr-analyze-document', {
            image: base64Image,
            type: ocrDocumentType 
        });

        if (resp.success && resp.data) {
            ocrDataResult = resp.data;
            displayOCRResult(resp.data);
            useDataButton.classList.remove('hidden');
        } else {
            ocrStatus.textContent = '‚ùå Falha na an√°lise OCR: ' + (resp.message || 'Erro desconhecido.');
            useDataButton.classList.add('hidden');
        }

    } catch (error) {
        console.error('Erro de OCR:', error);
        ocrStatus.textContent = '‚ùå Erro de comunica√ß√£o. Tente novamente.';
        useDataButton.classList.add('hidden');
    }
}

/**
 * Exibe os dados retornados pela API.
 * @param {object} data Dados estruturados
 */
function displayOCRResult(data) {
    ocrResultContainer.classList.remove('hidden');
    ocrResultData.innerHTML = '';
    ocrStatus.textContent = '‚úÖ Dados extra√≠dos com sucesso. Verifique e use.';

    let html = '';
    for (const key in data) {
        if (key !== 'type') {
            html += `<p><strong>${key.replace(/_/g, ' ').toUpperCase()}:</strong> ${escapeHtml(data[key])}</p>`;
        }
    }
    ocrResultData.innerHTML = html;
}

/**
 * Usa os dados de OCR para preencher formul√°rios.
 */
function useOCRData() {
    if (Object.keys(ocrDataResult).length === 0) return;

    if (ocrDocumentType === 'recipe') {
        // Preenche o formul√°rio de prescri√ß√£o
        document.getElementById('nome_medicamento').value = ocrDataResult.nome_medicamento || '';
        document.getElementById('dosagem').value = ocrDataResult.dosagem || '';
        document.getElementById('unidade_dosagem').value = ocrDataResult.unidade_dosagem || '';
        document.getElementById('intervalo_horas').value = ocrDataResult.intervalo_horas || '';
        document.getElementById('data_hora_inicio').value = ocrDataResult.data_hora_inicio ? new Date(ocrDataResult.data_hora_inicio).toISOString().slice(0, 16) : '';
        document.getElementById('medico_prescritor').value = ocrDataResult.medico_prescritor || '';
        
        closeCameraOCRModal();
        showModal('Sucesso', 'Formul√°rio de medicamento preenchido com dados da receita.');
    } else if (ocrDocumentType === 'blood' || ocrDocumentType === 'monitor') {
        // Salva diretamente o registro de sinais vitais/exames
        saveOCRDataEntry(ocrDataResult);
        closeCameraOCRModal();
    }
}

/**
 * Salva os dados de OCR de sinais vitais/exames na nova tabela via API.
 * @param {object} data Dados extra√≠dos do OCR.
 */
async function saveOCRDataEntry(data) {
    const payload = {
        patientId: state.patientId, 
        caregiverId: state.userId,
        tipo_registro: ocrDocumentType === 'blood' ? 'Exame_Sangue' : (ocrDocumentType === 'monitor' ? 'Monitor_UTI' : 'OCR'),
        campo_chave: data.campo_chave,
        valor_lido: data.valor_lido,
        unidade_medida: data.unidade_medida,
        observacoes: data.observacoes || 'Dados extra√≠dos via OCR.'
        // N√£o estamos salvando a imagem base64, apenas os metadados
    };

    const resp = await apiPost('save-sinais-vitais-exames', payload);

    if (resp.success) {
        showCelebrationMessage(`‚úÖ Registro de ${payload.tipo_registro} salvo: ${data.campo_chave} ${data.valor_lido} ${data.unidade_medida}`);
        // Se este registro substitui uma notifica√ß√£o pendente (ex: blood/heartbeat), adicione a l√≥gica de `performAction` aqui:
        // performAction('heartbeat'); ou performAction('blood');
    } else {
        showModal('Erro de Salvamento', resp.message || 'Falha ao salvar dados de exame/sinais vitais.');
    }
  }

/* -----------------------
   Fim do arquivo da bomba de infus√£o
------------------------*/
  
  
    // tenta renderizar o bot√£o do Google caso o app.js j√° disponibilize a fun√ß√£o
    setTimeout(() => {
      if (typeof renderGoogleButtonIfReady === 'function') renderGoogleButtonIfReady();
      if (typeof renderGoogleButton === 'function') renderGoogleButton(); // fallback nome
    }, 800);
  </script>
  <script>
  //formul√°rio bomba de infus√£o
  const openFormBtn = document.getElementById('open-form-btn');
  const closeFormBtn = document.getElementById('close-form-btn');
  const formPopup = document.getElementById('form-popup');
  
  //formul√°rio rem√©dios
  const openFormBtnDrug = document.getElementById('btnCadastrarDrug');
  const closeFormBtnDrug = document.getElementById('close-form-btn-Drug');
  const formPopupDrug = document.getElementById('form-popup-drugs');

  //formulario consultas, exames e procedimentos
  const formExamConsultProc = document.getElementById('btn-new-appointment-timeline');
  
  const calculateBtn = document.getElementById('calculate-btn');
  const startBtn = document.getElementById('start-btn');
  const infusionForm = document.getElementById('infusion-form');
  const volumeInput = document.getElementById('volume');
  const flowInput = document.getElementById('flow');
  const hoursInput = document.getElementById('hours');
  const minutesInput = document.getElementById('minutes');
  const secondsInput = document.getElementById('seconds');
  const multiProgressPanel = document.getElementById('multi-progress-panel');
  const alarmSoundMaster = state.medicationAlarmSound;
  const resetCalcBtn = document.getElementById('reset-calc-btn');  

  //confirmacao de ignorar/suspender medica√ß√£o
  const btnIgnorarDose = document.getElementById('btnIgnorarDose');
  const btnSuspenderReceita = document.getElementById('btnSuspenderReceita');

  let doseEmAcaoId = null; 
  let infusionIdCounter = 0;
  let infusionTimers = {};

  // Mapas de problemas e passos
  const problemsSteps = {
    "A": {
      label: "Mensagem na tela de oclus√£o no equipo",
      steps: [
        "1- Aperte o bot√£o silenciar na bomba de infus√£o para ter dois minutos de sil√™ncio",
        "2- Verifique se o equipo ou o cateter n√£o est√° dobrado ou clampado",
        "3- Verifique se o equipo est√° bem colocado na bomba de infus√£o"
      ]
    },
    "B": {
      label: "Mensagem na tela de ar no equipo",
      steps: [
        "1- Aperte o bot√£o silenciar na bomba de infus√£o para ter dois minutos de sil√™ncio",
        "2- Verifique se o equipo est√° bem colocado na bomba de infus√£o",
        "3- Chame a enfermagem"
      ]
    },
    "C": {
      label: "Mensagem na tela de bateria fraca",
      steps: [
        "1- Aperte o bot√£o silenciar na bomba de infus√£o para ter dois minutos de sil√™ncio",
        "2- Retire e coloque na tomada novamente o cabo de energia da bomba de infus√£o",
        "3- Se n√£o resolver, chame a enfermagem"
      ]
    },
    "D": {
      label: "KVO ou fim de infus√£o",
      steps: [
        "1- Aperte o bot√£o silenciar na bomba de infus√£o para ter dois minutos de sil√™ncio",
        "2- Desligue a bomba de infus√£o e feche o clamp no cateter/equipo",
        "3- Chame a enfermagem"
      ]
    }
  };

  const evaluationOptions = [
    "‚è≥üíâ problema: bomba est√° infundindo [atrasada mais de 5 minutos]",
    "‚è∞ü™´ problema: bomba terminou antes do esperado [medica√ß√£o foi toda aplicada]",
    "‚è∞üîã problema: bomba terminou antes do esperado [e ainda tem medica√ß√£o a ser aplicada]",
    "‚è±Ô∏èü™´ Perfeito! [tempo e medica√ß√£o conforme o programado]"
  ];

  //Inicio abre e fecha formul√°rio de bomba de infus√£o
  function openForm() {
    formPopup.classList.add('active');
  }

function closeForm() {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    formPopup.classList.remove('active');
    
    // Resetar t√≠tulo
    const formTitle = document.querySelector('#form-popup h3#formTitle');
    if (formTitle) {
        // CORRE√á√ÉO: Busca o texto traduzido e preserva o it√°lico
        const text = t['tipInfusionCalc'] || 'Dica: Use 2 dados para c√°lculo do 3¬∫';
        formTitle.innerHTML = `<i>${text}</i>`;
    }
    
    resetForm();
}

  openFormBtn.addEventListener('click', openForm);
  closeFormBtn.addEventListener('click', closeForm);
  //fim de abre e fecha formul√°rio de bomba de infus√£o
  
  //Inicio abre e fecha formul√°rio de rem√©dios
  function openFormDrugs() {
    formPopupDrug.classList.add('active');
  }

  function closeFormDrugs() {
    formPopupDrug.classList.remove('active');
    limparFormularioMedicamento();
  }

  //fala para o navegador ficar de olho nos botoes
  openFormBtnDrug.addEventListener('click', openFormDrugs);
  closeFormBtnDrug.addEventListener('click', closeFormDrugs);  
    
  //salva Meus Rem√©dios   
async function saveDrugs() {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    // Valida√ß√£o de campos obrigat√≥rios do medicamento
    const pacienteId = state.patientId;
    const nomeMedicamento = document.getElementById('nome_medicamento')?.value?.trim();
    const dosagem = document.getElementById('dosagem')?.value?.trim();
    const unidadeDosagem = document.getElementById('unidade_dosagem')?.value?.trim();
  
    // Validar campos obrigat√≥rios
    if (!pacienteId) {
        showModal(t['modalErrorTitle'], t['msgSelectPatient']);
        return;
    }
  
    if (!nomeMedicamento || !dosagem || !unidadeDosagem) {
        showModal(t['modalErrorTitle'], t['msgFillMedFields']);
        return;
    }
  
    // Montar objeto com os dados do medicamento
    const data = {
        paciente_id: pacienteId,
        nome_medicamento: nomeMedicamento,
        via_administracao: document.getElementById('via_administracao')?.value || null,
        dosagem: dosagem,
        unidade_dosagem: unidadeDosagem,
        volume_diluicao_liquido: document.getElementById('volume_diluicao_liquido')?.value || null,
        volume_diluicao_quant: document.getElementById('volume_diluicao_quant')?.value || null,
        unidade_diluicao: document.getElementById('unidade_diluicao')?.value || null,
        vazao_bomba: document.getElementById('vazao_bomba')?.value || null,
        intervalo_horas: document.getElementById('intervalo_horas')?.value || null,
        data_hora_inicio: document.getElementById('data_hora_inicio')?.value || null,
        medico_prescritor: document.getElementById('medico_prescritor')?.value || null,
        data_hora_suspensao: document.getElementById('data_hora_suspensao')?.value || null,
        status_receita: document.getElementById('status_receita')?.value || null,
        status_pagador: document.getElementById('status_pagador')?.value || null
    };
  
    try {
        const resp = await apiPost('save-drugs', data);
    
        if (resp.success) {
            state.medicamentoId = resp.data.id;
            state.medicamento = resp.data.medicamento;
      
            // Criar agenda
            try {
                const agendaResp = await apiPost('criar-agenda-medicamentos', {
                    paciente_id: pacienteId
                });
        
                if (agendaResp.success) {
                    // TRADU√á√ÉO: Montagem da mensagem de sucesso
                    let mensagem = (t['msgMedSavedId'] || 'Medicamento cadastrado! ID: {id}').replace('{id}', state.medicamentoId) + "\n\n";
                    mensagem += (t['msgAgendaCreated'] || 'üìÖ Agenda criada:') + "\n";
                    
                    const txtAdded = t['msgTasksAdded'] || '‚úÖ {count} tarefa(s) adicionada(s)';
                    mensagem += txtAdded.replace('{count}', agendaResp.tarefas_criadas) + "\n";
          
                    if (agendaResp.tarefas_ja_existentes > 0) {
                        const txtExisting = t['msgTasksExisting'] || '‚ÑπÔ∏è {count} tarefa(s) j√° existente(s)';
                        mensagem += txtExisting.replace('{count}', agendaResp.tarefas_ja_existentes) + "\n";
                    }
          
                    if (agendaResp.erros && agendaResp.erros.length > 0) {
                        mensagem += `\n${t['msgWarnings'] || '‚ö†Ô∏è Avisos:'}\n${agendaResp.erros.join('\n')}`;
                    }
          
                    showModal(t['modalSuccessTitle'], mensagem);
          
                    // Atualizar agenda ap√≥s salvar medicamento
                    await Atualiza_Agenda(pacienteId);
          
                } else {
                    // Erro parcial (Salvou rem√©dio, falhou agenda)
                    const errorMsg = agendaResp.error || agendaResp.message;
                    let warningMsg = (t['msgMedSavedId'] || 'Medicamento cadastrado! ID: {id}').replace('{id}', state.medicamentoId);
                    warningMsg += ", " + (t['msgAgendaErrorBackend'] || 'mas houve um problema na agenda: {error}').replace('{error}', errorMsg);

                    showModal(t['modalWarningTitle'], warningMsg);
                }
            } catch (agendaError) {
                console.error('Erro ao criar agenda:', agendaError);
                
                let warningMsg = (t['msgMedSavedId'] || 'Medicamento cadastrado! ID: {id}').replace('{id}', state.medicamentoId);
                warningMsg += ", " + (t['msgAgendaErrorNetwork'] || 'mas n√£o foi poss√≠vel criar a agenda automaticamente.');

                showModal(t['modalWarningTitle'], warningMsg);
            }
      
            limparFormularioMedicamento();
            closeFormDrugs(); // Fechar o formul√°rio
      
        } else {
            // Falha na API principal
            showModal(t['modalErrorTitle'], resp.error || resp.message || t['msgMedSaveFail']);
        }
    } catch (error) {
        console.error('Erro ao salvar medicamento:', error);
        showModal(t['modalErrorTitle'], t['msgConnectionError']);
    }
}

// Fun√ß√£o auxiliar para limpar o formul√°rio
function limparFormularioMedicamento() {
  const campos = [
    'nome_medicamento', 'via_administracao', 'dosagem', 'unidade_dosagem',
    'volume_diluicao_liquido', 'volume_diluicao_quant', 'unidade_diluicao',
    'vazao_bomba', 'intervalo_horas', 'data_hora_inicio', 'medico_prescritor',
    'data_hora_suspensao', 'status_receita', 'status_pagador'
  ];
  
  campos.forEach(campo => {
    const elemento = document.getElementById(campo);
    if (elemento) {
      elemento.value = '';
    }
  });

  resetFormularioPrescricao();
}

  // -- fim de salvar rem√©dios
  

  function parseTimeInputs() {
    const h = parseInt(hoursInput.value) || 0;
    const m = parseInt(minutesInput.value) || 0;
    const s = parseInt(secondsInput.value) || 0;
    return { h, m, s };
  }

  function totalSeconds(h, m, s) {
    return h * 3600 + m * 60 + s;
  }

  function secToHMS(seconds) {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    return { h, m, s };
  }

  function displayTime(h, m, s) {
    hoursInput.value = h;
    minutesInput.value = m;
    secondsInput.value = s;
  }

function calculateMissing() {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    const v = parseFloat(volumeInput.value);
    const f = parseFloat(flowInput.value);
    let { h, m, s } = parseTimeInputs();
    const tSeconds = totalSeconds(h, m, s);
    const tHours = tSeconds / 3600;

    let filledCount = 0;
    if (!isNaN(v) && v > 0) filledCount++;
    if (!isNaN(f) && f > 0) filledCount++;
    if (tSeconds > 0) filledCount++;

    if (filledCount < 2) {
        // TRADU√á√ÉO: Preencha 2 campos
        showModal(t['modalWarningTitle'], t['msgCalcFillTwo']);
        return false;
    }

    if ((!v || isNaN(v)) && !isNaN(f) && tSeconds > 0) {
        // Calcula Volume
        volumeInput.value = (f * tHours).toFixed(2);
    } else if ((!f || isNaN(f)) && !isNaN(v) && tSeconds > 0) {
        // Calcula Vaz√£o
        flowInput.value = (v / tHours).toFixed(2);
    } else if (tSeconds === 0 && !isNaN(v) && !isNaN(f)) {
        // Calcula Tempo
        let timeCalcHours = v / f;
        if (!isFinite(timeCalcHours) || timeCalcHours <= 0) {
            // TRADU√á√ÉO: Valores inv√°lidos
            showModal(t['modalErrorTitle'], t['msgCalcInvalidTime']);
            return false;
        }
        let timeCalcSeconds = timeCalcHours * 3600;
        let { h: H, m: M, s: S } = secToHMS(Math.round(timeCalcSeconds));
        displayTime(H, M, S);
    } else if (tSeconds > 0 && (!v || isNaN(v)) && (!f || isNaN(f))) {
        // TRADU√á√ÉO: Caso raro de erro
        showModal(t['modalWarningTitle'], t['msgCalcVolOrFlow']);
        return false;
    }
    return true;
}
 
  
  calculateBtn.addEventListener('click', () => {
    if (calculateMissing()) {
      startBtn.style.display = 'block';
      resetCalcBtn.style.display = 'block';
      calculateBtn.style.display = 'none';
    }
  });
  
  resetCalcBtn.addEventListener('click', () => {
    infusionForm.reset();
    startBtn.style.display = 'none';
    resetCalcBtn.style.display = 'none';
    calculateBtn.style.display = 'block';
  });


  function resetForm() {
    infusionForm.reset();
    startBtn.style.display = 'none';
  }

  function formatTimerText(secondsLeft) {
    let { h, m, s } = secToHMS(secondsLeft);
    return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
  }

 // --- NOVO: Fun√ß√£o Auxiliar para Gerar os Problemas Traduzidos ---
function getInfusionProblems(t) {
    // Reutilizamos frases comuns para economizar chaves de tradu√ß√£o
    const stepSilence = t['stepSilence'] || "1- Aperte o bot√£o silenciar na bomba para ter 2 min de sil√™ncio";
    const stepCallNurse = t['stepCallNurse'] || "3- Chame a enfermagem";
    const stepCheckFit = t['stepCheckFit'] || "2- Verifique se o equipo est√° bem colocado na bomba";

    return {
        "A": {
            label: t['probLabelOcclusion'],
            steps: [
                stepSilence,
                t['stepCheckKink'], // "Verifique se o equipo/cateter n√£o est√° dobrado"
                stepCheckFit
            ]
        },
        "B": {
            label: t['probLabelAir'],
            steps: [
                stepSilence,
                stepCheckFit,
                stepCallNurse
            ]
        },
        "C": {
            label: t['probLabelBattery'],
            steps: [
                stepSilence,
                t['stepCheckPower'], // "Retire e coloque na tomada..."
                t['stepCallNurseIfFail'] // "Se n√£o resolver, chame a enfermagem"
            ]
        },
        "D": {
            label: t['probLabelKVO'],
            steps: [
                stepSilence,
                t['stepTurnOffClose'], // "Desligue a bomba e feche o clamp"
                stepCallNurse
            ]
        }
    };
}

// --- Fun√ß√£o Principal Atualizada ---
function createProblemSection(infusionId, container) {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    const section = document.createElement('div');
    section.className = 'problem-section';

    const select = document.createElement('select');
    select.id = 'problem-select-' + infusionId;
    
    const defaultOption = document.createElement('option');
    // TRADU√á√ÉO: Texto padr√£o do select
    defaultOption.textContent = t['optSelectProblem'] || 'Selecione um problema...';
    defaultOption.value = '';
    select.appendChild(defaultOption);

    // 2. Obt√©m a lista de problemas traduzida
    const currentProblems = getInfusionProblems(t);

    for (const key in currentProblems) {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = currentProblems[key].label;
        select.appendChild(option);
    }

    const solutionDiv = document.createElement('div');
    solutionDiv.id = 'solution-' + infusionId;
    solutionDiv.style.marginTop = '10px';

    select.addEventListener('change', () => {
        const val = select.value;
        solutionDiv.innerHTML = '';
        
        // Usa a lista local traduzida
        if (val && currentProblems[val]) {
            const steps = currentProblems[val].steps;
            steps.forEach(step => {
                const p = document.createElement('p');
                p.className = 'problem-step';
                p.textContent = step;
                solutionDiv.appendChild(p);
            });
        }
    });

    section.appendChild(select);
    section.appendChild(solutionDiv);
    container.appendChild(section);
    return section;
}

// --- NOVO: Fun√ß√£o Auxiliar para Gerar as Op√ß√µes de Avalia√ß√£o ---
function getEvaluationOptions(t) {
    return [
        t['evalOptionDelay'] || "‚è≥üíâ problema: bomba est√° infundindo [atrasada mais de 5 minutos]",
        t['evalOptionEarly'] || "‚è∞ü™´ problema: bomba terminou antes do esperado [medica√ß√£o foi toda aplicada]",
        t['evalOptionEarlyLeftover'] || "‚è∞üîã problema: bomba terminou antes do esperado [e ainda tem medica√ß√£o]",
        t['evalOptionPerfect'] || "‚è±Ô∏èü™´ Perfeito! [tempo e medica√ß√£o conforme o programado]"
    ];
}

// --- Fun√ß√£o Principal Atualizada ---
function createEvaluationSection(infusionId, container) {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    const section = document.createElement('div');
    section.className = 'evaluation-section';

    const select = document.createElement('select');
    select.id = 'evaluation-select-' + infusionId;
    
    const defaultOption = document.createElement('option');
    // TRADU√á√ÉO: Op√ß√£o padr√£o
    defaultOption.textContent = t['optSelectEvaluation'] || 'Selecione uma avalia√ß√£o...';
    defaultOption.value = '';
    select.appendChild(defaultOption);

    // 2. Obt√©m a lista de op√ß√µes traduzida
    const currentOptions = getEvaluationOptions(t);

    currentOptions.forEach((evalText, idx) => {
        const option = document.createElement('option');
        option.value = idx;
        option.textContent = evalText;
        select.appendChild(option);
    });

    const resultDiv = document.createElement('div');
    resultDiv.style.marginTop = '10px';
    resultDiv.style.fontWeight = 'bold';

    select.addEventListener('change', () => {
        const selectedIndex = select.value;
        
        if (selectedIndex !== '') {
            // Pega o texto da lista local traduzida
            const avaliacaoTexto = currentOptions[selectedIndex]; 
            
            // TRADU√á√ÉO: Feedback de registro
            const msgRegistered = t['msgEvalRegistered'] || 'Avalia√ß√£o registrada: ';
            resultDiv.textContent = msgRegistered + avaliacaoTexto;

            // Recupera o ID da dose (verificando exist√™ncia)
            const timerObj = infusionTimers[infusionId];
            if (timerObj && timerObj.agendaDoseId) {
                const doseDaAgendaId = timerObj.agendaDoseId;
                salvarObservacaoInfusao(doseDaAgendaId, avaliacaoTexto);
            } else {
                console.error("ID da dose de agenda n√£o encontrado no objeto de timer.");
            }

            // Exibe mensagem de agradecimento e remove infus√£o ap√≥s 3s
            const infusion = infusionTimers[infusionId];
            const thankYou = document.createElement('div');
            thankYou.className = 'thank-you-message';
            // TRADU√á√ÉO: Obrigado
            thankYou.textContent = t['msgThankYou'] || ' ü§© Obrigado!';
            
            section.appendChild(thankYou);
            
            if (typeof setNotificationStatus === 'function') {
                setNotificationStatus(0); // 0 = Inativo
            }          

            setTimeout(() => {
                if (infusion && infusion.infusionItem && infusion.infusionItem.parentNode) {
                    infusion.infusionItem.parentNode.removeChild(infusion.infusionItem);
                    delete infusionTimers[infusionId];
                }
            }, 3000);
         
        // --- CORRE√á√ÉO DEFINITIVA: RELAT√ìRIO DE INFUS√ÉO ---
            
            // 1. Identifica o Profissional (Prioridade: Lista do Modal > Usu√°rio Logado)
            // Se houver algu√©m na lista "Profissional Presente", usa esse nome.
            // Se a lista estiver vazia, assume que o pr√≥prio usu√°rio logado realizou o procedimento.
            let nomeProfissional = "N√£o Identificado";
            if (typeof ProfessionalPresence !== 'undefined') {
                nomeProfissional = ProfessionalPresence.getCurrentResponder();
            } else {
                nomeProfissional = state.nickname || localStorage.getItem('nickname') || "Usu√°rio Logado";
            }

            // 2. Identifica o Cuidador (Sempre o usu√°rio logado no dispositivo)
            const nomeCuidador = state.nickname || localStorage.getItem('nickname') || "Cuidador Principal";

            // 3. Nome do Medicamento (Seguran√ßa caso a vari√°vel n√£o exista no escopo)
            const nomeMedicamentoLog = (typeof medicamento !== 'undefined') ? medicamento : 'Infus√£o';

            // 4. Registro do Evento
            if (typeof ReportSystem !== 'undefined') {
                ReportSystem.logEvent({
                    reason: "End Infusion: " + nomeMedicamentoLog,
                    professional: nomeProfissional, // Ex: "Dr. Silva" (se selecionado no modal)
                    caregiver: nomeCuidador,        // Ex: "Maria" (quem est√° segurando o celular)
                    notes: "Infus√£o finalizada e avalia√ß√£o registrada.",
                    isLocationCorrect: true         // Assume verdadeiro pois o app est√° em uso
                });
            }
            // -------------------------------------------------
            
        } else {
            resultDiv.textContent = '';
        }
    });

    section.appendChild(select);
    section.appendChild(resultDiv);
    container.appendChild(section);
    return section;
} 

async function salvarObservacaoInfusao(idAgenda, observacao) {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    try {
        const resp = await apiPost('salvar-observacao-agenda', {
            id: idAgenda,
            observacoes: observacao
        });

        if (resp.success) {
            console.log(`Observa√ß√£o salva com sucesso para ID ${idAgenda}.`);
        } else {
            console.error('Falha ao salvar observa√ß√£o:', resp.message || resp.error);
            // TRADU√á√ÉO: Mensagem de erro de salvamento
            showModal(
                t['modalErrorTitle'] || 'Erro', 
                t['msgSaveObsError'] || 'Falha ao salvar a avalia√ß√£o da infus√£o no hist√≥rico.'
            );
        }
    } catch (e) {
        console.error('Erro de conex√£o ao salvar observa√ß√£o:', e);
        // TRADU√á√ÉO: Mensagem de erro de conex√£o
        showModal(
            t['modalErrorTitle'] || 'Erro', 
            t['msgSaveObsNetworkError'] || 'Erro de conex√£o ao salvar avalia√ß√£o.'
        );
    }
} 

 function triggerAlarm(infusion) {
    // 1. CHECAGEM DE SIL√äNCIO
    // Se estiver silenciado para sempre OU ainda estiver no tempo de soneca, sai da fun√ß√£o.
    if (infusion.alarmSilencedPermanent || Date.now() <= infusion.alarmSilencedUntil) {
        return;
    }

    // 2. TOCAR ALARME
    // Chama sua fun√ß√£o existente (que agora deve ser um wrapper para o AlarmSystem)
    playCentralAlarm(infusion.alarmSound); 

    // Vibra√ß√£o extra (redundante se o AlarmSystem j√° tiver, mas mal n√£o faz)
    if (navigator.vibrate) {
        navigator.vibrate([500, 200, 500]);
    }

    // 3. EXIBIR ELEMENTOS VISUAIS
    infusion.alarmMessage.style.display = 'block';
    infusion.controls.style.display = 'block';

    // *** NOVO: Mostrar o Bot√£o de P√¢nico na Tela Principal ***
    // Isso permite silenciar mesmo se o usu√°rio n√£o estiver olhando para esta infus√£o espec√≠fica
    const btnPanico = document.getElementById('btn-silenciar-geral');
    if (btnPanico) {
        btnPanico.style.display = 'block';
    }

    // 4. CONFIGURAR O BOT√ÉO "ENTENDIDO" (L√≥gica de Parada)
    // Precisamos capturar o bot√£o dentro da div de controles dessa infus√£o
    const btnEntendido = infusion.controls.querySelector('button'); 
    
    if (btnEntendido) {
        // Sobrescrevemos o onclick para garantir que ele fa√ßa tudo que precisa
        btnEntendido.onclick = function(e) {
            e.preventDefault(); // Evita recarregamentos indesejados

            // A. Para o som (Usa o sistema global para garantir)
            if(typeof AlarmSystem !== 'undefined') {
                AlarmSystem.stopAlarm();
            }

            // B. Ativa a "Trava Permanente"
            // Isso impede que o runTimer toque o alarme de novo no pr√≥ximo segundo
            infusion.alarmSilencedPermanent = true; 

            // C. Esconde os alertas visuais desta infus√£o
            infusion.alarmMessage.style.display = 'none';
            infusion.controls.style.display = 'none';

            // D. Esconde o bot√£o de p√¢nico global
            if (btnPanico) btnPanico.style.display = 'none';

            // E. Atualiza status no banco (opcional, define como inativo/lido)
            setNotificationStatus(0); 
            
            console.log("Infus√£o silenciada e travada permanentemente.");
        };
    }

    // 5. Notifica√ß√£o no Banco de Dados (Mantido do seu original)
    setNotificationStatus(1); // 1 = Ativo
}

  function silenceAlarm(infusion) {
    infusion.alarmSound.pause();
    infusion.alarmSound.currentTime = 0;
    //infusion.alarmMessage.style.display = 'none';
    //infusion.controls.style.display = 'none';
    infusion.alarmSilencedPermanent = true;

  }

/**
 * Limpa completamente o painel de infus√µes, para intervalos e reseta estados.
 * Deve ser chamada antes de carregar um novo paciente ou fazer logout.
 */
function clearInfusionPanel() {
    // 1. Limpar Timers e √Åudios da Mem√≥ria
    // Verifica se a vari√°vel global infusionTimers existe
    if (typeof infusionTimers !== 'undefined') {
        for (let key in infusionTimers) {
            const infusion = infusionTimers[key];
            
            // Parar o "tique-taque" do rel√≥gio
            if (infusion.intervalId) {
                clearInterval(infusion.intervalId);
            }
            
            // Parar sons de alarme que estejam tocando
            if (infusion.alarmSound) {
                infusion.alarmSound.pause();
                infusion.alarmSound.currentTime = 0;
            }
        }
        
        // Esvaziar o objeto global
        // Nota: N√£o redefina com 'const infusionTimers = {}', apenas limpe as propriedades
        for (const key in infusionTimers) {
            delete infusionTimers[key];
        }
    }

    // 2. Limpar o HTML Visual
    const panel = document.getElementById('multi-progress-panel');
    if (panel) {
        panel.innerHTML = '';
    }
}

let agendaDoseId;

/* verifica as infus√µes em andamento*/
async function checkOngoingInfusions(patientId) {
    // 1. Limpeza de seguran√ßa (para n√£o misturar pacientes)
    if(typeof clearInfusionPanel === 'function') clearInfusionPanel();
    else {
        // Fallback manual se a fun√ß√£o n√£o existir
        const panel = document.getElementById('multi-progress-panel');
        if(panel) panel.innerHTML = '';
        if(typeof infusionTimers !== 'undefined') {
             for(let k in infusionTimers) clearInterval(infusionTimers[k].intervalId);
        }
    }

    if (!patientId) return;

    try {
        const response = await fetch(`api.php?action=buscar-infusoes-ativas&pacienteId=${patientId}`);
        const result = await response.json();

        if (result.success && result.data) {
            result.data.forEach(dose => {
                const now = Date.now();
                const endTimestamp = new Date(dose.data_hora_final_previsto).getTime();
                
                // Tenta pegar os valores salvos. 
                // Se o banco for antigo (null), usa fallback
                const volumeSalvo = dose.volume_infusao || dose.dosagem || '0';
                const vazaoSalva = dose.vazao_infusao || '--';
                
                // Recalcular dura√ß√£o estimada para a barra de progresso
                // Se tiver volume e vaz√£o, a dura√ß√£o total √© precisa: (Vol / Vaz√£o) * 3600
                let totalDurationSecs = 3600; // Default
                if (parseFloat(volumeSalvo) > 0 && parseFloat(vazaoSalva) > 0) {
                    totalDurationSecs = (parseFloat(volumeSalvo) / parseFloat(vazaoSalva)) * 3600;
                } else {
                    // Se n√£o tiver vaz√£o, estima pelo tempo restante (menos preciso para a barra, mas funcional)
                    let remaining = (endTimestamp - now) / 1000;
                    if(remaining > 0) totalDurationSecs = remaining + (remaining * 0.2); // +20% buffer
                }

                console.log(`id da dose: ${dose.id}.`);

                // Cria o card com os dados completos vindos do banco
                spawnInfusionCard({
                    agendaId: dose.id,
                    nomeMedicamento: dose.nome_medicamento,
                    volume: volumeSalvo, // Agora vir√° correto do banco
                    flow: vazaoSalva,    // Agora vir√° correto do banco
                    durationSeconds: totalDurationSecs, 
                    endTimeMs: endTimestamp,
                    isRestoring: true
                });
            });
        }
    } catch (error) {
        console.error("Erro ao restaurar infus√µes:", error);
    }
}

/**
 * Cria o card de infus√£o e inicia o timer.
 * Usado tanto pelo bot√£o Iniciar quanto pela restaura√ß√£o do banco.
 */
function spawnInfusionCard(params) {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    const {
        agendaId,           // ID da tabela agenda_medicamentos
        nomeMedicamento,    // Nome para exibi√ß√£o
        volume,             // Volume
        flow,               // Vaz√£o
        durationSeconds,    // Dura√ß√£o TOTAL em segundos
        endTimeMs,          // Timestamp (ms) de quando deve acabar
        isRestoring = false // Flag para saber se √© restaura√ß√£o
    } = params;

    const infusionId = agendaId;
    
    // --- NOVO: VERIFICA√á√ÉO DE MEM√ìRIA (PERSIST√äNCIA) ---
    // Verifica no localStorage se esta infus√£o j√° foi silenciada anteriormente
    const silencedList = JSON.parse(localStorage.getItem('silencedInfusions') || '[]');
    const isAlreadySilenced = silencedList.includes(infusionId);
    // ---------------------------------------------------

    // Se o card j√° existe, atualiza badge e sai
    const existingCard = document.getElementById(infusionId);
    if(existingCard) {
        const currentBadge = existingCard.querySelector('.shift-badge-container');
        if (currentBadge && typeof ProfessionalPresence !== 'undefined') {
            currentBadge.innerHTML = ProfessionalPresence.getBadgeHtml();
        }
        return; 
    }

    const infusionItem = document.createElement('div');
    infusionItem.className = "infusion-item";
    infusionItem.id = infusionId;

    const title = document.createElement('div');
    title.className = "infusion-title";
    
    const lblMed = t['labelMedication'] || 'Medica√ß√£o';
    const lblVol = t['labelVolumeAbbr'] || 'Vol';
    const lblFlow = t['labelFlowAbbr'] || 'Vaz√£o';    
    title.textContent = `${lblMed}: ${nomeMedicamento} | ${lblVol}: ${volume} mL | ${lblFlow}: ${flow} mL/h`;

    const progressContainer = document.createElement('div');
    progressContainer.className = "progress-container";

    const progressBar = document.createElement('div');
    progressBar.className = "progress-bar";
    progressContainer.appendChild(progressBar);

    const problemBtn = document.createElement('button');
    problemBtn.className = 'btn-problem solving';
    problemBtn.textContent = t['btnSolveProblem'] || 'Solucionar um problema?';
    progressContainer.appendChild(problemBtn);

    const timerText = document.createElement('div');
    timerText.className = "timer-text";
    timerText.textContent = "--:--:--"; 

    const alarmMessage = document.createElement('div');
    alarmMessage.className = "alarm-message";
    alarmMessage.textContent = t['msgInfusionWarning'] || 'Aviso: Prepare-se para silenciar a bomba...';
    alarmMessage.style.display = 'none';

    const controls = document.createElement('div');
    controls.className = "infusion-controls";
    controls.style.display = 'none';

    const silenceButton = document.createElement('button');
    silenceButton.textContent = `üîï ${t['btnUnderstood'] || 'Entendido'}`;
    silenceButton.type = 'button';
    silenceButton.className = 'p-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition-colors flex items-center justify-center space-x-2';
    
    controls.appendChild(silenceButton);

    const badgeDiv = document.createElement('div');
    badgeDiv.className = "shift-badge-container"; 
    if (typeof ProfessionalPresence !== 'undefined') {
        badgeDiv.innerHTML = ProfessionalPresence.getBadgeHtml();
    }

    infusionItem.appendChild(title);
    infusionItem.appendChild(progressContainer);
    infusionItem.appendChild(timerText);
    infusionItem.appendChild(alarmMessage);
    infusionItem.appendChild(controls);
    infusionItem.appendChild(badgeDiv); 

    document.getElementById('multi-progress-panel').appendChild(infusionItem);

    const startTimeCalculated = endTimeMs - (durationSeconds * 1000);

    const infusion = infusionTimers[infusionId] = {
        duration: durationSeconds,
        startTime: startTimeCalculated, 
        endTime: endTimeMs,
        progressBar,
        timerText,
        alarmMessage,
        controls,
        alarmSound: new Audio(typeof alarmSoundMaster !== 'undefined' ? alarmSoundMaster.src : ''), 
        alarmSilencedUntil: 0,
        
        // --- ATUALIZA√á√ÉO: Usa o valor recuperado da mem√≥ria ---
        alarmSilencedPermanent: isAlreadySilenced, 
        // -----------------------------------------------------
        
        intervalId: null,
        problemSection: null,
        evaluationSection: null,
        problemBtn,
        infusionItem,
        finalized: false,
        agendaDoseId: agendaId,
    };

    console.log('Identifica√ß√£o agendaDoseId.', agendaDoseId);

    // --- ATUALIZA√á√ÉO: Listeners Internos com Salvamento ---
    if(typeof silenceAlarm === 'function') {
        silenceButton.addEventListener('click', () => {
            // 1. Salva no LocalStorage que este ID foi silenciado
            const currentList = JSON.parse(localStorage.getItem('silencedInfusions') || '[]');
            if (!currentList.includes(infusionId)) {
                currentList.push(infusionId);
                localStorage.setItem('silencedInfusions', JSON.stringify(currentList));
            }

            // 2. Marca o objeto atual como silenciado (redund√¢ncia de seguran√ßa)
            infusion.alarmSilencedPermanent = true;

            // 3. Chama a fun√ß√£o original
            silenceAlarm(infusion);
        });
    }
    // -----------------------------------------------------

    problemBtn.addEventListener('click', () => {
        // (L√≥gica do bot√£o de problema mantida igual...)
        if (!infusion.finalized) {
            if (!infusion.problemSection || infusion.problemSection.style.display === 'none') {
                if (!infusion.problemSection && typeof createProblemSection === 'function') 
                    infusion.problemSection = createProblemSection(infusionId, infusion.infusionItem);
                
                if(infusion.problemSection) {
                    infusion.problemSection.style.display = 'block';
                    problemBtn.textContent = t['btnCloseProblem'] || 'Fechar problema';
                }
            } else {
                infusion.problemSection.style.display = 'none';
                problemBtn.textContent = t['btnSolveProblem'] || 'Solucionar um problema?';
            }
        } else {
             if (!infusion.evaluationSection || infusion.evaluationSection.style.display === 'none') {
                if (!infusion.evaluationSection && typeof createEvaluationSection === 'function') 
                    infusion.evaluationSection = createEvaluationSection(infusionId, infusion.infusionItem);
                
                if(infusion.evaluationSection) {
                    infusion.evaluationSection.style.display = 'block';
                    problemBtn.textContent = t['btnCloseEvaluation'] || 'Fechar avalia√ß√£o';
                }
             } else {
                infusion.evaluationSection.style.display = 'none';
                problemBtn.textContent = t['btnEvaluation'] || 'Avalia√ß√£o de conclus√£o';
             }
        }
    });

    function runTimer() {
        const now = Date.now();
        const elapsed = now - infusion.startTime;
        const remainingMs = infusion.endTime - now;
        
        const percent = Math.min((elapsed / (infusion.duration * 1000)) * 100, 100);
        infusion.progressBar.style.width = percent + '%';

        let remainingSeconds = Math.max(0, Math.round(remainingMs / 1000));
        infusion.timerText.textContent = formatTimerText(remainingSeconds);

        // A verifica√ß√£o abaixo agora respeita o isAlreadySilenced carregado no in√≠cio
        if (remainingMs <= 300000 && remainingMs > 0 && !infusion.finalized && !infusion.alarmSilencedPermanent) {
            if(typeof triggerAlarm === 'function') triggerAlarm(infusion);
        } else {
            if (infusion.alarmMessage) infusion.alarmMessage.style.display = 'none';
            if (infusion.controls) infusion.controls.style.display = 'none';
        }

        if (remainingMs <= 0) {
            clearInterval(infusion.intervalId);

            if (!infusion.finalized && typeof ReportSystem !== 'undefined') {
                ReportSystem.startTimer();
            }
                     
            if(typeof AlarmSystem !== 'undefined') {
                AlarmSystem.stopAlarm();
            } else if(infusion.alarmSound) {
                infusion.alarmSound.pause();
                infusion.alarmSound.currentTime = 0;
            }

            infusion.progressBar.style.width = '100%';
            infusion.timerText.textContent = "00:00:00 - " + (t['statusFinished'] || "Finalizado");
            
            if (infusion.alarmMessage) {
                infusion.alarmMessage.textContent = t['msgInfusionFinished'] || "Infus√£o finalizada.";
                infusion.alarmMessage.style.color = "green";
                infusion.alarmMessage.style.display = "block";
            }
            
            if (infusion.controls) infusion.controls.style.display = 'none';

            infusion.finalized = true;
            
            if (infusion.problemSection) infusion.problemSection.style.display = 'none';
            
            if (typeof createEvaluationSection === 'function' && !infusion.evaluationSection) {
                infusion.evaluationSection = createEvaluationSection(infusionId, infusion.infusionItem); 
            }
            
            if (infusion.problemBtn) {
                infusion.problemBtn.textContent = t['btnEvaluation'] || 'Avalia√ß√£o de conclus√£o';
                infusion.problemBtn.classList.remove('solving');
                infusion.problemBtn.classList.add('evaluation');
            }
        }
    }
    
    infusion.intervalId = setInterval(runTimer, 1000);
    runTimer(); 

    if (!isRestoring && typeof showModal === 'function') {
         let startMsg = t['msgInfusionStarted'] || "Infus√£o de {med} come√ßou. Pode dar in√≠cio na bomba de infus√£o agora.üìü";
         startMsg = startMsg.replace('{med}', nomeMedicamento);
         showModal(t['modalSuccessTitle'] || 'Sucesso', startMsg);
    }
}

startBtn.addEventListener('click', async () => {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    // 2. Obter dados (Mantido original)
    const doseId = doseEmAcaoId;
    
    // TRADU√á√ÉO: Nome padr√£o caso n√£o encontre na agenda
    const defaultMedName = t['defaultMedName'] || 'Medicamento';

    // Nota: Se voc√™ busca de AGENDA_SIMULADA, certifique-se que ela existe. 
    const dose = typeof AGENDA_SIMULADA !== 'undefined' 
                 ? AGENDA_SIMULADA.find(d => d.id === doseId) 
                 : { id: doseId, nome_medicamento: defaultMedName, dosagem: '0' }; // Fallback seguro

    // Parsing de inputs de tempo (Mantido original)
    let { h, m, s } = parseTimeInputs();
    let durationSeconds = totalSeconds(h, m, s);
    
    if (durationSeconds <= 0) {
        // TRADU√á√ÉO: Mensagem de valida√ß√£o
        showModal(t['modalErrorTitle'], t['msgInvalidTime']);
        return;
    }
    
    const volume = parseFloat(volumeInput.value).toFixed(2);
    const flow = parseFloat(flowInput.value).toFixed(2);

    // 3. CALCULAR DATA FINAL PREVISTA
    const now = new Date();
    const endDate = new Date(now.getTime() + (durationSeconds * 1000));
    // Formata para MySQL: YYYY-MM-DD HH:MM:SS
    const endDateFormat = new Date(endDate.getTime() - (endDate.getTimezoneOffset() * 60000))
                          .toISOString().slice(0, 19).replace('T', ' ');

    // 4. SALVAR NO BANCO DE DADOS
    try {
        const formData = new FormData();
        formData.append('id', doseId);
        formData.append('data_hora_final_previsto', endDateFormat);

        const volumeVisual = parseFloat(volumeInput.value).toFixed(2);
        const flowVisual = parseFloat(flowInput.value).toFixed(2);
        
        const payload = {
            id: doseId,
            data_hora_final_previsto: endDateFormat,
            volume_infusao: volumeVisual,
            vazao_infusao: flowVisual
        };

        // Chamada API
        await fetch('api.php?action=registrar-inicio-infusao', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Timezone': userTimezone },
            body: JSON.stringify(payload)
        });
        
    } catch (e) {
        console.error("Erro ao salvar dados da infus√£o:", e);
        // TRADU√á√ÉO: Feedback de erro de salvamento (opcional, mas recomendado)
        showModal(t['modalWarningTitle'], t['msgSaveInfusionError']);
    }

    // 5. GERAR O CARD
    spawnInfusionCard({
        agendaId: doseId,
        nomeMedicamento: dose.nome_medicamento || defaultMedName,
        volume: volume,
        flow: flow,
        durationSeconds: durationSeconds,
        endTimeMs: endDate.getTime(),
        isRestoring: false
    });

    // 6. Finalizar A√ß√£o da Agenda
    if(typeof removerDoseDaAgenda === 'function') {
        removerDoseDaAgenda(doseId, "realizada", ""); 
    }
    
    resetForm();
    closeForm(); 
});

</script>
  <script>
        
        const SUGESTOES_MEDS = ['Amoxicilina', 'Dipirona', 'Captopril', 'Insulina'];
        const SUGESTOES_MEDS_UND = ['mg', 'ml', 'gotas']; 
        const beepSound = new Audio('beep.mp3');

        // Fun√ß√£o para carregar as sugest√µes (Autocompletar) medicamentos
        function carregarSugestoes() {
            const datalist = document.getElementById('sugestoesMeds');
            datalist.innerHTML = '';
            SUGESTOES_MEDS.forEach(med => {
                const option = document.createElement('option');
                option.value = med;
                datalist.appendChild(option);
            });
        }
        
        // Fun√ß√£o para carregar as sugest√µes (Autocompletar) unidade de doses
        function carregarSugestoesUND() {
            const datalist = document.getElementById('sugestoesMedsUnd');
            datalist.innerHTML = '';
            SUGESTOES_MEDS_UND.forEach(medund => {
                const option = document.createElement('option');
                option.value = medund;
                datalist.appendChild(option);
            });
        }

        // --- Fun√ß√£o Auxiliar que estava faltando ---
        function garantirValorSelect(elementId, valorPadrao) {
            const element = document.getElementById(elementId);
            if (element) {
                element.value = valorPadrao;
                // Caso o valor n√£o exista na lista, reseta para o √≠ndice 0 (opcional)
                if (element.selectedIndex === -1) {
                    element.selectedIndex = 0;
                }
            }
        }

      function resetFormularioPrescricao() {
            const form = document.getElementById('formPrescricao');
            form.reset();

            // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
            const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
                    ? LANG_STRINGS[currentLang] 
                    : LANG_STRINGS['pt'];

            // 2. Define os valores padr√£o usando as tradu√ß√µes ou valores fixos
            
            // Para 'Via', geralmente termos m√©dicos como 'Oral' s√£o universais ou mantidos fixos no value
            garantirValorSelect('via_administracao', 'Oral'); 

            // Para os demais, usamos as chaves de tradu√ß√£o
            garantirValorSelect('volume_diluicao_liquido', t['optNone'] || 'Nenhum');
            garantirValorSelect('status_pagador', t['payerPublic'] || 'P√∫blico');
            garantirValorSelect('status_receita', t['statusActive'] || 'Ativa');
        }

        // Fun√ß√£o para alternar campos dependentes no formul√°rio
        function alternarCamposFormulario() {
            const via = document.getElementById('via_administracao').value;
            const liquido = document.getElementById('volume_diluicao_liquido').value;

            console.log('via √©', via);
            
            const campoVazao = document.getElementById('campoVazao');
            if (via === 'Intravenosa' || via === 'Nasofagica') {
                campoVazao.style.display = 'block';
                document.getElementById('vazao_bomba').setAttribute('required', 'required');
            } else {
                campoVazao.style.display = 'none';
                document.getElementById('vazao_bomba').removeAttribute('required');
            }

            const camposDiluicao = document.getElementById('camposDiluicao');
            if (liquido === 'Soro Fisiol√≥gico' || liquido === '√Ågua') {
                camposDiluicao.style.display = 'block';
                document.getElementById('volume_diluicao_quant').setAttribute('required', 'required');
            } else {
                camposDiluicao.style.display = 'none';
                document.getElementById('volume_diluicao_quant').removeAttribute('required');
            }
        }
        
        function formatarHora(dataHoraString) {
            const data = new Date(dataHoraString);
            return data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }


        {

        /**
         * Formata data/hora para exibi√ß√£o
         */
        function formatarDataHora(dataHora) {
          const data = new Date(dataHora);
          const dia = String(data.getDate()).padStart(2, '0');
          const mes = String(data.getMonth() + 1).padStart(2, '0');
          const ano = data.getFullYear();
          const hora = String(data.getHours()).padStart(2, '0');
          const minuto = String(data.getMinutes()).padStart(2, '0');
          
          return `${dia}/${mes}/${ano} ${hora}:${minuto}`;
        }


        // Listener para atualizar interface quando agenda mudar
        document.addEventListener('agendaAtualizada', (e) => {
          console.log('Evento agendaAtualizada disparado:', e.detail);
          //renderizarAgenda();
          construirAgenda()
        });

        }
        
       // Fun√ß√£o auxiliar para processar e remover a dose (Ignorar ou Suspender)
        async function processarDoseComObservacao(doseId, novoStatus, observacao) {
            // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
            const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
                    ? LANG_STRINGS[currentLang] 
                    : LANG_STRINGS['pt'];

            if (doseId === null) {
                console.error("ID da dose est√° nulo ao tentar processar.");
                return;
            }

            try {
                // 1. Enviar os dados ao backend
                const resp = await apiPost('atualizar-status-agenda-com-observacao', {
                    id: doseId,
                    status: novoStatus,
                    // A data/hora realizada √© o momento da a√ß√£o para fins de log
                    data_hora_realizada: new Date().toISOString().slice(0, 19).replace('T', ' '),
                    observacoes: observacao
                });

                if (resp.success) {
                    console.log(`Dose ${doseId} atualizada para '${novoStatus}' com observa√ß√£o salva.`);
                    
                    // TRADU√á√ÉO: Seleciona a mensagem baseada no status
                    let msg;
                    // Verifica se √© suspensa (considerando poss√≠vel envio em PT ou EN pelo c√≥digo legado)
                    if (novoStatus === 'Suspensa' || novoStatus === 'Suspended') {
                        msg = t['msgDoseSuspendedObs'] || "Dose suspensa e registrada com observa√ß√£o.";
                    } else {
                        msg = t['msgDoseRegisteredObs'] || "Dose registrada com observa√ß√£o.";
                    }
                    
                    showModal(t['modalSuccessTitle'] || 'Sucesso', msg);

                } else {
                    console.error('Falha ao processar dose no backend:', resp.message || resp.error);
                    
                    // TRADU√á√ÉO: Mensagem de erro com placeholder
                    let errMsg = t['msgDoseActionError'] || "ERRO: Falha ao registrar a a√ß√£o de {status}.";
                    errMsg = errMsg.replace('{status}', novoStatus);
                    
                    showModal(t['modalErrorTitle'] || 'Erro', errMsg);
                }
            } catch (e) {
                console.error('Erro de conex√£o ao processar dose:', e);
                // TRADU√á√ÉO: Erro de conex√£o
                showModal(
                    t['modalErrorTitle'] || 'Erro', 
                    t['msgConnectionError'] || 'Erro de conex√£o com o servidor.'
                );
            } finally {
                // 2. Limpar a interface
                removerDoseDaAgenda(doseId, novoStatus); 
                fecharModalIgnorar();
                
                // Limpar o ID global
                doseEmAcaoId = null; 
            }
        }

        // Fun√ß√£o para remover uma dose da Agenda (interface e dados)
       function removerDoseDaAgenda(id, status, observacoes) {
            // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
            const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
                    ? LANG_STRINGS[currentLang] 
                    : LANG_STRINGS['pt'];

            // 2. Remove da Simula√ß√£o de Dados
            AGENDA_SIMULADA = AGENDA_SIMULADA.filter(dose => dose.id !== id);

            // 3. Remove do DOM
            const elementoParaRemover = document.querySelector(`.lembrete-dose[data-dose-id="${id}"]`);
            if (elementoParaRemover) {
                if (typeof silenciarAlarme === 'function') silenciarAlarme(elementoParaRemover);
                elementoParaRemover.remove();
            }

            // 4. L√≥gica de Jogo (Penalidade)
            if (status === "Ignorada" || status === "Suspensa") {
                // Penalidade por neglig√™ncia
                state.gameStats.survivalProbability = Math.max(0, state.gameStats.survivalProbability - 10);
                updateStatsUI();
                
                // TRADU√á√ÉO: Mensagem de penalidade
                showStatusMessage(t['msgDoseNeglected'] || '‚ùå Medica√ß√£o ignorada ou suspensa. -10% de chance.');
            } else if (status === "realizada") {
                // (L√≥gica de sucesso j√° tratada em outro lugar ou aqui se necess√°rio)
            }

            // 5. Atualiza a mensagem de agenda vazia
            if (AGENDA_SIMULADA.length === 0) {
                const agendaContainer = document.getElementById('agendaDia');
                if (agendaContainer) {
                    // TRADU√á√ÉO: Injeta HTML com chaves de tradu√ß√£o E o texto atual
                    const todayTitle = t['todayAgenda'] || 'Agenda de Hoje';
                    const allDoneMsg = t['msgAllMedsTaken'] || 'As medica√ß√µes est√£o em dia!';
                    
                    agendaContainer.innerHTML = `
                        <h2 data-i18n="todayAgenda">${todayTitle}</h2>
                        <p>${allDoneMsg}</p>
                    `;
                }
            }

            // 6. Data/Hora Local para o Backend
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hour = String(now.getHours()).padStart(2, '0');
            const minute = String(now.getMinutes()).padStart(2, '0');
            const second = String(now.getSeconds()).padStart(2, '0');

            let nowDateLocal = `${year}-${month}-${day} ${hour}:${minute}:${second}`; 

            // 7. Chama API
            if (typeof Atualiza_Status_Agenda === 'function') {
                Atualiza_Status_Agenda(id, status, nowDateLocal, observacoes); 
            }
        }

      
        async function construirAgenda() {
            const agendaDiv = document.getElementById('agendaDia');
            
            // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
            const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
                    ? LANG_STRINGS[currentLang] 
                    : LANG_STRINGS['pt'];

            // Mostra um estado de carregamento inicial
            agendaDiv.innerHTML = `
                <h2><i data-i18n="todayAgenda">${t['todayAgenda']}</i></h2>
                <div class="flex flex-col items-center justify-center p-4 gap-2">
                    <span class="animate-pulse text-gray-500">${t['msgSyncData'] || 'Sincronizando dados cl√≠nicos...'}</span>
                </div>
            `;

            try {
                const patientId = (typeof state !== 'undefined' && state.patientId) ? state.patientId : 1;

                // --- 1. Consultas √† API ---
                const [respAppointments, respLocation, respCatheters] = await Promise.all([
                    apiGet('get-appointments', { paciente_id: patientId }),
                    fetch(`api.php?action=get-last-location&patientId=${patientId}`).then(r => r.json()),
                    apiGet('get-catheters', { patient_id: patientId })
                ]);

                // Limpa o loader
                agendaDiv.innerHTML = `<h2><i data-i18n="todayAgenda">${t['todayAgenda']}</i></h2>`;

                // ============================================================
                // 2. Verifica√ß√£o de Limpeza Terminal (TMO)
                // ============================================================
                if (respLocation.success && respLocation.data) {
                    const d = respLocation.data;
                    if (typeof currentLocationId !== 'undefined' && d.id) currentLocationId = d.id;
                    else if (d.id) window.currentLocationId = d.id;

                    const frequencia = parseInt(d.cleaning_frequency) || 7;
                    let precisaLimpar = false;
                    let diasPassados = 0;

                    if (!d.last_cleaning_date) {
                        precisaLimpar = true;
                        diasPassados = "N/A";
                    } else {
                        const hoje = new Date();
                        const ultimaLimpeza = new Date(d.last_cleaning_date);
                        const diffTime = Math.abs(hoje - ultimaLimpeza);
                        diasPassados = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                        if (diasPassados >= frequencia) precisaLimpar = true;
                    }

                    if (precisaLimpar) {
                        const divLimpeza = document.createElement('div');
                        divLimpeza.className = "bg-red-50 border-l-4 border-red-500 p-4 mb-4 shadow-sm rounded-r fade-in";
                        
                        // TRADU√á√ÉO: Textos de Limpeza
                        const title = t['tmoRequiredTitle'] || 'Limpeza Terminal Necess√°ria';
                        let msg = t['tmoLastCleaning'] || '√öltima limpeza h√° <strong>{days} dias</strong>. (Meta: cada {freq} dias).';
                        msg = msg.replace('{days}', diasPassados).replace('{freq}', frequencia);
                        const btnText = t['tmoChecklistBtn'] || 'Checklist';

                        divLimpeza.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <svg class="h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <h3 class="text-sm font-bold text-red-800">${title}</h3>
                                        <p class="text-xs text-red-700 mt-1">${msg}</p>
                                    </div>
                                </div>
                                <button onclick="openChecklistTMO()" class="ml-2 bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-2 px-3 rounded shadow animate-pulse">
                                    ${btnText}
                                </button>
                            </div>
                        `;
                        agendaDiv.appendChild(divLimpeza);
                    }
                }

                // ============================================================
                // 3. Verifica√ß√£o de Cateteres
                // ============================================================
                if (respCatheters.success && respCatheters.data && respCatheters.data.length > 0) {
                    const cateteres = respCatheters.data;
                    const hoje = new Date();
                    hoje.setHours(0, 0, 0, 0);

                    cateteres.forEach(cat => {
                        let pendencias = [];
                        if (!cat.ultima_manutencao) return; 

                        let dataLimpa = cat.ultima_manutencao;
                        if (dataLimpa.length > 10) dataLimpa = dataLimpa.substring(0, 10);
                        const parts = dataLimpa.split('-'); 
                        const ultimaManutencao = new Date(parts[0], parts[1] - 1, parts[2]);

                        if (isNaN(ultimaManutencao.getTime())) return;

                        const diffTime = hoje - ultimaManutencao;
                        const diasPassados = Math.floor(diffTime / (1000 * 60 * 60 * 24));

                        const freqFlush = parseInt(cat.freq_flush);
                        if (!isNaN(freqFlush) && freqFlush > 0 && diasPassados >= freqFlush) {
                            pendencias.push(t['catIssueFlush'] || 'Flush/Saliniza√ß√£o (Venceu hoje ou antes)');
                        }

                        const freqCurativo = parseInt(cat.freq_curativo);
                        if (!isNaN(freqCurativo) && freqCurativo > 0 && diasPassados >= freqCurativo) {
                            pendencias.push(t['catIssueDressing'] || 'Troca de Curativo (Venceu hoje ou antes)');
                        }

                        if (pendencias.length > 0) {
                            const divCateter = document.createElement('div');
                            divCateter.className = "bg-orange-50 border-l-4 border-orange-500 p-4 mb-4 shadow-sm rounded-r fade-in";
                            
                            const maintTitle = (t['catMaintTitle'] || 'Manuten√ß√£o: ') + (cat.tipo_cateter || 'Cateter');
                            const btnCheck = t['tmoChecklistBtn'] || 'Checklist';

                            divCateter.innerHTML = `
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <svg class="h-5 w-5 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                        </svg>
                                    </div>
                                    <div class="ml-3 w-full">
                                        <h3 class="text-sm font-bold text-orange-800">${maintTitle}</h3>
                                        <ul class="list-disc list-inside text-xs text-orange-700 mt-1">
                                            ${pendencias.map(p => `<li>${p}</li>`).join('')}
                                        </ul>
                                        <div class="mt-2 text-right">                                    
                                            <button onclick="openChecklistModal('${cat.id}')" class="ml-2 bg-orange-600 hover:bg-orange-800 text-white text-xs font-bold py-2 px-3 rounded shadow animate-pulse">
                                                ${btnCheck}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                            agendaDiv.appendChild(divCateter);
                        }
                    });
                }

                // ============================================================
                // 4. Agendamentos (Consultas/Exames)
                // ============================================================
                let eventosHoje = [];
                if (respAppointments.success && respAppointments.data && respAppointments.data.length > 0) {
                    const hojeStr = new Date().toLocaleDateString('en-CA'); 
                    eventosHoje = respAppointments.data.filter(app => app.data_consulta === hojeStr);
                }

                if (eventosHoje.length > 0) {                   
                    const divAviso = document.createElement('div');
                    divAviso.className = "bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4 shadow-sm rounded-r fade-in";
                    
                    // TRADU√á√ÉO: Aviso de Agendamentos
                    let alertMsg = t['msgAppointmentsToday'] || '<strong>Aten√ß√£o:</strong> H√° <span class="font-bold">{count}</span> agendamento(s) hoje!';
                    alertMsg = alertMsg.replace('{count}', eventosHoje.length);
                    const listaTipos = eventosHoje.map(e => e.tipo_agendamento || 'Compromisso').join(', ');

                    divAviso.innerHTML = `
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-yellow-700">${alertMsg}</p>
                                <p class="text-xs text-yellow-600 mt-1">(${listaTipos})</p>
                            </div>
                        </div>
                    `;
                    agendaDiv.appendChild(divAviso);
                }

                // ============================================================
                // 5. Medica√ß√µes (Doses)
                // ============================================================
                if (typeof AGENDA_SIMULADA === 'undefined' || AGENDA_SIMULADA.length === 0) {
                    const temAlertas = agendaDiv.querySelectorAll('.bg-red-50, .bg-orange-50, .bg-yellow-50').length > 0;
                    
                    if (typeof AlarmSystem !== 'undefined' && AlarmSystem.stopAlarm) {
                        AlarmSystem.stopAlarm();
                    }
                    
                    if (eventosHoje.length === 0 && !temAlertas) {
                        // TRADU√á√ÉO: Tudo Limpo
                        agendaDiv.innerHTML += `<p class="text-gray-500 mt-4 p-2 bg-green-50 rounded border border-green-200">${t['msgAllClear'] || '‚ú® Tudo tranquilo! Nenhuma pend√™ncia no momento.'}</p>`;
                    } else if (!temAlertas) {
                        // TRADU√á√ÉO: S√≥ rem√©dios OK
                        agendaDiv.innerHTML += `<p class="text-gray-500 mt-4">${t['msgAllMedsTaken'] || 'As medica√ß√µes est√£o em dia!'}</p>`;
                    }
                    return;
                }

                AGENDA_SIMULADA.forEach(dose => {
                    playCentralAlarm(state.medicationAlarmSound);

                    const elemento = document.createElement('div');
                    elemento.className = 'lembrete-dose';
                    elemento.setAttribute('data-dose-id', dose.id);
                    elemento.setAttribute('data-hora-prevista', dose.data_hora_prevista);

                    // TRADU√á√ÉO: Labels dos bot√µes e campos
                    const lblVia = t['labelVia'] || 'Via';
                    const lblDosage = t['medDosageLabel'] || 'Dosagem';
                    const lblDilution = t['labelDilution'] || 'Dilui√ß√£o';
                    const lblFlow = t['labelFlow'] || 'Vaz√£o';
                    const btnIgnore = t['btnIgnore'] || 'Ignorar';
                    const btnStart = t['btnStart'] || 'Iniciar';
                    const shiftBadge = (typeof ProfessionalPresence !== 'undefined') ? ProfessionalPresence.getBadgeHtml() : '';

                    elemento.innerHTML = `
                        <span class="info-dose">                             
                            <strong>${dose.nome_medicamento}</strong> 
                            <p class="text-sm text-gray-600">
                                <span>${lblVia}</span>: ${dose.via_administracao}
                            </p> 
                            <p class="text-sm text-gray-600">
                                <span>${lblDosage}</span>: ${dose.dosagem} ${dose.unidade_dosagem}
                            </p> 
                            ${dose.volume_diluicao_quant > 0 ? 
                                `<p class="text-sm text-gray-600"><span>${lblDilution}</span>: ${dose.volume_diluicao_quant} ml</p>` 
                                : ''}
                            ${dose.vazao_bomba > 0 ? 
                                `<p class="text-sm text-gray-600"><span>${lblFlow}</span>: ${dose.vazao_bomba} ml/h</p>` 
                                : ''} 
                            <p class="text-sm text-gray-600">${shiftBadge}</p>                                                    
                        </span>                        
                        <div class="agenda-actions-container">                            
                            <p class="agenda-datetime text-sm font-semibold text-blue-600">${formatarDataHora(dose.data_hora_prevista)}</p>                             
                            <div class="agenda-buttons-wrapper">
                                <button class="agenda-btn agenda-btn-ignore" onclick="handleDoseAction(${dose.id}, 'Ignorar')">
                                    <span class="agenda-btn-icon">‚úï</span>
                                    <span class="agenda-btn-text">${btnIgnore}</span>
                                </button>
                                
                                <button class="agenda-btn agenda-btn-start" onclick="handleDoseAction(${dose.id}, 'Tomar')">
                                    <span class="agenda-btn-icon">‚úì</span>
                                    <span class="agenda-btn-text">${btnStart}</span>
                                </button>
                            </div>
                        </div>
                    `;
                    agendaDiv.appendChild(elemento);
                });

                // Reaplica idioma para garantir (caso haja outros elementos data-i18n)
                if(typeof setAppLanguage === 'function') setAppLanguage(state.appLanguage);
                if(typeof setFontSize === 'function') setFontSize(state.appFontSize);

            } catch (error) {
                console.error("Erro ao carregar agenda:", error);
                // TRADU√á√ÉO: Erro de API
                const msgError = t['msgAgendaErrorNetwork'] || 'Erro ao verificar agenda online. Verifique sua conex√£o.';
                agendaDiv.innerHTML += `<p class="text-red-500 text-sm">${msgError}</p>`;
                
                // Fallback
                if (typeof AGENDA_SIMULADA !== 'undefined' && AGENDA_SIMULADA.length > 0) {
                    // Opcional: recriar UI com dados locais
                }
            }
        }

        function silenciarAlarme(lembreteElement) {
            lembreteElement.classList.remove('lembrete-alerta');
            state.medicationAlarmSound.pause();
            state.medicationAlarmSound.currentTime = 0;
            const silenciarBtn = lembreteElement.querySelector('.btn-silenciar');
            if(silenciarBtn) silenciarBtn.style.display = 'none';
            if (typeof AlarmSystem !== 'undefined' && AlarmSystem.stopAlarm) {
                AlarmSystem.stopAlarm();
            }
        }

        function monitorarAlarmes() {
            const agora = new Date().getTime();
            const doses = document.querySelectorAll('.lembrete-dose');

            doses.forEach(doseElement => {
                const horaPrevistaStr = doseElement.getAttribute('data-hora-prevista');
                const horaPrevista = new Date(horaPrevistaStr).getTime();
                const diferencaMinutos = (horaPrevista - agora) / (1000 * 60);

                if (diferencaMinutos > 0 && diferencaMinutos <= 10) {
                    if (!doseElement.classList.contains('lembrete-alerta')) {
                        doseElement.classList.add('lembrete-alerta');
                        state.medicationAlarmSound.loop = true; // Mant√©m o loop
                        playCentralAlarm(state.medicationAlarmSound);
                    }
                } else {
                    silenciarAlarme(doseElement);
                }
            });
        }

   function handleDoseAction(id, acao) {
        // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
        const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
                ? LANG_STRINGS[currentLang] 
                : LANG_STRINGS['pt'];

        const dose = AGENDA_SIMULADA.find(d => d.id === id);
        doseEmAcaoId = id; 

        if (!dose) return; // Seguran√ßa extra caso n√£o ache a dose

        if (acao === 'Ignorar') {
            abrirModalIgnorar(id);
        } else if (acao === 'Tomar') {
            const lembreteElement = document.querySelector(`.lembrete-dose[data-dose-id="${id}"]`);
            if (lembreteElement) {
                silenciarAlarme(lembreteElement); 
                if (typeof AlarmSystem !== 'undefined' && AlarmSystem.stopAlarm) {
                    AlarmSystem.stopAlarm();
                }
            }
            
            if (dose.via_administracao === 'Oral') {
                console.log(`Dose ID ${id} oral tomada.`);
                
                // TRADU√á√ÉO: Mensagem de sucesso com nome do rem√©dio
                let msgSuccess = t['msgMedTakenSuccess'] || 'Medica√ß√£o {med} tomada com sucesso. üíä';
                msgSuccess = msgSuccess.replace('{med}', dose.nome_medicamento);
                
                showModal(t['modalSuccessTitle'] || 'Sucesso', msgSuccess);
                
                removerDoseDaAgenda(id, "realizada", "");

            } else {
                // Preencher formul√°rio COM c√°lculo autom√°tico de tempo
                preencherFormularioInfusaoComCalculo(dose);
                
                // Adicionar t√≠tulo no formul√°rio da bomba
                const formTitle = document.querySelector('#form-popup h3#formTitle');
                if (formTitle) {
                    // TRADU√á√ÉO: Elementos do t√≠tulo do formul√°rio
                    const lblInfusion = t['lblInfusion'] || 'Infus√£o';
                    const lblId = t['lblAgendaId'] || 'ID Agenda';
                    const msgAutoCalc = t['msgTimeCalcAuto'] || 'Tempo calculado automaticamente';

                    formTitle.innerHTML = `<i>${lblInfusion}: <strong>${dose.nome_medicamento}</strong> (${lblId}: ${dose.id})</i><br>
                                        <small style="color: #666;">${msgAutoCalc}</small>`;
                }
                
                // Abrir formul√°rio
                openForm();
            }
        }
    }

    function preencherFormularioInfusaoComCalculo(dose) {
    // Calcular volume total
    const volumeTotal = (parseFloat(dose.dosagem) + parseFloat(dose.volume_diluicao_quant || 0)).toFixed(2);
    const vazao = parseFloat(dose.vazao_bomba);
    
    // Preencher campos
    document.getElementById('volume').value = volumeTotal;
    document.getElementById('flow').value = vazao;
    
    // Auto-calcular o tempo baseado em volume e vaz√£o
    if (volumeTotal > 0 && vazao > 0) {
        const tempoHoras = volumeTotal / vazao;
        const tempoSegundos = tempoHoras * 3600;
        
        const horas = Math.floor(tempoSegundos / 3600);
        const minutos = Math.floor((tempoSegundos % 3600) / 60);
        const segundos = Math.floor(tempoSegundos % 60);
        
        document.getElementById('hours').value = horas;
        document.getElementById('minutes').value = minutos;
        document.getElementById('seconds').value = segundos;
        
        // Mostrar bot√£o de iniciar automaticamente
        const calculateBtn = document.getElementById('calculate-btn');
        const startBtn = document.getElementById('start-btn');
        const resetCalcBtn = document.getElementById('reset-calc-btn');
        
        if (calculateBtn) calculateBtn.style.display = 'none';
        if (startBtn) startBtn.style.display = 'block';
        if (resetCalcBtn) resetCalcBtn.style.display = 'block';
        
        console.log('Tempo calculado automaticamente:', {
            horas: horas,
            minutos: minutos,
            segundos: segundos
        });
    }
}

//configura√ß√µes
   const settingsModal = document.getElementById('settings-modal');
    const gameContainer = document.getElementById('game-container');

// Fun√ß√µes para abrir e fechar o modal de configura√ß√µes
  /**
 * Abre o modal de configura√ß√µes e preenche os campos.
 */

function openSettingsModal() {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    const modal = document.getElementById('settings-modal');
    modal.classList.remove('hidden');
    setTimeout(() => document.getElementById('settings-content').classList.remove('scale-95'), 10);
    
    // 1. Inicializa as abas
    if (typeof setupTabs === 'function') {
        setupTabs(); 
    }
    
    // 2. Carrega dados de Perfil (Cuidador)
    document.getElementById('settingsCaregiverNickname').value = state.nickname || '';
    
    // Preenche as op√ß√µes de rela√ß√£o dinamicamente (reaproveitando do loginScreen)
    const relationSelect = document.getElementById('settingsCaregiverRelation');
    if (relationSelect && relationSelect.options.length === 0) {
        // Tenta copiar do select original se ele existir na DOM
        const originalSelect = document.getElementById('caregiverRelation');
        if (originalSelect) {
            relationSelect.innerHTML = originalSelect.innerHTML;
        }
    }
    if (relationSelect) {
        relationSelect.value = state.relation || '';
    }
    
    const avatarImg = document.getElementById('settingsCaregiverAvatar');
    if (avatarImg) {
        avatarImg.src = state.avatarUrl || 'https://placehold.co/80x80/cbd5e1/475569?text=C';
    }
    
    // 3. Carrega dados de Perfil (Paciente)
    if (state.patient) {
        document.getElementById('settingsPatientNickname').value = state.patient.nickname || '';
        document.getElementById('settingsPatientIllness').value = state.patient.illness || '';
        document.getElementById('settingsPatientAllergies').value = state.patient.allergies || '';
        
        const patAvatar = document.getElementById('settingsPatientAvatar');
        if (patAvatar) {
            patAvatar.src = state.patient.avatarUrl || 'https://placehold.co/80x80/cbd5e1/475569?text=P';
        }
    } else {
        // TRADU√á√ÉO: Texto de "Nenhum paciente"
        document.getElementById('settingsPatientNickname').value = t['msgNoPatientSelected'] || 'Nenhum paciente selecionado';
        document.getElementById('settingsPatientIllness').value = '';
        document.getElementById('settingsPatientAllergies').value = '';
    }
    
    // 4. Carrega configura√ß√µes do Sistema
    
    // Carregar a prefer√™ncia de som do alarme
    const alarmSelect = document.getElementById('alarm-select');
    if (alarmSelect) {
        // Tenta pegar de userAlarmPreference ou alarmSound (compatibilidade)
        alarmSelect.value = state.userAlarmPreference || state.alarmSound || 'beep';
    }

    // Carregar idioma atual no select (se existir)
    const langSelect = document.getElementById('language-select');
    if (langSelect && state.appLanguage) {
        langSelect.value = state.appLanguage;
    }
}

/**
 * Fecha o modal de configura√ß√µes.
 */
function closeSettingsModal() {
    document.getElementById('settings-content').classList.add('scale-95');
    setTimeout(() => document.getElementById('settings-modal').classList.add('hidden'), 300);
}


/* --- L√ìGICA DE LOCALIZA√á√ÉO E HIST√ìRICO (Renomeada) --- */

// Vari√°vel global para armazenar coordenadas tempor√°rias
let currentLocationCoords = { lat: null, lng: null };

/* Vers√£o Aprimorada com Feedback de Dist√¢ncia */
async function openLocationModal() {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    const modal = document.getElementById('locationModal');
    if (!modal) return;

    // 1. Mostrar o modal imediatamente
    modal.classList.remove('hidden');

    // Refer√™ncias aos elementos
    const inputHosp = document.getElementById('hospitalNameInput');
    const inputSec  = document.getElementById('hospitalSector');
    const inputFlr  = document.getElementById('hospitalFloor');
    const inputBed  = document.getElementById('hospitalBed');
    const inputDate = document.getElementById('admissionDate');
    const gpsStatus = document.getElementById('gpsStatus');
    const inputFreq = document.getElementById('loc_freq_limpeza');
    const cleaningContainer = document.getElementById('cleaningActionContainer');
    const locationToggle = document.getElementById('locationToggle');

    // Reset visual
    if (gpsStatus) {
        // TRADU√á√ÉO: Status inicial
        gpsStatus.innerText = t['gpsSearching'] || "üìç Buscando dados...";
        gpsStatus.className = "text-xs text-gray-500 mt-2";
    }
    if (cleaningContainer) cleaningContainer.innerHTML = '';

    // 2. BUSCAR DADOS DO SERVIDOR
    try {
        const patientId = (typeof state !== 'undefined' && state.patientId) ? state.patientId : 1;
        const response = await fetch(`api.php?action=get-last-location&patientId=${patientId}`);
        const json = await response.json();

        if (json.success && json.data) {
            const d = json.data;

            if (d.id) currentLocationId = d.id; 

            // Verifica se existem dados de hospital no banco
            const temDadosHospital = (d.sector || d.floor || d.bed || (d.hospital_name && d.hospital_name !== 'Casa de Paciente'));

            if (locationToggle) {
                locationToggle.checked = temDadosHospital; 
                if (typeof toggleLocationMode === 'function') toggleLocationMode();
            }

            // Preenchimento dos campos
            // TRADU√á√ÉO: Nome padr√£o para casa
            const homeLabel = t['labelHomePatient'] || 'Casa de Paciente';
            inputHosp.value = d.hospital_name || (temDadosHospital ? '' : homeLabel);
            
            if (d.sector) inputSec.value = d.sector;
            if (d.floor)  inputFlr.value = d.floor;
            if (d.bed)    inputBed.value = d.bed;
            if (d.cleaning_frequency && inputFreq) inputFreq.value = d.cleaning_frequency;

            // Tratamento da Data
            if (d.admission_date && !d.admission_date.startsWith('0000')) {
                inputDate.value = d.admission_date.split(' ')[0];
                if (typeof calculateLocationDays === 'function') calculateLocationDays();
            }

            // --- L√ìGICA DO BOT√ÉO TMO ---
            if (cleaningContainer) {
                const frequencia = parseInt(d.cleaning_frequency) || 7;
                
                // TRADU√á√ÉO: Status padr√£o
                let statusText = t['tmoStatusNone'] || "Nenhuma limpeza registrada anteriormente.";
                let btnClass = "bg-blue-600 hover:bg-blue-700";
                // TRADU√á√ÉO: Bot√£o padr√£o
                let btnText = t['tmoBtnDoChecklist'] || "Realizar Checklist de Limpeza TMO";
                let diasPassados = 999; 

                if (d.last_cleaning_date && !d.last_cleaning_date.startsWith('0000')) {
                    const hoje = new Date();
                    const ultimaLimpeza = new Date(d.last_cleaning_date);
                    const diffTime = Math.abs(hoje - ultimaLimpeza);
                    diasPassados = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    
                    // TRADU√á√ÉO: Texto com vari√°veis
                    // Ex: "√öltima limpeza: {days} dias atr√°s (Meta: {freq} dias)."
                    let msg = t['tmoStatusDays'] || "√öltima limpeza: {days} dias atr√°s (Meta: {freq} dias).";
                    statusText = msg.replace('{days}', diasPassados).replace('{freq}', frequencia);

                    if (diasPassados >= frequencia) {
                        btnClass = "bg-red-600 hover:bg-red-700 animate-pulse border-2 border-red-800 shadow-lg shadow-red-500/50";
                        // TRADU√á√ÉO: Bot√£o Vencido
                        btnText = t['tmoBtnExpired'] || "‚ö†Ô∏è ATEN√á√ÉO: Limpeza TMO Vencida";
                    } else {
                        btnClass = "bg-green-600 hover:bg-green-700";
                        // TRADU√á√ÉO: Bot√£o Em Dia
                        btnText = t['tmoBtnOk'] || "Limpeza em dia. Realizar nova?";
                    }
                }

                // TRADU√á√ÉO: Tag "A√ß√£o Necess√°ria"
                const actionTag = diasPassados >= frequencia 
                    ? `<span class="text-xs bg-red-100 text-red-800 px-2 py-0.5 rounded-full font-bold">${t['tagActionRequired'] || 'A√ß√£o Necess√°ria'}</span>` 
                    : '';

                cleaningContainer.innerHTML = `
                    <div class="border-t border-gray-200 pt-4 mt-2">
                        <div class="flex justify-between items-center mb-2">
                             <p class="text-xs text-gray-600 font-semibold">${statusText}</p>
                             ${actionTag}
                        </div>
                        <button type="button" onclick="openChecklistTMO()" class="${btnClass} text-white font-bold py-3 px-4 rounded w-full flex justify-center items-center gap-2 shadow-md transition duration-200">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                            ${btnText}
                        </button>
                    </div>
                `;
            }
        }
    } catch (e) {
        console.error("Erro ao carregar dados:", e);
    }

    // 3. Iniciar GPS
    if (navigator.geolocation) {
        if (gpsStatus) gpsStatus.innerText = t['gpsConfirming'] || "üìç Confirmando GPS...";
        
        navigator.geolocation.getCurrentPosition(
            (position) => {
                if (typeof currentLocationCoords !== 'undefined') {
                    currentLocationCoords.lat = position.coords.latitude;
                    currentLocationCoords.lng = position.coords.longitude;
                }
                if (gpsStatus) {
                    gpsStatus.innerText = t['gpsUpdated'] || "üìç Localiza√ß√£o GPS Atualizada";
                    gpsStatus.className = "text-xs text-green-600 mt-2 font-bold";
                }
            },
            (error) => {
                if (gpsStatus) {
                    gpsStatus.innerText = t['gpsOffline'] || "üìç Usando √∫ltima localiza√ß√£o conhecida (GPS Off)";
                    gpsStatus.className = "text-xs text-orange-500 mt-2";
                }
            },
            { enableHighAccuracy: true, timeout: 8000 }
        );
    }
}

function closeLocationModal() {
    const modal = document.getElementById('locationModal');
    if (modal) modal.classList.add('hidden');
}

// Fun√ß√£o corrigida para ignorar horas e fusos hor√°rios
function calculateLocationDays() {
    const inputDate = document.getElementById('admissionDate').value;
    const display = document.getElementById('daysInHospital');
    
    if (!inputDate || !display) {
        if (display) display.innerText = "0";
        return;
    }

    // 1. Cria a data de in√≠cio for√ßando o hor√°rio local (adicionando T00:00:00)
    // Isso evita que o navegador use UTC e volte um dia
    const start = new Date(inputDate + "T00:00:00");
    
    // 2. Cria a data de hoje e ZERA as horas
    const now = new Date();
    now.setHours(0, 0, 0, 0);

    // 3. Calcula a diferen√ßa em milissegundos
    const diffTime = now - start;

    // 4. Converte para dias usando Math.floor (arredondar para baixo)
    // Como zeramos as horas, a divis√£o ser√° exata ou muito pr√≥xima
    let diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); 
    
    // Evita n√∫meros negativos se o usu√°rio selecionar data futura
    if (diffDays < 0) diffDays = 0;
    
    display.innerText = diffDays;
}

// Busca a √∫ltima localiza√ß√£o salva e decide a posi√ß√£o do bot√£o
async function fetchLastLocation(pid) {
    try {
        const resp = await fetch(`api.php?action=get-last-location&patientId=${pid}`);
        const json = await resp.json();

        if (json.success && json.data) {
            const data = json.data;
            const toggle = document.getElementById('locationToggle');
            
            // L√ìGICA INTELIGENTE DE DECIS√ÉO:
            // Verifica se existem dados de interna√ß√£o (Setor, Andar OU Leito preenchidos)
            // Se qualquer um deles existir, consideramos que o paciente est√° internado.
            const hasHospitalData = (data.sector || data.floor || data.bed);

            if (hasHospitalData) {
                // MODO HOSPITAL (Internado)
                toggle.checked = true; // Bot√£o para a direita (Azul)
                fillModalFields(data, true);
            } else {
                // MODO RESID√äNCIA (Home Care)
                // Se n√£o tem dados de hospital, assume resid√™ncia
                toggle.checked = false; // Bot√£o para a esquerda (Verde)
                fillModalFields(data, false);
            }
            
            // Aplica a mudan√ßa visual nos campos (Mostra/Esconde inputs)
            toggleLocationMode();
        }
    } catch (e) {
        console.error("Erro ao buscar localiza√ß√£o:", e);
    }
}

// Controla o visual (Esconde/Mostra campos)
function toggleLocationMode() {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    const toggle = document.getElementById('locationToggle');
    const hospitalFields = document.getElementById('hospitalFields');
    const nameInput = document.getElementById('hospitalNameInput');
    const labelText = document.getElementById('toggleLabelText');
    const labelName = document.getElementById('lblLocalName');

    if (!toggle || !hospitalFields || !nameInput) return;

    // --- Defini√ß√£o dos Textos Traduzidos ---
    const txtHospitalMode = t['locModeHospital'] || "Hospital / Institui√ß√£o";
    const lblHospital = t['lblHospitalName'] || "Nome do Hospital:";
    
    const txtHomeMode = t['locModeHome'] || "Resid√™ncia / HomeCare";
    const lblHome = t['lblIdentification'] || "Identifica√ß√£o:";
    const valHomeDefault = t['valHomePatient'] || "Casa de Paciente";

    if (toggle.checked) {
        // --- MODO HOSPITAL (Direita) ---
        hospitalFields.classList.remove('hidden');
        
        if (labelText) labelText.innerText = txtHospitalMode;
        if (labelName) labelName.innerText = lblHospital;
        
        // Limpa se o valor atual for igual ao padr√£o de "Casa" (evita apagar algo que o usu√°rio digitou)
        // Nota: Idealmente verificamos contra o valor padr√£o de qualquer l√≠ngua, mas verificar o atual j√° ajuda.
        if (nameInput.value === valHomeDefault) {
            nameInput.value = ''; 
        }

    } else {
        // --- MODO RESID√äNCIA (Esquerda) ---
        hospitalFields.classList.add('hidden');
        
        if (labelText) labelText.innerText = txtHomeMode;
        if (labelName) labelName.innerText = lblHome;
        
        // Auto-preenche com o texto traduzido
        nameInput.value = valHomeDefault; 
    }
}

// Fun√ß√£o corrigida para garantir envio dos IDs
async function saveLocationSettings() {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    // 1. Verifica o modo: Resid√™ncia vs Hospital
    const toggle = document.getElementById('locationToggle');
    const isHospital = toggle ? toggle.checked : true; 

    // 2. Pegar nome do local
    const hospitalName = document.getElementById('hospitalNameInput').value;

    // 3. Captura ou Anula os dados de interna√ß√£o
    const sector = isHospital ? document.getElementById('hospitalSector').value : null;
    const floor = isHospital ? document.getElementById('hospitalFloor').value : null;
    const bed = isHospital ? document.getElementById('hospitalBed').value : null;
    const admissionDate = isHospital ? document.getElementById('admissionDate').value : null;

    // Captura frequ√™ncia de limpeza
    const freqInput = document.getElementById('loc_freq_limpeza');
    const cleaningFrequency = freqInput && freqInput.value ? freqInput.value : 7;

    if (!hospitalName) {
        // TRADU√á√ÉO: Valida√ß√£o de nome
        showModal(t['modalWarningTitle'] || 'Falta algo', t['msgMissingLocationName'] || "Por favor, informe o nome do Local.");
        return;
    }

    // --- L√≥gica de Identifica√ß√£o ---
    const patientId = (typeof state !== 'undefined' && state.patientId) ? state.patientId : null; 
    
    let caregiverId = (typeof state !== 'undefined' && state.userId) ? state.userId : null;
    if (!caregiverId) {
        try {
            const storedUser = JSON.parse(localStorage.getItem('user_data'));
            if (storedUser && storedUser.id) caregiverId = storedUser.id;
        } catch(e) {}
    }

    if (!caregiverId || !patientId) {
        // TRADU√á√ÉO: Erro de Sess√£o
        showModal(t['modalErrorTitle'] || 'Falha', t['msgSessionError'] || "Erro de Sess√£o: N√£o foi poss√≠vel identificar usu√°rio/paciente.");
        return;
    }

    // UI Loading
    const btn = document.getElementById('btnSaveLocation');
    const originalText = btn ? btn.innerText : (t['btnSave'] || 'Salvar');
    if (btn) {
        // TRADU√á√ÉO: Texto do bot√£o carregando
        btn.innerText = t['btnSaving'] || "Salvando...";
        btn.disabled = true;
    }
   
    try {
        // Tenta pegar coordenadas
        let latToSend = null;
        let lngToSend = null;
        
        if (typeof currentLat !== 'undefined' && currentLat) {
            latToSend = currentLat;
            lngToSend = currentLon;
        } else if (typeof currentLocationCoords !== 'undefined') {
            latToSend = currentLocationCoords.lat;
            lngToSend = currentLocationCoords.lng;
        }

        // Envio dos dados para a API
        const response = await apiPost('update-patient-location', {
            patientId: patientId,
            caregiverId: caregiverId,
            hospitalName: hospitalName,
            sector: sector,             
            floor: floor,               
            bed: bed,                   
            admissionDate: admissionDate, 
            lat: latToSend,
            lng: lngToSend,
            cleaningFrequency: cleaningFrequency
        });

        if (response.success) {
            // Atualiza Header Imediatamente
            const headerDisplay = document.getElementById('hospitalNameDisplay');
            if (headerDisplay) {
                headerDisplay.innerText = hospitalName;
                headerDisplay.classList.remove('text-red-600', 'animate-pulse');
                headerDisplay.classList.add('text-gray-800');
            }

            // Fecha Modal
            if(typeof closeLocationModal === 'function') {
                closeLocationModal();
            } else {
                 document.getElementById('locationModal').classList.add('hidden');
            }
            
            // TRADU√á√ÉO: Sucesso
            showModal(t['modalSuccessTitle'] || 'Sucesso', t['msgLocationUpdated'] || "‚úÖ Localiza√ß√£o atualizada!");
            
        } else {
            // TRADU√á√ÉO: Erro do servidor
            let msg = t['msgServerRefused'] || "‚ö†Ô∏è O servidor recusou: ";
            msg += (response.message || response.error);
            showModal(t['modalErrorTitle'] || 'Falha', msg);
        }
    } catch (error) {
        console.error(error);
        // TRADU√á√ÉO: Erro de conex√£o
        showModal(t['modalErrorTitle'] || 'Falha', t['msgConnectionError'] || "‚ùå Erro de conex√£o.");
    } finally {
        if (btn) {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }
}

// Auxiliar: Preenche campos vindo do banco
function fillModalFields(data, isHospital) {
    // Preenche o nome do local (Se vazio, sugere 'Casa de Paciente' para resid√™ncia)
    const nameInput = document.getElementById('hospitalNameInput');
    nameInput.value = data.hospital_name || (isHospital ? '' : 'Casa de Paciente');

    // Frequ√™ncia de limpeza
    document.getElementById('loc_freq_limpeza').value = data.cleaning_frequency || 7;
    
    if (isHospital) {
        // Preenche dados hospitalares se estiver no modo hospital
        document.getElementById('hospitalSector').value = data.sector || '';
        document.getElementById('hospitalFloor').value = data.floor || '';
        document.getElementById('hospitalBed').value = data.bed || '';
        document.getElementById('admissionDate').value = data.admission_date || '';
    } else {
        // Limpa campos hospitalares se estiver no modo resid√™ncia (visual apenas)
        document.getElementById('hospitalSector').value = '';
        document.getElementById('hospitalFloor').value = '';
        document.getElementById('hospitalBed').value = '';
        document.getElementById('admissionDate').value = '';
    }

    // Recalcula dias de interna√ß√£o/estadia
    if (typeof calculateLocationDays === 'function') {
        calculateLocationDays();
    }
}

// Auxiliar: Dist√¢ncia entre coordenadas (Haversine)
function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
    var R = 6371; // Raio da terra em km
    var dLat = deg2rad(lat2-lat1);
    var dLon = deg2rad(lon2-lon1); 
    var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
    return R * c;
}
function deg2rad(deg) { return deg * (Math.PI/180) }

// 1. Defini√ß√£o Estruturada (Usando CHAVES de tradu√ß√£o, n√£o textos fixos)
const checklistTMOData = [
    {
        categoryKey: "tmoCatPrep",
        items: [
            "tmoItemHands",
            "tmoItemPPE",
            "tmoItemSupplies",
            "tmoItemMaterials",
            "tmoItemTrash",
            "tmoItemLinens"
        ]
    },
    {
        categoryKey: "tmoCatSurface",
        items: [
            "tmoItemPaint",
            "tmoItemCeiling",
            "tmoItemWalls",
            "tmoItemCobwebs"
        ]
    },
    {
        categoryKey: "tmoCatLightVent",
        items: [
            "tmoItemLights",
            "tmoItemACGrills",
            "tmoItemHEPACheck",
            "tmoItemSwitches",
            "tmoItemWindows",
            "tmoItemServiceLight"
        ]
    },
    {
        categoryKey: "tmoCatFurniture",
        items: [
            "tmoItemBed",
            "tmoItemBedTable",
            "tmoItemMealTable",
            "tmoItemChair",
            "tmoItemPumps",
            "tmoItemCables",
            "tmoItemRemote"
        ]
    },
    {
        categoryKey: "tmoCatBath",
        items: [
            "tmoItemToilet",
            "tmoItemSink",
            "tmoItemShower",
            "tmoItemBathTrash",
            "tmoItemDrains",
            "tmoItemSupports",
            "tmoItemFilters",
            "tmoItemBathWindows"
        ]
    },
    {
        categoryKey: "tmoCatFloor",
        items: [
            "tmoItemSweep",
            "tmoItemMop",
            "tmoItemMotion",
            "tmoItemCorners"
        ]
    },
    {
        categoryKey: "tmoCatFinal",
        items: [
            "tmoItemOdors",
            "tmoItemRefill",
            "tmoItemCleanLinens",
            "tmoItemFinalHEPA",
            "tmoItemDust",
            "tmoItemSign",
            "tmoItemDispenser",
            "tmoItemTemp",
            "tmoItemFridge"
        ]
    }
];

// 2. Fun√ß√£o para Abrir e Renderizar o Modal (Com Tradu√ß√£o)
function openChecklistTMO() {
    const container = document.getElementById('tmoChecklistContent');
    // Obt√©m o dicion√°rio atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    container.innerHTML = ''; // Limpa anterior
    
    let sectionIndex = 0;

    // Itera sobre o Array de Categorias
    checklistTMOData.forEach((section) => {
        const sectionDiv = document.createElement('div');
        sectionDiv.className = "bg-white p-4 rounded shadow-sm border border-gray-200";
        
        // T√≠tulo da Se√ß√£o (Traduzido)
        const title = document.createElement('h4');
        title.className = "font-bold text-blue-800 border-b pb-2 mb-3 uppercase text-sm tracking-wide";
        title.textContent = t[section.categoryKey] || section.categoryKey; // Fallback se falhar
        sectionDiv.appendChild(title);

        // Lista de Itens
        const ul = document.createElement('ul');
        ul.className = "space-y-2";
        
        section.items.forEach((itemKey, index) => {
            const uniqueID = `chk_${sectionIndex}_${index}`;
            const li = document.createElement('li');
            li.className = "flex items-start gap-3 hover:bg-blue-50 p-1 rounded transition";
            
            // Texto do Item (Traduzido)
            const itemText = t[itemKey] || itemKey;

            li.innerHTML = `
                <div class="flex items-center h-5">
                    <input id="${uniqueID}" name="tmo_item" type="checkbox" 
                           class="focus:ring-blue-500 h-5 w-5 text-blue-600 border-gray-300 rounded cursor-pointer"
                           onchange="updateProgress()">
                </div>
                <div class="ml-1 text-sm">
                    <label for="${uniqueID}" class="font-medium text-gray-700 cursor-pointer select-none">
                        ${itemText}
                    </label>
                </div>
            `;
            ul.appendChild(li);
        });

        sectionDiv.appendChild(ul);
        container.appendChild(sectionDiv);
        sectionIndex++;
    });

    document.getElementById('tmoChecklistModal').classList.remove('hidden');
    // Reseta progresso visualmente
    if(typeof updateProgress === 'function') updateProgress();
}

// 3. Fun√ß√£o para fechar o modal
function closeTmoModal() {
    document.getElementById('tmoChecklistModal').classList.add('hidden');
}

// 4. Barra de Progresso
function updateProgress() {
    const total = document.querySelectorAll('input[name="tmo_item"]').length;
    const checked = document.querySelectorAll('input[name="tmo_item"]:checked').length;
    const pct = Math.round((checked / total) * 100);
    
    const progressEl = document.getElementById('checklistProgress');
    progressEl.textContent = `${pct}%`;
    
    if(pct === 100) progressEl.className = "font-bold text-green-600";
    else progressEl.className = "font-bold text-blue-600";
}

// 5. Salvar (Submit)
async function saveChecklistTMO() {
    // 1. Valida√ß√£o do ID da Localiza√ß√£o
    // A vari√°vel currentLocationId √© preenchida na fun√ß√£o openLocationModal
    if (!currentLocationId) {
        showModal('Erro', 'ID da localiza√ß√£o n√£o encontrado. Por favor, abra o modal de localiza√ß√£o novamente para carregar os dados.');
        return;
    }

    // 2. Identifica√ß√£o do Respons√°vel (Melhoria)
    let responsibleName = 'Cuidador N√£o Identificado';
    
    // Tenta pegar do estado global
    if (typeof state !== 'undefined' && state.userName) {
        responsibleName = state.userName;
    } 
    // Fallback: Tenta pegar do localStorage
    else {
        try {
            const storedUser = JSON.parse(localStorage.getItem('user_data'));
            if (storedUser && storedUser.name) responsibleName = storedUser.name;
            else if (storedUser && storedUser.email) responsibleName = storedUser.email;
        } catch(e) {}
    }

    // 3. Coleta dos dados do Checklist
    const checklistResult = {};
    document.querySelectorAll('input[name="tmo_item"]').forEach(input => {
        // Pega o texto do label associado ao checkbox
        // closest('li') garante que pegamos o label certo dentro da estrutura de lista
        const labelText = input.closest('li').querySelector('label').innerText;
        checklistResult[labelText] = input.checked; 
    });

    const total = document.querySelectorAll('input[name="tmo_item"]').length;
    const checked = document.querySelectorAll('input[name="tmo_item"]:checked').length;

    // 4. Confirma√ß√£o se incompleto (Seguran√ßa do Paciente)
    if (checked < total) {
        const proceed = await customConfirm(
            'Checklist Incompleto ‚ö†Ô∏è', 
            `Aten√ß√£o: Apenas ${checked} de ${total} itens foram marcados.\n\nPara seguran√ßa do paciente TMO, o ideal √© 100% de conformidade.\n\nDeseja registrar mesmo assim?`
        );
        if (!proceed) return;
    }

    // Feedback visual de carregamento
    const btnSalvar = document.querySelector('#tmoChecklistModal button[onclick="saveChecklistTMO()"]');
    const txtOriginal = btnSalvar ? btnSalvar.innerText : '';
    if(btnSalvar) {
        btnSalvar.innerText = "Salvando...";
        btnSalvar.disabled = true;
    }

    console.log('Enviando ID:', currentLocationId);

    try {
        const resp = await fetch('api.php?action=save-checklist', {
            method: 'POST',
            headers: {'Content-Type': 'application/json','X-Timezone': userTimezone},
            body: JSON.stringify({
                location_id: currentLocationId, // Fundamental para o UPDATE no SQL
                checklist_data: {
                    items: checklistResult,
                    summary: `${checked}/${total}`,
                    percentage: Math.round((checked / total) * 100),
                    timestamp: new Date().toISOString(),
                    user: responsibleName // Agora salva quem fez
                }
            })
        });

        const json = await resp.json();

        if (json.success) {
            showModal('Sucesso', '‚úÖ Limpeza Terminal registrada e hist√≥rico atualizado!');
            closeTmoModal();
            Atualiza_Agenda(state.patientId);
            
            // Atualiza o modal principal (LocationModal) para recalcular os dias
            // e mudar o bot√£o de "Vencido" para "Em dia" imediatamente
            await openLocationModal(); 
            
        } else {
            showModal('Erro', 'O servidor recusou o salvamento: ' + (json.message || json.error || 'Erro desconhecido'));
        }

    } catch (e) {
        console.error(e);
        showModal('Erro', 'Falha na comunica√ß√£o com o servidor.');
    } finally {
        if(btnSalvar) {
            btnSalvar.innerHTML = txtOriginal || 'Finalizar e Registrar'; // Restaura o bot√£o (pode conter √≠cone, por isso innerHTML)
            btnSalvar.disabled = false;
        }
    }
}


/**
 * Configura a navega√ß√£o por abas no MODAL DE CONFIGURA√á√ïES (isolado).
 * ‚ö†Ô∏è N√ÉO afeta as abas do Dashboard
 */
function setupTabs() {
    // ‚úÖ ESCOPO ISOLADO: Busca apenas dentro do modal de configura√ß√µes
    const modal = document.getElementById('settings-modal');
    if (!modal) {
        console.warn('setupTabs: Modal de configura√ß√µes n√£o encontrado');
        return;
    }
    
    // ‚úÖ Seletores espec√≠ficos do modal
    const tabButtons = modal.querySelectorAll('.settings-tab-button');
    const tabContents = modal.querySelectorAll('.settings-tab-content');
    
    if (tabButtons.length === 0 || tabContents.length === 0) {
        console.warn('setupTabs: Abas n√£o encontradas no modal');
        return;
    }
    
    /**
     * Fun√ß√£o para mostrar uma aba espec√≠fica
     */
    function showSettingsTab(tabId) {
        // Ocultar todos os conte√∫dos
        tabContents.forEach(content => {
            content.classList.remove('active-settings-tab');
        });
        
        // Desativar todos os bot√µes
        tabButtons.forEach(btn => {
            btn.classList.remove('active-settings-tab', 'border-blue-600');
        });
        
        // Ativar o conte√∫do selecionado
        const targetContent = modal.querySelector(`#settings-tab-${tabId}`);
        if (targetContent) {
            targetContent.classList.add('active-settings-tab');
        } else {
            console.error(`setupTabs: Conte√∫do "settings-tab-${tabId}" n√£o encontrado`);
        }
        
        // Ativar o bot√£o selecionado
        const targetButton = modal.querySelector(`.settings-tab-button[data-settings-tab="${tabId}"]`);
        if (targetButton) {
            targetButton.classList.add('active-settings-tab', 'border-blue-600');
        }
        
        console.log(`‚öôÔ∏è Aba de configura√ß√£o "${tabId}" ativada`);
    }
    
    // ‚úÖ Adicionar listeners APENAS aos bot√µes do modal
    tabButtons.forEach(button => {
        const tabId = button.getAttribute('data-settings-tab');
        if (tabId) {
            // Remover listeners antigos (se existirem)
            button.onclick = null;
            
            // Adicionar novo listener
            button.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                showSettingsTab(tabId);
            });
        }
    });
    
    // Mostrar a aba padr√£o (caregiver)
    showSettingsTab('caregiver');
    
    console.log('‚úÖ setupTabs: Abas do modal de configura√ß√µes inicializadas');
}
/**
 * Altera o tamanho da fonte (exemplo)
 */
function setFontSize(size) {
    document.body.style.fontSize = `${size}px`;
    showStatusMessage(`Tamanho da fonte alterado para: ${size}px.`);
    
    // Antes salvava no localStorage, agora apenas atualiza o estado se a mudan√ßa for externa
    // Esta fun√ß√£o ser√° chamada no saveCaregiverSettings() e no carregamento do login.
}

/**
 * Altera o idioma do app (apenas placeholder)
 */
function setAppLanguage(lang) {
    showStatusMessage(`Idioma alterado para: ${lang}. Requer recarregamento para textos.`);
    //localStorage.setItem('appLanguage', lang);

    // NOVO: Aplica a tradu√ß√£o imediatamente
    applyLanguage(lang);
}


/**
 * Define as unidades de medida (apenas placeholder).
 */
function setMeasurementUnits(newSystem) {
    // 1. Valida√ß√£o simples para evitar erros
    if (newSystem !== 'metric' && newSystem !== 'imperial') {
        console.error("Sistema de medidas inv√°lido:", newSystem);
        return;
    }

    // 2. Verifica se houve mudan√ßa real (evita rec√°lculos desnecess√°rios)
    const oldSystem = state.measurementSystem || 'metric';
    if (oldSystem === newSystem) return;

    // 3. Atualiza o Estado Global e LocalStorage
    state.measurementUnit = newSystem;
    localStorage.setItem('measurementSystem', newSystem);

    // 4. Aplica as mudan√ßas na interface (Labels, Sliders e Convers√£o de Valores)
    updateMeasurementUI(newSystem, oldSystem);

    // 5. Feedback ao usu√°rio (Traduzido)
    // Busca o nome do sistema na tradu√ß√£o (ex: "M√©trico" ou "Imperial")
    const systemName = LANG_STRINGS[state.currentLanguage || 'pt'][`system_${newSystem}`] || newSystem;
    const msgTemplate = LANG_STRINGS[state.currentLanguage || 'pt']['msgUnitsChanged'] || "Unidades alteradas para:";
    
    showStatusMessage(`${msgTemplate} ${systemName}`);
    
    console.log(`Sistema de medidas alterado de ${oldSystem} para ${newSystem}`);
}

// A fun√ß√£o updateMeasurementUI que √© chamada por setMeasurementUnits
function updateMeasurementUI(newSystem, oldSystem) {
    const config = MEASUREMENT_CONFIG[newSystem];

    // O loop percorre weight, height, circumference E AGORA temperature e monitorTemp
    Object.keys(config).forEach(type => {
        const settings = config[type];
        
        // A. Atualiza o Texto do Label (ex: muda "kg" para "lbs", "¬∞C" para "¬∞F")
        const labelEl = document.getElementById(settings.labelId);
        if (labelEl) labelEl.textContent = settings.unit;

        // B. Sincroniza todos os Seletores (se existirem)
        const selectEl = document.getElementById(settings.selectId);
        if (selectEl) {
            selectEl.value = newSystem;
        }

        // C. Atualiza apenas os limites t√©cnicos do Slider (se existir)
        const rangeEl = document.getElementById(settings.rangeId);
        if (rangeEl) {
            rangeEl.min = settings.min;
            rangeEl.max = settings.max;
            rangeEl.step = settings.step;
        }

        // D. Sincroniza Slider com Input (Sem convers√£o matem√°tica)
        const inputEl = document.getElementById(settings.inputId);
        if (inputEl && rangeEl) {
            // Se houver um valor digitado, ajusta a posi√ß√£o da bolinha do slider
            // para a nova escala, mantendo o n√∫mero que o usu√°rio digitou.
            if (inputEl.value) {
                rangeEl.value = inputEl.value;
            }
        }
    });
}

/**
 * Ativa/Desativa a coleta de dados ambientais (apenas placeholder).
 */
function toggleDataCollection(checked) {

    showStatusMessage(`Coleta de dados ambientais: ${checked ? 'Ativada' : 'Desativada'}`);
    // L√≥gica real: Salvar no DB a prefer√™ncia ou iniciar/parar hardware.
}



/**
 * Salva as configura√ß√µes do perfil do Cuidador no backend.
 */
async function saveCaregiverSettings() {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    const nickname = document.getElementById('settingsCaregiverNickname').value.trim();
    const relation = document.getElementById('settingsCaregiverRelation').value || '';
    
    // 1. Coleta das Configura√ß√µes do Sistema
    const appLanguage = document.getElementById('language-select').value;
    
    const alarmSound = document.getElementById('alarm-select').value;
    const measurementUnit = document.getElementById('units-select').value;
    const dataCollectionActive = document.getElementById('data-collection-toggle').checked;
    const appFontSize = document.getElementById('font-size-slider').value; 

    // Valida√ß√µes
    if (!state.userId) { 
        showModal(t['modalErrorTitle'] || 'Erro', t['msgUserNotAuth'] || 'Usu√°rio n√£o autenticado.'); 
        return; 
    }
    if (!nickname) { 
        showModal(t['modalErrorTitle'] || 'Erro', t['msgNicknameRequired'] || 'Apelido do cuidador √© obrigat√≥rio.'); 
        return; 
    }
    
    // Status de salvamento
    showStatusMessage(t['msgSavingSettings'] || 'Salvando configura√ß√µes...');
    
    const resp = await apiPost('save-caregiver-profile', { 
        userId: state.userId, 
        nickname, 
        relation,
        patientID: state.patientId,
        // 2. Envio das configura√ß√µes do sistema para a API
        appLanguage,
        alarmSound,
        measurementUnit,
        dataCollectionActive: dataCollectionActive ? 'true' : 'false',
        appFontSize 
    });

    if (resp.success) {
        // 3. Atualiza o estado da aplica√ß√£o com os novos valores
        state.nickname = nickname;
        state.relation = relation;
        
        state.appLanguage = appLanguage;
        state.alarmSound = alarmSound;
        state.measurementUnit = measurementUnit;
        state.dataCollectionActive = dataCollectionActive;
        state.appFontSize = appFontSize; 

        updateCaregiverUI(); 
        
        // Mensagem de sucesso
        showCelebrationMessage(t['msgSettingsSaved'] || '‚úÖ Configura√ß√µes salvas e aplicadas!');
        closeSettingsModal();
    } else {
        // Mensagem de erro
        showModal(
            t['modalErrorTitle'] || 'Erro', 
            resp.message || t['msgSettingsSaveFail'] || 'Falha ao salvar configura√ß√µes.'
        );
    }
}

/**
 * Salva as configura√ß√µes do Paciente no backend.
 */
async function savePatientSettings() {
    if (!state.patientId) { 
        showModal('Erro', 'Nenhum paciente selecionado.'); 
        return; 
    }
    
    const illness = document.getElementById('settingsPatientIllness').value.trim();
    const allergies = document.getElementById('settingsPatientAllergies').value.trim();

    const resp = await apiPost('update-patient-profile', {
        patientId: state.patientId,
        // N√£o permitimos editar o apelido do paciente ap√≥s a cria√ß√£o, apenas a doen√ßa e alergias
        illness,
        allergies
        // Adicionar l√≥gica de avatarUrl aqui
    });

    if (resp.success) {
        state.patient.illness = illness;
        state.patient.allergies = allergies;
        updatePatientUI(); // Atualiza a info do paciente na tela principal
        showCelebrationMessage('‚úÖ Perfil do(a) Paciente salvo!');
    } else {
        showModal('Erro', resp.message || 'Falha ao salvar perfil do paciente.');
    }
}

/**
 * Abre o modal de upload de avatar.
 */
function changeAvatar(type) {
    avatarTargetType = type; // 'caregiver' ou 'patient'
    document.getElementById('avatarUploadModal').classList.remove('hidden');
    document.getElementById('avatarFileInput').value = ''; // Limpa o input
    document.getElementById('uploadAvatarBtn').disabled = true;
    
    // Listener para habilitar o bot√£o de upload
    document.getElementById('avatarFileInput').onchange = function() {
        document.getElementById('uploadAvatarBtn').disabled = this.files.length === 0;
    };
}

function closeAvatarUploadModal() {
    document.getElementById('avatarUploadModal').classList.add('hidden');
}

/**
 * Envia o arquivo de imagem para o backend.
 */
async function uploadAvatar() {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    const fileInput = document.getElementById('avatarFileInput');
    const file = fileInput.files[0];
    
    if (!file) {
        // TRADU√á√ÉO: Arquivo n√£o selecionado
        showModal(t['modalErrorTitle'] || 'Erro', t['msgNoFileSelected'] || 'Nenhum arquivo selecionado.');
        return;
    }

    if (!state.userId) {
        showModal(t['modalErrorTitle'] || 'Erro', t['msgUserNotAuth'] || 'Usu√°rio n√£o autenticado.');
        return;
    }
    
    const base64Image = await new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result.split(',')[1]);
        reader.readAsDataURL(file);
    });

    closeAvatarUploadModal();
    // TRADU√á√ÉO: Status de salvamento
    showStatusMessage(t['msgSavingAvatar'] || 'Salvando novo avatar...');

    const payload = {
        userId: state.userId,
        targetType: avatarTargetType,
        image: base64Image,
        patientId: avatarTargetType === 'patient' ? state.patientId : null
    };

    const resp = await apiPost('upload-avatar', payload);
    
    if (resp.success) {
        const newUrl = resp.data.avatarUrl;
        
        if (avatarTargetType === 'caregiver') {
            // Sincronizar campos
            state.avatarUrl = newUrl;
            state.caregiver.avatarUrl = newUrl;
            
            const mainAvatar = document.getElementById('caregiverAvatar');
            const settingsAvatar = document.getElementById('settingsCaregiverAvatar');
            
            if (mainAvatar) mainAvatar.src = newUrl;
            if (settingsAvatar) settingsAvatar.src = newUrl;
            
        } else {
            state.patient.avatarUrl = newUrl;
            
            const mainAvatar = document.getElementById('patientAvatar');
            const settingsAvatar = document.getElementById('settingsPatientAvatar');
            
            if (mainAvatar) mainAvatar.src = newUrl;
            if (settingsAvatar) settingsAvatar.src = newUrl;
        }
        
        // TRADU√á√ÉO: Sucesso
        showCelebrationMessage(t['msgAvatarUpdated'] || '‚úÖ Avatar atualizado com sucesso!');
    } else {
        // TRADU√á√ÉO: Erro da API
        showModal(
            t['modalErrorTitle'] || 'Erro', 
            resp.message || t['msgAvatarUploadFail'] || 'Falha ao carregar avatar.'
        );
    }
}      
       
        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            initNotifications();            
            construirAgenda();
            setInterval(monitorarAlarmes, 5000);
            carregarSugestoes(); 
            carregarSugestoesUND();
            
            
            document.getElementById('btnCadastrarDrug').onclick = function() {
                document.getElementById('form-popup-drugs').classList.add('active'); // Usa o ID correto
                resetFormularioPrescricao();
                alternarCamposFormulario();
            };

                      
            // Listener de idioma
            // NOVO: 1. Carregar e Aplicar Idioma Salvo
            const savedLanguage = localStorage.getItem('appLanguage') || 'pt'; // 'pt' como padr√£o
            // Garante que o <select> comece com o valor correto
            document.getElementById('language-select').value = savedLanguage; 
            applyLanguage(savedLanguage); // Aplica o idioma salvo ou padr√£o

            // Listener de fechamento do modal de prescri√ß√£o (corrigido)
            document.getElementById('close-form-btn-Drug').onclick = closeFormDrugs;

            document.getElementById('via_administracao').onchange = alternarCamposFormulario;
            document.getElementById('volume_diluicao_liquido').onchange = alternarCamposFormulario;

            

            document.getElementById('formPrescricao').onsubmit = function(event) {
                event.preventDefault();
                saveDrugs(); // Chama a fun√ß√£o de salvamento
                this.reset();
            };
            
            // Listener para o bot√£o 'Ignorar S√ì AGORA'
            document.getElementById('btnIgnorarDose').onclick = function(e) {
              e.preventDefault();
              e.stopPropagation();

             if (doseEmAcaoId === null) return;
        
            const observacao = document.getElementById('motivoObservacao').value;

            processarDoseComObservacao(doseEmAcaoId, "Ignorada", observacao);
        
            console.log(`Dose ID ${doseEmAcaoId} ignorada. Observa√ß√£o: ${observacao}. (Backend:ok)`);
            showModal('Dose ignorada para o hor√°rio atual.');
        
            
    };

            // Listener para o bot√£o 'Suspender Uso'
            document.getElementById('btnSuspenderReceita').onclick = async function(e) {

            e.preventDefault();
            e.stopPropagation();

            if (doseEmAcaoId === null) return;

            const confirmed = await customConfirm('ATEN√á√ÉO:'," Voc√™ tem certeza que deseja SUSPENDER o uso desta receita? Todas as doses futuras ser√£o canceladas.");

            if (confirmed) {
              const observacao = document.getElementById('motivoObservacao').value;

              processarDoseComObservacao(doseEmAcaoId, "Suspensa", observacao);
            
              console.log(`Dose ID ${doseEmAcaoId} e Prescri√ß√£o Suspensa. Observa√ß√£o: ${observacao}. (Backend:ok)`);
              showModal('Uso da medica√ß√£o suspenso. üë®üèª‚Äç‚öïÔ∏è');

        }
    };
       
           //agenda de consultas e exames
           // Listener do formul√°rio de novo agendamento (dentro do DOMContentLoaded)

                // Sincroniza estado premium
                state.isPremium = localStorage.getItem('isPremium') === 'true';
                
                // Listener espec√≠fico para bot√µes timeline ANTES do global
                document.getElementById('btn-new-appointment-timeline')?.addEventListener('click', function(e) {
                    e.stopPropagation();
                    openTimelineNewModal(e);
                });
    

          });

// Fun√ß√£o para criar agendamento (executada pelo bot√£o)
async function createAppointment() {
    // Prevenir m√∫ltiplos cliques
    const btn = document.getElementById('appointment_create');
    if (btn.disabled) return;
    btn.disabled = true;
    
    try {
        // Obter o formul√°rio
        const form = document.getElementById('timeline-new-appointment-form');
        if (!form) {
            showStatusMessage('Formul√°rio n√£o encontrado.');
            return;
        }
        
        // Criar FormData a partir do formul√°rio
        const formData = new FormData(form);
        
        // Montar o payload
        const payload = {
            // üîë MUDAN√áA CR√çTICA: Usar state.patientId
            paciente_id: state.patientId, 
            data_consulta: formData.get('data_consulta'),
            hora_consulta: formData.get('hora_consulta'),
            tipo: formData.get('tipo'),
            descricao: formData.get('descricao'),
            local: formData.get('local'),
            profissional_contato: formData.get('profissional_contato'),
            telefone_clinica: formData.get('telefone_clinica') || null,
            instrucoes_preparo: formData.get('instrucoes_preparo') || null,
            jejum: formData.get('jejum') || null,
            status_pagador: formData.get('status_pagador')
        };
        
        // Fazer a requisi√ß√£o
        const resp = await apiPost('save-appointment', payload);

        if (resp.success) {
            showCelebrationMessage('‚úÖ Agendamento criado com sucesso!');
            closeTimelineNewModal();
            renderTimeline(); // Recarregar a timeline
        } else {
            showStatusMessage('Falha ao criar agendamento: ' + (resp.message || 'Erro desconhecido.'));
        }
        
    } catch (error) {
        console.error('Erro ao criar agendamento:', error);
        showStatusMessage('Erro ao criar agendamento. Tente novamente.');
    } finally {
        // Reabilitar o bot√£o
        btn.disabled = false;
    }
}

// Vincular a fun√ß√£o ao bot√£o
document.getElementById('appointment_create')?.addEventListener('click', createAppointment);

/* ========================================
   FUN√á√ïES DA TIMELINE DE AGENDAMENTOS
======================================== */

let timelineGroupedAppointments = {}; // Vari√°vel para armazenar a agenda agrupada

const timeline = document.getElementById('timeline');
const timelineLoading = document.getElementById('timeline-loading');
const timelineDetailModal = document.getElementById('timeline-detail-modal');
const timelineCardContainer = document.getElementById('timeline-card-container');

/**
 * Calcula dias restantes (ou passados) at√© uma data.
 * @param {string} dateString Data no formato YYYY-MM-DD
 */
function daysUntilTimeline(dateString) {
    const today = normalizeDate(new Date());
    const targetDate = normalizeDate(new Date(dateString + 'T00:00:00'));
    const diffTime = targetDate.getTime() - today.getTime();
    const oneDay = 1000 * 60 * 60 * 24;
    return Math.round(diffTime / oneDay);
}

/**
 * Normaliza uma data para o in√≠cio do dia (00:00:00)
 */
function normalizeDate(date) {
    const normalized = new Date(date);
    normalized.setHours(0, 0, 0, 0);
    return normalized;
}

/**
 * Formata data para exibi√ß√£o curta (Dia/M√™s)
 */
function formatTimelineDate(date) {
    const d = new Date(date + 'T00:00:00');
    return d.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
}

/**
 * Retorna a cor do status para o badge
 */
function getAppStatusColor(status) {
    switch (status) {
        case 'Agendado':
        case 'Em aprova√ß√£o':
            return '#2563eb';
        case 'Realizado com Sucesso':
            return '#10b981';
        case 'N√£o Realizado':
        case 'Cancelado':
        case 'Recusado':
            return '#ef4444';
        default:
            return '#64748b';
    }
}

/**
 * Renderiza a Timeline com agendamentos (Consultas/Exames/Procedimentos)
 */
async function renderTimeline() {
    // Verifica se os elementos DOM da timeline existem antes de tentar renderizar
    if (!timeline || !timelineLoading) return;
    
    timeline.innerHTML = '';
    timelineLoading.style.display = 'block';
   
    if (!state.patientId) {
        timelineLoading.style.display = 'none';
        timeline.innerHTML = '<p class="loading">Selecione um paciente para ver a agenda.</p>';
        return;
    }
    
    const response = await apiGet('get-appointments', { paciente_id: state.patientId });
    timelineLoading.style.display = 'none';

    if (!response.success || response.data.length === 0) {
        timeline.innerHTML = '<p class="loading">Nenhum agendamento encontrado nos pr√≥ximos 90 dias.</p>';
        return;
    }

    const appointments = response.data.map(app => ({
        ...app,
        dateKey: app.data_consulta
    }));

    // Agrupa agendamentos por data
    timelineGroupedAppointments = appointments.reduce((acc, app) => {
        const dateKey = app.dateKey;
        if (!acc[dateKey]) acc[dateKey] = [];
        acc[dateKey].push(app);
        return acc;
    }, {});

    const todayNormalized = normalizeDate(new Date()); 
    const totalDays = 90; 
    const timelineWidth = 1000;
    //const timelineCalculatedWidth = 100; // Representa 100% do elemento pai

    // Calcula o valor m√°ximo de compress√£o para normaliza√ß√£o (raiz de 90)
    const compressionFactor = Math.sqrt(totalDays); // Raiz quadrada de 90 ‚âà 9.48

    Object.keys(timelineGroupedAppointments).forEach(dateKey => {
        const dayAppointments = timelineGroupedAppointments[dateKey];
        const appointmentCount = dayAppointments.length;
        const appDate = normalizeDate(new Date(dateKey + 'T00:00:00')); 
        const diffTime = appDate.getTime() - todayNormalized.getTime();
        const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24)); 
        
        if (diffDays >= 0 && diffDays <= totalDays) {
            
            const compressedDays = Math.sqrt(diffDays);
            
            const positionPercent = (compressedDays / compressionFactor) * 100;
            
            const wrapper = document.createElement('div');
            wrapper.classList.add('timeline-item-wrapper');
            // Calcula a posi√ß√£o do ponto na barra
            wrapper.style.left = `${positionPercent}%`;

            const point = document.createElement('div');
            point.classList.add('timeline-point');
            
            const firstAppStatus = dayAppointments[0].status;
            let titleText = `${appointmentCount} agendamento(s) em ${formatTimelineDate(dateKey)}`;
            
            if (appointmentCount > 1) {
                point.classList.add('multiple');
            } else if (firstAppStatus === 'Realizado com Sucesso') {
                point.classList.add('success');
            } else if (['Cancelado', 'N√£o Realizado', 'Recusado'].includes(firstAppStatus)) {
                point.classList.add('cancelled');
            }
            
            point.title = titleText;
            // üîë MUDAN√áA CR√çTICA: Chama a nova fun√ß√£o de modal
            point.onclick = () => openTimelineDetailModal(dayAppointments, dateKey);

            const countElement = document.createElement('span');
            countElement.classList.add('appointment-count');
            countElement.textContent = appointmentCount > 1 ? `${appointmentCount} ag.` : '';
            
            wrapper.appendChild(point);
            wrapper.appendChild(countElement);
            timeline.appendChild(wrapper);
        }
    });
}

function generateAppointmentCard(app) {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    const statusColor = getAppStatusColor(app.status);
    const typeIcon = app.tipo === 'Exame' ? 'üî¨' : app.tipo === 'Consulta' ? 'üë®‚Äç‚öïÔ∏è' : 'üè•';
    
    // Formata√ß√£o de data/hora (sem altera√ß√µes l√≥gicas)
    const currentDateTime = `${app.data_consulta}T${app.hora_consulta.substring(0,5)}`;

    const safeDesc = escapeHtml(app.descricao || '');
    const safeLocal = escapeHtml(app.local || '');
    const safeProf = escapeHtml(app.profissional_contato || '');
    const safeTipo = escapeHtml(app.tipo || '');
    
    // TRADU√á√ÉO: Labels e Textos Fixos
    const lblDesc = t['lblDescription'] || 'Descri√ß√£o:';
    const lblPlace = t['lblPlace'] || 'Local:';
    const lblProf = t['lblProfessional'] || 'Profissional:';
    const lblPhone = t['lblPhone'] || 'Telefone:';
    const lblFasting = t['lblFasting'] || 'Jejum:';
    const lblHours = t['lblHours'] || 'horas';
    const lblNotNeeded = t['lblNotNeeded'] || 'N√£o necess√°rio';
    const lblInstructions = t['lblInstructions'] || 'Instru√ß√µes:';
    const lblStatus = t['lblStatus'] || 'Status:';
    
    const btnNotDone = t['btnNotDone'] || '‚ö†Ô∏è N√£o Realizado';
    const btnCancel = t['btnCancel'] || '‚ùå Cancelar';
    const btnReschedule = t['btnReschedule'] || 'üìÖ Reagendar';
    const btnDone = t['btnDone'] || '‚úÖ Realizado';
    
    const lblNewDate = t['lblNewDate'] || 'Nova Data e Hora (Reagendamento):';
    const btnRequestReschedule = t['btnRequestReschedule'] || 'Solicitar Reagendamento';
    
    const titleFinishReturn = t['titleFinishReturn'] || 'Finalizar e Agendar Retorno';
    const lblReturnDate = t['lblReturnDate'] || 'Data/Hora do Retorno (Deixe vazio para finalizar sem retorno):';
    const lblPayerSource = t['lblPayerSource'] || 'Selecione a fonte do pagamento do retorno:';
    
    const optPublic = t['optPublic'] || 'P√∫blico';
    const optInsurance = t['optInsurance'] || 'Plano';
    const optPrivate = t['optPrivate'] || 'Particular';
    
    const btnConfirmCompletion = t['btnConfirmCompletion'] || 'Confirmar Conclus√£o';
    const btnCancelText = t['btnCancelText'] || 'Cancelar'; // Bot√£o cinza de fechar √°rea

    return `
        <div id="app-card-${app.agendamento_id}" class="timeline-appointment-card">
            <h4 style="color: ${statusColor};">${typeIcon} ${app.tipo} √†s ${app.hora_consulta}</h4>
            <p><strong>${lblDesc}</strong> ${safeDesc}</p>
            <p><strong>${lblPlace}</strong> ${safeLocal}</p>
            <p><strong>${lblProf}</strong> ${safeProf}</p>
            ${app.telefone_clinica ? `<p><strong>${lblPhone}</strong> ${escapeHtml(app.telefone_clinica)}</p>` : ''}
            <p><strong>${lblFasting}</strong> ${app.jejum > 0 ? app.jejum + ' ' + lblHours : lblNotNeeded}</p>
            ${app.instrucoes_preparo ? `<p><strong>${lblInstructions}</strong> ${escapeHtml(app.instrucoes_preparo)}</p>` : ''}
            
            <p style="font-weight: 600; margin-top: 12px;">
                ${lblStatus} <span id="status-span-${app.agendamento_id}" class="status-badge" style="background-color: ${statusColor};">${app.status}</span>
            </p>
            
            <div class="card-actions">                           
                <button class="btn-app-action failure" onclick="updateAppointmentStatus(${app.agendamento_id}, 'N√£o Realizado')">${btnNotDone}</button>
                <button class="btn-app-action cancel" onclick="updateAppointmentStatus(${app.agendamento_id}, 'Cancelado')">${btnCancel}</button>
                <button class="btn-app-action" style="background-color: #f59e0b;" onclick="toggleReschedule(${app.agendamento_id})">${btnReschedule}</button>
                 <button class="btn-app-action success" onclick="toggleReturn(${app.agendamento_id})">${btnDone}</button>
            </div>

            <div id="reschedule-area-${app.agendamento_id}" class="hidden mt-4 p-3 bg-gray-50 border rounded-lg transition-all">
                <label class="block text-sm font-bold text-gray-700 mb-2">${lblNewDate}</label>
                <input type="datetime-local" id="new-date-${app.agendamento_id}" value="${currentDateTime}" class="w-full p-2 border rounded mb-3">
                <button class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded hover:bg-blue-700" onclick="confirmReschedule(${app.agendamento_id})">
                    ${btnRequestReschedule}
                </button>
            </div>

            <div id="return-area-${app.agendamento_id}" class="hidden mt-4 p-3 bg-green-50 border border-green-200 rounded-lg transition-all">
                <p class="text-sm text-green-800 font-semibold mb-2">${titleFinishReturn}</p>
                
                <label class="block text-xs text-gray-600 mb-1">${lblReturnDate}</label>
                <input type="datetime-local" id="return-date-${app.agendamento_id}" class="w-full p-2 border rounded mb-3 focus:ring-2 focus:ring-green-500 outline-none">

                <label class="block text-xs text-gray-600 mb-1">${lblPayerSource}</label>
                <select id="retorno-status-pagador-${app.agendamento_id}"
                    class="w-full p-2 border border-gray-300 rounded-md bg-white focus:ring-red-500 focus:border-red-500" required>                    
                    <option value="P√∫blico" selected>${optPublic}</option>
                    <option value="Plano">${optInsurance}</option>
                    <option value="Particular">${optPrivate}</option>
                </select><br><br>
                
                <input type="hidden" id="retorno-tipo-${app.agendamento_id}" value="${safeTipo}">
                <input type="hidden" id="retorno-desc-${app.agendamento_id}" value="${safeDesc}">
                <input type="hidden" id="retorno-local-${app.agendamento_id}" value="${safeLocal}">
                <input type="hidden" id="retorno-prof-${app.agendamento_id}" value="${safeProf}">
                <input type="hidden" id="retorno-tel-${app.agendamento_id}" value="${escapeHtml(app.telefone_clinica || '')}">
                <input type="hidden" id="retorno-instr-${app.agendamento_id}" value="${escapeHtml(app.instrucoes_preparo || '')}">
                <input type="hidden" id="retorno-jejum-${app.agendamento_id}" value="${app.jejum || 0}">

                <div class="flex gap-2">
                    <button class="flex-1 bg-green-600 text-white font-bold py-2 px-4 rounded hover:bg-green-700 text-sm" 
                            onclick="confirmCompletionWithReturn(${app.agendamento_id})">
                        ${btnConfirmCompletion}
                    </button>
                    <button class="bg-gray-300 text-gray-700 font-bold py-2 px-3 rounded hover:bg-gray-400 text-sm" 
                            onclick="toggleReturn(${app.agendamento_id})">
                        ${btnCancelText}
                    </button>
                </div>
            </div>
        </div>
    `;
}

/**
 * Fun√ß√£o para exibir/ocultar o campo de data (Adicionar ao seu JS)
 */
function toggleReschedule(id) {
    const area = document.getElementById(`reschedule-area-${id}`);
    if (area.classList.contains('hidden')) {
        area.classList.remove('hidden');
    } else {
        area.classList.add('hidden');
    }
}

/**
 * Fun√ß√£o para enviar a solicita√ß√£o ao Backend (Adicionar ao seu JS)
 */
async function confirmReschedule(id) {
    const inputDate = document.getElementById(`new-date-${id}`).value;
    
    // Valida√ß√£o: Substitui alert por showModal
    if (!inputDate) {
        showModal('Aten√ß√£o', 'Por favor, selecione uma nova data e hora antes de solicitar.');
        return;
    }

    // Confirma√ß√£o: Substitui confirm() por customConfirm()
    // O 'await' faz o c√≥digo pausar aqui at√© o usu√°rio clicar no modal
    const aceitou = await customConfirm(
        'Confirmar Reagendamento', 
        "O status do agendamento voltar√° para 'Em aprova√ß√£o' e a data ser√° alterada. Deseja continuar?"
    );

    // Se o usu√°rio clicou em Cancelar (false), paramos aqui.
    if (!aceitou) {
        return; 
    }

    // UI: Feedback visual no bot√£o enquanto processa
    const btnAction = document.querySelector(`#reschedule-area-${id} button`);
    const textoOriginal = btnAction.innerText;
    btnAction.innerText = "Enviando...";
    btnAction.disabled = true;

    try {
        const resp = await apiPost('reschedule-appointment', { 
            agendamento_id: id, 
            new_datetime: inputDate 
        });

        if (resp.success) {
            // Sucesso: Usa showModal e recarrega a lista
            showModal('Sucesso', 'Reagendamento solicitado com sucesso!');
            
            // Oculta a √°rea de edi√ß√£o imediatamente para feedback visual r√°pido
            document.getElementById(`reschedule-area-${id}`).classList.add('hidden');
            
            renderTimeline(); 
        } else {
            // Erro vindo da API
            showModal('Erro', resp.message || 'Falha ao reagendar.');
        }
    } catch (e) {
        console.error(e);
        showModal('Erro de Conex√£o', 'N√£o foi poss√≠vel contatar o servidor.');
    } finally {
        // Restaura o bot√£o para o estado original
        btnAction.innerText = textoOriginal;
        btnAction.disabled = false;
    }
}



/**
 * Abre modal com detalhes dos agendamentos do dia.
 */

 function openTimelineDetailModal(appointments, dateKey) {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    // 2. Define o locale de data
    const localeMap = { 'pt': 'pt-BR', 'en': 'en-US', 'es': 'es-ES' };
    const dateLocale = (typeof currentLang !== 'undefined' && localeMap[currentLang]) ? localeMap[currentLang] : 'pt-BR';

    // Ordena√ß√£o
    appointments.sort((a, b) => (a.hora_consulta > b.hora_consulta) ? 1 : -1);

    const modalTitle = document.getElementById('timeline-modal-title');
    const days = daysUntilTimeline(dateKey);
    let daysWarning = '';
    
    // Tradu√ß√£o de Tempo Relativo
    if (days === 0) {
        daysWarning = t['timeToday'] || " (hoje)";
    } else if (days === 1) {
        daysWarning = t['timeTomorrow'] || " (amanh√£)";
    } else if (days > 1) {
        const template = t['timeInDays'] || " (daqui a {days} dias)";
        daysWarning = template.replace('{days}', days);
    }
    
    // T√≠tulo Traduzido
    const titlePrefix = t['titleAppointmentsFor'] || 'Agendamentos para';
    const formattedDate = new Date(dateKey + 'T00:00:00').toLocaleDateString(dateLocale);
    
    modalTitle.textContent = `${titlePrefix} ${formattedDate}${daysWarning}`;
    
    // Inserir cards
    const container = document.getElementById('timeline-card-container');
    if (container) {
        container.innerHTML = appointments.map(generateAppointmentCard).join('');
    }
    
    // --- RESTAURA√á√ÉO: Uso direto da vari√°vel global ---
    // Removemos o 'document.getElementById' e usamos a vari√°vel como no original
    if (typeof timelineDetailModal !== 'undefined') {
        timelineDetailModal.classList.add('active');
    } else {
        console.error("Erro: Vari√°vel global 'timelineDetailModal' n√£o encontrada.");
    }
    
    // Ativa√ß√£o do Overlay (Geralmente necess√°rio para fechar o modal ao clicar fora)
    const overlay = document.querySelector('.popup-overlay:not(#modal-premium-hope):not(#modal-delete-account)');
    if (overlay) {
        overlay.classList.add('active');
    }
}

/**
 * Fecha modal de detalhes
 */
function closeTimelineDetailModal() {
    if (timelineDetailModal) timelineDetailModal.classList.remove('active');
    document.querySelector('.popup-overlay')?.classList.remove('active');
}

/**
 * Abre modal de novo agendamento
 */
function openTimelineNewModal() {

    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
   
    document.getElementById('timeline-data').valueAsDate = new Date();
    document.getElementById('timeline-new-appointment-modal').classList.add('active');
    // Adiciona o overlay (o CSS no index.html j√° tem a classe 'popup-overlay' mas n√£o a fun√ß√£o)
    const overlay = document.querySelector('.popup-overlay:not(#modal-premium-hope):not(#modal-delete-account)');
    if (overlay) overlay.classList.add('active');    
}

/**
 * Fecha modal de novo agendamento
 */
function closeTimelineNewModal() {
    document.getElementById('timeline-new-appointment-modal').classList.remove('active');
    document.getElementById('timeline-new-appointment-form').reset();
    const overlay = document.querySelector('.popup-overlay:not(#modal-premium-hope):not(#modal-delete-account)');
    if (overlay) overlay.classList.remove('active');
}

async function updateAppointmentStatus(agendamentoId, newStatus) {
    // Adicione o await antes do customConfirm para aguardar a decis√£o do jogador
    const confirmed = await customConfirm(
        'Alterar?', 
        `Tem certeza que deseja mudar o status para "${newStatus}"?`,
        'Confirmar', // Texto do bot√£o de confirma√ß√£o
        'bg-blue-600' // Cor do bot√£o (exemplo seguindo o padr√£o do seu sistema)
    );

    if (confirmed) {
        const response = await apiPost('update-appointment-status', {
            agendamento_id: agendamentoId,
            status: newStatus
        });

        if (response.success) {
            showCelebrationMessage('Status atualizado com sucesso!');
            console.log('Status atualizado com sucesso');
            const statusSpan = document.getElementById(`status-span-${agendamentoId}`);
            if (statusSpan) {
                statusSpan.textContent = newStatus;
                statusSpan.style.backgroundColor = getAppStatusColor(newStatus);
            }
            renderTimeline(); // Recarregar a timeline
        } else {
            showStatusMessage('Falha ao atualizar status: ' + (response.message || 'Erro desconhecido.'));
            console.log('Falha ao atualizar status'+ (response.message || 'Erro desconhecido.'));
        }
    }
}

// Fun√ß√£o para exibir/ocultar a √°rea de retorno
function toggleReturn(id) {
    const area = document.getElementById(`return-area-${id}`);
    const reschedArea = document.getElementById(`reschedule-area-${id}`);
    
    // Fecha a √°rea de reagendamento se estiver aberta, para n√£o poluir a tela
    if (reschedArea && !reschedArea.classList.contains('hidden')) {
        reschedArea.classList.add('hidden');
    }

    if (area.classList.contains('hidden')) {
        area.classList.remove('hidden');
    } else {
        area.classList.add('hidden');
    }
}

// L√≥gica principal: Realiza o atual e cria o novo se houver data
async function confirmCompletionWithReturn(id) {
    const dateInput = document.getElementById(`return-date-${id}`);
    const dataRetornoFull = dateInput.value; // Formato esperado: "YYYY-MM-DDTHH:MM"

    // 1. Cen√°rio: Usu√°rio N√ÉO preencheu data (Apenas finalizar)
    if (!dataRetornoFull) {
        // Nota: Se o customConfirm for ass√≠ncrono, deve-se usar await, mas para o confirm nativo ou s√≠ncrono mantemos assim.
        // Assumindo que aqui voc√™ usaria um confirm simples ou await customConfirm se for modal.
        const confirmNoReturn = customConfirm("Aten√ß√£o","Voc√™ n√£o inseriu uma data de retorno.\nDeseja apenas finalizar este atendimento como 'Realizado' sem criar um novo agendamento?");
        
        if (confirmNoReturn) {
            await updateAppointmentStatus(id, 'Realizado com Sucesso');
            toggleReturn(id); 
        }
        return;
    }

    // 2. Cen√°rio: Usu√°rio preencheu data (Finalizar + Criar Novo)
    const dataObj = new Date(dataRetornoFull);
    
    // ATEN√á√ÉO: Adicionado 'await' aqui, pois customConfirm geralmente √© ass√≠ncrono (modal)
    const confirmReturn = await customConfirm(
        "Importante",
        "Deseja finalizar o atendimento atual e agendar o retorno para " + dataObj.toLocaleString() + "?"
    );
    
    if (!confirmReturn) return;

    // Coleta dados dos campos ocultos HTML
    const tipo = document.getElementById(`retorno-tipo-${id}`).value;
    const descricaoOriginal = document.getElementById(`retorno-desc-${id}`).value;
    const local = document.getElementById(`retorno-local-${id}`).value;
    const profissional = document.getElementById(`retorno-prof-${id}`).value;
    const telefone = document.getElementById(`retorno-tel-${id}`).value;
    const instrucoes = document.getElementById(`retorno-instr-${id}`).value;
    const jejum = document.getElementById(`retorno-jejum-${id}`).value;

    // --- NOVA CAPTURA: Status Pagador ---
    const statusPagadorElement = document.getElementById(`retorno-status-pagador-${id}`);
    const statusPagador = statusPagadorElement ? statusPagadorElement.value : 'P√∫blico'; // Default seguro

    // Separa Data e Hora para a API
    const partesData = dataRetornoFull.split('T');
    const dataConsulta = partesData[0]; 
    const horaConsulta = partesData[1] + ":00"; 

    try {
        // PASSO A: Finaliza o atual
        await updateAppointmentStatus(id, 'Realizado com Sucesso');

        // PASSO B: Cria o novo card
        const payload = {
            action: 'save-appointment',
            paciente_id: (typeof state !== 'undefined' && state.patientId) ? state.patientId : null,
            tipo: tipo,
            titulo: tipo, 
            descricao: "Retorno: " + descricaoOriginal, 
            local: local,
            
            // Campos de Data separados
            data_consulta: dataConsulta,
            hora_consulta: horaConsulta,
            
            // Novos campos solicitados
            profissional_contato: profissional,
            telefone_clinica: telefone,
            instrucoes_preparo: instrucoes,
            jejum: jejum,
            status_pagador: statusPagador, // <--- CAMPO ADICIONADO NO ENVIO
            
            status: 'Em aprova√ß√£o'
        };

        // Valida√ß√£o de seguran√ßa para ID do Paciente
        if (!payload.paciente_id) {
            const urlParams = new URLSearchParams(window.location.search);
            // Corre√ß√£o: Atribui ao campo correto 'paciente_id' para consist√™ncia
            payload.paciente_id = urlParams.get('patientId');
            
            if(!payload.paciente_id) {
                showModal("Falhou","Erro: ID do paciente n√£o identificado para criar o retorno.");
                return;
            }
        }

        // Envio para API
        const response = await fetch('api.php?action=save-appointment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json','X-Timezone': userTimezone },
            body: JSON.stringify(payload),            
        });

        const result = await response.json();

        if (result.success) {
            showModal("Sucesso",'Atendimento finalizado e retorno agendado com sucesso!');
            if (typeof renderTimeline === 'function') {
                if (timelineDetailModal) timelineDetailModal.classList.remove('active'); //fecha a tela de cards da timeline
                renderTimeline(); 
            } else {
                window.location.reload();
            }
        } else {
            showModal("Falhou",'Erro ao criar retorno: ' + (result.message || 'Erro desconhecido.'));
        }

    } catch (error) {
        console.error('Erro no processo de retorno:', error);
        showModal("Falhou",'Ocorreu um erro de conex√£o.');
    }
}

// Listener para o bot√£o de novo agendamento (j√° est√° no HTML, apenas garantir a fun√ß√£o)
//document.getElementById('btn-new-appointment-timeline')?.addEventListener('click', openTimelineNewModal);
formExamConsultProc.addEventListener('click', openTimelineNewModal);


// Listener para fechar modais da timeline clicando no overlay/fora
window.addEventListener('click', function(event) {
    // üîë MUDAN√áA CR√çTICA: Usar as classes e IDs do index.html
    const timelineDetailModal = document.getElementById('timeline-detail-modal');
    const timelineNewAppointmentModal = document.getElementById('timeline-new-appointment-modal');
    const overlay = document.querySelector('.popup-overlay:not(#modal-premium-hope):not(#modal-delete-account)');
    
    if (event.target === overlay  ) { //|| (timelineDetailModal && event.target === timelineDetailModal)
        if (timelineDetailModal) timelineDetailModal.classList.remove('active');
        if (overlay) overlay.classList.remove('active');
    }
    if (event.target === overlay ) { //|| (timelineNewAppointmentModal && event.target === timelineNewAppointmentModal)
        if (timelineNewAppointmentModal) timelineNewAppointmentModal.classList.remove('active');
        if (overlay) overlay.classList.remove('active');
    }
});

/* ========================================
   SISTEMA DE BEM-ESTAR DO CUIDADOR
======================================== */

// Estado do Bem-Estar do Cuidador
const caregiverWellness = {
    mealsToday: 0,        // Contador de refei√ß√µes (m√°x 4)
    sleptToday: false,    // Se o cuidador dormiu hoje
    totalTasks: 5,        // Total de tarefas di√°rias (4 refei√ß√µes + 1 sono)
    lastResetDate: null,  // Data do √∫ltimo reset
    wellnessPercentage: 100 // Percentual de bem-estar (100% no in√≠cio)
};

/**
 * Inicializa o sistema de bem-estar do cuidador
 */
async function initCaregiverWellness() {
    // 1. Verifica√ß√£o de Seguran√ßa
    if (!state.userId) {
        console.warn('initCaregiverWellness: Usu√°rio n√£o identificado.');
        return;
    }

    checkCaregiverDailyReset();

    console.log('üîÑ Sincronizando bem-estar do cuidador com o servidor...');

    try {
        // 2. Chamada ao Endpoint que criamos (get-caregiver-wellness)
        const resp = await apiGet('get-caregiver-wellness', { 
            caregiverId: state.userId 
        });

        if (resp.success) {
            // 3. Atualiza o Estado Global com a "Verdade do Servidor"
            // O SQL j√° garante que esses dados s√£o apenas de HOJE.
            caregiverWellness.mealsToday = parseInt(resp.data.mealsToday) || 0;
            
            // Tratamento robusto para booleano (aceita 1, "1", true)
            caregiverWellness.sleptToday = (resp.data.sleptToday == 1 || resp.data.sleptToday === true);
            
            // Se voc√™ usa respira√ß√£o:
            caregiverWellness.breathingToday = parseInt(resp.data.breathingToday) || 0;

            // Atualiza data de refer√™ncia
            caregiverWellness.lastUpdate = new Date().toDateString();

            // 4. Salva no localStorage (Backup/Cache para acesso r√°pido posterior)
            localStorage.setItem('caregiverWellness', JSON.stringify(caregiverWellness));

            console.log('‚úÖ Bem-estar carregado do servidor:', caregiverWellness);
        } else {
            console.warn('‚ö†Ô∏è API retornou erro, usando cache local:', resp.message);
            loadCaregiverLocalFallback();
        }

    } catch (error) {
        console.error('‚ùå Erro de conex√£o ao buscar bem-estar:', error);
        loadCaregiverLocalFallback();
    }

    // 5. Atualiza a UI com os dados finais (do servidor ou fallback)
    updateCaregiverWellnessUI();
}

// Fun√ß√£o auxiliar de Fallback (caso a internet falhe, usa o localStorage antigo)
function loadCaregiverLocalFallback() {
    const savedData = localStorage.getItem('caregiverWellness');
    if (savedData) {
        const parsed = JSON.parse(savedData);
        // Aqui sim precisamos checar a data, pois o cache pode ser de ontem
        if (parsed.lastUpdate === new Date().toDateString()) {
            Object.assign(caregiverWellness, parsed);
        } else {
            // Se o cache √© velho, zera tudo
            caregiverWellness.mealsToday = 0;
            caregiverWellness.sleptToday = false;
            caregiverWellness.lastUpdate = new Date().toDateString();
        }
    }
}

/**
 * Verifica se √© um novo dia e reseta as tarefas
 */
function checkCaregiverDailyReset() {
    const today = new Date().toDateString();
    
    if (caregiverWellness.lastResetDate !== today) {
        console.log('üîÑ Novo dia detectado - Resetando bem-estar do cuidador');
        
        // Reset das tarefas
        caregiverWellness.mealsToday = 0;
        caregiverWellness.sleptToday = false;
        caregiverWellness.lastResetDate = today;
        caregiverWellness.wellnessPercentage = 100;
        
        saveCaregiverWellness();
    }
}

/**
 * Salva o estado no localStorage
 */
function saveCaregiverWellness() {
    localStorage.setItem('caregiverWellness', JSON.stringify(caregiverWellness));
}

/**
 * Calcula o progresso das tarefas completadas
 */
function calculateCaregiverProgress() {
    const completed = caregiverWellness.mealsToday + (caregiverWellness.sleptToday ? 1 : 0);
    return {
        completed: completed,
        total: caregiverWellness.totalTasks,
        percentage: (completed / caregiverWellness.totalTasks) * 100
    };
}

/**
 * Calcula o percentual de bem-estar (c√≠rculo diminui ao longo do dia)
 */
function calculateCaregiverWellness() {
    const progress = calculateCaregiverProgress();
    
    // F√≥rmula: 100% quando todas as tarefas est√£o completas
    // Diminui proporcionalmente quando tarefas n√£o s√£o feitas
    caregiverWellness.wellnessPercentage = progress.percentage;
    
    return caregiverWellness.wellnessPercentage;
}

/**
 * Atualiza a UI do c√≠rculo de progresso e menu
 */
function updateCaregiverWellnessUI() {
    const wellness = calculateCaregiverWellness();
    const progress = calculateCaregiverProgress();
    
    // 1. Atualizar c√≠rculo SVG (similar ao do paciente)
    const circle = document.getElementById('caregiverWellnessCircle');
    if (circle) {
        const circumference = 125.66; // 2 * PI * 20
        const offset = circumference - (wellness / 100) * circumference;
        circle.style.strokeDashoffset = offset;
        
        // Mudar cor baseado no percentual
        if (wellness < 40) {
            circle.style.stroke = '#ef4444'; // Vermelho
        } else if (wellness <= 70) {
            circle.style.stroke = '#f59e0b'; // Laranja
        } else {
            circle.style.stroke = '#22c55e'; // Verde
        }
    }
    
    // 2. Atualizar textos do menu
    const progressText = document.getElementById('caregiverProgressText');
    if (progressText) {
        progressText.textContent = `${progress.completed}/${progress.total}`;
        progressText.className = 'font-bold ' + (wellness >= 80 ? 'text-green-600' : wellness >= 40 ? 'text-orange-500' : 'text-red-500');
    }
    
    // 3. Atualizar barra de progresso
    const progressBar = document.getElementById('caregiverProgressBar');
    if (progressBar) {
        progressBar.style.width = `${progress.percentage}%`;
    }
    
    // 4. Atualizar contador de refei√ß√µes
    const mealsText = document.getElementById('mealsCountText');
    if (mealsText) {
        mealsText.textContent = `${caregiverWellness.mealsToday}/4 hoje`;
    }
    
    // 5. Atualizar status de sono
    const sleepText = document.getElementById('sleepStatusText');
    if (sleepText) {
        sleepText.textContent = caregiverWellness.sleptToday ? '‚úÖ Completado' : 'Pendente';
        sleepText.className = 'text-xs ' + (caregiverWellness.sleptToday ? 'text-green-600' : 'opacity-75');
    }
    
    // 6. Anima√ß√£o de conclus√£o
    if (wellness === 100) {
        const container = document.querySelector('.caregiver-avatar-container');
        if (container) {
            container.classList.add('wellness-complete');
            setTimeout(() => container.classList.remove('wellness-complete'), 600);
        }
    }
}

/**
 * Abre/fecha o menu do cuidador
 */
function toggleCaregiverMenu() {
    const menu = document.getElementById('caregiverDropdownMenu');
    const container = document.querySelector('.caregiver-avatar-container');
    
    if (!menu) return;
    
    const isHidden = menu.classList.contains('hidden');
    
    if (isHidden) {
        // Fechar outros menus/modais se necess√°rio
        // closeChatModal('ai');
        // closeChatModal('caregiver');
        
        menu.classList.remove('hidden');
        container.classList.add('menu-open');
        
        // Atualizar dados antes de mostrar        
        updateCaregiverWellnessUI();
    } else {
        menu.classList.add('hidden');
        container.classList.remove('menu-open');
    }
}

/**
 * Fecha o menu do cuidador
 */
function closeCaregiverMenu() {
    const menu = document.getElementById('caregiverDropdownMenu');
    const container = document.querySelector('.caregiver-avatar-container');
    
    if (menu) menu.classList.add('hidden');
    if (container) container.classList.remove('menu-open');
}

/**
 * Registra uma refei√ß√£o do cuidador
 */
async function recordCaregiverMeal() {
    if (caregiverWellness.mealsToday >= 4) {
        showModal('Limite Atingido', 'Voc√™ j√° registrou as 4 refei√ß√µes de hoje! üçΩÔ∏è');
        return;
    }
    
    // Incrementar contador
    caregiverWellness.mealsToday++;
    
    // Salvar no localStorage
    saveCaregiverWellness();
    
    // Salvar no banco (opcional - criar endpoint save-caregiver-wellness na api.php)
    if (state.userId) {
        try {
            await apiPost('save-caregiver-wellness', {
                caregiverId: state.userId,
                action: 'meal',
                timestamp: new Date().toISOString()
            });
        } catch (e) {
            console.warn('N√£o foi poss√≠vel salvar no servidor:', e);
        }
    }
    
    // Atualizar UI
    updateCaregiverWellnessUI();
    
    // Feedback visual
    const messages = [
        'üçΩÔ∏è Refei√ß√£o registrada!',
        'ü•ó √ìtimo! Continue se alimentando bem!',
        'üç≤ Mais uma refei√ß√£o completa!',
        '‚ú® Parab√©ns! Voc√™ est√° cuidando de si!'
    ];
    
    const randomMsg = messages[Math.floor(Math.random() * messages.length)];
    showCelebrationMessage(randomMsg);
    
    // Fechar menu ap√≥s 1 segundo
    setTimeout(closeCaregiverMenu, 1000);
    
    console.log(`‚úÖ Refei√ß√£o registrada: ${caregiverWellness.mealsToday}/4`);
}

/**
 * Registra o sono do cuidador
 */
async function recordCaregiverSleep() {
    if (caregiverWellness.sleptToday) {
        showModal('J√° Registrado', 'Voc√™ j√° registrou seu per√≠odo de sono hoje! üò¥');
        return;
    }
    
    // Marcar como dormido
    caregiverWellness.sleptToday = true;
    
    // Salvar no localStorage
    saveCaregiverWellness();
    
    // Salvar no banco (opcional)
    if (state.userId) {
        try {
            await apiPost('save-caregiver-wellness', {
                caregiverId: state.userId,
                action: 'sleep',
                timestamp: new Date().toISOString()
            });
        } catch (e) {
            console.warn('N√£o foi poss√≠vel salvar no servidor:', e);
        }
    }
    
    // Atualizar UI
    updateCaregiverWellnessUI();
    
    // Feedback visual
    showCelebrationMessage('üò¥ Sono registrado! Descanse bem!');
    
    // Fechar menu ap√≥s 1 segundo
    setTimeout(closeCaregiverMenu, 1000);
    
    console.log('‚úÖ Sono registrado');
}

/**
 * Fecha o menu ao clicar fora dele
 */
document.addEventListener('click', function(event) {
    const menu = document.getElementById('caregiverDropdownMenu');
    const avatar = document.getElementById('caregiverAvatar');
    const container = document.querySelector('.caregiver-avatar-container');
    
    if (!menu || !avatar) return;
    
    // Se clicou fora do menu e do avatar
    if (!menu.contains(event.target) && 
        !avatar.contains(event.target) && 
        !container.contains(event.target)) {
        closeCaregiverMenu();
    }
});

/**
 * Integra√ß√£o com o startGame() - Inicializar bem-estar
 */
// Adicione ao final da fun√ß√£o startGame() existente:
// initCaregiverWellness();

///---Dados do Dashboard

// VARI√ÅVEIS GLOBAIS (ADICIONAR/ATUALIZAR NO IN√çCIO DO SCRIPT, SE NECESS√ÅRIO)
let weightImcChartInstance = null;
let abdominalChartInstance = null;
let liquidosChartInstance = null; 
let mealBalanceChartInstance = null; // üîë NOVA VARI√ÅVEL GLOBAL
// ...

// *** SUBSTITUA ESTAS FUN√á√ïES NO SEU C√ìDIGO JS ***
async function loadNutritionData(patientId, dataInicio = null, dataFim = null) {
    try {
        // --- CORRE√á√ÉO DE FUSO HOR√ÅRIO ---
        // Fun√ß√£o auxiliar para pegar data local no formato YYYY-MM-DD HH:mm:ss
        const getLocalISO = (date) => {
            const offset = date.getTimezoneOffset() * 60000; // Deslocamento em milissegundos
            const localDate = new Date(date.getTime() - offset);
            return localDate.toISOString().slice(0, 19).replace('T', ' ');
        };

        // Define per√≠odo padr√£o (√öltimas 24h Locais)
        if (!dataInicio || !dataFim) {
            const now = new Date();
            const yesterday = new Date();
            yesterday.setDate(now.getDate() - 1);
            
            dataFim = getLocalISO(now);
            dataInicio = getLocalISO(yesterday);
            
            console.log(`üìÖ Buscando dados de: ${dataInicio} at√© ${dataFim} (Local)`);
        }
        
        // Chamada 1: Nutri√ß√£o
        const nutritionResponse = await apiGet('get-nutrition-data', { paciente_id: patientId, data_inicio: dataInicio, data_fim: dataFim });
        
        // Chamada 2: Medidas F√≠sicas
        const physicalResponse = await apiGet('get-physical-measurements', { paciente_id: patientId, data_inicio: dataInicio, data_fim: dataFim });

        // Chamada 3: Balan√ßo Nutricional (Gr√°fico de Rosca)
        const mealBalanceResponse = await apiGet('get-meal-balance', { paciente_id: patientId, data_inicio: dataInicio, data_fim: dataFim });
      
        // Chamada 4: Balan√ßo H√≠drico (Meta vs Realizado)
        const hydricBalanceResponse = await apiGet('get-hydric-balance', { paciente_id: patientId, data_inicio: dataInicio, data_fim: dataFim });

        // --- RENDERIZA√á√ÉO ---

        if (nutritionResponse.success && nutritionResponse.data) {
            renderNutritionCharts(nutritionResponse.data);
            console.log('‚úÖ Nutri√ß√£o:', nutritionResponse.data);
        } else {
            console.warn('‚ö†Ô∏è Nutri√ß√£o vazia ou erro:', nutritionResponse);
        }

        if (mealBalanceResponse.success) {
            try { 
                // Verifica se a fun√ß√£o existe antes de chamar para evitar travar o resto
                if (typeof renderMealBalanceChart === 'function') {
                    renderMealBalanceChart(mealBalanceResponse.data);
                } else {
                    console.warn('Fun√ß√£o renderMealBalanceChart n√£o encontrada.');
                }
            } catch (err) {
                console.error('Erro render Balan√ßo Nutricional:', err);
            }
        }

        if (physicalResponse.success && physicalResponse.data) {
            // Verifica exist√™ncia
            if (typeof renderPhysicalMeasurementsCharts === 'function') {
                renderPhysicalMeasurementsCharts(physicalResponse);
            }
        }

        if (hydricBalanceResponse.success) {
             if (typeof renderHydricBalance === 'function') {
                renderHydricBalance(hydricBalanceResponse.data, dataFim);
             }
        }

    } catch (error) {
        console.error('‚ùå Erro fatal em loadNutritionData:', error);
    }
}

// index.html - Nova fun√ß√£o JavaScript para renderizar o Gr√°fico de Balan√ßo Nutricional
function renderMealBalanceChart(data) {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    const ctx = document.getElementById('mealBalanceChart');
    const loadingMessage = document.getElementById('mealBalanceChart-loading');
    
    // üîë Destruir inst√¢ncia anterior
    if (typeof mealBalanceChartInstance !== 'undefined' && mealBalanceChartInstance) {
        mealBalanceChartInstance.destroy();
    }

    if (!data || data.length === 0) {
        if (loadingMessage) {
            // TRADU√á√ÉO: Mensagem de vazio
            loadingMessage.textContent = t['msgNoMealData'] || 'Nenhum dado de refei√ß√£o ou excre√ß√£o s√≥lida encontrado no per√≠odo.';
            loadingMessage.classList.remove('hidden');
        }
        return;
    }

    if (loadingMessage) loadingMessage.classList.add('hidden');

    // Mapear dados com Localiza√ß√£o de Data correta
    // Define o locale baseado na linguagem atual
    const localeMap = { 'pt': 'pt-BR', 'en': 'en-US', 'es': 'es-ES' };
    const dateLocale = (typeof currentLang !== 'undefined' && localeMap[currentLang]) ? localeMap[currentLang] : 'pt-BR';

    const labels = data.map(d => new Date(d.dia).toLocaleDateString(dateLocale, { day: '2-digit', month: '2-digit' }));
    const intake = data.map(d => parseFloat(d.total_intake_g) || 0);
    const output = data.map(d => parseFloat(d.total_output_g) || 0);
    
    mealBalanceChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                // TRADU√á√ÉO: Label Ingest√£o
                label: t['labelIntakeG'] || 'Ingest√£o (g)',
                data: intake,
                borderColor: '#10b981', // Verde
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                fill: true,
                tension: 0.3
            }, {
                // TRADU√á√ÉO: Label Sa√≠da
                label: t['labelOutputG'] || 'Sa√≠da (Fezes, g)',
                data: output,
                borderColor: '#ef4444', // Vermelho
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                fill: false,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    // TRADU√á√ÉO: Eixo X
                    title: { display: true, text: t['labelDay'] || 'Dia' }
                },
                y: {
                    // TRADU√á√ÉO: Eixo Y
                    title: { display: true, text: t['labelMassG'] || 'Massa (g)' },
                    beginAtZero: true
                }
            },
            plugins: {
                legend: { position: 'top' },
                tooltip: { mode: 'index', intersect: false }
            }
        }
    });
}

// index.html - Nova fun√ß√£o JavaScript para renderizar o Balan√ßo H√≠drico

function renderHydricBalance(data, dataFim) {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    // 2. Define o locale de data baseado na linguagem (Fallback para pt-BR)
    const localeMap = { 'pt': 'pt-BR', 'en': 'en-US', 'es': 'es-ES' };
    const dateLocale = (typeof currentLang !== 'undefined' && localeMap[currentLang]) ? localeMap[currentLang] : 'pt-BR';

    // 1. C√ÅLCULO DO BALAN√áO E ATUALIZA√á√ÉO DO RESUMO
    if (!data || !data.period_days) {
        // TRADU√á√ÉO: Mensagem de estado vazio
        document.getElementById('bh-loading-row').textContent = t['msgNoHydricData'] || 'Nenhum dado encontrado para o per√≠odo.';
        document.getElementById('bh-balanco-final').textContent = 'N/A';
        return;
    }

    const ingestaoOral = data.total_oral_intake_ml;
    const ingestaoIV = data.total_iv_intake_ml;
    const eliminacaoExcrecao = data.total_excretion_ml;
    const perdaInsensivel = data.total_insensible_loss_ml;
    
    // C√°lculo final
    const ingestaoTotal = ingestaoOral + ingestaoIV;
    const eliminacaoTotal = eliminacaoExcrecao + perdaInsensivel;
    const balancoFinal = ingestaoTotal - eliminacaoTotal;

    // Atualizar Resumo
    document.getElementById('bh-ingestao-total').textContent = `${ingestaoTotal.toFixed(0)} mL`;
    document.getElementById('bh-eliminacao-total').textContent = `${eliminacaoTotal.toFixed(0)} mL`;
    
    const finalElement = document.getElementById('bh-balanco-final');
    finalElement.textContent = `${(balancoFinal > 0 ? '+' : '')}${balancoFinal.toFixed(0)} mL`;
    
    // Aplicar cor baseada no resultado
    finalElement.classList.remove('text-red-600', 'text-green-600', 'text-gray-800');
    if (Math.abs(balancoFinal) <= 200) { 
        finalElement.classList.add('text-gray-800');
    } else if (balancoFinal > 200) { 
        finalElement.classList.add('text-green-600');
    } else { 
        finalElement.classList.add('text-red-600');
    }
    
    document.getElementById('bh-insensible-loss').textContent = perdaInsensivel.toFixed(0);
    document.getElementById('bh-fever-days').textContent = data.fever_days;
    document.getElementById('bh-period-days').textContent = data.period_days;

    // 2. MONTAR TABELA DETALHADA
    const allEntries = [
      // Entradas Orais
      ...data.intake_details
        .filter(d => d.action_type === 'meds') 
        .map(d => ({
            data: d.data_registro,
            // TRADU√á√ÉO: Tipo Oral
            tipo: t['typeOralLiquids'] || 'L√≠quidos Orais',
            volume: parseFloat(d.volume_ml) || 0, 
            isIngestao: true,
            notes: d.notes||null 
        })),
        // Entradas IV/Enteral
      ...data.intake_details
        .filter(d => d.action_type !== 'food' && d.action_type !== 'meds')
        .map(d => ({
            data: d.data_agendada, 
            // TRADU√á√ÉO: Tipo IV
            tipo: t['typeIVEtheral'] || 'IV/Enteral (Medica√ß√£o)',
            volume: parseFloat(d.volume_ml) || 0,
            isIngestao: true,
            notes: d.notes||null 
        })),
        // Sa√≠das (Excre√ß√£o)
        ...data.excretion_details.map(d => ({
            data: d.data_registro,
            // TRADU√á√ÉO: Tipo Excre√ß√£o
            tipo: t['typeExcretion'] || 'Excre√ß√£o (Diurese/V√¥mito/Dreno)',
            volume: parseFloat(d.volume_ml) || 0,
            isIngestao: false,
            notes: d.notes||null 
        })),
        // Perda Insens√≠vel (Resumo)
        {
            data: new Date(dataFim).toISOString(), 
            // TRADU√á√ÉO: Tipo Perda Insens√≠vel
            tipo: t['typeInsensible'] || 'Perda Insens√≠vel (Est.)',
            volume: perdaInsensivel, 
            isIngestao: false,
            isSummary: true,
            notes: null 
        }
    ];

    // Ordenar por data
    allEntries.sort((a, b) => new Date(a.data) - new Date(b.data));

    const tableBody = document.getElementById('bh-details-table');
    tableBody.innerHTML = ''; 

    allEntries.forEach(entry => {
        const row = tableBody.insertRow();
        
        const noteText = (entry.notes || '').trim();
        const hasNote = noteText.length > 0;

        const volumeClass = entry.isIngestao ? 'text-blue-600' : (entry.isSummary ? 'text-red-800' : 'text-red-600');
        const typePrefix = entry.isIngestao ? '‚¨ÜÔ∏è ' : '‚¨áÔ∏è ';
        const rowBg = entry.isSummary ? 'bg-yellow-50 font-bold' : 'bg-white';
        
        row.className = `${rowBg} border-b border-gray-100 transition-colors duration-150`;

        if (hasNote) {
            row.classList.add('cursor-pointer', 'hover:bg-blue-50');
            // TRADU√á√ÉO: Tooltip
            row.setAttribute('title', t['tooltipViewNote'] || 'Toque para ver a observa√ß√£o');
            row.onclick = function() {
                openBhObservationModal(noteText, entry.tipo);
            };
        } else if (!entry.isSummary) {
             row.classList.add('cursor-default');
        }

        // C√©lula 1: Data
        const cellDate = row.insertCell();
        cellDate.className = 'px-3 py-2 whitespace-nowrap text-xs align-middle';
        // TRADU√á√ÉO: Label Resumo ou Data Formatada Localmente
        const lblSummary = t['labelSummary'] || 'Resumo';
        cellDate.textContent = entry.isSummary ? lblSummary : (() => {
             if (!entry.data) return '';
             const d = new Date(entry.data);
             // Uso do dateLocale definido no in√≠cio
             return isNaN(d) ? entry.data : d.toLocaleDateString(dateLocale, { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
        })();

        // C√©lula 2: Tipo + √çcone
        const cellType = row.insertCell();
        cellType.className = 'px-3 py-2 whitespace-normal text-sm align-middle relative'; 
        
        let contentHtml = `<span class="font-medium">${entry.isSummary ? '' : typePrefix}${entry.tipo}</span>`;
        
        if (hasNote) {
            // TRADU√á√ÉO: Tooltip do √≠cone
            const lblNote = t['labelViewNote'] || 'Ver nota';
            contentHtml += ` <span class="inline-flex items-center justify-center bg-blue-100 text-blue-600 rounded-full w-5 h-5 ml-2 text-xs" title="${lblNote}">üìù</span>`;
        }
        
        cellType.innerHTML = contentHtml;

        // C√©lula 3: Volume
        const cellVolume = row.insertCell();
        const vol = parseFloat(entry.volume_ml || entry.volume || 0);
        cellVolume.textContent = vol.toFixed(0);
        cellVolume.className = `px-3 py-2 whitespace-nowrap text-right font-bold ${volumeClass} align-middle`;
    });

    if (allEntries.length === 0) {
        const row = tableBody.insertRow();
        const cell = row.insertCell();
        cell.colSpan = 3;
        cell.className = 'text-center text-gray-500 py-4';
        // TRADU√á√ÉO: Tabela vazia
        cell.textContent = t['msgNoHydricRecords'] || 'Nenhum registro de entrada ou sa√≠da encontrado no per√≠odo.';
    }
}


/**
 * Abre o modal centralizado
 */
function openBhObservationModal(text, title) {
    const modal = document.getElementById('bh-observation-modal');
    const textField = document.getElementById('bh-modal-text');
    
    if (modal && textField) {
        textField.textContent = text || "Sem observa√ß√µes registradas.";
        
        // FOR√áA O DISPLAY FLEX PARA APARECER E CENTRALIZAR
        modal.style.display = 'flex'; 
    }
}

/**
 * Fecha o modal
 */
function closeBhObservationModal() {
    const modal = document.getElementById('bh-observation-modal');
    if (modal) {
        // Oculta o modal
        modal.style.display = 'none';
    }
}

// Fechar ao clicar fora (no fundo escuro)
window.onclick = function(event) {
    const modal = document.getElementById('bh-observation-modal');
    if (event.target === modal) {
        closeBhObservationModal();
    }
}


function renderNutritionCharts(nutritionData) {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    const nutrologiaContent = document.getElementById('nutrologia-content');
    if (!nutrologiaContent) return;

    // Remove gr√°ficos antigos
    if (typeof liquidosChartInstance !== 'undefined' && liquidosChartInstance) {
        liquidosChartInstance.destroy();
    }

    // Dados de Nutri√ß√£o
    const totais = nutritionData.totais;
    const percentualLiquidos = (totais.liquidos_ml / totais.meta_liquidos) * 100;

    // --- L√≥gica de Tradu√ß√£o Din√¢mica ---
    const isAdequate = percentualLiquidos >= 80;
    
    // 1. Defini√ß√£o dos textos traduzidos (Vari√°veis JS)
    
    // NOVO: T√≠tulo Principal com Emoji (Resolvendo o problema anterior)
    //const titleMainSection = t['nutritionalbalanceTitle'] || 'üçé Balan√ßo Nutricional (Entrada/Sa√≠da S√≥lida)';

    const txtTrend = t['lblTrend'] || 'Tend√™ncia:';
    const txtStatus = isAdequate 
        ? (t['statusAdequate'] || '‚úÖ Adequado') 
        : (t['statusConsumeMore'] || '‚ö†Ô∏è Consumir Mais');
    const colorClass = isAdequate ? 'text-green-600' : 'text-red-600';
    
    const titleLiquids = t['titleLiquidConsumption'] || 'Consumo de L√≠quidos (mL)';
    const lblTotal = t['lblTotal'] || 'Total:';
    const lblGoal = t['lblGoal'] || 'Meta:';
    const lblDaily = t['lblDaily'] || '/Dia';
    
    const titleMeals = t['titleRegisteredMeals'] || 'Refei√ß√µes Registradas';
    const lblMealsPeriod = t['lblMealsInPeriod'] || 'refei√ß√µes no per√≠odo';
    const statusStable = t['statusStable'] || 'Est√°vel';
    const goalMealsText = t['goalMealsPerDay'] || 'Meta: 4-5 refei√ß√µes/dia';

    // --- Inserir HTML ---
    const nutritionChartsContainer = document.getElementById('nutrition-charts-container');
    if (nutritionChartsContainer) {
         // Adicionamos o H3 do t√≠tulo principal no topo do HTML injetado
         nutritionChartsContainer.innerHTML = `
            <div class="col-span-1 md:col-span-2 mb-2">               
            </div>

            <div class="bg-white p-4 rounded-xl shadow-md">
                <h3 class="font-semibold mb-2">${titleLiquids}</h3>
                <div class="h-40 flex items-center justify-center rounded-lg">
                    <canvas id="liquidosChart"></canvas>
                </div>
                <p class="mt-2 text-sm"> 
                    ${lblTotal} <span class="font-bold">${totais.liquidos_ml.toFixed(0)} mL</span> | ${lblGoal} ${totais.meta_liquidos} mL${lblDaily} 
                </p> 
                <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2"> 
                    <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${Math.min(percentualLiquidos, 100)}%"></div> 
                </div> 
                <p class="mt-1 text-xs ${colorClass}"> 
                    ${txtTrend} ${txtStatus} 
                </p> 
            </div> 
            
            <div class="bg-white p-4 rounded-xl shadow-md"> 
                <h3 class="font-semibold mb-2">${titleMeals}</h3> 
                <div class="h-40 bg-gray-100 flex items-center justify-center rounded-lg border border-dashed"> 
                    <div class="text-center"> 
                        <div class="text-5xl font-bold text-indigo-600">${totais.refeicoes}</div> 
                        <div class="text-sm text-gray-600 mt-2">${lblMealsPeriod}</div> 
                    </div> 
                </div> 
                <p class="mt-2 text-sm"> 
                    ${txtTrend} <span class="text-green-500 font-bold">${statusStable}</span> | ${goalMealsText} 
                </p> 
            </div>
        `;
    }
    
    

    // Renderiza o gr√°fico
    if(typeof renderLiquidosChart === 'function') {
        renderLiquidosChart(nutritionData.liquidos); 
    }
}

/**
 * üîë FUN√á√ÉO NOVA: Renderiza gr√°ficos de Peso, IMC e Circunfer√™ncia Abdominal.  
 * @param {object} data Dados hist√≥ricos de medidas f√≠sicas.
 */
function renderPhysicalMeasurementsCharts(data) {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    // Destruir inst√¢ncias antigas se existirem
    if (typeof weightImcChartInstance !== 'undefined' && weightImcChartInstance) weightImcChartInstance.destroy();
    if (typeof abdominalChartInstance !== 'undefined' && abdominalChartInstance) abdominalChartInstance.destroy();
    
    // Obter altura atual do paciente
    const patientHeight = parseFloat(state.patient?.height) || 1.70; 

    if (!data.data || data.data.length === 0) {
        document.getElementById('latestWeight').textContent = '-- kg';
        document.getElementById('latestImc').textContent = '--';
        document.getElementById('latestCirc').textContent = '-- cm';
        // TRADU√á√ÉO: Mensagem de sem dados
        document.getElementById('circAlert').innerHTML = `<span class="text-gray-500">${t['msgNoData'] || 'Nenhum dado'}</span>`;
        return;
    }

    const labels = data.data.map(d => new Date(d.data_registro));
    
    // Filtra e prepara dados
    const weights = data.data.map(d => parseFloat(d.weight)).filter(w => !isNaN(w) && w > 0);
    const imcs = weights.map(w => w / (patientHeight * patientHeight));
    const abdominals = data.data.map(d => parseFloat(d.abdominal_circumference)).filter(a => !isNaN(a) && a > 0);

    const latest = data.data[data.data.length - 1];
    
    // Atualizar latest values e alertas
    if (latest) {
        const latestWeight = parseFloat(latest.weight);
        const latestImc = latestWeight && patientHeight ? (latestWeight / (patientHeight * patientHeight)).toFixed(1) : '--';
        
        document.getElementById('latestWeight').textContent = latest.weight ? `${latest.weight} kg` : '-- kg';
        document.getElementById('latestImc').textContent = latestImc;
        document.getElementById('latestCirc').textContent = latest.abdominal_circumference ? `${latest.abdominal_circumference} cm` : '-- cm';

        // Alerta Circunfer√™ncia Abdominal
        const circ = parseFloat(latest.abdominal_circumference);
        // TRADU√á√ÉO: Status padr√£o
        let alertText = t['statusEvaluation'] || 'Em Avalia√ß√£o';
        let alertColor = 'text-gray-500';

        if (circ > 0) {
            if ((state.patient?.gender === 'male' && circ > 102) || (state.patient?.gender === 'female' && circ > 88)) {
                // TRADU√á√ÉO: Risco Alto
                alertText = t['statusHighRisk'] || '‚ö†Ô∏è Risco Acentuado!';
                alertColor = 'text-red-600 font-bold';
            } else {
                // TRADU√á√ÉO: Adequado
                alertText = t['statusAdequate'] || '‚úÖ Adequado';
                alertColor = 'text-green-600 font-bold';
            }
        }
        document.getElementById('circAlert').innerHTML = `<span class="${alertColor}">${alertText}</span>`;
    }

    // 1. Gr√°fico de Peso e IMC
    const ctxWeightImc = document.getElementById('weightImcChart');
    if (ctxWeightImc) {
        // TRADU√á√ÉO: Labels dos Eixos e Datasets
        const lblWeight = t['labelWeight'] || 'Peso (kg)';
        const lblBMI = t['labelBMI'] || 'IMC';

        weightImcChartInstance = new Chart(ctxWeightImc, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: lblWeight,
                    data: weights,
                    borderColor: '#2563eb', 
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    yAxisID: 'yPeso',
                    tension: 0.3,
                    pointRadius: 3
                }, {
                    label: lblBMI,
                    data: imcs.map((imc, index) => ({ x: labels[index], y: imc })),
                    borderColor: '#f97316', 
                    backgroundColor: 'rgba(249, 115, 22, 0.1)',
                    yAxisID: 'yImc',
                    tension: 0.3,
                    pointRadius: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'month' },
                        title: { display: false },
                        ticks: { source: 'auto' }
                    },
                    yPeso: {
                        type: 'linear',
                        position: 'left',
                        title: { display: true, text: lblWeight, color: '#2563eb' },
                        grid: { drawOnChartArea: true }
                    },
                    yImc: {
                        type: 'linear',
                        position: 'right',
                        title: { display: true, text: lblBMI, color: '#f97316' },
                        grid: { drawOnChartArea: false } 
                    }
                },
                plugins: {
                    legend: { position: 'top' },
                    tooltip: { mode: 'index', intersect: false }
                }
            }
        });
    }

    // 2. Gr√°fico de Circunfer√™ncia Abdominal
    const ctxAbdominal = document.getElementById('abdominalChart');
    if (ctxAbdominal) {
        // TRADU√á√ÉO: Labels
        const lblAbdCirc = t['labelAbdominalCirc'] || 'Circ. Abdominal (cm)';
        const lblLimitHigh = t['labelHighRiskLimit'] || 'Limite Risco Alto';
        const lblAxisCirc = t['labelCirc'] || 'Circ. (cm)';

        abdominalChartInstance = new Chart(ctxAbdominal, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: lblAbdCirc,
                    data: abdominals,
                    borderColor: '#10b981', 
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    yAxisID: 'yCirc',
                    tension: 0.3,
                    pointRadius: 4
                }, {
                    label: lblLimitHigh, 
                    data: labels.map(() => (state.patient?.gender === 'male' ? 102 : 88)), 
                    borderColor: '#ef4444', 
                    borderDash: [5, 5],
                    borderWidth: 1,
                    pointRadius: 0,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'month' },
                        title: { display: false },
                        ticks: { source: 'auto' }
                    },
                    yCirc: {
                        type: 'linear',
                        position: 'left',
                        title: { display: true, text: lblAxisCirc, color: '#10b981' },
                        grid: { drawOnChartArea: true }
                    }
                },
                plugins: {
                    legend: { position: 'top' },
                    tooltip: { mode: 'index', intersect: false }
                }
            }
        });
    }
}

/**
 * Renderiza o gr√°fico de Consumo de L√≠quidos (Barras)
 * @param {object} liquidosData Dados de consumo de l√≠quidos
 */
function renderLiquidosChart(liquidosData) {
    const ctxLiquidos = document.getElementById('liquidosChart');
    if (liquidosChartInstance) liquidosChartInstance.destroy();
    
    if (ctxLiquidos && liquidosData.length > 0) {
        const labels = liquidosData.map(d => `${new Date(d.data).toLocaleDateString('pt-BR')} - ${d.hora}h`);
        const dataValues = liquidosData.map(d => parseFloat(d.total_ml));

        liquidosChartInstance = new Chart(ctxLiquidos, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'L√≠quidos (mL)',
                    data: dataValues,
                    backgroundColor: 'rgba(59, 130, 246, 0.5)',
                    borderColor: '#3b82f6',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        // type: 'time', // Usar 'category' se o eixo for apenas para horas/dia
                        stacked: true,
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        title: { display: true, text: 'Volume (mL)' }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    } else if (ctxLiquidos) {
        // Fallback for no data
        ctxLiquidos.parentNode.innerHTML = '<div class="text-center text-gray-500 p-8">Nenhum registro de l√≠quido encontrado no per√≠odo.</div>';
    }
}

/**
 * Renderiza dados farmac√™uticos
 */

let medicationFrequencyChartInstance = null; // Vari√°vel global para a inst√¢ncia do gr√°fico

async function loadPharmacyData(patientId, dataInicio = null, dataFim = null) {
    if (!patientId) {
        console.warn('loadPharmacyData: paciente_id n√£o fornecido, abortando.');
        return;
    }

    // Normaliza per√≠odo: se vier com hora (YYYY-MM-DD HH:mm:ss) converte para YYYY-MM-DD
    const normalizeToDate = (d) => {
        if (!d) return null;
        return (typeof d === 'string' && d.length >= 10) ? d.slice(0,10) : d;
    };

    try {
        // Define per√≠odo padr√£o (√∫ltimos 30 dias)
        if (!dataInicio || !dataFim) {
            const today = new Date();
            dataFim = today.toISOString().slice(0, 10);
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            dataInicio = thirtyDaysAgo.toISOString().slice(0, 10);
        }

        dataInicio = normalizeToDate(dataInicio);
        dataFim = normalizeToDate(dataFim);

        // 1) Buscar dados farmac√™uticos principais
        const response = await apiGet('get-pharmacy-data', {
            paciente_id: patientId,
            data_inicio: dataInicio,
            data_fim: dataFim
        });

        if (response && response.success && response.data) {
            renderPharmacyData(response.data);            
            console.debug('‚úÖ Dados de farm√°cia carregados:', response.data);
        } else {
            console.warn('loadPharmacyData: resposta inv√°lida de get-pharmacy-data', response);
            // limpar √°reas de UI se necess√°rio
            const farmaciaContent = document.getElementById('farmacia-content');
            // opcional: exibir mensagem
        }

        // 2) Buscar resumo de medicamentos (tabela + gr√°fico)
        try {
            const summaryResponse = await apiGet('get-medication-summary', {
                paciente_id: patientId,
                data_inicio: dataInicio,
                data_fim: dataFim
            });

            if (summaryResponse && summaryResponse.success) {
                renderMedicationSummary(summaryResponse.data);
                renderMedicationFrequencyChart(summaryResponse.data);
                // Chama NOVA API para Compliance (Execu√ß√£o paralela)
                loadComplianceData(patientId, dataInicio, dataFim);
            } else {
                console.warn('loadPharmacyData: get-medication-summary retornou erro', summaryResponse);
                const table = document.getElementById('medication-summary-table');
                if (table) table.innerHTML = `<tr><td colspan="3" class="text-center text-red-500 py-4">${summaryResponse.message || 'Nenhum resumo dispon√≠vel.'}</td></tr>`;
                if (medicationFrequencyChartInstance) {
                    medicationFrequencyChartInstance.destroy();
                    medicationFrequencyChartInstance = null;
                }
            }
        } catch (errSummary) {
            console.error('Erro ao obter/representar get-medication-summary:', errSummary);
            const table = document.getElementById('medication-summary-table');
            if (table) table.innerHTML = `<tr><td colspan="3" class="text-center text-red-500 py-4">Erro ao carregar resumo de medicamentos.</td></tr>`;
            if (medicationFrequencyChartInstance) {
                try { medicationFrequencyChartInstance.destroy(); } catch(e){}
                medicationFrequencyChartInstance = null;
            }
        }

    } catch (error) {
        console.error('Erro geral loadPharmacyData:', error);
        // fallback UI
        const table = document.getElementById('medication-summary-table');
        if (table) table.innerHTML = `<tr><td colspan="3" class="text-center text-red-500 py-4">Erro de conex√£o ao carregar farm√°cia.</td></tr>`;
        if (medicationFrequencyChartInstance) {
            try { medicationFrequencyChartInstance.destroy(); } catch(e){}
            medicationFrequencyChartInstance = null;
        }
    }
}

function renderPharmacyData(data) {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    const farmaciaContent = document.getElementById('farmacia-content');
    if (!farmaciaContent) return;
    
    const compliance = data.compliance || { percentual: 0, doses_realizadas: 0, doses_agendadas: 0 };
    const ativos = data.medicamentos_ativos || [];
    const inativos = data.medicamentos_inativos || [];
    const alertas = data.alertas || [];

    // Contabiliza a origem do pagamento dos medicamentos ativos
    const pagadorMedsData = ativos.reduce((acc, med) => {
        const pagador = med.status_pagador || (t['statusNotInformed'] || 'N√£o informado');
        acc[pagador] = (acc[pagador] || 0) + 1;
        return acc;
    }, {});
    
    const listaNomesAtivos = ativos.map(m => m.nome_medicamento);

    // TRADU√á√ÉO: Textos comuns
    const txtSN = t['medIntervalSN'] || 'S/N';
    const txtIntervalPrefix = t['medIntervalPrefix'] || 'De';
    const txtIntervalSuffix = t['medIntervalSuffix'] || 'em';
    const txtHours = t['medIntervalHours'] || 'h';

    // Construir listas HTML (Ativos)
    let ativosHTML = ativos.slice(0, 5).map(med => {
        let intervaloTexto = '';
        if (med.intervalo_horas && med.intervalo_horas > 0) {
            // Ex: "De 8 em 8 h"
            intervaloTexto = `${txtIntervalPrefix} ${med.intervalo_horas} ${txtIntervalSuffix} ${med.intervalo_horas} ${txtHours}`;
        } else {
            intervaloTexto = txtSN;
        }

        return `
            <li class="flex justify-between items-center border-b border-gray-100 py-2 last:border-0">
                <div class="flex flex-col">
                    <span class="font-medium text-gray-800 text-sm">${escapeHtml(med.nome_medicamento)}</span>
                    <span class="text-xs text-gray-500">${med.dosagem}${med.unidade_dosagem}</span>
                </div>
                <span class="font-bold text-indigo-600 text-xs bg-indigo-50 px-2 py-1 rounded-lg">
                    ${intervaloTexto}
                </span>
            </li>
        `;
    }).join('');
    
    if (ativos.length === 0) {
        // TRADU√á√ÉO: Lista vazia
        ativosHTML = `<li class="text-gray-500 text-sm">${t['msgNoActiveMeds'] || 'Nenhum medicamento ativo registrado.'}</li>`;
    }
    
    // Construir lista HTML (Inativos)
    let inativosHTML = inativos.slice(0, 3).map(med => `
        <li class="flex justify-between text-gray-500 text-sm">
            <span>${escapeHtml(med.nome_medicamento)}</span> 
            <span class="text-xs">${med.status_receita}</span>
        </li>
    `).join('');
    
    if (inativos.length === 0) {
        // TRADU√á√ÉO: Lista inativa vazia
        inativosHTML = `<li class="text-gray-500 text-sm">${t['msgNoInactiveMeds'] || 'Nenhum inativo recente.'}</li>`;
    }
    
    // Construir lista HTML (Alertas)
    let alertasHTML = alertas.map(alerta => `
        <li class="text-orange-600 flex items-center text-xs font-medium">
            <span class="mr-1">‚ö†Ô∏è</span> ${escapeHtml(alerta.nome_medicamento)}: ${alerta.tipo_alerta}
        </li>
    `).join('');
    
    if (alertas.length === 0) {
        // TRADU√á√ÉO: Sem alertas
        alertasHTML = `<li class="text-green-600 text-xs">‚úÖ ${t['msgNoAlerts'] || 'Sem alertas internos.'}</li>`;
    }
    
    // Cor do compliance e status
    let complianceColor = 'text-red-600';
    // TRADU√á√ÉO: Status Compliance
    let complianceStatus = t['statusAttention'] || 'Aten√ß√£o Necess√°ria';

    if (compliance.percentual >= 90) {
        complianceColor = 'text-green-600';
        complianceStatus = t['statusExcellent'] || 'Excelente!';
    } else if (compliance.percentual >= 70) {
        complianceColor = 'text-yellow-600';
        complianceStatus = t['statusRegular'] || 'Regular';
    }
    
    // TRADU√á√ÉO: T√≠tulos e Labels da Interface
    const titlePharmacy = t['titlePharmacy'] || 'üíä Gest√£o Farmac√™utica';
    const titleActive = t['titleActive'] || 'Ativos';
    const tagInUse = t['tagInUse'] || 'Em uso';
    const titleAlerts = t['titleAlerts'] || 'Alertas Farmac√™uticos';
    const btnCheckInteractions = t['btnCheckInteractions'] || 'Verificar Intera√ß√µes (IA)';
    const tooltipNeedMeds = t['tooltipNeedMeds'] || 'Necess√°rio 2+ medicamentos';
    const titleHistory = t['titleHistory'] || 'Hist√≥rico Recente';
    const msgHistoryDisclaimer = t['msgHistoryDisclaimer'] || '"O valor total consumido dividido pela capacidade do frasco indica o consumo real."';
    const titleAdherence = t['titleAdherence'] || 'Ades√£o ao Tratamento';
    const lblEfficiency = t['lblEfficiency'] || 'Efici√™ncia Adminstrada';
    const lblDoses = t['lblDoses'] || 'doses';
    const msgBasedOn30Days = t['msgBasedOn30Days'] || 'Baseado nos √∫ltimos 30 dias.';
    const titleConsolidated = t['titleConsolidated'] || 'üìä Consumo Consolidado';
    const colItem = t['colItem'] || 'Item';
    const colDoses = t['colDoses'] || 'Doses';
    const colTotal = t['colTotal'] || 'Total';
    const msgLoading = t['msgLoading'] || 'Carregando...';
    const titleFrequencyChart = t['titleFrequencyChart'] || 'üìà Gr√°fico de Frequ√™ncia';

    // Renderiza√ß√£o do HTML Principal
    farmaciaContent.innerHTML = `
        <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2 flex items-center gap-2">
            üíä ${t['titlePharmacy'] || 'Gest√£o Farmac√™utica'}
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white p-4 rounded-xl shadow-md border-t-4 border-emerald-500">
                <div class="flex justify-between items-center mb-3 border-b pb-2">
                    <h3 class="font-semibold text-emerald-700">${t['titleActive'] || 'Ativos'} (${ativos.length})</h3>
                    <span class="text-xs text-emerald-600 bg-emerald-100 px-2 py-0.5 rounded-full">${t['tagInUse'] || 'Em uso'}</span>
                </div>
                <ul class="space-y-1 mb-4 max-h-60 overflow-y-auto custom-scrollbar">
                    ${ativosHTML}
                </ul>
                
                <div class="bg-gray-50 rounded-lg p-3 border border-gray-100">
                    <h3 class="font-semibold text-xs text-gray-500 uppercase mb-2">${t['titleAlerts'] || 'Alertas'}</h3>
                    <ul class="space-y-1">${alertasHTML}</ul>
                </div>
            </div>
            
            <div class="space-y-6">
                <div class="bg-white p-4 rounded-xl shadow-md border-t-4 border-blue-500">
                    <h3 class="font-semibold mb-2 text-blue-800 text-sm">${t['titleAdherence'] || 'Ades√£o ao Tratamento'}</h3>
                    <div class="flex items-center justify-around">
                        <div class="text-4xl font-extrabold ${complianceColor}">${compliance.percentual.toFixed(0)}%</div>
                        <div class="text-center">
                            <span class="text-blue-700 font-bold text-xs block">${complianceStatus}</span>
                            <span class="text-[10px] text-blue-500">${compliance.doses_realizadas}/${compliance.doses_agendadas} ${t['lblDoses'] || 'doses'}</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-xl shadow-md border-t-4 border-orange-400">
                    <h3 class="text-sm font-bold text-gray-700 mb-3">üí∞ ${t['titleMedPayerSource'] || 'Origem do Custo (Ativos)'}</h3>
                    <div class="relative h-40 w-full">
                        <canvas id="medPayerChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
             <div class="bg-white p-4 rounded-xl shadow-md">
                <h3 class="text-sm font-bold text-gray-700 mb-3">${t['titleConsolidated'] || 'Consumo Consolidado'}</h3>
                </div>

            <div class="bg-white p-4 rounded-xl shadow-md">
                <h3 class="text-sm font-bold text-gray-700 mb-3">${t['titleFrequencyChart'] || 'Frequ√™ncia'}</h3>
                <div class="relative h-48">
                    <canvas id="medicationFrequencyChart"></canvas>
                </div>
            </div>
        </div>
    `;

    // Inicializa√ß√£o do Novo Gr√°fico de Pagadores da Farm√°cia
    const ctxMed = document.getElementById('medPayerChart').getContext('2d');
    new Chart(ctxMed, {
        type: 'doughnut',
        data: {
            labels: Object.keys(pagadorMedsData),
            datasets: [{
                data: Object.values(pagadorMedsData),
                backgroundColor: ['#10B981', '#3B82F6', '#F59E0B', '#6366F1', '#94A3B8'],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'right', labels: { boxWidth: 10, font: { size: 9 } } }
            },
            cutout: '70%'
        }
    });

}

/**
 * Fun√ß√£o acionada pelo bot√£o na aba Farm√°cia para checar intera√ß√µes via API
 */
async function checkPharmacyInteractions(btnElement) {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    const resultContainer = document.getElementById('ddi-result-container');
    const medsData = btnElement.getAttribute('data-meds');
    
    // Recupera ID do paciente
    const patientId = (typeof state !== 'undefined' && state.patientId) 
                      ? state.patientId 
                      : (typeof currentPatientId !== 'undefined' ? currentPatientId : null); 

    if (!patientId) {
        // TRADU√á√ÉO: Valida√ß√£o
        showModal(t['modalErrorTitle'] || 'Falha', t['msgSelectPatientVerification'] || 'Selecione um paciente para realizar a verifica√ß√£o.');
        return;
    }

    let medsList = [];
    try {
        medsList = JSON.parse(medsData);
    } catch (e) {
        console.error("Erro ao ler dados do bot√£o", e);
        return;
    }

    // UI Loading (TRADUZIDO)
    const originalText = btnElement.innerHTML;
    const txtAnalyzing = t['btnAnalyzing'] || 'Analisando...';
    btnElement.disabled = true;
    btnElement.innerHTML = `<svg class="animate-spin h-4 w-4 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> ${txtAnalyzing}`;
    
    resultContainer.classList.remove('hidden');
    resultContainer.innerHTML = '<div class="animate-pulse bg-gray-200 h-10 rounded"></div>';

    try {
        const response = await fetch('api.php?action=check-ddi', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Timezone': (typeof userTimezone !== 'undefined' ? userTimezone : 'UTC') },
            body: JSON.stringify({
                paciente_id: patientId,
                meds: medsList,
                // CORRE√á√ÉO: Envia o idioma atual para a API retornar o texto correto
                lang: (typeof currentLang !== 'undefined') ? currentLang : 'pt'                
            })
        });

        const data = await response.json();

        if (data.success) {
            const styles = {
                'contraindicated': 'bg-red-100 text-red-800 border-red-200',
                'contra-indicado': 'bg-red-100 text-red-800 border-red-200',
                'major':           'bg-orange-100 text-orange-800 border-orange-200',
                'moderate':        'bg-yellow-50 text-yellow-800 border-yellow-200',
                'minor':           'bg-blue-50 text-blue-800 border-blue-100',
                'unknown':         'bg-gray-100 text-gray-800 border-gray-200'
            };
            
            let severity = (data.gravidade || 'unknown').toLowerCase();
            
            // L√ìGICA DE SEGURAN√áA:
            // Compara o texto recebido com a tradu√ß√£o esperada de "Nenhuma intera√ß√£o"
            const noInteractionText = (t['msgNoInteractions'] || 'nenhuma intera√ß√£o').toLowerCase();
            let safeMode = data.descricao_alerta.toLowerCase().includes(noInteractionText);
            
            let finalClass = safeMode 
                ? 'bg-green-50 text-green-700 border-green-200' 
                : (styles[severity] || styles['unknown']);
            
            let icon = safeMode ? '‚úÖ' : '‚ö†Ô∏è';

            // TRADU√á√ÉO: Textos do Card
            const lblResult = t['lblAnalysisResult'] || 'Resultado da An√°lise';
            const lblSource = t['lblSource'] || 'Fonte';

            resultContainer.innerHTML = `
                <div class="p-2 rounded border ${finalClass} mt-2 animate-fade-in">
                    <div class="font-bold flex items-center justify-between mb-1">
                        <span>${icon} ${lblResult}</span>
                        <span class="text-[10px] opacity-70 border border-current px-1 rounded uppercase">${severity}</span>
                    </div>
                    <p class="leading-snug opacity-90 text-[11px] whitespace-pre-line">${escapeHtml(data.descricao_alerta)}</p>
                    <div class="mt-2 pt-1 border-t border-black/10 text-[10px] opacity-60 flex justify-between">
                        <span>${lblSource}: National Library of Medicine - NIH/USA</span>
                        <span>ID: ${data.alerta_id}</span>
                    </div>
                </div>
            `;
        } else {
            // ... (C√≥digo de Debug mantido igual) ...
            console.group("üî¥ ERRO CR√çTICO DRUGBANK");
            console.warn("Mensagem:", data.message);
            // ... (restante dos logs) ...
            console.groupEnd();

            resultContainer.innerHTML = `<p class="text-red-500 mt-2">Erro: ${data.message}</p>`;
        }

    } catch (error) {
        console.error(error);
        // TRADU√á√ÉO: Falha na conex√£o
        const msgFail = t['msgConnectionErrorVerification'] || 'Falha na conex√£o.';
        resultContainer.innerHTML = `<p class="text-red-500 mt-2">${msgFail}</p>`;
    } finally {
        btnElement.innerHTML = originalText;
        btnElement.disabled = false;
    }
}

// Pequeno helper caso n√£o exista globalmente
function escapeHtml(text) {
    if (!text) return text;
    return text.toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function renderMedicationSummary(data) {
    const tableBody = document.getElementById('medication-summary-table');
    if (!tableBody) return;

    // Caso n√£o haja dados
    if (!data || data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500 py-4">Nenhum dado registrado no per√≠odo.</td></tr>';
        return;
    }

    // Calcular o total geral de doses apenas para valida√ß√£o (opcional, mantido da l√≥gica anterior se necess√°rio para outros fins)
    const totalDosesGeral = data.reduce((acc, item) => acc + (parseInt(item.total_doses, 10) || 0), 0);

    tableBody.innerHTML = ''; // Limpar tabela
    const chartLabels = [];
    const chartData = [];

    data.forEach(item => {
        const doses = parseInt(item.total_doses, 10) || 0;
        
        // --- NOVA L√ìGICA ---
        // 1. Pega o valor num√©rico da dosagem unit√°ria (ex: 25 de "25mg")
        const doseUnitaria = parseFloat(item.dosagem) || 0;
        
        // 2. Calcula o total ministrado (ex: 25mg * 3 doses = 75)
        const totalCalculado = doseUnitaria * doses;
        
        // 3. Formata para evitar d√≠zimas (ex: 20.00 vira 20)
        const totalExibicao = parseFloat(totalCalculado.toFixed(2));
        
        // 4. Prepara o texto da unidade (ex: "mg", "ml")
        const unidade = item.unidade_dosagem || '';

        const nomeCompleto = `${item.nome_medicamento || ''} ${item.dosagem || ''}${unidade}`;
        
        const row = tableBody.insertRow();
        row.innerHTML = `
            <td class="px-4 py-2 whitespace-nowrap">${escapeHtml(nomeCompleto)}</td>
            <td class="px-4 py-2 whitespace-nowrap text-right font-medium">${doses}</td>
            <td class="px-4 py-2 whitespace-nowrap text-right font-bold text-blue-600">
                ${totalExibicao} ${unidade}
            </td>
        `;

        chartLabels.push(nomeCompleto);
        chartData.push(doses);
    });

    // Se voc√™ estiver usando o gr√°fico abaixo da tabela, ele continua funcionando com base no n√∫mero de doses
    renderMedicationFrequencyChart(data); // Certifique-se que essa fun√ß√£o espera o objeto 'data' completo agora
}

function renderMedicationFrequencyChart(data) {
    const canvasEl = document.getElementById('medicationFrequencyChart');
    if (!canvasEl) return;

    const ctx = canvasEl.getContext('2d');
    
    // Destruir gr√°fico anterior se existir
    if (medicationFrequencyChartInstance) {
        try {
            medicationFrequencyChartInstance.destroy();
        } catch(e) { 
            console.warn('Erro ao destruir gr√°fico anterior', e); 
        }
        medicationFrequencyChartInstance = null;
    }

    // Valida√ß√£o de dados
    if (!Array.isArray(data) || data.length === 0) {
        // Opcional: Limpar canvas ou mostrar mensagem
        return;
    }

    // CORRE√á√ÉO 2: Calcular totalDoses dentro desta fun√ß√£o (vari√°vel local)
    const totalDoses = data.reduce((sum, item) => {
        const val = parseInt(item.total_doses, 10);
        return sum + (isNaN(val) ? 0 : val);
    }, 0);

    // Preparar dados para o Chart.js
    const labels = data.map(item => item.nome_medicamento || 'Desconhecido');
    const chartDataValues = data.map(item => parseInt(item.total_doses, 10) || 0);
    
    const backgroundColors = [
        '#2563eb', '#f97316', '#10b981', '#8b5cf6', '#ef4444', '#eab308', '#06b6d4'
    ];

    medicationFrequencyChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: chartDataValues,
                backgroundColor: backgroundColors.slice(0, labels.length),
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    align: 'center',
                    labels: {
                        padding: 15,
                        generateLabels: (chart) => {
                            const d = chart.data;
                            if (d.labels.length && d.datasets.length) {
                                return d.labels.map((label, i) => {
                                    const value = d.datasets[0].data[i] || 0;
                                    // CORRE√á√ÉO 2 (Uso): Agora totalDoses existe neste escopo
                                    const percentage = totalDoses > 0 ? Math.round(value / totalDoses * 100) + '%' : '0%';
                                    return {
                                        text: `${label}: ${percentage} (${value} doses)`,
                                        fillStyle: d.datasets[0].backgroundColor[i],
                                        index: i
                                    };
                                });
                            }
                            return [];
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.raw || 0;
                            // CORRE√á√ÉO 2 (Uso): totalDoses dispon√≠vel aqui tamb√©m
                            const percentage = totalDoses > 0 ? ((value / totalDoses) * 100).toFixed(1) : 0;
                            return `${context.label}: ${value} doses (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

async function loadComplianceData(patientId, dataInicio, dataFim) {
    // Identifique os elementos no seu HTML onde os n√∫meros devem aparecer
    // Exemplo: <span id="compliance-percent">--%</span> e <span id="compliance-fraction">--/--</span>
    const percentEl = document.getElementById('compliance-percent');
    const fractionEl = document.getElementById('compliance-fraction');
    
    // Reset visual
    if(percentEl) percentEl.innerText = '...';

    try {
        const response = await apiGet('get-medication-compliance', {
            paciente_id: patientId,
            data_inicio: dataInicio,
            data_fim: dataFim
        });

        if (response && response.success && response.compliance) {
            const { realizado, esperado, percentual } = response.compliance;

            // Atualiza Porcentagem
            if (percentEl) {
                percentEl.innerText = `${percentual}%`;
                
                // Cores din√¢micas baseadas na nota
                percentEl.className = ''; // Limpa classes antigas
                if (percentual >= 80) percentEl.classList.add('text-green-600', 'font-bold');
                else if (percentual >= 50) percentEl.classList.add('text-yellow-600', 'font-bold');
                else percentEl.classList.add('text-red-600', 'font-bold');
            }

            // Atualiza Fra√ß√£o (Ex: "15/20")
            if (fractionEl) {
                fractionEl.innerText = `${realizado}/${esperado} doses`;
            }
            
            // Se houver uma barra de progresso
            const progressBar = document.getElementById('compliance-progress-bar');
            if(progressBar) {
                progressBar.style.width = `${percentual}%`;
            }

        } else {
            console.warn('Dados de compliance vazios ou falha na API', response);
            if(percentEl) percentEl.innerText = '-';
        }
    } catch (error) {
        console.error('Erro ao carregar compliance:', error);
    }
}



/**
 * Carrega dados de exames/labs e atualiza a aba correspondente
 */
 
async function loadExamsData(patientId, dataInicio = null, dataFim = null) {
    try {
        // Define per√≠odo padr√£o (√∫ltimos 90 dias)
        if (!dataInicio || !dataFim) {
            dataFim = new Date().toISOString().slice(0, 10);
            const ninetyDaysAgo = new Date();
            ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);
            dataInicio = ninetyDaysAgo.toISOString().slice(0, 10);
        }
        
        const response = await apiGet('get-exams-data', {
            paciente_id: patientId,
            data_inicio: dataInicio,
            data_fim: dataFim
        });
        
        if (response.success && response.data) {
            renderExamsData(response.data);
            console.log('‚úÖ Dados de exames carregados:', response.data);
        } else {
            console.error('Erro ao carregar dados de exames:', response.message);
        }


    } catch (error) {
        console.error('Erro de conex√£o ao carregar exames:', error);
    }
}


// ===== Helpers para cores e cria√ß√£o de chart =====
const EXAM_COLORS = {
  'fc': '#ef4444',      // frequ√™ncia card√≠aca - vermelho
  'fr': '#f59e0b',      // frequ√™ncia respirat√≥ria - amarelo
  'ox': '#06b6d4',      // oximetria - azul celeste
  'temp': '#fb923c',    // temperatura - laranja
  'lab1': '#7c3aed',    // roxo
  'lab2': '#ec4899',    // rosa
  'lab3': '#10b981'     // verde
};

function getColorForCampo(campo, index = 0) {
  const key = campo.toLowerCase();
  if (key.includes('card') || key.includes('freq') && key.includes('card')) return EXAM_COLORS.fc;
  if (key.includes('resp') || key.includes('frequec') && key.includes('resp')) return EXAM_COLORS.fr;
  if (key.includes('oxi') || key.includes('spo2') || key.includes('satur')) return EXAM_COLORS.ox;
  if (key.includes('temp')) return EXAM_COLORS.temp;
  if (key.includes('press') || key.includes('pa')) {
    // Pressure handled specially externally (sist/diast)
    return EXAM_COLORS.temp; // default for sist√≥lica
  }
  // Alterna labs entre 3 cores
  const labs = [EXAM_COLORS.lab1, EXAM_COLORS.lab2, EXAM_COLORS.lab3];
  return labs[index % labs.length];
}

function createLineChart(ctx, labels, dataPoints, options = {}) {
  // returns Chart instance
  return new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: dataPoints
    },
    options: Object.assign({
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'nearest',
        intersect: false
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(context) {
              let v = context.parsed.y;
              return `${v} ${context.dataset.unidade || ''}`;
            }
          }
        }
      },
      scales: {
        x: {
          type: 'time',
          time: { tooltipFormat: 'dd/MM/yyyy HH:mm', unit: 'day' },
          ticks: { maxRotation: 0 }
        },
        y: {
          beginAtZero: false
        }
      }
    }, options)
  });
}

// destroyChart caso j√° exista
function destroyIfExists(chartVar) {
  if (chartVar && typeof chartVar.destroy === 'function') {
    try { chartVar.destroy(); } catch(e){ console.warn(e); }
  }
}

function renderExamsData(data) {
  const container = document.getElementById('exames-content');
  if (!container) return;

  // Limpar container
  container.innerHTML = '';

  const sinais = data.sinais_vitais || {};
  const labs = data.exames_laboratoriais || {};
  const alertas = data.alertas_criticos || [];

  const grid = document.createElement('div');
  grid.className = 'exams-grid';

  const allKeys = Object.keys(sinais).concat(Object.keys(labs));

  let labIndex = 0;
  allKeys.forEach((campoKey) => {
    const item = sinais[campoKey] || labs[campoKey];
    if (!item) return;

    const card = document.createElement('div');
    card.className = 'exam-card';
    card.setAttribute('data-campo', campoKey);

    // --- Header ---
    const header = document.createElement('div');
    header.className = 'exam-header';

    const title = document.createElement('div');
    title.className = 'exam-title flex items-center';

    const titleText = document.createElement('span');
    titleText.innerText = campoKey;
    title.appendChild(titleText);

    // L√≥gica de Observa√ß√£o
    let lastObs = '';
    if (item.registros && item.registros.length > 0) {
      const lastReg = item.registros[item.registros.length - 1];
      lastObs = lastReg.observacoes || lastReg.observacao || '';
    }

    if (lastObs && lastObs.trim() !== '') {
      const btnObs = document.createElement('button');
      btnObs.innerHTML = 'üìù'; 
      btnObs.className = 'ml-2 text-sm text-blue-600 hover:bg-blue-100 p-1 rounded-full transition-colors cursor-pointer border-none bg-transparent';
      btnObs.title = 'Ver observa√ß√£o';
      btnObs.onclick = (e) => {
        e.stopPropagation();
        openBhObservationModal(lastObs, campoKey);
      };
      title.appendChild(btnObs);
    }

    const meta = document.createElement('div');
    meta.className = 'exam-meta';
    const lastValEl = document.createElement('div');
    lastValEl.className = 'font-semibold';
    lastValEl.innerText = `${item.ultimo_valor ?? '-'} ${item.unidade_medida ?? ''}`;
    
    const lastDateEl = document.createElement('div');
    lastDateEl.className = 'text-sm text-gray-500';
    lastDateEl.innerText = item.ultima_data ? new Date(item.ultima_data).toLocaleString('pt-BR') : '-';

    meta.appendChild(lastValEl);
    meta.appendChild(lastDateEl);
    header.appendChild(title);
    header.appendChild(meta);

    // --- Canvas ---
    const canvasWrap = document.createElement('div');
    canvasWrap.className = 'canvas-wrap';
    const canvas = document.createElement('canvas');
    canvasWrap.appendChild(canvas);

    // --- Legenda e Limites ---
    const legend = document.createElement('div');
    legend.className = 'legend-small';
    const low = item.limite_inferior;
    const high = item.limite_superior;
    
    if (low !== null || high !== null) {
      legend.innerHTML = `Faixa normal: ${low ?? '-'} ‚Äî ${high ?? '-'}`;
    } else {
      legend.innerHTML = '&nbsp;';
    }

    card.appendChild(header);
    card.appendChild(canvasWrap);
    card.appendChild(legend);
    grid.appendChild(card);

    // --- Preparar Datasets ---
    let datasets = [];
    let labels = [];
    let limitDatasets = [];

    if (item.registros && item.registros.length > 0) {
      const isPA = campoKey.toUpperCase().includes('PA') || 
                   campoKey.toUpperCase().includes('PRESS√ÉO') ||
                   (typeof item.registros[0].valor_lido === 'string' && item.registros[0].valor_lido.includes('/'));

      if (isPA) {
        // S√©ries de Dados PA
        const dsSys = { label: 'Sist√≥lica', data: [], borderColor: '#ef4444', tension: 0.2, fill: false };
        const dsDia = { label: 'Diast√≥lica', data: [], borderColor: '#3b82f6', tension: 0.2, fill: false };

        item.registros.forEach(r => {
          const d = new Date(r.data_registro);
          labels.push(d);
          if (typeof r.valor_lido === 'string' && r.valor_lido.includes('/')) {
            const v = r.valor_lido.split('/');
            dsSys.data.push({ x: d, y: parseFloat(v[0]) });
            dsDia.data.push({ x: d, y: parseFloat(v[1]) });
          }
        });
        datasets.push(dsSys, dsDia);

        // Limites tracejados PA (Quebrando strings "95/60")
        if (low && typeof low === 'string' && low.includes('/')) {
          const l = low.split('/');
          limitDatasets.push({
            label: 'M√≠n Sist/Diast',
            data: labels.map(x => ({ x: x, y: parseFloat(l[0]) })),
            borderColor: 'rgba(239, 68, 68, 0.2)', borderDash: [5, 5], pointRadius: 0, fill: false
          });
          limitDatasets.push({
            label: '',
            data: labels.map(x => ({ x: x, y: parseFloat(l[1]) })),
            borderColor: 'rgba(59, 130, 246, 0.2)', borderDash: [5, 5], pointRadius: 0, fill: false
          });
        }
        if (high && typeof high === 'string' && high.includes('/')) {
          const h = high.split('/');
          limitDatasets.push({
            label: 'M√°x Sist/Diast',
            data: labels.map(x => ({ x: x, y: parseFloat(h[0]) })),
            borderColor: 'rgba(239, 68, 68, 0.2)', borderDash: [5, 5], pointRadius: 0, fill: false
          });
          limitDatasets.push({
            label: '',
            data: labels.map(x => ({ x: x, y: parseFloat(h[1]) })),
            borderColor: 'rgba(59, 130, 246, 0.2)', borderDash: [5, 5], pointRadius: 0, fill: false
          });
        }
      } else {
        // Exame Normal
        const color = getColorForCampo(campoKey, labIndex);
        const ds = { label: campoKey, data: [], borderColor: color, tension: 0.2, fill: false, pointRadius: 4 };
        item.registros.forEach(r => {
          const d = new Date(r.data_registro);
          labels.push(d);
          ds.data.push({ x: d, y: parseFloat(r.valor_lido) || 0 });
        });
        datasets.push(ds);

        if (low !== null && !isNaN(parseFloat(low))) {
          limitDatasets.push({ label: 'M√≠n', data: labels.map(x => ({ x: x, y: parseFloat(low) })), borderColor: 'rgba(107,114,128,0.2)', borderDash: [5,5], pointRadius: 0, fill: false });
        }
        if (high !== null && !isNaN(parseFloat(high))) {
          limitDatasets.push({ label: 'M√°x', data: labels.map(x => ({ x: x, y: parseFloat(high) })), borderColor: 'rgba(107,114,128,0.2)', borderDash: [5,5], pointRadius: 0, fill: false });
        }
        if (!Object.keys(sinais).includes(campoKey)) labIndex++;
      }
    }

    // --- Criar Gr√°fico ---
    const chartInstance = createLineChart(canvas.getContext('2d'), labels, datasets.concat(limitDatasets), {
      scales: { x: { type: 'time', time: { tooltipFormat: 'dd/MM/yyyy HH:mm' } } }
    });

    // --- Valida√ß√£o de Out-of-Range (Alerta Visual) ---
    try {
      const last = item.ultimo_valor;
      if (last && typeof last === 'string' && last.includes('/')) {
        const v = last.split('/'), l = (low||"0/0").split('/'), h = (high||"999/999").split('/');
        if (parseFloat(v[0]) > parseFloat(h[0]) || parseFloat(v[0]) < parseFloat(l[0]) || 
            parseFloat(v[1]) > parseFloat(h[1]) || parseFloat(v[1]) < parseFloat(l[1])) {
          card.classList.add('out-of-range');
        }
      } else if (last !== null && !isNaN(parseFloat(last))) {
        const val = parseFloat(last);
        if ((low !== null && val < low) || (high !== null && val > high)) card.classList.add('out-of-range');
      }
    } catch(e) { console.warn(e); }
  });

  container.appendChild(grid);
}

/**
 * Carrega dados de procedimentos e atualiza a aba correspondente
 */
async function loadProceduresData(patientId, dataInicio = null, dataFim = null) {
    try {
        // Define per√≠odo padr√£o (√∫ltimos 6 meses)
        if (!dataInicio || !dataFim) {
            dataFim = new Date().toISOString().slice(0, 10);
            const sixMonthsAgo = new Date();
            sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
            dataInicio = sixMonthsAgo.toISOString().slice(0, 10);
        }
        
        const response = await apiGet('get-procedures-data', {
            paciente_id: patientId,
            data_inicio: dataInicio,
            data_fim: dataFim
        });
        
        if (response.success && response.data) {
            renderProceduresData(response.data);
            console.log('‚úÖ Dados de procedimentos carregados:', response.data);
        } else {
            console.error('Erro ao carregar dados de procedimentos:', response.message);
        }
    } catch (error) {
        console.error('Erro de conex√£o ao carregar procedimentos:', error);
    }
}

/**
 * Renderiza dados de procedimentos e consultas
 */

 function gerarRankingProfissionais(agendamentos) {
    // 1. Contabiliza as ocorr√™ncias por profissional
    const contagem = agendamentos.reduce((acc, ag) => {
        // Ignora registros sem nome de profissional ou n√£o realizados
        if (!ag.profissional_contato || ag.status !== 'Realizado com Sucesso') return acc;
        
        const nome = ag.profissional_contato.trim();
        if (!acc[nome]) {
            acc[nome] = { nome: nome, total: 0, consultas: 0, exames: 0, outros: 0 };
        }
        
        acc[nome].total++;
        
        // Categoriza por tipo para detalhamento no ranking
        if (ag.tipo === 'Consulta') acc[nome].consultas++;
        else if (ag.tipo === 'Exame') acc[nome].exames++;
        else acc[nome].outros++;
        
        return acc;
    }, {});

    // 2. Converte em array e ordena (Ranking: do maior para o menor)
    return Object.values(contagem).sort((a, b) => b.total - a.total);
}


function renderProceduresData(data) {
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    const procedimentosContent = document.getElementById('procedimentos-content');
    if (!procedimentosContent) return;
    
    const agendamentos = data.agendamentos || [];
    const stats = data.estatisticas;

    // 1. L√≥gica do Ranking de Profissionais (Apenas realizados)
    const ranking = agendamentos.reduce((acc, ag) => {
        if (!ag.profissional_contato || ag.status !== 'Realizado com Sucesso') return acc;
        const nome = ag.profissional_contato.trim();
        if (!acc[nome]) acc[nome] = { nome: nome, total: 0, consultas: 0, exames: 0 };
        acc[nome].total++;
        if (ag.tipo === 'Consulta') acc[nome].consultas++;
        else if (ag.tipo === 'Exame') acc[nome].exames++;
        return acc;
    }, {});
    const rankingSorted = Object.values(ranking).sort((a, b) => b.total - a.total);

    // 2. L√≥gica do Gr√°fico de Pagadores
    const pagadorData = agendamentos.reduce((acc, ag) => {
        const pagador = ag.status_pagador || 'N√£o informado';
        acc[pagador] = (acc[pagador] || 0) + 1;
        return acc;
    }, {});

    // 3. Renderiza√ß√£o do HTML com Grid de 2 Colunas
    procedimentosContent.innerHTML = `
        <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2 flex items-center gap-2">
            üìã ${t['titleProceduresTimeline'] || 'Timeline de Procedimentos'}
        </h2>
        
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 text-center">
                <div class="text-2xl font-bold text-blue-700">${stats.total_consultas}</div>
                <div class="text-xs text-gray-500">${t['titleConsultas'] || 'Consultas'}</div>
            </div>
            <div class="bg-purple-50 p-3 rounded-xl border border-purple-100 text-center">
                <div class="text-2xl font-bold text-purple-700">${stats.total_exames}</div>
                <div class="text-xs text-gray-500">${t['titleExames'] || 'Exames'}</div>
            </div>
            <div class="bg-green-50 p-3 rounded-xl border border-green-100 text-center">
                <div class="text-2xl font-bold text-green-700">${stats.realizados}</div>
                <div class="text-xs text-gray-500">${t['statusRealizado'] || 'Realizados'}</div>
            </div>
            <div class="bg-red-50 p-3 rounded-xl border border-red-100 text-center">
                <div class="text-2xl font-bold text-red-700">${stats.cancelados}</div>
                <div class="text-xs text-gray-500">${t['statusCancelado'] || 'Cancelados'}</div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-gray-50 p-4 rounded-xl shadow-inner md:row-span-2">
                <h3 class="text-sm font-bold text-gray-700 mb-3">${t['titleRecentHistory'] || 'Hist√≥rico Recente'}</h3>
                <ul class="space-y-3 max-h-[600px] overflow-y-auto custom-scrollbar">
                    ${agendamentos.map(ag => `
                        <li class="p-3 bg-white rounded-lg shadow-sm border-l-4 ${ag.status === 'Realizado com Sucesso' ? 'border-green-500' : 'border-blue-500'}">
                            <p class="font-semibold text-xs">${ag.tipo === 'Exame' ? 'üî¨' : 'üë®‚Äç‚öïÔ∏è'} ${escapeHtml(ag.tipo)}: ${escapeHtml(ag.descricao)}</p>
                            <p class="text-[10px] text-gray-500">${new Date(ag.data_consulta).toLocaleDateString()} | ${escapeHtml(ag.status_pagador || '')}</p>
                        </li>
                    `).join('')}
                </ul>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-md border-t-4 border-indigo-500">
                <h3 class="text-sm font-bold text-gray-700 mb-3">üèÜ ${t['titleProfRanking'] || 'Ranking de Atendimentos'}</h3>
                <div class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar">
                    ${rankingSorted.map((prof, i) => `
                        <div class="flex justify-between items-center text-xs p-2 bg-gray-50 rounded">
                            <span>${i < 3 ? ['ü•á','ü•à','ü•â'][i] : 'üë§'} ${prof.nome}</span>
                            <span class="font-bold text-indigo-600">${prof.total}</span>
                        </div>
                    `).join('')}
                </div>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-md border-t-4 border-orange-400">
                <h3 class="text-sm font-bold text-gray-700 mb-3">üí∞ ${t['titlePayerDistribution'] || 'Origem do Pagamento'}</h3>
                <div class="relative h-48 w-full">
                    <canvas id="payerDistributionChart"></canvas>
                </div>
            </div>
        </div>
    `;

    // 4. Inicializa√ß√£o do Gr√°fico (Chart.js)
    const ctx = document.getElementById('payerDistributionChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(pagadorData),
            datasets: [{
                data: Object.values(pagadorData),
                backgroundColor: ['#4F46E5', '#10B981', '#F59E0B', '#EF4444', '#94A3B8'],
                borderWidth: 2,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } }
            },
            cutout: '60%'
        }
    });
}


/* =========================================================================
   L√ìGICA DE GAMIFICA√á√ÉO E CONQUISTAS (SUBSTITUI√á√ÉO COMPLETA)
   ========================================================================= */
async function loadAchievementsData(patientId, dataInicio, dataFim) {
    console.group("üöÄ DEBUG: loadAchievementsData"); // Inicia agrupamento de logs
    
    // 1. Verifica√ß√£o de Seguran√ßa dos IDs
    const userId = state.userId; // Certifique-se que state.userId est√° preenchido no login
    
    console.log("Par√¢metros iniciais:", { 
        patientId: patientId, 
        caregiverId: userId,
        data_inicio: dataInicio, 
        data_fim: dataFim 
    });

    if (!userId) {
        console.error("‚ùå ERRO CR√çTICO: ID do cuidador (state.userId) est√° indefinido.");
        showModal('Falha',"Erro: Sess√£o do usu√°rio parece inv√°lida. Tente recarregar a p√°gina.");
        console.groupEnd();
        return;
    }

    // Refer√™ncias aos elementos da DOM
    const badgeContainer = document.getElementById('badges-grid');
    const rankingBody = document.getElementById('ranking-table-body');
    const levelTitle = document.getElementById('user-level-title');
    const progressBar = document.getElementById('xp-progress-bar');
    const xpOverlay = document.getElementById('xp-text-overlay');
    const currentXpLabel = document.getElementById('current-xp-label');
    const nextLevelLabel = document.getElementById('next-level-xp-label');

    // Estado visual de carregamento
    if(badgeContainer) badgeContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center py-4 animate-pulse">Carregando suas conquistas...</p>';
    if(rankingBody) rankingBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-400">Calculando ranking...</td></tr>';

    try {
        // 2. Chamada √† API
        
        
        const response = await apiGet('get-gamification-data', { 
            paciente_id: patientId,
            caregiver_id: userId, // <--- O PULO DO GATO: Enviando o ID para filtrar o updated_by
            data_inicio: dataInicio, 
            data_fim: dataFim
        });

        console.log("üì• Resposta da API Recebida:", response);

        if (response.success && response.data) {
            const { stats, ranking, debug_info } = response.data;
            
            console.log("‚úÖ Dados parseados com sucesso:", { stats, ranking });
            console.log("üîç Debug Server-Side:", debug_info);

            // 3. Renderiza√ß√£o
            if(badgeContainer) renderBadges(stats, badgeContainer);
            if(rankingBody) renderRanking(ranking, rankingBody);

            // 4. Atualiza√ß√£o da Barra de XP
            const myXP = parseInt(stats.total_xp) || 0;
            console.log(`üìä XP Total calculado para o usu√°rio: ${myXP}`);
            
            if(levelTitle) updateLevelUI(myXP, levelTitle, progressBar, xpOverlay, currentXpLabel, nextLevelLabel);

        } else {
            console.warn("‚ö†Ô∏è A API retornou sucesso:false ou dados vazios.", response);
            if(badgeContainer) badgeContainer.innerHTML = '<p class="text-red-400 col-span-full text-center">N√£o foi poss√≠vel carregar os dados.</p>';
            if(rankingBody) rankingBody.innerHTML = '<tr><td colspan="4" class="text-center text-red-400">Falha ao carregar.</td></tr>';
        }

    } catch (e) {
        console.error("‚ùå Exce√ß√£o (Catch) no loadAchievementsData:", e);
        if(badgeContainer) badgeContainer.innerHTML = '<p class="text-red-500 col-span-full text-center">Erro de conex√£o.</p>';
    }
    
    console.groupEnd(); // Fim do agrupamento
}

/**
 * Define as regras e renderiza os cards de medalhas
 * Mant√©m as originais e expande com as novas solicita√ß√µes
 */
function renderBadges(stats, container) {
    container.innerHTML = '';

    const definitions = [
        // --- ORIGINAIS MANTIDAS ---
        { 
            id: 'ambassador_share', 
            title: 'Embaixador Acura', 
            desc: 'Fortaleceu a rede compartilhando o app', 
            icon: 'üöÄ', 
            colorClass: 'text-purple-600 bg-purple-50', 
            barColor: 'bg-purple-500', 
            current: stats.total_shares || 0, // Pega o dado enviado pela API
            target: 2 // Meta: 1 compartilhamento
        },        
        {
            id: 'meds_master',
            title: 'Farmac√™utico(a)',
            desc: 'Administrou 20+ medicamentos',
            icon: 'üíä',
            colorClass: 'text-blue-600 bg-blue-50',
            barColor: 'bg-blue-500',
            current: stats.meds_administrados || 0,
            target: 20
        },
        {
            id: 'wellbeing_zen',
            title: 'Zen Master',
            desc: 'Registrou bem-estar 5 vezes',
            icon: 'üßò',
            colorClass: 'text-green-600 bg-green-50',
            barColor: 'bg-green-500',
            current: stats.bem_estar_logs || 0,
            target: 5
        },
        {
            id: 'hygiene_hero',
            title: 'Guardi√£o da Higiene',
            desc: '10 registros de banho/higiene',
            icon: 'üöø',
            colorClass: 'text-cyan-600 bg-cyan-50',
            barColor: 'bg-cyan-500',
            current: stats.higiene_logs || 0,
            target: 10
        },
        {
            id: 'activity_pro',
            title: 'Personal Trainer',
            desc: '5 atividades f√≠sicas registradas',
            icon: 'üèÉ',
            colorClass: 'text-orange-600 bg-orange-50',
            barColor: 'bg-orange-500',
            current: stats.atividades_fisicas || 0,
            target: 5
        },
        {
            id: 'social_star',
            title: 'Comunicador',
            desc: '15 mensagens no chat',
            icon: 'üí¨',
            colorClass: 'text-pink-600 bg-pink-50',
            barColor: 'bg-pink-500',
            current: stats.chat_msgs || 0,
            target: 15
        },

        // --- NOVAS MEDALHAS (EXPANS√ÉO) ---
        {
            id: 'appointment_master',
            title: 'Mestre da Agenda',
            desc: 'Realizou todos os appointments do per√≠odo',
            icon: 'üìÖ',
            colorClass: 'text-indigo-600 bg-indigo-50',
            barColor: 'bg-indigo-500',
            current: stats.appointments_concluidos || 0,
            target: 4 // Ajuste a meta conforme desejar
        },
        {
            id: 'specialist_wound',
            title: 'Especialista em Curativos',
            desc: 'Trocas de curativo e flush no per√≠odo',
            icon: 'ü©π',
            colorClass: 'text-red-600 bg-red-50',
            barColor: 'bg-red-500',
            current: stats.procedimentos_especiais || 0,
            target: 1
        },
        {
            id: 'terminal_cleaner',
            title: 'Expert em Biosseguran√ßa',
            desc: 'Limpeza terminal em todas as localiza√ß√µes',
            icon: '‚ú®',
            colorClass: 'text-teal-600 bg-teal-50',
            barColor: 'bg-teal-500',
            current: stats.limpezas_terminais || 0,
            target: 1
        },
        {
            id: 'biometric_pro',
            title: 'Vigilante Biom√©trico',
            desc: 'Registrou peso, altura e circunfer√™ncia',
            icon: '‚öñÔ∏è',
            colorClass: 'text-emerald-600 bg-emerald-50',
            barColor: 'bg-emerald-500',
            current: stats.registros_biometricos || 0,
            target: 3
        },
        {
            id: 'network_builder',
            title: 'Conector de Sa√∫de',
            desc: 'Convites e cadastro de profissionais',
            icon: 'ü§ù',
            colorClass: 'text-yellow-600 bg-yellow-50',
            barColor: 'bg-yellow-500',
            current: (stats.convites_sucesso || 0) + (stats.profissionais_cadastrados || 0),
            target: 2
        },
        {
            id: 'safety_expert',
            title: 'Seguran√ßa Farmac√™utica',
            desc: 'Consulta de intera√ß√£o medicamentosa',
            icon: 'üõ°Ô∏è',
            colorClass: 'text-slate-600 bg-slate-50',
            barColor: 'bg-slate-500',
            current: stats.consultas_interacao || 0,
            target: 1
        },
        {
            id: 'finance_pro',
            title: 'Gestor Financeiro',
            desc: 'Registrou 5+ controles de gastos/compras',
            icon: 'üí∞',
            colorClass: 'text-green-700 bg-green-100',
            barColor: 'bg-green-600',
            current: stats.controle_financeiro || 0,
            target: 10
        },
        {
            id: 'bestseller_author',
            title: 'Autor de Bestseller',
            desc: 'Criou relatos detalhados no hist√≥rico do paciente',
            icon: '‚úçÔ∏è',
            colorClass: 'text-amber-600 bg-amber-50',
            barColor: 'bg-amber-500',
            current: stats.posts_realizados || 0,
            target: 6 // Meta: 5 posts no per√≠odo
        },
        {
            id: 'clinical_strategist',
            title: 'Estrategista Cl√≠nico',
            desc: 'Utilizou o m√≥dulo de tomada de decis√£o',
            icon: 'üß†',
            colorClass: 'text-purple-600 bg-purple-50',
            barColor: 'bg-purple-500',
            current: stats.decisoes_ia || 0,
            target: 1 // Meta: 1 decis√µes registradas
        },
        {
            id: 'team_guardian',
            title: 'Guardi√£o da Equipe',
            desc: 'Registrou profissionais no turno',
            icon: 'üõ°Ô∏è', // √çcone de Escudo representando prote√ß√£o/guardi√£o
            colorClass: 'text-slate-700 bg-slate-100', // Cores s√≥brias e fortes
            barColor: 'bg-slate-600',
            // Pega o valor calculado no PHP (contagem de relat√≥rios com profissionais preenchidos)
            current: stats.registros_equipe || 0, 
            target: 1 // Basta fazer 1 vez no per√≠odo para desbloquear
        }
    ];

    definitions.forEach(badge => {
        const progressRaw = (badge.current / badge.target) * 100;
        const progressPercent = Math.min(progressRaw, 100).toFixed(0);
        const isUnlocked = badge.current >= badge.target;

        const opacity = isUnlocked ? 'opacity-100 ring-2 ring-offset-1 ring-green-400' : 'opacity-70 grayscale';
        const statusIcon = isUnlocked ? '<span class="absolute top-2 right-2 text-lg">‚úÖ</span>' : '<span class="absolute top-2 right-2 text-xs text-gray-400">üîí</span>';

        const html = `
            <div class="relative flex flex-col items-center p-4 rounded-xl border border-gray-100 shadow-sm bg-white transition-all hover:shadow-md ${opacity}">
                ${statusIcon}
                <div class="w-14 h-14 rounded-full flex items-center justify-center text-3xl mb-3 ${badge.colorClass}">
                    ${badge.icon}
                </div>
                <h4 class="font-bold text-gray-800 text-sm text-center">${badge.title}</h4>
                <p class="text-xs text-center text-gray-500 mb-3 h-8 flex items-center justify-center leading-tight">
                    ${badge.desc}
                </p>
                
                <div class="w-full bg-gray-100 rounded-full h-2 mt-auto overflow-hidden">
                    <div class="${badge.barColor} h-full rounded-full transition-all duration-700" style="width: ${progressPercent}%"></div>
                </div>
                <div class="text-[10px] text-gray-400 mt-1 w-full text-right font-mono">
                    ${badge.current}/${badge.target}
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
    });
}

/**
 * Renderiza a Tabela de Ranking
 */
function renderRanking(list, tableBody) {
    tableBody.innerHTML = '';
    
    if (!list || list.length === 0) {
        console.log("‚ÑπÔ∏è Lista de ranking vazia.");
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-400">Nenhum dado registrado para este paciente.</td></tr>';
        return;
    }

    console.log(`üèÜ Renderizando ${list.length} usu√°rios no ranking.`);

    list.forEach((user, index) => {
        const position = index + 1;
        
        // Verifica se √© o usu√°rio atual (convers√£o para string para garantir igualdade)
        const isMe = String(user.cuidador_id) === String(state.userId);
        
        // L√≥gica visual
        let medal = `<span class="font-bold text-gray-500">#${position}</span>`;
        let rowClass = isMe ? 'bg-blue-50 border-l-4 border-blue-500' : 'hover:bg-gray-50';
        let nameColor = isMe ? 'text-blue-700 font-bold' : 'text-gray-800';

        if (position === 1) medal = 'ü•á';
        if (position === 2) medal = 'ü•à';
        if (position === 3) medal = 'ü•â';

        // Avatar
        let avatarHTML = '';
        if (user.avatarUrl && user.avatarUrl.length > 5) {
             avatarHTML = `<img src="${user.avatarUrl}" class="w-8 h-8 rounded-full object-cover border border-gray-200">`;
        } else {
             const inicial = (user.nome_cuidador || '?').charAt(0).toUpperCase();
             avatarHTML = `<div class="w-8 h-8 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center text-xs font-bold">${inicial}</div>`;
        }

        const xp = parseInt(user.total_xp) || 0;
        const nivelInfo = getLevelInfo(xp); // Certifique-se que getLevelInfo existe no seu c√≥digo

        const html = `
            <tr class="border-b transition-colors ${rowClass}">
                <td class="px-4 py-3 text-center text-lg">${medal}</td>
                <td class="px-4 py-3">
                    <div class="flex items-center gap-3">
                        ${avatarHTML}
                        <span class="${nameColor}">${user.nome_cuidador || 'Desconhecido'} ${isMe ? '(Voc√™)' : ''}</span>
                    </div>
                </td>
                <td class="px-4 py-3 text-center">
                    <span class="px-2 py-1 rounded text-xs font-medium bg-indigo-100 text-indigo-800">
                        Nvl ${nivelInfo.level}
                    </span>
                </td>
                <td class="px-4 py-3 text-right font-mono font-medium text-gray-600">
                    ${xp} XP
                </td>
            </tr>
        `;
        tableBody.insertAdjacentHTML('beforeend', html);
    });
}

/**
 * Atualiza a interface da barra de n√≠vel principal
 */
function updateLevelUI(xp, titleEl, barEl, overlayEl, currentLabel, nextLabel) {
    const info = getLevelInfo(xp);
    
    // Atualiza Textos
    titleEl.innerHTML = `N√≠vel ${info.level} <span class="text-sm font-normal opacity-80">(${info.title})</span>`;
    currentLabel.textContent = `${xp} XP Atual`;
    nextLabel.textContent = `Pr√≥ximo: ${info.nextLevelXp} XP`;
    
    // Calcula porcentagem dentro do n√≠vel atual
    // Ex: Se N√≠vel 1 √© 0-500, e tenho 250, √© 50%.
    // Ex: Se N√≠vel 2 √© 500-1500 (diferen√ßa 1000), e tenho 750 (250 dentro do nivel), √© 25%.
    
    const xpIntoLevel = xp - info.baseXp;
    const levelSpan = info.nextLevelXp - info.baseXp;
    const percent = Math.min((xpIntoLevel / levelSpan) * 100, 100);

    barEl.style.width = `${percent}%`;
    overlayEl.textContent = `${xp} / ${info.nextLevelXp} XP`;
}

/**
 * L√≥gica central de n√≠veis (Helper)
 */
function getLevelInfo(xp) {
    xp = parseInt(xp) || 0;
    
    if (xp < 500)   return { level: 1, title: 'Aprendiz', baseXp: 0, nextLevelXp: 500 };
    if (xp < 1500)  return { level: 2, title: 'Cuidador Dedicado', baseXp: 500, nextLevelXp: 1500 };
    if (xp < 3000)  return { level: 3, title: 'Especialista', baseXp: 1500, nextLevelXp: 3000 };
    if (xp < 6000)  return { level: 4, title: 'Guardi√£o Mestre', baseXp: 3000, nextLevelXp: 6000 };
    return { level: 5, title: 'Lenda do Cuidado', baseXp: 6000, nextLevelXp: 100000 };
}

/**
 * Fallback para calcular XP se a API n√£o retornar o total, mas retornar stats
 */
function calculateTotalXP(stats) {
    let xp = 0;
    xp += (stats.meds_administrados || 0) * 50;
    xp += (stats.higiene_logs || 0) * 40;
    xp += (stats.atividades_fisicas || 0) * 40;
    xp += (stats.bem_estar_logs || 0) * 30;
    xp += (stats.dr_ia_msgs || 0) * 10;
    xp += (stats.chat_msgs || 0) * 5;
    return xp;
}

/**
 * Renderiza conquistas e estat√≠sticas de gamifica√ß√£o
 */
function renderAchievementsData(data) {
    const conquistasContent = document.getElementById('conquistas-content');
    if (!conquistasContent) return;
    
    const conquistas = data.conquistas || [];
    const stats = data.estatisticas;
    
    // Construir cards de conquistas
    let conquistasHTML = conquistas.map(conquista => `
        <div class="text-center p-4 ${conquista.cor} rounded-xl shadow-inner">
            <span class="text-4xl">${conquista.icone}</span>
            <p class="font-semibold text-gray-700 mt-2">${conquista.titulo}</p>
            <p class="text-xs text-gray-600 mt-1">${conquista.descricao}</p>
        </div>
    `).join('');
    
    if (conquistas.length === 0) {
        conquistasHTML = `
            <div class="col-span-full text-center p-8 bg-gray-100 rounded-xl">
                <p class="text-gray-600">Continue cuidando bem do(a) paciente para desbloquear conquistas! üåü</p>
            </div>
        `;
    }
    
    conquistasContent.innerHTML = `
        <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Conquistas de Cuidado (Gamifica√ß√£o)</h2>
        
        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 p-6 rounded-xl shadow-lg text-white mb-6">
            <div class="text-center">
                <div class="text-6xl font-extrabold">${stats.survival_probability.toFixed(0)}%</div>
                <div class="text-lg mt-2">Probabilidade de Recupera√ß√£o</div>
                <div class="text-sm opacity-90 mt-1">${stats.tasks_completed} tarefas completadas (${stats.task_progress}% hoje)</div>
            </div>
        </div>
        
        <p class="text-gray-500 mb-4">Reconhecimento pelo cuidado consistente e alcance de metas.</p>
        
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            ${conquistasHTML}
        </div>
    `;
}



/**
 * Modifica a fun√ß√£o changeDashboardTab para carregar dados quando necess√°rio
 */
const originalChangeDashboardTab = window.changeDashboardTab;
window.changeDashboardTab = function(tabName) {
    // Chama a fun√ß√£o original
    if (originalChangeDashboardTab) {
        originalChangeDashboardTab(tabName);
    }
    
    // Carrega dados espec√≠ficos da aba se necess√°rio
    if (!currentPatientId) return;
    
    // Obt√©m o filtro de tempo selecionado
    const timeframeSelect = document.getElementById('filterTimeframe');
    const timeframe = timeframeSelect ? timeframeSelect.value : 'dia';
    
    // Calcula datas baseado no filtro
    let dataInicio, dataFim;
    dataFim = new Date().toISOString().slice(0, 19).replace('T', ' ');
    
    switch(timeframe) {
        case '6h':
            const sixHoursAgo = new Date();
            sixHoursAgo.setHours(sixHoursAgo.getHours() - 6);
            dataInicio = sixHoursAgo.toISOString().slice(0, 19).replace('T', ' ');
            break;
        case '12h':
            const twelveHoursAgo = new Date();
            twelveHoursAgo.setHours(twelveHoursAgo.getHours() - 12);
            dataInicio = twelveHoursAgo.toISOString().slice(0, 19).replace('T', ' ');
            break;
        case 'dia':
            const oneDayAgo = new Date();
            oneDayAgo.setDate(oneDayAgo.getDate() - 1);
            dataInicio = oneDayAgo.toISOString().slice(0, 19).replace('T', ' ');
            break;
        case 'semana':
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            dataInicio = oneWeekAgo.toISOString().slice(0, 19).replace('T', ' ');
            break;
    }
    
    // Carrega dados conforme a aba
    switch(tabName) {
        case 'nutrologia-content':
            loadNutritionData(currentPatientId, dataInicio, dataFim);
            break;
        case 'farmacia-content':
            loadPharmacyData(currentPatientId, dataInicio, dataFim);
            break;
        case 'exames-content':
            loadExamsData(currentPatientId, dataInicio, dataFim);
            break;
        case 'procedimentos-content':
            loadProceduresData(currentPatientId, dataInicio, dataFim);
            break;
        case 'conquistas-content':
            loadAchievementsData(currentPatientId, dataInicio, dataFim);
            break;
    }
};

/**
 * Listener para o filtro de per√≠odo
 */
document.addEventListener('DOMContentLoaded', () => {
    const filterTimeframe = document.getElementById('filterTimeframe');
    if (filterTimeframe) {
        filterTimeframe.addEventListener('change', () => {
            // Recarrega a aba atual com o novo filtro
            const activeTab = document.querySelector('.patient-content-module.active-content');
            if (activeTab && currentPatientId) {
                changeDashboardTab(activeTab.id);
            }
        });
    }
    
    // [INSERIR AQUI O C√ìDIGO DA SPLASH SCREEN DO PASSO 3]
    const splashScreen = document.getElementById('splash-screen');
    setTimeout(() => {
        if (splashScreen) {
            splashScreen.classList.add('hidden');
            setTimeout(() => { splashScreen.remove(); }, 800);
        }
    }, 2500); 

});


/* --- L√ìGICA DO HUB DE CUIDADO (Anteriormente Patient Dashboard) --- */

let currentCareHubPid = null;
let hubDecisions = [];
let hubDecisionIdx = 0;

function handleAvatarClick(eventOrElement) {
    let el = null;
    if (!eventOrElement) return;

    // Se foi passado um Event, extrai o elemento clicado
    if (eventOrElement instanceof Event) {
        eventOrElement.preventDefault?.();
        eventOrElement.stopPropagation?.();
        el = eventOrElement.target ? eventOrElement.target.closest('[data-patient-id], #patientAvatar, .patient-avatar') : null;
    } else if (eventOrElement instanceof HTMLElement) {
        el = eventOrElement;
    } else {
        el = document.getElementById('patientAvatar') || document.querySelector('.patient-avatar');
    }

    console.log('[handleAvatarClick] elemento clicado:', el);

    // 1) Procurar patientId em data-atributo
    let pid = el?.dataset?.patientId || el?.getAttribute?.('data-patient-id') || null;
    let name = el?.dataset?.patientName || el?.getAttribute?.('data-patient-name') || null;
    let avatar = el?.getAttribute?.('src') || el?.dataset?.avatarUrl || null;

    // 2) Procurar nos estados globais (PRIORIDADE ALTA)
    if (!pid) {
        // Tenta pegar o ID Num√©rico do State primeiro (que √© o ideal para APIs)
        if (window.state && state.patientId) {
            pid = state.patientId;
            name = name || (state.patient && (state.patient.nickname || state.patient.name));
            avatar = avatar || (state.patient && state.patient.avatarUrl);
        } else if (window.state && state.patientCode) {
            // Se n√£o tiver ID num√©rico, usa o c√≥digo visual
            pid = state.patientCode;
        } else if (typeof selectedPatient !== 'undefined' && selectedPatient && selectedPatient.id) {
            pid = selectedPatient.id;
        } else {
            // --- CORRE√á√ÉO AQUI (Fallback do DOM) ---
            const domIdElement = document.getElementById('pacientIdDisplay') || document.getElementById('patientIdDisplay');
            if (domIdElement) {
                const text = (domIdElement.innerText || domIdElement.textContent || '').trim();
                
                // ANTES (Causava erro): pid = text.replace(/\D+/g, '') || null;
                
                // AGORA (Correto): Remove apenas "C√≥d:", "ID:", espa√ßos e mant√©m letras/n√∫meros
                // Remove tudo que N√ÉO for letra (a-z) ou n√∫mero (0-9)
                pid = text.replace(/[^a-zA-Z0-9]/g, '') || null;
            }
        }
    }

    // 3) Se ainda n√£o temos pid, avisar
    if (!pid) {
        console.warn('[handleAvatarClick] patientId n√£o encontrado.', { state: window.state });
        showModal('Falha','Erro: n√£o foi poss√≠vel identificar o paciente (ID ou C√≥digo ausente).');
        return;
    }

    // Garantir string
    pid = String(pid);

    // Atualiza o state global se necess√°rio
    if (window.state) {
        // Se o PID encontrado for num√©rico ou c√≥digo, garantimos que o state tenha algo
        if (!state.patientId) state.patientId = pid; 
    }

    // Chama a fun√ß√£o principal
    openCareHub(pid, name || (state.patient && state.patient.nickname) || 'Paciente', avatar || null);
}

let hubEmergencyLogs = [];
let hubEmergencyLogIndex = 0;

function atualizarTrofeuSurvivor(pacienteCreatedAt) {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    // console.log("Iniciando Trof√©u com data:", pacienteCreatedAt);
    
    if (!pacienteCreatedAt) {
        console.warn("Data de cria√ß√£o n√£o fornecida");
        return;
    }

    // 1. TRATAMENTO DA DATA
    const dataFormatada = pacienteCreatedAt.replace(" ", "T");
    const dataInicio = new Date(dataFormatada); 

    const elCountdown = document.getElementById('survivor-countdown');

    if (isNaN(dataInicio.getTime())) {
        console.error("Data inv√°lida convertida:", dataFormatada);
        if (elCountdown) elCountdown.innerText = t['msgDatePending'] || "Data de in√≠cio pendente";
        return;
    }

    // 2. VERIFICA√á√ÉO DOS ELEMENTOS
    const btn = document.getElementById('btn-overall-survivor');
    const progressBar = document.getElementById('survivor-progress-bar');
    
    if (!btn || !progressBar || !elCountdown) return;

    // 3. C√ÅLCULOS
    const dataCuraGarantida = new Date(dataInicio);
    dataCuraGarantida.setFullYear(dataCuraGarantida.getFullYear() + 5); 
    
    const agora = new Date();
    const tempoTotal = dataCuraGarantida - dataInicio;
    const tempoDecorrido = agora - dataInicio;
    const tempoRestante = dataCuraGarantida - agora;

    // C√°lculo de porcentagem
    let progresso = (tempoDecorrido / tempoTotal) * 100;
    progresso = Math.min(Math.max(progresso, 0), 100);
    progressBar.style.width = progresso + "%";

    const vitoriaAlcancada = tempoRestante <= 0;

    if (!vitoriaAlcancada) {
        // --- MODO: EM JORNADA ---
        const anos = Math.floor(tempoRestante / (1000 * 60 * 60 * 24 * 365.25)); 
        const dias = Math.floor((tempoRestante % (1000 * 60 * 60 * 24 * 365.25)) / (1000 * 60 * 60 * 24));
        const horas = Math.floor((tempoRestante % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        
        // TRADU√á√ÉO: Countdown
        const templateCountdown = t['survivorCountdown'] || "{a}a {d}d {h}h para Celebra√ß√£o Suprema";
        elCountdown.innerText = templateCountdown
            .replace('{a}', anos)
            .replace('{d}', dias)
            .replace('{h}', horas);

        btn.onclick = () => {
            if (typeof Swal !== 'undefined') {
                if(typeof forceCloseCareHub === 'function') forceCloseCareHub();
                
                // TRADU√á√ÉO: Modal Informativo
                // Constru√ß√£o do HTML usando as chaves traduzidas
                const htmlContent = `
                    <div class="text-left text-sm space-y-3 z-[99999]">
                        <p>${t['survivorInfoP1']}</p>
                        <p>${t['survivorInfoP2']}</p>
                        <p>${t['survivorInfoP3']}</p>
                        <p>${t['survivorInfoFooter'].replace('{a}', anos).replace('{d}', dias)}</p>
                    </div>`;

                Swal.fire({
                    title: t['survivorInfoTitle'] || 'O Caminho Her√≥ico',
                    html: htmlContent,
                    icon: 'info',
                    confirmButtonText: t['btnKeepCaring'] || 'Continuar Cuidando',
                    confirmButtonColor: '#d4af37'
                });
            }
        };
    } else {       
        // --- MODO: VIT√ìRIA ---
        
        // TRADU√á√ÉO: Bot√£o Vit√≥ria
        elCountdown.innerText = t['survivorVictoryBtnLabel'] || "VIT√ìRIA ALCAN√áADA! CLIQUE AQUI!";
        btn.classList.add('animate-victory-glow');
        
        btn.onclick = () => {
            if(typeof forceCloseCareHub === 'function') forceCloseCareHub();
            if (typeof lancarConfetes === 'function') lancarConfetes();
            
            if (typeof Swal !== 'undefined') {
                // TRADU√á√ÉO: Modal de Vit√≥ria
                Swal.fire({
                    title: t['survivorVictoryTitle'] || 'üéä SUPER VIVENTE ABSOLUTO üéä',
                    html: `
                        <div class="text-center p-2">
                            <div class="relative inline-block mb-6">
                                <div class="absolute inset-0 bg-yellow-400 blur-2xl opacity-30 animate-pulse"></div>
                                <div class="text-7xl relative">üèÜ</div>
                            </div>

                            <h2 class="text-3xl font-black text-amber-600 mb-2 tracking-tight">${t['survivorVictorySubtitle']}</h2>
                            <p class="text-gray-600 italic mb-6">"${t['survivorVictoryQuote']}"</p>
                            
                            <div class="bg-amber-50 rounded-2xl p-6 border border-amber-100 shadow-inner">
                                <p class="font-bold text-amber-900 mb-4 text-lg">${t['survivorVictoryListTitle']}</p>
                                
                                <ul class="text-left space-y-4">
                                    <li class="flex items-start gap-3">
                                        <span class="bg-white p-1 rounded-lg shadow-sm">üé¨</span>
                                        <span class="text-amber-950 text-sm"><b>${t['survivorActionInspireTitle']}</b> ${t['survivorActionInspireDesc']}</span>
                                    </li>
                                    <li class="flex items-start gap-3">
                                        <span class="bg-white p-1 rounded-lg shadow-sm">üôè</span>
                                        <span class="text-amber-950 text-sm"><b>${t['survivorActionGratitudeTitle']}</b> ${t['survivorActionGratitudeDesc']}</span>
                                    </li>
                                    <li class="flex items-start gap-3">
                                        <span class="bg-white p-1 rounded-lg shadow-sm">ü§ù</span>
                                        <span class="text-amber-950 text-sm"><b>${t['survivorActionMentorshipTitle']}</b> ${t['survivorActionMentorshipDesc']}</span>
                                    </li>
                                </ul>
                            </div>

                            <div class="mt-6">
                                <p class="text-xl font-serif italic text-amber-700 font-bold">
                                    ${t['survivorVictoryFinalMsg']}
                                </p>
                            </div>
                        </div>`,
                    width: '600px',
                    padding: '2em',
                    background: '#fff url(https://www.transparenttextures.com/patterns/white-diamond.png)',
                    confirmButtonText: t['btnCelebrateLife'] || '‚ú® CELEBRAR A VIDA ‚ú®',
                    confirmButtonColor: '#d97706',
                    customClass: {
                        title: 'text-2xl font-black text-amber-700',
                        confirmButton: 'rounded-full px-10 py-4 uppercase tracking-widest hover:scale-105 transition-transform'
                    },
                    backdrop: `rgba(255, 215, 0, 0.2)`
                });
            }
        };
    }
}

// Fun√ß√£o auxiliar para confetes
function lancarConfetes() {
    // Se voc√™ n√£o tiver uma lib de confete, este √© um alerta visual r√°pido
    const duration = 15 * 1000;
    const animationEnd = Date.now() + duration;
    // Exemplo de integra√ß√£o com Canvas-Confetti se dispon√≠vel:
    if(typeof confetti !== 'undefined') {
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
    }
}

/* --- FUN√á√ÉO DE ABRIR (For√ßa visualiza√ß√£o) --- */
// === Substituir: openCareHub ===
function openCareHub(pid, name, avatar) {
    if (!pid) {
        console.error('[openCareHub] pid inv√°lido:', pid);
        showModal('Falha','Erro: patient id inv√°lido ao abrir Care Hub.');
        return;
    }

    console.log('[openCareHub] Abrindo Care Hub para paciente:', pid);

    // Normalizar
    pid = String(pid);

    // Atualiza vari√°veis de estado globais
    currentCareHubPid = pid;
    if (window.state) {
        state.patientId = pid;
        if (!state.patient) state.patient = {};
        if (name) state.patient.nickname = name;
    }

    // Atualiza UI
    const nameEl = document.getElementById('hub-patient-name');
    const avatarEl = document.getElementById('hub-avatar');
    if (nameEl) nameEl.innerText = name || (state.patient && state.patient.nickname) || "Paciente";
    if (avatarEl) {
        if (avatar) {
            avatarEl.src = avatar;
            avatarEl.hidden = false;
        } else {
            avatarEl.src = "https://placehold.co/100x100";
            avatarEl.hidden = false;
        }
    }
    

    // Abrir modal (classe 'active' ou remover 'hidden' dependendo do seu CSS)
    const modal = document.getElementById('modal-care-hub');
    if (!modal) {
        showModal('Falha','Erro: modal care hub n√£o encontrado no DOM.');
        return;
    }

    // Garantir que o modal esteja vis√≠vel: preferir classes j√° usadas no projeto
    modal.classList.remove('hidden');
    modal.classList.add('flex', 'active');

    // Opcional: v√° para a tela de dashboard se necess√°rio
    // goToScreen(Screens.DASHBOARD); // Descomente se precisar for√ßar a navega√ß√£o de tela

    // Carregamento dos dados do hub usando o pid atualizado
    try {
        hubLoadDecisions(pid);
    } catch (e) { console.warn('hubLoadDecisions falhou:', e); }
    try {
        hubLoadHistoryData(pid);
    } catch (e) { console.warn('hubLoadHistoryData falhou:', e); }
    try {
        hubLoadPatientDetails(pid);
    } catch (e) { console.warn('hubLoadPatientDetails falhou:', e); }
    try {
        hubLoadEmergencyLogs(pid);
    } catch (e) { console.warn('hubLoadEmergencyLogs falhou:', e); }

    // For√ßa um pequeno scroll/top para abrir corretamente em dispositivos m√≥veis (melhora UX)
    modal.scrollTop = 0;
}

function hubLoadEmergencyLogs() {
    fetch(`api.php?action=get-emergency-logs&patientId=${state.patientId}`)
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            hubEmergencyLogs = data.data;
            hubEmergencyLogIndex = 0; // Reseta para o mais recente (√≠ndice 0)
            hubRenderEmergencyLog();
        }
    })
    .catch(err => console.error("Erro ao carregar logs:", err));
}

function hubRenderEmergencyLog() {
    const display = document.getElementById('hub-emergency-log-display');
    
    if (hubEmergencyLogs.length === 0) {
        display.innerHTML = `<p class="text-xs text-gray-400">Nenhum registro recente.</p>`;
        return;
    }

    const log = hubEmergencyLogs[hubEmergencyLogIndex];
    
    // Formata data e hora
    const dateObj = new Date(log.created_at);
    const dateStr = dateObj.toLocaleDateString('pt-BR');
    const timeStr = dateObj.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
    
    // Formata o ID ou Nome do Cuidador
    const caregiverInfo = log.caregiver_name ? log.caregiver_name : `ID: ${log.caregiver_id}`;

    display.innerHTML = `
        <div class="animate-fade-in">
            <p class="text-xs font-bold text-gray-800">${log.action_type}</p>
            <p class="text-[10px] text-gray-500">
                ${dateStr} √†s ${timeStr} ‚Ä¢ Por: <span class="text-indigo-600 font-medium">${caregiverInfo}</span>
            </p>
            <p class="text-[9px] text-gray-400 mt-1">Registro ${hubEmergencyLogs.length - hubEmergencyLogIndex} de ${hubEmergencyLogs.length}</p>
        </div>
    `;
}

function hubNavigateEmergencyLog(direction) {
    if (hubEmergencyLogs.length === 0) return;

    // Direction 1 = Anterior (vai para √≠ndice maior, pois a lista vem DESC do banco)
    // Direction -1 = Recente (vai para √≠ndice menor)
    const newIndex = hubEmergencyLogIndex + direction;

    if (newIndex >= 0 && newIndex < hubEmergencyLogs.length) {
        hubEmergencyLogIndex = newIndex;
        hubRenderEmergencyLog();
    }
}

function closeCareHub(e) {
    // S√≥ fecha se clicar no fundo escuro (ID modal-care-hub) e n√£o no conte√∫do interno
    if (e.target.id === 'modal-care-hub') {
        const modal = document.getElementById('modal-care-hub');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }
}

// (Opcional) Fun√ß√£o para fechar via bot√£o X ou cancelar
function forceCloseCareHub() {
    const modal = document.getElementById('modal-care-hub');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
}


// 1. Emerg√™ncia
async function hubLogEmergency(type) {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    // Tradu√ß√£o do t√≠tulo e mensagem din√¢mica
    const titleConfirm = t['titleLogEmergency'] || 'Registrar Emerg√™ncia';
    const msgTemplate = t['msgConfirmEmergency'] || 'Deseja registrar "{type}" agora?';
    const msgConfirm = msgTemplate.replace('{type}', type); // Ex: Deseja registrar "Queda" agora?
    const btnLabel = t['btnRegister'] || 'Registrar';

    // Confirma√ß√£o visual
    const confirmed = await customConfirm(
        titleConfirm, 
        msgConfirm, 
        btnLabel, 
        'bg-red-600'
    );

    if (!confirmed) return;

    // Configura√ß√£o do GPS para n√£o esperar eternamente
    const geoOptions = {
        enableHighAccuracy: true,
        timeout: 10000, 
        maximumAge: 0
    };

    // Feedback opcional de "Obtendo localiza√ß√£o..." poderia ser adicionado aqui

    navigator.geolocation.getCurrentPosition(async (pos) => {
        try {
            const response = await fetch(`api.php?action=log-emergency`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Timezone': (typeof userTimezone !== 'undefined' ? userTimezone : 'UTC'),
                    'X-Lang': (typeof currentLang !== 'undefined') ? currentLang : 'pt'
                },
                body: JSON.stringify({
                    patientId: (typeof state !== 'undefined') ? state.patientId : null,
                    caregiverId: localStorage.getItem('userId'),
                    actionType: type,
                    lat: pos.coords.latitude,
                    lon: pos.coords.longitude
                })
            });
            
            // Verifica se a requisi√ß√£o foi bem sucedida (HTTP 200-299)
            if (response.ok) {
                // TRADU√á√ÉO: Mensagem de Sucesso
                const msgSuccess = t['msgEmergencySaved'] || "‚úÖ Registro de emerg√™ncia salvo com sucesso!";
                
                if (typeof showCelebrationMessage === 'function') {
                    showCelebrationMessage(msgSuccess);
                } else {
                    showModal(t['modalSuccessTitle'] || 'Sucesso', msgSuccess);
                }

                if (typeof hubLoadEmergencyLogs === 'function') {
                    hubLoadEmergencyLogs(); 
                }
            } else {
                console.error("Erro na API");
                showModal(t['modalErrorTitle'] || 'Erro', t['msgGenericError'] || 'Ocorreu um erro ao salvar.');
            }

        } catch (error) {
            console.error(error);
            showModal(t['modalErrorTitle'] || 'Erro', t['msgConnectionError'] || 'Erro de conex√£o.');
        }

    }, (error) => {
        console.warn("Erro GPS:", error);
        // TRADU√á√ÉO: Erro de Localiza√ß√£o
        const titleLoc = t['titleLocationAccess'] || "Acesso √† Localiza√ß√£o";
        const msgLoc = t['msgLocationRequiredEmergency'] || "Por favor, permita a localiza√ß√£o para registrar a emerg√™ncia.";
        
        showModal(titleLoc, msgLoc);
    }, geoOptions);
}

// 2. Hist√≥ria
let hubIsReadMode = false;
function hubToggleHistoryView() {
    // L√≥gica para alternar visualiza√ß√£o
    // Se o usu√°rio est√° tentando abrir o modo de leitura (ReadMode), verificamos o Premium
    
    if (!hubIsReadMode) { // Ele quer ir para o modo leitura
        
        // üõë GATILHO PREMIUM
        if (!checkPremiumFeature()) return; 
        
        // Se passou, executa a troca de tela
        hubIsReadMode = true;
        document.getElementById('hub-history-write-mode').classList.add('hidden');
        document.getElementById('hub-history-read-mode').classList.remove('hidden');
        document.getElementById('hub-btn-toggle-history').innerText = "Escrever Hist√≥ria";
        hubLoadHistoryData(); // Carrega os dados
        
    } else {
        // Voltar para escrever √© gr√°tis (nunca bloqueie a entrada de dados!)
        hubIsReadMode = false;
        document.getElementById('hub-history-write-mode').classList.remove('hidden');
        document.getElementById('hub-history-read-mode').classList.add('hidden');
        document.getElementById('hub-btn-toggle-history').innerText = "Ler Hist√≥rias";
    }
}

function hubSaveHistory() {
    const content = document.getElementById('hub-history-input').value;
    if(!content.trim()) {
        showStatusMessage("‚ö†Ô∏è Escreva algo para salvar.");
        return;
    }

    navigator.geolocation.getCurrentPosition(pos => {
        fetch(`api.php?action=save-history`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Timezone': userTimezone 
            },
            body: JSON.stringify({
                patientId: state.patientId,
                caregiverId: localStorage.getItem('userId'),
                content: content,
                isPublic: document.getElementById('hub-history-public').checked,
                lat: pos.coords.latitude,
                lon: pos.coords.longitude
            })
        }).then(res => res.json()).then(data => {
            if(data.success) {
                // Mensagem motivadora
                showCelebrationMessage("‚ú® Hist√≥ria salva no di√°rio!");
                document.getElementById('hub-history-input').value = '';
                // Se estiver no modo leitura, recarrega
                if(typeof hubIsReadMode !== 'undefined' && hubIsReadMode) {
                    hubLoadHistoryData();
                }
            } else {
                showModal("Erro", "N√£o foi poss√≠vel salvar a hist√≥ria.");
            }
        });
    }, () => showModal("Localiza√ß√£o Necess√°ria", "Ative o GPS para registrar o di√°rio."));
}

function hubLoadHistoryData() {
    fetch(`api.php?action=get-history&patientId=${state.patientId}`)
        .then(res => res.json())
        .then(data => {
            const container = document.getElementById('hub-history-read-mode');
            container.innerHTML = "";
            if(data.data.length === 0) {
                container.innerHTML = "<p class='text-center text-gray-500'>Nenhuma hist√≥ria ainda.</p>";
                return;
            }
            data.data.forEach(post => {
                const date = new Date(post.created_at).toLocaleDateString('pt-BR');
                const html = `
                    <div class="bg-white p-3 rounded shadow-sm border border-gray-100">
                        <div class="flex justify-between text-xs text-gray-500 mb-1">
                            <strong>${post.author_name || 'Cuidador'}</strong>
                            <span>${date}</span>
                        </div>
                        <p class="text-sm text-gray-800 whitespace-pre-wrap">${post.content}</p>
                    </div>
                `;
                container.innerHTML += html;
            });
        });
}

// 3. Decis√µes
function hubOpenNewDecisionForm() {
    // üõë GATILHO PREMIUM
    // Tenta passar pelo guarda. Se ele disser n√£o, a fun√ß√£o para aqui.
    if (!checkPremiumFeature()) return; 

    // Se passou, executa o c√≥digo original
    document.getElementById('hub-new-decision-form').classList.remove('hidden');
}

function hubSubmitNewDecision() {
    const title = document.getElementById('hub-new-dec-title').value;
    const desc = document.getElementById('hub-new-dec-desc').value;
    const deadline = document.getElementById('hub-new-dec-deadline').value;
    const options = Array.from(document.querySelectorAll('.hub-new-dec-opt')).map(i => i.value);

    if(!title || !options[0]) {
        showModal("Aten√ß√£o", "Preencha o t√≠tulo e pelo menos uma op√ß√£o para vota√ß√£o.");
        return;
    }

    fetch(`api.php?action=create-decision`, {
        method: 'POST',
        headers: {
        'Content-Type': 'application/json',
        'X-Timezone': userTimezone // <--- ADICIONE ISSO
        },
        body: JSON.stringify({
            patientId: state.patientId,
            caregiverId: localStorage.getItem('userId'),
            title: title,
            description: desc,
            deadline: deadline,
            options: options            
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showCelebrationMessage("üó≥Ô∏è Nova decis√£o criada com sucesso!");
            document.getElementById('hub-new-decision-form').classList.add('hidden');
            
            // Limpa o formul√°rio
            document.getElementById('hub-new-dec-title').value = '';
            document.getElementById('hub-new-dec-desc').value = '';
            document.getElementById('hub-new-dec-deadline').value = '';
            
            hubLoadDecisions();
        } else {
            showModal("Erro", "Erro ao criar decis√£o: " + (data.message || "Tente novamente."));
        }
    })
    .catch(err => showModal("Erro de Conex√£o", "Verifique sua internet."));
}

function hubLoadDecisions() {
    const uid = localStorage.getItem('userId');
    fetch(`api.php?action=get-decisions&patientId=${state.patientId}&userId=${uid}`)
        .then(res => res.json())
        .then(data => {
            hubDecisions = data.data;
            hubDecisionIdx = 0;
            hubRenderDecision();
        });
}

function hubRenderDecision() {
    const display = document.getElementById('hub-decision-display-area');
    //const currentUserId = localStorage.getItem('userId'); 
    const currentUserId = state.userId; 

    console.log('--- DEBUG BOT√ÉO DELETAR ---');
    console.log('Meu ID (localStorage):', currentUserId);
    
    // 1. Verifica√ß√£o de dados
    if(!hubDecisions || !hubDecisions.length) {
        display.innerHTML = `<div class="text-center text-gray-500 text-sm py-4">Nenhuma decis√£o ativa.</div>`;
        return;
    }
    
    // Define a decis√£o atual antes de qualquer outra l√≥gica
    const dec = hubDecisions[hubDecisionIdx];
    
    // --- 2. L√≥gica do Bot√£o de Deletar (Agora com 'dec' definido) ---
    let deleteButtonHtml = '';
    // Nota: Use 'dec.criador_id' ou 'dec.author_id' conforme o retorno da sua API
    if (dec.created_by_caregiver_id == currentUserId && dec.status !== 'concluded') {
        deleteButtonHtml = `
            <div class="mt-6 border-t pt-4">
                <button 
                    onclick="deleteDecision(${dec.id})"
                    class="bg-red-50 hover:bg-red-100 text-red-600 font-bold py-2 px-4 rounded-lg border border-red-200 shadow-sm flex items-center gap-2 transition-colors w-full justify-center text-xs"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Cancelar e Excluir Vota√ß√£o
                </button>
                <p class="text-[9px] text-gray-400 mt-2 text-center">Aten√ß√£o: Esta a√ß√£o remover√° permanentemente a consulta e os votos.</p>
            </div>
        `;
    } 

    // --- 3. L√≥gica do Prazo ---
    let deadlineHtml = '';
    let isExpired = false; 
    
    if(dec.deadline) {
        const dateStr = dec.deadline.replace(' ', 'T'); 
        const d = new Date(dateStr);
        const now = new Date();
        
        isExpired = now > d;
        const colorClass = isExpired ? 'text-red-600 bg-red-50 border-red-200' : 'text-orange-600 bg-orange-50 border-orange-200';
        const textLabel = isExpired ? 'Encerrado em' : 'Vota√ß√£o at√©';
        
        const dateFmt = d.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'});
        const timeFmt = d.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});

        deadlineHtml = `
            <div class="inline-flex items-center gap-1 px-2 py-1 rounded text-[10px] font-bold ${colorClass} border self-start whitespace-nowrap">
                <span>‚è≥ ${textLabel} ${dateFmt} √†s ${timeFmt}</span>
            </div>
        `;
    }

    // --- 4. Renderiza√ß√£o das Op√ß√µes ---
    let optionsHtml = '';
    dec.options.forEach(opt => {
        const isSelected = dec.my_vote_option_id == opt.id;
        const borderClass = isSelected ? 'border-indigo-500 ring-1 ring-indigo-500 bg-indigo-50' : 'border-gray-200 hover:border-indigo-300';
        const checkIcon = isSelected ? '‚úÖ' : '‚ö™';
        const votersList = opt.voters_names ? opt.voters_names.replace(/,/g, ', ') : 'Nenhum voto ainda';
        
        optionsHtml += `
            <div class="mb-2 bg-white rounded-lg border ${borderClass} transition-all overflow-hidden group">
                <div class="flex items-stretch min-h-[40px]">
                    <button onclick="hubVoteDecision(${dec.id}, ${opt.id}, event)" class="w-12 flex items-center justify-center border-r border-gray-100 hover:bg-indigo-100 cursor-pointer transition-colors" title="Votar nesta op√ß√£o" ${isExpired ? 'disabled' : ''}>
                        <span class="text-lg transform group-hover:scale-110 transition-transform ${isExpired ? 'opacity-50 grayscale' : ''}">${checkIcon}</span>
                    </button>
                    
                    <div onclick="toggleVoterList('voters-${opt.id}')" class="flex-grow p-2 flex justify-between items-center cursor-pointer hover:bg-gray-50">
                        <span class="text-sm font-medium text-gray-700 select-none">${opt.option_text}</span>
                        <div class="flex items-center gap-1">
                             <span class="text-xs font-bold text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full">${opt.vote_count}</span>
                             <span class="text-[10px] text-gray-400">‚ñº</span>
                        </div>
                    </div>
                </div>
                <div id="voters-${opt.id}" class="hidden bg-gray-50 p-2 border-t border-gray-100 text-xs text-gray-600 italic">
                    <strong>Votos:</strong> ${votersList}
                </div>
            </div>
        `;
    });

    // --- 5. Formul√°rio de "Adicionar Op√ß√£o" ---
    let addOptionFormHtml = '';
    if (!isExpired) {
        addOptionFormHtml = `
            <div class="mt-3 pt-3 border-t border-dashed border-gray-200">
                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 block">Sugerir nova alternativa:</label>
                <div class="flex gap-2">
                    <input type="text" id="new-opt-input-${dec.id}" placeholder="Descreva vantagens..." class="flex-grow text-xs p-2 border border-gray-300 rounded focus:border-indigo-500 outline-none">
                    <button onclick="hubAddOptionToDecision(${dec.id})" class="bg-indigo-100 text-indigo-700 hover:bg-indigo-200 px-3 py-1 rounded text-xs font-bold transition-colors">
                        + Adicionar
                    </button>
                </div>
            </div>
        `;
    } else {
        addOptionFormHtml = `<div class="mt-3 pt-2 border-t border-gray-100 text-center"><span class="text-[10px] text-gray-400 italic">Vota√ß√£o encerrada.</span></div>`;
    }

    // --- 6. Montagem Final ---
    display.innerHTML = `
        <div class="bg-white p-4 rounded-xl shadow-sm border border-indigo-100 relative">
            <div class="flex justify-between items-start gap-2 mb-2">
                <h4 class="font-bold text-indigo-900 text-lg leading-tight">${dec.title}</h4>
                ${deadlineHtml}
            </div>
            
            <p class="text-xs text-gray-600 mb-4 bg-gray-50 p-2 rounded border border-gray-100">
                ${dec.description || 'Sem detalhes adicionais.'}
            </p>
            
            <div class="space-y-1">
                ${optionsHtml}
            </div>

            ${addOptionFormHtml}
            
            <div class="mt-3 flex justify-between items-end pt-2">
                <p class="text-[10px] text-gray-400">Criado por ${dec.author}</p>                
                <p class="text-[10px] text-indigo-400">Toque no texto para ver votos</p>
            </div>

            ${deleteButtonHtml}
        </div>
    `;
    
    document.getElementById('hub-decision-status').innerText = `${hubDecisionIdx + 1}/${hubDecisions.length}`;
}


function hubAddOptionToDecision(decisionId) {
    const inputId = `new-opt-input-${decisionId}`;
    const input = document.getElementById(inputId);
    const newText = input.value.trim();

    if (!newText) {
        showStatusMessage("‚ö†Ô∏è Digite o texto da nova op√ß√£o.");
        return;
    }

    input.disabled = true;

    fetch(`api.php?action=add-decision-option`, {
        method: 'POST',
        headers: {
        'Content-Type': 'application/json',
        'X-Timezone': userTimezone // <--- ADICIONE ISSO
        },
        body: JSON.stringify({
            decisionId: decisionId,
            optionText: newText,
            caregiverId: localStorage.getItem('userId')            
        })
    })
    .then(res => res.json())
    .then(data => {
        input.disabled = false;
        if (data.success) {
            showStatusMessage("‚úÖ Op√ß√£o adicionada!");
            hubLoadDecisions();
        } else {
            showModal("Erro", data.message);
        }
    })
    .catch(err => {
        input.disabled = false;
        showModal("Erro", "Erro de conex√£o ao adicionar op√ß√£o.");
    });
}

// Fun√ß√£o auxiliar para mostrar/esconder a lista de nomes
function toggleVoterList(elementId) {
    const el = document.getElementById(elementId);
    if(el.classList.contains('hidden')) {
        el.classList.remove('hidden');
    } else {
        el.classList.add('hidden');
    }
}

function hubNavigateDecision(dir) {
    if(!hubDecisions.length) return;
    hubDecisionIdx += dir;
    if(hubDecisionIdx < 0) hubDecisionIdx = 0;
    if(hubDecisionIdx >= hubDecisions.length) hubDecisionIdx = hubDecisions.length - 1;
    hubRenderDecision();
}

function hubVoteDecision(did, oid, event) {
    if(event) event.stopPropagation();
    
    fetch(`api.php?action=vote-decision`, {
        method: 'POST',
        headers: {
        'Content-Type': 'application/json',
        'X-Timezone': userTimezone // <--- ADICIONE ISSO
        },
        body: JSON.stringify({
            decisionId: did,
            optionId: oid,
            caregiverId: localStorage.getItem('userId')            
        })
    }).then(res => res.json()).then(data => {
        // Feedback visual motivador
        if(data.success || data.message.includes('sucesso')) {
            showCelebrationMessage(data.message || "Voto computado! ‚úÖ");
        } else {
            showStatusMessage(data.message);
        }
        // Recarrega para ver a atualiza√ß√£o dos votos
        hubLoadDecisions();
    });
}

function hubOpenAddMember() {
    // üõë GATILHO PREMIUM
    if (!checkPremiumFeature()) return;

    // Se passou, abre o formul√°rio de convite
    document.getElementById('hub-add-member-form').classList.toggle('hidden');
}

function hubInviteMember() {
    const email = document.getElementById('hub-invite-email').value;
    fetch(`api.php?action=invite-member`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Timezone': userTimezone 
        },
        body: JSON.stringify({
            patientId: state.patientId,
            email: email            
        })
    }).then(res => res.json()).then(data => showModal("Resultado",data.message));
}

// 4. Doen√ßa e Fim
function hubToggleDiseaseForm() {
    const form = document.getElementById('hub-disease-form');
    form.classList.toggle('hidden');
}

function hubUpdateDiseaseInfo() {
    const illness = document.getElementById('hub-illness-type').value;
    const subtype = document.getElementById('hub-illness-subtype').value;

    if(!illness) {
        showStatusMessage("‚ö†Ô∏è Selecione o tipo da doen√ßa.");
        return;
    }

    // 1. Defini√ß√£o robusta do ID do Paciente
    // Prioriza o ID do Hub se estiver aberto, sen√£o usa o do estado global (Configura√ß√µes)
    const targetPid = (typeof currentCareHubPid !== 'undefined' && currentCareHubPid) 
                      ? currentCareHubPid 
                      : (state && state.patientId ? state.patientId : null);

    if (!targetPid) {
        showModal("Erro Cr√≠tico", "ID do(a) paciente n√£o encontrado. Por favor, recarregue a p√°gina.");
        return;
    }

    const payload = {
        patientId: targetPid,
        caregiverId: localStorage.getItem('userId'),
        updateType: 'disease_update', // Garanta que seu PHP trate isso fazendo UPDATE na tabela patients
        illness: illness,
        subtype: subtype,
        details: `Atualizado para ${illness} - ${subtype}`
    };
    
    // Adiciona geolocaliza√ß√£o se poss√≠vel, mas n√£o bloqueia se falhar
    navigator.geolocation.getCurrentPosition(
        (pos) => sendDiseaseUpdate({...payload, lat: pos.coords.latitude, lon: pos.coords.longitude}),
        () => sendDiseaseUpdate(payload) // Envia mesmo sem GPS
    );

    //altera o formul√°rio de configura√ß√µes
    const settingsInput = document.getElementById('settingsPatientIllness'); 
    // ou talvez o ID seja 'patient-illness' ou similar, verifique seu HTML
    if(settingsInput) {
        settingsInput.value = illness;
    }
}

// Fun√ß√£o auxiliar para enviar e tratar a resposta
function sendDiseaseUpdate(bodyData) {
    fetch(`api.php?action=update-disease-journey`, {
        method: 'POST',
        headers: {
        'Content-Type': 'application/json',
        'X-Timezone': userTimezone 
        },
        body: JSON.stringify(bodyData)        
    })
    .then(res => res.json())
    .then(data => {
        if(data.success) {
            showCelebrationMessage("üß¨ Diagn√≥stico salvo com sucesso!");
            
            // --- CORRE√á√ÉO PRINCIPAL DE ESTADO ---
            
            // 1. Atualiza o objeto state.patient IMEDIATAMENTE na mem√≥ria
            if (typeof state !== 'undefined') {
                if (!state.patient) state.patient = {};
                state.patient.illness = bodyData.illness;
                state.patient.illness_subtype = bodyData.subtype;
            }

            // 2. Atualiza visualmente o menu de configura√ß√µes (se estiver vis√≠vel)
            const settingsDisplay = document.getElementById('settings-current-diagnosis');
            if(settingsDisplay) {
                settingsDisplay.innerText = `${bodyData.illness} ${bodyData.subtype ? '- ' + bodyData.subtype : ''}`;
                // Adiciona um efeito visual para confirmar a mudan√ßa
                settingsDisplay.classList.add('text-green-600');
                setTimeout(() => settingsDisplay.classList.remove('text-green-600'), 2000);
            }

            // 3. Atualiza o Care Hub (se estiver vis√≠vel)
            const hubDisplay = document.getElementById('care-hub-diagnosis-display');
            if(hubDisplay) {
                hubDisplay.innerText = `${bodyData.illness} (${bodyData.subtype})`;
            }

            // 4. Fecha o modal
            hubToggleDiseaseForm();

        } else {
            showModal("Erro ao Salvar", "O servidor recusou a atualiza√ß√£o: " + (data.message || "Erro desconhecido"));
        }
    })
    .catch(err => {
        console.error(err);
        showModal("Erro de Conex√£o", "Verifique sua internet e tente novamente.");
    });
}

async function hubInitiateEndJourney() {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    // Confirma√ß√£o dupla com estilo visual de alerta (vermelho/escuro)
    const confirmed = await customConfirm(
        t['titleEndOfJourney'] || 'Fim da Jornada', 
        t['msgConfirmGrief'] || 'ATEN√á√ÉO: Esta a√ß√£o encerrar√° o ciclo de cuidados para este paciente. Deseja realmente confirmar o luto?', 
        t['btnConfirmGrief'] || 'Sim, Confirmar Luto', 
        'bg-gray-800' // Bot√£o escuro/s√©rio para luto
    );

    if (confirmed) {
        // Op√ß√µes para o GPS n√£o travar o app eternamente
        const geoOptions = {
            enableHighAccuracy: true,
            timeout: 10000, // 10 segundos m√°ximo
            maximumAge: 0
        };

        // Feedback de carregamento (opcional, mas recomendado)
        showStatusMessage(t['msgValidatingLocation'] || "Validando localiza√ß√£o...");

        navigator.geolocation.getCurrentPosition(async (pos) => {
            try {
                const response = await fetch(`api.php?action=update-disease-journey`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Timezone': (typeof userTimezone !== 'undefined' ? userTimezone : 'UTC'),
                        'X-Lang': (typeof currentLang !== 'undefined') ? currentLang : 'pt'
                    },
                    body: JSON.stringify({
                        patientId: state.patientId,
                        caregiverId: localStorage.getItem('userId'),
                        updateType: 'journey_end',
                        details: t['detailsJourneyEnded'] || 'Jornada encerrada.',
                        lat: pos.coords.latitude,
                        lon: pos.coords.longitude
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // TRADU√á√ÉO: Mensagem de Condol√™ncias
                    showModal(
                        t['titleJourneyEnded'] || "Jornada Encerrada", 
                        t['msgCondolences'] || "Meus sentimentos. O aplicativo ser√° reiniciado para atualizar os dados."
                    );
                    
                    setTimeout(() => {
                        const modal = document.getElementById('modal-care-hub');
                        if (modal) modal.classList.remove('active');
                        location.reload(); 
                    }, 3000);
                } else {
                    showModal(t['modalErrorTitle'] || 'Erro', data.message || (t['msgGenericError'] || 'Erro ao processar.'));
                }

            } catch (error) {
                console.error(error);
                showModal(t['modalErrorTitle'] || 'Erro', t['msgConnectionError'] || "Erro de conex√£o.");
            }
        }, (error) => {
            console.warn("Erro de GPS:", error);
            // TRADU√á√ÉO: Erro de Localiza√ß√£o
            showModal(t['modalErrorTitle'] || 'Erro', t['msgLocationRequired'] || "Necess√°rio localiza√ß√£o para validar o encerramento.");
        }, geoOptions);
    }
}

// --- Adicione esta fun√ß√£o para buscar os detalhes espec√≠ficos do paciente ---
function hubLoadPatientDetails() {
    // Busca os dados completos do paciente atual para preencher o formul√°rio
    fetch(`api.php?action=get-patient-details&patientId=${state.patientId}`)
    .then(res => res.json())
    .then(data => {
        if(data.success && data.patient) {
            // Preenche os campos do formul√°rio com o valor do banco de dados
            const illnessSelect = document.getElementById('hub-illness-type');
            const subtypeInput = document.getElementById('hub-illness-subtype');
            
            // Define o valor do select se existir na lista, sen√£o deixa em branco ou 'Outro'
            if(data.patient.illness) {
                illnessSelect.value = data.patient.illness;
            }
            
            if(data.patient.illness_subtype) {
                subtypeInput.value = data.patient.illness_subtype;
            }
        }
    })
    .catch(err => console.error("Erro ao carregar detalhes da doen√ßa:", err));
}

// --- Mantenha a fun√ß√£o de toggle (apenas visual) ---
function hubToggleDiseaseForm() {
    const form = document.getElementById('hub-disease-form');
    form.classList.toggle('hidden');
}

// 1. Fun√ß√£o de Filtragem (Esconde op√ß√µes que n√£o batem com a busca)
function hubFilterDiseaseList() {
    const input = document.getElementById("hub-disease-search");
    const filter = input.value.toUpperCase();
    const select = document.getElementById("hub-illness-type");
    const options = select.getElementsByTagName("option");
    const optgroups = select.getElementsByTagName("optgroup");

    // Mostra/Esconde op√ß√µes individuais
    for (let i = 0; i < options.length; i++) {
        const txtValue = options[i].textContent || options[i].innerText;
        if (txtValue.toUpperCase().indexOf(filter) > -1 || filter === "") {
            options[i].style.display = "";
        } else {
            options[i].style.display = "none";
        }
    }

    // Mostra/Esconde grupos vazios
    for (let i = 0; i < optgroups.length; i++) {
        const groupOptions = optgroups[i].getElementsByTagName("option");
        let hasVisible = false;
        for (let j = 0; j < groupOptions.length; j++) {
            if (groupOptions[j].style.display !== "none") {
                hasVisible = true;
                break;
            }
        }
        optgroups[i].style.display = hasVisible ? "" : "none";
    }
}

// 2. Fun√ß√£o Atualizada de Carregamento (Aciona o filtro automaticamente)
function hubLoadPatientDetails() {
    fetch(`api.php?action=get-patient-details&patientId=${state.patientId}`)
    .then(res => res.json())
    .then(data => {
        if(data.success && data.patient) {
            const illnessSelect = document.getElementById('hub-illness-type');
            const searchInput = document.getElementById('hub-disease-search');
            const subtypeInput = document.getElementById('hub-illness-subtype');

            if (data.patient.created_at) {
                    atualizarTrofeuSurvivor(data.patient.created_at);
            }
            
            if(data.patient.illness) {
                // AQUI EST√Å A CORRE√á√ÉO:               
                
                // 1. Pega a primeira palavra da doen√ßa salva (ex: "Leucemia" de "Leucemia Miel√≥ide")
                // Isso garante que filtraremos pela categoria principal.
                const mainTerm = data.patient.illness.split(' ')[0];
                
                // 2. Preenche o campo de busca com esse termo
                searchInput.value = mainTerm;
                
                // 3. Executa o filtro imediatamente para esconder o "lixo"
                hubFilterDiseaseList();
                
                // 4. Seleciona o item exato no select
                illnessSelect.value = data.patient.illness;
            } else {
                searchInput.value = "";
                hubFilterDiseaseList(); // Reseta lista se n√£o tiver doen√ßa
            }
            
            if(data.patient.illness_subtype) {
                subtypeInput.value = data.patient.illness_subtype;
            }
        }
    })
    .catch(err => console.error("Erro ao carregar detalhes:", err));
}

/* --- L√ìGICA DE MONETIZA√á√ÉO E EMPATIA --- */

let selectedPlan = 'annual';
let selectedMethod = 'card';

// Inicia com o valor padr√£o do Mensal
let currentPlanPrice = 214.00; 
let currentPlanName = "Plano Premium Anual";
let currentPlanType = "annual"; // √∫til para enviar ao backend se necess√°rio

console.log(`Estado Inicial: ${currentPlanName} - R$ ${currentPlanPrice}`);

// 1. Controle de UI do Modal
function openPremiumModal() {
    const modal = document.getElementById('modal-premium-hope');
    
    if (modal) {
        console.log('abriu modal-premium-hope');
        modal.classList.add('active');
        
        // Dispara o c√°lculo da cota√ß√£o (sem await, para n√£o travar a abertura visual)
        if (typeof mostrarPrecoInternacional === 'function') {
            mostrarPrecoInternacional();
        }
    } else {
        console.error('Erro: Modal #modal-premium-hope n√£o encontrado no HTML');
    }
}

function closePremiumModal(e) {
    if (e.target.id === 'modal-premium-hope') {
        // WINBACK TRIGGER: Ao tentar fechar clicando fora, mostramos o sino se for a primeira vez
        // Para demo, vamos mostrar sempre que tentar fechar sem comprar
        document.getElementById('modal-winback').style.display = 'block';
    }
}

// 2. Sele√ß√£o de Plano
function updatePlanUI(plan) {
    selectedPlan = plan;
        
    // ATUALIZA√á√ÉO DAS VARI√ÅVEIS GLOBAIS DE PAGAMENTO
    if (plan === 'annual') {
        currentPlanPrice = 214.00;
        currentPlanName = "Plano Premium Anual (1 ano)";
        currentPlanType = "annual";
    } else {
        // Assume que qualquer outra coisa √© 'monthly'
        currentPlanPrice = 29.90;
        currentPlanName = "Plano Premium Mensal";
        currentPlanType = "monthly";
    }

    // Log para confirmar a troca
    console.log(`üîÑ Plano alterado para: ${currentPlanName} | Valor: R$ ${currentPlanPrice}`);
}

// 3. Sele√ß√£o de M√©todo de Pagamento
function selectPayment(method) {
    selectedMethod = method;
    
    // Resetar estilos
    ['card', 'pix', 'paypal'].forEach(m => {
        const btn = document.getElementById(`btn-pay-${m}`);
        const isActive = m === method;
        btn.className = isActive 
            ? "flex-1 py-2 text-xs font-bold rounded border border-indigo-600 bg-indigo-50 text-indigo-700"
            : "flex-1 py-2 text-xs font-bold rounded border border-gray-200 bg-white text-gray-600 hover:bg-gray-50";
    });

    // Mostrar forms
    document.getElementById('payment-form-card').classList.add('hidden');
    document.getElementById('payment-form-pix').classList.add('hidden');
    
    if(method === 'card') document.getElementById('payment-form-card').classList.remove('hidden');
    if(method === 'pix') document.getElementById('payment-form-pix').classList.remove('hidden');
}

// 4. Processar Assinatura
function processSubscription() {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    const btn = document.querySelector('#modal-premium-hope button[onclick="processSubscription()"]');
    
    // --- FLUXO 1: PIX ---
    if (typeof selectedMethod !== 'undefined' && selectedMethod === 'pix') {
        if(typeof generatePixCode === 'function') generatePixCode(); 
        return;
    }

    // --- FLUXO 2: CART√ÉO DE CR√âDITO ---
    if (typeof cardFormInstance === 'undefined' || !cardFormInstance) {
        // TRADU√á√ÉO: Erro t√©cnico
        showModal(t['modalErrorTitle'] || 'Falha', t['msgErrCardFormNotLoaded'] || "Erro: O formul√°rio de pagamento n√£o foi carregado corretamente. Recarregue a p√°gina.");
        return;
    }

    // Valida√ß√£o Visual B√°sica
    const nome = document.getElementById('cardholderName').value;
    const email = document.getElementById('cardholderEmail').value;
    
    if (!nome || !email) {
        // TRADU√á√ÉO: Valida√ß√£o de campos
        showModal(t['modalAttentionTitle'] || 'Aten√ß√£o', t['msgFillCardData'] || "Por favor, preencha os dados para continuar.");
        return;
    }

    // Feedback visual no bot√£o
    if (btn) {
        // TRADU√á√ÉO: Validando cart√£o
        const txtValidating = t['btnValidatingCard'] || 'Validando Cart√£o...';
        btn.innerHTML = `<span class="animate-spin">‚Üª</span> ${txtValidating}`;
        btn.disabled = true;
    }

    // Dispara o evento onSubmit do Mercado Pago
    cardFormInstance.submit(); 
}

// 4. Finaliza√ß√£o (Reutilizada)
function completeSubscriptionFlow() {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    fetch(`api.php?action=start-premium-trial`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Timezone': (typeof userTimezone !== 'undefined' ? userTimezone : 'UTC'),
            'X-Lang': (typeof currentLang !== 'undefined') ? currentLang : 'pt' // Envia o idioma para e-mails de boas-vindas
        },
        body: JSON.stringify({
            userId: localStorage.getItem('userId'),
            plan: (typeof selectedPlan !== 'undefined' ? selectedPlan : 'monthly'),
            method: (typeof selectedMethod !== 'undefined' ? selectedMethod : 'credit_card')            
        })
    })
    .then(res => res.json())
    .then(data => {
        if(data.success) {
            const modal = document.getElementById('modal-premium-hope');
            if(modal) modal.classList.remove('active');
            
            localStorage.setItem('isPremium', 'true');
            
            // TRADU√á√ÉO: Boas-vindas
            showModal(t['titleWelcome'] || 'Boas-vindas!', t['msgPremiumWelcome'] || 'üéâ Bem-vindo(a)! Sua jornada premium come√ßou.');
            
            setTimeout(() => { location.reload(); }, 2000);
        } else {
            // Tratamento de erro da API
            showModal(t['modalErrorTitle'] || 'Falha', data.message || (t['msgGenericError'] || 'Ocorreu um erro.'));
        }
    })
    .catch(err => {
        console.error(err);
        showModal(t['modalErrorTitle'] || 'Falha', t['msgConnectionError'] || 'Erro de conex√£o.');
    });
}

// 5. Simula√ß√£o de Verifica√ß√£o de Pagamento (Polling)
// Nota: Em produ√ß√£o real, voc√™ consultaria o Mercado Pago a cada 5s
/*
function startPixPolling(paymentId) {
    let attempts = 0;
    const interval = setInterval(() => {
        attempts++;
        // Aqui voc√™ chamaria uma API real: api.php?action=check-payment&id=...
        // Para este exemplo, vamos simular que o usu√°rio "pagou" clicando num bot√£o "J√° paguei" 
        // ou apenas aguardar o usu√°rio clicar em "J√° Paguei" (opcional).
        
        // Se quiser automatizar real, precisaria de outro endpoint no PHP consultando o MP.
        
        if (attempts > 60) clearInterval(interval); // Para ap√≥s 5 min
    }, 5000);
    
    // Adicionar bot√£o "J√° Paguei" manualmente abaixo do QR code para UX
    const resultDiv = document.getElementById('pix-result-step');
    if(!document.getElementById('btn-confirm-pix')) {
        const btnConfirm = document.createElement('button');
        btnConfirm.id = 'btn-confirm-pix';
        btnConfirm.className = "w-full bg-indigo-600 text-white font-bold py-3 rounded mt-4";
        btnConfirm.innerText = "J√° fiz o pagamento";
        btnConfirm.onclick = () => completeSubscriptionFlow(); // Libera o acesso
        resultDiv.appendChild(btnConfirm);
    }
}
*/
// 2. Fun√ß√£o espec√≠fica para gerar o Pix
// Vari√°vel global para controlar o intervalo (para poder parar se o usu√°rio fechar o modal)
let pixPollingInterval = null;

function startPixPolling(paymentId) {
    let attempts = 0;
    const maxAttempts = 60; // 5 minutos (60 * 5s)
    
    // Limpa intervalo anterior se existir
    if (pixPollingInterval) clearInterval(pixPollingInterval);

    // Fun√ß√£o de verifica√ß√£o (extra√≠da para ser usada pelo intervalo e pelo bot√£o)
    const checkPayment = async () => {
        try {
            const response = await fetch('api.php?action=check-payment-status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Timezone': userTimezone 
                },
                body: JSON.stringify({ 
                    paymentId: paymentId,
                    userId: localStorage.getItem('userId')                    
                })
            });
            const data = await response.json();

            console.log("Status Pix:", data.status); // Debug

            if (data.success && data.status === 'approved') {
                clearInterval(pixPollingInterval); // Para o loop
                
                // Feedback visual de sucesso
                const resultDiv = document.getElementById('pix-result-step');
                resultDiv.innerHTML = `
                    <div class="animate-bounce text-5xl mb-4">üéâ</div>
                    <h3 class="text-xl font-bold text-green-600">Pagamento Aprovado!</h3>
                    <p class="text-sm text-gray-500">Liberando seu acesso...</p>
                `;
                
                // Finaliza o fluxo
                setTimeout(() => {
                    document.getElementById('modal-premium-hope').classList.remove('active');
                    localStorage.setItem('isPremium', 'true');
                    showModal('Sucesso', 'Assinatura ativada com sucesso!');
                    setTimeout(() => location.reload(), 2000);
                }, 2000);
                
                return true; // Aprovado
            }
            return false; // Ainda pendente
        } catch (error) {
            console.error("Erro no polling:", error);
            return false;
        }
    };

    // Inicia o Loop Autom√°tico
    pixPollingInterval = setInterval(() => {
        attempts++;
        if (attempts > maxAttempts) {
            clearInterval(pixPollingInterval);
            // Opcional: Mostrar mensagem "Tempo expirado, gere novo c√≥digo"
        } else {
            checkPayment();
        }
    }, 5000); // Verifica a cada 5 segundos

    // L√≥gica do Bot√£o "J√° Paguei" (Apenas antecipa a verifica√ß√£o)
    const resultDiv = document.getElementById('pix-result-step');
    
    // Evita duplicar o bot√£o se a fun√ß√£o for chamada 2x
    if(!document.getElementById('btn-confirm-pix')) {
        const btnConfirm = document.createElement('button');
        btnConfirm.id = 'btn-confirm-pix';
        btnConfirm.className = "w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded mt-4 transition-all flex justify-center items-center gap-2";
        btnConfirm.innerHTML = `<span>J√° fiz o pagamento</span>`;
        
        btnConfirm.onclick = async () => {
            // UI Feedback imediato no bot√£o
            const originalText = btnConfirm.innerHTML;
            btnConfirm.innerHTML = `<span class="animate-spin text-white">‚Üª</span> Verificando...`;
            btnConfirm.disabled = true;
            
            const isApproved = await checkPayment();
            
            if (!isApproved) {
                // Se ainda n√£o compensou, volta o bot√£o e avisa
                setTimeout(() => {
                    btnConfirm.innerHTML = originalText;
                    btnConfirm.disabled = false;
                    showModal('Ainda n√£o compensou', 'O banco ainda est√° processando. Aguarde alguns instantes e tente novamente.');
                }, 1000);
            }
        };
        
        resultDiv.appendChild(btnConfirm);
    }
}

// 3. Fun√ß√£o para Copiar o C√≥digo
function copyPixCode() {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    const copyText = document.getElementById("pix-copy-code");
    
    // Verifica√ß√£o de seguran√ßa caso o elemento n√£o exista
    if (!copyText) return; 

    copyText.select();
    copyText.setSelectionRange(0, 99999); /* Mobile */
    
    navigator.clipboard.writeText(copyText.value).then(() => {
        // 2. Usa as chaves de tradu√ß√£o
        // 'pixCopyTitle' = Pronto
        // 'msgPixCopied' = C√≥digo Pix copiado!
        showModal(
            t['pixCopyTitle'] || 'Pronto', 
            t['msgPixCopied'] || 'C√≥digo Pix copiado!'
        ); 
    });
}

function finishPixPayment() {
    // Fecha o modal e recarrega para verificar se o status mudou (ou aguarda webhook)
    document.getElementById('modal-pix-payment').classList.add('hidden');
    showModal('Info:',"Estamos verificando seu pagamento. Seu plano ser√° ativado em instantes.");
    location.reload(); 
}

// 5. L√≥gica Winback (Campainha)
function acceptWinback() {
    // Exibe a mensagem padronizada
    showModal('Jornada Estendida', 'Obrigado por n√£o desistir! Adicionamos +7 dias ao seu trial.');
    
    // Fecha os modais
    document.getElementById('modal-winback').style.display = 'none';
    document.getElementById('modal-premium-hope').classList.remove('active');
}

function confirmCancel() {
    document.getElementById('modal-winback').style.display = 'none';
    document.getElementById('modal-premium-hope').classList.remove('active');
}

// GATILHO: Verificar se deve abrir o modal ao carregar
// Exemplo: Se o usu√°rio clicar em algo premium
function checkPremiumFeature() {
    // Normaliza state e localStorage para boolean PRIMEIRO
    const isPremiumState = !!(state && state.isPremium);
    const isPremiumStorage = localStorage.getItem('isPremium') === 'true';
    
    // Verifica TRIAL tamb√©m (adicionar se existir)
    const trialActive = localStorage.getItem('trialActive') === 'true';
    
    const hasPremium = isPremiumState || isPremiumStorage || trialActive;
    
    console.log('Premium check:', { isPremiumState, isPremiumStorage, trialActive, hasPremium });
    
    if (!hasPremium) {
        console.log('Acesso bloqueado: Usu√°rio n√£o possui Premium/Trial ativo.');
        openPremiumModal();
        // (Experimente vs Seja Premium) estejam corretos neste exato momento
        verificarStatusEAtualizarModal();
        return false;
    }
    
    return true;
}

// 1. Fun√ß√£o chamada quando o usu√°rio troca a op√ß√£o no Select
async function updateMetaDisplay(newValue) {
    if (!state.patientId) return; // Seguran√ßa extra usando ID

    // 1. ATUALIZA√á√ÉO IMEDIATA DO ESTADO LOCAL (Corre√ß√£o do Bug da Tarefa)
    // Isso garante que quando updateStatsUI rodar, ele pegue o valor novo
    state.patientId.meta_display = newValue;

    // Opcional: Se voc√™ tiver o ID separado no state, garanta a consist√™ncia
    if (state.patientId) {
        // Apenas se voc√™ armazenar dados extras, sen√£o a linha acima basta        
    }

    try {
        const resp = await apiPost('update-patient-meta', {
            patient_id: state.patientId, // Use o ID do objeto paciente
            meta_display: newValue
        });

        if (resp.success) {
            console.log('Meta salva no banco com sucesso:', newValue);
        } else {
            // Se der erro no banco, revertemos o visual para o usu√°rio saber
            showModal('Erro', 'Falha ao salvar prefer√™ncia. Verifique sua conex√£o.');
            // Reverter estado local se falhar (opcional)
        }
    } catch (e) {
        console.error(e);
    }
}

// 2. Atualize sua fun√ß√£o existente de carregar dados do paciente
// Procure a fun√ß√£o onde voc√™ processa o retorno de 'select-patient-by-code' ou similar.

function updateDashboardMeta(patient) {
    // 1. Tenta pegar o elemento dropdown
    const selectEl = document.getElementById('meta-display-select');
    
    // 2. SEGURAN√áA: Se o dropdown n√£o existe (estamos na tela de sele√ß√£o), PARE.
    // Isso evita erros ao tentar manipular elementos inexistentes.
    if (!selectEl) return;

    // 3. L√ìGICA CORRETA: Usa o par√¢metro 'patient' passado para a fun√ß√£o
    // Verifica se 'patient' existe e se tem a propriedade 'meta_display'
    if (patient && patient.meta_display) {
        selectEl.value = patient.meta_display;
    } else {
        // Fallback: Se n√£o tiver dado salvo, usa o padr√£o
        selectEl.value = "Probabilidade de Cura";
    }
}

/* --- L√ìGICA DE RESPIRA√á√ÉO 4-7-8 --- */

let breathingInterval = null;
let breathingActive = false;

async function openBreathingExercise() {
    const modal = document.getElementById('modal-breathing');
    const t = LANG_STRINGS[currentLang] || LANG_STRINGS['pt']; // Carrega tradu√ß√µes
    
    // Mostra o modal suavemente
    modal.classList.remove('pointer-events-none', 'opacity-0');
    breathingActive = true;
    
    // Reset visual (Traduzido)
    updateBreathUI(t['breathInstrPrep'], t['breathSubPrep'], 1, "text-white");
    
    // Pequeno delay para o usu√°rio se acomodar antes de come√ßar
    await new Promise(r => setTimeout(r, 2000));
    
    if(breathingActive) startBreathingLoop();
}

async function startBreathingLoop() {
    const circle = document.getElementById('breath-circle');
    const aura1 = document.getElementById('breath-aura-1');
    const aura2 = document.getElementById('breath-aura-2');
    const t = LANG_STRINGS[currentLang] || LANG_STRINGS['pt']; // Carrega tradu√ß√µes

    while (breathingActive) {
        // 1. INSPIRAR (4 Segundos)
        setCircleTransition(4000); 
        circle.style.transform = "scale(1.8)"; 
        aura1.style.transform = "scale(2.2)";
        aura2.style.transform = "scale(2.5)";
        
        // Texto Traduzido: INSPIRE
        updateBreathUI(t['breathInstrIn'], t['breathSubIn'], 4, "text-teal-300");
        await countdown(4);
        if(!breathingActive) break;

        // 2. SEGURAR (7 Segundos)
        setCircleTransition(100); 
        
        // Texto Traduzido: SEGURE
        updateBreathUI(t['breathInstrHold'], t['breathSubHold'], 7, "text-yellow-300");
        await countdown(7);
        if(!breathingActive) break;

        // 3. EXPIRAR (8 Segundos)
        setCircleTransition(8000); 
        circle.style.transform = "scale(1)";
        aura1.style.transform = "scale(1)";
        aura2.style.transform = "scale(1)";

        // Texto Traduzido: EXPIRE
        updateBreathUI(t['breathInstrOut'], t['breathSubOut'], 8, "text-blue-300");
        await countdown(8);
        if(!breathingActive) break;
    }
}

function stopBreathingExercise() {
    breathingActive = false;
    const t = LANG_STRINGS[currentLang] || LANG_STRINGS['pt'];
    
    // Esconde o modal visualmente
    const modal = document.getElementById('modal-breathing');
    modal.classList.add('opacity-0', 'pointer-events-none');
    
    // Salva no LocalStorage
    const today = new Date().toDateString();
    localStorage.setItem('lastBreathingExercise', today);
    
    // --- API ---
    const uid = localStorage.getItem('userId') || (typeof state !== 'undefined' ? state.userId : null);

    // Garante que o timezone exista, sen√£o pega do navegador
    const timezone = (typeof userTimezone !== 'undefined') ? userTimezone : Intl.DateTimeFormat().resolvedOptions().timeZone;

    if (uid) {
        fetch('api.php?action=save-caregiver-wellness', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Timezone': timezone
            },
            body: JSON.stringify({
                caregiverId: uid,
                action: 'breathing',
                timestamp: new Date().toISOString().slice(0, 19).replace('T', ' ')               
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) console.log("Respira√ß√£o registrada.");
        })
        .catch(err => console.error("Erro API:", err));
    }
    
    // Mensagem de Sucesso Traduzida
    const msg = t['msgBreathCelebration'] || "Voc√™ tirou um tempo para si. Parab√©ns!";
    showCelebrationMessage(msg);
}

// Fun√ß√µes Auxiliares (Mantidas iguais, pois n√£o t√™m texto)
function updateBreathUI(mainText, subText, seconds, colorClass) {
    const instruction = document.getElementById('breath-instruction');
    const sub = document.getElementById('breath-subtext');
    
    instruction.innerText = mainText;
    instruction.className = `text-3xl font-light tracking-widest mb-2 transition-all duration-500 ${colorClass}`;
    
    if(subText) sub.innerText = subText;
}

function setCircleTransition(durationMs) {
    const ids = ['breath-circle', 'breath-aura-1', 'breath-aura-2'];
    ids.forEach(id => {
        const el = document.getElementById(id);
        if(el) el.style.transitionDuration = `${durationMs}ms`;
    });
}

function countdown(seconds) {
    return new Promise(resolve => {
        let remaining = seconds;
        const timerEl = document.getElementById('breath-timer');
        timerEl.innerText = remaining;
        
        const interval = setInterval(() => {
            if(!breathingActive) {
                clearInterval(interval);
                resolve();
                return;
            }
            remaining--;
            if (remaining > 0) {
                timerEl.innerText = remaining;
            } else {
                clearInterval(interval);
                resolve();
            }
        }, 1000);
    });
}

// B√¥nus: Verificar se j√° respirou hoje ao carregar a p√°gina
function checkDailyBreathing() {
    const last = localStorage.getItem('lastBreathingExercise');
    const today = new Date().toDateString();
    
    if (last !== today) {
        // Poderia adicionar um "bolinha vermelha" no menu para avisar
        // Exemplo: document.getElementById('badge-menu-breath').classList.remove('hidden');
    }
}
// Chame checkDailyBreathing() no init do seu app

/* --- L√ìGICA DO MENU ACURA --- */

// Alternar visibilidade do menu
function toggleAcuraMenu(event) {
    updatePatientUI();
    if(event) event.stopPropagation(); // Impede que o clique feche o menu imediatamente
    const menu = document.getElementById('acura-dropdown');
    menu.classList.toggle('hidden');
}

// Fechar o menu se clicar fora
window.addEventListener('click', function(e) {
    const menu = document.getElementById('acura-dropdown');
    const btn = document.getElementById('acura-menu-container');
    
    // Se o clique N√ÉO foi dentro do container do menu, fecha o menu
    if (menu && !menu.classList.contains('hidden') && !btn.contains(e.target)) {
        menu.classList.add('hidden');
    }
});

/* --- L√ìGICA DE DELETAR CONTA --- */

function openDeleteAccountModal() {
    // Fecha o menu dropdown primeiro
    document.getElementById('acura-dropdown').classList.add('hidden');
    // Abre o modal de perigo
    document.getElementById('modal-delete-account').classList.remove('hidden');
}

async function confirmDeleteAccountAction() {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    const btn = document.querySelector('#modal-delete-account button[onclick="confirmDeleteAccountAction()"]');
    const originalText = btn.innerHTML;
    
    // Feedback visual
    // TRADU√á√ÉO: Texto do bot√£o
    const txtProcessing = t['btnProcessing'] || 'Processando...';
    btn.innerHTML = `<span class="loading-spinner"></span> ${txtProcessing}`;
    btn.disabled = true;

    try {
        const uid = localStorage.getItem('userId');
        
        // Chamada √† API
        const response = await fetch('api.php?action=delete-account', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }, // Boa pr√°tica adicionar o header
            body: JSON.stringify({ userId: uid })
        });
        
        const data = await response.json();

        if (data.success) {
            // Limpa tudo do navegador
            localStorage.clear();
            sessionStorage.clear();
            
            // TRADU√á√ÉO: Sucesso
            showModal(t['titleDone'] || 'Pronto', t['msgAccountDeleted'] || "Conta exclu√≠da. Lamentamos ver voc√™ partir.");
            
            // Redireciona para login ou recarrega
            location.reload(); 
        } else {
            // TRADU√á√ÉO: Erro da API
            const errorPrefix = t['msgDeleteErrorPrefix'] || "Erro ao excluir conta: ";
            const msgTryAgain = t['msgTryAgain'] || "Tente novamente.";
            
            showModal(t['modalErrorTitle'] || 'Falha', errorPrefix + (data.message || msgTryAgain));
            
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    } catch (error) {
        console.error(error);
        // TRADU√á√ÉO: Erro de conex√£o
        showModal(t['modalErrorTitle'] || 'Falha', t['msgConnectionError'] || "Erro de conex√£o. Verifique sua internet.");
        
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

/* --- L√ìGICA DE RECUPERA√á√ÉO DE SENHA --- */

// 1. Enviar solicita√ß√£o
async function requestPasswordReset() {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    const email = document.getElementById('forgot-email').value;
    const btn = document.querySelector('#modal-forgot-password button');
    
    // Valida√ß√£o
    if(!email) {
        return showModal(t['modalErrorTitle'] || 'Erro', t['msgEnterEmail'] || 'Por favor, digite seu e-mail.');
    }
    
    // Estado de carregamento
    btn.innerText = t['btnSending'] || 'Enviando...';
    btn.disabled = true;

    try {
        const res = await fetch('api.php?action=request-password-reset', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Lang': (typeof currentLang !== 'undefined') ? currentLang : 'pt'
            },
            body: JSON.stringify({ email })
        });
        const data = await res.json();
        
        // L√ìGICA INTELIGENTE:
        // Tenta traduzir o c√≥digo retornado pelo backend (ex: 'EMAIL_SENT').
        // Se n√£o houver tradu√ß√£o para o c√≥digo, usa a mensagem crua do backend.
        let msg = (data.code && t[data.code]) ? t[data.code] : (data.message || 'Solicita√ß√£o processada.');
        
        // T√≠tulo do modal
        const title = data.success ? (t['modalSuccessTitle'] || 'Sucesso') : (t['modalErrorTitle'] || 'Erro');
        
        showModal(title, msg);
        
        if (data.success) {
            document.getElementById('modal-forgot-password').classList.add('hidden');
        }

    } catch(e) {
        console.error(e);
        showModal(t['modalErrorTitle'] || 'Erro', t['msgConnectionError'] || 'Erro de conex√£o.');
    } finally {
        // Restaura o bot√£o
        btn.innerText = t['btnSendLink'] || 'Enviar Link';
        btn.disabled = false;
    }
}

// 2. Detectar Token na URL (Rodar ao iniciar o App)
function checkResetToken() {
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('reset_token');
    
    if (token) {
        // Se tem token na URL, abre o modal de nova senha imediatamente
        document.getElementById('intro-screen').classList.remove('active-screen'); // Esconde intro se estiver
        document.getElementById('modal-reset-confirm').classList.remove('hidden');
        document.getElementById('reset-token-input').value = token;
        
        // Limpa a URL para ficar bonita
        window.history.replaceState({}, document.title, window.location.pathname);
    }
}

// 3. Confirmar a nova senha
async function confirmNewPassword() {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    const token = document.getElementById('reset-token-input').value;
    const newPass = document.getElementById('reset-new-pass').value;
    
    // Refer√™ncia ao bot√£o de confirmar (ajuste o seletor se necess√°rio)
    const btn = document.querySelector('#modal-reset-confirm button[onclick="confirmNewPassword()"]') || document.querySelector('#modal-reset-confirm button.btn-primary');
    let originalText = '';

    // Valida√ß√£o
    if(newPass.length < 6) {
        // TRADU√á√ÉO: Mensagem de valida√ß√£o
        return showModal(t['modalErrorTitle'] || 'Falha', t['msgPassMinLength'] || "A senha deve ter pelo menos 6 caracteres.");
    }

    // Estado de Carregamento
    if (btn) {
        originalText = btn.innerHTML;
        btn.innerHTML = `<span class="loading-spinner"></span> ${t['btnSaving'] || 'Salvando...'}`;
        btn.disabled = true;
    }

    try {
        const res = await fetch('api.php?action=reset-password-confirm', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-Lang': (typeof currentLang !== 'undefined') ? currentLang : 'pt'
            },
            body: JSON.stringify({ token: token, newPassword: newPass })
        });
        const data = await res.json();
        
        if(data.success) {
            // TRADU√á√ÉO: Sucesso
            showModal(t['modalSuccessTitle'] || 'Sucesso', t['msgPassResetSuccess'] || "Sucesso! Use sua nova senha para entrar.");
            
            document.getElementById('modal-reset-confirm').classList.add('hidden');
            
            // Opcional: Mostrar tela de login
            const introScreen = document.getElementById('intro-screen');
            if(introScreen) introScreen.classList.add('active-screen');
            
        } else {
            // TRADU√á√ÉO: Erro da API (usa c√≥digo se existir, ou mensagem crua)
            const msg = (data.code && t[data.code]) ? t[data.code] : data.message;
            showModal(t['modalResultTitle'] || "Resultado", msg);
        }
    } catch (error) {
        console.error(error);
        // TRADU√á√ÉO: Erro de conex√£o
        showModal(t['modalErrorTitle'] || 'Falha', t['msgConnectionError'] || "Erro de conex√£o.");
    } finally {
        // Restaura bot√£o
        if (btn) {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }
}

// *** IMPORTANTE: Adicione esta chamada na inicializa√ß√£o do seu script ***
// Pode ser logo no final do <script>, ou dentro de window.addEventListener('load', ...)
checkResetToken();

/* --- SISTEMA DE TUTORIAL ONBOARDING --- */

// Defini√ß√£o dos Passos (Personalize os IDs e Textos aqui)
const tutorialSteps = [
    {
        targetId: null, // Intro centralizada
        titleKey: 'tutIntroTitle',
        textKey: 'tutIntroDesc'
    },
    {
        targetId: "acura-menu-container",
        titleKey: 'tutMenuTitle',
        textKey: 'tutMenuDesc'
    },
    {
        targetId: "openSettingsBtn",
        titleKey: 'tutSettingsTitle',
        textKey: 'tutSettingsDesc'
    },
    {
        targetId: "caregiverAvatar",
        titleKey: 'tutCaregiverTitle',
        textKey: 'tutCaregiverDesc'
    }, 
    {
        targetId: "notificationBtn",
        titleKey: 'tutCallCaregiversTitle',
        textKey: 'tutCallCaregiversDesc'
    },
    {
        targetId: "hospitalNameDisplay",
        titleKey: 'tutLocationTitle',
        textKey: 'tutLocationDesc'
    },
    {
        targetId: "progressFill",
        titleKey: 'tutProgressTitle',
        textKey: 'tutProgressDesc'
    },
    {
        targetId: "timeline",
        titleKey: 'tutTimelineTitle',
        textKey: 'tutTimelineDesc'
    },
    {
        targetId: "btn-new-appointment-timeline",
        titleKey: 'tutAddEventTitle',
        textKey: 'tutAddEventDesc'
    },
    {
        targetId: "agendaDia",
        titleKey: 'tutAgendaTitle',
        textKey: 'tutAgendaDesc'
    },
    {
        targetId: "btnCadastrarDrug",
        titleKey: 'tutMedsTitle',
        textKey: 'tutMedsDesc'
    },
    {
        targetId: "patientAvatar",
        titleKey: 'tutPatientTitle',
        textKey: 'tutPatientDesc'
    },
    {
        targetId: "survivalProgressCircle",
        titleKey: 'tutShieldTitle',
        textKey: 'tutShieldDesc'
    },
    {
        targetId: "foodButton", // Representando os bot√µes de registro r√°pido
        titleKey: 'tutQuickLogTitle',
        textKey: 'tutQuickLogDesc'
    },
    {
        targetId: "catheter-icon",
        titleKey: 'tutCatheterTitle',
        textKey: 'tutCatheterDesc'
    },
    {
        targetId: "notification-message-ai", // Bot√£o do Chat IA
        titleKey: 'tutDrAITitle',
        textKey: 'tutDrAIDesc'
    },
    {
        targetId: "btnOpenCaregiverChat", // CORRE√á√ÉO: Sugest√£o de ID para o chat humano
        titleKey: 'tutChatHumanTitle',
        textKey: 'tutChatHumanDesc'
    },   
    {
        targetId: "currentTime", // Relat√≥rio de atendimento
        titleKey: 'tutcurrentTimeTitle',
        textKey: 'tutcurrentTimeDesc'
    }, 
     {
        targetId: "ProfessionalPresenceId", // Cadastrar a equipe de enfermagem do dia
        titleKey: 'tutProfessionalPresenceTitle',
        textKey: 'tutProfessionalPresenceDesc'
    }, 
      {
        targetId: 'OpenShareId', // Compartilhar com outros cuidadores
        titleKey: 'tutOpenShareTitle',
        textKey: 'tutOpenShareDesc'
    },
      {
        targetId: null, // CORRE√á√ÉO: null para centralizar como conclus√£o (ou use o ID do bot√£o Dashboard se houver)
        titleKey: 'tutDashboardTitle',
        textKey: 'tutDashboardDesc'
    }
];

let currentStepIndex = 0;

// Inicializa o tutorial (Chamar no window.onload)
function initTutorial() {
    if (!localStorage.getItem('tutorialCompleted')) {
        setTimeout(() => {
            startTutorial();
        }, 1500);
    }
}

function startTutorial() {
    document.getElementById('tutorial-overlay').classList.remove('hidden');
    currentStepIndex = 0;
    renderStep();
}

function renderStep() {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    // Garante que existe, sen√£o usa 'pt' como fallback
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    const step = tutorialSteps[currentStepIndex];
    
    // 2. Atualiza Textos usando as CHAVES (Keys)
    // Se a tradu√ß√£o falhar, usa um texto gen√©rico para n√£o quebrar
    document.getElementById('tut-title').innerText = t[step.titleKey] || '...';
    document.getElementById('tut-desc').innerText = t[step.textKey] || '...';
    
    document.getElementById('tut-step-count').innerText = `${currentStepIndex + 1}/${tutorialSteps.length}`;

    // 3. Controla Bot√µes (Traduzidos)
    const btnNext = document.getElementById('tut-btn-next');
    const btnPrev = document.getElementById('tut-btn-prev');
    
    btnPrev.classList.toggle('hidden', currentStepIndex === 0);
    
    // L√≥gica: Se for o √∫ltimo passo, texto √© "Concluir", sen√£o "Pr√≥ximo"
    if (currentStepIndex === tutorialSteps.length - 1) {
        btnNext.innerText = t['btnFinish'] || 'Concluir';
    } else {
        btnNext.innerText = t['btnNext'] || 'Pr√≥ximo';
    }

    // 4. Efeito Spotlight (Mantido igual, apenas l√≥gica visual)
    document.querySelectorAll('.tutorial-highlight').forEach(el => {
        el.classList.remove('tutorial-highlight', 'relative', 'z-[13001]', 'bg-white', 'pointer-events-none');
        el.style.pointerEvents = 'auto'; // Garante que o pointer events volte ao normal
    });

    if (step.targetId) {
        const target = document.getElementById(step.targetId);
        if (target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Adiciona classe de destaque e bloqueia clique no elemento alvo
            target.classList.add('tutorial-highlight', 'relative', 'z-[13001]', 'bg-white', 'rounded-lg', 'shadow-[0_0_15px_rgba(255,255,255,0.5)]');
            target.style.pointerEvents = 'none'; 
        }
    }
}

function nextTutorialStep() {
    cleanupCurrentStep();

    if (currentStepIndex < tutorialSteps.length - 1) {
        currentStepIndex++;
        renderStep();
    } else {
        finishTutorial();
    }
}

function prevTutorialStep() {
    cleanupCurrentStep();
    if (currentStepIndex > 0) {
        currentStepIndex--;
        renderStep();
    }
}

function cleanupCurrentStep() {
    const step = tutorialSteps[currentStepIndex];
    if (step && step.targetId) {
        const target = document.getElementById(step.targetId);
        if (target) {
            target.classList.remove('tutorial-highlight', 'relative', 'z-[13001]', 'rounded-lg', 'shadow-[0_0_15px_rgba(255,255,255,0.5)]', 'bg-white');
            target.style.pointerEvents = 'auto'; // Devolve o clique
        }
    }
}

function skipTutorial() {
    cleanupCurrentStep();
    finishTutorial();
}

function finishTutorial() {
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    document.getElementById('tutorial-overlay').classList.add('hidden');
    localStorage.setItem('tutorialCompleted', 'true');
    
    // Feedback visual de conclus√£o (Traduzido)
    const msg = t['msgTutorialComplete'] || "Voc√™ est√° pronto! Conte conosco.";
    showCelebrationMessage(msg);
}

// Adicione a chamada no final do carregamento da p√°gina
//window.addEventListener('load', initTutorial);
// Se voc√™ tiver uma fun√ß√£o de login, chame initTutorial() logo ap√≥s o login com sucesso tamb√©m.

/* --- Fun√ß√£o para Reiniciar o Tutorial via Menu --- */
function restartTutorialAction() {
    // 1. Fecha o menu dropdown para n√£o atrapalhar o tutorial
    const menu = document.getElementById('caregiverDropdownMenu');
    if (menu) menu.classList.add('hidden');

    // 2. Remove a "mem√≥ria" de que j√° foi completado (opcional, mas bom para garantir)
    localStorage.removeItem('tutorialCompleted');

    // 3. Inicia o tutorial diretamente
    // Nota: Certifique-se de que a fun√ß√£o startTutorial existe (criada no passo anterior)
    if (typeof startTutorial === 'function') {
        startTutorial();
    } else {
        console.error("Fun√ß√£o startTutorial n√£o encontrada. Verifique se o c√≥digo do onboarding foi inserido.");
    }
}

/* --- SISTEMA DE NOTIFICA√á√ÉO DE CHAT --- */

// Intervalo de verifica√ß√£o (armazenado para poder limpar se necess√°rio)
let chatNotificationInterval = null;

// 1. Fun√ß√£o Principal de Verifica√ß√£o
async function checkUnreadChatMessages() {
    const uid = localStorage.getItem('userId');
    if (!uid) return;

    // Se nunca leu, usa uma data bem antiga
    const lastRead = localStorage.getItem('lastChatReadTime') || '2000-01-01 00:00:00';
    
    // Tenta pegar o ID do paciente do state global ou do localStorage
    const pid = (typeof state !== 'undefined' && state.patientId) 
                ? state.patientId 
                : localStorage.getItem('lastPatientId'); 

    try {
        const response = await fetch('api.php?action=check-unread-messages', {
            method: 'POST',
            body: JSON.stringify({
                userId: uid,
                patientId: pid,
                lastReadTime: lastRead                
            })
        });
        
        const data = await response.json();
        const badge = document.getElementById('notification-message-caregiver');
        
        if (badge) {
            if (data.success && data.hasUnread) {
                // TEM MENSAGEM: Remove o hidden
                badge.classList.remove('hidden');
                
                // Opcional: Se seu span for 'absolute', ele j√° aparece. 
                // Se precisar for√ßar display block, use: badge.style.display = 'block';
                
            } else {
                // N√ÉO TEM MENSAGEM
                badge.classList.add('hidden');
            }
        }
    } catch (error) {
        console.error("Erro ao verificar mensagens:", error);
    }
}
// 2. Fun√ß√£o para "Ler" as mensagens (Limpar notifica√ß√£o)
// Chame esta fun√ß√£o SEMPRE que abrir o modal de Chat
function markChatAsRead() {
    // Esconde a bolinha visualmente na hora
    const badge = document.getElementById('notification-message-caregiver');
    if (badge) badge.classList.add('hidden');

    // CORRE√á√ÉO: Usar hor√°rio local para alinhar com o PHP/MySQL
    const nowLocal = getLocalMySQLDate();
    localStorage.setItem('lastChatReadTime', nowLocal);
    
    console.log("Chat marcado como lido em:", nowLocal);
}

// 3. Inicializador do Polling (Chamar no login ou load da p√°gina)
function startChatNotificationService() {
    // Executa a primeira vez imediatamente
    checkUnreadChatMessages();

    // Configura para rodar a cada 5 minutos (300.000 ms)
    if (chatNotificationInterval) clearInterval(chatNotificationInterval);
    chatNotificationInterval = setInterval(checkUnreadChatMessages, 300000);
}

function getLocalMySQLDate() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');
    
    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
}

// ==========================================
// L√ìGICA DO M√ìDULO FINANCEIRO
// ==========================================

let financeDataLoaded = false;

// Vari√°vel global para armazenar a lista de pend√™ncias (para refer√™ncia cruzada)
let pendingItemsList = [];

// 1. Atualize a fun√ß√£o openFinanceModal 
function openFinanceModal() {
     
    closeCaregiverMenu(); //fecha o modal de cuidador

    const modal = document.getElementById('financeModal');
    
    // Mostra visualmente
    modal.classList.remove('hidden');
    
    // CORRE√á√ÉO: Avisa a acessibilidade que o modal agora est√° vis√≠vel
    modal.setAttribute('aria-hidden', 'false'); 
    
    // Define a data de hoje
    document.getElementById('fin_data').valueAsDate = new Date();

    if (!financeDataLoaded) {
        fetchFinanceData();
    }
    
    // Busca pend√™ncias
    fetchPendingExpenses();
}

// 2. NOVA fun√ß√£o para buscar pend√™ncias
async function fetchPendingExpenses() {
    //const currentPatientId = localStorage.getItem('selectedPatientId');
    const currentPatientId = state.patientId;
    if (!currentPatientId) return;

    try {
        const response = await fetch(`api.php?action=finance-get-pending-items&patient_id=${currentPatientId}`);
        const data = await response.json();

        const alertArea = document.getElementById('pending-alert-area');
        const container = document.getElementById('pending-chips-container');
        
        // Limpar container visual e lista
        container.innerHTML = '';
        pendingItemsList = [];

        if (data.success && data.pendencias.length > 0) {
            pendingItemsList = data.pendencias;
            
            // Mostrar a √°rea de alerta
            alertArea.classList.remove('hidden');

            // Criar um "chip" (bot√£o) para cada pend√™ncia
            data.pendencias.forEach(item => {
                const btn = document.createElement('button');
                btn.type = 'button'; // Importante para n√£o submeter o form
                // Estiliza√ß√£o do bot√£o (chip)
                btn.className = "text-xs font-medium px-3 py-1.5 bg-white border border-orange-300 text-orange-700 rounded-full hover:bg-orange-100 hover:text-orange-900 transition shadow-sm flex items-center gap-1";
                btn.innerHTML = `<span>${item.label_view}</span>`;
                
                // Evento de clique para selecionar o item
                btn.onclick = function() {
                    selectPendingItem(item, btn);
                };

                container.appendChild(btn);
            });
        } else {
            // Se n√£o houver pend√™ncias, esconder a √°rea
            alertArea.classList.add('hidden');
        }
    } catch (error) {
        console.error('Erro ao buscar pend√™ncias:', error);
    }
}

function selectPendingItem(item, btnElement) {
    // 1. Preencher os campos
    document.getElementById('fin_descricao').value = item.descricao;
    document.getElementById('fin_origin_type').value = item.origin_type;
    document.getElementById('fin_origin_id').value = item.id;

    // 2. Feedback visual (destacar o bot√£o clicado e suavizar os outros)
    const allBtns = document.getElementById('pending-chips-container').children;
    Array.from(allBtns).forEach(b => {
        b.classList.remove('bg-orange-500', 'text-white', 'border-transparent');
        b.classList.add('bg-white', 'text-orange-700', 'border-orange-300');
    });

    // Destaca o selecionado
    btnElement.classList.remove('bg-white', 'text-orange-700', 'border-orange-300');
    btnElement.classList.add('bg-orange-500', 'text-white', 'border-transparent');

    // 3. (Opcional) Tentar adivinhar a categoria baseada no tipo
    // Supondo IDs padr√£o: 1=Medicamentos, 2=Consultas, 3=Exames (ajuste conforme seu DB)
    const catSelect = document.getElementById('fin_categoria');
    if (item.origin_type === 'drug') {
        // Tenta selecionar categoria de Medicamentos (ajuste o value '1' se necess√°rio)
        setSelectValue(catSelect, '1', 'Medicamento'); 
    } else if (item.origin_type === 'exam') {
        // Agenda pode ser consulta ou exame, aqui simplificamos para Exame ou Consulta
        // Se quiser ser mais preciso, precisaria vir do backend se √© consulta ou exame
        setSelectValue(catSelect, '3', 'Exame'); 
    }
}

// Auxiliar para selecionar categoria sem quebrar se o ID n√£o existir
function setSelectValue(select, valueToSelect, textMatch) {
    // Tenta pelo Value direto
    let option = select.querySelector(`option[value="${valueToSelect}"]`);
    if(option) {
        select.value = valueToSelect;
        return;
    }
    // Fallback: Tenta pelo texto (caso os IDs mudem)
    Array.from(select.options).forEach(opt => {
        if(opt.text.toLowerCase().includes(textMatch.toLowerCase())) {
            select.value = opt.value;
        }
    });
}

// 3. Adicione um Listener no input de Descri√ß√£o
// Isso serve para detectar se o usu√°rio selecionou uma op√ß√£o ou digitou algo novo
document.getElementById('fin_descricao').addEventListener('input', function(e) {
    // Se o usu√°rio alterar o texto manualmente, removemos o v√≠nculo com a pend√™ncia
    // para evitar salvar uma descri√ß√£o nova vinculada a um ID de rem√©dio antigo.
    document.getElementById('fin_origin_type').value = '';
    document.getElementById('fin_origin_id').value = '';
    
    // Remove o destaque visual dos bot√µes
    const allBtns = document.getElementById('pending-chips-container').children;
    Array.from(allBtns).forEach(b => {
        b.classList.remove('bg-orange-500', 'text-white', 'border-transparent');
        b.classList.add('bg-white', 'text-orange-700', 'border-orange-300');
    });
});

// 2. Fechar Modal
function closeFinanceModal() {
    const modal = document.getElementById('financeModal');
    
    // Esconde visualmente
    modal.classList.add('hidden');
    
    // CORRE√á√ÉO: Avisa a acessibilidade que o modal voltou a ficar oculto
    modal.setAttribute('aria-hidden', 'true');
    
    document.getElementById('finance-feedback').classList.add('hidden');
}

// 3. Alternar Abas (Despesas vs Dicas)
function switchFinanceTab(tabId) {
    // 1. Esconde todos os conte√∫dos
    document.getElementById('tab-despesa').classList.add('hidden');
    document.getElementById('tab-dicas').classList.add('hidden');
    
    // 2. Reseta estilos dos bot√µes
    const btnDespesa = document.getElementById('btn-tab-despesa');
    const btnDicas = document.getElementById('btn-tab-dicas');
    
    // Classes de estilo (inativo vs ativo)
    const inactiveClass = "inline-block p-4 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 rounded-t-lg";
    const activeClass = "inline-block p-4 border-b-2 border-blue-600 text-blue-600 rounded-t-lg active";
    
    btnDespesa.className = inactiveClass;
    btnDicas.className = inactiveClass;
    
    // 3. Mostra o conte√∫do selecionado
    document.getElementById(tabId).classList.remove('hidden');
    
    // 4. Ativa o bot√£o e carrega dados se necess√°rio
    if (tabId === 'tab-despesa') {
        btnDespesa.className = activeClass;
    }
    
    if (tabId === 'tab-dicas') {
        btnDicas.className = activeClass;
        
        // CORRE√á√ÉO: Chama a fun√ß√£o de carregamento aqui!
        console.log("Carregando checklist..."); // Log para debug
        if (typeof loadFinanceChecklist === 'function') {
            loadFinanceChecklist();
        } else {
            console.error("Fun√ß√£o loadFinanceChecklist n√£o encontrada.");
        }
    }
}

// 4. Buscar Dados Iniciais (API)
async function fetchFinanceData() {
    try {
        const response = await fetch('api.php?action=finance-get-initial-data');
        const data = await response.json();
        
        if (data.success) {
            // 1. Popular Select de Categorias (ISSO DEVEMOS MANTER)
            const select = document.getElementById('fin_categoria');
            
            // Verifica√ß√£o de seguran√ßa: s√≥ preenche se o select existir
            if (select) {
                select.innerHTML = '<option value="">Selecione uma categoria...</option>';
                
                if (data.categorias) {
                    data.categorias.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.id;
                        option.textContent = `${cat.icone} ${cat.nome}`;
                        select.appendChild(option);
                    });
                }
            }

            // ‚ùå REMOVIDO: O c√≥digo antigo que tentava preencher 'tips-container'
            // Como agora usamos o loadFinanceChecklist na aba de dicas, 
            // n√£o precisamos mais carregar dicas simples aqui.
            
            financeDataLoaded = true;
        }
    } catch (error) {
        console.error('Erro ao carregar dados financeiros:', error);
    }
}

// Fun√ß√£o para verificar a categoria selecionada (COM DEBUG)
function checkMedicationCategory(selectElement) {
    // Valida√ß√£o de seguran√ßa
    if (!selectElement || selectElement.selectedIndex < 0) return;

    const text = selectElement.options[selectElement.selectedIndex].text.toLowerCase();
    const detailsDiv = document.getElementById('medication-details');
    
    // Log para verificar se a fun√ß√£o est√° sendo chamada (Abra o F12 -> Console)
    console.log("Categoria alterada para:", text);
    
    if (!detailsDiv) {
        console.error("ERRO: Elemento 'medication-details' n√£o encontrado no HTML.");
        return;
    }

    // Verifica palavras-chave (singular e plural, com ou sem acento)
    // Inclui 'farm√°cia' caso sua categoria tenha esse nome
    if (text.includes('medicamento') || text.includes('rem√©dio') || text.includes('farm√°cia')) {
        console.log("Exibindo campos extras...");
        detailsDiv.classList.remove('hidden');
        
        // Foca no primeiro campo para facilitar
        setTimeout(() => document.getElementById('fin_med_tipo').focus(), 100);
    } else {
        console.log("Ocultando campos extras...");
        detailsDiv.classList.add('hidden');
        
        // Limpar campos ao ocultar para n√£o enviar lixo
        const tipo = document.getElementById('fin_med_tipo');
        if(tipo) tipo.value = '';
        
        const conteudo = document.getElementById('fin_med_conteudo');
        if(conteudo) conteudo.value = '';
        
        const qtd = document.getElementById('fin_med_qtd_comprada');
        if(qtd) qtd.value = '1';
    }
}

// 5. Enviar Despesa (Submit)
// 4. Atualize a fun√ß√£o submitExpense
async function submitExpense(event) {
    event.preventDefault();
    
    //const currentPatientId = localStorage.getItem('selectedPatientId'); 

    const currentPatientId = state.patientId; 
    
    if (!currentPatientId) {
        showModal('Falha',"Erro: Nenhum paciente selecionado.");
        return;
    }

    // ============================================================
    // CORRE√á√ÉO: Definir a vari√°vel ANTES de usar no payload
    // ============================================================
    const detailsDiv = document.getElementById('medication-details');
    // A vari√°vel √© verdadeira se a div existir e N√ÉO estiver oculta
    const medDetailsVisible = detailsDiv && !detailsDiv.classList.contains('hidden');

    const payload = {
        patient_id: currentPatientId, 
        caregiver_id: localStorage.getItem('userId'),
        categoria_id: document.getElementById('fin_categoria').value,
        descricao: document.getElementById('fin_descricao').value,
        valor: document.getElementById('fin_valor').value,
        data_despesa: document.getElementById('fin_data').value,
        recorrente: document.getElementById('fin_recorrente').checked ? 1 : 0,
        
        origin_type: document.getElementById('fin_origin_type').value,
        origin_id: document.getElementById('fin_origin_id').value,

        // Agora a vari√°vel 'medDetailsVisible' j√° existe e pode ser usada aqui:
        med_tipo: medDetailsVisible ? document.getElementById('fin_med_tipo').value : null,
        med_conteudo: medDetailsVisible ? document.getElementById('fin_med_conteudo').value : null,
        med_unidade: medDetailsVisible ? document.getElementById('fin_med_unidade').value : null,
        med_qtd: medDetailsVisible ? document.getElementById('fin_med_qtd_comprada').value : 1
    };

    try {
        const response = await fetch('api.php?action=finance-add-expense', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json','X-Timezone': userTimezone },
            body: JSON.stringify(payload)            
        });
        
        const result = await response.json();
        const feedback = document.getElementById('finance-feedback');
        
        feedback.classList.remove('hidden', 'text-green-800', 'bg-green-50', 'text-red-800', 'bg-red-50');
        
        if (result.success) {
            feedback.classList.add('text-green-800', 'bg-green-50');
            feedback.textContent = "‚úÖ " + result.message;
            
            document.getElementById('formFinanceExpense').reset();
            
            // Limpa campos ocultos e extras
            document.getElementById('fin_origin_type').value = '';
            document.getElementById('fin_origin_id').value = '';
            
            // Oculta os detalhes de medicamento novamente
            if(detailsDiv) detailsDiv.classList.add('hidden');
            
            document.getElementById('fin_data').valueAsDate = new Date();
            
            // Atualiza lista de pend√™ncias
            if(typeof fetchPendingExpenses === 'function') {
                fetchPendingExpenses(); 
            }
        } else {
            feedback.classList.add('text-red-800', 'bg-red-50');
            feedback.textContent = "‚ùå " + result.message;
        }
        
        feedback.classList.remove('hidden');
        setTimeout(() => feedback.classList.add('hidden'), 3000);

    } catch (error) {
        console.error(error);
        showModal('Falha',"Erro de conex√£o ao salvar despesa.");
    }
}

function loadShiftReport() {
    // 1. Busca robusta do ID do Paciente
    let pid = null;
    if (typeof state !== 'undefined' && currentPatientId) {
        pid = currentPatientId;
    } else {
        pid = localStorage.getItem('patientId');
    }

    // DEBUG: Mostra no console o que o JS vai enviar
    console.log("üîç Tentando carregar escala...");
    console.log("   > Patient ID:", pid);

    if (!pid || pid === 'null' || pid === 'undefined') {
        console.warn("‚ö†Ô∏è Abortando carga da escala: ID do paciente inv√°lido.");
        const tbody = document.getElementById('escala-tbody');
        if(tbody) tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-red-400">Selecione um paciente primeiro.</td></tr>';
        return;
    }
    
    // 2. Filtro de Data
    const monthInput = document.getElementById('financeFilterMonth');
    const mes = monthInput ? monthInput.value : new Date().toISOString().slice(0,7);
    console.log("   > M√™s Filtro:", mes);

    // 3. UI
    const tbody = document.getElementById('escala-tbody');
    const resumoContainer = document.getElementById('escala-resumo-container');

    if (!tbody || !resumoContainer) return;
    tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-400">Carregando dados...</td></tr>';

    // 4. Chamada √† API
    fetch(`api.php?action=shift-get-report&patient_id=${pid}&mes=${mes}`)
    .then(r => r.json())
    .then(data => {
        // DEBUG: Mostra o que o PHP entendeu
        if(data.debug_params) {
            console.log("üì° Resposta API (Debug):", data.debug_params);
        }

        if(!data.success) {
            tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-red-400">${data.message || 'Erro ao buscar'}</td></tr>`;
            return;
        }

        // A. Renderiza Resumo
        resumoContainer.innerHTML = '';
        if(data.resumo && data.resumo.length > 0) {
            data.resumo.forEach(r => {
                const card = `
                    <div class="bg-green-50 p-3 rounded border border-green-200 flex flex-col items-center shadow-sm">
                        <span class="text-xs text-gray-500 font-bold uppercase tracking-wide">${r.nome}</span>
                        <span class="text-lg text-green-700 font-bold">${r.total_formatado}</span>
                    </div>
                `;
                resumoContainer.insertAdjacentHTML('beforeend', card);
            });
        } else {
            resumoContainer.innerHTML = '<p class="text-gray-400 text-xs text-center w-full col-span-2">Sem horas registradas.</p>';
        }

        // B. Renderiza Tabela
        tbody.innerHTML = '';
        if(data.lista && data.lista.length > 0) {
            data.lista.forEach(item => {
                const checkInDate = item.check_in ? new Date(item.check_in) : null;
                const dia = checkInDate ? checkInDate.toLocaleDateString('pt-BR') : '--/--';
                const horaIn = checkInDate ? checkInDate.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'}) : '--:--';
                
                let horaOut = '--:--';
                let duracao = 'Em andamento';
                let rowClass = !item.check_out ? 'bg-green-50 border-l-4 border-green-500' : 'bg-white border-b hover:bg-gray-50';

                if(item.check_out) {
                    const checkOutDate = new Date(item.check_out);
                    horaOut = checkOutDate.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
                    const mins = parseInt(item.minutos_trabalhados || 0);
                    const h = Math.floor(mins / 60);
                    const m = mins % 60;
                    duracao = `${h}h ${m}m`;
                }

                const nomeCuidador = item.nome_cuidador || 'N√£o Identificado';

                const tr = `
                    <tr class="${rowClass} transition text-sm">
                        <td class="px-3 py-3 font-medium text-gray-700">${dia}</td>
                        <td class="px-3 py-3 text-blue-600 font-medium">${nomeCuidador}</td>
                        <td class="px-3 py-3 text-gray-600">${horaIn}</td>
                        <td class="px-3 py-3 text-gray-600">${horaOut}</td>
                        <td class="px-3 py-3 text-right font-bold text-gray-800">${duracao}</td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', tr);
            });
        } else {
            tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400 italic">Nenhum registro encontrado para este m√™s.</td></tr>';
        }
    })
    .catch(err => {
        console.error("Erro fatal loadShiftReport:", err);
        tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-red-500">Erro de conex√£o.</td></tr>';
    });
}

// Vari√°vel global para o gr√°fico (para poder destruir e recriar)
let financeChartInstance = null;

// 1. Fun√ß√£o Principal chamada ao abrir a aba
// 1. Carregar Relat√≥rio (Com Logs de Debug)
function loadFinanceReport() {
    //const currentPatientId = localStorage.getItem('selectedPatientId');
    //const currentPatientId = state.patientId;
    if (!currentPatientId) {
        console.warn("Financeiro: Nenhum paciente selecionado.");
        return;
    }

    // Pega o valor do filtro de m√™s
    let monthInput = document.getElementById('financeFilterMonth');
    
    // Se o input n√£o existir ou estiver vazio, define o m√™s atual
    if (!monthInput || !monthInput.value) {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        
        // Se o elemento existir, atualiza visualmente
        if(monthInput) monthInput.value = `${year}-${month}`;
        // Valor para a API
        var selectedMonth = `${year}-${month}`;
    } else {
        var selectedMonth = monthInput.value;
    }

    console.log(`üì° Financeiro: Buscando dados para Paciente ${currentPatientId} no m√™s ${selectedMonth}...`);

    // Feedback visual de carregamento (opcional, mas recomendado)
    const tbody = document.getElementById('financeTableBody');
    if(tbody) tbody.innerHTML = '<tr><td colspan="3" class="px-4 py-4 text-center text-gray-400">Carregando dados...</td></tr>';

    fetch(`api.php?action=finance-get-report-complete&patient_id=${currentPatientId}&mes=${selectedMonth}`)
        .then(res => res.json())
        .then(data => {
            console.log("‚úÖ Financeiro: Resposta da API:", data);
            
            if (data.success) {
                renderFinanceDashboard(data); 
                renderCaregiverChart(data.resumo_cuidadores);  
                loadShiftReport();             
            } else {
                console.error("‚ùå Erro na API Financeira:", data.message);
                if(tbody) tbody.innerHTML = `<tr><td colspan="3" class="px-4 py-4 text-center text-red-500">${data.message}</td></tr>`;
            }
        })
        .catch(err => {
            console.error("‚ùå Erro de conex√£o Financeiro:", err);
            if(tbody) tbody.innerHTML = '<tr><td colspan="3" class="px-4 py-4 text-center text-red-500">Erro de conex√£o. Tente novamente.</td></tr>';
        });
}

// 2. Renderiza a Tela
function renderFinanceDashboard(data) {
    // A. Atualiza Total Geral (Converter string para float)
    const totalElement = document.getElementById('finReportTotal');
    if (totalElement) {
        totalElement.textContent = formatCurrencyBRL(parseFloat(data.total_geral));
    }

    // B. Renderiza Tabela
    const tbody = document.getElementById('financeTableBody');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (!data.despesas || data.despesas.length === 0) {
        tbody.innerHTML = `<tr><td colspan="3" class="px-4 py-8 text-center text-gray-400">Nenhum lan√ßamento encontrado neste m√™s.</td></tr>`;
    } else {
        data.despesas.forEach(d => {
            // CORRE√á√ÉO DE DATA: Evita o erro de fuso hor√°rio (-1 dia)
            // Divide a string 'YYYY-MM-DD' manualmente
            let dateStr = 'Data inv√°lida';
            if (d.data_despesa) {
                const parts = d.data_despesa.split('-'); // [2025, 12, 01]
                if (parts.length === 3) {
                    dateStr = `${parts[2]}/${parts[1]}`; // 01/12
                }
            }
            
            // √çcone e Cor com fallback
            const icone = d.icone || 'üìù';
            const cor = d.cor || '#666';

            const tr = document.createElement('tr');
            tr.className = "border-b hover:bg-gray-50 transition";
            tr.innerHTML = `
                <td class="px-4 py-3 font-medium text-gray-900 whitespace-nowrap text-xs sm:text-sm">${dateStr}</td>
                <td class="px-4 py-3">
                    <div class="flex items-center">
                        <span class="mr-2 text-lg" style="color:${cor}">${icone}</span>
                        <div class="flex flex-col">
                            <span class="text-sm font-medium text-gray-700">${d.descricao}</span>
                            <span class="text-xs text-gray-400">${d.categoria_nome || 'Geral'}</span>
                        </div>
                    </div>
                </td>
                <td class="px-4 py-3 text-right font-bold text-gray-700 text-sm">
                    ${formatCurrencyBRL(parseFloat(d.valor))}
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // C. Renderiza Gr√°fico (Atrasa ligeiramente para garantir que o DOM est√° pronto)
    requestAnimationFrame(() => {
        renderChart(data.grafico);
    });
}

// 3. Auxiliar para Gr√°fico
function renderChart(dataGrafico) {
    const canvas = document.getElementById('financeChart');
    const emptyLabel = document.getElementById('financeChartEmpty');

    if (!canvas) {
        console.warn("Canvas do gr√°fico financeiro n√£o encontrado.");
        return;
    }

    // Destruir gr√°fico anterior se existir
    if (financeChartInstance) {
        financeChartInstance.destroy();
        financeChartInstance = null;
    }

    // Verifica se tem dados
    if (!dataGrafico || dataGrafico.length === 0) {
        if(emptyLabel) emptyLabel.classList.remove('hidden');
        // Limpa o canvas visualmente
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        return;
    }
    
    if(emptyLabel) emptyLabel.classList.add('hidden');

    const labels = dataGrafico.map(item => item.nome);
    const values = dataGrafico.map(item => parseFloat(item.total)); // Garante float
    const colors = dataGrafico.map(item => item.cor || '#cccccc');

    try {
        const ctx = canvas.getContext('2d');
        financeChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: colors,
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%', // Rosca mais fina
                plugins: {
                    legend: {
                        position: 'right',
                        labels: { boxWidth: 12, font: { size: 11 } }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    label += formatCurrencyBRL(context.parsed);
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    } catch (e) {
        console.error("Erro ao criar gr√°fico Chart.js:", e);
    }
}

// Vari√°vel global para armazenar a inst√¢ncia deste gr√°fico espec√≠fico
let chartCaregiverInstance = null;

/**
 * Fun√ß√£o nova para renderizar exclusivamente o gr√°fico de Cuidadores.
 * Recebe o array 'resumo_cuidadores' vindo da API.
 */
function renderCaregiverChart(resumoCuidadores) {
    const ctx = document.getElementById('chartCaregiverExpenses');
    const msgEmpty = document.getElementById('msgSemDadosCuidador');
    
    if (!ctx) return; // Se o elemento n√£o existir, para aqui.

    // 1. Limpa gr√°fico anterior se existir (para evitar sobreposi√ß√£o ao recarregar)
    if (chartCaregiverInstance) {
        chartCaregiverInstance.destroy();
        chartCaregiverInstance = null;
    }

    // 2. Verifica se h√° dados
    if (!resumoCuidadores || resumoCuidadores.length === 0) {
        ctx.style.display = 'none';
        if (msgEmpty) msgEmpty.classList.remove('hidden');
        return;
    }

    // Se tem dados, mostra o canvas e esconde msg de erro
    ctx.style.display = 'block';
    if (msgEmpty) msgEmpty.classList.add('hidden');

    // 3. Prepara os dados para o Chart.js
    const labels = resumoCuidadores.map(item => item.nome || 'N√£o Identificado');
    const dataValues = resumoCuidadores.map(item => parseFloat(item.total));
    
    // Paleta de cores din√¢mica
    const colors = [
        '#3B82F6', // Azul
        '#10B981', // Verde
        '#F59E0B', // Laranja
        '#EF4444', // Vermelho
        '#8B5CF6', // Roxo
        '#EC4899', // Rosa
        '#6366F1', // Indigo
        '#14B8A6'  // Teal
    ];

    // 4. Cria o Gr√°fico
    chartCaregiverInstance = new Chart(ctx, {
        type: 'doughnut', // Pode mudar para 'pie' ou 'bar' se preferir
        data: {
            labels: labels,
            datasets: [{
                label: 'Total Gasto (R$)',
                data: dataValues,
                backgroundColor: colors.slice(0, labels.length),
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right', // Legenda ao lado
                    labels: {
                        boxWidth: 12,
                        font: { size: 11 }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) label += ': ';
                            // Formata√ß√£o BRL
                            label += new Intl.NumberFormat('pt-BR', { 
                                style: 'currency', 
                                currency: 'BRL' 
                            }).format(context.raw);
                            return label;
                        }
                    }
                }
            }
        }
    });
}

// 4. Auxiliar de Formata√ß√£o Monet√°ria
function formatCurrencyBRL(value) {
    if (isNaN(value)) return 'R$ 0,00';
    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
}

// ==========================================
// FUN√á√ïES: ABANDONAR PACIENTE
// ==========================================

// 1. Abrir o modal e configurar o nome
function openAbandonPatientModal() {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    const currentId = state.patientId;

    const dropdown = document.getElementById('Acura-dropdown');
    if (dropdown) dropdown.classList.add('hidden');

    if (!currentId) {
        // TRADU√á√ÉO: Erro de sele√ß√£o
        showModal(t['modalErrorTitle'] || 'Falha', t['msgNoPatientToAbandon'] || "Nenhum paciente selecionado para abandonar.");
        return;
    }

    // Atualiza a vari√°vel com o nome do paciente
    if (typeof updatePatientUI === 'function') updatePatientUI();

    // 2. Obter Nome do Paciente
    let patientName = state.patient ? state.patient.nickname : null;   

    // Fallback de seguran√ßa
    if (!patientName) {
        const headerName = document.getElementById('pacientName');
        if (headerName) {
            patientName = headerName.textContent.trim();
        } else {
            // TRADU√á√ÉO: Nome gen√©rico
            patientName = t['defaultPatientName'] || 'Paciente';
        }
    }

    // 3. Atualiza textos do Modal   
    const modalEl = document.getElementById('modal-abandon-name');   
    if (modalEl) modalEl.textContent = patientName;
    
    // 4. Mostra modal
    document.getElementById('abandonPatientModal').classList.remove('hidden');
}

// 2. Fechar modal (N√£o requer tradu√ß√£o, apenas l√≥gica visual)
function closeAbandonPatientModal() {
    document.getElementById('abandonPatientModal').classList.add('hidden');
}

// 3. Confirmar e chamar API
async function confirmAbandonPatient() {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    // 1. Pega ID do Paciente do estado global
    const patientId = state.patientId;
    
    // 2. Pega ID do Cuidador
    const caregiverId = localStorage.getItem('userId') || localStorage.getItem('caregiver_id');
    
    if (!patientId) {
        showModal(t['modalErrorTitle'] || 'Falha', t['msgErrPatientIdMissing'] || "Erro: ID do paciente n√£o encontrado no estado.");
        return;
    }

    if (!caregiverId) {
        showModal(t['modalErrorTitle'] || 'Falha', t['msgErrSessionMissing'] || "Erro: Sess√£o do cuidador n√£o encontrada. Tente fazer login novamente.");
        return;
    }

    try {
        const response = await fetch('api.php?action=abandon-patient', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Timezone': (typeof userTimezone !== 'undefined' ? userTimezone : 'UTC') },
            body: JSON.stringify({ 
                patient_id: patientId,
                caregiver_id: caregiverId                
            })
        });

        const data = await response.json();

        if (data.success) {
            // TRADU√á√ÉO: Sucesso
            showModal(t['titleDone'] || 'Est√° feito', t['msgAbandonSuccess'] || `Voc√™ deixou de cuidar deste paciente.`);
            
            // Limpeza de estado
            if (typeof state !== 'undefined') state.patientId = null;
            localStorage.removeItem('selectedPatientId'); 
            localStorage.removeItem('selectedPatientData'); 
            
            closeAbandonPatientModal();
            window.location.reload(); 
        } else {
            // TRADU√á√ÉO: Erro da API
            const prefix = t['msgErrorPrefix'] || "Erro: ";
            showModal(t['modalErrorTitle'] || 'Falha', prefix + data.message);
        }
    } catch (error) {
        console.error(error);
        // TRADU√á√ÉO: Erro de conex√£o
        showModal(t['modalErrorTitle'] || 'Falha', t['msgConnectionError'] || "Erro de conex√£o ao tentar realizar a opera√ß√£o.");
    }
}

// ==========================================
// M√ìDULO CHECKLIST (Dicas e Direitos)
// ==========================================

async function loadFinanceChecklist() {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    const currentPatientId = state.patientId;
    if (!currentPatientId) return;

    const container = document.getElementById('checklist-container');
    
    try {
        // 2. IMPORTANTE: Envia o idioma para a API
        // Isso garante que os textos do checklist (que v√™m do banco) venham traduzidos
        const langParam = (typeof currentLang !== 'undefined') ? currentLang : 'pt';
        
        const response = await fetch(`api.php?action=finance-get-checklist&patient_id=${currentPatientId}&lang=${langParam}`);
        const data = await response.json();

        if (data.success) {
            renderChecklist(data.structure, data.saved_status);
            updateChecklistProgress();
        } else {
            // Exibe mensagem da API (que agora deve vir traduzida gra√ßas ao &lang=)
            container.innerHTML = `<p class="text-red-500 text-center">${data.message}</p>`;
        }
    } catch (error) {
        console.error("Erro ao carregar checklist:", error);
        // TRADU√á√ÉO: Mensagem de erro de conex√£o
        const msgError = t['msgConnectionError'] || 'Erro de conex√£o.';
        container.innerHTML = `<p class="text-gray-500 text-center">${msgError}</p>`;
    }
}

function renderChecklist(sections, savedStatus) {
    const container = document.getElementById('checklist-container');
    if (!container) return; // Seguran√ßa extra
    
    container.innerHTML = '';

    // Mapa de cores para Tailwind (Baseado nas chaves 'cor' enviadas pela API)
    const colorMap = {
        'red': 'bg-red-100 text-red-800 border-red-200',
        'orange': 'bg-orange-100 text-orange-800 border-orange-200',
        'blue': 'bg-blue-100 text-blue-800 border-blue-200',
        'green': 'bg-green-100 text-green-800 border-green-200',
        'gray': 'bg-gray-100 text-gray-800 border-gray-200',
        'yellow': 'bg-yellow-100 text-yellow-800 border-yellow-200',
        'pink': 'bg-pink-100 text-pink-800 border-pink-200'
    };

    // Itera sobre cada se√ß√£o recebida da API (j√° traduzida pelo PHP)
    for (const [key, section] of Object.entries(sections)) {
        const colorClass = colorMap[section.cor] || colorMap['gray'];
        
        // HTML da Se√ß√£o
        const sectionDiv = document.createElement('div');
        sectionDiv.className = "bg-white rounded-lg shadow-sm border border-gray-100 overflow-hidden";
        
        let itemsHtml = '';
        section.itens.forEach(item => {
            // Nota: 'aprovado' √© a chave t√©cnica do banco de dados, n√£o precisa traduzir
            const isChecked = savedStatus[item.id] === 'aprovado' ? 'checked' : '';
            const textDecoration = isChecked ? 'line-through text-gray-400' : 'text-gray-800';
            
            itemsHtml += `
                <div class="flex items-start p-3 border-b last:border-0 border-gray-50 hover:bg-gray-50 transition-colors">
                    <div class="flex items-center h-5">
                        <input id="${item.id}" type="checkbox" ${isChecked} 
                               onchange="toggleChecklistItem('${item.id}', this)"
                               class="checklist-checkbox w-5 h-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                    </div>
                    <div class="ml-3 text-sm">
                        <label for="${item.id}" class="font-medium ${textDecoration} cursor-pointer select-none transition-all duration-300" id="label-${item.id}">
                            ${item.texto} 
                        </label>
                        <p class="text-xs text-gray-500 mt-0.5">${item.desc}</p>
                    </div>
                </div>
            `;
        });

        sectionDiv.innerHTML = `
            <div class="px-4 py-2 flex justify-between items-center ${colorClass}">
                <h5 class="font-bold text-sm flex items-center gap-2">
                    ${section.titulo}
                </h5>
                <span class="text-[10px] font-bold uppercase tracking-wider bg-white bg-opacity-50 px-2 py-0.5 rounded">
                    ${section.prioridade}
                </span>
            </div>
            <div class="divide-y divide-gray-100">
                ${itemsHtml}
            </div>
        `;
        
        container.appendChild(sectionDiv);
    }
}

async function toggleChecklistItem(itemId, checkbox) {
    //const currentPatientId = localStorage.getItem('selectedPatientId');
    const currentPatientId = state.patientId;
    const label = document.getElementById(`label-${itemId}`);
    
    // Efeito visual imediato (Optimistic UI)
    if (checkbox.checked) {
        label.classList.add('line-through', 'text-gray-400');
        label.classList.remove('text-gray-800');
    } else {
        label.classList.remove('line-through', 'text-gray-400');
        label.classList.add('text-gray-800');
    }

    updateChecklistProgress();

    // Salvar no servidor
    try {
        await fetch('api.php?action=finance-toggle-benefit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json','X-Timezone': userTimezone },
            body: JSON.stringify({
                patient_id: currentPatientId,
                item_id: itemId,
                checked: checkbox.checked                
            })
        });
        // (Opcional) Poderia tratar erro aqui revertendo o checkbox
    } catch (e) {
        console.error("Erro ao salvar status:", e);
    }
}

function updateChecklistProgress() {
    const total = document.querySelectorAll('.checklist-checkbox').length;
    const checked = document.querySelectorAll('.checklist-checkbox:checked').length;
    
    const percent = total === 0 ? 0 : Math.round((checked / total) * 100);
    
    document.getElementById('checklist-bar').style.width = `${percent}%`;
    document.getElementById('checklist-percent').textContent = `${percent}%`;
    document.getElementById('checklist-count').textContent = `${checked} de ${total} conquistas`;
    
    // Feedback visual na barra dependendo do progresso
    const bar = document.getElementById('checklist-bar');
    if (percent === 100) {
        bar.classList.remove('bg-blue-600');
        bar.classList.add('bg-green-500');
    } else {
        bar.classList.add('bg-blue-600');
        bar.classList.remove('bg-green-500');
    }
}

// ==========================================
// INTEGRA√á√ÉO: Atualize sua fun√ß√£o de troca de abas
// ==========================================
// Quando clicar no bot√£o da aba de dicas:
// document.getElementById('btn-tab-dicas').addEventListener('click', () => {
//    switchFinanceTab('tab-dicas');
//    loadFinanceChecklist(); // <--- CHAME AQUI
// });


// ==========================================
// Cadastro de profissionais
// ==========================================

const modalCadastroProf = document.getElementById('modal-cadastro-prof');
const btnAbrirCadastroProf = document.getElementById('btn-abrir-cadastro-prof');
const formCadastroProf = document.getElementById('form-cadastro-prof');
const selectFormacao = document.getElementById('prof_formacao');
const selectConselho = document.getElementById('prof_tipo_conselho');
let targetInputIdForProfessional = null; 

function openNewProfessionalModal(targetId = null) {
    console.log('A fun√ß√£o de novo profissional foi chamada');
    
    // 1. Guardamos quem pediu a abertura (ex: 'medico_prescritor')
    targetInputIdForProfessional = targetId;
    
    // 2. Abrimos o modal (usando sua vari√°vel existente)
    modalCadastroProf.classList.remove('hidden');
}

// 1. Fun√ß√£o para abrir o modal
btnAbrirCadastroProf.addEventListener('click', () => {
    modalCadastroProf.classList.remove('hidden');
});

// 2. Fun√ß√£o global para fechar o modal
function fecharModalCadastroProf() {
    modalCadastroProf.classList.add('hidden');
    formCadastroProf.reset(); // Limpa o formul√°rio
}

// 3. Fun√ß√£o para auto-preencher o Conselho baseado na forma√ß√£o (melhoria de UX)
function atualizarConselho() {
    const formacao = selectFormacao.value;
    
    // Auto-seleciona o conselho mais prov√°vel
    if (formacao === 'Medico') {
        selectConselho.value = 'CFM';
    } else if (['Enfermeiro', 'Tecnico', 'Auxiliar'].includes(formacao)) {
        selectConselho.value = 'COFEN';
    } else {
        selectConselho.value = '';
    }
}

// 4. Listener de submiss√£o do formul√°rio

formCadastroProf.addEventListener('submit', async (e) => {
    e.preventDefault();

    const btnSubmit = formCadastroProf.querySelector('button[type="submit"]');
    const textoOriginal = btnSubmit ? btnSubmit.innerHTML : 'Salvar';

    // 1. Bloqueia o bot√£o para evitar cliques duplos enquanto busca o GPS
    if (btnSubmit) {
        btnSubmit.disabled = true;
        btnSubmit.innerHTML = '<span class="loading-spinner"></span> Salvando...';
    }

    // 2. Coleta dos dados b√°sicos do formul√°rio
    const data = {
        action: 'register-professional',
        nome: document.getElementById('prof_nome').value,
        formacao: selectFormacao.value,
        pronome_tratamento: document.getElementById('prof_pronome').value,
        tipo_conselho: selectConselho.value,
        numero_conselho: document.getElementById('prof_numero_conselho').value,
        email: document.getElementById('prof_email').value || null, 
        telefone: document.getElementById('prof_telefone').value || null,
        is_cuidador: document.getElementById('prof_is_cuidador').checked,
        
        // --- NOVOS CAMPOS DE CONTEXTO ---
        // Tenta pegar do localStorage ou de vari√°veis globais do seu sistema
        // Ajuste 'userId' e 'selectedPatientId' conforme voc√™ salvou no login/sele√ß√£o
        user_id: localStorage.getItem('userId') || (typeof currentUser !== 'undefined' ? currentUser.id : null),
        //patient_id: localStorage.getItem('selectedPatientId') || (typeof currentPatientId !== 'undefined' ? currentPatientId : null)
        patient_id: state.patientId
    };

    // Valida√ß√£o de seguran√ßa no Frontend
    if (!data.user_id || !data.patient_id) {
        showModal('Erro', 'N√£o foi poss√≠vel identificar o usu√°rio ou o paciente ativo. Tente recarregar a p√°gina.');
        if (btnSubmit) { btnSubmit.disabled = false; btnSubmit.innerHTML = textoOriginal; }
        return;
    }

    // 3. Fun√ß√£o interna para enviar os dados (com ou sem GPS)
    const enviarDados = async (dadosFinais) => {
        try {
            const response = await fetch('api.php?action=register-professional', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dadosFinais)
            });

            const result = await response.json();

            if (result.success) {
                // Se retornou mensagem espec√≠fica de "J√° existe", mostramos ela
                showModal("Sucesso", result.message); 
                fecharModalCadastroProf();
                
                // --- ATUALIZA√á√ÉO DOS CAMPOS DE INTERFACE ---
                
                // 1. Atualiza timeline
                const inputTimeline = document.getElementById('timeline-profissional');
                if (inputTimeline) inputTimeline.value = dadosFinais.nome;

                // 2. Atualiza prescritor
                const inputMedico = document.getElementById('medico_prescritor');
                if (inputMedico) inputMedico.value = dadosFinais.nome;

                // 3. Atualiza telefone
                const inputTelefone = document.getElementById('timeline-telefone');
                if (inputTelefone) inputTelefone.value = dadosFinais.telefone || '';

                // 4. Limpa o form
                formCadastroProf.reset();

            } else {
                showModal('Aten√ß√£o', result.message);
            }

        } catch (error) {
            console.error('Erro:', error);
            showModal('Falha', 'Ocorreu um erro na comunica√ß√£o com o servidor.');
        } finally {
            // Libera o bot√£o
            if (btnSubmit) {
                btnSubmit.disabled = false;
                btnSubmit.innerHTML = textoOriginal;
            }
        }
    };

    // 4. L√≥gica de Geolocaliza√ß√£o
    // Tenta obter a posi√ß√£o. Se conseguir, adiciona ao objeto 'data'. Se falhar, envia sem.
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                // Sucesso: Adiciona lat/long
                data.latitude = position.coords.latitude;
                data.longitude = position.coords.longitude;
                enviarDados(data);
            },
            (error) => {
                // Erro (bloqueado ou timeout): Envia sem coordenadas
                console.warn("Localiza√ß√£o n√£o obtida (erro ou permiss√£o negada). Enviando sem GPS.");
                enviarDados(data);
            },
            { timeout: 5000 } // Espera no m√°ximo 5 segundos pelo GPS
        );
    } else {
        // Navegador n√£o suporta GPS
        enviarDados(data);
    }
});

document.addEventListener('DOMContentLoaded', () => {
    const inputNome = document.getElementById('timeline-profissional');
    const inputTelefone = document.getElementById('timeline-telefone');
    const inputMedicoDrugs = document.getElementById('medico_prescritor');

    // --- NOVA L√ìGICA DE GEOLOCALIZA√á√ÉO ---
    // Tentamos pegar a localiza√ß√£o assim que a p√°gina carrega.
    // Salvamos em uma vari√°vel para usar no momento da pesquisa sem atrasar a digita√ß√£o.
    let userLocation = null;

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                userLocation = {
                    lat: position.coords.latitude,
                    lon: position.coords.longitude
                };
                console.log('Localiza√ß√£o obtida para busca de profissionais.');
            },
            (error) => {
                console.warn('Permiss√£o de localiza√ß√£o negada ou erro. A busca ser√° por ordem alfab√©tica.');
            },
            { timeout: 10000, maximumAge: 60000 } // Cache de 1 minuto
        );
    }
    // -------------------------------------
    
    // Verificamos se o elemento existe para evitar erros
    if (inputMedicoDrugs) {
        setupAutocomplete(inputMedicoDrugs, 'suggestions-profissional-drugs', (item) => {
            inputMedicoDrugs.value = item.nome;
        });
    }
    
    // Configura o autocomplete para o campo de NOME
    if (inputNome) { // Adicionada verifica√ß√£o de exist√™ncia
        setupAutocomplete(inputNome, 'suggestions-profissional', (item) => {
            inputNome.value = item.nome;
            if (inputTelefone) inputTelefone.value = item.telefone || '';
        });
    }

    // Configura o autocomplete para o campo de TELEFONE
    if (inputTelefone) { // Adicionada verifica√ß√£o de exist√™ncia
        setupAutocomplete(inputTelefone, 'suggestions-telefone', (item) => {
            inputTelefone.value = item.telefone;
            if (inputNome) inputNome.value = item.nome;
        });
    }

    // Fun√ß√£o gen√©rica de Autocomplete
    function setupAutocomplete(inputElement, listId, onSelectCallback) {
        const listElement = document.getElementById(listId);
        let timeout = null;

        // Escuta a digita√ß√£o
        inputElement.addEventListener('input', function() {
            const term = this.value;

            // Limpa timeout anterior (Debounce)
            clearTimeout(timeout);
            
            if (term.length < 2) {
                listElement.style.display = 'none';
                return;
            }

            // Aguarda 300ms antes de chamar a API
            timeout = setTimeout(async () => {
                try {
                    // --- ATUALIZA√á√ÉO DA URL ---
                    // Monta a URL base
                    let url = `api.php?action=search-professional&term=${encodeURIComponent(term)}`;
                    
                    // Se tivermos a localiza√ß√£o salva, adicionamos na requisi√ß√£o
                    if (userLocation) {
                        url += `&lat=${userLocation.lat}&lon=${userLocation.lon}`;
                    }

                    const response = await fetch(url);
                    const data = await response.json();

                    renderSuggestions(data, listElement, onSelectCallback);
                } catch (error) {
                    console.error('Erro ao buscar profissional:', error);
                }
            }, 300);
        });

        // Fecha a lista se clicar fora
        document.addEventListener('click', function(e) {
            if (e.target !== inputElement && e.target !== listElement) {
                listElement.style.display = 'none';
            }
        });
    }

    // Renderiza a lista visual
    function renderSuggestions(data, listElement, onSelectCallback) {
        listElement.innerHTML = ''; // Limpa lista atual

        if (data.length === 0) {
            listElement.style.display = 'none';
            return;
        }

        data.forEach(item => {
            const li = document.createElement('li');
            
            // --- ATUALIZA√á√ÉO VISUAL (DIST√ÇNCIA) ---
            // Formata o texto para mostrar a dist√¢ncia se ela existir
            let displayText = item.nome;
            
            // Adiciona telefone se houver
            if (item.telefone) {
                displayText += ` (${item.telefone})`;
            }

            // Adiciona a dist√¢ncia (ex: " - 3.5 km") se a API retornou
            if (item.distance_km !== undefined && item.distance_km !== null) {
                // Usamos um √≠cone de pin ou apenas texto para indicar proximidade
                displayText += ` ‚Äî üìç ${item.distance_km} km`;
            }

            // Adiciona forma√ß√£o se houver (opcional, mas ajuda a distinguir)
            if (item.formacao) {
                displayText += ` [${item.formacao}]`;
            }

            li.textContent = displayText;
            
            // Estiliza√ß√£o condicional para os mais pr√≥ximos (Opcional - ex: negrito nos top 3)
            // if (item.distance_km && item.distance_km < 20) { li.style.fontWeight = 'bold'; }

            li.addEventListener('click', () => {
                onSelectCallback(item);
                listElement.style.display = 'none'; 
            });

            listElement.appendChild(li);
        });

        listElement.style.display = 'block';
    }
});


//cadastro de decis√µes

async function deleteDecision(decisionId) {

    const querydelete = await customConfirm('Excluir', 'Tem certeza que deseja cancelar e excluir esta vota√ß√£o? Esta a√ß√£o n√£o pode ser desfeita.');

    if (!querydelete) {
        return;
    }

    const currentUserId = localStorage.getItem('userId'); // Certifique-se de pegar o ID correto

    try {
        const response = await fetch('api.php?action=delete-decision', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json','X-Timezone': userTimezone },
            body: JSON.stringify({ 
                decision_id: decisionId,
                user_id: currentUserId               
            })
        });

        const result = await response.json();

        if (result.success) {
            showModal('Pronto','Vota√ß√£o exclu√≠da com sucesso.');
            
            // Limpa a √°rea de visualiza√ß√£o
            document.getElementById('hub-decision-display-area').innerHTML = '<p class="text-gray-500">Selecione uma decis√£o...</p>';
            
            // Recarrega a lista de decis√µes para remover o item deletado
            // Supondo que voc√™ tenha uma fun√ß√£o que carrega a lista lateral:
            if (typeof loadDecisionsList === 'function') {
                loadDecisionsList(); 
            } else {
                window.location.reload(); // Fallback se n√£o tiver a fun√ß√£o de recarregar lista
            }
        } else {
            showModal('Falha','Erro: ' + result.message);
        }
    } catch (error) {
        console.error('Erro:', error);
        showModal('Falha','Erro ao tentar excluir a vota√ß√£o.');
    }
}

function openLegacyModal() {
    const modal = document.getElementById('modal-legacy-info');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

// Vari√°vel para controle do tempo de digita√ß√£o (Debounce)
let timeoutBusca = null;

async function buscarMedicamento(termo) {
    const lista = document.getElementById('lista-sugestoes');
    
    clearTimeout(timeoutBusca);
    
    if (termo.length < 3) {
        lista.style.display = 'none';
        lista.innerHTML = '';
        return;
    }

    timeoutBusca = setTimeout(async () => {
        try {
            const userLang = localStorage.getItem('appLanguage') || 'pt'; 
            
            // Adicionei log para voc√™ ver o que est√° acontecendo
            console.log(`Buscando: ${termo} em ${userLang}`);

            const response = await fetch(`api.php?action=search-drugs&term=${encodeURIComponent(termo)}&lang=${userLang}`);
            
            if (!response.ok) {
                // Se der erro 400 ou 500, lan√ßa exce√ß√£o para n√£o quebrar o JSON
                throw new Error(`Erro API: ${response.status}`);
            }

            const data = await response.json();

            // VERIFICA√á√ÉO DE SEGURAN√áA (Corrige o erro forEach)
            if (Array.isArray(data)) {
                renderizarSugestoes(data);
            } else {
                console.warn("A API retornou algo que n√£o √© uma lista:", data);
                lista.style.display = 'none';
            }

        } catch (error) {
            console.error("Erro na busca de medicamentos:", error);
            lista.style.display = 'none';
        }
    }, 300);
}

function renderizarSugestoes(medicamentos) {
    const lista = document.getElementById('lista-sugestoes');
    lista.innerHTML = '';

    // Seguran√ßa extra: se n√£o for array, sai da fun√ß√£o
    if (!Array.isArray(medicamentos) || medicamentos.length === 0) {
        lista.style.display = 'none';
        return;
    }

    medicamentos.forEach(med => {
        const div = document.createElement('div');
        div.className = 'suggestion-item';
        div.innerHTML = `
            <span class="suggestion-name">${med.display}</span>
            <span class="suggestion-details">${med.detalhes}</span>
        `;

        div.onclick = () => {
            // Preenche o input
            const input = document.getElementById('nome_medicamento');
            input.value = med.nome;
            
            // Dispara evento para o formul√°rio saber que mudou (importante para valida√ß√µes)
            input.dispatchEvent(new Event('input')); 
            
            lista.style.display = 'none';
        };

        lista.appendChild(div);
    });

    lista.style.display = 'block';
}

// Fecha a lista se clicar fora dela
document.addEventListener('click', function(e) {
    const container = document.querySelector('.autocomplete-container');
    const lista = document.getElementById('lista-sugestoes');
    if (container && !container.contains(e.target)) {
        lista.style.display = 'none';
    }
});

//--Plano Premium

/**
 * Adapta o Modal Premium baseado no hist√≥rico do usu√°rio.
 * Deve ser chamada ap√≥s verificar o status do usu√°rio via API.
 */
function adaptarModalPremium(trialUsed) {
    const modal = document.getElementById('modal-premium-hope');
    if (!modal) return;

    // --- 1. Mapeamento de Textos (Tradu√ß√£o e Ajustes) ---
    const mapTextos = {
        'experimente 14 dias sem custo': 'Continue com cuidados Premium',
        'm√©todo seguro (cobran√ßa ap√≥s 14 dias)': 'Seja Premium tamb√©m e ajude mais vidas!',
        'teste gr√°tis dispon√≠vel': 'Seu Teste Gr√°tis Terminou',
        'cobran√ßa ap√≥s 14 dias': 'Seja Premium tamb√©m'
    };

    // --- 2. Atualiza√ß√£o do Badge "Teste Gr√°tis" ---
    const spanTrial = document.getElementById('teste_gratis');
    if (spanTrial && trialUsed) {
        spanTrial.innerText = "Seu Teste Gr√°tis Terminou";
        // Remove estilo verde e adiciona vermelho (alerta)
        spanTrial.classList.remove('bg-green-100', 'text-green-700');
        spanTrial.classList.add('bg-red-100', 'text-red-700');
    }

    // --- 3. Varredura e Substitui√ß√£o de Textos Gerais ---
    // Seleciona todos os n√≥s de elemento dentro do modal
    const allElements = modal.getElementsByTagName('*');
    
    for (let i = 0; i < allElements.length; i++) {
        const el = allElements[i];
        
        // Verifica apenas elementos que cont√™m texto direto
        if (el.childNodes.length > 0) {
            // Normaliza: remove quebras de linha (\n) e espa√ßos extras, e p√µe em min√∫sculo
            const rawText = el.innerText || el.textContent;
            const textoLimpo = rawText.replace(/\s+/g, ' ').trim().toLowerCase();

            if (mapTextos[textoLimpo]) {
                el.innerText = mapTextos[textoLimpo];
                // Adiciona destaque visual (exceto no badge que j√° tratamos)
                if (el.id !== 'teste_gratis') {
                    el.classList.add('font-bold', 'text-indigo-700');
                }
            }
        }
    }

    // --- 4. L√≥gica "Nuclear" para Ocultar Bot√£o de Trial ---
    if (trialUsed) {
        console.log("Aplicando regras para usu√°rio p√≥s-trial...");

        // Seleciona QUALQUER elemento que possa ser um bot√£o
        const candidates = modal.querySelectorAll('button, a, div[role="button"], input[type="button"], .btn');

        candidates.forEach(btn => {
            // Normaliza√ß√£o agressiva do texto do bot√£o
            const t = (btn.innerText || btn.textContent || "").toLowerCase().replace(/\s+/g, ' ');
            
            // Verifica palavras-chave combinadas para evitar falsos positivos
            // Se tiver "14" E ("dias" OU "gr√°tis"), √© o bot√£o alvo.
            if (t.includes('14') && (t.includes('gr√°tis') || t.includes('dias') || t.includes('come√ßar'))) {
                
                // For√ßa oculta√ß√£o ignorando qualquer classe do Tailwind ou CSS anterior
                btn.style.setProperty('display', 'none', 'important');
                
                // Opcional: Adiciona classe hidden caso o framework remova o style inline
                btn.classList.add('hidden');
                
                console.log("Bot√£o de trial ocultado:", btn);
            }
        });

        // --- 5. Mostrar Bot√µes de Pagamento ---
        // Procura bot√µes ocultos de pagamento e revela
        const btnsPagamento = modal.querySelectorAll('.btn-pagamento-imediato, .btn-confirmar-pix, .btn-confirmar-cartao');
        btnsPagamento.forEach(btn => {
            btn.classList.remove('hidden');
            btn.style.display = 'block';
        });

        // Garante visibilidade dentro das Abas (Tabs)
        const containersPagamento = modal.querySelectorAll('[id^="tab-content-"]');
        containersPagamento.forEach(div => {
             const btn = div.querySelector('button');
             // S√≥ exibe se o bot√£o N√ÉO foi ocultado no passo 4 (ou seja, n√£o √© o de trial)
             if(btn && btn.style.display !== 'none') {
                 btn.style.display = 'block';
             }
        });
    }
}

async function verificarStatusEAtualizarModal() {
    try {
        const userId = localStorage.getItem('userId');
        if (!userId) return;

        // Chama a API
        const response = await fetch(`api.php?action=get-premium-status&userId=${userId}`);
        const data = await response.json();

        if (data.success) {
            // --- ATUALIZA√á√ÉO CR√çTICA AQUI ---
            // 1. Persistir o status real no LocalStorage para o checkPremiumFeature ler depois
            localStorage.setItem('isPremium', data.is_premium); 
            
            // Opcional: Se voc√™ usa um objeto global 'state', atualize-o tamb√©m
            if (typeof state !== 'undefined') {
                state.isPremium = data.is_premium;
            }

            // 2. L√≥gica Visual (Seu c√≥digo anterior)
            if (data.trial_used && !data.is_premium) {
                // Usu√°rio j√° gastou o trial: Modal mostra "Compre Agora"
                adaptarModalPremium(true); 
            } else {
                // Usu√°rio novo: Modal mostra "Teste Gr√°tis"
                adaptarModalPremium(false); 
            }
        }
    } catch (error) {
        console.error("Erro ao sincronizar status premium:", error);
    }
}

const mp = new MercadoPago('APP_USR-618b060a-76b4-4ade-857c-fe0f081e96ae', { locale: 'pt-BR' }); // teste: TEST-9aa36b6f-5471-4a27-bbc3-288284ebaebb

// Vari√°veis globais para armazenar os pre√ßos reais (BRL)
const PLAN_PRICES_BRL = {
    monthly: 29.90,
    annual_monthly_equivalent: 17.90
};

async function mostrarPrecoInternacional() {
    // S√≥ executa se o idioma n√£o for PT (opcional, mas recomendado)
    // if (currentLang === 'pt') return; 

    try {
        // Chama a API que criamos antes para pegar a cota√ß√£o
        // Note: Podemos usar a action 'get-price-preview' apenas para pegar o 'rate_used'
        const res = await fetch('api.php?action=get-price-preview');
        const data = await res.json();

        if (data.success && data.rate_used) {
            const cotacao = parseFloat(data.rate_used);

            // 1. Calcula Mensal
            const usdMonthly = (PLAN_PRICES_BRL.monthly / cotacao).toFixed(2);
            const elMonthly = document.getElementById('display-usd-monthly');
            if (elMonthly) {
                elMonthly.innerHTML = `üá∫üá∏ USD $${usdMonthly}`;
                elMonthly.classList.remove('hidden');
            }

            // 2. Calcula Anual (Equivalente mensal)
            const usdAnnual = (PLAN_PRICES_BRL.annual_monthly_equivalent / cotacao).toFixed(2);
            const elAnnual = document.getElementById('display-usd-annual');
            if (elAnnual) {
                elAnnual.innerHTML = `üá∫üá∏ USD $${usdAnnual}<span class="text-[9px]">/mo</span>`;
                elAnnual.classList.remove('hidden');
            }

            console.log(`üí± Pre√ßos atualizados com cota√ß√£o 1 USD = R$ ${cotacao}`);
        }
    } catch (error) {
        console.error("Erro ao carregar pre√ßos internacionais:", error);
    }
}

// Chame esta fun√ß√£o ao abrir o modal de pagamento
// mostrarPrecoInternacional();

let cardFormInstance = null;

// Inicializar o cardForm (chamar uma vez no carregamento da p√°gina)
function initCardPayment() {
    try {
        // Verificar se o SDK do Mercado Pago est√° carregado
        if (typeof mp === 'undefined') {
            console.error('‚ùå SDK do Mercado Pago n√£o carregado');
            return;
        }
        
        console.log('üîÑ Inicializando cardForm...');

        // Nota: O amount aqui na inicializa√ß√£o serve para c√°lculo de parcelas pelo MP.
        // O valor REAL da cobran√ßa ser√° enviado no onSubmit.
        const initialPrice = currentPlanPrice; 
        
        cardFormInstance = mp.cardForm({
            amount: String(initialPrice), // MP recomenda string para evitar flutuantes estranhos
            autoMount: true,
            form: {
                id: 'form-cartao',
                cardNumber: { id: 'cardNumber' },
                expirationDate: { id: 'expirationDate' },
                securityCode: { id: 'securityCode' },
                cardholderName: { id: 'cardholderName' },
                cardholderEmail: { id: 'cardholderEmail' },
                issuer: { id: 'issuer' },
                installments: { id: 'installments' },
                identificationType: { id: 'identificationType' },
                identificationNumber: { id: 'identificationNumber' }
            },
            callbacks: {
                onFormMounted: error => {
                    if (error) {
                        console.error('‚ùå Erro ao montar formul√°rio:', error);
                        cardFormInstance = null;
                    } else {
                        console.log('‚úÖ CardForm inicializado com sucesso!');
                    }
                },

                onSubmit: async (event) => {
                    event.preventDefault();

                    const btn = document.getElementById('card-payment-start');
                    const feedback = document.getElementById('card-feedback');

                    try {
                        btn.disabled = true;
                        // Mostra o valor que est√° sendo processado para o usu√°rio ver
                        feedback.innerHTML = `‚è≥ Processando R$ ${currentPlanPrice}...`;

                        const data = cardFormInstance.getCardFormData();

                        // Corre√ß√£o para o ano (caso venha 4 d√≠gitos, o MP as vezes prefere 2)
                        if (data.expirationYear && data.expirationYear.length === 4) {
                            data.expirationYear = data.expirationYear.slice(-2);
                        }

                        if (!data.token) {
                            throw new Error('Token n√£o gerado pelo Mercado Pago. Verifique os dados.');
                        }

                        // --- AQUI EST√Å A CORRE√á√ÉO PRINCIPAL ---
                        // Pegamos as vari√°veis globais AGORA, no momento do clique.
                        const paymentData = {
                            token: data.token,
                            payment_method_id: data.paymentMethodId,
                            installments: parseInt(data.installments),
                            email: data.cardholderEmail,
                            issuer_id: data.issuerId, // Importante enviar o banco emissor
                            
                            // Enviando os dados globais para a API PHP:
                            userId: localStorage.getItem('userId'),
                            transaction_amount: currentPlanPrice, // <--- Valor Atualizado
                            description: currentPlanName,          // <--- Nome Atualizado
                            is_trial: true // <--- DICA: Envie essa flag para o PHP saber que √© teste gr√°tis
                        };

                        console.log("üì§ Enviando pagamento:", paymentData); // Debug

                        const res = await fetch(
                            'api.php?action=create-card-payment',
                            {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json','X-Timezone': userTimezone },
                                body: JSON.stringify(paymentData)                                
                            }
                        );

                        const json = await res.json();

                        if (json.success && json.status === 'approved') {
                            feedback.innerHTML = '‚úÖ Pagamento aprovado!';
                            localStorage.setItem('isPremium', 'true');
                            setTimeout(() => location.reload(), 1500);
                        } else {
                            // Exibe mensagem de erro do MP se houver
                            feedback.innerHTML = '‚ùå ' + (json.message || 'Pagamento recusado');
                            btn.disabled = false;
                        }

                    } catch (err) {
                        console.error(err);
                        feedback.innerHTML = '‚ö†Ô∏è ' + err.message;
                        btn.disabled = false;
                    }
                }
            }
        });
        
    } catch (error) {
        console.error('‚ùå Erro na inicializa√ß√£o do cardForm:', error);
        cardFormInstance = null;
    }
}

async function generatePixCode() {
    // 1. Defini√ß√£o dos elementos
    const btnConfirm = document.querySelector('#modal-premium-hope button[onclick="processSubscription()"]');
    const modalVendas = document.getElementById('modal-premium-hope');
    const modalPix = document.getElementById('modal-pix-payment');
    
    // Elementos onde vamos colocar os dados do PIX
    const inputCopiaCola = document.getElementById('pix-copia-cola');
    const imgQr = document.getElementById('pix-qr-image');

    // 2. Verifica√ß√£o de Seguran√ßa (Aqui estava o seu erro!)
    if (!inputCopiaCola || !imgQr) {
        console.error("ERRO CR√çTICO: Elementos do modal PIX n√£o encontrados no HTML (pix-copia-cola ou pix-qr-image).");
        showModal('Falha',"Erro interno: Modal de PIX incompleto.");
        return;
    }

    // Feedback visual de carregamento
    const originalText = btnConfirm ? btnConfirm.innerText : '';
    if (btnConfirm) {
        btnConfirm.innerText = "Gerando PIX...";
        btnConfirm.disabled = true;
    }

    try {
        // Usa as vari√°veis globais que definimos antes (currentPlanPrice)
        // Se voc√™ usa 'selectedPlan' no seu c√≥digo antigo, ajuste aqui
        const valor = typeof currentPlanPrice !== 'undefined' ? currentPlanPrice : 29.90;
        const descricao = typeof currentPlanName !== 'undefined' ? currentPlanName : 'Plano Premium';

        console.log("Enviando pedido PIX:", valor, descricao);

        const response = await fetch('api.php?action=create-pix-payment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json','X-Timezone': userTimezone },
            body: JSON.stringify({
                userId: localStorage.getItem('userId'),
                transaction_amount: valor,
                description: descricao,
                email: localStorage.getItem('userEmail') || 'cliente@app.com'                
            })
        });

        const json = await response.json();

        if (json.success) {
            console.log("‚úÖ PIX Criado. C√≥digo:", json.qr_code);

            // 1. Preencher o input 'Copia e Cola'
            if (inputCopiaCola) {
                inputCopiaCola.value = json.qr_code;
            }

            // 2. Gerar a Imagem do QR Code (SOLU√á√ÉO ROBUSTA)
            const canvasElement = document.getElementById('pix-qr-canvas');
            
            if (canvasElement && json.qr_code) {
                // Usa a biblioteca QRious para desenhar o QR Code na hora
                const qr = new QRious({
                    element: canvasElement,
                    value: json.qr_code, // O c√≥digo de texto do PIX
                    size: 250,           // Tamanho em pixels
                    level: 'H'           // N√≠vel de corre√ß√£o de erro (High)
                });
                console.log("üé® QR Code desenhado no canvas com sucesso.");
            } else {
                console.error("‚ùå Elemento canvas n√£o encontrado ou c√≥digo PIX vazio.");
            }

            // 3. Troca de Modais
            if (modalVendas) {
                modalVendas.style.display = 'none';
                modalVendas.classList.remove('active'); 
            }
            
            if (modalPix) modalPix.classList.remove('hidden');

        } else {
            showModal('Falha',"Erro ao gerar PIX: " + (json.message || 'Desconhecido'));
        }

    } catch (e) {
        console.error("Erro na requisi√ß√£o PIX:", e);
        showModal('Falha',"Erro de conex√£o ao gerar o PIX.");
    } finally {
        // Restaura bot√£o original caso tenha dado erro
        if (btnConfirm) {
            btnConfirm.innerText = originalText;
            btnConfirm.disabled = false;
        }
    }
}

// Fun√ß√£o para processar o pagamento (executada pelo bot√£o)
async function processCardPayment() {
    const btn = document.getElementById('card-payment-start');
    const feedback = document.getElementById('card-feedback');

    if (btn.disabled) return;

    try {
        if (!cardFormInstance) {
            throw new Error('Formul√°rio do cart√£o n√£o inicializado');
        }

        btn.disabled = true;
        feedback.innerHTML = '‚è≥ Processando pagamento...';

        const cardFormData = cardFormInstance.getCardFormData();

        if (!cardFormData.token) {
            throw new Error('Falha ao gerar token do cart√£o');
        }

        const paymentData = {
            token: cardFormData.token,
            payment_method_id: cardFormData.paymentMethodId,
            installments: parseInt(cardFormData.installments),
            email: cardFormData.cardholderEmail,
            userId: localStorage.getItem('userId')
        };

        const res = await fetch('api.php?action=create-card-payment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Timezone': userTimezone },
            body: JSON.stringify(paymentData),            
        });

        const json = await res.json();

        if (json.success && json.status === 'approved') {
            feedback.innerHTML = '‚úÖ Pagamento aprovado!';
            localStorage.setItem('isPremium', 'true');
            setTimeout(() => location.reload(), 1500);
        } else {
            feedback.innerHTML = '‚ùå Pagamento recusado';
            btn.disabled = false;
        }

    } catch (err) {
        console.error(err);
        feedback.innerHTML = '‚ö†Ô∏è ' + err.message;
        btn.disabled = false;
    }
}

// Vincular a fun√ß√£o ao bot√£o
document.getElementById('card-payment-start')
  ?.addEventListener('click', () => {
      cardFormInstance.submit();
  });

// Inicializar quando o DOM estiver pronto
document.addEventListener('DOMContentLoaded', () => {
    console.log('üé¨ DOM carregado, inicializando cardForm...');
    
    // Aguardar um pouco para garantir que o SDK do MP carregou
    setTimeout(() => {
        initCardPayment();
    }, 500);
});

//-- GEST√ÉO ASSINATURA DO PLANO

function openCancelPlanModal() {
    // 1. Verificar explicitamente se o usu√°rio J√Å √â Premium
    // (Geralmente salvo como string 'true' no localStorage)
    const isPremium = localStorage.getItem('isPremium') === 'true';

    // 2. Se N√ÉO for premium, exibe a tela de vendas e PARA a execu√ß√£o
    if (!isPremium) {
        checkPremiumFeature(); // Abre o modal de "Seja Premium"
        
        // Fecha o dropdown para n√£o ficar atrapalhando visualmente
        const dropdown = document.getElementById('acura-dropdown');
        if(dropdown) dropdown.classList.add('hidden');

        return; // <--- O PULO DO GATO: Isso impede que o c√≥digo abaixo rode
    }

    // --- O c√≥digo abaixo s√≥ ser√° executado se o usu√°rio FOR Premium ---

    console.log("Abrindo modal de cancelamento..."); 
    
    // Tenta fechar o dropdown se ele existir e estiver aberto
    const dropdown = document.getElementById('acura-dropdown');
    if(dropdown) dropdown.classList.add('hidden');
    
    // Abre o modal removendo a classe 'hidden'
    const modal = document.getElementById('modal-cancel-plan');
    if(modal) {
        modal.classList.remove('hidden');
    } else {
        console.error("Erro: Elemento 'modal-cancel-plan' n√£o encontrado no DOM.");
        // Verifica se a fun√ß√£o showModal existe antes de chamar
        if (typeof showModal === "function") {
            showModal('Falha', "Erro ao abrir janela de cancelamento.");
        } else {
            showModal('Falha',"Erro ao abrir janela de cancelamento.");
        }
    }
}

function closeCancelPlanModal() {
    const modal = document.getElementById('modal-cancel-plan');
    if(modal) modal.classList.add('hidden');
}

async function confirmCancelPlan() {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    const btn = document.querySelector('#modal-cancel-plan button[onclick="confirmCancelPlan()"]');
    const originalText = btn ? btn.innerHTML : 'Confirmar';
    
    // Feedback visual
    if (btn) {
        // TRADU√á√ÉO: Processando
        const txtProcessing = t['btnProcessing'] || 'Processando...';
        btn.innerHTML = `<span class="loading-spinner"></span> ${txtProcessing}`;
        btn.disabled = true;
    }

    try {
        const userId = localStorage.getItem('userId');
        
        // Verifica se o ID do usu√°rio existe
        if (!userId) {
            // TRADU√á√ÉO: Usu√°rio n√£o identificado
            showModal(t['modalErrorTitle'] || 'Falha', t['msgUserNotAuth'] || "Erro: Usu√°rio n√£o identificado. Fa√ßa login novamente.");
            return;
        }

        // Chama a API
        const response = await fetch('api.php?action=plan-cancel', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json', 
                'X-Timezone': (typeof userTimezone !== 'undefined' ? userTimezone : 'UTC'),
                'X-Lang': (typeof currentLang !== 'undefined') ? currentLang : 'pt' // Importante para e-mails transacionais
            },
            body: JSON.stringify({ userId: userId })            
        });

        const json = await response.json();

        if (json.success) {
            localStorage.setItem('isPremium', 'false');
            
            // TRADU√á√ÉO: Sucesso no cancelamento
            showModal(t['titleFreeMode'] || 'Modo Free ativado..', t['msgPlanCanceled'] || 'Plano cancelado com sucesso.');
            
            if (typeof closeCancelPlanModal === 'function') {
                closeCancelPlanModal();
            } else {
                document.getElementById('modal-cancel-plan').classList.add('hidden');
            }
            
            setTimeout(() => location.reload(), 1000);
        } else {
            // TRADU√á√ÉO: Erro da API
            const errorPrefix = t['msgErrorPrefix'] || 'Erro: ';
            const failMsg = t['msgCancelFailed'] || 'Falha ao cancelar';
            showModal(t['modalErrorTitle'] || 'Falha', errorPrefix + (json.message || failMsg));
        }
    } catch (error) {
        console.error(error);
        // TRADU√á√ÉO: Erro de conex√£o
        showModal(t['modalErrorTitle'] || 'Falha', t['msgConnectionErrorCancel'] || 'Erro de conex√£o ao tentar cancelar.');
    } finally {
        if(btn) {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }
}

//controle de cateter

// --- L√≥gica de Controle do Cateter ---

// Vari√°vel de estado global (deve vir do seu banco de dados posteriormente)
let hasActiveCatheter = false; 

/**
 * Fun√ß√£o chamada ao carregar a p√°gina e ao alterar o status
 */
function updateCatheterUI() {
    const icon = document.getElementById('catheter-icon');
    
    if (icon) {
        if (hasActiveCatheter) {
            // Estado COM Cateter: Vermelho (Indica fluxo/sangue/aten√ß√£o)
            icon.classList.remove('text-gray-300');
            icon.classList.add('text-red-500');
        } else {
            // Estado SEM Cateter: Cinza claro (Discreto)
            icon.classList.remove('text-red-500');
            icon.classList.add('text-gray-300');
        }
    }
}

/**
 * Fun√ß√£o chamada ao clicar na seta
 */
function openCatheterModal() {
    // L√≥gica simulada. Aqui voc√™ abrir√° seu modal real de cadastro.
    const novoStatus = !hasActiveCatheter;
    const acao = novoStatus ? "CADASTRAR" : "REMOVER";
    
    // Confirma√ß√£o simples para teste (substitua pelo seu modal real)
    // Se usar customConfirm, lembre de colocar 'async' na fun√ß√£o e 'await'
    const confirmacao = confirm(`Deseja ${acao} o cateter do paciente?`);
    
    if (confirmacao) {
        hasActiveCatheter = novoStatus;
        updateCatheterUI();
        
        // Exemplo de como salvar no futuro:
        // apiPost('update-catheter', { status: hasActiveCatheter, patientId: ... });
    }
}

// --- CONTROLE DO MODAL DE CATETER ---

// Fun√ß√£o chamada pelo bot√£o da seta (que criamos anteriormente)
function openCatheterModal() {
    document.getElementById('modal-cateter').classList.remove('hidden');
    switchCatheterTab('active'); // Abre na aba de ativos por padr√£o
}

function closeCatheterModal() {
    document.getElementById('modal-cateter').classList.add('hidden');
}

// Troca de Abas
function switchCatheterTab(tab) {
    const btnActive = document.getElementById('tab-cat-active');
    const btnAdd = document.getElementById('tab-cat-add');
    const contentActive = document.getElementById('content-cat-active');
    const contentAdd = document.getElementById('content-cat-add');

    if (tab === 'active') {
        // Estilo Aba Ativa
        btnActive.className = "flex-1 py-3 px-4 text-center font-medium text-indigo-600 border-b-2 border-indigo-600 bg-indigo-50";
        btnAdd.className = "flex-1 py-3 px-4 text-center font-medium text-gray-500 hover:text-indigo-600";
        
        contentActive.classList.remove('hidden');
        contentAdd.classList.add('hidden');
        
        loadActiveCatheters(); // Recarrega a lista
    } else {
        // Estilo Aba Adicionar
        btnAdd.className = "flex-1 py-3 px-4 text-center font-medium text-indigo-600 border-b-2 border-indigo-600 bg-indigo-50";
        btnActive.className = "flex-1 py-3 px-4 text-center font-medium text-gray-500 hover:text-indigo-600";
        
        contentAdd.classList.remove('hidden');
        contentActive.classList.add('hidden');
    }
}

// --- CARREGAR LISTA DE CATETERES ---
async function loadActiveCatheters() {
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    // 2. Define o locale de data
    const localeMap = { 'pt': 'pt-BR', 'en': 'en-US', 'es': 'es-ES' };
    const dateLocale = (typeof currentLang !== 'undefined' && localeMap[currentLang]) ? localeMap[currentLang] : 'pt-BR';

    const container = document.getElementById('catheter-list-container');
    if (!container) return;
    
    // TRADU√á√ÉO: Carregando
    const msgLoading = t['msgLoading'] || 'Carregando...';
    container.innerHTML = `<p class="text-center text-gray-500">${msgLoading}</p>`;

    const pid = (typeof state !== 'undefined' && state.patientId) ? state.patientId : new URLSearchParams(window.location.search).get('patientId');
    if(!pid) return;

    try {
        const resp = await fetch(`api.php?action=get-catheters&patient_id=${pid}`);
        const result = await resp.json();

        // Atualiza o estado global
        hasActiveCatheter = (result.data && result.data.length > 0);
        if(typeof updateCatheterUI === 'function') updateCatheterUI();

        if (!result.success || !result.data || result.data.length === 0) {
            // TRADU√á√ÉO: Estado Vazio
            const msgNoCatheter = t['msgNoCatheter'] || 'Nenhum cateter ativo encontrado.';
            const btnRegisterNew = t['btnRegisterNew'] || 'Cadastrar Novo';
            
            container.innerHTML = `
                <div class="text-center py-8">
                    <p class="text-gray-500 mb-4">${msgNoCatheter}</p>
                    <button onclick="switchCatheterTab('add')" class="text-indigo-600 font-bold hover:underline">${btnRegisterNew}</button>
                </div>`;
            return;
        }

        container.innerHTML = '';
        
        // Define "Hoje" como Meia-Noite (ignora hora atual para compara√ß√£o de prazo)
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);

        // TRADU√á√ÉO: Textos fixos do card
        const lblDefaultName = t['labelCatheter'] || 'Cateter';
        const lblInsertedIn = t['lblInsertedIn'] || 'Inserido em:';
        const lblManufacturer = t['lblManufacturer'] || 'Fabricante:';
        const lblGauge = t['lblGauge'] || 'Calibre:';
        const statusActive = t['statusActive'] || 'Ativo';
        const lblNextFlush = t['lblNextFlush'] || 'Pr√≥ximo Flush';
        const lblNextDressing = t['lblNextDressing'] || 'Pr√≥ximo Curativo';
        const tagToday = t['tagToday'] || '(HOJE)';
        const btnMaintenance = t['btnMaintenance'] || 'Manuten√ß√£o';
        const btnRemoved = t['btnRemoved'] || 'Retirado';

        result.data.forEach(cat => {
            const baseDateStr = cat.ultima_manutencao || cat.data_insercao;
            if (!baseDateStr) return;

            // Parse seguro da data
            let lastMaint;
            if (baseDateStr.includes('-')) {
                // Formato YYYY-MM-DD
                const parts = baseDateStr.split(' ')[0].split('-');
                lastMaint = new Date(parts[0], parts[1] - 1, parts[2]);
            } else {
                lastMaint = new Date(baseDateStr.replace(" ", "T"));
            }

            // C√°lculos
            const nextFlush = new Date(lastMaint);
            nextFlush.setDate(nextFlush.getDate() + parseInt(cat.freq_flush || 0));
            
            const nextCurativo = new Date(lastMaint);
            nextCurativo.setDate(nextCurativo.getDate() + parseInt(cat.freq_curativo || 0));

            // Verifica√ß√µes
            const atrasadoFlush = hoje.getTime() > nextFlush.getTime();
            const atrasadoCurativo = hoje.getTime() > nextCurativo.getTime();
            const hojeFlush = hoje.getTime() === nextFlush.getTime();
            const hojeCurativo = hoje.getTime() === nextCurativo.getTime();
            
            const temPendencia = atrasadoFlush || atrasadoCurativo || hojeFlush || hojeCurativo;

            // SEGURAN√áA: Sanitiza√ß√£o de dados do usu√°rio
            const safeType = escapeHtml(cat.tipo || lblDefaultName);
            const safeAccess = escapeHtml(cat.local_acesso || 'N/A');
            const safeFab = escapeHtml(cat.fabricante || '-');
            const safeCalibre = escapeHtml(cat.calibre || '-');
            
            // Formata√ß√£o de Datas Localizada
            const dateInsercao = new Date(cat.data_insercao.replace(" ","T")).toLocaleDateString(dateLocale);
            const dateFlush = nextFlush.toLocaleDateString(dateLocale);
            const dateCurativo = nextCurativo.toLocaleDateString(dateLocale);

            const html = `
                <div class="bg-white border rounded-lg shadow-sm p-4 mb-4 relative border-l-4 ${temPendencia ? 'border-orange-500 shadow-md' : 'border-indigo-500'}">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h3 class="font-bold text-lg text-gray-800">${safeType} (${safeAccess})</h3>
                            <p class="text-xs text-gray-500">${lblInsertedIn} ${dateInsercao}</p>
                            <p class="text-xs text-gray-500 font-medium">${lblManufacturer} ${safeFab} | ${lblGauge} ${safeCalibre}</p>
                        </div>
                        <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-bold">${statusActive}</span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 my-3 text-sm">
                        <div class="bg-gray-50 p-2 rounded ${hojeFlush ? 'ring-2 ring-orange-300' : ''}">
                            <span class="block text-xs text-gray-500">${lblNextFlush}</span>
                            <span class="font-bold ${atrasadoFlush ? 'text-red-600' : (hojeFlush ? 'text-orange-600' : 'text-gray-800')}">
                                ${dateFlush} ${hojeFlush ? tagToday : ''}
                            </span>
                        </div>

                        <div class="bg-gray-50 p-2 rounded ${hojeCurativo ? 'ring-2 ring-orange-300' : ''}">
                            <span class="block text-xs text-gray-500">${lblNextDressing}</span>
                            <span class="font-bold ${atrasadoCurativo ? 'text-red-600' : (hojeCurativo ? 'text-orange-600' : 'text-gray-800')}">
                                ${dateCurativo} ${hojeCurativo ? tagToday : ''}
                            </span>
                        </div>
                    </div>

                    <div class="flex gap-2 mt-4">
                        <button onclick="openChecklistModal('${cat.id}')" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold py-2 rounded flex items-center justify-center gap-2 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>
                            ${btnMaintenance}
                        </button>
                        <button onclick="removeCatheter('${cat.id}')" class="bg-red-50 hover:bg-red-100 text-red-600 text-sm font-bold py-2 px-4 rounded transition-colors">
                            ${btnRemoved}
                        </button>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        });

    } catch (e) {
        console.error("Erro ao carregar cateteres:", e);
        // TRADU√á√ÉO: Erro de conex√£o
        const msgError = t['msgConnectionError'] || 'Erro ao conectar com o servidor.';
        container.innerHTML = `<p class="text-red-500 text-center">${msgError}</p>`;
    }
}

// --- SALVAR NOVO CATETER ---
document.getElementById('form-add-catheter').addEventListener('submit', async (e) => {
    e.preventDefault();
    const pid = (typeof state !== 'undefined' && state.patientId) ? state.patientId : new URLSearchParams(window.location.search).get('patientId');

    const payload = {
        patient_id: pid,
        tipo: document.getElementById('cat_tipo').value,
        fabricante: document.getElementById('cat_fabricante').value,
        local_acesso: document.getElementById('cat_local').value,
        numero_lumens: document.getElementById('cat_lumens').value,
        calibre: document.getElementById('cat_calibre').value,
        comprimento: document.getElementById('cat_comp').value,
        metodo_insercao: document.getElementById('cat_metodo').value,
        confirmacao_rx: document.getElementById('cat_rx').value,
        data_insercao: document.getElementById('cat_data').value,
        intercorrencias: document.getElementById('cat_inter').value,
        freq_flush: document.getElementById('cat_freq_flush').value,
        freq_curativo: document.getElementById('cat_freq_curativo').value
    };

    try {
        const resp = await fetch('api.php?action=save-catheter', {
            method: 'POST',
            headers: {'Content-Type': 'application/json','X-Timezone': userTimezone},
            body: JSON.stringify(payload)            
        });
        const res = await resp.json();
        
        if (res.success) {
            showModal("Sucesso",'Cateter cadastrado com sucesso!');
            document.getElementById('form-add-catheter').reset();
            switchCatheterTab('active');
        } else {
            showModal("Falha",'Erro ao salvar.');
        }
    } catch(e) {
        console.error(e);
        showModal("Falha",'Erro de conex√£o.');
    }
});

// --- REMOVER CATETER ---
async function removeCatheter(id) {
    // CORRE√á√ÉO: Adicionado 'await' para esperar a decis√£o do usu√°rio
    const confirmado = await customConfirm(
        'Cateter retirado do corpo',
        'Confirmar a RETIRADA? O registro ser√° movido para o hist√≥rico.'
    );

    // Se o usu√°rio cancelar (retornar false), paramos aqui.
    if (!confirmado) return;
    
    try {
        const resp = await fetch('api.php?action=remove-catheter', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json', // MELHORIA: Boa pr√°tica informar o tipo
                'X-Timezone': userTimezone
            },
            body: JSON.stringify({id: id})
        });

        // MELHORIA: Verifica se o servidor respondeu com sucesso (c√≥digo 200-299)
        // O fetch sozinho n√£o lan√ßa erro para erros 400/500 do servidor.
        if (!resp.ok) {
            throw new Error('Falha na comunica√ß√£o com o servidor');
        }

        // Se sua API retornar um JSON, √© ideal verificar o success tamb√©m:
        // const data = await resp.json();
        // if (!data.success) throw new Error(data.message || 'Erro desconhecido');

        // Recarrega a lista
        loadActiveCatheters();

        // Opcional: Feedback visual de sucesso
        // showStatusMessage("Cateter removido com sucesso."); 

    } catch(e) { 
        console.error("Erro ao remover cateter:", e); // Log para debug
        showModal("Falha", 'Erro ao remover o registro.'); 
    }
}

// --- CHECKLIST DE MANUTEN√á√ÉO ---
function openChecklistModal(catId) {
    document.getElementById('checklist_cat_id').value = catId;
    // Reseta checkboxes
    document.querySelectorAll('#modal-checklist-cateter input[type="checkbox"]').forEach(c => c.checked = false);
    document.getElementById('checklist_obs').value = '';
    
    document.getElementById('modal-checklist-cateter').classList.remove('hidden');
}

function closeChecklistModal() {
    document.getElementById('modal-checklist-cateter').classList.add('hidden');
    //atualiza a agenda
    Atualiza_Agenda();
}

async function submitMaintenance() {
    const catId = document.getElementById('checklist_cat_id').value;
    const obs = document.getElementById('checklist_obs').value;
    
    // Valida√ß√£o simples
    const checked = document.querySelectorAll('#modal-checklist-cateter input[type="checkbox"]:checked');
    if (checked.length < 3) {
        showModal("Aten√ß√£o",'Por favor, marque os itens realizados no checklist.');
        return;
    }

    try {
        const resp = await fetch('api.php?action=log-catheter-maintenance', {
            method: 'POST',
            body: JSON.stringify({
                catheter_id: catId,
                observacoes: obs                
            })
        });
        
        showModal("Sucesso",'Manuten√ß√£o registrada!');
        closeChecklistModal();
        loadActiveCatheters(); // Recarrega para atualizar datas
        Atualiza_Agenda();
    } catch(e) { showModal("Falha",'Erro ao registrar manuten√ß√£o'); }
}

//verifica a vers√£o do webapp e avisa ao cuidador
// Defina a vers√£o atual do c√≥digo que est√° rodando no navegador
const CURRENT_VERSION = "1.0.14"; // Voc√™ atualiza isso manualmente no c√≥digo quando sobe uma vers√£o nova

async function checkForUpdates() {
    try {
        // Adiciona timestamp para evitar que o navegador leia o JSON do cache
        const response = await fetch(`version.json?t=${new Date().getTime()}`); 
        const data = await response.json();

        if (data.version !== CURRENT_VERSION) {
            console.log(`Nova vers√£o dispon√≠vel: ${data.version}`);
            
            // L√≥gica para FOR√áAR ou SUGERIR
            if (data.force_update) {
                showModal('Importante',`Atualiza√ß√£o Cr√≠tica Necess√°ria:\n${data.message}`);
                window.location.reload(true); // Recarrega for√ßado
            } else {
                showUpdateBanner(data.message);
            }
        }
    } catch (error) {
        console.warn('N√£o foi poss√≠vel verificar atualiza√ß√µes', error);
    }
}

function showUpdateBanner(msg) {
    const banner = document.getElementById('updateBanner');
    const msgElement = document.getElementById('updateMsg');
    
    if(banner) {
        if(msg) msgElement.textContent = msg;
        banner.classList.remove('hidden');
    }
}

// Fun√ß√£o para Abrir/Fechar o Modal
function toggleContactModal(show) {
    const modal = document.getElementById('contactModal');
    if (show) {
        modal.classList.remove('hidden');
        document.getElementById('contactForm').reset(); // Limpa campos anteriores
    } else {
        modal.classList.add('hidden');
    }
}

// Fun√ß√£o de Envio de mensagem para o suporte
async function enviarFaleConosco(e) {
    e.preventDefault();
    
    // 1. Obt√©m o dicion√°rio de tradu√ß√£o atual
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    const subject = document.getElementById('contactSubject').value;
    const message = document.getElementById('contactMessage').value;
    const btn = document.getElementById('btnSendContact');
    
    // Feedback visual de carregamento
    const textoOriginal = btn.innerHTML;
    btn.disabled = true;
    
    // TRADU√á√ÉO: Texto do bot√£o em loading
    const txtSending = t['btnSending'] || 'Enviando...';
    btn.innerHTML = `<span class="loading-spinner"></span> ${txtSending}`;

    try {
        const userId = localStorage.getItem('userId') || (typeof currentUser !== 'undefined' ? currentUser.id : null);

        const response = await fetch('api.php?action=contact-support', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: userId,
                subject: subject,
                message: message
            })
        });

        const data = await response.json();

        if (data.success) {
            // TRADU√á√ÉO: Sucesso
            showModal(t['modalThankYouTitle'] || 'Obrigado', t['msgMessageSent'] || 'Mensagem enviada com sucesso!');
            toggleContactModal(false);
        } else {
            // TRADU√á√ÉO: Erro da API
            const errorPrefix = t['msgSendErrorPrefix'] || 'Erro ao enviar: ';
            const msgTryAgain = t['msgTryAgain'] || 'Tente novamente.';
            showModal(t['modalErrorTitle'] || 'Falha', errorPrefix + (data.message || msgTryAgain));
        }

    } catch (error) {
        console.error(error);
        // TRADU√á√ÉO: Erro de conex√£o
        showModal(t['modalErrorTitle'] || 'Falha', t['msgConnectionError'] || 'Erro de conex√£o.');
    } finally {
        btn.disabled = false;
        btn.innerHTML = textoOriginal;
    }
}

// Verifica assim que carrega e depois a cada 10 minutos (600000 ms)
document.addEventListener('DOMContentLoaded', () => {
    // Atualiza a vers√£o na tela
    const versionEl = document.getElementById('app-version-display');
    if (versionEl) {
        versionEl.innerText = CURRENT_VERSION;
    }
    checkForUpdates();
    setInterval(checkForUpdates, 600000); 
});


// Inicializa a UI assim que o script rodar
document.addEventListener('DOMContentLoaded', () => {
    updateCatheterUI();
});


// para os bot√µes de ignorar e suspender dose ( ajustes especiais por causa do DOM reescrito)
document.addEventListener('click', async function (e) {

    const btnIgnorar = e.target.closest('#btnIgnorarDose');
    if (btnIgnorar) {
        e.preventDefault();
        e.stopPropagation();

        if (typeof doseEmAcaoId === 'undefined' || doseEmAcaoId === null) {
            console.warn('doseEmAcaoId inv√°lido');
            return;
        }

        const observacao = document.getElementById('motivoObservacao')?.value || '';
        processarDoseComObservacao(doseEmAcaoId, 'Ignorada', observacao);
        showModal('Dose ignorada para o hor√°rio atual.');
       
        // 1. Parar o som do alarme (Chama o seu AlarmSystem)
            if (typeof AlarmSystem !== 'undefined' && AlarmSystem.stopAlarm) {
                AlarmSystem.stopAlarm();
            }
        return;
    }

    const btnSuspender = e.target.closest('#btnSuspenderReceita');
    if (btnSuspender) {
        e.preventDefault();
        e.stopPropagation();

        if (typeof doseEmAcaoId === 'undefined' || doseEmAcaoId === null) {
            console.warn('doseEmAcaoId inv√°lido');
            return;
        }

        const confirmed = await customConfirm(
            'ATEN√á√ÉO:',
            'Voc√™ tem certeza que deseja SUSPENDER o uso desta receita?'
        );

        if (!confirmed) return;

        const observacao = document.getElementById('motivoObservacao')?.value || '';
        processarDoseComObservacao(doseEmAcaoId, 'Suspensa', observacao);
        showModal('Uso da medica√ß√£o suspenso.');
        // 1. Parar o som do alarme (Chama o seu AlarmSystem)
            if (typeof AlarmSystem !== 'undefined' && AlarmSystem.stopAlarm) {
                AlarmSystem.stopAlarm();
            }
        return;
    }

});

/**
 * Wearables e Bluetooth (BLT) - Sistema de Monitoramento de Sinais Vitais Consolidado
 */

// 1. Inicializa√ß√£o do Estado e Constantes
if (!window.state) window.state = {};
state.activeServers = state.activeServers || {};

const BLE_CONFIG = {
    XIAOMI: '0000fee0-0000-1000-8000-00805f9b34fb', // Mi Band / Amazfit
    HR: 0x180D,   // Heart Rate
    TEMP: 0x1809, // Thermometer
    SPO2: 0x1822, // Pulse Oximeter
    BP: 0x1810,   // Blood Pressure
    BATT: 0x180F  // Battery Service
};

// ================= CONFIGURA√á√ÉO DE RECONEX√ÉO =================
const RECONNECT_CONFIG = {
    maxAttempts: 5,        // Tentar no m√°ximo 5 vezes
    baseDelay: 2000,       // Come√ßar esperando 2 segundos (2s, 4s, 8s...)
    isIntentional: false   // Flag para saber se foi o usu√°rio que clicou em sair
};

const sensorState = {
    hr: null,
    temp: null,
    spo2: null,
    bp_sys: null,
    activeAlarms: new Set()
};

// Vari√°vel de controle para n√£o inundar a API
let ultimaNotificacaoEnviada = false;

// 2. Processamento de Dados e Alarmes
function processVitals(type, value) {
    const display = document.getElementById(`val-${type === 'bp_sys' ? 'bp' : type}`);
    if (!display) return;

    const min = parseFloat(document.getElementById(`limit-${type}-min`)?.value || -999);
    const max = parseFloat(document.getElementById(`limit-${type}-max`)?.value || 999);
    
    sensorState[type] = value;

    if (type === 'temp') display.innerText = value.toFixed(1);
    else if (type === 'bp_sys') display.innerText = value; 
    else display.innerText = value;

    const isOutOfLimit = (value < min || value > max);
    const alarmKey = `alarm-${type}`;

    if (isOutOfLimit) {
        sensorState.activeAlarms.add(alarmKey);
        display.classList.add('animate-pulse', 'text-red-500', 'brightness-150');
    } else {
        sensorState.activeAlarms.delete(alarmKey);
        display.classList.remove('animate-pulse', 'text-red-500', 'brightness-150');
    }

    updateAlarmUI();
    adquirirWakeLock(); //impede a tela de fechar
}

// 3. Atualiza√ß√£o da UI do Bot√£o de Notifica√ß√£o
async function updateAlarmUI() {
    const btn = document.getElementById('notificationBtn');
    if (!btn) return;

    const temAlarmeAtivo = sensorState.activeAlarms.size > 0;

    // L√≥gica Visual do Bot√£o
    if (temAlarmeAtivo || state.isNotificationActive) {
        btn.classList.add('animate-pulse-glow');
        
        // Se o alarme veio do WEARABLE e ainda n√£o avisamos a API...
        if (temAlarmeAtivo && !ultimaNotificacaoEnviada) {
            await notificarEnfermagemAPI(1); // Ativa Notifica√ß√£o na Tabela Patients
            ultimaNotificacaoEnviada = true;
        }
    } else {
        btn.classList.remove('animate-pulse-glow');
        
        
        // Se os sinais voltaram ao normal e o alarme estava ativo por wearable
        if (!temAlarmeAtivo && ultimaNotificacaoEnviada) {
            // Opcional: Desativar a notifica√ß√£o automaticamente quando o sinal normalizar
            // await notificarEnfermagemAPI(0); 
            ultimaNotificacaoEnviada = false;
        }
    }
}

// 3.5 Chamada ao Endpoint update-notification-status
async function notificarEnfermagemAPI(status) {
    // Certifique-se que o state.patientId est√° preenchido
    if (!state.patientId) {
        console.warn("API: Tentativa de notificar sem Patient ID definido.");
        return;
    }

    try {
        const response = await fetch('api.php?action=update-notification-status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                patientId: state.patientId,
                status: status, // 1 para Ativo, 0 para Inativo
                observation: "Alerta Autom√°tico: Sinais Vitais fora do limite (Wearable)"
            })
        });

        const result = await response.json();
        if (result.success) {
            console.log(`API: Enfermagem notificada (Status: ${status})`);
        }
    } catch (error) {
        console.error("Erro ao comunicar com a API de notifica√ß√£o:", error);
    }
}

// 4. Decodificadores IEEE-11073 (Essenciais para dispositivos m√©dicos)
function decodeIEEE11073FLOAT(dataView, offset) {
    const b0 = dataView.getUint8(offset);
    const b1 = dataView.getUint8(offset + 1);
    const b2 = dataView.getUint8(offset + 2);
    let mantissa = b0 | (b1 << 8) | (b2 << 16);
    if (mantissa & 0x800000) mantissa -= 0x1000000;
    const exponent = dataView.getInt8(offset + 3);
    return mantissa * Math.pow(10, exponent);
}

function decodeSFLOAT(value) {
    let mantissa = value & 0x0FFF;
    if (mantissa >= 0x0800) mantissa -= 0x1000;
    const exponent = value >> 12;
    if (exponent >= 0x08) exponent -= 0x10;
    return mantissa * Math.pow(10, exponent);
}

// 5. Handlers de Sensores
async function setupHeartRate(server) {
    try {
        const service = await server.getPrimaryService(BLE_CONFIG.HR);
        const char = await service.getCharacteristic(0x2A37);
        await char.startNotifications();
        char.addEventListener('characteristicvaluechanged', (ev) => {
            const v = ev.target.value;
            const flags = v.getUint8(0);
            const hr = (flags & 0x01) === 1 ? v.getUint16(1, true) : v.getUint8(1);
            processVitals('hr', hr);
        });
        showModal("Sucesso","Monitoramento de Pulso Ativo!");
    } catch(e) { showModal("Falha","Falha ao ativar Pulso."); }
}

async function setupTemperature(server) {
    try {
        const service = await server.getPrimaryService(BLE_CONFIG.TEMP);
        const char = await service.getCharacteristic(0x2A1C);
        await char.startNotifications();
        char.addEventListener('characteristicvaluechanged', (ev) => {
            const temp = decodeIEEE11073FLOAT(ev.target.value, 1);
            processVitals('temp', temp);
        });
        showModal("Sucesso","Monitoramento de Temperatura Ativo!");
    } catch(e) { showModal("Falha","Falha ao ativar Temperatura."); }
}

async function setupOximetry(server) {
    try {
        const service = await server.getPrimaryService(BLE_CONFIG.SPO2);
        let char;
        try { char = await service.getCharacteristic(0x2A5F); } 
        catch(e) { char = await service.getCharacteristic(0x2A5E); }
        await char.startNotifications();
        char.addEventListener('characteristicvaluechanged', (ev) => {
            processVitals('spo2', ev.target.value.getUint8(1));
        });
        showModal("Sucesso","Monitoramento de Oximetria Ativo!");
    } catch(e) { showModal("Falha","Falha ao ativar Oximetria."); }
}

async function setupBloodPressure(server) {
    try {
        const service = await server.getPrimaryService(BLE_CONFIG.BP);
        const char = await service.getCharacteristic(0x2A35);
        await char.startNotifications();
        char.addEventListener('characteristicvaluechanged', (ev) => {
            const v = ev.target.value;
            const sys = decodeSFLOAT(v.getUint16(1, true));
            const dia = decodeSFLOAT(v.getUint16(3, true));
            const display = document.getElementById('val-bp');
            if (display) display.innerText = `${Math.round(sys)}/${Math.round(dia)}`;
            processVitals('bp_sys', sys); // Alarme baseado na sist√≥lica
        });
        showModal("Sucesso","Monitor de Press√£o Arterial Vinculado!");
    } catch(e) { showModal("Falha","Falha ao ativar Press√£o Arterial."); }
}

// 6. Fluxo de Interface
async function abrirGuiaSincronizacao() {

    //fazer um teste se tem plano Premium
    checkPremiumFeature();

    const modal = document.getElementById('bleModal');
    if (!modal) return;

    /* =====================================================
     * DIAGN√ìSTICO DE AMBIENTE (ANDROID / WEBVIEW)
     * ===================================================== */
    // Se recarregou e AINDA est√° undefined, a√≠ sim mostra o erro
    if (typeof navigator.bluetooth === 'undefined') {
        // Pega as tradu√ß√µes do idioma atual
        const t = LANG_STRINGS[currentLang]; 

        // Monta a mensagem base
        let erroMsg = t['bleErrorTitle'];

        if (!window.isSecureContext) {
            erroMsg += `<br>${t['bleErrorHttps']}`;
        } else {
            erroMsg += `<br>${t['bleErrorCausesTitle']}<br>`
                    + `${t['bleErrorCause1']}<br>`
                    + `${t['bleErrorCause2']}<br>`
                    + `${t['bleErrorCause3']}`;
        }

        // Injeta o HTML mantendo as classes de estilo
        document.getElementById('bleStatus').innerHTML = `
            <div class="text-red-500 p-2 text-xs border border-red-200 bg-red-50 rounded">
                ${erroMsg}
            </div>
        `;
        
        // Mostra o modal se a vari√°vel 'modal' estiver definida no escopo, 
        // ou use document.getElementById('bleModal') para garantir.
        const modalElement = document.getElementById('bleModal');
        if (modalElement) {
            modalElement.classList.remove('hidden');
        }
        
        return;
    }

    /* =====================================================
     * ABERTURA DO MODAL
     * ===================================================== */
    modal.classList.remove('hidden');
    document.getElementById('bleStatus').innerHTML = `
        <div class="p-3 bg-blue-50 text-blue-700 rounded-lg text-center animate-pulse text-xs">
            Aguardando Bluetooth...
        </div>
    `;

    try {
        /* =====================================================
         * SOLICITA√á√ÉO DO DISPOSITIVO BLE
         * (WebView exige filtros expl√≠citos)
         * ===================================================== */
        const device = await navigator.bluetooth.requestDevice({
            filters: [
                { services: [BLE_CONFIG.HR] },
                { services: [BLE_CONFIG.TEMP] },
                { services: [BLE_CONFIG.SPO2] },
                { services: [BLE_CONFIG.BP] },
                { services: [BLE_CONFIG.XIAOMI] },
                { services: [BLE_CONFIG.BATT] },
                { namePrefix: 'Mi' },
                { namePrefix: 'Amazfit' },
                { namePrefix: 'Polar' },
                { namePrefix: 'Galaxy' },
                { namePrefix: 'Smart' }
            ],
            optionalServices: [
                BLE_CONFIG.HR,
                BLE_CONFIG.TEMP,
                BLE_CONFIG.SPO2,
                BLE_CONFIG.BP,
                BLE_CONFIG.XIAOMI,
                BLE_CONFIG.BATT // üî¥ OBRIGAT√ìRIO PARA BATERIA
            ]
        });

        /* =====================================================
         * CONEX√ÉO GATT
         * ===================================================== */
        const server = await device.gatt.connect();
        state.activeServers[device.id] = server;

        /* =====================================================
         * MONITORAMENTO DE BATERIA + CONEX√ÉO
         * ===================================================== */
        monitorarWearable(device, [
            'slot-batt-hr',
            'slot-batt-temp',
            'slot-batt-spo2',
            'slot-batt-bp'
        ]);

        /* =====================================================
         * INTERFACE DE DELEGA√á√ÉO DE SENSORES
         * ===================================================== */
        await exibirInterfaceDelegacao(device, server);

    } catch (error) {
        console.error("Erro BLE:", error);

        let msg = "Busca cancelada.";
        if (error.name === 'NotFoundError') {
            msg = "Nenhum dispositivo encontrado ou permiss√£o negada. (Verifique o GPS)";
        } else if (error.name === 'SecurityError') {
            msg = "Erro de Seguran√ßa (Use HTTPS).";
        } else if (error.name === 'NotSupportedError') {
            msg = "Bluetooth n√£o suportado neste contexto.";
        }

        document.getElementById('bleStatus').innerHTML = `
            <div class="text-red-500 p-2 text-xs">
                ${msg}<br>
                <span class="text-[9px] text-gray-500">${error.message}</span>
            </div>
        `;
    }
}

async function exibirInterfaceDelegacao(device, server) {
    const statusDiv = document.getElementById('bleStatus');
    
    // 1. Verificamos quais servi√ßos REALMENTE existem no aparelho
    const servicosDisponiveis = await server.getPrimaryServices();
    const uuids = servicosDisponiveis.map(s => s.uuid.toLowerCase());

    // 2. Filtramos quais bot√µes mostrar
    const temHR = uuids.includes('0000180d-0000-1000-8000-00805f9b34fb');
    const temTemp = uuids.includes('00001809-0000-1000-8000-00805f9b34fb');
    const temSPO2 = uuids.includes('00001822-0000-1000-8000-00805f9b34fb');
    const temBP = uuids.includes('00001810-0000-1000-8000-00805f9b34fb');

    statusDiv.innerHTML = `
        <div class="mt-4 p-4 border border-blue-200 rounded-xl bg-blue-50 shadow-sm">
            <p class="font-bold text-blue-900 text-sm mb-1">üì° ${device.name}</p>
            <p class="text-[9px] text-blue-600 mb-3 uppercase text-center">Recursos detectados:</p>
            
            <div class="grid grid-cols-2 gap-2 mb-4">
                ${temHR ? `<button onclick="atribuirSensor('${device.id}', 'hr')" class="bg-white border p-2 rounded-lg text-[10px] font-bold shadow-sm">‚ù§Ô∏è PULSO</button>` : ''}
                ${temTemp ? `<button onclick="atribuirSensor('${device.id}', 'temp')" class="bg-white border p-2 rounded-lg text-[10px] font-bold shadow-sm">üå°Ô∏è TEMP</button>` : ''}
                ${temSPO2 ? `<button onclick="atribuirSensor('${device.id}', 'spo2')" class="bg-white border p-2 rounded-lg text-[10px] font-bold shadow-sm">ü©∏ OXI</button>` : ''}
                ${temBP ? `<button onclick="atribuirSensor('${device.id}', 'bp')" class="bg-white border p-2 rounded-lg text-[10px] font-bold shadow-sm">üí™ P.A.</button>` : ''}
            </div>
            
            <button onclick="finalizarSincronizacao('${device.id}')" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold text-xs uppercase">
                Concluir Configura√ß√£o
            </button>
        </div>
    `;
}

async function atribuirSensor(deviceId, tipo) {
    const server = state.activeServers[deviceId];
    if (!server) return alert("Desconectado.");
    if (tipo === 'hr') await setupHeartRate(server);
    else if (tipo === 'temp') await setupTemperature(server);
    else if (tipo === 'spo2') await setupOximetry(server);
    else if (tipo === 'bp') await setupBloodPressure(server);
}

function finalizarSincronizacao(deviceId) {
    document.getElementById('bleModal').classList.add('hidden');
    const monitor = document.getElementById('monitorSVAlarm');
    if (monitor) monitor.classList.remove('hidden');
}

/**
 * Monitora bateria e conex√£o de dispositivos wearable Bluetooth
 * @param {BluetoothDevice} device - Dispositivo Bluetooth conectado
 * @param {string} slotId - ID do container onde os indicadores devem aparecer (ex: 'slot-batt-hr')
 * @returns {Object} Objeto com m√©todos de controle do monitoramento
 */
/*
async function monitorarWearable(device, slotIds) {
    
    // Estado interno do monitoramento
    const estado = {
        conectado: device.gatt?.connected || false,
        nivelBateria: null,
        characteristic: null,
        listeners: []
    };

    // Renderiza o estado atual (bateria + conex√£o)
    const renderizarEstado = () => {
        const slotEl = document.getElementById(slotIds);
        if (!slotEl) return;

        // Se desconectado
        if (!estado.conectado) {
            slotEl.innerHTML = `
                <div class="flex items-center gap-1" title="Dispositivo desconectado">
                    <svg class="w-4 h-4 text-red-500 animate-pulse" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/>
                        <line x1="2" y1="2" x2="18" y2="18" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    <span class="text-xs text-red-500 font-semibold">OFF</span>
                </div>
            `;
            return;
        }

        // Se conectado, mas sem leitura de bateria ainda
        if (estado.nivelBateria === null) {
            slotEl.innerHTML = `
                <div class="flex items-center gap-1" title="Lendo bateria...">
                    <div class="w-4 h-4 border-2 border-slate-400 border-t-transparent rounded-full animate-spin"></div>
                    <span class="text-xs text-slate-400">...</span>
                </div>
            `;
            return;
        }

        // Conectado com n√≠vel de bateria conhecido
        const nivel = estado.nivelBateria;
        let corBarra = 'bg-green-500';
        let corTexto = 'text-green-500';
        let animacao = '';

        if (nivel <= 20) {
            corBarra = 'bg-red-500';
            corTexto = 'text-red-500';
            animacao = 'animate-pulse';
        } else if (nivel <= 50) {
            corBarra = 'bg-yellow-500';
            corTexto = 'text-yellow-500';
        }

        slotEl.innerHTML = `
            <div class="flex items-center gap-1 group cursor-help" title="Bateria: ${nivel}% | Dispositivo conectado">
                <!-- √çcone da bateria -->
                <div class="relative w-6 h-3 border border-slate-500 rounded-[2px] bg-slate-800/50 flex items-center px-[2px] ${animacao}">
                    <div class="h-1.5 rounded-[1px] ${corBarra} transition-all duration-500" style="width: ${nivel}%"></div>
                    <div class="absolute -right-[3px] top-1/2 transform -translate-y-1/2 w-[2px] h-1.5 bg-slate-500 rounded-r-[1px]"></div>
                </div>
                
                <!-- Texto do n√≠vel -->
                <span class="text-[10px] ${corTexto} font-semibold tabular-nums">${nivel}%</span>
                
                <!-- Indicador de conex√£o -->
                <svg class="w-3 h-3 text-green-500 opacity-60" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
                </svg>
            </div>
        `;
    };

    // Handler de desconex√£o
    const onDisconnect = () => {
        estado.conectado = false;
        estado.nivelBateria = null;
        renderizarEstado();
        
        // Vibra√ß√£o de alerta
        if (navigator.vibrate) {
            navigator.vibrate([200, 100, 200]);
        }
        
        // Alerta visual no topo do monitorSVAlarm
        exibirAlertaDesconexao(device.name || 'Sensor');
    };

    // Exibe alerta de desconex√£o no topo
    function exibirAlertaDesconexao(nome) {
        const monitorDiv = document.getElementById('monitorSVAlarm');
        if (!monitorDiv) return;
        
        const idAlerta = `alert-disc-${slotId}`;
        
        // Remove alerta anterior se existir
        const alertaExistente = document.getElementById(idAlerta);
        if (alertaExistente) alertaExistente.remove();
        
        monitorDiv.insertAdjacentHTML('afterbegin', `
            <div id="${idAlerta}" class="w-full bg-red-500 text-white text-xs p-2 text-center rounded mb-2 cursor-pointer flex items-center justify-between shadow-lg animate-pulse" onclick="this.remove()">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
                <span class="flex-1">Conex√£o perdida: ${nome}</span>
                <span class="text-[10px] opacity-75">Toque para fechar</span>
            </div>
        `);
        
        // Auto-remove ap√≥s 10 segundos
        setTimeout(() => {
            const el = document.getElementById(idAlerta);
            if (el) el.remove();
        }, 10000);
    }

    // Handler de mudan√ßa no n√≠vel de bateria
    const onBatteryChange = (event) => {
        const nivel = event.target.value.getUint8(0);
        estado.nivelBateria = nivel;
        renderizarEstado();
    };

    // Registra listener de desconex√£o
    device.addEventListener('gattserverdisconnected', onDisconnect);
    estado.listeners.push({ event: 'gattserverdisconnected', handler: onDisconnect });

    // Inicializa monitoramento de bateria
    try {
        const server = device.gatt.connected ? device.gatt : await device.gatt.connect();
        estado.conectado = true;
        renderizarEstado(); // Mostra estado de "carregando"

        const service = await server.getPrimaryService('battery_service');
        const characteristic = await service.getCharacteristic('battery_level');
        estado.characteristic = characteristic;

        // Leitura inicial
        const valorInicial = await characteristic.readValue();
        estado.nivelBateria = valorInicial.getUint8(0);
        renderizarEstado();

        // Ativa notifica√ß√µes
        await characteristic.startNotifications();
        characteristic.addEventListener('characteristicvaluechanged', onBatteryChange);
        estado.listeners.push({ 
            event: 'characteristicvaluechanged', 
            handler: onBatteryChange,
            target: characteristic 
        });

        console.log(`‚úì Monitoramento iniciado: ${device.name} (${estado.nivelBateria}%)`);

    } catch (erro) {
        console.warn(`‚ö† Erro ao monitorar bateria de ${device.name}:`, erro);
        
        // Se conectado mas falhou bateria, mostra "?"
        if (estado.conectado) {
            const slotEl = document.getElementById(slotId);
            if (slotEl) {
                slotEl.innerHTML = `
                    <div class="flex items-center gap-1" title="N√£o foi poss√≠vel ler bateria">
                        <span class="text-xs text-slate-500">?</span>
                        <svg class="w-3 h-3 text-green-500 opacity-60" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
                        </svg>
                    </div>
                `;
            }
        }
    }

    // Retorna objeto de controle
    return {
        // Para cleanup/desmontar
        destruir: () => {
            estado.listeners.forEach(({ event, handler, target }) => {
                const alvo = target || device;
                alvo.removeEventListener(event, handler);
            });
            estado.listeners = [];
            console.log(`‚úì Monitoramento destru√≠do: ${device.name}`);
        },
        
        // Getters para acesso ao estado
        estaConectado: () => estado.conectado,
        getNivelBateria: () => estado.nivelBateria,
        
        // For√ßa atualiza√ß√£o visual
        atualizar: () => renderizarEstado()
    };
}
*/

/**
 * Monitora bateria, conex√£o e gerencia RECONEX√ÉO AUTOM√ÅTICA
 */
async function monitorarWearable(device, slotIds) {
    
    // Estado interno do monitoramento
    const estado = {
        conectado: device.gatt?.connected || false,
        nivelBateria: null,
        characteristic: null,
        listeners: [],
        reconnectAttempts: 0, // Contador de tentativas
        reconnectTimer: null  // Timer para cancelar se necess√°rio
    };

    // --- FUN√á√ÉO AUXILIAR: Renderiza o estado atual (Visual) ---
    const renderizarEstado = () => {
        slotIds.forEach(slotId => {
            const slotEl = document.getElementById(slotId);
            if (!slotEl) return;

            // 1. Desconectado / Tentando Reconectar
            if (!estado.conectado) {
                const textoStatus = estado.reconnectAttempts > 0 
                    ? `Reconectando (${estado.reconnectAttempts})...` 
                    : 'OFF';
                
                const corStatus = estado.reconnectAttempts > 0 
                    ? 'text-yellow-500 animate-pulse' 
                    : 'text-red-500';

                slotEl.innerHTML = `
                    <div class="flex items-center gap-1" title="Status da Conex√£o">
                        <svg class="w-4 h-4 ${corStatus}" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6z"/>
                            ${estado.reconnectAttempts === 0 ? '<line x1="2" y1="2" x2="18" y2="18" stroke="currentColor" stroke-width="2"/>' : ''}
                        </svg>
                        <span class="text-xs ${corStatus} font-semibold">${textoStatus}</span>
                    </div>
                `;
                return;
            }

            // 2. Conectado, Lendo Bateria
            if (estado.nivelBateria === null) {
                slotEl.innerHTML = `
                    <div class="flex items-center gap-1" title="Lendo bateria...">
                        <div class="w-4 h-4 border-2 border-slate-400 border-t-transparent rounded-full animate-spin"></div>
                        <span class="text-xs text-slate-400">...</span>
                    </div>
                `;
                return;
            }

            // 3. Conectado com Bateria OK
            const nivel = estado.nivelBateria;
            let corBarra = 'bg-green-500';
            let corTexto = 'text-green-500';
            let animacao = '';

            if (nivel <= 20) {
                corBarra = 'bg-red-500';
                corTexto = 'text-red-500';
                animacao = 'animate-pulse';
            } else if (nivel <= 50) {
                corBarra = 'bg-yellow-500';
                corTexto = 'text-yellow-500';
            }

            slotEl.innerHTML = `
                <div class="flex items-center gap-1 group cursor-help" title="Bateria: ${nivel}% | Conectado">
                    <div class="relative w-6 h-3 border border-slate-500 rounded-[2px] bg-slate-800/50 flex items-center px-[2px] ${animacao}">
                        <div class="h-1.5 rounded-[1px] ${corBarra} transition-all duration-500" style="width: ${nivel}%"></div>
                        <div class="absolute -right-[3px] top-1/2 transform -translate-y-1/2 w-[2px] h-1.5 bg-slate-500 rounded-r-[1px]"></div>
                    </div>
                    <span class="text-[10px] ${corTexto} font-semibold tabular-nums">${nivel}%</span>
                    <svg class="w-3 h-3 text-green-500 opacity-60" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
                    </svg>
                </div>
            `;
        });
    };

    // --- L√ìGICA DE RECONEX√ÉO ---
    const attemptReconnect = async () => {
        if (estado.reconnectAttempts >= RECONNECT_CONFIG.maxAttempts) {
            console.error("M√°ximo de tentativas de reconex√£o atingido.");
            exibirAlertaDesconexao(device.name, true); // True indica falha final
            return;
        }

        // Exponential Backoff: 2s, 4s, 8s, 16s...
        const delay = RECONNECT_CONFIG.baseDelay * Math.pow(2, estado.reconnectAttempts);
        console.log(`üîÑ Tentativa ${estado.reconnectAttempts + 1} em ${delay}ms...`);
        
        renderizarEstado(); // Atualiza UI para "Reconectando..."

        estado.reconnectTimer = setTimeout(async () => {
            try {
                estado.reconnectAttempts++;
                // Tenta reconectar o GATT
                const server = await device.gatt.connect();
                state.activeServers[device.id] = server; // Atualiza a refer√™ncia global do servidor
                
                console.log("‚úÖ Reconex√£o bem-sucedida!");
                estado.conectado = true;
                estado.reconnectAttempts = 0; // Reset
                
                // Reinicia servi√ßos vitais (Bateria)
                await iniciarServicoBateria();
                
                // Opcional: Tentar reativar sensores automaticamente se soubermos quais eram
                // await restaurarSensoresAnteriores(device.id); 

            } catch (error) {
                console.warn(`Falha na tentativa ${estado.reconnectAttempts}:`, error);
                attemptReconnect(); // Tenta de novo recursivamente
            }
        }, delay);
    };

    // --- HANDLER DE DESCONEX√ÉO ---
    const onDisconnect = () => {
        estado.conectado = false;
        estado.nivelBateria = null;
        renderizarEstado();

        // Se foi intencional (usu√°rio clicou em sair), n√£o reconecta
        if (RECONNECT_CONFIG.isIntentional) {
            RECONNECT_CONFIG.isIntentional = false; // Reset
            return;
        }

        // Vibra√ß√£o de alerta
        if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        
        // Exibe alerta visual tempor√°rio
        exibirAlertaDesconexao(device.name || 'Sensor');

        // Inicia protocolo de reconex√£o
        attemptReconnect();
    };

    // --- INICIALIZADOR DO SERVI√áO DE BATERIA ---
    const iniciarServicoBateria = async () => {
        try {
            const server = device.gatt.connected ? device.gatt : await device.gatt.connect();
            
            // Atualiza estado
            estado.conectado = true;
            renderizarEstado();

            const service = await server.getPrimaryService(BLE_CONFIG.BATT); // Usa a constante
            const characteristic = await service.getCharacteristic('battery_level');
            estado.characteristic = characteristic;

            // Leitura inicial
            const valorInicial = await characteristic.readValue();
            estado.nivelBateria = valorInicial.getUint8(0);
            renderizarEstado();

            // Notifica√ß√µes
            await characteristic.startNotifications();
            characteristic.addEventListener('characteristicvaluechanged', onBatteryChange);
            
            // Salva listener espec√≠fico para remo√ß√£o futura
            const listenerRef = { 
                event: 'characteristicvaluechanged', 
                handler: onBatteryChange, 
                target: characteristic 
            };
            // Evita duplicar listeners no array ao reconectar
            if (!estado.listeners.some(l => l.target === characteristic)) {
                estado.listeners.push(listenerRef);
            }

            console.log(`‚úì Bateria monitorada: ${estado.nivelBateria}%`);

        } catch (erro) {
            console.warn(`‚ö† Erro bateria (${device.name}):`, erro);
            // Se falhar bateria, mas estiver conectado, mantemos conectado visualmente
            if (device.gatt.connected) {
                estado.conectado = true;
                renderizarEstado();
            }
        }
    };

    // Handler de mudan√ßa no n√≠vel de bateria
    const onBatteryChange = (event) => {
        const nivel = event.target.value.getUint8(0);
        estado.nivelBateria = nivel;
        renderizarEstado();
    };

    // --- ALERTA VISUAL (TOAST) ---
    function exibirAlertaDesconexao(nome, falhaFinal = false) {
        const monitorDiv = document.getElementById('monitorSVAlarm');
        if (!monitorDiv) return;
        
        const idAlerta = `alert-disc-${slotIds[0]}`; // Usa o primeiro slot como ID
        const alertaExistente = document.getElementById(idAlerta);
        if (alertaExistente) alertaExistente.remove();
        
        const corBg = falhaFinal ? 'bg-gray-800' : 'bg-red-500';
        const msg = falhaFinal ? 'Falha definitiva na conex√£o.' : `Conex√£o perdida: ${nome}`;
        const subMsg = falhaFinal ? 'Tente parear novamente.' : 'Tentando reconectar...';

        monitorDiv.insertAdjacentHTML('afterbegin', `
            <div id="${idAlerta}" class="w-full ${corBg} text-white text-xs p-2 text-center rounded mb-2 cursor-pointer flex items-center justify-between shadow-lg animate-pulse" onclick="this.remove()">
                <span class="flex-1 font-bold">${msg} <span class="font-normal opacity-90">(${subMsg})</span></span>
            </div>
        `);
        
        // Remove ap√≥s 5s se n√£o for falha final
        if (!falhaFinal) {
            setTimeout(() => {
                const el = document.getElementById(idAlerta);
                if (el) el.remove();
            }, 5000);
        }
    }

    // --- INICIALIZA√á√ÉO ---
    
    // Registra listener de desconex√£o (apenas uma vez)
    if (!estado.listeners.some(l => l.event === 'gattserverdisconnected')) {
        device.addEventListener('gattserverdisconnected', onDisconnect);
        estado.listeners.push({ event: 'gattserverdisconnected', handler: onDisconnect });
    }

    // Dispara o fluxo inicial
    await iniciarServicoBateria();

    // Retorna objeto de controle
    return {
        destruir: () => {
            // Cancela tentativas de reconex√£o pendentes
            if (estado.reconnectTimer) clearTimeout(estado.reconnectTimer);
            
            // Remove todos os listeners
            estado.listeners.forEach(({ event, handler, target }) => {
                const alvo = target || device;
                try { alvo.removeEventListener(event, handler); } catch(e){}
            });
            estado.listeners = [];
            console.log(`‚úì Monitoramento encerrado: ${device.name}`);
        },
        estaConectado: () => estado.conectado,
        getNivelBateria: () => estado.nivelBateria,
        atualizar: () => renderizarEstado()
    };
}

const renderizarEstado = () => {
    slotIds.forEach(slotId => {
        const slotEl = document.getElementById(slotId);
        if (!slotEl) return;

        /* =============================
         * DISPOSITIVO DESCONECTADO
         * ============================= */
        if (!estado.conectado) {
            slotEl.innerHTML = `
                <div class="flex items-center gap-1" title="Dispositivo desconectado">
                    <svg class="w-4 h-4 text-red-500 animate-pulse" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6z"/>
                        <line x1="2" y1="2" x2="18" y2="18" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    <span class="text-xs text-red-500 font-semibold">OFF</span>
                </div>
            `;
            return;
        }

        /* =============================
         * CONECTADO, BATERIA INDEFINIDA
         * ============================= */
        if (estado.nivelBateria === null) {
            slotEl.innerHTML = `
                <div class="flex items-center gap-1" title="Lendo bateria...">
                    <div class="w-4 h-4 border-2 border-slate-400 border-t-transparent rounded-full animate-spin"></div>
                    <span class="text-xs text-slate-400">...</span>
                </div>
            `;
            return;
        }

        /* =============================
         * CONECTADO COM BATERIA
         * ============================= */
        const nivel = estado.nivelBateria;
        let corBarra = 'bg-green-500';
        let corTexto = 'text-green-500';
        let animacao = '';

        if (nivel <= 20) {
            corBarra = 'bg-red-500';
            corTexto = 'text-red-500';
            animacao = 'animate-pulse';
        } else if (nivel <= 50) {
            corBarra = 'bg-yellow-500';
            corTexto = 'text-yellow-500';
        }

        slotEl.innerHTML = `
            <div class="flex items-center gap-1 group cursor-help" title="Bateria: ${nivel}% | Conectado">
                <div class="relative w-6 h-3 border border-slate-500 rounded-[2px] bg-slate-800/50 flex items-center px-[2px] ${animacao}">
                    <div class="h-1.5 rounded-[1px] ${corBarra}" style="width:${nivel}%"></div>
                    <div class="absolute -right-[3px] top-1/2 -translate-y-1/2 w-[2px] h-1.5 bg-slate-500"></div>
                </div>
                <span class="text-[10px] ${corTexto} font-semibold tabular-nums">${nivel}%</span>
                <svg class="w-3 h-3 text-green-500 opacity-60" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
                </svg>
            </div>
        `;
    });
};


// Exemplo de uso:
// const monitor = await monitorarWearable(deviceHR, 'slot-batt-hr');
// ... quando n√£o precisar mais:
// monitor.destruir();



/**
 * Define o tema do aplicativo (Claro/Escuro/Auto - requer Tailwind CSS)
 */

/**
 * SISTEMA DE TEMA INTELIGENTE
 * Substitui a fun√ß√£o setAppTheme antiga.
 */

const THEME_CONFIG = {
    horaInicioNoite: 18,    // 18:00
    horaFimNoite: 6,        // 06:00
    luxEscuro: 15,          // Limite de luz (Lux) para considerar escuro
    storageKey: 'appTheme'  // Mesma chave do seu c√≥digo original
};

let ambientLightSensor = null;
let themeInterval = null;

// Vari√°vel global para guardar o lux recebido do Android
window.luxAndroid = null;

// Esta fun√ß√£o √© chamada automaticamente pelo Kotlin
window.atualizarLuzAndroid = function(lux) {
    // console.log("Luz recebida do Android:", lux);
    window.luxAndroid = lux;
    
    // Chama sua l√≥gica de aplicar tema imediatamente
    verificarIluminacaoHibrida();
}

// Sua nova fun√ß√£o unificada
function verificarIluminacaoHibrida() {
    let luxAtual = 0;

    // Prioridade 1: Valor vindo do App Android (Hardware Nativo)
    if (window.luxAndroid !== null) {
        luxAtual = window.luxAndroid;
    } 
    // Prioridade 2: API Web (AmbientLightSensor) - Fallback
    else if (window.ambientLightSensor && window.ambientLightSensor.activated) {
        luxAtual = window.ambientLightSensor.illuminance;
    }
    // Prioridade 3: Sem sensor? Use hor√°rio.
    else {
        verificarHorario(); // Sua fun√ß√£o antiga de hor√°rio
        return;
    }

    // Sua l√≥gica original de limiares
    if (luxAtual < THEME_CONFIG.luxEscuro) {
        aplicarVisual(true); // Escuro
    } else if (luxAtual > (THEME_CONFIG.luxEscuro + 20)) {
        aplicarVisual(false); // Claro
    }
}

// --- Fun√ß√£o Principal (Substitui a antiga) ---
function setAppTheme(theme) {
    console.log("Alterando tema para:", theme);
    localStorage.setItem(THEME_CONFIG.storageKey, theme);
    aplicarLogicaDoTema(theme);
}

// --- Impedir que a tela apague

let wakeLock = null;

// Fun√ß√£o para solicitar o bloqueio de tela
async function adquirirWakeLock() {
    try {
        // Verifica se o navegador suporta a API
        if ('wakeLock' in navigator) {
            wakeLock = await navigator.wakeLock.request('screen');
            console.log("A tela permanecer√° ligada.");

            // Ouve se o bloqueio for liberado (ex: quando o app √© minimizado)
            wakeLock.addEventListener('release', () => {
                console.log("O bloqueio de tela foi liberado.");
            });
        }
    } catch (err) {
        console.error(`${err.name}, ${err.message}`);
    }
}

// --- N√∫cleo de Decis√£o ---
function aplicarLogicaDoTema(theme) {
    // 1. Limpa processos anteriores (para n√£o conflitar)
    if (themeInterval) { clearInterval(themeInterval); themeInterval = null; }
    if (ambientLightSensor) { try { ambientLightSensor.stop(); } catch(e){} }

    // 2. Decide o visual
    if (theme === 'light') {
        aplicarVisual(false); // For√ßa Claro
    } 
    else if (theme === 'dark') {
        aplicarVisual(true);  // For√ßa Escuro
    } 
    else {
        // MODO AUTOM√ÅTICO (Sensor + Hor√°rio)
        iniciarModoAutomatico();
    }
}

// --- Aplica√ß√£o Visual (Compat√≠vel com seu CSS antigo) ---
function aplicarVisual(isDark) {
    const html = document.documentElement;
    
    // Remove as duas classes para garantir limpeza total
    html.classList.remove('light', 'dark');

    if (isDark) {
        html.classList.add('dark'); // Adiciona classe dark
    } else {
        html.classList.add('light'); // Adiciona classe light
    }
}

// --- Intelig√™ncia do Modo Auto ---
function iniciarModoAutomatico() {
    // 1. Verifica√ß√£o imediata pelo rel√≥gio
    verificarHorario();

    // 2. Tenta usar o Sensor de Luz (se dispon√≠vel)
    if ('AmbientLightSensor' in window) {
        try {
            if (!ambientLightSensor) ambientLightSensor = new AmbientLightSensor();
            
            ambientLightSensor.onreading = () => {
                const lux = ambientLightSensor.illuminance;
                // Histerese para evitar piscar: < 15 escurece, > 35 clareia
                if (lux < THEME_CONFIG.luxEscuro) {
                    aplicarVisual(true); 
                } else if (lux > (THEME_CONFIG.luxEscuro + 20)) {
                    aplicarVisual(false);
                }
            };
            ambientLightSensor.start();
        } catch (e) {
            console.log("Sensor de luz indispon√≠vel, usando apenas hor√°rio.");
        }
    }

    // 3. Re-checa o hor√°rio a cada 1 minuto (para mudar sozinho se anoitecer)
    themeInterval = setInterval(verificarHorario, 60000);
}

// --- Verifica√ß√£o por Hor√°rio (Fallback) ---
function verificarHorario() {
    // Se o sensor estiver ativo, ele manda. Ignoramos o rel√≥gio.
    if (ambientLightSensor && ambientLightSensor.activated) return;

    const agora = new Date();
    const horas = agora.getHours();
    
    // √â noite se for >= 18h OU < 06h
    const ehNoite = horas >= THEME_CONFIG.horaInicioNoite || horas < THEME_CONFIG.horaFimNoite;
    
    aplicarVisual(ehNoite);

    adquirirWakeLock(); //impede a tela de fechar
}

// --- Inicializa√ß√£o ao abrir o app ---
document.addEventListener('DOMContentLoaded', () => {
    const savedTheme = localStorage.getItem(THEME_CONFIG.storageKey) || 'auto';
    
    // Atualiza o <select> visualmente
    const selectElement = document.getElementById('theme-select');
    if (selectElement) {
        selectElement.value = savedTheme;
    }

    aplicarLogicaDoTema(savedTheme);

});

document.addEventListener('visibilitychange', async () => {
    if (wakeLock !== null && document.visibilityState === 'visible') {
        await adquirirWakeLock();
    }
});

/**
 * SISTEMA DE ALARMES INTEGRADO - VENCER CUIDANDO (V3 FINAL)
 * Inclui: Sele√ß√£o de sons, Trava de repeti√ß√£o (Cooldown), WakeLock e Limpeza de Notifica√ß√µes.
 */

const AlarmSystem = {
    checkInterval: null,
    audioContext: null,
    wakeLock: null,
    activeNotification: null,
    silenceUntil: 0,
    
    // REMOVIDO: sounds: { ... } 
    // Motivo: Vamos usar a const ALARM_SOUNDS global para evitar duplicidade

   init: async function() {
    // 1. Evita reinicializar se j√° estiver rodando
    if (this.initialized) return;

    console.log("Sistema de Alarmes V3 Iniciado...");

    // ATIVA√á√ÉO DO RELAT√ìRIO AO CLICAR NO REL√ìGIO
    const timeSpan = document.getElementById('currentTime');
    if (timeSpan) {
        timeSpan.style.cursor = 'pointer';
        timeSpan.title = "Toque para ver Relat√≥rio de Atendimentos";
        timeSpan.onclick = function() {
            ReportSystem.openModal();
        };
    }

    // 2. CORRE√á√ÉO: Busca o elemento de √°udio no HTML
    const silent = document.getElementById('silentKeeper');

    if (silent) {
        // Tenta tocar o sil√™ncio para destravar o √°udio do navegador
        silent.play().then(() => {
            this.initialized = true;
            
            // --- FEEDBACK VISUAL PARA O CUIDADOR ---
            const statusDiv = document.getElementById('status-audio');
            if (statusDiv) {
                statusDiv.innerHTML = "üîä Sound ON";
                statusDiv.style.color = "green";
                statusDiv.style.fontWeight = "bold"; 
                statusDiv.style.padding = "5px";
                statusDiv.style.border = "1px solid green";
                
                // Esconde ap√≥s 5 segundos
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
            
        }).catch((err) => {
            console.warn("Autoplay bloqueado. Aguardando intera√ß√£o...", err);
            // Se falhar, garante que tentar√° de novo no pr√≥ximo clique
            document.body.addEventListener('click', () => this.init(), { once: true });
            return; // Sai da fun√ß√£o para n√£o iniciar o timer sem √°udio
        });
    }

    // 3. Configura√ß√µes de Hardware/Sistema
    this.requestWakeLock();
    // this.startSentinel(); // Opcional: j√° tocamos o silent acima, mas pode manter se a sentinel tiver l√≥gica de volume

    // 4. Inicia o Loop de Verifica√ß√£o (Timer)
    if (this.checkInterval) clearInterval(this.checkInterval);
    this.checkInterval = setInterval(() => this.checkAlarms(), 5000);
},

    speakMessage: function(message) {
        if ('speechSynthesis' in window) {
            // Cancela falas anteriores para n√£o encavalar
            window.speechSynthesis.cancel(); 
            
            const utterance = new SpeechSynthesisUtterance(message);
            utterance.lang = currentLang;
            utterance.rate = 1.1; // Um pouco mais r√°pido para urg√™ncia
            utterance.volume = 1.0;
            
            window.speechSynthesis.speak(utterance);
        }
    },

    flashInterval: null,

    startVisualAlert: function() {
        let state = false;
        const originalTitle = document.title;
        
        if (this.flashInterval) clearInterval(this.flashInterval);
        
        this.flashInterval = setInterval(() => {
            document.title = state ? "üîî ALARME TOCANDO!" : "üî¥ ATEN√á√ÉO";
            state = !state;
        }, 1000);
    },

    stopVisualAlert: function() {
        if (this.flashInterval) clearInterval(this.flashInterval);
        document.title = "Vencer Cuidando"; // Volta ao original
    },

    playAlarm: function(soundKeyOverride = null) {          

        // 1. CHECAGEM DE SIL√äNCIO
        //if (Date.now() < this.silenceUntil) return;

        const player = document.getElementById('alarmPlayer');

        
        // 2. RECUPERA√á√ÉO CORRETA DA CHAVE DO SOM
        soundKey = state.alarmSound;
        soundKeyOverride = ALARM_SOUNDS[soundKey];

        // Se o usu√°rio marcou 'none', silencia e retorna
        if (soundKey === 'none') return;

        // 3. BUSCA A URL NA CONSTANTE GLOBAL
        // Usa ALARM_SOUNDS global em vez de this.sounds
        const soundUrl = soundKeyOverride || ALARM_SOUNDS['beep'];

        console.log('playAlarm est√° rodando..', soundUrl );
        
        // 4. Tocar √Åudio (l√≥gica de prote√ß√£o contra rein√≠cio desnecess√°rio)
        if (player.paused || player.ended || player.src !== soundUrl) {
            player.src = soundUrl;
            player.volume = 1.0;
            player.loop = true; 
                        
            if (navigator.vibrate) navigator.vibrate([500, 200, 500, 200, 1000]);
            
            player.play().catch(e => {
                console.warn("Erro no som online, usando emerg√™ncia offline");
                player.src = EMERGENCY_BEEP;
                player.play();
            });
        }

        // 5. Feedback Visual
        if (!this.activeNotification) {

            this.startVisualAlert();
            
            // 1. Obt√©m o dicion√°rio (caso ainda n√£o tenha sido declarado na fun√ß√£o)
            const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
                    ? LANG_STRINGS[currentLang] 
                    : LANG_STRINGS['pt'];

            // 2. Busca a tradu√ß√£o
            const msgSpeak = t['msgSpeakComeAcura'] || "Venha! Voc√™ tem Acura.";
            const msgSpeak2 = t['msgWeNeedYou'] || "Precisamos de voc√™.";

            // 3. Executa a fala
            this.speakMessage(msgSpeak);
            this.showNotification(msgSpeak2 , msgSpeak);
        }        
        
        const btnPanico = document.getElementById('btn-silenciar-geral');
        if (btnPanico) btnPanico.style.display = 'block';
    },

    stopAlarm: function() {

        console.log('parar alarme');

        this.stopVisualAlert();

        // 1. Parar √Åudio
        const player = document.getElementById('alarmPlayer');
        player.pause();
        player.currentTime = 0;
        if (navigator.vibrate) navigator.vibrate(0);

        // 2. ATIVAR TRAVA DE REPETI√á√ÉO (CR√çTICO)
        // Impede que o alarme toque de novo pelos pr√≥ximos 65 segundos.
        // Isso d√° tempo para o rel√≥gio mudar de minuto (ex: sair de 14:00 para 14:01)
        this.silenceUntil = Date.now() + 65000; 

        // 3. LIMPEZA VISUAL
        // Fecha a notifica√ß√£o do Android/PC
        if (this.activeNotification) {
            this.activeNotification.close();
            this.activeNotification = null;
        }

        // Esconde o bot√£o de p√¢nico
        const btnPanico = document.getElementById('btn-silenciar-geral');
        if (btnPanico) btnPanico.style.display = 'none';
    },

    // --- Fun√ß√µes Auxiliares ---
    requestWakeLock: async function() {
        try {
            if ('wakeLock' in navigator) {
                this.wakeLock = await navigator.wakeLock.request('screen');
            }
        } catch (err) { console.log('WakeLock erro:', err); }
    },

    startSentinel: function() {
        const silent = document.getElementById('silentKeeper');
        if(silent) {
            silent.volume = 0.01;
            const playPromise = silent.play();
            if (playPromise !== undefined) {
                playPromise.catch(() => {
                    window.addEventListener('click', () => silent.play(), { once: true });
                });
            }
        }
    },

    showNotification: function(title, body) {
        if ("Notification" in window && Notification.permission === "granted") {
            // Fecha anterior se existir
            if (this.activeNotification) this.activeNotification.close();

            this.activeNotification = new Notification(title, { 
                body: body, 
                icon: 'imagens/favicon-32x32.png',
                tag: 'medication-alarm' // Agrupa notifica√ß√µes no Android
            });
            
            // Focar na janela ao clicar
            this.activeNotification.onclick = () => {
                window.focus();
                this.activeNotification.close();
            };
        }
    },

    checkAlarms: function() {
        // L√≥gica de backup...
        // O app usa principalmente os timers das infus√µes/rem√©dios, 
        // mas √© bom manter isso aqui caso adicione alarmes gerais.
    }
};



// Inicializar
document.addEventListener('DOMContentLoaded', () => {
    if ("Notification" in window) Notification.requestPermission();
    document.body.addEventListener('click', () => AlarmSystem.init(), { once: true });
});

/**
 * GERENCIAMENTO DE EQUIPE PRESENTE (TURNO)
 */
/**
 * GERENCIAMENTO DE EQUIPE PRESENTE (TURNO)
 * Vers√£o compat√≠vel com endpoint existente 'search-professional'
 */
const ProfessionalPresence = {
    activeList: [], 
    inactiveList: [], // Nova lista para profissionais em descanso
    userLocation: null, 

    init: function() {
        // 1. Carrega os dados salvos (Ativos)
        const savedActive = localStorage.getItem('activeProfessionals');
        if (savedActive) {
            try { this.activeList = JSON.parse(savedActive); } 
            catch (e) { console.error("Erro ler ativos:", e); this.activeList = []; }
        }

        // 2. Carrega os dados salvos (Inativos/Descanso)
        const savedInactive = localStorage.getItem('inactiveProfessionals');
        if (savedInactive) {
            try { this.inactiveList = JSON.parse(savedInactive); } 
            catch (e) { console.error("Erro ler inativos:", e); this.inactiveList = []; }
        }
        
        // 3. Busca localiza√ß√£o
        this.updateLocation();

        // 4. Atualiza a tela ap√≥s delay para garantir DOM
        setTimeout(() => {
            this._refreshUI();
            this.renderLists(); // Renderiza ambas as listas
        }, 500);
    },

    updateLocation: function() {
        if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition((position) => {
                this.userLocation = {
                    lat: position.coords.latitude,
                    lon: position.coords.longitude
                };
            }, (err) => console.log("Loc erro:", err));
        }
    },

    openModal: function() {
        const modal = document.getElementById('profissional_presente_agora');
        if (modal) {
            modal.style.display = 'flex';
            // Adiciona classe para anima√ß√£o se houver
            modal.classList.remove('hidden');
        }
        
        this.renderLists();
        this.updateLocation();
        
        // Limpa buscas residuais se existirem
        const input = document.getElementById('input-busca-prof');
        if(input) {
            input.value = '';
            input.focus();
        }
        const results = document.getElementById('resultados-busca-prof');
        if(results) results.style.display = 'none';
    },

    closeModal: function() {
        const modal = document.getElementById('profissional_presente_agora');
        if(modal) {
            modal.style.display = 'none';
            modal.classList.add('hidden');
        }
    },

    // --- FUN√á√ÉO DE TOGGLE (A M√°gica acontece aqui) ---
    toggleStatus: function(profId, currentStatus) {
        if (currentStatus === 'active') {
            // Mover de Ativo -> Inativo
            const index = this.activeList.findIndex(p => p.id === profId);
            if (index > -1) {
                const prof = this.activeList[index];
                this.activeList.splice(index, 1); // Remove de ativos
                this.inactiveList.push(prof);     // Adiciona em inativos
            }
        } else {
            // Mover de Inativo -> Ativo
            const index = this.inactiveList.findIndex(p => p.id === profId);
            if (index > -1) {
                const prof = this.inactiveList[index];
                this.inactiveList.splice(index, 1); // Remove de inativos
                this.activeList.push(prof);         // Adiciona em ativos
            }
        }
        
        this.save();
        this.renderLists();
        this._refreshUI();
    },

    addProfessional: function(prof) {
        // Verifica se j√° existe em QUALQUER uma das listas para evitar duplicidade
        const inActive = this.activeList.some(p => p.id === prof.id);
        const inInactive = this.inactiveList.some(p => p.id === prof.id);

        if (!inActive && !inInactive) {
            const profNormalizado = {
                id: prof.id,
                nome: prof.nome,
                especialidade: prof.formacao || prof.especialidade || 'Geral'
            };

            // Por padr√£o, novos entram como ATIVOS
            this.activeList.push(profNormalizado);
            this.save();
            this._refreshUI(); 
            this.renderLists();
            
            // Limpa UI de busca se existir
            const input = document.getElementById('input-busca-prof');
            if(input) input.value = '';
            const results = document.getElementById('resultados-busca-prof');
            if(results) results.style.display = 'none';

        } else {
            showModal("","Este profissional j√° est√° na lista (ativo ou em descanso).");
        }
    },

    // Fun√ß√£o de exclus√£o definitiva (Opcional, caso queira remover das duas listas)
        deleteProfessional: function(profId) {
            // 1. Obt√©m o dicion√°rio
            const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
                    ? LANG_STRINGS[currentLang] 
                    : LANG_STRINGS['pt'];

            // 2. Prepara os textos traduzidos
            const title = t['titleDeleteProf'] || "Excluir Profissional";
            const message = t['msgConfirmDeleteProf'] || "Tem certeza que deseja remover este profissional da lista definitivamente?";
            const btnText = t['btnDelete'] || "Excluir";

            // 3. Chama o modal de confirma√ß√£o
            customConfirm(
                title,      // T√≠tulo traduzido
                message,    // Mensagem traduzida
                btnText,    // Bot√£o traduzido
                "bg-red-600" // Cor (n√£o precisa de tradu√ß√£o)
            ).then((confirmado) => {
                if (confirmado) {
                    this.activeList = this.activeList.filter(p => p.id !== profId);
                    this.inactiveList = this.inactiveList.filter(p => p.id !== profId);
                    this.save();
                    this.renderLists();
                    
                    // Verifica se a fun√ß√£o existe antes de chamar (boa pr√°tica)
                    if (typeof this._refreshUI === 'function') {
                        this._refreshUI();
                    }
                }
            });
        },

    save: function() {
        localStorage.setItem('activeProfessionals', JSON.stringify(this.activeList));
        localStorage.setItem('inactiveProfessionals', JSON.stringify(this.inactiveList));
    },

    // Renderiza AMBAS as listas nas divs correspondentes
    renderLists: function() {
        // 1. Renderiza ATIVOS (Verde)
        const containerActive = document.getElementById('lista-profissionais-ativos');
        if (containerActive) {
            containerActive.innerHTML = '';
            
            if (this.activeList.length === 0) {
                // Recupera a mensagem de vazio do HTML ou usa padr√£o
                containerActive.innerHTML = '<span class="empty-msg" style="color: #666; font-style: italic; font-size: 13px;">Nenhum profissional ativo no momento.</span>';
            } else {
                this.activeList.forEach(prof => {
                    const tag = document.createElement('div');
                    // Estilo Verde para Ativos
                    tag.className = 'prof-tag active animate-fade-in';
                    tag.style.cssText = 'background: white; border: 1px solid #166534; color: #166534; padding: 6px 12px; border-radius: 20px; font-size: 13px; display: flex; align-items: center; gap: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);';
                    
                    tag.innerHTML = `
                        <span style="font-weight:600;">${prof.nome}</span>
                        <button onclick="ProfessionalPresence.toggleStatus(${prof.id}, 'active')" title="Mover para Descanso" style="background:#dcfce7; border:none; color:#166534; cursor:pointer; font-size: 10px; padding: 2px 6px; border-radius: 10px; display:flex; align-items:center; gap:2px;">
                            üí§ Descansar
                        </button>
                    `;
                    containerActive.appendChild(tag);
                });
            }
        }

        // 2. Renderiza INATIVOS/DESCANSO (Cinza)
        const containerInactive = document.getElementById('lista-profissionais-desativos');
        if (containerInactive) {
            containerInactive.innerHTML = '';

            if (this.inactiveList.length === 0) {
                containerInactive.innerHTML = '<span class="empty-msg" style="color: #9ca3af; font-style: italic; font-size: 13px;">Nenhum profissional em descanso.</span>';
            } else {
                this.inactiveList.forEach(prof => {
                    const tag = document.createElement('div');
                    // Estilo Cinza para Inativos
                    tag.className = 'prof-tag inactive animate-fade-in';
                    tag.style.cssText = 'background: white; border: 1px solid #9ca3af; color: #4b5563; padding: 6px 12px; border-radius: 20px; font-size: 13px; display: flex; align-items: center; gap: 8px; opacity: 0.8;';
                    
                    tag.innerHTML = `
                        <span>${prof.nome}</span>
                        <button onclick="ProfessionalPresence.toggleStatus(${prof.id}, 'inactive')" title="Ativar no Turno" style="background:#e5e7eb; border:none; color:#374151; cursor:pointer; font-size: 10px; padding: 2px 6px; border-radius: 10px; display:flex; align-items:center; gap:2px;">
                            ‚úÖ Ativar
                        </button>
                        <button onclick="ProfessionalPresence.deleteProfessional(${prof.id})" title="Remover da lista" style="margin-left:5px; color:#ef4444; background:none; border:none; cursor:pointer;">&times;</button>
                    `;
                    containerInactive.appendChild(tag);
                });
            }
        }
    },

    // Mant√©m compatibilidade com o resto do sistema (s√≥ considera ativos para "Responder")
    getCurrentResponder: function() {
        if (this.activeList && this.activeList.length > 0) {
            if (this.activeList.length === 1) return this.activeList[0].nome;
            return this.activeList.map(p => p.nome).join(" & ");
        }
        return (typeof state !== 'undefined' ? state.nickname : null) || localStorage.getItem('nickname') || "Cuidador";
    },

    // Badge no Header (s√≥ mostra ativos)
    getBadgeHtml: function() {
        if (this.activeList && this.activeList.length > 0) {
            const nomes = this.activeList.map(p => p.nome).join(" & ");
            return `
                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px dashed #e5e7eb; display: flex; align-items: center; font-size: 12px; color: #166534; background-color: #f0fdf4; padding: 4px 8px; border-radius: 4px;">
                    <span style="margin-right: 4px;">üë®‚Äç‚öïÔ∏è</span>                    
                    <strong style="color: #14532d;">${nomes}</strong>
                </div>
            `;
        }
        return ''; 
    },

    _refreshUI: function() {
        if (typeof renderPatientTimeline === 'function') renderPatientTimeline();
        if (typeof renderActiveInfusions === 'function') renderActiveInfusions();
        if (typeof renderSchedule === 'function') renderSchedule(); 
        
        // Atualiza badge se existir fun√ß√£o global de renderizar header
        const headerBadge = document.getElementById('professional-badge-container');
        if (headerBadge) headerBadge.innerHTML = this.getBadgeHtml();
    },

    // --- MANTENDO A BUSCA (Para compatibilidade ou uso futuro) ---
    searchTimer: null,
    search: function(term) {
        const resultsContainer = document.getElementById('resultados-busca-prof');
        if (this.searchTimer) clearTimeout(this.searchTimer);
        
        if (!term || term.length < 2) {
            if(resultsContainer) resultsContainer.style.display = 'none';
            return;
        }

        this.searchTimer = setTimeout(async () => {
            if(resultsContainer) {
                resultsContainer.innerHTML = '<div style="padding:10px; color:#666;">Buscando...</div>';
                resultsContainer.style.display = 'block';
            }

            const params = { term: term };
            if (this.userLocation) {
                params.lat = this.userLocation.lat;
                params.lon = this.userLocation.lon;
            }

            // Assume que apiGet existe no escopo global
            if(typeof apiGet === 'function') {
                const response = await apiGet('search-professional', params);
                
                if(resultsContainer) resultsContainer.innerHTML = '';
                
                let listaProfissionais = [];
                if (response) {
                    if (Array.isArray(response)) listaProfissionais = response;
                    else if (response.data && Array.isArray(response.data)) listaProfissionais = response.data;
                }

                if (listaProfissionais.length > 0) {
                    listaProfissionais.forEach(prof => {
                        const div = document.createElement('div');
                        div.style.cssText = 'padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s;';
                        div.innerHTML = `<div><b>${prof.nome}</b> <div style="font-size:12px; color:#666;">${prof.formacao || 'Profissional'}</div></div>`;
                        div.onclick = () => this.addProfessional(prof);
                        resultsContainer.appendChild(div);
                    });
                } else {
                    if(resultsContainer) resultsContainer.innerHTML = '<div style="padding:10px; color:#999;">Nenhum profissional encontrado.</div>';
                }
            }
        }, 500);
    }
};

// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', () => {
    ProfessionalPresence.init();
});

// Fun√ß√£o para carregar o hist√≥rico de profissionais
// Agora a fun√ß√£o aceita o ID do paciente como par√¢metro
async function carregarHistoricoProfissionais(pacienteId) {
    // Seguran√ßa: se n√£o tiver ID, n√£o faz a busca
    if (!pacienteId) {
        console.warn("Tentativa de carregar hist√≥rico sem paciente_id");
        return;
    }

    try {
        const response = await fetch(`api.php?action=get-historico-profissionais&paciente_id=${pacienteId}`);
        const result = await response.json();

        if (result.success && result.data) {
            const dataList = document.getElementById('lista_profissionais_historico');
            
            // Usamos um Set para garantir que n√£o haja nomes repetidos
            // (ex: se tiver "Ana" e "Ana & Bia", o "Ana" apareceria duas vezes sem o Set)
            const nomesUnicos = new Set();

            // Processa cada registro vindo do banco
            result.data.forEach(registroRaw => {
                if (!registroRaw) return;

                // 1. Quebra a string pelo separador '&'
                const partes = registroRaw.split('&');

                partes.forEach(parte => {
                    // 2. Remove espa√ßos em branco do in√≠cio e fim (trim)
                    const nomeLimpo = parte.trim();

                    // Se sobrou algum texto, adiciona ao conjunto de √∫nicos
                    if (nomeLimpo.length > 0) {
                        nomesUnicos.add(nomeLimpo);
                    }
                });
            });

            // Limpa lista atual do HTML
            dataList.innerHTML = '';

            // Converte o Set de volta para Array, ordena alfabeticamente e cria as op√ß√µes
            Array.from(nomesUnicos).sort().forEach(nome => {
                const option = document.createElement('option');
                option.value = nome;
                dataList.appendChild(option);
            });
            
            console.log(`Hist√≥rico carregado para o paciente ${pacienteId}: ${nomesUnicos.size} nomes √∫nicos processados.`);
        }
    } catch (error) {
        console.error("Erro ao carregar hist√≥rico de profissionais:", error);
    }
}


// Opcional: Se o campo fica num modal que abre via clique, 
// voc√™ pode adicionar a chamada no bot√£o que abre o modal para garantir dados frescos:
// document.getElementById('ProfessionalPresenceId').addEventListener('click', carregarHistoricoProfissionais);

/**
 * SISTEMA DE RELAT√ìRIO DE RESPOSTA E AUDITORIA
 */
const ReportSystem = {
    storageKey: 'vencer_cuidando_reports',
    startTime: null, 

   // --- ATUALIZA√á√ÉO: Timer Persistente ---
    
    startTimer: function() {
        this.startTime = Date.now();
        // Salva no banco local para n√£o perder se der F5
        localStorage.setItem('report_startTime', this.startTime); 
        console.log("‚è±Ô∏è Timer de resposta iniciado: " + new Date(this.startTime).toLocaleTimeString());
    },

    logEvent: function(data) {
        // Tenta pegar da mem√≥ria OU do localStorage (recupera√ß√£o de falha)
        let startTimestamp = this.startTime || localStorage.getItem('report_startTime');
        
        let durationStr = "Imediato";
        
        if (startTimestamp) {
            startTimestamp = parseInt(startTimestamp); // Converte string para n√∫mero
            const diffMs = Date.now() - startTimestamp;
            const seconds = Math.floor(diffMs / 1000);
            
            if (seconds < 60) {
                durationStr = `${seconds}s`;
            } else {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                durationStr = `${mins}m ${secs}s`;
            }

            // Reseta o timer ap√≥s registrar
            this.startTime = null;
            localStorage.removeItem('report_startTime');
        } else {
            // Se chegou aqui como N/A, √© porque o startTimer nunca foi chamado para este evento
            console.warn("‚ö†Ô∏è Aviso: logEvent chamado sem startTimer pr√©vio.");
        }

        const newEntry = {
            id: Date.now(),
            timestamp: new Date().toLocaleString('pt-BR'),
            agility: durationStr, // Agora deve mostrar o tempo correto (ex: 45s)
            reason: data.reason || 'Geral',
            professional: data.professional || 'N√£o Informado',
            caregiver: data.caregiver || 'N√£o Informado',
            locationOk: data.isLocationCorrect ? 'Sim' : 'N√£o',
            notes: data.notes || '-'
        };

        const history = this.getHistory();
        history.unshift(newEntry);
        localStorage.setItem(this.storageKey, JSON.stringify(history));

        // Envio para API (Nuven)
        if (typeof state !== 'undefined' && state.userId) {
            const payload = {
                userId: state.userId,
                patientId: state.patientId || null,
                reason: newEntry.reason,
                professional: newEntry.professional,
                caregiver: newEntry.caregiver,
                agility: durationStr,
                notes: data.notes,
                locationOk: data.isLocationCorrect
            };
            if (typeof apiPost === 'function') {
                apiPost('save-attendance-report', payload).catch(e => console.error(e));
            }
        }
    },

    getHistory: function() {
        const stored = localStorage.getItem(this.storageKey);
        return stored ? JSON.parse(stored) : [];
    },

    // UI: Abre o Modal e Renderiza
    openModal: function() {
        const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
                  ? LANG_STRINGS[currentLang] 
                  : LANG_STRINGS['pt'];

        const modal = document.getElementById('modal-relatorio-resposta');
        const tbody = document.getElementById('lista-relatorio-corpo');
        const history = this.getHistory();

        if(tbody) {
            tbody.innerHTML = '';

            if (history.length === 0) {
                // TRADU√á√ÉO: Mensagem de lista vazia
                const msgNoRecords = t['rsNoRecordsFound'] || 'Nenhum registro encontrado.';
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:20px;">${msgNoRecords}</td></tr>`;
            } else {
                // TRADU√á√ÉO: Label "Resp" (Tempo de Resposta)
                const lblResp = t['rsLabelResp'] || 'Resp';

                history.forEach(log => {
                    // L√≥gica visual: Verde para Sim/Yes, Vermelho para N√£o/No
                    const isPositive = !log.locationOk.toLowerCase().startsWith('n'); // Funciona para N√£o/No
                    const colorLoc = isPositive ? 'green' : 'red';

                    const row = `
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 8px;">${log.timestamp}</td>
                            <td style="padding: 8px;"><b>${log.reason}</b><br><small style="color:blue">${lblResp}: ${log.agility}</small></td>
                            <td style="padding: 8px;">${log.professional}</td>
                            <td style="padding: 8px;">${log.caregiver}</td>
                            <td style="padding: 8px; color: ${colorLoc}; font-weight:bold;">${log.locationOk}</td>
                            <td style="padding: 8px; font-style:italic;">${log.notes}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }
        }

        if(modal) modal.style.display = 'flex';
    },

    closeModal: function() {
        const modal = document.getElementById('modal-relatorio-resposta');
        if(modal) modal.style.display = 'none';
    },

    clearLogs: function() {
        // 1. Obt√©m dicion√°rio
        const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
                  ? LANG_STRINGS[currentLang] 
                  : LANG_STRINGS['pt'];

        // TRADU√á√ÉO: Modal de confirma√ß√£o
        const titulo = t['rsClearHistoryTitle'] || "Limpar Hist√≥rico";
        const mensagem = t['rsConfirmClear'] || "Tem certeza que deseja apagar todo o hist√≥rico de atendimentos?";
        const textoBotao = t['rsBtnClearConfirm'] || "Sim, Apagar";
        const corBotao = "bg-red-600";

        if (typeof customConfirm === 'function') {
            customConfirm(titulo, mensagem, textoBotao, corBotao).then((confirmado) => {
                if (confirmado) {
                    localStorage.removeItem(this.storageKey);
                    this.openModal(); 
                }
            });
        } else {
            // Fallback
            if (confirm(mensagem)) {
                localStorage.removeItem(this.storageKey);
                this.openModal();
            }
        }
    },
    
    checkLocation: function() {
        return true; 
    }
};

/* ==========================================
   L√ìGICA DE COMPARTILHAMENTO (SHARE)
   ========================================== */

function openShareModal() {
    document.getElementById('shareOptionModal').classList.remove('hidden');
}

function closeShareModal() {
    document.getElementById('shareOptionModal').classList.add('hidden');
}

async function shareLink(type) {
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    const baseUrl = window.location.origin + window.location.pathname;
    let patientCode = '';
    
    // Recupera IDs para o log
    const caregiverId = localStorage.getItem('userId'); // Assumindo que voc√™ guarda o ID do user
    const patientId = localStorage.getItem('selectedPatientId'); 

    // ... (Mant√©m a l√≥gica de montagem da mensagem/URL que voc√™ j√° possui)
    let shareData = {
        title: 'Acura: Vencer Cuidando',
        text: t['msgShareDefault'] || 'Ol√°! Estou usando o app Acura...',
        url: baseUrl
    };

    if (type === 'full' && patientCode) {
        const separator = baseUrl.includes('?') ? '&' : '?';
        shareData.url = `${baseUrl}${separator}patient_code=${encodeURIComponent(patientCode)}`;
        const templateMsg = t['msgShareWithCode'] || 'Ol√°! Acesse o app Acura. C√≥digo: *{code}*';
        shareData.text = templateMsg.replace('{code}', patientCode);
    }

    try {
        let success = false;

        if (typeof Android !== 'undefined' && Android.compartilhar) {
            Android.compartilhar(shareData.text, shareData.url);
            success = true; // No Android nativo, assumimos sucesso ao chamar a interface
        } 
        else if (navigator.share) {
            await navigator.share(shareData);
            success = true;
        } 
        else {
            fallbackShare(shareData);
            success = true; 
        }

        // --- ENCORAJAMENTO: Salva no banco de dados ---
        if (success && caregiverId) {
            fetch('api.php?action=log-share', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    caregiverId: caregiverId,
                    patientId: patientId,
                    type: type === 'full' ? 'full' : 'simple'
                })
            })
            .then(response => response.json())
            .then(res => {
                if (res.success) {
                    console.log("Compartilhamento contabilizado para recompensa.");
                }
            });
        }

    } catch (err) {
        console.error('Erro ao compartilhar:', err);
    }
}

// Fun√ß√£o de Fallback (Caso voc√™ ainda n√£o tenha)
function fallbackShare(data) {
    const fullText = `${data.text}\n${data.url}`;
    navigator.clipboard.writeText(fullText).then(() => {
        alert("Link copiado para a √°rea de transfer√™ncia!");
    }).catch(() => {
        prompt("Copie o link abaixo:", fullText);
    });
}

function fallbackShare(data) {
    // Cria link do WhatsApp
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(data.text + ' ' + data.url)}`;
    window.open(whatsappUrl, '_blank');
}

// L√≥gica de Carregamento e Auto-preenchimento
window.addEventListener('DOMContentLoaded', () => {
    // 1. Obt√©m dicion√°rio aqui tamb√©m
    const t = (typeof LANG_STRINGS !== 'undefined' && typeof currentLang !== 'undefined') 
              ? LANG_STRINGS[currentLang] 
              : LANG_STRINGS['pt'];

    const urlParams = new URLSearchParams(window.location.search);
    
    // Verifica√ß√µes de seguran√ßa para evitar erro se 'state' n√£o existir
    const stateCode = (typeof state !== 'undefined' && state.patient) 
                      ? (state.patientCode || state.patient.access_code || state.patient.codigo_acesso) 
                      : null;

    const codeFromUrl = urlParams.get('patient_code') || stateCode || localStorage.getItem('patientCode') || 'N/A';

    console.log('code do paciente:', codeFromUrl);
    
    if (codeFromUrl && codeFromUrl !== 'N/A') {
        // Preenche automaticamente
        const codeInput = document.getElementById('patientCode');
        if (codeInput) {
            codeInput.value = codeFromUrl;
            
            // TRADU√á√ÉO: Feedback visual (Swal)
            const titleDetected = t['titleCodeDetected'] || 'C√≥digo Detectado!';
            const msgDetected = t['msgCodeInserted'] || "C√≥digo {code} inserido. Clique em 'Entrar' para acessar.";
            const btnOk = t['btnOk'] || 'Ok';

            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    title: titleDetected,
                    text: msgDetected.replace('{code}', codeFromUrl),
                    icon: 'success',
                    confirmButtonText: btnOk
                });
            }
        }
    }
});

// sauda√ß√µes ao cuidador que chega sem c√≥digo de paciente
// Fun√ß√£o auxiliar para fechar o modal de boas-vindas e abrir o de cria√ß√£o
function closeWelcomeAndCreate() {
    const modal = document.getElementById('welcomeOnboardingModal');
    if (modal) modal.classList.add('hidden');
    
    // Assume que voc√™ j√° tem uma fun√ß√£o para abrir o modal de criar paciente
    if (typeof openNewPatientModal === 'function') {
        openNewPatientModal();
    } else if (typeof openCreatePatientModal === 'function') {
        openCreatePatientModal(); // Ajuste conforme o nome da sua fun√ß√£o existente
    }
}

// --- L√ìGICA DE DISPARO ---
// Chame esta fun√ß√£o logo ap√≥s receber a resposta da API que lista os pacientes
// Exemplo: no final da fun√ß√£o 'loadPatients()' ou 'initApp()'

function checkOnboardingStatus(patientsList) {
    // Se a lista for nula ou vazia, mostramos o onboarding
    if (!patientsList || patientsList.length === 0) {
        const modal = document.getElementById('welcomeOnboardingModal');
        if (modal) {
            modal.classList.remove('hidden');
            
            // Efeito visual extra: Confete (opcional, se tiver biblioteca)
            // if (typeof confetti === 'function') confetti();
        }
    }
}


// AUTODETECTAR IDIOMA DO NAVEGADOR
function autoDetectLanguage() {
    // 1. Prioridade M√°xima: Escolha salva pelo usu√°rio (Persist√™ncia)
    const savedLang = localStorage.getItem('user_lang_preference');
    if (savedLang) {
        return savedLang;
    }

    // 2. Detec√ß√£o H√≠brida (Android WebApp / Navegador)
    // Tenta pegar a lista de idiomas preferidos (mais preciso no Android Chrome/WebView)
    // Se n√£o existir, pega o idioma principal.
    let detectedLang = (navigator.languages && navigator.languages.length > 0) 
                       ? navigator.languages[0] 
                       : (navigator.language || navigator.userLanguage || 'en');

    // 3. Normaliza√ß√£o (converte 'pt-BR' ou 'PT' para 'pt')
    detectedLang = detectedLang.toLowerCase();

    // 4. L√≥gica de Decis√£o
    if (detectedLang.startsWith('pt')) {
        return 'pt'; // Portugu√™s (Brasil, Portugal, etc)
    } 
    else if (detectedLang.startsWith('es')) {
        return 'es'; // Espanhol
    }
    
    // 5. Padr√£o Global (Fallback) = Ingl√™s
    // Isso cobre 'en-US', 'en-GB', ou qualquer outro idioma (Franc√™s, Alem√£o, etc.)
    return 'en';
}

// --- Inicializa√ß√£o ---
document.addEventListener('DOMContentLoaded', () => {
    // Detecta
    const lang = autoDetectLanguage();
    
    // Define globalmente
    window.currentLang = lang; 

    // (Opcional) Salva no HTML para CSS espec√≠fico se precisar: <html lang="en">
    document.documentElement.lang = lang;

    // Aplica as tradu√ß√µes
    if (typeof applyLanguage === 'function') {
        applyLanguage(lang);
    }
    
    console.log("Idioma detectado (Android/Web):", lang);
});

// --- Inicializa√ß√£o ---
document.addEventListener('DOMContentLoaded', () => {
    // Detecta
    const lang = autoDetectLanguage();
    
    // Define globalmente
    window.currentLang = lang; 

    // (Opcional) Salva no HTML para CSS espec√≠fico se precisar: <html lang="en">
    document.documentElement.lang = lang;

    // Aplica as tradu√ß√µes
    if (typeof applyLanguage === 'function') {
        applyLanguage(lang);
    }
    
    console.log("Idioma detectado (Android/Web):", lang);
});



//evita o console e o bot√£o direito
/*
document.addEventListener('DOMContentLoaded', () => {
    // 1. Bloqueia o bot√£o direito do mouse
    document.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        return false;
    });

    // 2. Bloqueia atalhos de teclado comuns para inspe√ß√£o
    document.onkeydown = function(e) {
        // F12
        if(e.keyCode == 123) {
            return false;
        }
        
        // Ctrl+Shift+I (Inspecionar)
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) {
            return false;
        }

        // Ctrl+Shift+C (Inspecionar Elemento)
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) {
            return false;
        }

        // Ctrl+Shift+J (Console)
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) {
            return false;
        }

        // Ctrl+U (Ver c√≥digo fonte)
        if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) {
            return false;
        }
    }
}); */

    </script>


<!-- Overlay para modais da timeline -->
<div class="popup-overlay" onclick="closeTimelineDetailModal(); closeTimelineNewModal();"></div>

</body>
</html>